<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>æ¬Šå’šé¢†åŸŸ</title>
  
  <subtitle>Making app a work of art.</subtitle>
  <link href="https://bqlin.github.io/atom.xml" rel="self"/>
  
  <link href="https://bqlin.github.io/"/>
  <updated>2021-11-21T03:18:58.000Z</updated>
  <id>https://bqlin.github.io/</id>
  
  <author>
    <name>æ¬Šå’š</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>AVFoundationè®¾å¤‡é…ç½®</title>
    <link href="https://bqlin.github.io/posts/avfoundation_device_setup/"/>
    <id>https://bqlin.github.io/posts/avfoundation_device_setup/</id>
    <published>2021-11-21T03:18:58.000Z</published>
    <updated>2021-11-21T03:18:58.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¸§ç‡ä¸åˆ†è¾¨ç‡">å¸§ç‡ä¸åˆ†è¾¨ç‡</h2><p>è®¾å¤‡å¸§ç‡ä¸åˆ†è¾¨ç‡åœ¨å¸§ç‡å¤§äº30fpsæ—¶ï¼Œä¸¤è€…æœ‰ç€ç»‘å®šå…³ç³»ï¼Œå³ä¸èƒ½è‡ªç”±è®¾ç½®ã€‚</p><h3 id="ä½å¸§ç‡æ¨¡å¼fps-30">ä½å¸§ç‡æ¨¡å¼ï¼ˆfps &lt;= 30ï¼‰</h3><p>ä½å¸§ç‡æ¨¡å¼ï¼ˆfps &lt;= 30ï¼‰ä¸‹ï¼Œå¸§ç‡å’Œåˆ†è¾¨ç‡å¯ä»¥åˆ†åˆ«è‡ªç”±è®¾ç½®ã€‚å³è®¾ç½®ï¼š</p><ul><li>AVCaptureSessionçš„<code>sessionPreset</code>ï¼šè®¾ç½®åˆ†è¾¨ç‡åŠå…¶é¢„è®¾æ ¼å¼ã€‚</li><li>AVCaptureDeviceçš„<code>activeVideoMinFrameDuration</code>ã€<code>activeVideoMaxFrameDuration</code></li></ul><h3 id="é«˜å¸§ç‡æ¨¡å¼fps-30">é«˜å¸§ç‡æ¨¡å¼ï¼ˆfps &gt; 30ï¼‰</h3><p>é«˜å¸§ç‡æ¨¡å¼ï¼ˆfps &gt; 30ï¼‰ä¸‹ï¼Œå¸§ç‡ä¸èƒ½è‡ªç”±è®¾ç½®ï¼Œéœ€è¦éå†è®¾å¤‡æ”¯æŒçš„æ ¼å¼ï¼Œåœ¨æ ¼å¼æ”¯æŒçš„å¸§ç‡èŒƒå›´é€‰æ‹©åˆé€‚çš„å¸§ç‡ã€‚ä¸ºäº†ç»Ÿä¸€æ“ä½œï¼Œä½å¸§ç‡æ¨¡å¼ä¸‹ä¹Ÿå¯ä»¥åº”ç”¨è¯¥è®¾ç½®æ–¹å¼ã€‚</p><ol type="1"><li>è·å–è®¾å¤‡å¯¹è±¡çš„<code>formats</code>æ•°ç»„ï¼Œå¹¶è¿›è¡Œéå†ï¼ˆä¹Ÿå¯ä»¥è¿›ä¸€æ­¥è·å–å…¶ä¸­çš„CMFormatDescriptionï¼‰ï¼š<ol type="1"><li>è·å–Formatçš„<code>videoSupportedFrameRateRanges</code>æ•°ç»„çš„é¦–ä¸ªå…ƒç´ ã€‚</li><li>æ¯”å¯¹AVFrameRateRangeçš„<code>maxFrameRate</code>æ˜¯å¦ &gt;= ç›®æ ‡å¸§ç‡ï¼Œæ»¡è¶³ç»§ç»­ï¼Œå¦åˆ™è·³è¿‡å¾ªç¯ã€‚</li><li>æ¯”å¯¹Formatçš„<code>formatDescription.dimensions</code>æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œæ»¡è¶³ç»§ç»­ï¼Œå¦åˆ™è·³è¿‡å¾ªç¯ã€‚</li><li>é”å®šè®¾å¤‡è¿›å…¥é…ç½®ï¼š<ol type="1"><li>è®¾ç½®AVCaptureDeviceçš„<code>activeFormat</code>ä¸ºå½“å‰Formatå¯¹è±¡ï¼›</li><li>è®¾ç½®AVCaptureDeviceçš„<code>activeVideoMinFrameDuration</code>ã€<code>activeVideoMaxFrameDuration</code>ä¸ºç›®æ ‡å¸§ç‡ã€‚</li></ol></li><li>è§£é”è®¾å¤‡å®Œæˆé…ç½®ã€‚</li></ol></li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å¸§ç‡ä¸åˆ†è¾¨ç‡&quot;&gt;å¸§ç‡ä¸åˆ†è¾¨ç‡&lt;/h2&gt;
&lt;p&gt;è®¾å¤‡å¸§ç‡ä¸åˆ†è¾¨ç‡åœ¨å¸§ç‡å¤§äº30fpsæ—¶ï¼Œä¸¤è€…æœ‰ç€ç»‘å®šå…³ç³»ï¼Œå³ä¸èƒ½è‡ªç”±è®¾ç½®ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="AVFoundation" scheme="https://bqlin.github.io/categories/AVFoundation/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>KVC</title>
    <link href="https://bqlin.github.io/posts/kvc/"/>
    <id>https://bqlin.github.io/posts/kvc/</id>
    <published>2021-11-20T03:12:33.000Z</published>
    <updated>2021-11-20T03:12:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>KVCï¼ŒKey Value Codingï¼Œæ˜¯ä¸€ç§é€šè¿‡å­—ç¬¦ä¸²keyæ¥è®¿é—®ç±»å±æ€§çš„æœºåˆ¶ã€‚ä¸æ˜¯é€šè¿‡è°ƒç”¨setterã€getteræ–¹æ³•è®¿é—®ã€‚</p><p>KVCå’ŒKVOéƒ½å±äºé”®å€¼ç¼–ç¨‹ï¼Œè€Œä¸”åº•å±‚å®ç°æœºåˆ¶éƒ½æ˜¯<strong>isa-swizzing</strong>ã€‚</p><h2 id="è®¾å€¼æµç¨‹">è®¾å€¼æµç¨‹</h2><ol type="1"><li>æŒ‰é¡ºåºæŸ¥æ‰¾<code>setKey:</code>ã€<code>_setKey:</code>æ–¹æ³•ï¼Œæ‰¾åˆ°æ–¹æ³•åˆ™ä¼ é€’å‚æ•°ï¼Œè°ƒç”¨æ–¹æ³•ã€‚å¦åˆ™ç»§ç»­ã€‚</li><li>è°ƒç”¨<code>accessInstanceVariablesDirectly</code>æ–¹æ³•ã€‚<ul><li>YESï¼šé»˜è®¤ï¼ŒæŸ¥æ‰¾æˆå‘˜å˜é‡ï¼š<ol type="1"><li>æŒ‰ç…§<code>_key</code>ã€<code>_isKey</code>ã€<code>key</code>ã€<code>isKey</code> çš„é¡ºåºæŸ¥æ‰¾ï¼Œæ‰¾åˆ°äº†å°±ç›´æ¥èµ‹å€¼ã€‚</li></ol></li><li>NOï¼šè¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li></ul></li><li>è°ƒç”¨<code>setValue:forUndefinedKey:</code>æ–¹æ³•ï¼Œå¹¶æŠ›å‡ºNSUnknownKeyExceptionå¼‚å¸¸ã€‚</li></ol><p><code>setValue:forUndefinedKey:</code>æ–¹æ³•çš„é»˜è®¤å®ç°å°±æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡é‡å†™è¯¥æ–¹æ³•é¿å…æŠ›å‡ºå¼‚å¸¸ã€‚</p><h2 id="å–å€¼æµç¨‹">å–å€¼æµç¨‹</h2><p>åŸºæœ¬ä¸è®¾å€¼æµç¨‹ä¸€è‡´ï¼Œåªæ˜¯æŠŠsetå…³é”®å­—æ”¹æˆgetã€‚</p><ol type="1"><li>æŒ‰é¡ºåºæŸ¥æ‰¾<code>getKey</code>ã€<code>key</code>ã€<code>isKey</code>ã€<code>_key</code>æ–¹æ³•ï¼Œæ‰¾åˆ°æ–¹æ³•åˆ™ç›´æ¥è°ƒç”¨ã€‚å¦åˆ™ç»§ç»­ã€‚</li><li>è°ƒç”¨<code>accessInstanceVariablesDirectly</code>æ–¹æ³•ã€‚<ul><li>YESï¼šé»˜è®¤ï¼ŒæŸ¥æ‰¾æˆå‘˜å˜é‡ï¼š<ol type="1"><li>æŒ‰ç…§<code>_key</code>ã€<code>_isKey</code>ã€<code>key</code>ã€<code>isKey</code> çš„é¡ºåºæŸ¥æ‰¾ï¼Œæ‰¾åˆ°äº†å°±ç›´æ¥å–å€¼ã€‚</li></ol></li><li>NOï¼šè¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li></ul></li><li>è°ƒç”¨<code>valueForUndefinedKey:</code>æ–¹æ³•ï¼Œå¹¶æŠ›å‡ºNSUnknownKeyExceptionå¼‚å¸¸ã€‚</li></ol><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://ityongzhen.github.io/KVC%E9%82%A3%E7%82%B9%E5%84%BF%E4%BA%8B.html/">KVCé‚£ç‚¹å„¿äº‹ | æ®·æ°¸æŒ¯</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;KVCï¼ŒKey Value Codingï¼Œæ˜¯ä¸€ç§é€šè¿‡å­—ç¬¦ä¸²keyæ¥è®¿é—®ç±»å±æ€§çš„æœºåˆ¶ã€‚ä¸æ˜¯é€šè¿‡è°ƒç”¨setterã€getteræ–¹æ³•è®¿é—®ã€‚&lt;/p&gt;
&lt;p&gt;KVCå’ŒKVOéƒ½å±äºé”®å€¼ç¼–ç¨‹ï¼Œè€Œä¸”åº•å±‚å®ç°æœºåˆ¶éƒ½æ˜¯&lt;strong&gt;isa-swizzing&lt;/strong&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
  </entry>
  
  <entry>
    <title>Objective-Cï¼šBlock</title>
    <link href="https://bqlin.github.io/posts/block/"/>
    <id>https://bqlin.github.io/posts/block/</id>
    <published>2021-11-16T09:55:04.000Z</published>
    <updated>2021-11-16T09:55:04.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å˜é‡æ•è·æœºåˆ¶">å˜é‡æ•è·æœºåˆ¶</h2><ul><li>å…¨å±€å˜é‡ï¼šä¸ä¼šæ•è·åˆ°blockå†…éƒ¨ï¼Œç›´æ¥è®¿é—®ã€‚</li><li>autoåŸºæœ¬ç±»å‹çš„å±€éƒ¨å˜é‡ï¼Œæ•è·åˆ°blockå†…éƒ¨ï¼Œç”Ÿæˆæˆå‘˜å˜é‡æ¥å­˜å‚¨ï¼Œä»¥å€¼ä¼ é€’çš„æ–¹å¼è®¿é—®ã€‚</li><li>staticç±»å‹çš„å±€éƒ¨å˜é‡ï¼šæ•è·åˆ°blockå†…éƒ¨ï¼Œç”Ÿæˆæˆå‘˜å˜é‡æ¥å­˜å‚¨ï¼Œä»¥æŒ‡é’ˆæ–¹å¼è®¿é—®ã€‚</li><li>å¯¹è±¡ç±»å‹çš„å±€éƒ¨å˜é‡ï¼šè¿åŒå®ƒçš„æ‰€æœ‰æƒä¿®é¥°ç¬¦ä¸€èµ·æ•è·ã€‚</li></ul><h2 id="å˜é‡æ•è·ä¿®é¥°ç¬¦">å˜é‡æ•è·ä¿®é¥°ç¬¦</h2><ul><li><code>__weak</code>æ˜¯ä¸ºäº†é˜²æ­¢å¾ªç¯å¼•ç”¨ã€‚åœ¨blockä¸­è®¿é—®weakæŒ‡é’ˆï¼Œå½“å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼ŒæŒ‡é’ˆç½®ç©ºï¼Œå˜æˆnilè°ƒç”¨ç›¸å…³æ–¹æ³•ã€‚</li><li><code>__strong</code>æ˜¯ä¸ºäº†å»¶é•¿ç”Ÿå‘½å‘¨æœŸã€‚è¿™é‡Œç”¨åœ¨blockå’Œç›®æ ‡å¯¹è±¡å­˜åœ¨ç›¸äº’å¼•ç”¨çš„å…³ç³»æ‰æœ‰æ•ˆï¼Œä¸”èµ‹å€¼çš„æ˜¯weakæŒ‡é’ˆï¼Œä½œç”¨æ˜¯ä½¿å…¶å¼•ç”¨è®¡æ•°+1ã€‚ç›¸å½“äºå£°æ˜äº†ä¸ªå±€éƒ¨å˜é‡ã€‚</li><li><code>__block</code>æ˜¯ä¸ºäº†åœ¨blockå†…éƒ¨å¯ä»¥ä¿®æ”¹å¤–éƒ¨çš„å˜é‡ã€‚<ul><li>å¦‚æœæƒ³ç”¨<code>__block</code>è§£å†³å¾ªç¯å¼•ç”¨ï¼Œå¿…é¡»è¦åœ¨blockä¸­å°†å…¶ä¿®é¥°çš„å˜é‡ç½®ç©ºã€‚</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    [self dismissViewControllerAnimated:true completion:nil];</span><br><span class="line">    </span><br><span class="line">    __weak typeof(self) _self = self;</span><br><span class="line">    TestViewController *tmp = self;</span><br><span class="line">    self.block = ^&#123;</span><br><span class="line">        // 1âƒ£ï¸</span><br><span class="line">        // æ³¨æ„å£°æ˜æ˜¯å‘ç”Ÿåœ¨è¿™é‡Œï¼Œå³weak selfæŒ‡å‘çš„å¯¹è±¡è¿˜æ²¡è¢«é”€æ¯çš„æ—¶å€™</span><br><span class="line">        __strong typeof(_self) s_self = _self; // åŒä¸‹</span><br><span class="line">        // TestViewController *s_self = _self;</span><br><span class="line">        // TestViewController *s_self = tmp; // è¿˜æ˜¯å¯¼è‡´å¾ªç¯å¼•ç”¨</span><br><span class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            // 2âƒ£ï¸</span><br><span class="line">            NSLog(@&quot;blockå±æ€§å»¶æ—¶weak: %@, strong: %@&quot;, _self, s_self);</span><br><span class="line">            // weak == strong != nil</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    self.block();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œç»™<code>__strong</code>å˜é‡èµ‹å€¼çš„å¼±å¼•ç”¨å¿…é¡»åœ¨å¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡è¿˜æ²¡è¢«é”€æ¯çš„æ—¶å€™å®Œæˆèµ‹å€¼ï¼Œå¦åˆ™æ‹¿åˆ°çš„å¼±å¼•ç”¨æ˜¯ä¸ªnilã€‚</p><p>å¦å¤–ï¼Œå¦‚æœåªæ˜¯åœ¨1âƒ£ï¸å¤„å®šä¹‰å¹¶èµ‹å€¼äº†å¼ºå¼•ç”¨å¯¹è±¡ï¼Œè€Œåœ¨2âƒ£ï¸å¤„æ²¡æœ‰ä½¿ç”¨ï¼Œåˆ™2âƒ£ï¸å¤„è®¿é—®çš„å¼±å¼•ç”¨ä¹Ÿæ˜¯ç©ºçš„ã€‚</p><h2 id="åº•å±‚æ•°æ®ç»“æ„">åº•å±‚æ•°æ®ç»“æ„</h2><p><img src="https://gitee.com/bqlin/image-land/raw/master/UUBdE6.jpg" /></p><p>blockæœ¬è´¨ä¹Ÿæ˜¯ä¸€ä¸ªOCå¯¹è±¡ï¼Œå†…éƒ¨ä¹Ÿæœ‰ä¸ªisaæŒ‡é’ˆã€‚å°è£…äº†å‡½æ•°è°ƒç”¨ä»¥åŠè°ƒç”¨ç¯å¢ƒã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://juejin.cn/post/6844904070746996750">OC åº•å±‚æ¢ç´¢ - Block è¯¦è§£ - æ˜é‡‘</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å˜é‡æ•è·æœºåˆ¶&quot;&gt;å˜é‡æ•è·æœºåˆ¶&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;å…¨å±€å˜é‡ï¼šä¸ä¼šæ•è·åˆ°blockå†…éƒ¨ï¼Œç›´æ¥è®¿é—®ã€‚&lt;/li&gt;
&lt;li&gt;autoåŸºæœ¬ç±»å‹çš„å±€éƒ¨å˜é‡ï¼Œæ•è·åˆ°blockå†…éƒ¨ï¼Œç”Ÿæˆæˆå‘˜å˜é‡æ¥å­˜å‚¨ï¼Œä»¥å€¼ä¼ é€’çš„æ–¹å¼è®¿é—®ã€‚&lt;/li&gt;
&lt;li&gt;staticç±»å‹çš„å±€éƒ¨å˜é‡ï¼šæ•è·åˆ°blockå†…éƒ¨ï¼Œç”Ÿæˆæˆå‘˜å˜é‡æ¥å­˜å‚¨ï¼Œä»¥æŒ‡é’ˆæ–¹å¼è®¿é—®ã€‚&lt;/li&gt;
&lt;li&gt;å¯¹è±¡ç±»å‹çš„å±€éƒ¨å˜é‡ï¼šè¿åŒå®ƒçš„æ‰€æœ‰æƒä¿®é¥°ç¬¦ä¸€èµ·æ•è·ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Objective-C" scheme="https://bqlin.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>Runtimeï¼šweak</title>
    <link href="https://bqlin.github.io/posts/runtime_weak/"/>
    <id>https://bqlin.github.io/posts/runtime_weak/</id>
    <published>2021-11-12T10:33:52.000Z</published>
    <updated>2021-11-12T10:33:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>å½“ä¸€ä¸ªå¯¹è±¡è¢«weakæŒ‡é’ˆæŒ‡å‘æ—¶ï¼Œè¿™ä¸ªweakæŒ‡é’ˆä¼šä»¥å¯¹è±¡ä½œä¸ºkeyï¼Œå­˜å‚¨åˆ°SideTableçš„<code>weak_table</code>å“ˆå¸Œè¡¨ä¸­ã€‚</p><ul><li>Keyï¼šå¯¹è±¡</li><li>Valueï¼šweakæŒ‡é’ˆæ•°ç»„</li></ul><p>å½“è¯¥å¯¹è±¡deallocæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒRuntimeä¼šä»¥è¯¥å¯¹è±¡ä¸ºkeyï¼Œä»SideTableçš„<code>weak_table</code>å“ˆå¸Œè¡¨ä¸­ï¼Œæ‰¾åˆ°å¯¹åº”çš„weakæŒ‡é’ˆåˆ—è¡¨ï¼Œç„¶åå§å…¶ä¸­çš„weakæŒ‡é’ˆé€ä¸ªç½®ä¸ºnilã€‚</p><h2 id="åº•å±‚ç»†èŠ‚">åº•å±‚ç»†èŠ‚</h2><p>ä½¿ç”¨weakä¿®é¥°çš„å¯¹è±¡ï¼Œåº•å±‚è°ƒç”¨äº†<code>objc_initWeak</code>å‡½æ•°ã€‚é‡Œé¢è·å–weakæŒ‡é’ˆåœ°å€å’Œå¯¹è±¡åœ°å€ä¼ é€’åˆ°ä¸‹ä¸€å±‚å‡½æ•°å­˜å‚¨ã€‚æœ€ç»ˆå­˜å‚¨åˆ°SideTableä¸­çš„<code>weak_table</code>å“ˆå¸Œè¡¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SideTable</span> &#123;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> slock; <span class="comment">// é”</span></span><br><span class="line">    RefcountMap refcnts; <span class="comment">// æŒ‡å‘å¯¹è±¡å¼•ç”¨è®¡æ•°çš„å“ˆå¸Œè¡¨ï¼ˆä»…åœ¨æœªå¼€å¯isaä¼˜åŒ–æˆ–åœ¨isaä¼˜åŒ–ä¸‹isa_tå¼•ç”¨è®¡æ•°æº¢å‡ºæ—¶æ‰ä¼šç”¨åˆ°ï¼‰</span></span><br><span class="line">    <span class="keyword">weak_table_t</span> weak_table; <span class="comment">// å­˜å‚¨å¯¹è±¡è‹¥å¼•ç”¨æŒ‡é’ˆçš„å“ˆå¸Œè¡¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">weak_table_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">weak_entry_t</span> *weak_entries; <span class="comment">// ç”¨äºå­˜å‚¨å“ˆå¸Œæ•°ç»„</span></span><br><span class="line">    <span class="keyword">size_t</span>    num_entries;</span><br><span class="line">    <span class="keyword">uintptr_t</span> mask;</span><br><span class="line">    <span class="keyword">uintptr_t</span> max_hash_displacement;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure><img src="https://gitee.com/bqlin/image-land/raw/master/aUBSTV.jpg" alt="aUBSTV" /><figcaption aria-hidden="true">aUBSTV</figcaption></figure><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://juejin.cn/post/6844904101839372295">iOSåº•å±‚åŸç†ï¼šweakçš„å®ç°åŸç† - æ˜é‡‘</a></li><li></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å½“ä¸€ä¸ªå¯¹è±¡è¢«weakæŒ‡é’ˆæŒ‡å‘æ—¶ï¼Œè¿™ä¸ªweakæŒ‡é’ˆä¼šä»¥å¯¹è±¡ä½œä¸ºkeyï¼Œå­˜å‚¨åˆ°SideTableçš„&lt;code&gt;weak_table&lt;/code&gt;å“ˆå¸Œè¡¨ä¸­ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Keyï¼šå¯¹è±¡&lt;/li&gt;
&lt;li&gt;Valueï¼šweakæŒ‡é’ˆæ•°ç»„&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Objective-C" scheme="https://bqlin.github.io/tags/Objective-C/"/>
    
    <category term="Runtime" scheme="https://bqlin.github.io/tags/Runtime/"/>
    
  </entry>
  
  <entry>
    <title>APNs</title>
    <link href="https://bqlin.github.io/posts/apns/"/>
    <id>https://bqlin.github.io/posts/apns/</id>
    <published>2021-11-12T10:23:59.000Z</published>
    <updated>2021-11-12T10:23:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>åŸºæœ¬åŸç†ï¼š</p><ol type="1"><li>åç«¯æŠŠè¦å‘é€çš„æ¶ˆæ¯ã€ç›®æ ‡è®¾å¤‡æ ‡è¯†æ‰“åŒ…ï¼Œå‘é€ç»™APNSã€‚</li><li>APNSåœ¨å·²æ³¨å†Œæ¨é€æœåŠ¡çš„è®¾å¤‡åˆ—è¡¨ä¸­ï¼ŒæŸ¥æ‰¾ç¬¦åˆæ ‡è¯†çš„è®¾å¤‡ï¼ŒæŠŠæ¶ˆæ¯å‘é€åˆ°è®¾å¤‡ã€‚</li><li>è®¾å¤‡æŠŠå‘é€æ¥çš„æ¶ˆæ¯ä¼ é€’ç»™ç›¸åº”çš„Appï¼ŒæŒ‰ç…§è®¾å®šå¼¹å‡ºæ¨é€é€šçŸ¥ã€‚</li></ol><h2 id="ç»†èŠ‚">ç»†èŠ‚</h2><p>æ³¨å†Œè¿‡ç¨‹ï¼š</p><ol type="1"><li>è®¾å¤‡é“¾æ¥APNså¹¶æºå¸¦è®¾å¤‡UUIDï¼›</li><li>è¿æ¥æˆåŠŸåï¼ŒAPNsç»è¿‡æ‰“åŒ…å’Œå¤„ç†äº§ç”ŸdeviceTokenè¿”å›åˆ°æ³¨å†Œçš„è®¾å¤‡ã€‚</li><li>è®¾å¤‡æŠŠdeviceTokenå‘é€åˆ°è‡ªå·±æœåŠ¡å™¨ã€‚</li></ol><p>æ¨é€è¿‡ç¨‹ï¼š</p><ol type="1"><li>è®¾å¤‡è£…æœ‰Appï¼Œä¸”æœ‰ç½‘ç»œçš„æƒ…å†µä¸‹ï¼ŒAPNsä¼šéªŒè¯deviceTokenï¼ŒæˆåŠŸåä¼šå¤„äºä¸€ä¸ªé•¿è¿æ¥ã€‚</li><li>åç«¯å‘é€æ¶ˆæ¯æ—¶ï¼Œåç«¯æŒ‰ç…§æŒ‡å®šæ ¼å¼è¿›è¡Œæ‰“åŒ…ï¼Œç»“åˆdeviceTokenä¸€èµ·å‘é€åˆ°APNsã€‚</li><li>APNsæŠŠæ–°æ¶ˆæ¯å‘é€åˆ°è®¾å¤‡ï¼Œç„¶åæ ¹æ®è®¾å®šå¼¹å‡ºæ¨é€é€šçŸ¥ã€‚</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;åŸºæœ¬åŸç†ï¼š&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;åç«¯æŠŠè¦å‘é€çš„æ¶ˆæ¯ã€ç›®æ ‡è®¾å¤‡æ ‡è¯†æ‰“åŒ…ï¼Œå‘é€ç»™APNSã€‚&lt;/li&gt;
&lt;li&gt;APNSåœ¨å·²æ³¨å†Œæ¨é€æœåŠ¡çš„è®¾å¤‡åˆ—è¡¨ä¸­ï¼ŒæŸ¥æ‰¾ç¬¦åˆæ ‡è¯†çš„è®¾å¤‡ï¼ŒæŠŠæ¶ˆæ¯å‘é€åˆ°è®¾å¤‡ã€‚&lt;/li&gt;
&lt;li&gt;è®¾å¤‡æŠŠå‘é€æ¥çš„æ¶ˆæ¯ä¼ é€’ç»™ç›¸åº”çš„Appï¼ŒæŒ‰ç…§è®¾å®šå¼¹å‡ºæ¨é€é€šçŸ¥ã€‚&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
  </entry>
  
  <entry>
    <title>Objective-Cï¼šå†…çœ</title>
    <link href="https://bqlin.github.io/posts/introspection/"/>
    <id>https://bqlin.github.io/posts/introspection/</id>
    <published>2021-11-12T10:07:48.000Z</published>
    <updated>2021-11-12T10:07:48.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li><code>isMemberOfClass</code>ï¼šå¯¹è±¡æ˜¯å¦æ˜¯æŸç±»å‹å¯¹è±¡ã€‚</li><li><code>isKindOfClass</code>ï¼šå¯¹è±¡æ—¶å¦æ˜¯æŸç±»å‹æˆ–ç±»å‹å­ç±»çš„å¯¹è±¡ã€‚</li><li><code>isSubclassOfClass</code>ã€<code>isAncestorOfObject</code>ï¼šç±»å¯¹è±¡æ˜¯å¦æ˜¯å¦ä¸€ä¸ªç±»å‹çš„å­ç±»ã€çˆ¶ç±»ã€‚</li><li><code>respondsToSelector</code>ï¼šæ˜¯å¦èƒ½å“åº”æŸæ–¹æ³•ã€‚</li><li><code>conformsToProtocol</code>ï¼šæ˜¯å¦éµå¾ªæŸåè®®ã€‚</li></ul><p><code>class</code>ä¸<code>object_getClass</code>ï¼š</p><ul><li>å®ä¾‹<code>class</code> = <code>object_getClass(self)</code></li><li>ç±»<code>class</code>è¿”å›è‡ªèº«ï¼›<code>object_getClass(ç±»å¯¹è±¡)</code>è¿”å›å…ƒç±»ã€‚</li></ul><p>å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// åˆ¤æ–­å½“å‰å¯¹è±¡ã€ç±»çš„isaæŒ‡å‘æ˜¯ä¸æ˜¯ç±»ã€åŸç±»</span><br><span class="line">+ (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    return object_getClass((id)self) == cls;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    return [self class] == cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åˆ¤æ–­å½“å‰å¯¹è±¡ã€ç±»çš„isaæ˜¯ä¸æ˜¯ç±»ã€å…ƒç±»æˆ–è€…å…¶å­ç±»ç±»å‹</span><br><span class="line">+ (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls = object_getClass((id)self); tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        if (tcls == cls) return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls = [self class]; tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        if (tcls == cls) return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class object_getClass(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    if (obj) return obj-&gt;getIsa();</span><br><span class="line">    else return Nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶<code>isKindOfClass</code>èŒƒå›´æ›´å¤§ï¼Œå½“è°ƒç”¨å¯¹è±¡å’Œå‚æ•°éƒ½æ˜¯ç±»æ—¶ï¼Œç±»å¯¹è±¡çš„isaæŒ‡å‘å…ƒç±»å¯¹è±¡ï¼Œè€Œå…¶å…ƒç±»çš„superclassæŒ‡å‘classå¯¹è±¡ï¼Œæ‰€ä»¥æ»¡è¶³æ¡ä»¶è¿”å›YESã€‚æ‰€ä»¥<code>[instance/class isKindOfClass:[NSObject class]];</code>éƒ½è¿”å› 1ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject</span><br><span class="line">@end</span><br><span class="line">......</span><br><span class="line">    BOOL res1 = [[NSObject class] isKindOfClass:[NSObject class]];</span><br><span class="line">    BOOL res2 = [[NSObject class] isMemberOfClass:[NSObject class]];</span><br><span class="line">    BOOL res3 = [[Person class] isKindOfClass:[Person class]];</span><br><span class="line">    BOOL res4 = [[Person class] isMemberOfClass:[Person class]];</span><br><span class="line"></span><br><span class="line">    NSLog(@&quot;%d,%d,%d,%d&quot;, res1, res2, res3, res4);</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    // 1,0,0,0</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;ul&gt;
&lt;li&gt;&lt;code&gt;isMemberOfClass&lt;/code&gt;ï¼šå¯¹è±¡æ˜¯å¦æ˜¯æŸç±»å‹å¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;isKindOfClass&lt;/code&gt;ï¼šå¯¹è±¡æ—¶å¦æ˜¯æŸç±»å‹æˆ–ç±»å‹å­ç±»çš„å¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;isSubclassOfClass&lt;/code&gt;ã€&lt;code&gt;isAncestorOfObject&lt;/code&gt;ï¼šç±»å¯¹è±¡æ˜¯å¦æ˜¯å¦ä¸€ä¸ªç±»å‹çš„å­ç±»ã€çˆ¶ç±»ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;respondsToSelector&lt;/code&gt;ï¼šæ˜¯å¦èƒ½å“åº”æŸæ–¹æ³•ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;conformsToProtocol&lt;/code&gt;ï¼šæ˜¯å¦éµå¾ªæŸåè®®ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;class&lt;/code&gt;ä¸&lt;code&gt;object_getClass&lt;/code&gt;ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Objective-C" scheme="https://bqlin.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>Runtimeï¼šå…³è”å¯¹è±¡</title>
    <link href="https://bqlin.github.io/posts/runtime_associative/"/>
    <id>https://bqlin.github.io/posts/runtime_associative/</id>
    <published>2021-11-12T08:35:38.000Z</published>
    <updated>2021-11-12T08:35:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>Associativeè¿è¡Œæ—¶ç‰¹æ€§å¯ä»¥ç»™ä¸¤ä¸ªå¯¹è±¡å»ºç«‹å…³è”å…³ç³»ï¼Œè¿™æ˜¯ä¸€ç§ä»å±å…³ç³»ã€‚</p><p>ç›¸å…³APIï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// objc/runtime.h</span><br><span class="line">/** ç»™ä¸€ä¸ªå¯¹è±¡è®¾ç½®å…³è”å¯¹è±¡</span><br><span class="line">object: éœ€è¦æ·»åŠ å…³è”çš„æºå¯¹è±¡</span><br><span class="line">key: å…³è”å€¼çš„å”¯ä¸€key</span><br><span class="line">value: å…³è”çš„å…·ä½“å€¼</span><br><span class="line">policy: å…³è”çš„ç­–ç•¥ (ç±»ä¼¼å£°æ˜propertiesçš„å‚æ•°)</span><br><span class="line">*/</span><br><span class="line">void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy)</span><br><span class="line"></span><br><span class="line">/** è·å–æŸä¸ªå¯¹è±¡çš„æŸä¸ªå…³è”å¯¹è±¡</span><br><span class="line">object: éœ€è¦è·å–å…³è”çš„æºå¯¹è±¡</span><br><span class="line">key: å…³è”å€¼çš„å”¯ä¸€key</span><br><span class="line">*/</span><br><span class="line">id objc_getAssociatedObject(id object, const void *key)</span><br><span class="line"></span><br><span class="line">/** ç§»é™¤å¯¹è±¡çš„å…³è”å¯¹è±¡</span><br><span class="line"> object: éœ€è¦ç§»é™¤çš„æºå¯¹è±¡</span><br><span class="line">*/</span><br><span class="line">void objc_removeAssociatedObjects(id object) </span><br></pre></td></tr></table></figure><p>åº”ç”¨åœºæ™¯ï¼š</p><ul><li>ç»™ç³»ç»Ÿç±»ã€ç¬¬ä¸‰æ–¹ç±»æ·»åŠ å±æ€§ã€‚</li><li>ä½¿ç”¨<code>RETAIN_NONATOMIC</code>å…³è”ç±»å‹çš„å¯¹è±¡å…³è”ç›®æ ‡å¯¹è±¡ï¼Œä»¥ç›‘å¬ç›®æ ‡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</li></ul><h2 id="å®ç°åŸç†">å®ç°åŸç†</h2><p>ç»„æˆéƒ¨åˆ†ï¼š</p><ul><li>AssociationsManagerï¼šç®¡ç†ä¸€ä¸ªAssociationsHashMapã€‚</li><li>AssociationsHashMapï¼šç”¨<code>objc_setAssociatedObject</code>ä¼ å…¥çš„objectä¸ºåŸºç¡€ï¼Œè¿›è¡Œä¸€äº›å…¶ä»–æ“ä½œåä½œä¸ºKeyï¼ŒObjectAssociationMapä¸ºValueã€‚</li><li>ObjectAssociationMapï¼šç”¨<code>objc_setAssociatedObject</code>ä¼ å…¥çš„keyä½œä¸ºKeyï¼ŒObjcAssociationä¸ºValueã€‚</li></ul><p><img src="https://gitee.com/bqlin/image-land/raw/master/VDcTrc.jpg" /></p><p>å¯¹è±¡å…³è”çš„å¯¹è±¡åœ¨<code>-dealloc</code>è°ƒç”¨çš„<code>object_dispose</code>å‡½æ•°ä¸­é‡Šæ”¾ã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://juejin.cn/post/6955372421931073572">iOS åº•å±‚åŸç†03: Category, å…³è”å¯¹è±¡ - æ˜é‡‘</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Associativeè¿è¡Œæ—¶ç‰¹æ€§å¯ä»¥ç»™ä¸¤ä¸ªå¯¹è±¡å»ºç«‹å…³è”å…³ç³»ï¼Œè¿™æ˜¯ä¸€ç§ä»å±å…³ç³»ã€‚&lt;/p&gt;
&lt;p&gt;ç›¸å…³APIï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Objective-C" scheme="https://bqlin.github.io/tags/Objective-C/"/>
    
    <category term="Runtime" scheme="https://bqlin.github.io/tags/Runtime/"/>
    
  </entry>
  
  <entry>
    <title>Runtimeï¼šCategory</title>
    <link href="https://bqlin.github.io/posts/runtime_category/"/>
    <id>https://bqlin.github.io/posts/runtime_category/</id>
    <published>2021-11-12T07:04:29.000Z</published>
    <updated>2021-11-12T07:04:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¦‚æœåŸæ¥çš„ç±»å’Œåˆ†ç±»ä¸­æœ‰ç›¸åŒçš„æ–¹æ³•ï¼Œé‚£ä¹ˆæœ€ç»ˆæ‰§è¡Œçš„æ˜¯åˆ†ç±»æ–¹æ³•ã€‚</p><p>ç¼–è¯‘å®Œï¼Œæ¯ä¸ªåˆ†ç±»éƒ½ä¼šç”Ÿæˆä¸€ä¸ªcategory_tç»“æ„ä½“ï¼Œé‡Œé¢å­˜å‚¨åç§°ã€å¯¹è±¡æ–¹æ³•åˆ—è¡¨ã€ç±»æ–¹æ³•åˆ—è¡¨ã€åè®®æ–¹æ³•åˆ—è¡¨ã€å±æ€§åˆ—è¡¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">category_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">classref_t</span> cls;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">instanceMethods</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">classMethods</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">protocol_list_t</span> *<span class="title">protocols</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property_list_t</span> *<span class="title">instanceProperties</span>;</span></span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property_list_t</span> *_<span class="title">classProperties</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">method_list_t</span> *<span class="title">methodsForMeta</span><span class="params">(<span class="keyword">bool</span> isMeta)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isMeta) <span class="keyword">return</span> classMethods;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> instanceMethods;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">property_list_t</span> *<span class="title">propertiesForMeta</span><span class="params">(<span class="keyword">bool</span> isMeta, struct header_info *hi)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨åˆå¹¶åˆ†ç±»çš„æ—¶å€™ï¼Œå…¶æ–¹æ³•åˆ—è¡¨ç­‰ä¸ä¼šè¦†ç›–åŸæ¥ç±»ä¸­çš„æ–¹æ³•ï¼Œæ˜¯å…±å­˜çš„ã€‚ä½†åˆ†ç±»çš„æ–¹æ³•åœ¨å‰é¢ï¼ŒåŸæ¥ç±»çš„æ–¹æ³•åœ¨åé¢ï¼Œè°ƒç”¨çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨åˆ†ç±»ä¸­çš„æ–¹æ³•ï¼Œå¦‚æœå¤šä¸ªåˆ†ç±»çš„ç›¸åŒæ–¹æ³•ï¼Œåç¼–è¯‘çš„åˆ†ç±»ä¼šè¢«è°ƒç”¨ã€‚</p><p>å¦‚æœæƒ³è¦æ‰§è¡Œè¢«â€œè¦†ç›–â€çš„ç±»å®šä¹‰æ–¹æ³•ï¼Œå¯ä»¥é€†åºéå†æ–¹æ³•åˆ—è¡¨ï¼Œç¬¬ä¸€æ¬¡å–å¾—çš„å°±æ˜¯ç±»å®šä¹‰çš„æ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (void)foo&#123;   </span><br><span class="line">  [ç±» invokeOriginalMethod:self selector:_cmd];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)invokeOriginalMethod:(id)target selector:(SEL)selector &#123;</span><br><span class="line">    uint count;</span><br><span class="line">    Method *list = class_copyMethodList([target class], &amp;count);</span><br><span class="line">    for ( int i = count - 1 ; i &gt;= 0; i--) &#123;</span><br><span class="line">        Method method = list[i];</span><br><span class="line">        SEL name = method_getName(method);</span><br><span class="line">        IMP imp = method_getImplementation(method);</span><br><span class="line">        if (name == selector) &#123;</span><br><span class="line">            ((void (*)(id, SEL))imp)(target, name);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç±»å¯¹è±¡/å…ƒç±»å¯¹è±¡æ‰æ˜¯æœ€ç»ˆå­˜å‚¨åˆ†ç±»å®ä¾‹/ç±»æ–¹æ³•ã€å±æ€§ã€åè®®çš„åœ°æ–¹ã€‚</p><h2 id="æ‰©å±•é—®é¢˜">æ‰©å±•é—®é¢˜</h2><h3 id="categoryçš„åŸæœ¬ä½¿ç”¨åœºæ™¯">Categoryçš„åŸæœ¬ä½¿ç”¨åœºæ™¯</h3><p>åŒºåˆ†ä¸åŒçš„åŠŸèƒ½æ¨¡å—ï¼Œä½¿ç”¨åˆ†ç±»å•ç‹¬å®ç°ã€‚</p><h3 id="categoryçš„å®ç°åŸç†">Categoryçš„å®ç°åŸç†</h3><p>åˆ†ç±»ç¼–è¯‘åæ˜¯category_tç»“æ„ä½“ï¼Œé‡Œé¢å­˜å‚¨ç€åˆ†ç±»çš„å¯¹è±¡æ–¹æ³•ã€ç±»æ–¹æ³•ã€å±æ€§ã€åè®®ä¿¡æ¯ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼ŒRuntimeä¼šæŠŠåˆ†ç±»çš„æ•°æ®åˆå¹¶åˆ°ç±»ä¿¡æ¯ï¼ˆç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡ï¼‰ä¸­ã€‚</p><h3 id="categoryä¸extensionçš„åŒºåˆ«">Categoryä¸Extensionçš„åŒºåˆ«</h3><p>Extensionåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå…¶æ•°æ®å·²ç»åŒ…å«åœ¨ç±»ä¿¡æ¯ä¸­ã€‚Categoryåœ¨è¿è¡Œæ—¶æ‰ä¼šæŠŠæ•°æ®åˆå¹¶åˆ°ç±»ä¿¡æ¯ä¸­ã€‚</p><h3 id="categoryä¸ºä»€ä¹ˆä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡">Categoryä¸ºä»€ä¹ˆä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡</h3><p>category_tç»“æ„ä½“åªèƒ½å­˜å‚¨å±æ€§ï¼Œä½†æ²¡æœ‰å­˜å‚¨objc_ivar_listç»“æ„ä½“ï¼Œæ²¡æœ‰ç”¨å­˜å‚¨æˆå‘˜å˜é‡çš„åœ°æ–¹ï¼Œæ‰€ä»¥ä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡ã€‚</p><h3 id="loadæ–¹æ³•çš„æ‰§è¡Œ"><code>+load</code>æ–¹æ³•çš„æ‰§è¡Œ</h3><p>Runtimeåœ¨åŠ è½½ç±»å’Œåˆ†ç±»çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨æ‰€æœ‰çš„<code>+load</code>æ–¹æ³•ï¼Œå³ä½¿æ²¡æœ‰è¯¥ç±»è¿˜æ²¡ä½¿ç”¨ã€‚</p><p>è°ƒç”¨æ–¹å¼ï¼šå‡½æ•°åœ°å€ç›´æ¥è°ƒç”¨ã€‚</p><p>è°ƒç”¨æ—¶æœºï¼šåŠ è½½ç±»å’Œåˆ†ç±»æ—¶è°ƒç”¨ä¸€æ¬¡ï¼Œåªä¼šè°ƒç”¨ä¸€æ¬¡ã€‚</p><p><code>+load</code>æ–¹æ³•è°ƒç”¨é¡ºåºï¼š</p><ol type="1"><li>è°ƒç”¨ç±»çš„<code>+load</code><ul><li>æŒ‰ç…§ç¼–è¯‘é¡ºåºè¿›è¡Œï¼›</li><li>å…ˆè°ƒçˆ¶ç±»ï¼Œå†è°ƒå­ç±»ï¼›</li></ul></li><li>æŒ‰ç…§ç¼–è¯‘é¡ºåºè°ƒç”¨åˆ†ç±»çš„<code>+load</code>æ–¹æ³•ã€‚</li></ol><p>å…ˆå»è°ƒç”¨ç±»çš„<code>+load</code>æ–¹æ³•ï¼Œè‹¥æœ‰çˆ¶ç±»åˆ™å…ˆè°ƒç”¨çˆ¶ç±»çš„<code>+load</code>æ–¹æ³•ï¼Œå†å»è°ƒç”¨åˆ†ç±»çš„<code>+load</code>æ–¹æ³•ã€‚</p><h3 id="initializeæ–¹æ³•çš„æ‰§è¡Œ"><code>+initialize</code>æ–¹æ³•çš„æ‰§è¡Œ</h3><p><code>+initialize</code>éœ€è¦åœ¨ä½¿ç”¨ï¼ˆè°ƒç”¨æ–¹æ³•ï¼‰ç±»çš„æ—¶å€™æ‰ä¼šè°ƒç”¨ã€‚å…¶è°ƒç”¨é¡ºåºè·Ÿæ™®é€šæ–¹æ³•ä¸€è‡´ï¼Œå³è‹¥æœ‰åˆ†ç±»å®ç°çš„<code>+initialize</code>æ–¹æ³•ï¼Œåˆ™è°ƒç”¨åˆ†ç±»çš„æ–¹æ³•ã€‚</p><p>è°ƒç”¨æ–¹å¼ï¼š<code>objc_msgSend</code>è°ƒç”¨ã€‚</p><p>è°ƒç”¨æ—¶æœºï¼šåœ¨ç±»ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶è°ƒç”¨ï¼Œæ‰€ä»¥çˆ¶ç±»å¯èƒ½ä¼šæ‰§è¡Œå¤šæ¬¡ï¼ˆåªæœ‰çˆ¶ç±»å®ç°äº†<code>+initialize</code>æ–¹æ³•ï¼Œè€Œå­ç±»æ²¡æœ‰å®ç°ï¼‰ã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://ityongzhen.github.io/%E8%AF%A6%E8%A7%A3iOS%E4%B8%AD%E5%88%86%E7%B1%BBCateogry.html/">è¯¦è§£iOSä¸­åˆ†ç±»Cateogry | æ®·æ°¸æŒ¯</a></li><li><a href="https://juejin.cn/post/6872205313678163981">iOSåº•å±‚ç³»åˆ—ï¼šCategory - æ˜é‡‘</a></li><li><a href="https://juejin.cn/post/6963889820363915300">Objective-Cä¹‹Categoryçš„åº•å±‚å®ç°åŸç† - æ˜é‡‘</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¦‚æœåŸæ¥çš„ç±»å’Œåˆ†ç±»ä¸­æœ‰ç›¸åŒçš„æ–¹æ³•ï¼Œé‚£ä¹ˆæœ€ç»ˆæ‰§è¡Œçš„æ˜¯åˆ†ç±»æ–¹æ³•ã€‚&lt;/p&gt;
&lt;p&gt;ç¼–è¯‘å®Œï¼Œæ¯ä¸ªåˆ†ç±»éƒ½ä¼šç”Ÿæˆä¸€ä¸ªcategory_tç»“æ„ä½“ï¼Œé‡Œé¢å­˜å‚¨åç§°ã€å¯¹è±¡æ–¹æ³•åˆ—è¡¨ã€ç±»æ–¹æ³•åˆ—è¡¨ã€åè®®æ–¹æ³•åˆ—è¡¨ã€å±æ€§åˆ—è¡¨ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Objective-C" scheme="https://bqlin.github.io/tags/Objective-C/"/>
    
    <category term="Runtime" scheme="https://bqlin.github.io/tags/Runtime/"/>
    
  </entry>
  
  <entry>
    <title>Runtimeï¼šç»¼åˆé¢è¯•é¢˜</title>
    <link href="https://bqlin.github.io/posts/runtime_interview_question/"/>
    <id>https://bqlin.github.io/posts/runtime_interview_question/</id>
    <published>2021-11-11T09:43:11.000Z</published>
    <updated>2021-11-11T09:43:11.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="runtimeç»¼åˆé¢è¯•é¢˜">Runtimeç»¼åˆé¢è¯•é¢˜</h1><h2 id="isaæŒ‡é’ˆ">isaæŒ‡é’ˆ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//***********â™¦ï¸â™¦ï¸CLPersonâ™¦ï¸â™¦ï¸************</span><br><span class="line">@interface CLPerson : NSObject</span><br><span class="line">@property (nonatomic, copy) NSString *name;</span><br><span class="line">-(void)print;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation CLPerson</span><br><span class="line">-(void)print &#123;</span><br><span class="line">    NSLog(@&quot;My name&#x27;s %@&quot;, self.name);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//***********ğŸ¥ğŸ¥ViewController.mğŸ¥ğŸ¥************ </span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    id cls = [CLPerson class];</span><br><span class="line">    void *obj = &amp;cls;</span><br><span class="line">    [(__bridge id)obj print]; </span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¾“å‡ºç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">My name&#x27;s &lt;ViewController: 0x7fce43e08aa0&gt;</span><br></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆprintå¯ä»¥è¢«è°ƒç”¨">ä¸ºä»€ä¹ˆ<code>print</code>å¯ä»¥è¢«è°ƒç”¨</h3><p>å› ä¸ºï¼š</p><ul><li>å®ä¾‹å¯¹è±¡ = æŒ‡å‘ç±»çš„æŒ‡é’ˆ</li><li>clsæŒ‡å‘ç±»ï¼ŒobjæŒ‡å‘clsï¼Œç›¸å½“äºobjæ˜¯æŒ‡å‘ç±»çš„æŒ‡é’ˆã€‚</li></ul><p>æ‰€ä»¥<code>(__bridge id)obj</code>å°±ç›¸å½“äºå®ä¾‹å˜é‡çš„æ•ˆæœã€‚</p><h3 id="ä¸ºä»€ä¹ˆæ‰“å°æ˜¯viewcontroller-0x7fce43e08aa0">ä¸ºä»€ä¹ˆæ‰“å°æ˜¯<code>&lt;ViewController: 0x7fce43e08aa0&gt;</code></h3><p>é¦–å…ˆ<code>self.name</code>å°±æ˜¯é€šè¿‡æŒ‡é’ˆè°ƒç”¨çš„<code>self-&gt;_name</code>ã€‚</p><p>å®ä¾‹å¯¹è±¡åº•å±‚æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå­˜æ”¾isaæŒ‡é’ˆå’Œæˆå‘˜å˜é‡åˆ—è¡¨ï¼Œå› ä¸ºæŒ‡é’ˆåœ¨arm64ä½ä¸Šå 8ä½ï¼Œ<code>name</code>åˆæ˜¯CLPersonçš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œæ‰€ä»¥<code>self-&gt;_name</code>å°±æ˜¯åŸºäºå¯¹è±¡åœ°å€å¾€é«˜åœ°å€åç§»8ä½è¯»å–çš„å†…å­˜ã€‚</p><p>æ ˆç©ºé—´æ˜¯å­˜æ”¾è¢«è°ƒç”¨å‡½æ•°å†…éƒ¨æ‰€å®šä¹‰çš„å±€éƒ¨å˜é‡çš„ã€‚å…ˆå®šä¹‰çš„å±€éƒ¨å˜é‡åœ¨æ ˆåº•é«˜åœ°å€ã€‚æ‰€ä»¥ä¸Šè¿°ä»£ç çš„å±€éƒ¨å˜é‡å¸ƒå±€ä¸ºï¼š</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/vdgI8O.jpg" /></p><p>è¿™é‡Œéšè—äº†ä¸ªç»†èŠ‚ï¼š<code>[super viewDidLoad];</code>ã€‚è¯¥ä»£ç çš„åº•å±‚è°ƒç”¨æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">objc_msgSendSuper(</span><br><span class="line">    (__rw_objc_super)&#123;</span><br><span class="line">        (id)self, </span><br><span class="line">        (id)class_getSuperclass(objc_getClass(&quot;ViewController&quot;))&#125;,</span><br><span class="line">    @selector(viewDidLoad));</span><br></pre></td></tr></table></figure><p>ç›¸å½“äºclsçš„é«˜åœ°å€æ–¹å‘è¿˜æœ‰ä¸€ä¸ªselfå±€éƒ¨å˜é‡ï¼Œå°±ViewControllerå®ä¾‹å¯¹è±¡ï¼Œæ‰€ä»¥<code>self-&gt;_name</code>æŒ‡å‘çš„å°±æ˜¯clsçš„ä¸Šä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå³é«˜åœ°å€æ–¹å‘åç§»8ä½â€”â€”ViewControllerå®ä¾‹å¯¹è±¡ã€‚</p><p>æ‰©å±•ï¼šç±»ä¼¼çš„ï¼Œå¦‚æœæ²¡æœ‰<code>[super viewDidLoad];</code>å°±ä¼šå‡ºç°BAD_ACCESSé”™è¯¯ã€‚å¦‚æœclså‰é¢å¤šäº†ä¸ªOCå¯¹è±¡å±€éƒ¨å˜é‡ï¼Œåˆ™æ‰“å°è¯¥å±€éƒ¨å˜é‡ã€‚æ³¨æ„è¿˜æ˜¯éœ€è¦å‰é¢æœ‰ä¸ªOCå¯¹è±¡ï¼Œå¦åˆ™è¿˜æ˜¯ä¼šBAD_ACCESSã€‚</p><p>æ›´å¤šæ‰©å±•ï¼š<a href="https://juejin.cn/post/6844904079953526791">iOSæ¢ç´¢ isaé¢è¯•é¢˜åˆ†æ - æ˜é‡‘</a></p><h2 id="autoreleasepool">autoreleasepool</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@interface ViewController ()</span><br><span class="line">&#123;</span><br><span class="line">    __weak NSString *string_weak;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    // å„åœºæ™¯</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;string: %@ %s&quot;, string_weak,__func__);</span><br><span class="line">&#125;</span><br><span class="line">- (void)viewWillAppear:(BOOL)animated&#123;</span><br><span class="line">    [super viewWillAppear:animated];</span><br><span class="line">    NSLog(@&quot;string: %@ %s&quot;, string_weak,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewDidAppear:(BOOL)animated&#123;</span><br><span class="line">    [super viewDidAppear:animated];</span><br><span class="line">    NSLog(@&quot;string: %@ %s&quot;, string_weak,__func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯ä¸€">åœºæ™¯ä¸€</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NSString *str =  [NSString stringWithFormat:@&quot;https://ityongzhen.github.io/&quot;];</span><br><span class="line">string_weak = str;</span><br><span class="line"></span><br><span class="line">// è¾“å‡º</span><br><span class="line">string: https://ityongzhen.github.io/ -[ViewController viewDidLoad]</span><br><span class="line">string: https://ityongzhen.github.io/ -[ViewController viewWillAppear:]</span><br><span class="line">string: (null) -[ViewController viewDidAppear:]</span><br></pre></td></tr></table></figure><ol type="1"><li>åˆ›å»ºå¯¹è±¡ï¼Œref=1ï¼Œå¹¶æ·»åŠ åˆ°å½“å‰çš„autoreleasepoolä¸­ï¼›</li><li>èµ‹å€¼åˆ°å±€éƒ¨å˜é‡ï¼Œref+1=2ï¼›</li><li><code>viewDidLoad</code>æ–¹æ³•è¿”å›ï¼Œå±€éƒ¨å˜é‡è¢«å›æ”¶ï¼Œref-1=1ï¼›</li><li><code>viewDidLoad</code>å’Œ<code>viewWillAppear</code>åœ¨åŒä¸€ä¸ªRunLoopä¸­ï¼Œæ‰€ä»¥è¿˜èƒ½è®¿é—®ï¼›<code>viewDidLoad</code>å·²ç»æ˜¯ä¸‹ä¸€ä¸ªRunLoopï¼Œå·²ç»è¢«é‡Šæ”¾ã€‚</li></ol><h3 id="åœºæ™¯äºŒ">åœºæ™¯äºŒ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@autoreleasepool &#123;</span><br><span class="line">    NSString *str =  [NSString stringWithFormat:@&quot;https://ityongzhen.github.io/&quot;];</span><br><span class="line">    string_weak = str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è¾“å‡º</span><br><span class="line">string: (null) -[ViewController viewDidLoad]</span><br><span class="line">string: (null) -[ViewController viewWillAppear:]</span><br><span class="line">string: (null) -[ViewController viewDidAppear:]</span><br></pre></td></tr></table></figure><ol type="1"><li>åˆ›å»ºå¯¹è±¡ï¼Œref=1ï¼›</li><li>èµ‹å€¼åˆ°å±€éƒ¨å˜é‡ï¼Œref+1=2ï¼›</li><li>ç¦»å¼€ä½œç”¨åŸŸåŸŸï¼Œref-1=1ï¼›</li><li>ç¦»å¼€autoreleasepoolï¼Œè°ƒç”¨releaseï¼Œref-1=0ï¼Œå¯¹è±¡é‡Šæ”¾ã€‚</li></ol><p>æ‰€ä»¥ååºåœ¨<code>viewDidLoad</code>æ–¹æ³•ä¸­è®¿é—®çš„å¯¹è±¡å·²ç»è¢«é‡Šæ”¾ã€‚</p><h3 id="åœºæ™¯ä¸‰">åœºæ™¯ä¸‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NSString *str = nil;</span><br><span class="line">@autoreleasepool &#123;</span><br><span class="line">    str =  [NSString stringWithFormat:@&quot;https://ityongzhen.github.io/&quot;];</span><br><span class="line">    string_weak = str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è¾“å‡º</span><br><span class="line">string: https://ityongzhen.github.io/ -[ViewController viewDidLoad]</span><br><span class="line">string: (null) -[ViewController viewWillAppear:]</span><br><span class="line">string: (null) -[ViewController viewDidAppear:]</span><br></pre></td></tr></table></figure><ol type="1"><li>åˆ›å»ºå¯¹è±¡ï¼Œref=1ï¼›</li><li>èµ‹å€¼åˆ°å±€éƒ¨å˜é‡ï¼Œref+1=2ï¼›</li><li>ç¦»å¼€autoreleasepoolï¼Œè°ƒç”¨releaseï¼Œref-1=1ï¼Œå¯¹è±¡é‡Šæ”¾ã€‚</li><li><code>viewDidLoad</code>æ–¹æ³•è¿”å›æ—¶ï¼Œref-1=0ï¼Œå¯¹è±¡è¢«é‡Šæ”¾ã€‚</li></ol><p>æ‰€ä»¥åœ¨<code>viewDidLoad</code>æ–¹æ³•ä¸­è®¿é—®å¯¹è±¡æ—¶ï¼Œè¿˜èƒ½è®¿é—®ï¼Œç¦»å¼€æ–¹æ³•åå°±æ— æ³•è®¿é—®ã€‚</p><h3 id="æ³¨æ„">æ³¨æ„</h3><ul><li>å¦‚æœå­—ç¬¦ä¸²è¿‡çŸ­ï¼Œä¼šå˜æˆå­˜å‚¨åœ¨æ ˆçš„TaggedPointerï¼Œæ— éœ€å¼•ç”¨è®¡æ•°ç®¡ç†ï¼Œåœ¨æ‰€æœ‰æ–¹æ³•ä¸­éƒ½å¯ä»¥è®¿é—®ã€‚</li><li>ç±»ä¼¼çš„ï¼Œå¦‚æœå­—ç¬¦ä¸²ä½<code>@"..."</code>å½¢å¼ï¼Œåˆ™å­˜å‚¨åˆ°å¸¸é‡åŒºï¼Œä¹Ÿæ— éœ€å¼•ç”¨è®¡æ•°ç®¡ç†ï¼Œåœ¨æ‰€æœ‰æ–¹æ³•ä¸­ä¹Ÿéƒ½å¯ä»¥è®¿é—®ã€‚</li></ul><p>å¯¹äºæ ˆä¸Šçš„å†…å­˜ï¼Œä¼šåœ¨ç¦»å¼€ä½œç”¨åŸŸåè¢«å›æ”¶ã€‚</p><h2 id="æ›´å¤š">æ›´å¤š</h2><ul><li><a href="https://juejin.cn/post/6844904072428912653">æ·±å…¥æµ…å‡º Runtimeï¼ˆäº”ï¼‰ï¼šç›¸å…³é¢è¯•é¢˜ - æ˜é‡‘</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;runtimeç»¼åˆé¢è¯•é¢˜&quot;&gt;Runtimeç»¼åˆé¢è¯•é¢˜&lt;/h1&gt;
&lt;h2 id=&quot;isaæŒ‡é’ˆ&quot;&gt;isaæŒ‡é’ˆ&lt;/h2&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Objective-C" scheme="https://bqlin.github.io/tags/Objective-C/"/>
    
    <category term="Runtime" scheme="https://bqlin.github.io/tags/Runtime/"/>
    
  </entry>
  
  <entry>
    <title>Runtimeï¼šæ–¹æ³•è°ƒç”¨ä¸å¯¹è±¡æœ¬è´¨</title>
    <link href="https://bqlin.github.io/posts/runtime_method_call_and_object_essence/"/>
    <id>https://bqlin.github.io/posts/runtime_method_call_and_object_essence/</id>
    <published>2021-11-11T09:43:11.000Z</published>
    <updated>2021-11-11T09:43:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ–¹æ³•è°ƒç”¨çš„æµç¨‹ï¼š</p><p><code>objc_msgSend</code>è°ƒç”¨æ–¹æ³•çš„æœ¬è´¨æ˜¯é€šè¿‡isaæŒ‡é’ˆæ‰¾åˆ°è¯¥ç±»ï¼Œç„¶åå¯»æ‰¾æ–¹æ³•ï¼Œæ‰¾åˆ°åè°ƒç”¨ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™é€šè¿‡<code>superClass</code>æ‰¾åˆ°çˆ¶ç±»ï¼Œç»§ç»­æŸ¥æ‰¾æ–¹æ³•ã€‚</p><p>å¯¹è±¡ç»“æ„ä½“ä¸­çš„isaæŒ‡å‘ç±»å¯¹è±¡ã€‚ç±»å¯¹è±¡çš„isaæŒ‡å‘å…ƒç±»ã€‚å…ƒç±»çš„isaæŒ‡å‘NSObjectçš„å…ƒç±»ã€‚</p><p>å¯¹è±¡æ–¹æ³•æ˜¯ä¿å­˜åœ¨ç±»å¯¹è±¡çš„ç»“æ„ä½“ä¸­ï¼Œæ‰€ä»¥è°ƒç”¨å®ä¾‹æ–¹æ³•æ—¶ï¼Œè¦å»ç±»å¯¹è±¡ä¸­æŸ¥æ‰¾ã€‚ä»¥æ­¤ç±»æ¨ï¼Œç±»æ–¹æ³•ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p><p>å®ä¾‹å¯¹è±¡å­˜æ”¾isaæŒ‡é’ˆä»¥åŠç¤ºä¾‹å˜é‡ï¼Œé€šè¿‡isaæŒ‡é’ˆå¯ä»¥æ‰¾åˆ°å®ä¾‹å¯¹è±¡æ‰€å±çš„ç±»å¯¹è±¡ã€‚ç±»ä¸­å­˜æ”¾ç€æ–¹æ³•åˆ—è¡¨ã€‚æ–¹æ³•åˆ—è¡¨ä¸­SELä½œä¸ºkeyï¼ŒIMPä½œä¸ºvalueã€‚åœ¨ç¼–è¯‘æœŸé—´ï¼Œæ ¹æ®æ–¹æ³•åå­—ä¼šç”Ÿæˆå”¯ä¸€çš„æ ‡è¯†SELã€‚IMPæ˜¯æŒ‡å‘æœ€ç»ˆå‡½æ•°å®ç°çš„å‡½æ•°æŒ‡é’ˆã€‚æ•´ä¸ªRuntimeçš„æ ¸å¿ƒæ˜¯<code>objc_msgSend</code>å‡½æ•°ï¼Œé€šè¿‡ç»™ç±»å‘é€SELä¼ é€’æ¶ˆæ¯ï¼Œæ‰¾åˆ°åŒ¹é…çš„IMPå†è·å¾—æœ€ç»ˆçš„å®ç°ï¼Œå¹¶æ‰§è¡Œæ–¹æ³•ã€‚</p><p><strong>æ¶ˆæ¯å‘é€é˜¶æ®µ</strong>ï¼š</p><ol type="1"><li>åˆ¤æ–­receiveræ˜¯å¦ä¸ºç©ºï¼Œæ˜¯åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™ç»§ç»­ã€‚</li><li>ä»receiverClassçš„ç¼“å­˜ä¸­ï¼ŒæŸ¥æ‰¾æ–¹æ³•æ‰¾åˆ°åˆ™è°ƒç”¨æ–¹æ³•ï¼Œå¦åˆ™ç»§ç»­ã€‚</li><li>ä»receiverClassçš„<code>class_rw_t</code>ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œå¦‚æœæ‰¾åˆ°äº†åˆ™ç¼“å­˜ä¸‹æ¥ï¼Œè°ƒç”¨æ–¹æ³•ï¼Œå¦åˆ™ç»§ç»­ã€‚</li><li>å»çˆ¶ç±»çš„ç¼“å­˜å’Œ<code>class_rw_t</code>ä¸­æŸ¥æ‰¾ï¼Œæ­¥éª¤åŒä¸Šï¼Œæ‰¾åˆ°äº†åˆ™ç¼“å­˜ä¸‹æ¥ï¼Œæ²¡æœ‰åˆ™ç»§ç»­å¾€ä¸Šæ‰¾çˆ¶ç±»ï¼Œéƒ½æ²¡æœ‰åˆ™æ¶ˆæ¯å‘é€é˜¶æ®µç»“æŸï¼Œè¿›å…¥ç¬¬äºŒé˜¶æ®µï¼šåŠ¨æ€æ–¹æ³•è§£æã€‚</li></ol><p><strong>åŠ¨æ€æ–¹æ³•è§£æé˜¶æ®µ</strong>ï¼š</p><p>è°ƒç”¨<code>-/+resolveClassMethod:</code>ï¼Œåœ¨æ–¹æ³•ä¸­è°ƒç”¨<code>class_addMethod</code>å‡½æ•°æ·»åŠ SELå¯¹åº”çš„æ–¹æ³•å®ç°IMPã€‚ä»¥ä¸Šæ–¹æ³•ä¸­æ²¡æœ‰å¤„ç†ï¼Œåˆ™è¿›å…¥ç¬¬ä¸‰é˜¶æ®µï¼šæ¶ˆæ¯è½¬å‘ã€‚</p><p><strong>æ¶ˆæ¯è½¬å‘é˜¶æ®µ</strong>ï¼š</p><ol type="1"><li>åˆ¤æ–­<code>-/+forwardingTargetForSelector:</code>çš„è¿”å›å€¼ï¼Œéç©ºåˆ™è°ƒç”¨<code>objc_msgSend(è¿”å›å€¼, SEL)</code>ï¼Œå‘è¿”å›å€¼å‘é€æ¶ˆæ¯ã€‚è¿”å›ç©ºåˆ™ç»§ç»­ã€‚</li><li>è°ƒç”¨<code>-/+methodSignatureForSelector:</code>æ–¹æ³•ï¼Œå¦‚æœè¿”å›ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨<code>-/+forwardInvocation:</code>æ–¹æ³•ä¸­å¤„ç†ã€‚è‹¥æœ¬ç±»æ— æ³•å¤„ç†åˆ™ç»§ç»­å¾€çˆ¶ç±»æŸ¥è¯¢ã€‚å¦‚æœè¿”å›ç©ºï¼Œåˆ™ç»§ç»­ã€‚</li><li>è°ƒç”¨<code>-doesNotRecognizeSelector:</code>æ–¹æ³•ã€‚</li></ol><p>æ³¨æ„ï¼šåªèƒ½å¯¹è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºçš„ç±»æ·»åŠ æˆå‘˜å˜é‡ï¼ˆivarsï¼‰ï¼Œä¸èƒ½å‘å·²å­˜åœ¨çš„ç±»æ·»åŠ æˆå‘˜å˜é‡ã€‚å› ä¸ºåœ¨ç¼–è¯‘æ—¶åªè¯»çš„class_ro_tç»“æ„ä½“å°±è¢«ç¡®å®šä¸‹æ¥ï¼Œå…¶åŒ…å«äº†åˆ†é…å¯¹è±¡çš„ç©ºé—´å¤§å°ï¼Œåœ¨è¿è¡Œæ—¶ä¸å¯æ”¹å˜ã€‚</p><h3 id="nsproxy">NSProxy</h3><p>NSProxyå’ŒNSObjectæ˜¯åŒä¸€å±‚çº§çš„ï¼Œå¯ä»¥ç†è§£ä¸ºNSProxyæ˜¯ä¸€ä¸ªåŸºç±»ï¼Œéƒ½éµå¾ªäº†NSObjectåè®®ã€‚NSProxyå°±æ˜¯ä¸“é—¨ç”¨æ¥è§£å†³é‡ç‚¹å¯¹è±¡è½¬å‘çš„é—®é¢˜ã€‚</p><p>ä¸NSObjectæ¥æ”¶æ¶ˆæ¯æµç¨‹ä¸ä¸€æ ·ï¼ŒNSProxyç®€åŒ–äº†å…¶ä¸­çš„æµç¨‹ï¼š</p><ol type="1"><li><code>[proxyObj message]</code></li><li>åˆ°proxyObjç±»å¯¹è±¡å¯»æ‰¾å¯¹åº”çš„æ–¹æ³•ï¼Œæ‰¾åˆ°è°ƒç”¨ã€‚å¦åˆ™ç»§ç»­ã€‚</li><li>å°è¯•è°ƒç”¨<code>resolveClassMethod</code>è¿›è¡ŒåŠ¨æ€æ–¹æ³•è§£æ</li><li><del>å°è¯•è¿›å…¥çˆ¶ç±»å¯¹è±¡é€’å½’æŸ¥æ‰¾æ–¹æ³•ï¼Œæ‰¾åˆ°è°ƒç”¨ã€‚å¦åˆ™ç»§ç»­ã€‚</del></li><li><del>å°è¯•è°ƒç”¨<code>forwardingTargetForSelector</code>è¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚è¿”å›ç©ºåˆ™ç»§ç»­ã€‚</del></li><li>å°è¯•è°ƒç”¨<code>methodSignatureForSelector</code>+<code>forwardInvocation</code>è¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚</li></ol><p>æ‰€ä»¥å¯¹äºå¤„ç†æ¶ˆæ¯è½¬å‘ï¼Œå®ƒæ¯”NSObjectæ›´é«˜æ•ˆã€‚ä¹Ÿé˜æ˜äº†è¯¥ç±»çš„ä½¿ç”¨æ–¹å¼å°±æ˜¯å®ç°æ¶ˆæ¯è½¬å‘çš„ä¸¤ä¸ªæ–¹æ³•å³å¯ã€‚</p><p>æ³¨æ„ï¼Œæ— éœ€è°ƒç”¨initæ–¹æ³•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;CLProxy2.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation CLProxy2</span><br><span class="line"></span><br><span class="line">+(instancetype)proxyWithTarget: (id)target &#123;</span><br><span class="line">// NSProxyå¯¹è±¡ä¸éœ€è¦è°ƒç”¨initï¼Œå› ä¸ºå®ƒæœ¬æ¥å°±æ²¡æœ‰initæ–¹æ³•ï¼Œç›´æ¥allocä¹‹åå°±å¯ä»¥ä½¿ç”¨</span><br><span class="line">    CLProxy2 *proxy = [CLProxy2 alloc];</span><br><span class="line">    proxy.target = target;</span><br><span class="line">    return proxy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-(NSMethodSignature *)methodSignatureForSelector:(SEL)sel &#123;</span><br><span class="line">    return [self.target methodSignatureForSelector:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)forwardInvocation:(NSInvocation *)invocation &#123;</span><br><span class="line">    invocation.target = self.target;</span><br><span class="line">    [invocation invoke];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure><h2 id="isa">isa</h2><p>ä»arm64æ¶æ„å¼€å§‹ï¼Œisaå˜æˆäº†ä¸€ä¸ªå…±ç”¨ä½“ï¼ˆunionï¼‰ç»“æœï¼Œä½¿ç”¨ä½åŸŸæ¥å­˜å‚¨æ›´å¤šä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">isa_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">isa_t</span>() &#123; &#125;</span><br><span class="line">    <span class="keyword">isa_t</span>(<span class="keyword">uintptr_t</span> value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    <span class="keyword">uintptr_t</span> bits;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ISA_BITFIELD;  <span class="comment">// defined in isa.h</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">define ISA_BITFIELD                                                      \</span><br><span class="line">      <span class="keyword">uintptr_t</span> nonpointer        : <span class="number">1</span>;   <span class="comment">//æŒ‡é’ˆæ˜¯å¦ä¼˜åŒ–è¿‡                                   \</span></span><br><span class="line"><span class="comment">      uintptr_t has_assoc         : 1;   //æ˜¯å¦æœ‰è®¾ç½®è¿‡å…³è”å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«                                   \</span></span><br><span class="line"><span class="comment">      uintptr_t has_cxx_dtor      : 1;  //æ˜¯å¦æœ‰C++çš„ææ„å‡½æ•°ï¼ˆ.cxx_destructï¼‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«                                     \</span></span><br><span class="line"><span class="comment">      uintptr_t shiftcls          : 33; //å­˜å‚¨ç€Classã€Meta-Classå¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯ \</span></span><br><span class="line"><span class="comment">      uintptr_t magic             : 6;  //ç”¨äºåœ¨è°ƒè¯•æ—¶åˆ†è¾¨å¯¹è±¡æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ–                                     \</span></span><br><span class="line"><span class="comment">      uintptr_t weakly_referenced : 1;  //æ˜¯å¦æœ‰è¢«å¼±å¼•ç”¨æŒ‡å‘è¿‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«                                     \</span></span><br><span class="line"><span class="comment">      uintptr_t deallocating      : 1;  //å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾                                     \</span></span><br><span class="line"><span class="comment">      uintptr_t has_sidetable_rc  : 1;  //å¼•ç”¨è®¡æ•°å™¨æ˜¯å¦è¿‡å¤§æ— æ³•å­˜å‚¨åœ¨isaä¸­                                     \</span></span><br><span class="line"><span class="comment">      uintptr_t extra_rc          : 19 //é‡Œé¢å­˜å‚¨çš„å€¼æ˜¯å¼•ç”¨è®¡æ•°å™¨å‡1</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_ONE   (1ULL&lt;&lt;45)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_HALF  (1ULL&lt;&lt;18)</span></span><br></pre></td></tr></table></figure><ul><li><code>nonpointer</code>ï¼š0ï¼šæ™®é€šæŒ‡é’ˆï¼Œå­˜å‚¨ç€Classã€Meta-Classå¯¹è±¡çš„å†…å­˜åœ°å€ï¼›1ï¼šä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ã€‚</li><li><code>has_assoc</code>ï¼šæ˜¯å¦æœ‰å…³è”è¿‡å¯¹è±¡ã€‚å¦ï¼šé‡Šæ”¾æ›´å¿«ã€‚</li><li><code>has_cxx_dtor</code>ï¼šæ˜¯å¦æœ‰C++ææ„å‡½æ•°ï¼ˆ.cxx_destructï¼‰ã€‚å¦ï¼šé‡Šæ”¾æ›´å¿«ã€‚</li><li><code>shiftcls</code>ï¼šå­˜å‚¨ç€Classã€Meta-Classå¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯ã€‚</li><li><code>magic</code>ï¼šè°ƒè¯•æ—¶åˆ†è¾¨æ˜¯å¦å®Œæˆåˆå§‹åŒ–ã€‚</li><li><code>weakly_referenced</code>ï¼šæ˜¯å¦è¢«å¼±å¼•ç”¨æŒ‡å‘è¿‡ã€‚å¦ï¼šé‡Šæ”¾æ›´å¿«ã€‚</li><li><code>deallocating</code>ï¼šå¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾ã€‚</li><li><code>extra_rc</code>ï¼šå¼•ç”¨è®¡æ•°å™¨-1ã€‚</li><li><code>has_sidetable_rc</code>ï¼šå¼•ç”¨è®¡æ•°å™¨æ˜¯å¦è¿‡å¤§æ— æ³•å­˜å‚¨åœ¨isaä¸­ã€‚1ï¼šå¼•ç”¨è®¡æ•°å™¨ä¼šå­˜å‚¨åœ¨SideTableç±»çš„å±æ€§ä¸­ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">objc_destructInstance</span><span class="params">(id obj)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">        <span class="comment">//æ˜¯å¦æœ‰C++çš„ææ„å‡½æ•°</span></span><br><span class="line">        <span class="keyword">bool</span> cxx = obj-&gt;hasCxxDtor();</span><br><span class="line">        <span class="comment">//æ˜¯å¦æœ‰è®¾ç½®è¿‡å…³è”å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">bool</span> assoc = obj-&gt;hasAssociatedObjects();</span><br><span class="line">        <span class="comment">//æœ‰C++çš„ææ„å‡½æ•°ï¼Œå°±å»é”€æ¯</span></span><br><span class="line">        <span class="keyword">if</span> (cxx) object_cxxDestruct(obj);</span><br><span class="line">         <span class="comment">//æœ‰è®¾ç½®è¿‡å…³è”å¯¹è±¡ï¼Œå°±å»ç§»é™¤ç®¡ç†å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (assoc) _object_remove_assocations(obj);</span><br><span class="line">        </span><br><span class="line">        obj-&gt;clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="class">class</h2><figure><img src="https://gitee.com/bqlin/image-land/raw/master/image-20211111175507815.png" alt="image-20211111175507815" /><figcaption aria-hidden="true">image-20211111175507815</figcaption></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="keyword">cache_t</span> cache;    <span class="comment">//æ–¹æ³•ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">class_data_bits_t</span> bits;    <span class="comment">// ç”¨äºè·å–å…·ä½“çš„ç±»çš„ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>method_array_tã€property_array_tã€protocol_array_tæ˜¯å¯è¯»å†™çš„äºŒç»´æ•°ç»„ï¼ŒåŒ…å«äº†ç±»çš„åˆå§‹å†…å®¹ã€åˆ†ç±»å†…å®¹ã€‚</p><p>å¦‚ï¼šmethod_array_tåŒ…å«å¤šä¸ªä¸€ä½æ•°ç»„method_list_tï¼Œmethod_list_té‡Œé¢å­˜æ”¾å¤šä¸ªmethod_tï¼Œmethod_tå­˜æ”¾åœ¨æ–¹æ³•impæŒ‡é’ˆã€åç§°ã€ç±»å‹ç­‰ä¿¡æ¯ã€‚</p><h3 id="method_t">method_t</h3><p>æ–¹æ³•ã€å‡½æ•°çš„å°è£…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">method_t</span> &#123;</span></span><br><span class="line">    SEL name; <span class="comment">// å‡½æ•°å</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *types; <span class="comment">// Type Encoding ç¼–ç (è¿”å›å€¼ç±»å‹ï¼Œå‚æ•°ç±»å‹)</span></span><br><span class="line">    MethodListIMP imp; <span class="comment">// æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ(å‡½æ•°åœ°å€)</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SortBySELAddress</span> :</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">std</span>::binary_function&lt;<span class="keyword">const</span> <span class="keyword">method_t</span>&amp;,</span><br><span class="line">                                    <span class="keyword">const</span> <span class="keyword">method_t</span>&amp;, <span class="keyword">bool</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">method_t</span>&amp; lhs,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="keyword">const</span> <span class="keyword">method_t</span>&amp; rhs)</span></span></span><br><span class="line"><span class="function">        </span>&#123; <span class="keyword">return</span> lhs.name &lt; rhs.name; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>IMPï¼šå‡½æ•°çš„å…·ä½“å®ç°ã€‚</p><p>SELï¼šæ–¹æ³•ã€å‡½æ•°åï¼Œåº•å±‚ç»“æ„ä¸<code>char *</code>ç±»ä¼¼ã€‚å¯ä»¥é€šè¿‡<code>@selector()</code>å’Œ<code>sel_registerName()</code>è·å¾—ã€‚å¯ä»¥é€šè¿‡<code>sel_getName()</code>å’Œ<code>NSStringFromSelector()</code>è½¬æˆå­—ç¬¦ä¸²ã€‚åå­—ç›¸åŒçš„æ–¹æ³•ï¼ŒSELä¹Ÿæ˜¯ç›¸åŒçš„ã€‚</p><h3 id="class_ro_t">class_ro_t</h3><p>æè¿°çš„æ˜¯ç±»çš„åˆå§‹å†…å®¹ï¼Œå…¶ä¸­çš„<code>baseMethodList</code>ã€<code>baseProtocols</code>ã€<code>ivars</code>ã€<code>baseProperties</code>æ˜¯åªè¯»çš„ä¸€ç»´æ•°ç»„ã€‚</p><h3 id="cache_t">cache_t</h3><p>æ–¹æ³•ç¼“å­˜ã€‚ç”¨å“ˆå¸Œè¡¨ç¼“å­˜è°ƒç”¨è¿‡çš„æ–¹æ³•ï¼Œå¯ä»¥æé«˜æ–¹æ³•æŸ¥æ‰¾é€Ÿåº¦ã€‚</p><p>å½“æ–¹æ³•ç¼“å­˜å¤ªå¤šçš„æ—¶å€™ï¼Œè¶…è¿‡äº†è¡¨å®¹é‡çš„3/4çš„æ—¶å€™ï¼Œå°±è¦æ‰©å®¹ä¸ºåŸæ¥çš„2å€ã€‚</p><h2 id="ç±»çš„æœ¬è´¨">ç±»çš„æœ¬è´¨</h2><p>ä¸€ä¸ªNSObjectçš„æœ¬è´¨æ˜¯åŒ…å«ä¸€ä¸ªisaæŒ‡é’ˆçš„ç»“æ„ä½“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct NSObject_IMPL &#123;</span><br><span class="line">Class isa;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œå…¶å­ç±»æ˜¯åœ¨isaæŒ‡é’ˆçš„åŸºç¡€ä¸Šå†åŠ ä¸Šè‡ªèº«çš„æˆå‘˜å˜é‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct Student_IMPL &#123;</span><br><span class="line">    struct NSObject_IMPL NSObject_IVARS;</span><br><span class="line">    int _age;</span><br><span class="line">    int _no;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä¸€ä¸ªå­ç±»çš„åº•å±‚ç»“æ„ä½“æ˜¯å…¶çˆ¶ç±»ç»“æ„ä½“é‡Œçš„æ‰€æœ‰æˆå‘˜å˜é‡ + å­ç±»è‡ªèº«å®šä¹‰çš„æˆå‘˜å˜é‡æ‰€ç»„æˆçš„ç»“æ„ä½“ã€‚</p><p><code>class_getInstanceSize</code>ï¼šè·å–OCç±»å®ä¾‹å¯¹è±¡çš„å®é™…å¤§å°ã€‚è¿™ä¸ªå¤§å°å¯ä»¥ç†è§£ä¸ºè¯¥å®ä¾‹å¯¹è±¡è‡³å°‘éœ€è¦çš„ç©ºé—´å¤§å°ï¼Œå®é™…åˆ†é…å¤§å°éœ€è¦ä½¿ç”¨<code>malloc_size</code>ã€‚</p><p><code>malloc_size</code>ï¼šå¾—åˆ°ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ç©ºé—´å¤§å°ï¼Œè¿™æ˜¯ç³»ç»Ÿä¸ºè¿™ä¸ªå¯¹è±¡æœ€ç»ˆåˆ†é…çš„å†…å­˜å¤§å°ã€‚</p><p>æ‰€ä»¥å›åˆ°é—®é¢˜ï¼šä¸€ä¸ªNSObjectå¯¹è±¡å ç”¨å¤šå°‘å†…å­˜ï¼Ÿ</p><ul><li>ç³»ç»Ÿåˆ†é…äº†16å­—èŠ‚ï¼ˆé€šè¿‡<code>malloc_size</code>è·å–ï¼‰ï¼›</li><li>NSObjectå†…éƒ¨åªä½¿ç”¨äº†8ä¸ªå­—èŠ‚æ¥å­˜æ”¾isaæŒ‡é’ˆå˜é‡ã€‚</li></ul><h2 id="å¯¹è±¡çš„ç§ç±»">å¯¹è±¡çš„ç§ç±»</h2><p>OCå¯¹è±¡ä¸»è¦åˆ†ä¸º3ç±»ï¼š</p><ul><li>å®ä¾‹å¯¹è±¡ï¼ˆinstanceï¼‰</li><li>ç±»å¯¹è±¡ï¼ˆclassï¼‰</li><li>å…ƒç±»å¯¹è±¡ï¼ˆmeta-classï¼‰</li></ul><p>å®ä¾‹å¯¹è±¡é€šè¿‡ç±»<code>alloc</code>æ–¹æ³•åˆ›å»ºå‡ºæ¥ã€‚å­˜æ”¾çš„ä¿¡æ¯ï¼š</p><ul><li><code>isa</code>æŒ‡é’ˆï¼ˆæŒ‡å‘ç±»ï¼‰ã€‚</li><li>æˆå‘˜å˜é‡ã€‚</li></ul><p>ç±»å¯¹è±¡åœ¨å†…å­˜ä¸­æ˜¯å”¯ä¸€ã€‚çš„ç±»å¯¹è±¡ç”¨æ¥æè¿°ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå­˜æ”¾ä¿¡æ¯ï¼š</p><ul><li><code>isa</code>æŒ‡é’ˆï¼ˆæŒ‡å‘å…ƒç±»ï¼‰å’Œ<code>superclass</code>æŒ‡é’ˆ</li><li>å±æ€§</li><li>å¯¹è±¡æ–¹æ³•</li><li>åè®®</li><li>æˆå‘˜å˜é‡</li></ul><p>å…ƒç±»å¯¹è±¡åœ¨å†…å­˜ä¸­ä¹Ÿæ˜¯å”¯ä¸€çš„ã€‚å…ƒç±»å¯¹è±¡ç”¨æ¥æè¿°ä¸€ä¸ªç±»å¯¹è±¡ï¼Œå­˜æ”¾ä¿¡æ¯ï¼š</p><ul><li><code>isa</code>æŒ‡é’ˆå’Œ<code>superclass</code>æŒ‡é’ˆï¼ˆæŒ‡å‘è¯¥ç±»çˆ¶ç±»çš„å…ƒç±»ï¼‰</li><li>ç±»æ–¹æ³•</li></ul><p>ç±»å’Œå…ƒç±»éƒ½æ˜¯objc_classï¼ˆç»§æ‰¿è‡ªobjc_objectï¼‰ï¼Œä¹Ÿæœ‰isaæŒ‡é’ˆï¼Œä¹Ÿæ˜¯å¯¹è±¡ã€‚</p><p>å…ƒç±»çš„<code>superclass</code>æŒ‡å‘åŸºç±»çš„ç±»å¯¹è±¡ï¼Œè€…å†³å®šäº†ï¼š</p><p>å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªç±»æ–¹æ³•æ—¶ï¼Œä¼šé€šè¿‡ç±»çš„isaæŒ‡é’ˆæ‰¾åˆ°å…ƒç±»ï¼Œåœ¨å…ƒç±»ä¸­æŸ¥æ‰¾æœ‰æ— è¯¥ç±»æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰åˆ™é€šè¿‡<code>superclass</code>é€çº§æŸ¥è¯¢çˆ¶å…ƒç±»ï¼Œä¸€ç›´æ‰¾åˆ°åŸºç±»çš„å…ƒç±»ï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œåˆ™å»æ‰¾åŸºç±»ä¸­çš„åŒåçš„å®ä¾‹æ–¹æ³•å®ç°ã€‚</p><h2 id="super">super</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>: <span class="title">NSObject</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>: <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">init</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;className: <span class="subst">\(<span class="keyword">self</span>.className)</span>, super.className: <span class="subst">\(<span class="keyword">super</span>.className)</span>&quot;</span>)</span><br><span class="line">        <span class="comment">// FoundationSwift.Student, FoundationSwift.Student</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;superclass: <span class="subst">\(<span class="keyword">self</span>.super<span class="keyword">class</span><span class="operator">!</span>)</span>, super.superclass: <span class="subst">\(<span class="keyword">super</span>.super<span class="keyword">class</span><span class="operator">!</span>)</span>&quot;</span>)</span><br><span class="line">        <span class="comment">// superclass: Person, super.superclass: Person</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å‘ç°ï¼Œ superå’Œselfè°ƒç”¨çš„ç»“æ„éƒ½æ˜¯ç›¸åŒçš„ã€‚</p><p>superè°ƒç”¨æ–¹æ³•å®é™…ä¸Šæ˜¯è°ƒç”¨äº†<code>objc_msgSendSuper(arg, SEL)</code>å‡½æ•°ã€‚é‡ç‚¹æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå…¶ç±»å‹æ˜¯<code>__rw_objc_super</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//â™¥ï¸â™¥ï¸â™¥ï¸C++ä¸­é—´ä»£ç é‡Œçš„å®šä¹‰</span><br><span class="line">struct __rw_objc_super &#123; </span><br><span class="line">struct objc_object *object; </span><br><span class="line">struct objc_object *superClass; </span><br><span class="line">__rw_objc_super(struct objc_object *o, struct objc_object *s) : object(o), superClass(s) &#123;&#125; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//âš ï¸âš ï¸âš ï¸objcæºç ä¸­çš„å®šä¹‰</span><br><span class="line">/// Specifies the superclass of an instance. </span><br><span class="line">struct objc_super &#123;</span><br><span class="line">    /// Specifies an instance of a class.</span><br><span class="line">    __unsafe_unretained _Nonnull id receiver;</span><br><span class="line"></span><br><span class="line">    /// Specifies the particular superclass of the instance to message. </span><br><span class="line">#if !defined(__cplusplus)  &amp;&amp;  !__OBJC2__</span><br><span class="line">    /* For compatibility with old objc-runtime.h header */</span><br><span class="line">    __unsafe_unretained _Nonnull Class class;</span><br><span class="line">#else</span><br><span class="line">    __unsafe_unretained _Nonnull Class super_class;</span><br><span class="line">#endif</span><br><span class="line">    /* super_class is the first class to search */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>objc_superç»“æ„ä½“æˆå‘˜ï¼š</p><ul><li><code>id receiver</code>ï¼šæ¶ˆæ¯æ¥æ”¶è€…ï¼Œå®å‚ä¼ é€’çš„å°±æ˜¯selfï¼Œå³Studentå¯¹è±¡ã€‚</li><li><code>Class super_class</code>ï¼šçˆ¶ç±»ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id objc_msgSendSuper(struct objc_super *super, SEL op, ...)</span><br></pre></td></tr></table></figure><ul><li><code>struct objc_super *super</code>ï¼šç»“æ„ä½“æŒ‡é’ˆï¼Œå†…å®¹æ˜¯<code>&#123;æ¶ˆæ¯æ¥æ”¶è€…ï¼ˆrecvï¼‰ï¼Œ æ¶ˆæ¯æ¥æ”¶è€…çš„çˆ¶ç±»ç±»å¯¹è±¡ï¼ˆ[[recv superclass] class]ï¼‰&#125;</code>ã€‚<code>objc_msgSendSuper</code>ä¼šå°†æ¶ˆæ¯æ¥æ”¶è€…çš„çˆ¶ç±»å¯¹è±¡ä½œä¸ºæ¶ˆæ¯æŸ¥æ‰¾çš„èµ·ç‚¹ã€‚</li><li><code>SEL op</code>ï¼šè¦æŸ¥æ‰¾çš„æ–¹æ³•ã€‚</li></ul><p>æ‰€ä»¥è¯´ï¼Œè°ƒç”¨superä¸è°ƒç”¨selfçš„ä¸åŒåªæ˜¯superæŠŠæŸ¥æ‰¾æ–¹æ³•çš„èµ·ç‚¹æ”¹ä¸ºä»çˆ¶ç±»å¼€å§‹è€Œå·²ï¼Œæ‰€ä»¥åƒä¸€äº›çˆ¶ç±»æ²¡æœ‰å®ç°ï¼Œè€ŒNSObjectåŸºç±»å®ç°çš„æ–¹æ³•ï¼Œä¸¤è€…è°ƒç”¨ç»“æœæ— å¼‚ï¼Œå› ä¸ºæœ€ç»ˆçš„æ¶ˆæ¯æ¥æ”¶è€…è¿˜æ˜¯selfï¼Œå³å½“å‰å¯¹è±¡ã€‚</p><p>è‹¥è¦æƒ³superå’Œselfè°ƒç”¨æ–¹æ³•ç»“æœä¸ä¸€è‡´ï¼Œå¿…é¡»æ˜¯å½“å‰ç±»å’Œçˆ¶ç±»éƒ½å®ç°äº†ç›¸åŒçš„æ–¹æ³•ï¼Œè‹¥åªæœ‰çˆ¶ç±»å®ç°äº†ï¼Œå°±éƒ½æ˜¯çˆ¶ç±»çš„ç»“æœã€‚è¿™ä¸ä¸€èˆ¬æ–¹æ³•æŸ¥æ‰¾çˆ¶ç±»å®ç°çš„é€»è¾‘ä¸€è‡´ã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://juejin.cn/post/6844903793138597896">OCå¯¹è±¡çš„æœ¬è´¨ï¼ˆä¸Šï¼‰ï¼šOCå¯¹è±¡çš„åº•å±‚å®ç°åŸç† - æ˜é‡‘</a></li><li><a href="https://juejin.cn/post/6963522983105134629">OCå¯¹è±¡çš„æœ¬è´¨ï¼ˆä¸­ï¼‰ï¼šOCå¯¹è±¡çš„ç§ç±» - æ˜é‡‘</a></li><li><a href="https://juejin.cn/post/6963524896672464903">OCå¯¹è±¡çš„æœ¬è´¨ï¼ˆä¸‹ï¼‰â€”â€” è¯¦è§£isa&amp;superclassæŒ‡é’ˆ - æ˜é‡‘</a></li><li><a href="https://juejin.cn/post/6844903474908364808">æ·±å…¥ç†è§£ Objective-C Runtime æœºåˆ¶ - æ˜é‡‘</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ–¹æ³•è°ƒç”¨çš„æµç¨‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;code&gt;objc_msgSend&lt;/code&gt;è°ƒç”¨æ–¹æ³•çš„æœ¬è´¨æ˜¯é€šè¿‡isaæŒ‡é’ˆæ‰¾åˆ°è¯¥ç±»ï¼Œç„¶åå¯»æ‰¾æ–¹æ³•ï¼Œæ‰¾åˆ°åè°ƒç”¨ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™é€šè¿‡&lt;code&gt;superClass&lt;/code&gt;æ‰¾åˆ°çˆ¶ç±»ï¼Œç»§ç»­æŸ¥æ‰¾æ–¹æ³•ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Objective-C" scheme="https://bqlin.github.io/tags/Objective-C/"/>
    
    <category term="Runtime" scheme="https://bqlin.github.io/tags/Runtime/"/>
    
  </entry>
  
  <entry>
    <title>Objective-Cï¼šTagged Pointer</title>
    <link href="https://bqlin.github.io/posts/tagged_pointer/"/>
    <id>https://bqlin.github.io/posts/tagged_pointer/</id>
    <published>2021-11-10T10:32:32.000Z</published>
    <updated>2021-11-10T10:32:32.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä»‹ç»ï¼š</p><p>TaggedPointerä¸“é—¨ç”¨æ¥å­˜å‚¨å°çš„å¯¹è±¡ï¼Œå¦‚NSNumberã€NSDateã€NSStringã€‚å…¶å­˜å‚¨çš„ä¸æ˜¯åœ°å€ï¼Œè€Œæ˜¯çœŸæ­£çš„å€¼ï¼Œæ‰€ä»¥å®ƒç›´æ¥å­˜å‚¨åˆ°æ ˆä¸­ã€‚</p><p>å¼•å…¥ï¼š</p><p>å¯¹äºæŒ‡é’ˆç±»å‹ï¼Œå…¶é•¿åº¦è¶³å¤Ÿå­˜å‚¨ä¸€äº›çŸ­å°çš„å€¼ï¼Œè€Œä¸å¿…æ“ä½œå †åˆ†é…ä¸ç®¡ç†å†…å­˜ã€‚å¯¹äºå¤§çš„å€¼ï¼Œå³è¶…è¿‡æŒ‡é’ˆç±»å‹é•¿åº¦çš„ï¼Œåˆ™è¿˜æ˜¯åœ¨å †ä¸­åˆ†é…å†…å­˜ã€‚æ‰€ä»¥å¯¹äºå°çš„å€¼æŒ‡é’ˆå†…å®¹å°±åŒ…å«å€¼ï¼Œè€Œå¤§çš„å€¼æ‰æ˜¯å †å†…å­˜åœ°å€ã€‚</p><p>å­˜å‚¨å†…å®¹ï¼šå€¼+æ ‡è®°</p><h2 id="é¢è¯•é¢˜">é¢è¯•é¢˜</h2><h4 id="æ‰§è¡Œä»¥ä¸‹ä¸¤æ®µä»£ç æœ‰ä»€ä¹ˆåŒºåˆ«">æ‰§è¡Œä»¥ä¸‹ä¸¤æ®µä»£ç ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;abcdefghij&quot;</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šå´©æºƒï¼Œå› ä¸ºè¯¥<code>name</code>ä¸º<code>__NSCFString</code>ç±»å‹ï¼Œå­˜å‚¨åœ¨å †ä¸Šï¼Œæ˜¯ä¸ªå¸¸è§„å¯¹è±¡ï¼Œéœ€è¦ç»´æŠ¤å¼•ç”¨è®¡æ•°ã€‚é€šè¿‡setterèµ‹å€¼ï¼Œå¼‚æ­¥å¹¶å‘è°ƒç”¨ä¼šæœ‰å¤šæ¡çº¿ç¨‹æ‰§è¡Œ<code>[_name release]</code>ï¼Œè¿ç»­<code>release</code>ä¸¤æ¬¡å°±ä¼šé€ æˆå¯¹è±¡çš„è¿‡åº¦é‡Šæ”¾ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue = dispatch_get_global_queue(0, 0);</span><br><span class="line">for (int i = 0; i &lt; 1000; i++) &#123;</span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">        self.name = [NSString stringWithFormat:@&quot;abcdefghi&quot;];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£å¸¸ï¼Œè¯¥<code>name</code>ä¸º<code>NSTaggedPointerString</code>ç±»å‹ï¼Œåœ¨<code>objc_release</code>å‡½æ•°ä¸­ä¼šåˆ¤æ–­æŒ‡é’ˆæ˜¯ä¸æ˜¯<code>TaggedPointer</code>ç±»å‹ï¼Œæ˜¯çš„è¯å°±ä¸å¯¹å¯¹è±¡è¿›è¡Œ<code>release</code>æ“ä½œï¼Œä¹Ÿå°±é¿å…äº†è¿‡åº¦é‡Šæ”¾å¯¹è±¡ã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://juejin.cn/post/6844903475562676238">iOS Tagged Pointer (æºç é˜…è¯»å¿…å¤‡çŸ¥è¯†) - æ˜é‡‘</a></li><li><a href="https://blog.devtang.com/2014/05/30/understand-tagged-pointer/">æ·±å…¥ç†è§£Tagged Pointer Â· å”å·§çš„åšå®¢</a></li><li><a href="https://juejin.cn/post/6844904132940136462">iOS - è€ç”Ÿå¸¸è°ˆå†…å­˜ç®¡ç†ï¼ˆäº”ï¼‰ï¼šTagged Pointer - æ˜é‡‘</a></li><li><a href="https://www.infoq.cn/article/r5s0budukwyndafrivh4">iOSå†…å­˜ç®¡ç†ä¹‹Tagged Pointer-InfoQ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»‹ç»ï¼š&lt;/p&gt;
&lt;p&gt;TaggedPointerä¸“é—¨ç”¨æ¥å­˜å‚¨å°çš„å¯¹è±¡ï¼Œå¦‚NSNumberã€NSDateã€NSStringã€‚å…¶å­˜å‚¨çš„ä¸æ˜¯åœ°å€ï¼Œè€Œæ˜¯çœŸæ­£çš„å€¼ï¼Œæ‰€ä»¥å®ƒç›´æ¥å­˜å‚¨åˆ°æ ˆä¸­ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Objective-C" scheme="https://bqlin.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>AVFoundationå¯¼å‡ºAPI</title>
    <link href="https://bqlin.github.io/posts/avfoundation_export_api/"/>
    <id>https://bqlin.github.io/posts/avfoundation_export_api/</id>
    <published>2021-11-08T08:47:22.000Z</published>
    <updated>2021-11-08T08:47:22.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="avassetexportsession">AVAssetExportSession</h2><p>AVAssetExportSessionå¯ä»¥å®ç°ç®€å•çš„å¯¼å‡ºã€‚</p><p>è¾“å…¥ï¼šAVAsset</p><p>è¾“å‡ºï¼šURL</p><p>å¯é…ç½®é¡¹ï¼š</p><ul><li>æ ¼å¼<ul><li><code>preset</code></li><li><code>timeRange: CMTimeRange</code></li><li><code>outputFileType: AVFileType</code></li></ul></li><li>é™åˆ¶ä¸ä¼˜åŒ–<ul><li><code>fileLengthLimit: Int64</code></li><li><code>shouldOptimizeForNetworkUse: Bool</code></li><li><code>canPerformMultiplePassesOverSourceMediaData: Bool</code>ã€<code>directoryForTemporaryFiles: URL</code></li></ul></li><li>é™„åŠ <ul><li><code>audioMix: AVAudioMix</code></li><li><code>videoComposition: AVVideoComposition</code></li><li><code>audioTimePitchAlgorithm: AVAudioTimePitchAlgorithm</code></li><li><code>metadata: [AVMetadataItem]</code></li></ul></li></ul><p>æ“ä½œï¼š<code>exportAsynchronously</code>ã€<code>cancelExport</code></p><p>è·å–çŠ¶æ€ï¼š<code>progress</code>ã€<code>status</code>ã€<code>error</code></p><h2 id="readerwriter">Reader+Writer</h2><h3 id="avassetreader">AVAssetReader</h3><p>ç®¡ç†è¯»å–è¾“å‡ºã€‚</p><p>è¾“å…¥ï¼šAVAsset</p><p>æ“ä½œï¼š<code>startReading</code>ã€<code>cancelReading</code>ã€æ·»åŠ è¾“å‡º</p><p>çŠ¶æ€ï¼š<code>status</code>ã€<code>error</code></p><h3 id="avassetreaderoutput">AVAssetReaderOutput</h3><p>è¾“å‡ºå¸§ã€‚</p><p>è¾“å…¥ï¼šAVAssetTrack</p><p>é…ç½®ï¼š<code>alwaysCopiesSampleData: Bool</code></p><p>æ“ä½œï¼š<code>copyNextSampleBuffer</code>ã€<code>markConfigurationAsFinal</code>ï¼ˆæå‰ç»“æŸï¼‰</p><p>è¾“å‡ºï¼šCMSampleBuffer</p><p>å…·ä½“å­ç±»ï¼š</p><ul><li>TrackOutputï¼šæœ€å¸¸ç”¨<ul><li>è¾“å…¥ï¼šAVAssetTrack</li><li>é…ç½®ï¼š<ul><li><code>outputSettings: [String : Any]</code></li><li><code>audioTimePitchAlgorithm: AVAudioTimePitchAlgorithm</code></li></ul></li></ul></li><li>AudioMixOutput<ul><li>è¾“å…¥ï¼š[AVAssetTrack]</li><li>é…ç½®ï¼š<ul><li><code>audioSettings: [String : Any]</code></li><li><code>audioMix: AVAudioMix</code></li><li><code>audioTimePitchAlgorithm: AVAudioTimePitchAlgorithm</code></li></ul></li></ul></li><li>VideoCompositionOutput<ul><li>è¾“å…¥ï¼š[AVAssetTrack]</li><li>é…ç½®ï¼š<ul><li><code>videoSettings: [String : Any]</code></li><li><code>videoComposition: AVVideoComposition</code>ã€</li></ul></li></ul></li><li>SampleReferenceOutput<ul><li>è¾“å…¥ï¼šAVAssetTrack</li></ul></li></ul><h3 id="avassetreaderoutputmetadataadaptor">AVAssetReaderOutputMetadataAdaptor</h3><p>ä»TrackOutputè¾“å‡ºå…ƒæ•°æ®ã€‚</p><p>æ“ä½œï¼š<code>nextTimedMetadataGroup</code></p><h3 id="avassetwriter">AVAssetWriter</h3><p>ç®¡ç†å†™å…¥è¾“å…¥ã€‚</p><p>è¾“å‡ºï¼šURL</p><p>é…ç½®ï¼š</p><ul><li><code>outputFileType: AVFileType</code></li><li><code>directoryForTemporaryFiles: URL</code></li><li><code>metadata: [AVMetadataItem]</code></li><li><code>movieFragmentInterval: CMTime</code></li><li><code>overallDurationHint: CMTime</code></li><li><code>movieTimeScale: CMTimeScale</code></li><li><code>shouldOptimizeForNetworkUse: Bool</code></li></ul><p>æ“ä½œï¼š<code>startWriting</code>ã€<code>finishWriting</code>ã€<code>cancelWriting</code>ã€æ·»åŠ è¾“å…¥ï¼ˆç»„ï¼‰ã€<code>startSession</code>ã€<code>endSession</code></p><p>çŠ¶æ€ï¼š<code>status</code>ã€<code>error</code></p><h3 id="avassetwriterinput">AVAssetWriterInput</h3><p>æ‹¼æ¥éŸ³è§†é¢‘å¸§ã€‚</p><p>è¾“å…¥ï¼šCMSampleBuffer</p><p>é…ç½®ï¼š</p><ul><li><code>mediaType: AVMediaType</code></li><li><code>outputSettings: [String : Any]</code></li><li><code>sourceFormatHint: CMFormatDescription</code></li><li><code>preferredVolume: Float</code></li><li><code>transform: CGAffineTransform</code></li><li><code>naturalSize: CGSize</code></li><li><code>mediaTimeScale: CMTimeScale</code></li><li><code>metadata: [AVMetadataItem]</code></li><li><strong><code>expectsMediaDataInRealTime: Bool</code></strong></li><li><code>marksOutputTrackAsEnabled: Bool</code></li><li><code>performsMultiPassEncodingIfSupported: Bool</code></li><li><code>preferredMediaChunkAlignment: Int</code></li><li><code>preferredMediaChunkDuration: CMTime</code></li><li><code>mediaDataLocation: AVAssetWriterInput.MediaDataLocation</code></li></ul><p>æ“ä½œï¼šæ‹¼æ¥å¸§ã€<code>markAsFinished</code>ã€<code>addTrackAssociation</code></p><p>çŠ¶æ€ï¼š<code>requestMediaDataWhenReady</code>ã€<code>isReadyForMoreMediaData</code></p><h3 id="avassetwriterinputgroup">AVAssetWriterInputGroup</h3><p>è¾“å…¥ï¼š<a href="#avassetwriterinput">AVAssetWriterInput</a></p><h3 id="avassetwriterinputpixelbufferadaptor">AVAssetWriterInputPixelBufferAdaptor</h3><p>æ‹¼æ¥æŒ‡å®šPTSçš„CVPixelBufferï¼Œå¹¶æä¾›CVPixelBufferPoolã€‚</p><p>è¾“å‡ºï¼šAVAssetWriterInput</p><p>é…ç½®ï¼š<code>sourcePixelBufferAttributes: [String : Any]</code></p><h3 id="avassetwriterinputmetadataadaptor">AVAssetWriterInputMetadataAdaptor</h3><p>æ‹¼æ¥AVTimedMetadataGroupåˆ°Inputã€‚</p><p>è¾“å‡ºï¼šAVAssetWriterInput</p><h3 id="avoutputsettingsassistant">AVOutputSettingsAssistant</h3><p>è¾…åŠ©ç”ŸæˆéŸ³è§†é¢‘é…ç½®å­—å…¸ã€‚</p><h3 id="ç»„åˆå®ç°å¯¼å‡º">ç»„åˆå®ç°å¯¼å‡º</h3><p>å…ˆå¯¹AVAssetå¼‚æ­¥åŠ è½½<code>"tracks"</code>keyã€‚</p><p>è¯»å–æµç¨‹ï¼š</p><ol type="1"><li>ç”¨AVAssetæ„å»ºAssetReaderï¼›</li><li>æ ¹æ®è½¨é“ï¼Œä½¿ç”¨è§£ç é…ç½®å­—å…¸åˆ†åˆ«åˆ›å»ºReaderOutputï¼›</li><li>æ·»åŠ åˆ°AssetReaderï¼›</li><li>AssetReaderè°ƒç”¨<code>startReading</code>å¼€å§‹è¯»å–ï¼›</li><li>ReaderOutputå¾ªç¯é€å¸§è°ƒç”¨<code>copyNextSampleBuffer</code>ï¼Œè¾“å‡ºå¸§ï¼Œè‹¥å¸§ä¸ºç©ºåˆ™å®Œæˆæˆ–é‡åˆ°é”™è¯¯ã€‚</li></ol><p>å†™å…¥æµç¨‹ï¼š</p><ol type="1"><li>ç”¨è¾“å‡ºURLã€æ–‡ä»¶ç±»å‹åˆ›å»ºAssetWriterï¼›</li><li>æ ¹æ®è½¨é“ç±»å‹ï¼Œä½¿ç”¨ç¼–ç é…ç½®å­—å…¸åˆ›å»ºWriterInputï¼›</li><li>æ·»åŠ åˆ°AssetWriterï¼›</li><li>AssetWriterè°ƒç”¨<code>startWriting</code>ã€<code>startSession</code>å¼€å§‹å†™å…¥ï¼›</li><li>WriterInputè°ƒç”¨<code>requestMediaDataWhenReady</code>ï¼Œåœ¨å…¶å›è°ƒä¸­ï¼š<ol type="1"><li><code>isReadyForMoreMediaData == true</code></li><li>WriterInputæ‹¼æ¥å¸§ï¼›å®Œæˆæ—¶è°ƒç”¨<code>markAsFinished</code>ã€‚</li></ol></li><li>å„ä¸ªè½¨éƒ½å†™å…¥å®Œæˆæ—¶ï¼ŒAssetWriterè°ƒç”¨<code>finishWriting</code>å®Œæˆå†™å…¥ï¼ˆè¿™ä¼šå†…éƒ¨è°ƒç”¨<code>endSession</code>ï¼‰ã€‚</li></ol><p>è¦æƒ³æå‰ç»“æŸï¼Œè°ƒç”¨<code>endSession</code>ï¼Œå†è°ƒç”¨<code>finishWriting</code>ã€‚</p><p><strong>é…ç½®å­—å…¸æ˜¯å…³é”®ã€‚</strong></p><p>ç»„åˆä½¿ç”¨ï¼š</p><ol type="1"><li>å¼‚æ­¥è¯»å–AVAsset keyï¼Œè¿›å…¥åˆå§‹åŒ–é˜¶æ®µï¼š<ol type="1"><li>åˆ›å»ºAssetReaderï¼Œç„¶åAssetWriterã€‚</li><li>å–å‡ºAssetTrackåˆ›å»ºåˆ†åˆ«åˆ›å»ºReaderOutputå’ŒWriterInputã€‚</li></ol></li><li>è¯»å–æ‹¼æ¥é˜¶æ®µï¼š<ol type="1"><li>AssetReaderè°ƒç”¨<code>startReading</code>å¼€å§‹è¯»å–ï¼›AssetWriterè°ƒç”¨<code>startWriting</code>ã€<code>startSession</code>å¼€å§‹å†™å…¥ï¼›</li><li>ReaderOutputå¾ªç¯é€å¸§è°ƒç”¨<code>copyNextSampleBuffer</code>ï¼Œè¾“å‡ºå¸§ï¼›WriterInputæ£€æŸ¥æ˜¯å¦å°±ç»ªï¼Œæ‹¼æ¥å¸§ï¼›</li></ol></li><li>ReaderOutputæ²¡æœ‰å¸§äº†ï¼Œè¿›å…¥å®Œæˆé˜¶æ®µï¼š<ol type="1"><li>æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ï¼›</li><li>AssetWriterè°ƒç”¨<code>finishWriting</code>å®Œæˆå†™å…¥ã€‚</li></ol></li></ol><p>å¤šçº¿ç¨‹åº”ç”¨ï¼š</p><ul><li>éƒ½ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—ï¼Œåˆ†åˆ«åˆ›å»ºï¼š<ul><li>ä¸»æ“ä½œé˜Ÿåˆ— Ã—1</li><li>å„è½¨é“è¯»å†™é˜Ÿåˆ— Ã—N</li></ul></li><li>åˆå§‹åŒ–é˜¶æ®µåœ¨ä¸»é˜Ÿåˆ—è¿›è¡Œï¼Œå³åœ¨å¼‚æ­¥è¯»å–AVAsset keyåè¿›å…¥ä¸»æ“ä½œé˜Ÿåˆ—åˆ›å»ºå„ç§å¯¹è±¡ã€‚</li><li>æ¯ä¸ªè½¨é“çš„è¯»å¸§ã€å†™å¸§æ“ä½œéƒ½åœ¨å¯¹åº”çš„ä¸€ä¸ªé˜Ÿåˆ—ä¸­è¿›è¡Œã€‚</li><li>ä½¿ç”¨è°ƒåº¦ç»„åœ¨æ‰€æœ‰è½¨é“éƒ½è¯»å†™å®Œæˆåå›è°ƒé€šçŸ¥ã€‚è¿›å…¥å„è½¨é“é˜Ÿåˆ—å‰enterï¼Œå„ä¸ªè½¨é“è¯»å†™å®Œæˆåleaveã€‚</li><li>å®Œæˆåè¿›å…¥ä¸»æ“ä½œé˜Ÿåˆ—ï¼Œè¿›è¡Œæ”¶å°¾å·¥ä½œã€‚</li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;avassetexportsession&quot;&gt;AVAssetExportSession&lt;/h2&gt;
&lt;p&gt;AVAssetExportSessionå¯ä»¥å®ç°ç®€å•çš„å¯¼å‡ºã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="AVFoundation" scheme="https://bqlin.github.io/categories/AVFoundation/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>AVFoundationå½±ç‰‡ç¼–è¾‘API</title>
    <link href="https://bqlin.github.io/posts/avfoundation_movie_edit_api/"/>
    <id>https://bqlin.github.io/posts/avfoundation_movie_edit_api/</id>
    <published>2021-11-08T02:11:40.000Z</published>
    <updated>2021-11-08T02:11:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>åª’ä½“åˆ›ä½œå’Œç¼–è¾‘åŸºæœ¬æ˜¯AVFoundationçš„é«˜çº§æ¥å£ï¼Œè¾ƒå°‘æ¶‰åŠåº•å±‚æ¥å£ã€‚æ•´ä¸ªè¿‡ç¨‹æ€»çš„æ¥è¯´å°±æ˜¯æ„å»ºAVAssetçš„è¿‡ç¨‹ï¼Œè€Œåœ¨è§†é¢‘ç¼–è¾‘ä¸­ï¼Œæ„å»ºçš„æ˜¯AVMutableCompositionçš„è¿‡ç¨‹ã€‚</p><h2 id="æ•´ä½“å…³ç³»">æ•´ä½“å…³ç³»</h2><p><strong>Composition</strong>ï¼šä½œä¸ºå†…å®¹ä¸»ä½“ï¼Œä¸€ä¸ªæŠ½è±¡çš„å¯ç¼–è¾‘çš„AVAssetå­ç±»ï¼Œæä¾›é¢å‘å¯¹è±¡çš„å¤šè½¨æ“ä½œã€‚</p><ul><li>CompositionTrack Ã—Nï¼šç®¡ç†æ—¶é—´ï¼Œæ€»çš„éŸ³è§†é¢‘è½¨ä¿¡æ¯ã€‚<ul><li>AssetTrackç‰‡æ®µ Ã—N</li><li>è½¨é“çš„åå¥½ä¿¡æ¯ï¼š<code>naturalTimeScale</code>ã€<code>preferredTransform</code>ã€<code>preferredVolume</code></li></ul></li></ul><p><strong>AudioMix</strong>ï¼šé™„åŠ ä¿¡æ¯ï¼Œå¯¹éŸ³é‡çš„æè¿°</p><ul><li><code>inputParameters</code>ï¼šAudioMixInputParameters Ã—Nï¼šæè¿°éŸ³é‡ï¼ˆ+æ—¶é—´=æ¸å˜ï¼‰ã€å˜é€Ÿæ—¶çš„éŸ³è°ƒç­–ç•¥</li></ul><p>AudioMixInputParametersçš„<code>audioTapProcessor</code>å¯ä»¥ä½¿ç”¨AudioUnitç»™éŸ³é¢‘å¢åŠ æ•ˆæœï¼Œä½†ä¼¼ä¹æŸ¥ä¸åˆ°å…·ä½“çš„é¢APIæ–‡æ¡£ï¼Œå¯å‚è€ƒï¼š<a href="https://developer.apple.com/forums/thread/90879">MTAudioProcessingTap with kMTAudioâ€¦ | Apple Developer Forums</a>ã€<a href="https://github.com/gchilds/MTAudioProcessingTap-in-Swift">gchilds/MTAudioProcessingTap-in-Swift: Example of creating an MTAudioProcessingTap in Swift4.2</a>ã€‚</p><p><strong>VideoComposition</strong>ï¼šé™„åŠ ä¿¡æ¯ï¼Œå¯¹ç”»é¢çš„æè¿°</p><ul><li><p>è§†é¢‘å±æ€§æ§åˆ¶ï¼š</p><ul><li>frameDuration</li><li>renderSize</li><li>colorParimaties</li><li>colorTransferFunction</li><li>colorYCbCrMatrix</li></ul></li><li><p>è§†é¢‘æ“ä½œï¼Œé€šè¿‡ä»¥ä¸‹ä¸‰ç§æ–¹å¼ï¼š</p><ul><li><p><code>instructions</code>ï¼šAVVideoCompositionInstructionProtocol Ã—N</p><ul><li><p>VideoCompositionLayerInstructionï¼šæä¾›å‡ ç§å›¾åƒä»¥æ—¶é—´ç‚¹ã€æ—¶é—´åŒºé—´/æ¸å˜æ“ä½œ</p><ul><li><p>opacity</p></li><li><p>transform</p></li><li><p>cropRectangle</p></li></ul></li></ul></li><li><p><code>animationTool</code>ï¼šæä¾›ä¸Core Animationçš„å‡ ç§äº¤äº’æ–¹å¼ï¼Œä¸èƒ½å®æ—¶é¢„è§ˆçš„ï¼Œå³è®¾ç½®åˆ°playerItemçœ‹ä¸åˆ°æ•ˆæœã€‚</p><ul><li>æ–°å¢ä¸€ä¸ªç”¨CALayerè¡¨ç¤ºçš„è§†é¢‘è½¨ï¼š<code>init(additionalLayer: CALayer, asTrackID: CMPersistentTrackID)</code></li><li>ç”¨CALayerå±‚çº§å…³ç³»ç®¡ç†è§†é¢‘è½¨ï¼š<code>init(postProcessingAsVideoLayer: CALayer, in: CALayer)</code>ã€<code>init(postProcessingAsVideoLayers: [CALayer], in: CALayer)</code></li></ul></li><li><p><code>customVideoCompositorClass</code>ï¼šè‡ªå·±å®ç°ä¸€ä¸ªVideoCompositionï¼Œå¯é€šè¿‡GLã€Metalå®ç°è‡ªå®šä¹‰çš„è½¬åœº</p></li></ul></li></ul><p>ä»¥ä¸ŠAPIçš„Mutableç‰ˆæœ¬çš„ç±»æ‰æ˜¯å¯ç¼–è¾‘çš„ã€‚</p><p>ä»¥ä¸Šçš„Compositionï¼Œå¯ç”¨äºåˆ›å»ºPlayerItemã€AssetExportSessionã€‚AudioMixã€VideoCompositionä½œä¸ºå±æ€§è®¾ç½®åˆ°AssetExportSessionã€AssetReaderAudioMixOutputã€playerItemã€‚</p><h2 id="å…·ä½“api">å…·ä½“API</h2><h3 id="avmutablecomposition">AVMutableComposition</h3><p>AVAssetçš„å­ç±»ï¼Œå› æ­¤è¿™æ˜¯æœ€åé¢„è§ˆã€å¯¼å‡ºæ“ä½œçš„æ•°æ®å¯¹è±¡ã€‚</p><h4 id="æ•´ä½“æ“ä½œ">æ•´ä½“æ“ä½œ</h4><p>å¯¹æ•´ä¸ªcompositionå¯¹è±¡è¿›è¡Œæ•´ä½“æ“ä½œï¼Œå½“ç„¶è¿™ä¼šæ¶‰åŠå¤šä¸ªè½¨é“ï¼Œé™¤äº†å¯¹æ•´ä½“è¿›è¡Œæ—¶é—´ä¼¸ç¼©ï¼Œå¦åˆ™è¾ƒå°‘ä½¿ç”¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/// æ’å…¥ç©ºå ä½</span><br><span class="line">func insertEmptyTimeRange(_ timeRange: CMTimeRange)</span><br><span class="line"></span><br><span class="line">/// æ’å…¥asset</span><br><span class="line">func insertTimeRange(_ timeRange: CMTimeRange, of asset: AVAsset, at startTime: CMTime) throws</span><br><span class="line"></span><br><span class="line">/// ç§»é™¤æ—¶é—´æ®µçš„å†…å®¹ï¼Œæ³¨æ„è¿™é‡Œä¸ä¼šç§»é™¤æ—¢æœ‰çš„è½¨é“ã€‚</span><br><span class="line">func removeTimeRange(_ timeRange: CMTimeRange)</span><br><span class="line"></span><br><span class="line">/// ä¼¸ç¼©æ—¶é—´ï¼Œå³æ”¹å˜æ—¶é—´åŒºé—´å†…æ‰€æœ‰è½¨é“çš„æ—¶é•¿</span><br><span class="line">func scaleTimeRange(_ timeRange: CMTimeRange, toDuration duration: CMTime)</span><br><span class="line"></span><br><span class="line">/// é…ç½®è§†é¢‘ç”»å¹…å°ºå¯¸</span><br><span class="line">var naturalSize: CGSize &#123; get set &#125;</span><br></pre></td></tr></table></figure><h4 id="è½¨é“æ“ä½œ">è½¨é“æ“ä½œ</h4><p>å¤§å¤šæ•°æ“ä½œéƒ½æ˜¯åŸºäºè½¨é“ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/// æ·»åŠ ã€ç§»é™¤è½¨é“</span><br><span class="line">func addMutableTrack(withMediaType mediaType: AVMediaType, preferredTrackID: CMPersistentTrackID) -&gt; AVMutableCompositionTrack?</span><br><span class="line">func removeTrack(_ track: AVCompositionTrack)</span><br><span class="line"></span><br><span class="line">// å…¶ä»–APIåªæ˜¯è·å–è½¨é“ç­‰éå¸¸ç”¨æ“ä½œ</span><br></pre></td></tr></table></figure><h3 id="avmutablecompositiontrack">AVMutableCompositionTrack</h3><p>ä¸€ä¸ªå¯ä¿®æ”¹çš„è½¨é“ã€‚</p><h4 id="å¸¸ç”¨é…ç½®å±æ€§">å¸¸ç”¨é…ç½®å±æ€§</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/// è§†é¢‘ç¿»è½¬çŸ©é˜µ</span><br><span class="line">var preferredTransform: CGAffineTransform &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// éŸ³é¢‘è½¨é“éŸ³é‡</span><br><span class="line">var preferredVolume: Float &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// å…¶ä»–ä¸å¤ªå¸¸ç”¨çš„å±æ€§</span><br><span class="line">var languageCode: String? &#123; get set &#125;</span><br><span class="line">var extendedLanguageTag: String? &#123; get set &#125;</span><br><span class="line">var naturalTimeScale: CMTimeScale &#123; get set &#125;</span><br></pre></td></tr></table></figure><p>å¢åˆ æ”¹æŸ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func insertEmptyTimeRange(_ timeRange: CMTimeRange)</span><br><span class="line">func insertTimeRange(_ timeRange: CMTimeRange, of track: AVAssetTrack, at startTime: CMTime) throws</span><br><span class="line">func insertTimeRanges(_ timeRanges: [NSValue], of tracks: [AVAssetTrack], at startTime: CMTime) throws // ä¼¼ä¹ä¸å¸¸ç”¨</span><br><span class="line">func removeTimeRange(_ timeRange: CMTimeRange)</span><br><span class="line">func scaleTimeRange(_ timeRange: CMTimeRange, toDuration duration: CMTime)</span><br><span class="line">var segments: [AVCompositionTrackSegment]! &#123; get set &#125;</span><br></pre></td></tr></table></figure><h3 id="avmutableaudiomix">AVMutableAudioMix</h3><p>åŒ…å«æ··éŸ³ï¼ˆç›®å‰çš„æ··éŸ³åªæœ‰éŸ³é‡è°ƒèŠ‚ï¼‰å‚æ•°ï¼Œæ‰€ä»¥å…¶å¯¹è±¡åªæœ‰ä¸€ä¸ªå±æ€§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var inputParameters: [AVAudioMixInputParameters] &#123; get set &#125;</span><br></pre></td></tr></table></figure><h4 id="avmutableaudiomixinputparameters">AVMutableAudioMixInputParameters</h4><p>éŸ³é¢‘æ··éŸ³å‚æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/// åˆ›å»º</span><br><span class="line">convenience init(track: AVAssetTrack?)</span><br><span class="line">/// åˆ›å»ºåä¹Ÿå¯ä»¥ä¿®æ”¹trackIdæ›´å˜åº”ç”¨çš„è½¨é“</span><br><span class="line">var trackID: CMPersistentTrackID &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// è®¾ç½®éŸ³é‡</span><br><span class="line">func setVolume(_ volume: Float, at time: CMTime)</span><br><span class="line">func setVolumeRamp(fromStartVolume startVolume: Float, toEndVolume endVolume: Float, timeRange: CMTimeRange)</span><br><span class="line"></span><br><span class="line">/// è®¾ç½®éŸ³è°ƒç®—æ³•</span><br><span class="line">var audioTimePitchAlgorithm: AVAudioTimePitchAlgorithm? &#123; get set &#125;</span><br></pre></td></tr></table></figure><h3 id="avmutablevideocomposition">AVMutableVideoComposition</h3><p>æ§åˆ¶è§†é¢‘è½¨é“ç»„åˆè¡Œä¸ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/// åˆ›å»º</span><br><span class="line">init(propertiesOf asset: AVAsset)</span><br><span class="line"></span><br><span class="line">/// é…ç½®è§†é¢‘ç›¸å…³å±æ€§</span><br><span class="line">var frameDuration: CMTime &#123; get set &#125;</span><br><span class="line">var renderSize: CGSize &#123; get set &#125;</span><br><span class="line">var renderScale: Float &#123; get set &#125; // ä¸å¸¸ç”¨</span><br><span class="line">var colorPrimaries: String? &#123; get set &#125;</span><br><span class="line">var colorTransferFunction: String? &#123; get set &#125;</span><br><span class="line">var colorYCbCrMatrix: String? &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// é…ç½®è§†é¢‘æ“ä½œ</span><br><span class="line">var instructions: [AVVideoCompositionInstructionProtocol] &#123; get set &#125;</span><br><span class="line">var animationTool: AVVideoCompositionCoreAnimationTool? &#123; get set &#125;</span><br><span class="line">var customVideoCompositorClass: AVVideoCompositing.Type? &#123; get set &#125;</span><br></pre></td></tr></table></figure><h3 id="avmutablevideocompositioninstruction">AVMutableVideoCompositionInstruction</h3><p>æä¾›ä¸€ä¸ªæ—¶é—´èŒƒå›´å†…çš„è§†é¢‘ç»„ç»‡ä¿¡æ¯ã€‚ç”±ä¸€ç»„AVMutableVideoCompositionLayerInstructionå¯¹è±¡æ ¼å¼å®šä¹‰çš„æŒ‡ä»¤ç»„æˆçš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/// è‡ªé¡¶è€Œä¸‹æ’åˆ—çš„layerInstructions</span><br><span class="line">var layerInstructions: [AVVideoCompositionLayerInstruction] &#123; get set &#125;</span><br><span class="line">var timeRange: CMTimeRange &#123; get set &#125;</span><br><span class="line">var enablePostProcessing: Bool &#123; get set &#125;</span><br><span class="line">var backgroundColor: CGColor? &#123; get set &#125;</span><br></pre></td></tr></table></figure><h3 id="avmutablevideocompositionlayerinstruction">AVMutableVideoCompositionLayerInstruction</h3><p>ç»™è§†é¢‘ç‰¹æ•ˆï¼Œç”¨äºå®šä¹‰ç»™å®šè§†é¢‘è½¨é“åº”ç”¨çš„åŸºäºæ—¶é—´çš„æ¨¡ç³Šã€å˜å½¢ã€å’Œè£å‰ªæ•ˆæœã€‚ä»å…¶æ„å»ºæ–¹å¼å¯è§ï¼Œå…¶æ›´ç±»ä¼¼äºAVMutableAudioMixInputParametersã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/// æ„å»º</span><br><span class="line">convenience init(assetTrack track: AVAssetTrack)</span><br><span class="line">var trackID: CMPersistentTrackID &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// æ”¯æŒçš„æ“ä½œ</span><br><span class="line">func setOpacity(_ opacity: Float, at time: CMTime)</span><br><span class="line">func setOpacityRamp(fromStartOpacity startOpacity: Float, toEndOpacity endOpacity: Float, timeRange: CMTimeRange)</span><br><span class="line">func setTransform(_ transform: CGAffineTransform, at time: CMTime)</span><br><span class="line">func setTransformRamp(fromStart startTransform: CGAffineTransform, toEnd endTransform: CGAffineTransform, timeRange: CMTimeRange)</span><br><span class="line">func setCropRectangle(_ cropRectangle: CGRect, at time: CMTime)</span><br><span class="line">func setCropRectangleRamp(fromStartCropRectangle startCropRectangle: CGRect, toEndCropRectangle endCropRectangle: CGRect, timeRange: CMTimeRange)</span><br></pre></td></tr></table></figure><p>LayerInstructionæ˜¯åº”ç”¨äºä¸€ä¸ªè½¨é“çš„ï¼Œæ„å‘³ç€è¦æƒ³åœ¨åº”ç”¨ç‰¹æ•ˆçš„æ—¶å€™èƒ½çœ‹åˆ°åº•ä¸‹çš„è§†é¢‘ï¼Œåˆ™éœ€è¦å¤šä¸ªè§†é¢‘è½¨é“ã€‚</p><h3 id="videocompositioncoreanimation">VideoComposition+CoreAnimation</h3><p>è§†é¢‘ç¼–è¾‘ä¸­é™¤äº†å¯ä»¥å åŠ è½¨é“ï¼Œè¿˜å¯ä»¥å åŠ CALayerã€‚è¿™é€šè¿‡VideoCompositionçš„animationToolå®ç°ã€‚å…¶ç±»æ˜¯AVVideoCompositionCoreAnimationToolï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/// æ·»åŠ é¢å¤–çš„å›¾å±‚</span><br><span class="line">convenience init(additionalLayer layer: CALayer, asTrackID trackID: CMPersistentTrackID)</span><br><span class="line"></span><br><span class="line">/// è‡ªå®šä¹‰ç»„ç»‡è§†é¢‘å±‚ä¸æ ¹å›¾å±‚ã€‚è¿™é‡ŒanimationLayeræ˜¯æ ¹å›¾å±‚ï¼ŒvideoLayerè§†é¢‘å±‚æ˜¯å…¶å­å›¾å±‚ï¼Œé™¤æ­¤ä»¥å¤–è¿˜å¯ä»¥åœ¨animationLayeræ·»åŠ æ›´å¤šå­å›¾å±‚ã€‚</span><br><span class="line">convenience init(postProcessingAsVideoLayer videoLayer: CALayer, in animationLayer: CALayer)</span><br><span class="line"></span><br><span class="line">/// æ‹·è´è§†é¢‘å¸§åˆ°å¤šä¸ªè§†é¢‘å±‚</span><br><span class="line">convenience init(postProcessingAsVideoLayers videoLayers: [CALayer], in animationLayer: CALayer)</span><br></pre></td></tr></table></figure><p>åœ¨è§†é¢‘ä¸­ä½¿ç”¨CoreAnimationï¼Œå¸¸éœ€è¦è®¾ç½®geometryFlippedå±æ€§ï¼Œè®©å…¶åæ ‡ç¿»è½¬ä¸€éã€‚</p><p>é€šè¿‡AVVideoCompositionCoreAnimationToolä½¿ç”¨Core Animationæ—¶éœ€è¦æ³¨æ„ï¼š</p><ul><li>ç”¨<code>AVCoreAnimationBeginTimeAtZero</code>è¡¨ç¤º0æ—¶é—´ç‚¹ï¼›</li><li><code>isRemovedOnCompletion</code>è®¾ä¸ºfalseï¼›</li><li>é¿å…ä½¿ç”¨ä¸UIViewå…³è”çš„CALayerã€‚</li></ul><h3 id="avassetexportsession">AVAssetExportSession</h3><p>é«˜çº§å¯¼å‡ºç±»ï¼Œæ˜¯ä¸ªé«˜çº§APIï¼Œè¦æƒ³æ›´ç»†åŒ–åœ°é…ç½®ï¼Œè¿˜æ˜¯éœ€è¦AVAssetReader+AVAssetWriterã€‚</p><h4 id="æ„å»º">æ„å»º</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">init?(asset: AVAsset, presetName: String)</span><br></pre></td></tr></table></figure><p>å½“ç„¶å¯ä»¥ç›´æ¥æ„å»ºåå°±å¼€å§‹å¯¼å‡ºã€‚å…¶éŸ³è§†é¢‘çš„è½¬ç é…ç½®éƒ½å›Šæ‹¬åœ¨presetNameä¸­ï¼Œå³æ—¢æœ‰çš„æ–¹æ¡ˆä¸­å»ç›´æ¥å¥—ç”¨ã€‚</p><h4 id="é…ç½®">é…ç½®</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/// è¾“å‡ºæ–‡ä»¶è·¯å¾„</span><br><span class="line">var outputURL: URL? &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// æ–‡ä»¶ç±»å‹ï¼Œå‡†ç¡®åœ°æ¥è¯´æ˜¯å®¹å™¨ç±»å‹</span><br><span class="line">var outputFileType: AVFileType? &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// æ–‡ä»¶é•¿åº¦é™åˆ¶</span><br><span class="line">var fileLengthLimit: Int64 &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// å¯¼å‡ºæ—¶é—´åŒºé—´</span><br><span class="line">var timeRange: CMTimeRange &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// é™„å¸¦çš„å…ƒæ•°æ®</span><br><span class="line">var metadata: [AVMetadataItem]? &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// æ··éŸ³</span><br><span class="line">var audioMix: AVAudioMix? &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// éŸ³è°ƒç®—æ³•ï¼ˆåœ¨ä¼¸ç¼©æ—¶é•¿æ—¶ï¼‰</span><br><span class="line">var audioTimePitchAlgorithm: AVAudioTimePitchAlgorithm &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// æ˜¯å¦ä¸ºç½‘ç»œæ’­æ”¾ä¼˜åŒ–</span><br><span class="line">var shouldOptimizeForNetworkUse: Bool &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// video composition</span><br><span class="line"> var videoComposition: AVVideoComposition? &#123; get set &#125;</span><br><span class="line"></span><br><span class="line">/// custom video compositor</span><br><span class="line">var customVideoCompositor: AVVideoCompositing? &#123; get &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;åª’ä½“åˆ›ä½œå’Œç¼–è¾‘åŸºæœ¬æ˜¯AVFoundationçš„é«˜çº§æ¥å£ï¼Œè¾ƒå°‘æ¶‰åŠåº•å±‚æ¥å£ã€‚æ•´ä¸ªè¿‡ç¨‹æ€»çš„æ¥è¯´å°±æ˜¯æ„å»ºAVAssetçš„è¿‡ç¨‹ï¼Œè€Œåœ¨è§†é¢‘ç¼–è¾‘ä¸­ï¼Œæ„å»ºçš„æ˜¯AVMutableCompositionçš„è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;æ•´ä½“å…³ç³»&quot;&gt;æ•´ä½“å…³ç³»&lt;/h2&gt;</summary>
    
    
    
    <category term="AVFoundation" scheme="https://bqlin.github.io/categories/AVFoundation/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>x264ç¼–ç å™¨å‚æ•°è®¾ç½®</title>
    <link href="https://bqlin.github.io/posts/x264_encoder_parameter_setting/"/>
    <id>https://bqlin.github.io/posts/x264_encoder_parameter_setting/</id>
    <published>2021-11-07T15:45:52.000Z</published>
    <updated>2021-11-07T15:45:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>å‚æ•°åˆ†ç±»ï¼š</p><ul><li>é¢„è®¾å€¼</li><li>å¸§ç›¸å…³å‚æ•°</li><li>ç æµçš„æ§åˆ¶</li><li>ç¼–ç åˆ†æ</li><li>è¾“å‡º</li></ul><h2 id="é¢„è®¾å€¼">é¢„è®¾å€¼</h2><ul><li>presetï¼šé€Ÿåº¦/å®æ—¶æ€§ç»´åº¦çš„é…ç½®æ–¹æ¡ˆ<ul><li>fastã€slow ç­‰</li></ul></li><li>tuneï¼šè§†é¢‘è´¨é‡ç»´åº¦çš„é…ç½®æ–¹æ¡ˆã€‚é€çº§é€’å‡ã€‚</li></ul><p>ä¸¤è€…ä¸äº’æ–¥ï¼Œtune å‚æ•°çš„ä¼˜å…ˆçº§åœ¨ preset å‚æ•°ä¹‹åï¼Œåœ¨å…¶ä»–å‚æ•°ä¹‹å‰ã€‚</p><h2 id="å¸§ç›¸å…³å‚æ•°">å¸§ç›¸å…³å‚æ•°</h2><ul><li>keyint/min-keyintï¼šGOP å¤§å°ï¼Œé»˜è®¤æ˜¯250ã€‚</li><li>scenecutï¼šåˆ¤æ–­ä¸ºåœºæ™¯åˆ‡æ¢çš„é˜ˆå€¼ï¼Œä¸ºåœºæ™¯åˆ‡æ¢æ—¶æ’å…¥ä¸€ä¸ª I å¸§ã€‚</li><li>bframesï¼šB å¸§æ•°é‡ï¼Œé»˜è®¤è®¾ç½®3ã€‚</li><li>refï¼šå‚è€ƒå¸§æ•°é‡ï¼Œå†³å®šäº†è§£ç æ—¶å€™ç¼“å†²åŒºçš„å¤§å°ã€‚</li><li>no-deblock/deblockï¼šæ˜¯å¦å¯ç”¨å»å—åŒ–ã€‚åœ¨ç¼–ç é¢„æµ‹çš„æ—¶å€™ä¼šå‘ç”Ÿå‡ºç°å—ã€‚</li><li>no-cabacï¼šæ˜¯å¦ä½¿ç”¨ CABAC è¿›è¡Œç†µç¼–ç ã€‚</li></ul><h2 id="æµæ§">æµæ§</h2><ul><li>qpï¼šé‡åŒ–å™¨ç­‰çº§ï¼Œæ¯” crf ç æµå¤§ä¸”ä¸ bitrate/crf äº’æ–¥ã€‚</li><li>bitrateï¼šç æµï¼Œæ— æ³•æ§åˆ¶è´¨é‡ã€‚</li><li>crfï¼šè´¨é‡ç­‰çº§ï¼Œé»˜è®¤æ˜¯23ï¼Œæ•°å€¼è¶Šä½è¶Šå¥½ã€‚</li><li>qminï¼šé»˜è®¤10ã€‚</li><li>qmaxï¼šé»˜è®¤51ã€‚</li><li>qpstepï¼šä¸¤å¸§ä¹‹é—´é‡åŒ–å™¨çš„æœ€å¤§å˜åŒ–ï¼Œé»˜è®¤æ˜¯4ã€‚</li></ul><h2 id="ç¼–ç åˆ†æ">ç¼–ç åˆ†æ</h2><ul><li>partitionsï¼šå®å—åˆ’åˆ†ã€‚å¦‚ï¼šp8x8ã€b8x8ã€i8x8ã€i4x4</li><li>meï¼šè¿åŠ¨è¯„ä¼°ç®—æ³•ã€‚å¦‚ï¼šé’»çŸ³ã€å…­è¾¹å½¢ç­‰ã€‚</li></ul><h2 id="è¾“å‡º">è¾“å‡º</h2><ul><li>sarï¼šå®½é«˜æ¯”ã€‚</li><li>fpsï¼šå¸§ç‡ã€‚</li><li>levelï¼šè¾“å‡ºç­‰è§„åˆ™ã€‚720Pç­‰ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="http://www.chaneru.com/Roku/HLS/X264_Settings.htm">X264 Settings - MeWiki</a></li><li><a href="https://sites.google.com/site/linuxencoding/x264-ffmpeg-mapping">x264 FFmpeg Options Guide - Linux Encoding</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‚æ•°åˆ†ç±»ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é¢„è®¾å€¼&lt;/li&gt;
&lt;li&gt;å¸§ç›¸å…³å‚æ•°&lt;/li&gt;
&lt;li&gt;ç æµçš„æ§åˆ¶&lt;/li&gt;
&lt;li&gt;ç¼–ç åˆ†æ&lt;/li&gt;
&lt;li&gt;è¾“å‡º&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>AVFoundationè§†é¢‘è§£ç API</title>
    <link href="https://bqlin.github.io/posts/avfoundation_video_decode_api/"/>
    <id>https://bqlin.github.io/posts/avfoundation_video_decode_api/</id>
    <published>2021-11-07T08:17:43.000Z</published>
    <updated>2021-11-07T08:17:43.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="è§†é¢‘è§£ç apiæ¦‚è¿°">è§†é¢‘è§£ç APIæ¦‚è¿°</h2><p>AVFoundation</p><ul><li>AVAssetReader</li><li>AVSampleBufferGenerator</li></ul><p>Video Toolbox</p><ul><li>VTDecompressionSession</li></ul><p>Core Video</p><ul><li>CVPixelBuffer integration with Metal</li></ul><p>ä½¿ç”¨AVFoundationçš„AVPlayerã€AVAssetExportSessionã€AVAssetReaderå’ŒVideo Toolboxçš„VTDecompressSesionéƒ½è‡ªåŠ¨è¿›è¡Œç¡¬ä»¶åŠ é€Ÿä»¥åŠCMSampleBufferçš„RPCä¼˜åŒ–ã€‚</p><h2 id="è§†é¢‘æ ¸å¿ƒæ•°æ®ç»“æ„">è§†é¢‘æ ¸å¿ƒæ•°æ®ç»“æ„</h2><p>CVPixelBufferï¼šåŸå§‹å›¾åƒ+å›¾åƒå…ƒæ•°æ®</p><p>CMBlockBufferï¼šä»»æ„ç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆå‹ç¼©å›¾åƒï¼‰+å…ƒæ•°æ®</p><p>CMSampleBufferï¼š</p><ul><li>CVPixelBuffer+æ—¶é—´ä¿¡æ¯+å¸§å…ƒæ•°æ®ï¼ˆCMFormatDescriptionï¼‰</li><li>CMBlockBuffer+æ—¶é—´ä¿¡æ¯+å¸§å…ƒæ•°æ®</li><li>åªåŒ…å«å…ƒæ•°æ®</li></ul><p>IOSurfaceï¼šä¸åŒæ¡†æ¶ã€è®¾å¤‡ä¸­äº¤æ¢å›¾åƒæ•°æ®çš„é«˜é€Ÿé€šé“ï¼Œåº”ç”¨åœ¨ï¼š</p><ul><li>ä¸åŒæ¡†æ¶ä¹‹é—´ï¼šCoreVideoå’ŒMetal</li><li>ä¸åŒè¿›ç¨‹ä¹‹é—´ï¼šè§£ç è¿›ç¨‹å’ŒAppè¿›ç¨‹</li><li>ä¸åŒçš„å†…å­˜åŒºï¼šæ˜¾å­˜å’Œå†…å­˜</li></ul><p>CVPixelBufferPoolï¼šå®ç°äº†CVPixelBufferä¸­çš„IOSurfaceçš„å¤ç”¨ä¸å›æ”¶ã€‚</p><h2 id="è§£ç æµç¨‹">è§£ç æµç¨‹</h2><figure><img src="https://images.xiaozhuanlan.com/photo/2020/155967becb2eb29e9c18bcb86353a8dc.png" alt="è§£ç æµç¨‹" /><figcaption aria-hidden="true">è§£ç æµç¨‹</figcaption></figure><p>åœ¨è§£ç çš„è¿‡ç¨‹ä¸­å¦‚æœé…ç½®çš„è¾“å‡ºæ ¼å¼ä¸åŸå§‹æ•°æ®æ ¼å¼ä¸ä¸€è‡´ï¼Œè¿˜ä¼šå‘ç”Ÿè½¬ç ï¼Œè§¦å‘å†…å­˜æ‹·è´ï¼Œè¦å°½é‡é¿å…ã€‚</p><h3 id="è·å–è§£å°è£…åçš„æ•°æ®">è·å–è§£å°è£…åçš„æ•°æ®</h3><p>è¦æƒ³è·å¾—è§£ç å‰çš„è£¸æ•°æ®ï¼Œå³è§£å°è£…åçš„è£¸æ•°æ®ï¼ˆè¾“å‡ºä¸ºCMSampleBufferï¼‰ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š</p><ul><li>AVAssetReaderï¼šåˆ›å»ºtrack ouputæ—¶æŠŠ<code>outputSetting</code>è®¾ä¸ºnilã€‚</li><li>AVSampleBufferGeneratorï¼šåªèƒ½è¯»å‡ºæœªè§£ç çš„è£¸æ•°æ®ã€‚</li><li>è‡ªå·±ç”ŸæˆCMSampleBufferï¼šæŠŠæ•°æ®è¯»å–å‡ºæ¥ï¼Œæ„å»ºCMBlockBufferï¼Œå†åŠ ä¸Šæ—¶é—´ä¿¡æ¯ï¼Œæ„å»ºå‡ºCMSampleBufferã€‚è¿™æ ·çš„CMSampleBufferä¸å¸¦RPCä¼˜åŒ–ã€‚</li></ul><h3 id="ä½¿ç”¨video-toolboxè§£ç ">ä½¿ç”¨Video Toolboxè§£ç </h3><p>VTDecompressionSessionåŒ…å«ä¸‰éƒ¨åˆ†ï¼š</p><ul><li>è§£ç å™¨</li><li>CVPixelBufferPool</li><li>VTPixelTransferSession</li></ul><p>ä½¿ç”¨VTDecompressionSessionçš„æ­¥éª¤ï¼š</p><ol type="1"><li>åˆ›å»ºVTDecompressionSessionï¼›</li><li>é€šè¿‡<code>VTSessionSetProperty</code>é…ç½®sessionï¼›</li><li>ä¼ é€’CMSampleBufferè§†é¢‘å¸§ç»™sessionè§£ç ã€‚</li><li>ä»å›è°ƒä¸­è·å–è§£ç CMSampleBufferã€‚</li></ol><p>è™½ç„¶å›è°ƒæ˜¯å¼‚æ­¥çš„ï¼Œä½†å›è°ƒä¸­çš„é€»è¾‘ä»ä¼šåå‘å½±å“è§£ç å™¨çš„æ€§èƒ½ã€‚å¸¸è§çš„åšæ³•æ˜¯æŠŠå›è°ƒä¸­çš„è§£ç å¸§ç”¨é˜Ÿåˆ—ç¼“å­˜èµ·æ¥ï¼Œåœ¨å¦å¤–çš„çº¿ç¨‹å¤„ç†ã€‚</p><h4 id="cvpixelbufferä¸metaläº¤äº’">CVPixelBufferä¸Metaläº¤äº’</h4><p>æ‹¿åˆ°äº†è§£ç å¸§CMSampleBufferï¼Œå°±å¯ä»¥ä»ä¸­å–å‡ºCVPixelBufferï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•å¤„ç†å’Œæ¸²æŸ“äº†ï¼Œè¿™é‡Œä½¿ç”¨Metalå®Œæˆã€‚</p><p>CVPixelBufferä¸Metaläº¤äº’æ–¹å¼ï¼š</p><ul><li>ç›´æ¥ä½¿ç”¨IOSurfaceã€‚å³ç›´æ¥é€šè¿‡ä»CVPixelBufferå–å‡ºçš„IOSurfaceåˆ›å»ºMetalçº¹ç†ï¼Œä½†è¦æ‰‹åŠ¨å¤„ç†IOSurfaceçš„å†…å­˜é‡Šæ”¾ï¼ˆé€šè¿‡<code>IOSurfaceIncrementUseCount</code>ã€<code>IOSurfaceDecrementUseCount</code>ï¼‰ã€‚</li><li>ä½¿ç”¨CVMetalTextureCacheã€‚<ol type="1"><li>åˆ›å»ºCVMetalTextureCacheï¼š<code>CVMetalTextureCacheCreate</code></li><li>é€šè¿‡å‘CVMetalTextureCacheä¼ å…¥CVPixelBufferåˆ›å»ºCVMetalTextureï¼š<code>CVMetalTextureCacheCreateTextureFromImage</code></li><li>é€šè¿‡CVMetalTextureåˆ›å»ºMTLTextureï¼š<code>CVMetalTextureGetTexture</code></li></ol></li></ul><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://xiaozhuanlan.com/topic/7219405386">WWDC20 10090 - ä½¿ç”¨ AVFoundation å’Œ VideoToolBox åšè§†é¢‘å¤„ç† ï¼ å°ä¸“æ </a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;è§†é¢‘è§£ç apiæ¦‚è¿°&quot;&gt;è§†é¢‘è§£ç APIæ¦‚è¿°&lt;/h2&gt;
&lt;p&gt;AVFoundation&lt;/p&gt;</summary>
    
    
    
    <category term="AVFoundation" scheme="https://bqlin.github.io/categories/AVFoundation/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>Video Toolboxå‹ç¼©é…ç½®</title>
    <link href="https://bqlin.github.io/posts/video_toolbox_compression_configuration/"/>
    <id>https://bqlin.github.io/posts/video_toolbox_compression_configuration/</id>
    <published>2021-10-12T03:20:38.000Z</published>
    <updated>2021-10-12T03:20:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="video-toolboxå‹ç¼©é…ç½®">Video Toolboxå‹ç¼©é…ç½®</h1><h2 id="å‹ç¼©å±æ€§">å‹ç¼©å±æ€§</h2><p>å‹ç¼©å±æ€§éƒ½æ˜¯ä»¥<code>kVTCompressionPropertyKey_Xx</code>å‘½åï¼Œæ‰€ä»¥ä¸‹é¢çš„å±æ€§åéƒ½çœç•¥äº†å…¶å‰ç¼€<code>kVTCompressionPropertyKey_</code>ã€‚</p><h3 id="ç æµé…ç½®">ç æµé…ç½®</h3><p>Depthï¼šåƒç´ æ·±åº¦ã€‚</p><p>è¯¥å±æ€§ä»…ç”±è§†é¢‘ç¼–ç å™¨æ”¯æŒï¼Œç”¨äºä¸ç‰¹å®šåƒç´ æ ¼å¼ï¼ˆä¾‹å¦‚ï¼Œ16ä½RGBã€24ä½RGBï¼‰ç»‘å®šçš„æ ¼å¼ã€‚</p><p>ProfileLevelï¼šç æµé…ç½®å’Œçº§åˆ«ã€‚</p><p><a href="https://developer.apple.com/documentation/videotoolbox/vtcompressionsession/compression_properties/profile_and_level_constants">é…ç½®æ–‡ä»¶å’Œçº§åˆ«å¸¸é‡</a></p><p>H264EntropyModeï¼šç”¨äºH.264å‹ç¼©çš„ç†µç¼–ç æ¨¡å¼ã€‚</p><p>å¦‚æœH.264ç¼–ç å™¨æ”¯æŒï¼Œè¯¥å±æ€§æ§åˆ¶ç¼–ç å™¨æ˜¯å¦åº”ä½¿ç”¨åŸºäºä¸Šä¸‹æ–‡çš„è‡ªé€‚åº”å˜é•¿ç¼–ç ï¼ˆCAVLCï¼‰æˆ–åŸºäºä¸Šä¸‹æ–‡çš„è‡ªé€‚åº”äºŒè¿›åˆ¶ç®—æœ¯ç¼–ç ï¼ˆCABACï¼‰ã€‚CABACé€šå¸¸èƒ½æä¾›æ›´å¥½çš„å‹ç¼©ï¼Œä½†ä»£ä»·æ˜¯æ›´é«˜çš„è®¡ç®—å¼€é”€ã€‚é»˜è®¤å€¼æ˜¯é’ˆå¯¹ç¼–ç å™¨çš„ï¼Œå¯èƒ½ä¼šæ ¹æ®å…¶ä»–ç¼–ç å™¨çš„è®¾ç½®è€Œæ”¹å˜ã€‚</p><p><strong>æ³¨æ„ï¼š</strong>æ”¹å˜é»˜è®¤çš„ç†µæ¨¡å¼å¯èƒ½ä¼šå¯¼è‡´é…ç½®ä¸è¦æ±‚çš„é…ç½®æ–‡ä»¶å’Œçº§åˆ«ä¸å…¼å®¹ã€‚è¿™ç§æƒ…å†µä¸‹çš„ç»“æœæ˜¯ä¸ç¡®å®šçš„ï¼Œå¯èƒ½åŒ…æ‹¬ç¼–ç é”™è¯¯æˆ–ä¸ç¬¦åˆè¦æ±‚çš„è¾“å‡ºæµã€‚</p><ul><li>kVTH264EntropyMode_CABAC</li><li>kVTH264EntropyMode_CAVLC</li></ul><h3 id="ç¼“å†²åŒº">ç¼“å†²åŒº</h3><p>NumberOfPendingFramesï¼šå‹ç¼©ä¼šè¯ä¸­å¾…å¤„ç†çš„å¸§çš„æ•°é‡ã€‚è¯¥å€¼å¯èƒ½ä¼šå¼‚æ­¥å‡å°‘ã€‚</p><p>PixelBufferPoolIsSharedï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè§†é¢‘ç¼–ç å™¨å’Œä¼šè¯å®¢æˆ·ç«¯ä¹‹é—´æ˜¯å¦å…±äº«å…¬å…±åƒç´ ç¼“å†²æ± ã€‚</p><p>falseè¡¨ç¤ºè§†é¢‘ç¼–ç å™¨å’Œå®¢æˆ·ç«¯çš„åƒç´ ç¼“å†²åŒºå±æ€§ä¸å…¼å®¹ï¼Œä½¿ç”¨å•ç‹¬çš„ç¼“å†²æ± ã€‚</p><p>VideoEncoderPixelBufferAttributesï¼šè§†é¢‘ç¼–ç å™¨çš„åƒç´ ç¼“å†²åŒºå±æ€§ã€‚ä½¿ç”¨è¿™äº›å±æ€§æ¥ä¸ºæºåƒç´ ç¼“å†²åŒºåˆ›å»ºä¸€ä¸ªåƒç´ ç¼“å†²åŒºæ± ã€‚</p><h3 id="æ¸…æ´å…‰åœˆå’Œåƒç´ é•¿å®½æ¯”">æ¸…æ´å…‰åœˆå’Œåƒç´ é•¿å®½æ¯”</h3><p>AspectRatio16x9ï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºDVè§†é¢‘æµæ˜¯å¦åº”è®¾ç½®16x9æ ‡å¿—ã€‚</p><p>æ­¤å±æ€§ç”±DV25/50ç³»åˆ—ç¼–ç å™¨æ”¯æŒã€‚</p><p>falseæ—¶ï¼Œå›¾ç‰‡é•¿å®½æ¯”ä¸º4:3ã€‚trueæ—¶ï¼Œå›¾ç‰‡é•¿å®½æ¯”ä¸º16:9ã€‚æ— è®ºå“ªç§æ–¹å¼ï¼Œéƒ½ä¼šä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„é•¿å®½æ¯”ï¼ˆå…·ä½“æ•°å€¼å–å†³äºæ ¼å¼æ˜¯NTSCè¿˜æ˜¯PALï¼‰ã€‚</p><p>CleanApertureï¼šç¼–ç å¸§çš„æ¸…æ´å…‰åœˆã€‚</p><p>å¦‚æœè§†é¢‘ç¼–ç å™¨æ‰§è¡Œç‰¹å®šçš„æ¸…æ´å…‰åœˆï¼Œè¿™ä¸ªå±æ€§æ˜¯åªè¯»çš„ï¼ˆ<code>VTSessionSetProperty(_:key:value:</code>)å°†è¿”å›<code>kVTPropertyReadOnlyErr</code>ï¼‰ã€‚æ´å‡€å­”å¾„å°†åœ¨è¾“å‡ºæ ·æœ¬çš„æ ¼å¼æè¿°ä¸­è®¾ç½®ï¼Œå¹¶å¯èƒ½å½±å“æºå¸§çš„ç¼©æ”¾ã€‚NULLæ˜¯è¿™ä¸ªå±æ€§çš„ä¸€ä¸ªæœ‰æ•ˆå€¼ï¼Œæ„å‘³ç€æ¸…æ´å­”å¾„æ˜¯å…¨å®½å’Œå…¨é«˜ã€‚</p><p>FieldCountï¼šåœºç±»å‹ï¼Œè¡¨ç¤ºå¸§åº”è¯¥æ˜¯é€è¡Œç¼–ç ï¼ˆ1ï¼‰è¿˜æ˜¯éš”è¡Œç¼–ç ï¼ˆ2ï¼‰ã€‚</p><p>åœ¨è¾“å‡ºæ ·æœ¬çš„æ ¼å¼æè¿°ä¸Šè®¾ç½®çš„ï¼Œå¯èƒ½ä¼šå½±å“æºå¸§çš„ç¼©æ”¾ã€‚NULLæ˜¯è¿™ä¸ªå±æ€§çš„ä¸€ä¸ªæœ‰æ•ˆå€¼ã€‚</p><p>FieldDetailï¼šéš”è¡Œæ‰«æå¸§çš„åœºæ’åºã€‚</p><p>å¦‚æœè§†é¢‘ç¼–ç å™¨æ‰§è¡Œç‰¹å®šçš„åœºæ’åºï¼Œè¿™ä¸ªå±æ€§å°†æ˜¯åªè¯»çš„ï¼ˆ<code>VTSessionSetProperty(_:key:value:)</code>è¿”å›<code>kVTPropertyReadOnlyErr</code>ï¼‰ã€‚å­—æ®µç»†èŠ‚æ˜¯åœ¨è¾“å‡ºæ ·æœ¬çš„æ ¼å¼æè¿°ä¸Šè®¾ç½®çš„ï¼Œå¹¶å¯èƒ½å½±å“æºå¸§çš„ç¼©æ”¾ã€‚NULLæ˜¯è¿™ä¸ªå±æ€§çš„ä¸€ä¸ªæœ‰æ•ˆå€¼ã€‚</p><p>PixelAspectRatioï¼šç¼–ç å¸§çš„åƒç´ é•¿å®½æ¯”ã€‚</p><p>å¦‚æœè§†é¢‘ç¼–ç å™¨å¼ºåˆ¶æ‰§è¡Œç‰¹å®šçš„åƒç´ é•¿å®½æ¯”ï¼Œè¯¥å±æ€§å°†æ˜¯åªè¯»çš„ï¼ˆ<code>VTSessionSetProperty(_:key:value:</code>) è¿”å› <code>kVTPropertyReadOnlyErr</code>ï¼‰ã€‚åƒç´ é•¿å®½æ¯”æ˜¯åœ¨è¾“å‡ºæ ·æœ¬çš„æ ¼å¼æè¿°ä¸Šè®¾ç½®çš„ï¼Œå¹¶å¯èƒ½å½±å“æºå¸§çš„ç¼©æ”¾ã€‚NULLæ˜¯è¿™ä¸ªå±æ€§çš„æœ‰æ•ˆå€¼ï¼Œæ„å‘³ç€æ–¹å½¢åƒç´ ï¼ˆ1:1ï¼‰ã€‚</p><p>ProgressiveScanï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºDVè§†é¢‘æµæ˜¯å¦åº”è®¾ç½®é€è¡Œæ ‡å¿—ã€‚</p><p>DV25/50ç³»åˆ—ç¼–ç å™¨æ”¯æŒæ­¤å±æ€§ã€‚å¦‚æœæ˜¯å‡çš„ï¼Œå†…å®¹è¢«ç¼–ç ä¸ºéš”è¡Œæ‰«æã€‚å¦‚æœä¸ºçœŸï¼Œåˆ™å†…å®¹è¢«ç¼–ç ä¸ºæ¸è¿›å¼ã€‚æ­¤å±æ€§çš„å€¼å¯å›ºå®š <code>kVTCompressionPropertyKey_FieldCount</code> å’Œ <code>kVTCompressionPropertyKey_FieldDetail</code> å±æ€§ã€‚</p><h3 id="é¢œè‰²">é¢œè‰²</h3><p>ColorPrimariesï¼šå‹ç¼©å†…å®¹çš„é¢œè‰²åŸè‰²ã€‚</p><p>TransferFunctionï¼šå‹ç¼©å†…å®¹çš„è½¬æ¢å‡½æ•°ã€‚</p><p>YCbCrMatrixï¼šç”¨äºå‹ç¼©å†…å®¹çš„YCbCrçŸ©é˜µã€‚</p><p>ICCProfileï¼šç”¨äºå‹ç¼©å†…å®¹çš„ICCé…ç½®æ–‡ä»¶ã€‚</p><h3 id="é¢„æœŸå€¼">é¢„æœŸå€¼</h3><p>ExpectedDurationï¼šå‹ç¼©ä¼šè¯çš„é¢„æœŸæ€»æ—¶é•¿ã€‚</p><p>ExpectedFrameRateï¼šé¢„æœŸçš„å¸§ç‡ã€‚</p><p>SourceFrameCountï¼šæºå¸§çš„æ•°é‡ã€‚</p><h3 id="å¸§ä¾èµ–">å¸§ä¾èµ–</h3><p>AllowFrameReorderingï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å¯ç”¨äº†å¸§é‡æ’ã€‚</p><p>AllowTemporalCompressionï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å¯ç”¨äº†æ—¶é—´å‹ç¼©ã€‚</p><p>MaxKeyFrameIntervalï¼šå…³é”®å¸§ä¹‹é—´çš„æœ€å¤§é—´éš”ï¼Œä¹Ÿè¢«ç§°ä¸ºå…³é”®å¸§ç‡ã€‚</p><p>MaxKeyFrameIntervalDurationï¼šä»ä¸€ä¸ªå…³é”®å¸§åˆ°ä¸‹ä¸€ä¸ªå…³é”®å¸§çš„æœ€å¤§æŒç»­æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚</p><h3 id="ç¡¬ä»¶åŠ é€Ÿ">ç¡¬ä»¶åŠ é€Ÿ</h3><p>UsingHardwareAcceleratedVideoEncoderï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦ä½¿ç”¨äº†ç¡¬ä»¶åŠ é€Ÿè§†é¢‘ç¼–ç å™¨ã€‚</p><p>kVTVideoEncoderSpecification_RequireHardwareAcceleratedVideoEncoderï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦ç¡¬ä»¶åŠ é€Ÿç¼–ç ã€‚</p><p>kVTVideoEncoderSpecification_EnableHardwareAcceleratedVideoEncoderï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸ç¡¬ä»¶åŠ é€Ÿè§†é¢‘ç¼–ç ï¼ˆå¦‚æœå¯ç”¨ï¼‰ã€‚</p><h3 id="å¤šé‡å‹ç¼©å­˜å‚¨">å¤šé‡å‹ç¼©å­˜å‚¨</h3><p>MultiPassStorageï¼šå¯ç”¨å¤šè·¯å‹ç¼©å¹¶ä¸ºç¼–ç å™¨ç§æœ‰æ•°æ®æä¾›å­˜å‚¨ã€‚</p><h3 id="æ¯å¸§é…ç½®">æ¯å¸§é…ç½®</h3><p>kVTEncodeFrameOptionKey_ForceKeyFrameï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå½“å‰å¸§æ˜¯å¦è¢«å¼ºåˆ¶ä¸ºå…³é”®å¸§çš„ã€‚</p><p>PixelTransferPropertiesï¼šç”¨äºé…ç½®VTPixelTransferSessionçš„å±æ€§ï¼Œä»¥ä¾¿åœ¨å¿…è¦æ—¶å°†æºå¸§ä»å®¢æˆ·ç«¯çš„å›¾åƒç¼“å†²åŒºè½¬ç§»åˆ°è§†é¢‘ç¼–ç å™¨çš„å›¾åƒç¼“å†²åŒºã€‚</p><h3 id="é€Ÿç‡æ§åˆ¶">é€Ÿç‡æ§åˆ¶</h3><p>AverageBitRateï¼šé•¿æœŸæœŸæœ›çš„å¹³å‡æ¯”ç‰¹ç‡ï¼Œå•ä½æ˜¯æ¯”ç‰¹/ç§’ã€‚</p><p>DataRateLimitsï¼šå¯¹æ•°æ®é€Ÿç‡çš„é›¶ã€ä¸€æˆ–ä¸¤ä¸ªç¡¬é™åˆ¶ã€‚</p><p>MoreFramesAfterEndï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºä¸€ä¸ªå‹ç¼©ä¼šè¯çš„å¸§æ˜¯å¦ä»¥åŠå¦‚ä½•ä¸å…¶ä»–å‹ç¼©å¸§ä¸²è”ä»¥å½¢æˆä¸€ä¸ªæ›´é•¿çš„ç³»åˆ—ã€‚</p><p>Qualityï¼šå¸Œæœ›çš„å‹ç¼©è´¨é‡ã€‚</p><p>RealTimeï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å»ºè®®è§†é¢‘ç¼–ç å™¨è¿›è¡Œå®æ—¶å‹ç¼©ã€‚</p><p>MaxH264SliceBytesï¼šH.264ç¼–ç çš„æœ€å¤§åˆ†ç‰‡å¤§å°ã€‚</p><p>MaxFrameDelayCountï¼šå‹ç¼©å™¨åœ¨å¿…é¡»è¾“å‡ºä¸€ä¸ªå‹ç¼©å¸§ä¹‹å‰å…è®¸ä¿ç•™çš„æœ€å¤§å¸§æ•°ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;video-toolboxå‹ç¼©é…ç½®&quot;&gt;Video Toolboxå‹ç¼©é…ç½®&lt;/h1&gt;
&lt;h2 id=&quot;å‹ç¼©å±æ€§&quot;&gt;å‹ç¼©å±æ€§&lt;/h2&gt;</summary>
    
    
    
    <category term="AVFoundation" scheme="https://bqlin.github.io/categories/AVFoundation/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>Audio Queue Services Programming Guideï¼šæ’­æ”¾éŸ³é¢‘</title>
    <link href="https://bqlin.github.io/posts/audio_queue_services_pg_playing_audio/"/>
    <id>https://bqlin.github.io/posts/audio_queue_services_pg_playing_audio/</id>
    <published>2021-09-27T04:18:11.000Z</published>
    <updated>2021-09-27T04:18:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>å½“ä½ ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æ’­æ”¾éŸ³é¢‘æ—¶ï¼Œæºå‡ ä¹å¯ä»¥æ˜¯ä»»æ„çš„â€”â€”ç£ç›˜æ–‡ä»¶ã€åŸºäºè½¯ä»¶éŸ³é¢‘åˆæˆå™¨ã€å†…å­˜ä¸­çš„å¯¹è±¡ç­‰ã€‚æœ¬ç« ä»‹ç»æœ€å¸¸è§çš„æƒ…å†µï¼šæ’­æ”¾ç£ç›˜ä¸Šçš„æ–‡ä»¶ã€‚</p><span id="more"></span><blockquote><p><strong>æ³¨æ„ï¼š</strong>æœ¬ç« ä»‹ç»äº†åŸºäºANSI-Cçš„æ’­æ”¾å®ç°ï¼Œå¹¶ä½¿ç”¨äº†Mac OS X Core Audio SDKçš„C++ç±»ã€‚æœ‰å…³Objective-Cçš„ç¤ºä¾‹ï¼Œå‚é˜…<a href="http://developer.apple.com/devcenter/ios/">iOS Dev Center</a>ä¸­çš„_SpeakHere_ç¤ºä¾‹ä»£ç ã€‚</p></blockquote><p>è¦æŠŠæ’­æ”¾åŠŸèƒ½æ·»åŠ åˆ°ç¨‹åºä¸­ï¼Œé€šå¸¸éœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p><ol type="1"><li>å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰ç»“æ„ä½“æ¥ç®¡ç†çŠ¶æ€ã€æ ¼å¼å’Œè·¯å¾„ä¿¡æ¯ã€‚</li><li>ç¼–å†™éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°æ¥æ‰§è¡Œå®é™…çš„æ’­æ”¾ã€‚</li><li>ç¼–å†™ä»£ç ä»¥ç¡®å®šéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„åˆé€‚å¤§å°ã€‚</li><li>æ‰“å¼€éŸ³é¢‘æ–‡ä»¶è¿›è¡Œæ’­æ”¾ï¼Œç„¶åç¡®å®šå…¶éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚</li><li>åˆ›å»ºä¸€ä¸ªæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å¹¶è¿›è¡Œç›¸å…³é…ç½®ã€‚</li><li>åˆ†é…å’Œæ’é˜ŸéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚å‘Šè¯‰éŸ³é¢‘é˜Ÿåˆ—å¼€å§‹æ’­æ”¾ã€‚å®Œæˆåï¼Œæ’­æ”¾å›è°ƒå‡½æ•°å‘Šè¯‰éŸ³é¢‘é˜Ÿåˆ—åœæ­¢ã€‚</li><li>å¤„ç†éŸ³é¢‘é˜Ÿåˆ—ï¼Œé‡Šæ”¾èµ„æºã€‚</li></ol><p>æœ¬ç« çš„å‰©ä½™éƒ¨åˆ†è¯¦ç»†ä»‹ç»äº†æ¯ä¸ªæ­¥éª¤ã€‚</p><h2 id="å®šä¹‰ç»“æ„ä½“ç®¡ç†çŠ¶æ€">å®šä¹‰ç»“æ„ä½“ç®¡ç†çŠ¶æ€</h2><p>é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå°†ç”¨å®ƒæ¥ç®¡ç†éŸ³é¢‘æ ¼å¼å’ŒéŸ³é¢‘é˜Ÿåˆ—çŠ¶æ€ä¿¡æ¯ï¼Œå¦‚æ¸…å•3-1æ‰€ç¤ºï¼š</p><p><strong>æ¸…å•3-1</strong> æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—çš„è‡ªå®šä¹‰ç»“æ„ä½“</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kNumberBuffers = <span class="number">3</span>;                              <span class="comment">// 1</span></span><br><span class="line"><span class="keyword">struct</span> AQPlayerState &#123;</span><br><span class="line">    AudioStreamBasicDescription   mDataFormat;                    <span class="comment">// 2</span></span><br><span class="line">    AudioQueueRef                 mQueue;                         <span class="comment">// 3</span></span><br><span class="line">    AudioQueueBufferRef           mBuffers[kNumberBuffers];       <span class="comment">// 4</span></span><br><span class="line">    AudioFileID                   mAudioFile;                     <span class="comment">// 5</span></span><br><span class="line">    <span class="built_in">UInt32</span>                        bufferByteSize;                 <span class="comment">// 6</span></span><br><span class="line">    SInt64                        mCurrentPacket;                 <span class="comment">// 7</span></span><br><span class="line">    <span class="built_in">UInt32</span>                        mNumPacketsToRead;              <span class="comment">// 8</span></span><br><span class="line">    AudioStreamPacketDescription  *mPacketDescs;                  <span class="comment">// 9</span></span><br><span class="line">    <span class="keyword">bool</span>                          mIsRunning;                     <span class="comment">// 10</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»“æ„ä½“ä¸­å¤§å¤šæ•°å­—æ®µä¸ç”¨äºå½•åˆ¶çš„è‡ªå®šä¹‰ç»“æ„ä½“å‡ ä¹ç›¸åŒï¼Œå¦‚<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW15">Define a Custom Structure to Manage State</a>æ‰€è¿°ã€‚ä¾‹å¦‚ï¼Œ<code>mDataFormat</code>å­—æ®µä¿å­˜æ­£åœ¨æ’­æ”¾çš„æ–‡ä»¶æ ¼å¼ã€‚å½•åˆ¶æ—¶ï¼Œç±»ä¼¼çš„å­—æ®µä¿å­˜äº†å†™å…¥ç£ç›˜çš„æ–‡ä»¶æ ¼å¼ã€‚</p><p>ä»¥ä¸‹æ˜¯è¯¥ç»“æ„ä½“å„å­—æ®µä»‹ç»ï¼š</p><ol type="1"><li>è®¾ç½®è¦ä½¿ç”¨çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ•°é‡ã€‚å¦‚<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW13">Audio Queue Buffers</a>æ‰€è¿°ï¼Œ3ä¸ªé€šå¸¸æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</li><li><code>AudioStreamBasicDescription</code>ç»“æ„ä½“ï¼ˆæ¥è‡ª<code>CoreAudioTypes.h</code>ï¼‰è¡¨ç¤ºæ­£åœ¨æ’­æ”¾çš„æ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚è¯¥æ ¼å¼ç”±<code>mQueue</code>å­—æ®µæŒ‡å®šçš„éŸ³é¢‘é˜Ÿåˆ—ä½¿ç”¨ã€‚ <code>mDataFormat</code>å­—æ®µé€šè¿‡æŸ¥è¯¢éŸ³é¢‘æ–‡ä»¶çš„<code>kAudioFilePropertyDataFormat</code>å±æ€§æ¥å¡«å……è¯¥å­—æ®µï¼Œå¦‚<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW25">Obtaining a Fileâ€™s Audio Data Format</a>æ‰€è¿°ã€‚ æœ‰å…³<code>AudioStreamBasicDescription</code>ç»“æ„ä½“çš„è¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜…_<a href="https://developer.apple.com/documentation/coreaudio/core_audio_data_types">Core Audio Data Types Reference</a>_ã€‚</li><li>ç¨‹åºåˆ›å»ºçš„æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«æŒ‡å‘éŸ³é¢‘é˜Ÿåˆ—ç®¡ç†çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚</li><li>ä»£è¡¨ç¨‹åºæ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶çš„å¯¹è±¡ã€‚</li><li>æ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚è¯¥å€¼åœ¨éŸ³é¢‘é˜Ÿåˆ—åˆ›å»ºä¹‹åå’Œå¼€å§‹ä¹‹å‰ï¼Œç”±<code>DeriveBufferSize</code>å‡½æ•°è®¡ç®—ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW23">Write a Function to Derive Playback Audio Queue Buffer Size</a>ã€‚</li><li>éŸ³é¢‘æ–‡ä»¶ä¸­ä¸‹ä¸€ä¸ªè¦æ’­æ”¾çš„æ•°æ®åŒ…ç´¢å¼•ã€‚</li><li>æ¯æ¬¡è°ƒç”¨éŸ³é¢‘é˜Ÿåˆ—çš„æ’­æ”¾å›è°ƒå‡½æ•°æ—¶ï¼Œè¦è¯»å–çš„æ•°æ®åŒ…æ•°é‡ã€‚å°±åƒ<code>bufferByteSize</code>å­—æ®µä¸€æ ·ï¼Œåœ¨éŸ³é¢‘é˜Ÿåˆ—åˆ›å»ºä¹‹åå’Œå¼€å§‹ä¹‹å‰ï¼Œç”±<code>DeriveBufferSize</code>å‡½æ•°è®¡ç®—è¯¥å€¼ã€‚</li><li>å¯¹äºVBRéŸ³é¢‘æ•°æ®ï¼Œè¯¥å­—æ®µæ˜¯æ­£åœ¨æ’­æ”¾çš„æ–‡ä»¶çš„æ•°æ®åŒ…æè¿°æ•°ç»„ã€‚å¯¹äºCBRæ•°æ®ï¼Œè¯¥å­—æ®µä¸º<code>NULL</code>ã€‚</li><li>ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºéŸ³é¢‘é˜Ÿåˆ—æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚</li></ol><h2 id="ç¼–å†™æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°">ç¼–å†™æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°</h2><p>ä¸‹é¢ï¼Œç¼–å†™ä¸€ä¸ªæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°ã€‚è¯¥å›è°ƒå‡½æ•°æ‰§è¡Œä¸‰é¡¹ä¸»è¦ä»»åŠ¡ï¼š</p><ul><li>ä»éŸ³é¢‘æ–‡ä»¶ä¸­è¯»å–æŒ‡å®šæ•°é‡çš„æ•°æ®ï¼Œå¹¶å°†å…¶æ”¾å…¥éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºä¸­ã€‚</li><li>æŠŠéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ’é˜Ÿåˆ°ç¼“å†²åŒºé˜Ÿåˆ—ä¸­ã€‚</li><li>å½“æ²¡æœ‰æ›´å¤šæ•°æ®è¦ä»éŸ³é¢‘æ–‡ä»¶ä¸­è¯»å–æ—¶ï¼Œå‘Šè¯‰éŸ³é¢‘é˜Ÿåˆ—åœæ­¢ã€‚</li></ul><p>æœ¬èŠ‚å±•ç¤ºæ¥ä¸€ä¸ªå›è°ƒå£°æ˜ç¤ºä¾‹ï¼Œåˆ†åˆ«æè¿°å„ä¸ªä»»åŠ¡ï¼Œæœ€åç»™å‡ºå®Œæ•´çš„æ’­æ”¾å›è°ƒå‡½æ•°ã€‚æœ‰å…³æ’­æ”¾å›è°ƒå‡½æ•°çš„ä½œç”¨ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW3">å›¾1-4</a>ã€‚</p><h3 id="æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå£°æ˜">æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå£°æ˜</h3><p>æ¸…å•3-2å±•ç¤ºäº†ä¸€ä¸ªæ’­æ”¾éŸ³é¢‘å›è°ƒå‡½æ•°çš„ç¤ºä¾‹å£°æ˜ï¼Œ<code>AudioQueueOutputCallback</code>åœ¨<code>AudioQueue.h</code>å£°æ˜ä¸ºï¼š</p><p><strong>æ¸…å•3-2</strong> æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå£°æ˜</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> HandleOutputBuffer (</span><br><span class="line">    <span class="keyword">void</span>                 *aqData,                 <span class="comment">// 1</span></span><br><span class="line">    AudioQueueRef        inAQ,                    <span class="comment">// 2</span></span><br><span class="line">    AudioQueueBufferRef  inBuffer                 <span class="comment">// 3</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>é€šå¸¸ï¼Œ<code>aqData</code>æ˜¯åŒ…å«å®šä¹‰éŸ³é¢‘é˜Ÿåˆ—çŠ¶æ€ä¿¡æ¯çš„è‡ªå®šä¹‰ç»“æ„ä½“ã€‚å¦‚<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW15">Define a Custom Structure to Manage State</a>æ‰€è¿°ã€‚</li><li>æŒæœ‰è¯¥å›è°ƒå‡½æ•°çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼Œå›è°ƒå‡½æ•°é€šè¿‡ä»éŸ³é¢‘æ–‡ä»¶ä¸­è¯»å–ï¼Œæ¥å¡«å……æ•°æ®ã€‚</li></ol><h3 id="ä»æ–‡ä»¶è¯»å–åˆ°éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº">ä»æ–‡ä»¶è¯»å–åˆ°éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº</h3><p>æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»éŸ³é¢‘æ–‡ä»¶ä¸­è¯»å–æ•°æ®å¹¶å°†å…¶æ”¾åœ¨éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºä¸­ï¼Œå¦‚æ¸…å•3-3æ‰€ç¤ºã€‚</p><p><strong>æ¸…å•3-3</strong> ä»éŸ³é¢‘æ–‡ä»¶è¯»å–åˆ°éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AudioFileReadPackets (                        <span class="comment">// 1</span></span><br><span class="line">    pAqData-&gt;mAudioFile,                      <span class="comment">// 2</span></span><br><span class="line">    <span class="literal">false</span>,                                    <span class="comment">// 3</span></span><br><span class="line">    &amp;numBytesReadFromFile,                    <span class="comment">// 4</span></span><br><span class="line">    pAqData-&gt;mPacketDescs,                    <span class="comment">// 5</span></span><br><span class="line">    pAqData-&gt;mCurrentPacket,                  <span class="comment">// 6</span></span><br><span class="line">    &amp;numPackets,                              <span class="comment">// 7</span></span><br><span class="line">    inBuffer-&gt;mAudioData                      <span class="comment">// 8</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>AudioFileReadPackets</code>å‡½æ•°ï¼ˆåœ¨<code>AudioFile.h</code>ä¸­å£°æ˜ï¼‰ï¼Œä»éŸ³é¢‘æ–‡ä»¶è¯»å–æ•°æ®å¹¶å°†å…¶æ”¾å…¥ç¼“å†²åŒºä¸­ã€‚</li><li>è¦è¯»å–çš„éŸ³é¢‘æ–‡ä»¶ã€‚</li><li>ç”¨<code>false</code>è¡¨ç¤ºè¯¥å‡½æ•°åœ¨è¯»å–æ—¶ä¸åº”ç¼“å­˜æ•°æ®ã€‚</li><li>è¾“å‡ºæ—¶ï¼Œæ˜¯ä»éŸ³é¢‘æ–‡ä»¶è¯»å–çš„éŸ³é¢‘æ•°æ®å­—èŠ‚æ•°ã€‚</li><li>è¾“å‡ºæ—¶ï¼Œæ˜¯ä»éŸ³é¢‘æ–‡ä»¶ä¸­è¯»å–çš„æ•°æ®åŒ…æè¿°æ•°ç»„ã€‚å¯¹äºCBRæ•°æ®ï¼Œè¯¥å‚æ•°è¾“å…¥<code>NULL</code>ã€‚</li><li>ä»éŸ³é¢‘æ–‡ä»¶ä¸­è¯»å–ç¬¬ä¸€ä¸ªæ•°æ®åŒ…çš„ç´¢å¼•ã€‚</li><li>è¾“å…¥æ—¶ï¼Œæ˜¯è¦ä»éŸ³é¢‘æ–‡ä»¶è¯»å–çš„æ•°æ®åŒ…æ•°é‡ã€‚è¾“å‡ºæ—¶ï¼Œæ˜¯å®é™…è¯»å–çš„åŒ…æ•°é‡ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œå¡«å……çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºåŒ…å«ä»éŸ³é¢‘æ–‡ä»¶è¯»å–çš„æ•°æ®ã€‚</li></ol><h3 id="æ’é˜ŸéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº">æ’é˜ŸéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº</h3><p>ç°åœ¨å·²ç»ä»éŸ³é¢‘æ–‡ä»¶ä¸­è¯»å–æ•°æ®å¹¶å°†å…¶æ”¾åœ¨éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºä¸­ï¼Œå›è°ƒå‡½æ•°è®©ç¼“å†²åŒºå…¥é˜Ÿï¼Œå¦‚æ¸…å•3-4æ‰€ç¤ºã€‚è¿›å…¥ç¼“å†²åŒºé˜Ÿåˆ—åï¼Œç¼“å†²åŒºçš„éŸ³é¢‘æ•°æ®å¯ç”¨äºéŸ³é¢‘é˜Ÿåˆ—å‘é€åˆ°è¾“å‡ºè®¾å¤‡ã€‚</p><p><strong>æ¸…å•3-4</strong> ä»ç£ç›˜ä¸­è¯»å–åæ’é˜ŸéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AudioQueueEnqueueBuffer (                      <span class="comment">// 1</span></span><br><span class="line">    pAqData-&gt;mQueue,                           <span class="comment">// 2</span></span><br><span class="line">    inBuffer,                                  <span class="comment">// 3</span></span><br><span class="line">    (pAqData-&gt;mPacketDescs ? numPackets : <span class="number">0</span>),  <span class="comment">// 4</span></span><br><span class="line">    pAqData-&gt;mPacketDescs                      <span class="comment">// 5</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>AudioQueueEnqueueBuffer</code>å‡½æ•°æŠŠéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ·»åŠ åˆ°ç¼“å†²åŒºé˜Ÿåˆ—ã€‚</li><li>æŒæœ‰ç¼“å†²åŒºé˜Ÿåˆ—çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>è¦æ’é˜Ÿçš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ•°æ®ä¸­çš„æ•°æ®åŒ…æ•°é‡ã€‚å¯¹äºä¸ä½¿ç”¨æ•°æ®åŒ…æè¿°çš„CBRæ•°æ®ï¼Œè®¾ä¸º<code>0</code>ã€‚</li><li>å¯¹äºä½¿ç”¨æ•°æ®æè¿°çš„å‹ç¼©éŸ³é¢‘æ•°æ®æ ¼å¼ï¼Œæ•°æ®åŒ…æè¿°åœ¨ç¼“å†²åŒºä¸­ã€‚</li></ol><h3 id="åœæ­¢éŸ³é¢‘é˜Ÿåˆ—">åœæ­¢éŸ³é¢‘é˜Ÿåˆ—</h3><p>å›è°ƒå‡½æ•°æœ€åä¸€ä¸ªæ“ä½œæ˜¯æ£€æŸ¥æ˜¯å¦æœ‰æ›´å¤šçš„æ•°æ®ï¼Œè¦ä»æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶ä¸­è¯»å–ã€‚åœ¨å‘ç°æ–‡ä»¶ç»“å°¾åï¼Œå›è°ƒå‡½æ•°å‘Šè¯‰éŸ³é¢‘é˜Ÿåˆ—åœæ­¢ï¼Œå¦‚æ¸…å•3-5æ‰€ç¤ºã€‚</p><p><strong>æ¸…å•3-5</strong> Â Stopping an audio queue</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (numPackets == <span class="number">0</span>) &#123;                          <span class="comment">// 1</span></span><br><span class="line">    AudioQueueStop (                            <span class="comment">// 2</span></span><br><span class="line">        pAqData-&gt;mQueue,                        <span class="comment">// 3</span></span><br><span class="line">        <span class="literal">false</span>                                   <span class="comment">// 4</span></span><br><span class="line">    );</span><br><span class="line">    pAqData-&gt;mIsRunning = <span class="literal">false</span>;                <span class="comment">// 5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>æ£€æŸ¥<code>AudioFileReadPackets</code>å‡½æ•°ï¼ˆç”±ä¹‹å‰çš„å›è°ƒå‡½æ•°è°ƒç”¨ï¼‰è¯»å–çš„æ•°æ®åŒ…æ•°é‡æ˜¯å¦ä¸º<code>0</code>ã€‚</li><li><code>AudioQueueStop</code>å‡½æ•°åœæ­¢éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>è¦åœæ­¢çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>æ’­æ”¾æ‰€æœ‰æ’é˜Ÿçš„ç¼“å†²åŒºåï¼Œå¼‚æ­¥åœæ­¢éŸ³é¢‘é˜Ÿåˆ—ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW17">Audio Queue Control and State</a>ã€‚</li><li>è®¾ç½®ç»“æ„ä½“æ ‡å¿—ï¼Œè¡¨ç¤ºæ’­æ”¾å·²å®Œæˆã€‚</li></ol><h3 id="å®Œæ•´æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°">å®Œæ•´æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°</h3><p>æ¸…å•3-6å±•ç¤ºäº†å®Œæ•´æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒçš„åŸºæœ¬ä»£ç ã€‚å’Œæœ¬æ–‡æ¡£çš„å…¶ä»–ç¤ºä¾‹ä»£ç ä¸€æ ·ï¼Œè¯¥æ¸…å•ä»£ç ä¸åŒ…å«é”™è¯¯å¤„ç†ã€‚</p><p><strong>æ¸…å•3-6</strong> ä¸€ä¸ªæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> HandleOutputBuffer (</span><br><span class="line">    <span class="keyword">void</span>                *aqData,</span><br><span class="line">    AudioQueueRef       inAQ,</span><br><span class="line">    AudioQueueBufferRef inBuffer</span><br><span class="line">) &#123;</span><br><span class="line">    AQPlayerState *pAqData = (AQPlayerState *) aqData;        <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (pAqData-&gt;mIsRunning == <span class="number">0</span>) <span class="keyword">return</span>;                     <span class="comment">// 2</span></span><br><span class="line">    <span class="built_in">UInt32</span> numBytesReadFromFile;                              <span class="comment">// 3</span></span><br><span class="line">    <span class="built_in">UInt32</span> numPackets = pAqData-&gt;mNumPacketsToRead;           <span class="comment">// 4</span></span><br><span class="line">    AudioFileReadPackets (</span><br><span class="line">        pAqData-&gt;mAudioFile,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        &amp;numBytesReadFromFile,</span><br><span class="line">        pAqData-&gt;mPacketDescs, </span><br><span class="line">        pAqData-&gt;mCurrentPacket,</span><br><span class="line">        &amp;numPackets,</span><br><span class="line">        inBuffer-&gt;mAudioData </span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (numPackets &gt; <span class="number">0</span>) &#123;                                     <span class="comment">// 5</span></span><br><span class="line">        inBuffer-&gt;mAudioDataByteSize = numBytesReadFromFile;  <span class="comment">// 6</span></span><br><span class="line">       AudioQueueEnqueueBuffer ( </span><br><span class="line">            pAqData-&gt;mQueue,</span><br><span class="line">            inBuffer,</span><br><span class="line">            (pAqData-&gt;mPacketDescs ? numPackets : <span class="number">0</span>),</span><br><span class="line">            pAqData-&gt;mPacketDescs</span><br><span class="line">        );</span><br><span class="line">        pAqData-&gt;mCurrentPacket += numPackets;                <span class="comment">// 7 </span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        AudioQueueStop (</span><br><span class="line">            pAqData-&gt;mQueue,</span><br><span class="line">            <span class="literal">false</span></span><br><span class="line">        );</span><br><span class="line">        pAqData-&gt;mIsRunning = <span class="literal">false</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>å®ä¾‹åŒ–åæä¾›ç»™éŸ³é¢‘é˜Ÿåˆ—çš„è‡ªå®šä¹‰ç»“æ„ä½“ï¼ŒåŒ…å«è¦æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶å¯¹è±¡ï¼ˆç±»å‹ä¸º<code>AudioFileID</code>ï¼‰ï¼Œä»¥åŠå„ç§çŠ¶æ€æ•°æ®ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW15">Define a Custom Structure to Manage State</a>ã€‚</li><li>å¦‚æœéŸ³é¢‘é˜Ÿåˆ—å·²åœæ­¢ï¼Œåˆ™ç«‹å³è¿”å›ã€‚</li><li>ä¸€ä¸ªå˜é‡ï¼Œç”¨äºä¿å­˜ä»æ­£åœ¨æ’­æ”¾çš„æ–‡ä»¶ä¸­è¯»å–çš„éŸ³é¢‘æ•°æ®å­—èŠ‚æ•°ã€‚</li><li>ä½¿ç”¨è¦ä»æ­£æ’­æ”¾çš„æ–‡ä»¶ä¸­è¯»å–çš„æ•°æ®åŒ…æ¥åˆå§‹åŒ–<code>numPackets</code>å˜é‡ã€‚</li><li>æµ‹è¯•æ˜¯å¦ä»æ–‡ä»¶ä¸­æ£€ç´¢äº†ä¸€äº›éŸ³é¢‘æ•°æ®ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è®©æ–°å¡«å……çš„ç¼“å†²åŒºå…¥é˜Ÿï¼›å¦åˆ™åœæ­¢éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>å‘Šè¯‰éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºç»“æ„ä½“å·²è¯»å–æ•°æ®çš„å­—èŠ‚æ•°ã€‚</li><li>æ ¹æ®è¯»å–çš„æ•°æ®åŒ…æ•°é‡å¢åŠ æ•°æ®åŒ…ç´¢å¼•ã€‚</li></ol><h2 id="ç¼–å†™å‡½æ•°è®¡ç®—æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°">ç¼–å†™å‡½æ•°è®¡ç®—æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°</h2><p>éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡å¸Œæœ›ä½ çš„ç¨‹åºä¸ºä½¿ç”¨çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæŒ‡å®šå¤§å°ï¼Œå¦‚æ¸…å•3-7æ‰€ç¤ºã€‚å®ƒå¾—å‡ºçš„ç¼“å†²åŒºå¤§å°è¶³ä»¥å®¹çº³ç»™å®šçš„éŸ³é¢‘æ—¶é•¿ã€‚</p><p>åˆ›å»ºæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—åï¼Œä½ å°†åœ¨ç¨‹åºä¸­è°ƒç”¨<code>DeriveBufferSize</code>å‡½æ•°ï¼Œä½œä¸ºåç»­éŸ³é¢‘é˜Ÿåˆ—åˆ†é…ç¼“å†²åŒºçš„å…ˆå†³æ¡ä»¶ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW14">Write a Function to Derive Recording Audio Queue Buffer Size</a>ã€‚ä¸ºäº†æ’­æ”¾ï¼Œè¿˜éœ€è¦ï¼š</p><ul><li>åœ¨æ¯æ¬¡å›è°ƒå‡½æ•°è°ƒç”¨<code>AudioFileReadPackets</code>å‡½æ•°ï¼Œå¾—å‡ºè¦è¯»å–çš„æ•°æ®åŒ…æ•°é‡ã€‚</li><li>è®¾ç½®ç¼“å†²åŒºå¤§å°çš„ä¸‹é™ï¼Œä»¥é¿å…è¿‡å¤šçš„ç£ç›˜è®¿é—®ã€‚</li></ul><p>è¿™é‡Œçš„è®¡ç®—è€ƒè™‘äº†ä»ç£ç›˜è¯»å–çš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚è¯¥æ ¼å¼åŒ…æ‹¬äº†å¯èƒ½å½±å“ç¼“å†²åŒºå¤§å°çš„æ‰€æœ‰å› ç´ ï¼Œä¾‹å¦‚éŸ³é¢‘é€šé“æ•°é‡ã€‚</p><p><strong>æ¸…å•3-7</strong> å¾—å‡ºæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> DeriveBufferSize (</span><br><span class="line">    AudioStreamBasicDescription &amp;ASBDesc,                            <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">UInt32</span>                      maxPacketSize,                       <span class="comment">// 2</span></span><br><span class="line">    Float64                     seconds,                             <span class="comment">// 3</span></span><br><span class="line">    <span class="built_in">UInt32</span>                      *outBufferSize,                      <span class="comment">// 4</span></span><br><span class="line">    <span class="built_in">UInt32</span>                      *outNumPacketsToRead                 <span class="comment">// 5</span></span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> maxBufferSize = <span class="number">0x50000</span>;                        <span class="comment">// 6</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> minBufferSize = <span class="number">0x4000</span>;                         <span class="comment">// 7</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (ASBDesc.mFramesPerPacket != <span class="number">0</span>) &#123;                             <span class="comment">// 8</span></span><br><span class="line">        Float64 numPacketsForTime =</span><br><span class="line">            ASBDesc.mSampleRate / ASBDesc.mFramesPerPacket * seconds;</span><br><span class="line">        *outBufferSize = numPacketsForTime * maxPacketSize;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;                                                         <span class="comment">// 9</span></span><br><span class="line">        *outBufferSize =</span><br><span class="line">            maxBufferSize &gt; maxPacketSize ?</span><br><span class="line">                maxBufferSize : maxPacketSize;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (                                                             <span class="comment">// 10</span></span><br><span class="line">        *outBufferSize &gt; maxBufferSize &amp;&amp;</span><br><span class="line">        *outBufferSize &gt; maxPacketSize</span><br><span class="line">    )</span><br><span class="line">        *outBufferSize = maxBufferSize;</span><br><span class="line">    <span class="keyword">else</span> &#123;                                                           <span class="comment">// 11</span></span><br><span class="line">        <span class="keyword">if</span> (*outBufferSize &lt; minBufferSize)</span><br><span class="line">            *outBufferSize = minBufferSize;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    *outNumPacketsToRead = *outBufferSize / maxPacketSize;           <span class="comment">// 12</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>éŸ³é¢‘é˜Ÿåˆ—çš„<code>AudioStreamBasicDescription</code>ç»“æ„ä½“ã€‚</li><li>æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶ä¸­æœ€å¤§æ•°æ®åŒ…çš„é¢„ä¼°å¤§å°ã€‚ä½ å¯ä»¥é€šè¿‡<code>kAudioFilePropertyPacketSizeUpperBound</code>å±æ€§IDï¼Œä½¿ç”¨<code>AudioFileGetProperty</code>å‡½æ•°ï¼ˆåœ¨<code>AudioFile.h</code>ä¸­å£°æ˜ï¼‰å¾—å‡ºè¯¥å€¼ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW9">Set Sizes for a Playback Audio Queue</a>ã€‚</li><li>ä¸ºæ¯ä¸ªéŸ³é¢‘ç¼“å†²åŒºæŒ‡å®šå¤§å°ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œæ˜¯æ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œæ˜¯åœ¨æ¯æ¬¡æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒæ—¶ï¼Œä»æ–‡ä»¶è¯»å–çš„éŸ³é¢‘æ•°æ®åŒ…çš„æ•°é‡ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°çš„ä¸Šé™ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œä¸Šé™è®¾ä¸º320 KBã€‚è¿™ç›¸ç­‰äºä»¥96 kHzé‡‡æ ·ç‡ï¼Œå¤§çº¦æŒç»­5ç§’çš„24ä½ç«‹ä½“å£°éŸ³é¢‘ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°çš„ä¸‹é™ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œä¸‹é™è®¾ä¸º16 KBã€‚</li><li>å¯¹äºå®šä¹‰æ¯ä¸ªæ•°æ®åŒ…å›ºå®šå¸§æ•°çš„éŸ³é¢‘æ•°æ®æ ¼å¼ï¼Œéœ€è¦å¾—å‡ºéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°ã€‚</li><li>å¯¹äºæ²¡å®šä¹‰æ¯ä¸ªæ•°æ®åŒ…å›ºå®šå¸§æ•°çš„éŸ³é¢‘æ ¼å¼ï¼Œéœ€è¦æ ¹æ®æœ€å¤§æ•°æ®åŒ…å¤§å°å’Œè®¾ç½®çš„ä¸Šé™å¾—å‡ºåˆç†çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°ã€‚</li><li>å¦‚æœå¾—å‡ºçš„ç¼“å†²åŒºå¤§å°å¤§äºè®¾ç½®çš„ä¸Šé™ï¼Œåˆ™è€ƒè™‘é¢„ä¼°çš„æœ€å¤§æ•°æ®åŒ…å¤§å°ï¼Œå¹¶å°†å…¶è°ƒæ•´ä¸ºè¾¹ç•Œå€¼ã€‚</li><li>å¦‚æœå¾—å‡ºçš„ç¼“å†²åŒºå¤§å°ä½äºè®¾ç½®çš„ä¸‹é™ï¼Œåˆ™å°†å…¶è°ƒæ•´ä¸ºä¸‹é™ã€‚</li><li>è®¡ç®—æ¯æ¬¡è°ƒç”¨å›è°ƒæ—¶ä»éŸ³é¢‘æ–‡ä»¶è¯»å–çš„æ•°æ®åŒ…æ•°é‡ã€‚</li></ol><h2 id="æ‰“å¼€éŸ³é¢‘æ–‡ä»¶è¿›è¡Œæ’­æ”¾">æ‰“å¼€éŸ³é¢‘æ–‡ä»¶è¿›è¡Œæ’­æ”¾</h2><p>ç°åœ¨ï¼Œä½¿ç”¨ä»¥ä¸‹æ­¥éª¤æ‰“å¼€éŸ³é¢‘æ–‡ä»¶è¿›è¡Œæ’­æ”¾ï¼š</p><ol type="1"><li>è·å–ä¸€ä¸ªè¡¨ç¤ºè¦æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶çš„CFURLå¯¹è±¡ã€‚</li><li>æ‰“å¼€æ–‡ä»¶ã€‚</li><li>è·å–æ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚</li></ol><h3 id="è·å–éŸ³é¢‘æ–‡ä»¶çš„cfurlå¯¹è±¡">è·å–éŸ³é¢‘æ–‡ä»¶çš„CFURLå¯¹è±¡</h3><p>æ¸…å•3-8å±•ç¤ºäº†å¦‚ä½•ä¸ºè¦æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶è·å–CFURLå¯¹è±¡ã€‚åœ¨ä¸‹ä¸€æ­¥ä¸­ä½¿ç”¨CFURLå¯¹è±¡ï¼Œæ‰“å¼€æ–‡ä»¶ã€‚</p><p><strong>æ¸…å•3-8</strong> è·å–éŸ³é¢‘æ–‡ä»¶çš„CFURLå¯¹è±¡</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFURLRef</span> audioFileURL =</span><br><span class="line">    <span class="built_in">CFURLCreateFromFileSystemRepresentation</span> (           <span class="comment">// 1</span></span><br><span class="line">        <span class="literal">NULL</span>,                                           <span class="comment">// 2</span></span><br><span class="line">        (<span class="keyword">const</span> <span class="built_in">UInt8</span> *) filePath,                       <span class="comment">// 3</span></span><br><span class="line">        strlen (filePath),                              <span class="comment">// 4</span></span><br><span class="line">        <span class="literal">false</span>                                           <span class="comment">// 5</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>CFURLCreateFromFileSystemRepresentation</code>å‡½æ•°ï¼ˆåœ¨<code>CFURL.h</code>ä¸­å£°æ˜ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªCFURLå¯¹è±¡ï¼Œè¯¥å¯¹è±¡è¡¨ç¤ºè¦æ’­æ”¾çš„æ–‡ä»¶ã€‚</li><li>ç”¨<code>NULL</code>æˆ–<code>kCFAllocatorDefault</code>ï¼Œè¡¨ç¤ºä½¿ç”¨å½“å‰é»˜è®¤çš„å†…å­˜åˆ†é…å™¨ã€‚</li><li>æƒ³è¦è½¬æ¢ä¸ºCFURLçš„æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ã€‚åœ¨ç”Ÿäº§ä»£ç ä¸­ï¼Œé€šå¸¸ä¼šä»ç”¨æˆ·è·å–<code>filePath</code>å€¼ã€‚</li><li>æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ä¸­çš„å­—èŠ‚æ•°ã€‚</li><li><code>false</code>å€¼è¡¨ç¤º<code>filePath</code>ä»£è¡¨æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç›®å½•ã€‚</li></ol><h3 id="æ‰“å¼€éŸ³é¢‘æ–‡ä»¶">æ‰“å¼€éŸ³é¢‘æ–‡ä»¶</h3><p>æ¸…å•3-9å±•ç¤ºäº†å¦‚ä½•æ‰“å¼€éŸ³é¢‘æ–‡ä»¶è¿›è¡Œæ’­æ”¾ã€‚</p><p><strong>æ¸…å•3-9</strong> æ‰“å¼€éŸ³é¢‘æ–‡ä»¶è¿›è¡Œæ’­æ”¾</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AQPlayerState aqData;                                   <span class="comment">// 1</span></span><br><span class="line"> </span><br><span class="line">OSStatus result =</span><br><span class="line">    AudioFileOpenURL (                                  <span class="comment">// 2</span></span><br><span class="line">        audioFileURL,                                   <span class="comment">// 3</span></span><br><span class="line">        fsRdPerm,                                       <span class="comment">// 4</span></span><br><span class="line">        <span class="number">0</span>,                                              <span class="comment">// 5</span></span><br><span class="line">        &amp;aqData.mAudioFile                              <span class="comment">// 6</span></span><br><span class="line">    );</span><br><span class="line"> </span><br><span class="line"><span class="built_in">CFRelease</span> (audioFileURL);                               <span class="comment">// 7</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>åˆ›å»º<code>AQPlayerState</code>è‡ªå®šä¹‰ç»“æ„ä½“å®ä¾‹ï¼ˆå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW15">Define a Custom Structure to Manage State</a>ï¼‰ã€‚æ‰“å¼€éŸ³é¢‘æ–‡ä»¶è¿›è¡Œæ’­æ”¾æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å®ä¾‹å­˜æ”¾éŸ³é¢‘æ–‡ä»¶å¯¹è±¡ï¼ˆç±»å‹ä¸º<code>AudioFileID</code>ï¼‰ã€‚</li><li><code>AudioFileOpenURL</code>å‡½æ•°ï¼ˆåœ¨<code>AudioFile.h</code>ä¸­å£°æ˜ï¼‰ï¼Œæ‰“å¼€è¦æ’­æ”¾çš„æ–‡ä»¶ã€‚</li><li>è¦æ’­æ”¾æ–‡ä»¶çš„å¼•ç”¨ã€‚</li><li>ä¸æ­£åœ¨æ’­æ”¾æ–‡ä»¶ä¸€èµ·ä½¿ç”¨çš„æ–‡ä»¶æƒé™ã€‚å¯ç”¨æƒé™åœ¨æ–‡ä»¶ç®¡ç†å™¨çš„<code>File Access Permission Constants</code>æšä¸¾ä¸­å®šä¹‰ã€‚åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œè¯·æ±‚è¯»å–æ–‡ä»¶çš„æƒé™ã€‚</li><li>å¯é€‰æ–‡ä»¶ç±»å‹hintã€‚è¿™é‡Œçš„<code>0</code>è¡¨ç¤ºè¯¥ç¤ºä¾‹æœªä½¿ç”¨è¯¥åŠŸèƒ½ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œå¯¹éŸ³é¢‘æ–‡ä»¶çš„å¼•ç”¨å°†æ”¾åœ¨è‡ªå®šä¹‰ç»“æ„ä½“çš„<code>mAudioFile</code>å­—æ®µã€‚</li><li>é‡Šæ”¾åœ¨ç¬¬ä¸€æ­¥åˆ›å»ºçš„CFURLå¯¹è±¡ã€‚</li></ol><h3 id="è·å–æ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼">è·å–æ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼</h3><p>æ¸…å•3-10å±•ç¤ºäº†å¦‚ä½•è·å–æ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚</p><p><strong>æ¸…å•3-10</strong> è·å–æ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UInt32</span> dataFormatSize = <span class="keyword">sizeof</span> (aqData.mDataFormat);    <span class="comment">// 1</span></span><br><span class="line"> </span><br><span class="line">AudioFileGetProperty (                                  <span class="comment">// 2</span></span><br><span class="line">    aqData.mAudioFile,                                  <span class="comment">// 3</span></span><br><span class="line">    kAudioFilePropertyDataFormat,                       <span class="comment">// 4</span></span><br><span class="line">    &amp;dataFormatSize,                                    <span class="comment">// 5</span></span><br><span class="line">    &amp;aqData.mDataFormat                                 <span class="comment">// 6</span></span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>è·å–åœ¨æŸ¥è¯¢éŸ³é¢‘æ–‡ä»¶æœ‰å…³éŸ³é¢‘æ•°æ®æ ¼å¼æ—¶è¦ä½¿ç”¨çš„é¢„æœŸå±æ€§å€¼å¤§å°ã€‚</li><li><code>AudioFileGetProperty</code>å‡½æ•°ï¼ˆåœ¨<code>AudioFile.h</code>ä¸­å£°æ˜ï¼‰ï¼Œè·å–éŸ³é¢‘æ–‡ä»¶ä¸­æŒ‡å®šå±æ€§çš„å€¼ã€‚</li><li>éŸ³é¢‘æ–‡ä»¶å¯¹è±¡ï¼ˆç±»å‹ä¸º<code>AudioFileID</code>ï¼‰ï¼Œè¡¨ç¤ºè¦è·å–å…¶éŸ³é¢‘æ•°æ®æ ¼å¼çš„æ–‡ä»¶ã€‚</li><li>ç”¨æˆ·è·å–éŸ³é¢‘æ–‡ä»¶çš„æ•°æ®æ ¼å¼çš„å±æ€§IDã€‚</li><li>è¾“å…¥æ—¶ï¼Œæ˜¯æè¿°éŸ³é¢‘æ–‡ä»¶çš„æ•°æ®æ ¼å¼çš„<code>AudioStreamBasicDescription</code>ç»“æ„ä½“çš„é¢„æœŸå¤§å°ã€‚è¾“å‡ºæ—¶ï¼Œæ˜¯å…¶å®é™…å¤§å°ã€‚æ’­æ”¾ç¨‹åºä¸éœ€è¦ä½¿ç”¨è¯¥å€¼ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œä»éŸ³é¢‘æ–‡ä»¶è·å¾—<code>AudioStreamBasicDescription</code>ç»“æ„ä½“çš„å®Œæ•´éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚è¯¥è¡Œé€šè¿‡æŠŠæ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼å­˜å‚¨åœ¨éŸ³é¢‘é˜Ÿåˆ—çš„è‡ªå®šä¹‰ç»“æ„ä½“ä¸­ï¼Œå°†å…¶åº”ç”¨äºéŸ³é¢‘é˜Ÿåˆ—ã€‚</li></ol><h2 id="åˆ›å»ºæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—">åˆ›å»ºæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—</h2><p>æ¸…å•3-11å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ã€‚æ³¨æ„ï¼Œ<code>AudioQueueNewOutput</code>å‡½æ•°ä½¿ç”¨äº†åœ¨ä¹‹å‰æ­¥éª¤ä¸­é…ç½®çš„è‡ªå®šä¹‰ç»“æ„ä½“å’Œå›è°ƒå‡½æ•°ï¼Œä»¥åŠè¦æ’­æ”¾æ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚</p><p><strong>æ¸…å•3-11</strong> åˆ›å»ºæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AudioQueueNewOutput (                                <span class="comment">// 1</span></span><br><span class="line">    &amp;aqData.mDataFormat,                             <span class="comment">// 2</span></span><br><span class="line">    HandleOutputBuffer,                              <span class="comment">// 3</span></span><br><span class="line">    &amp;aqData,                                         <span class="comment">// 4</span></span><br><span class="line">    <span class="built_in">CFRunLoopGetCurrent</span> (),                          <span class="comment">// 5</span></span><br><span class="line">    kCFRunLoopCommonModes,                           <span class="comment">// 6</span></span><br><span class="line">    <span class="number">0</span>,                                               <span class="comment">// 7</span></span><br><span class="line">    &amp;aqData.mQueue                                   <span class="comment">// 8</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>AudioQueueNewOutput</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>è®¾ç½®è¦æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—çš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW25">Obtaining a Fileâ€™s Audio Data Format</a>ã€‚</li><li>å’Œæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨çš„å›è°ƒå‡½æ•°ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW2">Write a Playback Audio Queue Callback</a>ã€‚</li><li>æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—çš„è‡ªå®šä¹‰æ•°æ®ç»“æ„ä½“ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW15">Define a Custom Structure to Manage State</a>ã€‚</li><li>å½“å‰çš„run loopï¼Œå°†åœ¨å…¶è°ƒç”¨éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°ã€‚</li><li>run loopæ¨¡å¼ã€‚é€šå¸¸è®¾ä¸º<code>kCFRunLoopCommonModes</code>ã€‚</li><li>ä¿ç•™å‚æ•°ï¼Œå¿…éœ€ä¸º<code>0</code>ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œæ–°åˆ†é…çš„æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ã€‚</li></ol><h2 id="è®¾ç½®æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å¤§å°">è®¾ç½®æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å¤§å°</h2><p>æ¥ä¸‹æ¥ï¼Œè®¾ç½®æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—çš„ä¸€äº›å¤§å°å€¼ã€‚åœ¨ä¸ºéŸ³é¢‘é˜Ÿåˆ—åˆ†é…ç¼“å†²åŒºæ—¶ï¼Œä»¥åŠå¼€å§‹è¯»å–éŸ³é¢‘æ–‡ä»¶ä¹‹å‰ï¼Œè¯·ä½¿ç”¨è¿™äº›å¤§å°å€¼ã€‚</p><p>æœ¬èŠ‚ä¸­çš„ä»£ç æ¸…å•å±•ç¤ºäº†å¦‚ä½•è®¾ç½®ï¼š</p><ul><li>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°ã€‚</li><li>æ¯æ¬¡è°ƒç”¨æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°æ—¶è¦è¯»å–çš„æ•°æ®åŒ…æ•°é‡ã€‚</li><li>æ•°ç»„å¤§å°ï¼Œç”¨äºä¿å­˜ä¸€ä¸ªç¼“å†²åŒºçš„éŸ³é¢‘æ•°æ®çš„æ•°æ®åŒ…æè¿°ã€‚</li></ul><h3 id="è®¾ç½®ç¼“å†²åŒºå¤§å°å’Œè¦è¯»å–çš„æ•°æ®åŒ…æ•°é‡">è®¾ç½®ç¼“å†²åŒºå¤§å°å’Œè¦è¯»å–çš„æ•°æ®åŒ…æ•°é‡</h3><p>æ¸…å•3-12å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ä¹‹å‰ç¼–å†™çš„<code>DeriveBufferSize</code>å‡½æ•°ï¼ˆå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW23">Write a Function to Derive Playback Audio Queue Buffer Size</a>ï¼‰ã€‚è¿™é‡Œçš„ç›®çš„æ˜¯ä¸ºæ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºè®¾ç½®ä¸€ä¸ªå¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œå¹¶ç¡®å®šæ¯æ¬¡è°ƒç”¨æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°æ—¶è¦è¯»å–çš„åŒ…æ•°é‡ã€‚</p><p>è¯¥ä»£ç ä½¿ç”¨æœ€å¤§æ•°æ®åŒ…å¤§å°çš„ä¿å®ˆé¢„ä¼°å€¼ï¼ŒCore Audioé€šè¿‡<code>kAudioFilePropertyPacketSizeUpperBound</code>å±æ€§æä¾›äº†è¯¥é¢„ä¼°å€¼ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ¯”èµ·èŠ±æ—¶é—´è¯»å–æ•´ä¸ªéŸ³é¢‘æ–‡ä»¶ä»¥è·å¾—å®é™…çš„æœ€å¤§æ•°æ®åŒ…å¤§å°ï¼Œä½¿ç”¨è¿™ç§è¿‘ä¼¼ï¼ˆä½†å¿«é€Ÿï¼‰çš„æŠ€æœ¯æ›´å¥½ã€‚</p><p><strong>æ¸…å•3-12</strong> è®¾ç½®æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å¤§å°å’Œè¦è¯»å–çš„æ•°æ®åŒ…æ•°é‡</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UInt32</span> maxPacketSize;</span><br><span class="line"><span class="built_in">UInt32</span> propertySize = <span class="keyword">sizeof</span> (maxPacketSize);</span><br><span class="line">AudioFileGetProperty (                               <span class="comment">// 1</span></span><br><span class="line">    aqData.mAudioFile,                               <span class="comment">// 2</span></span><br><span class="line">    kAudioFilePropertyPacketSizeUpperBound,          <span class="comment">// 3</span></span><br><span class="line">    &amp;propertySize,                                   <span class="comment">// 4</span></span><br><span class="line">    &amp;maxPacketSize                                   <span class="comment">// 5</span></span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">DeriveBufferSize (                                   <span class="comment">// 6</span></span><br><span class="line">    aqData.mDataFormat,                              <span class="comment">// 7</span></span><br><span class="line">    maxPacketSize,                                   <span class="comment">// 8</span></span><br><span class="line">    <span class="number">0.5</span>,                                             <span class="comment">// 9</span></span><br><span class="line">    &amp;aqData.bufferByteSize,                          <span class="comment">// 10</span></span><br><span class="line">    &amp;aqData.mNumPacketsToRead                        <span class="comment">// 11</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>AudioFileGetProperty</code>å‡½æ•°ï¼ˆåœ¨<code>AudioFile.h</code>ä¸­å£°æ˜ï¼‰ï¼Œè·å–éŸ³é¢‘æ–‡ä»¶çš„æŒ‡å®šå±æ€§çš„å€¼ã€‚è¿™é‡Œï¼Œå¯ä»¥ç”¨å®ƒæ¥è·å–è¦æ’­æ”¾æ–‡ä»¶ä¸­éŸ³é¢‘æ•°æ®åŒ…å¤§å°çš„ä¿å®ˆä¸Šé™å€¼ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li>è¦æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶å¯¹è±¡ï¼ˆç±»å‹ä¸º<code>AudioFileID</code>ï¼‰ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW24">Opening an Audio File</a>ã€‚</li><li>ç”¨äºè·å–éŸ³é¢‘æ–‡ä»¶ä¸­æ•°æ®åŒ…å¤§å°çš„ä¿å®ˆä¸Šé™çš„å±æ€§IDã€‚</li><li>è¾“å‡ºæ—¶ï¼Œ<code>kAudioFilePropertyPacketSizeUpperBound</code>å±æ€§çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li>è¾“å‡ºæ—¶ï¼Œè¦æ’­æ”¾çš„æ–‡ä»¶çš„æ•°æ®åŒ…å¤§å°çš„ä¿å®ˆä¸Šé™ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li><code>DeriveBufferSize</code>å‡½æ•°ï¼ˆåœ¨<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW23">Write a Function to Derive Playback Audio Queue Buffer Size</a>ä¸­æè¿°ï¼‰ï¼Œè®¾ç½®æ¥ç¼“å†²åŒºå¤§å°å’Œæ¯æ¬¡è°ƒç”¨å›è°ƒå‡½æ•°æ—¶è¦è¯»å–çš„æ•°æ®åŒ…æ•°é‡ã€‚</li><li>è¦æ’­æ”¾çš„æ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW25">Obtaining a Fileâ€™s Audio Data Format</a>ã€‚</li><li>æ¥è‡ªç¬¬5è¡Œçš„éŸ³é¢‘æ–‡ä»¶æœ€å¤§æ•°æ®åŒ…å¤§å°çš„é¢„ä¼°å€¼ã€‚</li><li>æ¯æ¬¡éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºåº”ä¿ç•™çš„éŸ³é¢‘æ—¶é•¿ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚æ­¤å¤„è®¾ç½®åŠç§’æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œæ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚è¯¥å€¼æ”¾åœ¨éŸ³é¢‘é˜Ÿåˆ—çš„è‡ªå®šä¹‰ç»“æ„ä½“ä¸­ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œæ˜¯åœ¨æ¯æ¬¡æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒæ—¶è¦è¯»å–çš„æ•°æ®åŒ…æ•°é‡ã€‚è¯¥å€¼ä¹Ÿæ”¾åœ¨éŸ³é¢‘é˜Ÿåˆ—çš„è‡ªå®šä¹‰ç»“æ„ä½“ä¸­ã€‚</li></ol><h3 id="ç»™æ•°æ®åŒ…æè¿°æ•°ç»„åˆ†é…å†…å­˜">ç»™æ•°æ®åŒ…æè¿°æ•°ç»„åˆ†é…å†…å­˜</h3><p>ç°åœ¨ï¼Œç»™æ•°ç»„åˆ†é…å†…å­˜ï¼Œä»¥ä¿å­˜ä¸€ä¸ªç¼“å†²åŒºçš„éŸ³é¢‘æ•°æ®çš„æ•°æ®åŒ…æè¿°ã€‚CBRæ•°æ®ä¸ä½¿ç”¨æ•°æ®åŒ…æè¿°ï¼Œå› æ­¤CBRçš„æƒ…å†µï¼ˆæ¸…å•3-13ä¸­çš„æ­¥éª¤3ï¼‰éå¸¸ç®€å•ã€‚</p><p><strong>æ¸…å•3-13</strong> ç»™æ•°æ®åŒ…æè¿°æ•°ç»„åˆ†é…å†…å­˜</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> isFormatVBR = (                                       <span class="comment">// 1</span></span><br><span class="line">    aqData.mDataFormat.mBytesPerPacket == <span class="number">0</span> ||</span><br><span class="line">    aqData.mDataFormat.mFramesPerPacket == <span class="number">0</span></span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (isFormatVBR) &#123;                                         <span class="comment">// 2</span></span><br><span class="line">    aqData.mPacketDescs =</span><br><span class="line">      (AudioStreamPacketDescription*) malloc (</span><br><span class="line">        aqData.mNumPacketsToRead * <span class="keyword">sizeof</span> (AudioStreamPacketDescription)</span><br><span class="line">      );</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;                                                   <span class="comment">// 3</span></span><br><span class="line">    aqData.mPacketDescs = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>ç¡®å®šéŸ³é¢‘æ–‡ä»¶çš„æ•°æ®æ ¼å¼æ˜¯VBRè¿˜æ˜¯CBRã€‚åœ¨VBRæ•°æ®ä¸­ï¼Œbytes-per-packetæˆ–frames-per-packetå€¼çš„ä¸€ä¸ªæˆ–ä¸¤ä¸ªæ˜¯å¯å˜çš„ï¼Œå› æ­¤åˆ—å‡ºåœ¨éŸ³é¢‘é˜Ÿåˆ—çš„<code>AudioStreamBasicDescription</code>ç»“æ„ä½“ä¸­è¿™ä¸¤ä¸ªå€¼ä¸º<code>0</code>çš„æƒ…å†µã€‚</li><li>å¯¹äºåŒ…å«VBRæ•°æ®çš„éŸ³é¢‘æ–‡ä»¶ï¼Œåˆ™ä¸ºæ•°æ®åŒ…æè¿°æ•°ç»„åˆ†é…å†…å­˜ã€‚æ ¹æ®æ¯æ¬¡æ’­æ”¾å›è°ƒè°ƒç”¨æ—¶è¦è¯»å–çš„éŸ³é¢‘æ•°æ®åŒ…æ•°é‡ï¼Œè®¡ç®—æ‰€éœ€å†…å­˜ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW26">Setting Buffer Size and Number of Packets to Read</a>ã€‚</li><li>å¯¹äºåŒ…å«CBRæ•°æ®çš„éŸ³é¢‘æ–‡ä»¶ï¼ˆä¾‹å¦‚çº¿æ€§PCMï¼‰ï¼ŒéŸ³é¢‘é˜Ÿåˆ—ä¸ä½¿ç”¨æ•°æ®åŒ…æè¿°æ•°ç»„ã€‚</li></ol><h2 id="ç»™æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—è®¾ç½®magic-cookie">ç»™æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—è®¾ç½®Magic Cookie</h2><p>æŸäº›å‹ç¼©éŸ³é¢‘æ ¼å¼ï¼ˆä¾‹å¦‚MPEG 4 AACï¼‰åˆ©ç”¨ç»“æ„ä½“æ¥åŒ…å«éŸ³é¢‘å…ƒæ•°æ®ã€‚è¿™äº›ç»“æ„ä½“ç§°ä¸º<strong>magic cookies</strong>ã€‚ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡ä»¥è¿™ç§æ ¼å¼æ’­æ”¾æ–‡ä»¶æ—¶ï¼Œéœ€è¦ä»éŸ³é¢‘æ–‡ä»¶ä¸­è·å–magic cookieï¼Œç„¶ååœ¨å¼€å§‹æ’­æ”¾ä¹‹å‰åº”ç”¨åˆ°éŸ³é¢‘é˜Ÿåˆ—ä¸­ã€‚</p><p>æ¸…å•3-14å±•ç¤ºäº†å¦‚ä½•ä»æ–‡ä»¶ä¸­è·å–magic cookieå¹¶å°†å…¶åº”ç”¨åˆ°éŸ³é¢‘é˜Ÿåˆ—ã€‚ä½ éœ€è¦åœ¨å¼€å§‹æ’­æ”¾ä¹‹å‰è°ƒç”¨è¯¥å‡½æ•°ã€‚</p><p><strong>æ¸…å•3-14</strong> ä¸ºæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—è®¾ç½®magic cookie</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UInt32</span> cookieSize = <span class="keyword">sizeof</span> (<span class="built_in">UInt32</span>);                   <span class="comment">// 1</span></span><br><span class="line"><span class="keyword">bool</span> couldNotGetProperty =                             <span class="comment">// 2</span></span><br><span class="line">    AudioFileGetPropertyInfo (                         <span class="comment">// 3</span></span><br><span class="line">        aqData.mAudioFile,                             <span class="comment">// 4</span></span><br><span class="line">        kAudioFilePropertyMagicCookieData,             <span class="comment">// 5</span></span><br><span class="line">        &amp;cookieSize,                                   <span class="comment">// 6</span></span><br><span class="line">        <span class="literal">NULL</span>                                           <span class="comment">// 7</span></span><br><span class="line">    );</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (!couldNotGetProperty &amp;&amp; cookieSize) &#123;              <span class="comment">// 8</span></span><br><span class="line">    <span class="keyword">char</span>* magicCookie =</span><br><span class="line">        (<span class="keyword">char</span> *) malloc (cookieSize);</span><br><span class="line"> </span><br><span class="line">    AudioFileGetProperty (                             <span class="comment">// 9</span></span><br><span class="line">        aqData.mAudioFile,                             <span class="comment">// 10</span></span><br><span class="line">        kAudioFilePropertyMagicCookieData,             <span class="comment">// 11</span></span><br><span class="line">        &amp;cookieSize,                                   <span class="comment">// 12</span></span><br><span class="line">        magicCookie                                    <span class="comment">// 13</span></span><br><span class="line">    );</span><br><span class="line"> </span><br><span class="line">    AudioQueueSetProperty (                            <span class="comment">// 14</span></span><br><span class="line">        aqData.mQueue,                                 <span class="comment">// 15</span></span><br><span class="line">        kAudioQueueProperty_MagicCookie,               <span class="comment">// 16</span></span><br><span class="line">        magicCookie,                                   <span class="comment">// 17</span></span><br><span class="line">        cookieSize                                     <span class="comment">// 18</span></span><br><span class="line">    );</span><br><span class="line"> </span><br><span class="line">    free (magicCookie);                                <span class="comment">// 19</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>è®¾ç½®magic cookieæ•°æ®çš„é¢„ä¼°å¤§å°ã€‚</li><li>æ¥æ”¶<code>AudioFileGetPropertyInfo</code>å‡½æ•°çš„ç»“æœã€‚å¦‚æœæˆåŠŸï¼Œè¯¥å‡½æ•°è¿”å›<code>NoErr</code>ï¼Œç­‰åŒäºå¸ƒå°”å€¼<code>false</code>ã€‚</li><li><code>AudioFileGetPropertyInfo</code>å‡½æ•°ï¼ˆåœ¨<code>AudioFile.h</code>ä¸­å£°æ˜ï¼‰ï¼Œè·å–æŒ‡å®šå±æ€§å€¼çš„å¤§å°ã€‚å¯ä»¥ç”¨å®ƒæ¥è®¾ç½®ä¿å­˜å±æ€§å€¼çš„å˜é‡å¤§å°ã€‚</li><li>éŸ³é¢‘æ–‡ä»¶å¯¹è±¡ï¼ˆç±»å‹ä¸º<code>AudioFileID</code>ï¼‰ï¼Œè¡¨ç¤ºè¦æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶ã€‚</li><li>è¡¨ç¤ºéŸ³é¢‘æ–‡ä»¶çš„magic cookieæ•°æ®çš„å±æ€§IDã€‚</li><li>è¾“å…¥æ—¶ï¼Œmagic cookieæ•°æ®çš„é¢„ä¼°å¤§å°ã€‚è¾“å‡ºæ—¶ï¼Œæ˜¯å…¶å®é™…å¤§å°ã€‚</li><li>ç”¨<code>NULL</code>è¡¨ç¤ºä¸å…³å¿ƒè¯¥å±æ€§çš„è¯»/å†™è®¿é—®æƒé™ã€‚</li><li>å¦‚æœéŸ³é¢‘æ–‡ä»¶ç¡®å®åŒ…å«magic cookieï¼Œåˆ™åˆ†é…å†…å­˜ä¿å­˜å®ƒã€‚</li><li><code>AudioFileGetProperty</code>å‡½æ•°ï¼ˆåœ¨<code>AudioFile.h</code>ä¸­å£°æ˜ï¼‰ï¼Œè·å–æŒ‡å®šå±æ€§çš„å€¼ã€‚åœ¨è¿™é‡Œï¼Œå®ƒå°†è·å–éŸ³é¢‘æ–‡ä»¶çš„magic cookieã€‚</li><li>éŸ³é¢‘æ–‡ä»¶å¯¹è±¡ï¼ˆç±»å‹ä¸º<code>AudioFileID</code>ï¼‰ï¼Œè¡¨ç¤ºè¦æ’­æ”¾çš„ä»¥åŠè¦è·å–magic cookieçš„éŸ³é¢‘æ–‡ä»¶ã€‚</li><li>éŸ³é¢‘æ–‡ä»¶çš„magic cookieæ•°æ®çš„å±æ€§IDã€‚</li><li>è¾“å…¥æ—¶ï¼Œ<code>magicCookie</code>ä½¿ç”¨<code>AudioFileGetPropertyInfo</code>å‡½æ•°è·å¾—å˜é‡çš„å¤§å°ã€‚è¾“å‡ºæ—¶ï¼Œå°†æ˜¯magic cookieçš„å®é™…å¤§å°ï¼ˆä»¥å†™å…¥<code>magicCookie</code>å˜é‡çš„å­—èŠ‚æ•°ä¸ºå•ä½ï¼‰ã€‚</li><li>è¾“å‡ºæ—¶ï¼ŒéŸ³é¢‘æ–‡ä»¶çš„magic cookieã€‚</li><li><code>AudioQueueSetProperty</code>å‡½æ•°ç»™éŸ³é¢‘é˜Ÿåˆ—è®¾ç½®å±æ€§ã€‚åœ¨è¿™é‡Œï¼Œå®ƒå°†ç»™éŸ³é¢‘é˜Ÿåˆ—è®¾ç½®magic cookieï¼Œä½¿å…¶äºè¦æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶ä¸­çš„magic cookieç›¸åŒ¹é…ã€‚</li><li>è¦ä¸ºå…¶è®¾ç½®magic cookieçš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—çš„magic cookieçš„å±æ€§IDã€‚</li><li>è¦æ’­æ”¾æ–‡ä»¶ä¸­çš„magic cookieã€‚</li><li>magic cookieçš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li>é‡Šæ”¾åˆ†é…ç»™magic cookieçš„å†…å­˜ã€‚</li></ol><h2 id="åˆ†é…å’Œå‡†å¤‡éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº">åˆ†é…å’Œå‡†å¤‡éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº</h2><p>ç°åœ¨ï¼Œè¯·æ±‚ä¹‹å‰åˆ›å»ºçš„ï¼ˆå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW5">Create a Playback Audio Queue</a>ï¼‰éŸ³é¢‘é˜Ÿåˆ—æ¥å‡†å¤‡ä¸€ç»„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼Œå¦‚æ¸…å•3-15æ‰€ç¤ºã€‚</p><p><strong>æ¸…å•3-15</strong> åˆ†é…å’Œå‡†å¤‡éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºè¿›è¡Œæ’­æ”¾</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">aqData.mCurrentPacket = <span class="number">0</span>;                                <span class="comment">// 1</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; kNumberBuffers; ++i) &#123;                <span class="comment">// 2</span></span><br><span class="line">    AudioQueueAllocateBuffer (                            <span class="comment">// 3</span></span><br><span class="line">        aqData.mQueue,                                    <span class="comment">// 4</span></span><br><span class="line">        aqData.bufferByteSize,                            <span class="comment">// 5</span></span><br><span class="line">        &amp;aqData.mBuffers[i]                               <span class="comment">// 6</span></span><br><span class="line">    );</span><br><span class="line"> </span><br><span class="line">    HandleOutputBuffer (                                  <span class="comment">// 7</span></span><br><span class="line">        &amp;aqData,                                          <span class="comment">// 8</span></span><br><span class="line">        aqData.mQueue,                                    <span class="comment">// 9</span></span><br><span class="line">        aqData.mBuffers[i]                                <span class="comment">// 10</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>æ•°æ®åŒ…ç´¢å¼•è®¾ä¸º<code>0</code>ï¼Œä»¥ä¾¿å½“å‰éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°å¡«å……ç¼“å†²åŒºï¼ˆæ­¥éª¤7ï¼‰æ—¶ï¼Œæ˜¯ä»éŸ³é¢‘æ–‡ä»¶çš„å¼€å¤´å¼€å§‹ã€‚</li><li>åˆ†é…å’Œå‡†å¤‡ä¸€ç»„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼ˆ<code>kNumberBuffers</code>è®¾ç½®ä¸º<code>3</code>ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW15">Define a Custom Structure to Manage State</a>ï¼‰ã€‚</li><li><code>AudioQueueAllocateBuffer</code>å‡½æ•°é€šè¿‡ä¸ºå…¶åˆ†é…å†…å­˜æ¥åˆ›å»ºéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚</li><li>åˆ†é…ç¼“å†²åŒºçš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>æ–°éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li>è¾“å‡ºæ—¶ï¼ŒæŠŠæ–°çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ·»åŠ åˆ°è‡ªå®šä¹‰ç»“æ„ä½“çš„<code>mBuffers</code>æ•°ç»„ä¸­ã€‚</li><li><code>HandleOutputBuffer</code>æ˜¯æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW2">Write a Playback Audio Queue Callback</a>ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—çš„è‡ªå®šä¹‰ç»“æ„ä½“ã€‚</li><li>è¦è°ƒç”¨å…¶å›è°ƒçš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>è¦ä¼ é€’ç»™éŸ³é¢‘é˜Ÿåˆ—å›è°ƒçš„ç¼“å†²åŒºã€‚</li></ol><h2 id="è®¾ç½®éŸ³é¢‘é˜Ÿåˆ—æ’­æ”¾å¢ç›Š">è®¾ç½®éŸ³é¢‘é˜Ÿåˆ—æ’­æ”¾å¢ç›Š</h2><p>åœ¨éŸ³é¢‘é˜Ÿåˆ—å¼€å§‹æ’­æ”¾ä¹‹å‰ï¼Œé€šè¿‡éŸ³é¢‘é˜Ÿåˆ—å‚æ•°æœºåˆ¶è®¾ç½®å…¶å¢ç›Šï¼Œå¦‚æ¸…å•3-16æ‰€ç¤ºã€‚æœ‰å…³å‚æ•°æœºåˆ¶çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW15">Audio Queue Parameters</a>ã€‚</p><p><strong>æ¸…å•3-16</strong> è®¾ç½®éŸ³é¢‘é˜Ÿåˆ—çš„æ’­æ”¾å¢ç›Š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Float32 gain = <span class="number">1.0</span>;                                       <span class="comment">// 1</span></span><br><span class="line">    <span class="comment">// Optionally, allow user to override gain setting here</span></span><br><span class="line">AudioQueueSetParameter (                                  <span class="comment">// 2</span></span><br><span class="line">    aqData.mQueue,                                        <span class="comment">// 3</span></span><br><span class="line">    kAudioQueueParam_Volume,                              <span class="comment">// 4</span></span><br><span class="line">    gain                                                  <span class="comment">// 5</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>åœ¨<code>0</code>ï¼ˆé™éŸ³ï¼‰å’Œ<code>1</code>ï¼ˆå•å…ƒå¢ç›Šï¼‰ä¹‹é—´è®¾ç½®å¢ç›Šã€‚</li><li><code>AudioQueueSetParameter</code>å‡½æ•°è®¾ç½®éŸ³é¢‘é˜Ÿåˆ—çš„å‚æ•°å€¼ã€‚</li><li>è¦è®¾ç½®å‚æ•°çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>è¦è®¾ç½®çš„å‚æ•°IDã€‚<code>kAudioQueueParam_Volume</code>ç”¨äºè®¾ç½®éŸ³é¢‘é˜Ÿåˆ—å¢ç›Šã€‚</li><li>è¦åº”ç”¨äºéŸ³é¢‘é˜Ÿåˆ—çš„å¢ç›Šè®¾ç½®ã€‚</li></ol><h2 id="å¯åŠ¨å’Œè¿è¡ŒéŸ³é¢‘é˜Ÿåˆ—">å¯åŠ¨å’Œè¿è¡ŒéŸ³é¢‘é˜Ÿåˆ—</h2><p>å‰é¢çš„ä»£ç å·²ç»ä¸ºæ’­æ”¾æ–‡ä»¶åšäº†å‡†å¤‡ã€‚ä¸‹é¢æ˜¯å¯åŠ¨éŸ³é¢‘é˜Ÿåˆ—å’Œç»´æŠ¤run loopï¼Œå¦‚æ¸…å•3-17æ‰€ç¤ºã€‚</p><p><strong>æ¸…å•3-17</strong> å¯åŠ¨å’Œè¿è¡ŒéŸ³é¢‘é˜Ÿåˆ—</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">aqData.mIsRunning = <span class="literal">true</span>;                          <span class="comment">// 1</span></span><br><span class="line"> </span><br><span class="line">AudioQueueStart (                                  <span class="comment">// 2</span></span><br><span class="line">    aqData.mQueue,                                 <span class="comment">// 3</span></span><br><span class="line">    <span class="literal">NULL</span>                                           <span class="comment">// 4</span></span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">do</span> &#123;                                               <span class="comment">// 5</span></span><br><span class="line">    <span class="built_in">CFRunLoopRunInMode</span> (                           <span class="comment">// 6</span></span><br><span class="line">        kCFRunLoopDefaultMode,                     <span class="comment">// 7</span></span><br><span class="line">        <span class="number">0.25</span>,                                      <span class="comment">// 8</span></span><br><span class="line">        <span class="literal">false</span>                                      <span class="comment">// 9</span></span><br><span class="line">    );</span><br><span class="line">&#125; <span class="keyword">while</span> (aqData.mIsRunning);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">CFRunLoopRunInMode</span> (                               <span class="comment">// 10</span></span><br><span class="line">    kCFRunLoopDefaultMode,</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>è®¾ç½®è‡ªå®šä¹‰ç»“æ„ä½“æ ‡å¿—ï¼Œè¡¨ç¤ºéŸ³é¢‘é˜Ÿåˆ—æ­£åœ¨è¿è¡Œã€‚</li><li><code>AudioQueueStart</code>å‡½æ•°åœ¨å…¶è‡ªèº«çš„çº¿ç¨‹ä¸Šå¯åŠ¨éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>è¦å¼€å§‹çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>ç”¨<code>NULL</code>è¡¨ç¤ºå› é˜Ÿåˆ—åº”ç«‹å³å¼€å§‹æ’­æ”¾ã€‚</li><li>å®šä¹‰è½®è¯¢è‡ªå®šä¹‰ç»“æ„ä½“çš„<code>mIsRunning</code>å­—æ®µï¼Œä»¥æ£€æŸ¥éŸ³é¢‘é˜Ÿåˆ—æ˜¯å¦å·²ç»åœæ­¢ã€‚</li><li><code>CFRunLoopRunInMode</code>å‡½æ•°è¿è¡ŒåŒ…å«éŸ³é¢‘é˜Ÿåˆ—çº¿ç¨‹çš„run loopã€‚</li><li>å¯¹run loopä½¿ç”¨é»˜è®¤æ¨¡å¼ã€‚</li><li>æŠŠrun loopçš„è¿è¡Œæ—¶é—´è®¾ç½®ä¸º<code>0.25</code>ç§’ã€‚</li><li>ç”¨<code>false</code>è¡¨ç¤ºrun loopåº”åœ¨æŒ‡å®šçš„æ—¶é—´å†…ç»§ç»­ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—åœæ­¢åï¼Œå†è¿è¡Œä¸€æ¬¡run loopï¼Œä»¥ç¡®ä¿å½“å‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæœ‰è¶³å¤Ÿæ—¶é—´å®Œæˆã€‚</li></ol><h2 id="æ’­æ”¾åçš„æ¸…ç†">æ’­æ”¾åçš„æ¸…ç†</h2><p>æ’­æ”¾æ–‡ä»¶åï¼Œå¤„ç†éŸ³é¢‘é˜Ÿåˆ—ï¼Œå…³é—­éŸ³é¢‘æ–‡ä»¶ï¼Œå¹¶é‡Šæ”¾æ‰€æœ‰å‰©ä½™èµ„æºï¼Œå¦‚æ¸…å•3-18æ‰€ç¤ºã€‚</p><p><strong>æ¸…å•3-18</strong> æ’­æ”¾éŸ³é¢‘æ–‡ä»¶åæ¸…ç†</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AudioQueueDispose (                            <span class="comment">// 1</span></span><br><span class="line">    aqData.mQueue,                             <span class="comment">// 2</span></span><br><span class="line">    <span class="literal">true</span>                                       <span class="comment">// 3</span></span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">AudioFileClose (aqData.mAudioFile);            <span class="comment">// 4</span></span><br><span class="line"> </span><br><span class="line">free (aqData.mPacketDescs);                    <span class="comment">// 5</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>AudioQueueDispose</code>å‡½æ•°å¤„ç†éŸ³é¢‘é˜Ÿåˆ—åŠå…¶æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬ç¼“å†²åŒºã€‚</li><li>è¦å¤„ç†çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>ç”¨<code>true</code>è¡¨ç¤ºåŒæ­¥å¤„ç†éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>å…³é—­æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶ã€‚<code>AudioFileClose</code>å‡½æ•°åœ¨<code>AudioFile.h</code>ä¸­å£°æ˜ã€‚</li><li>é‡Šæ”¾ç”¨äºä¿å­˜æ•°æ®åŒ…æè¿°çš„å†…å­˜ã€‚</li></ol><h2 id="æ€»ç»“">æ€»ç»“</h2><ul><li>ä½¿ç”¨AudioQueueå®ç°æ’­æ”¾åŠŸèƒ½ï¼Œä¸€èˆ¬æ­¥éª¤ï¼š<ol type="1"><li>å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰ç»“æ„ä½“æ¥ç®¡ç†çŠ¶æ€ã€æ ¼å¼å’Œè·¯å¾„ä¿¡æ¯ã€‚</li><li>ç¼–å†™éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°æ¥æ‰§è¡Œå®é™…çš„æ’­æ”¾ã€‚</li><li>ç¼–å†™ä»£ç ä»¥ç¡®å®šéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„åˆé€‚å¤§å°ã€‚</li><li>æ‰“å¼€éŸ³é¢‘æ–‡ä»¶è¿›è¡Œæ’­æ”¾ï¼Œç„¶åç¡®å®šå…¶éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚</li><li>åˆ›å»ºä¸€ä¸ªæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å¹¶è¿›è¡Œç›¸å…³é…ç½®ã€‚</li><li>åˆ†é…å’Œæ’é˜ŸéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚å‘Šè¯‰éŸ³é¢‘é˜Ÿåˆ—å¼€å§‹æ’­æ”¾ã€‚å®Œæˆåï¼Œæ’­æ”¾å›è°ƒå‡½æ•°å‘Šè¯‰éŸ³é¢‘é˜Ÿåˆ—åœæ­¢ã€‚</li><li>å¤„ç†éŸ³é¢‘é˜Ÿåˆ—ï¼Œé‡Šæ”¾èµ„æºã€‚</li></ol></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å½“ä½ ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æ’­æ”¾éŸ³é¢‘æ—¶ï¼Œæºå‡ ä¹å¯ä»¥æ˜¯ä»»æ„çš„â€”â€”ç£ç›˜æ–‡ä»¶ã€åŸºäºè½¯ä»¶éŸ³é¢‘åˆæˆå™¨ã€å†…å­˜ä¸­çš„å¯¹è±¡ç­‰ã€‚æœ¬ç« ä»‹ç»æœ€å¸¸è§çš„æƒ…å†µï¼šæ’­æ”¾ç£ç›˜ä¸Šçš„æ–‡ä»¶ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Audio Queue Services Programming Guide" scheme="https://bqlin.github.io/tags/Audio-Queue-Services-Programming-Guide/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>Audio Queue Services Programming Guideï¼šå½•åˆ¶éŸ³é¢‘</title>
    <link href="https://bqlin.github.io/posts/audio_queue_services_pg_recording_audio/"/>
    <id>https://bqlin.github.io/posts/audio_queue_services_pg_recording_audio/</id>
    <published>2021-09-27T04:17:11.000Z</published>
    <updated>2021-09-27T04:17:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>å½“ä½ ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡è¿›è¡Œå½•åˆ¶çš„æ—¶å€™ï¼Œä½ å¯ä»¥å°†éŸ³é¢‘å½•åˆ¶åˆ°ä»»ä½•åœ°æ–¹ï¼šç£ç›˜æ–‡ä»¶ã€ç½‘ç»œè¿æ¥æˆ–å†…å­˜å¯¹è±¡ç­‰ç­‰ã€‚æœ¬ç« å°†ä»‹ç»ä¸­æœ€å¸¸è§çš„ä¸€ç§æƒ…å†µï¼Œå°†éŸ³é¢‘å½•åˆ¶åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚</p><span id="more"></span><blockquote><p><strong>æ³¨æ„ï¼š</strong>æœ¬ç« ä»‹ç»äº†åŸºäºANSI-Cçš„å½•åˆ¶çš„å®ç°ï¼Œå¹¶ä¸”ä½¿ç”¨äº†MAC OS Xä¸­Core Audio SDKä¸­äº†ä¸€äº›C++ç±»ï¼Œå¦‚æœæƒ³äº†è§£åŸºäºObjective-Cçš„ä¾‹å­ï¼Œè¯·å‚è€ƒ<a href="http://developer.apple.com/devcenter/ios/">iOS Dev Center</a>ä¸­çš„_SpeakHere_ä¾‹å­ã€‚</p></blockquote><p>è¦æŠŠå½•åˆ¶åŠŸèƒ½æ·»åŠ åˆ°ç¨‹åºä¸­ï¼Œä¸€èˆ¬éƒ½è¦è¿›è¡Œä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol type="1"><li>å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰çš„ç»“æ„ä½“æ¥ç®¡ç†çŠ¶æ€ã€æ ¼å¼ä»¥åŠè·¯å¾„ä¿¡æ¯ç­‰ã€‚</li><li>ç¼–å†™éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°æ¥æ‰§è¡Œå®é™…çš„å½•åˆ¶å·¥ä½œã€‚</li><li>ï¼ˆå¯é€‰ï¼‰ç¼–å†™ä»£ç æ¥ä¸ºéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„å¤§å°ã€‚å¦‚æœä½ å°†è¦å½•åˆ¶çš„æ ¼å¼ä½¿ç”¨äº†magic cookiesï¼Œä½ éœ€è¦ç¼–å†™ç›¸åº”çš„ä»£ç æ¥é…åˆä½¿ç”¨ã€‚</li><li>å¡«å……è‡ªå®šä¹‰ç»“æ„ä½“ä¸­çš„å„ä¸ªå­—æ®µï¼ŒåŒ…æ‹¬æŒ‡å®šéŸ³é¢‘é˜Ÿåˆ—å°†è¦å½•åˆ¶åˆ°çš„æ–‡ä»¶çš„æ•°æ®æµã€æ–‡ä»¶è·¯å¾„ã€‚</li><li>åˆ›å»ºä¸€ä¸ªç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—å¹¶ä¸”è®©éŸ³é¢‘é˜Ÿåˆ—åˆ›å»ºä¸€ç³»åˆ—çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªå°†è¦å†™å…¥çš„æ–‡ä»¶ã€‚</li><li>é€šçŸ¥éŸ³é¢‘é˜Ÿåˆ—å¼€å§‹å½•åˆ¶ã€‚</li><li>å½•åˆ¶å®Œæ¯•ä¹‹åï¼Œé€šçŸ¥éŸ³é¢‘é˜Ÿåˆ—åœæ­¢å½•åˆ¶ï¼Œç„¶åé‡Šæ”¾æ‰å®ƒï¼ŒåŒæ—¶å®ƒä¼šé‡Šæ”¾æ‰å®ƒæ‰€æ‹¥æœ‰çš„ç¼“å†²åŒºã€‚</li></ol><p>æœ¬ç« çš„å‰©ä½™éƒ¨åˆ†å°†è¯¦ç»†æè¿°ä¸Šè¿°çš„æ¯ä¸€ä¸ªæ­¥éª¤ã€‚</p><h2 id="å®šä¹‰ä¸€ä¸ªç®¡ç†çŠ¶æ€çš„ç»“æ„ä½“">å®šä¹‰ä¸€ä¸ªç®¡ç†çŠ¶æ€çš„ç»“æ„ä½“</h2><p>ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æ¥å¼€å‘ä¸€ä¸ªéŸ³é¢‘å½•åˆ¶è§£å†³æ–¹æ¡ˆçš„æ—¶å€™ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ã€‚å°†ä½¿ç”¨è¿™ä¸ªç»“æ„ä½“æ¥ç®¡ç†éŸ³é¢‘æ ¼å¼å’ŒéŸ³é¢‘é˜Ÿåˆ—çŠ¶æ€ä¿¡æ¯ã€‚æ¸…å•2-1å±•ç¤ºäº†è¿™ä¸ªè¿™æ ·çš„ä¸€ä¸ªç»“æ„ä½“ã€‚</p><p><strong>æ¸…å•2-1</strong> ä¸€ä¸ªç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—çš„ç»“æ„ä½“</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kNumberBuffers = <span class="number">3</span>;                            <span class="comment">// 1</span></span><br><span class="line"><span class="keyword">struct</span> AQRecorderState &#123;</span><br><span class="line">    AudioStreamBasicDescription  mDataFormat;                   <span class="comment">// 2</span></span><br><span class="line">    AudioQueueRef                mQueue;                        <span class="comment">// 3</span></span><br><span class="line">    AudioQueueBufferRef          mBuffers[kNumberBuffers];      <span class="comment">// 4</span></span><br><span class="line">    AudioFileID                  mAudioFile;                    <span class="comment">// 5</span></span><br><span class="line">    <span class="built_in">UInt32</span>                       bufferByteSize;                <span class="comment">// 6</span></span><br><span class="line">    SInt64                       mCurrentPacket;                <span class="comment">// 7</span></span><br><span class="line">    <span class="keyword">bool</span>                         mIsRunning;                    <span class="comment">// 8</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¿™ä¸ªç»“æ„ä½“ä¸­æ¯ä¸ªå­—æ®µçš„è¯´æ˜ï¼š</p><ol type="1"><li>è¦ä½¿ç”¨çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„æ•°é‡ã€‚</li><li>ä¸€ä¸ª<code>AudioStreamBasicDescription</code>ç»“æ„ä½“ï¼ˆæ¥è‡ª<code>CoreAudioTypes.h</code>ï¼‰ï¼Œè¡¨ç¤ºå°†è¦å†™å…¥ç£ç›˜çš„éŸ³é¢‘æ•°æ®çš„æ ¼å¼ï¼ŒéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºä½¿ç”¨è¿™ä¸ªæ ¼å¼æ¥æŒ‡å®šå®ƒçš„<code>mQueue</code>å­—æ®µã€‚<code>mDataFormat</code>å­—æ®µæ˜¯ç”±ä½ çš„ç¨‹åºåˆå§‹åŒ–çš„ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW4">Set Up an Audio Format for Recording</a>ã€‚å¯ä»¥é€šè¿‡æŸ¥è¯¢éŸ³é¢‘é˜Ÿåˆ—çš„<code>kAudioQueueProperty_StreamDescription</code>å±æ€§æ¥æ›´æ–°è¿™ä¸ªå­—æ®µçš„å€¼ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW23">Getting the Full Audio Format from an Audio Queue</a>ã€‚åœ¨Mac OS X v10.5ä¸­è¦ä½¿ç”¨<code>kAudioConverterCurrentInputStreamDescription</code>ã€‚ å…³äº<code>AudioStreamBasicDescription</code>ç»“æ„ä½“çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…_<a href="https://developer.apple.com/documentation/coreaudio/core_audio_data_types">Core Audio Data Types Reference</a>_ã€‚</li><li>ç”±ç¨‹åºåˆ›å»ºçš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>ä¸€ä¸ªæŒ‡å‘ç”±éŸ³é¢‘é˜Ÿåˆ—æ‰€ç®¡ç†çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„æŒ‡é’ˆæ•°ç»„ã€‚</li><li>ä¸€ä¸ªè¡¨ç¤ºç¨‹åºå½•åˆ¶éŸ³é¢‘æ—¶å†™å…¥çš„æ–‡ä»¶çš„éŸ³é¢‘æ–‡ä»¶å¯¹è±¡ã€‚</li><li>æ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å­—èŠ‚å¤§å°ã€‚å®ƒçš„å€¼åœ¨éšåçš„ä¾‹å­ä¸­çš„<code>DeriveBufferSize</code>å‡½æ•°ä¸­è®¡ç®—å‡ºæ¥ï¼Œå®ƒåœ¨éŸ³é¢‘é˜Ÿåˆ—åˆ›å»ºåï¼Œå¼€å§‹å½•åˆ¶éŸ³é¢‘å‰è®¡ç®—å‡ºæ¥ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW14">Write a Function to Derive Recording Audio Queue Buffer Size</a>ã€‚</li><li>ä»å½“å‰éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå†™å…¥æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªåŒ…ï¼ˆpacketï¼‰çš„ç´¢å¼•ã€‚</li><li>ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºéŸ³é¢‘é˜Ÿåˆ—æ˜¯å¦åœ¨è¿è¡Œä¸­ã€‚</li></ol><h2 id="ç¼–å†™ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°">ç¼–å†™ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°</h2><p>æ¥ä¸‹æ¥ï¼Œç¼–å†™ä¸€ä¸ªç”¨äºå½•åˆ¶çš„å›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦åšä¸¤ä¸ªäº‹æƒ…ï¼š</p><ul><li>å°†æ–°å¡«å……è¿›éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å†…å®¹å†™å…¥ä½ æ­£åœ¨å½•åˆ¶çš„æ–‡ä»¶ä¸­ã€‚</li><li>å°†åˆšæ‰å·²ç»å°†å†…å®¹å†™å…¥æ–‡ä»¶çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå…¥é˜Ÿåˆ°ç¼“å†²åŒºé˜Ÿåˆ—ã€‚</li></ul><p>ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªå›è°ƒå‡½æ•°å£°æ˜çš„åˆ—å­ï¼Œç„¶ååˆ†åˆ«æè¿°è¿™ä¸¤ä¸ªä»»åŠ¡ï¼Œæœ€åå±•ç¤ºä¸€ä¸ªå®Œæ•´çš„ç”¨äºå½•åˆ¶çš„å›è°ƒå‡½æ•°ã€‚å…³äºç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°æ‰€æ‰®æ¼”çš„è§’è‰²ï¼Œå¯ä»¥å‚è€ƒ<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW2">å›¾1-3</a>ã€‚</p><h3 id="ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°çš„å£°æ˜">ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°çš„å£°æ˜</h3><p>æ¸…å•2-2æ˜¯ä¸€ä¸ªç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°å£°æ˜ï¼Œæ˜¯åœ¨<code>AudioQueue.h</code>ä¸­å£°æ˜çš„<code>AudioQueueInputCallback</code>ï¼š</p><p><strong>æ¸…å•2-2</strong> Â ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°å£°æ˜</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> HandleInputBuffer (</span><br><span class="line">    <span class="keyword">void</span>                                *aqData,             <span class="comment">// 1</span></span><br><span class="line">    AudioQueueRef                       inAQ,                <span class="comment">// 2</span></span><br><span class="line">    AudioQueueBufferRef                 inBuffer,            <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">const</span> AudioTimeStamp                *inStartTime,        <span class="comment">// 4</span></span><br><span class="line">    <span class="built_in">UInt32</span>                              inNumPackets,        <span class="comment">// 5</span></span><br><span class="line">    <span class="keyword">const</span> AudioStreamPacketDescription  *inPacketDesc        <span class="comment">// 6</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>ä¸€èˆ¬æ¥è¯´ï¼Œ<code>aqData</code>æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ï¼ŒåŒ…å«äº†éŸ³é¢‘é˜Ÿåˆ—çš„çŠ¶æ€ä¿¡æ¯ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW15">Define a Custom Structure to Manage State</a>ã€‚</li><li>æ‹¥æœ‰è¯¥å›è°ƒå‡½æ•°çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>åŒ…å«å½•åˆ¶æ•°æ®çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºä¸­ç¬¬ä¸€ä¸ªé‡‡æ ·çš„æ—¶é—´ï¼ˆå¯¹äºç®€å•çš„å½•åˆ¶æ˜¯ä¸éœ€è¦çš„ï¼‰ã€‚</li><li><code>inPacketDesc</code>å­—æ®µä¸­åŒ…æè¿°çš„æ•°é‡ï¼Œå¦‚æœæ˜¯0ï¼Œè¡¨æ˜è¿™æ˜¯ä¸ªCBRæ•°æ®ã€‚</li><li>å¯¹äºå‹ç¼©æ•°æ®æ ¼å¼å¦‚æœéœ€è¦åŒ…æè¿°ï¼ŒåŒ…æè¿°æ˜¯ç”±ç¼–ç å™¨äº§ç”Ÿçš„ã€‚</li></ol><h3 id="å°†éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥ç£ç›˜">å°†éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥ç£ç›˜</h3><p>ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æŠŠéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥ç£ç›˜ã€‚è¿™ä¸ªç¼“å†²åŒºå°±æ˜¯éŸ³é¢‘é˜Ÿåˆ—ä»è¾“å…¥è®¾å¤‡æœ€æ–°è¾“å…¥çš„éŸ³é¢‘æ•°æ®ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°ä½¿ç”¨<code>AudioFile.h</code>ä¸­å£°æ˜çš„<code>AudioFileWritePackets</code>å‡½æ•°ã€‚å¦‚æ¸…å•2-3æ‰€ç¤ºã€‚</p><p><strong>æ¸…å•2-3</strong> å°†éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ•°æ®å†™å…¥ç£ç›˜</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AudioFileWritePackets (                     <span class="comment">// 1</span></span><br><span class="line">    pAqData-&gt;mAudioFile,                    <span class="comment">// 2</span></span><br><span class="line">    <span class="literal">false</span>,                                  <span class="comment">// 3</span></span><br><span class="line">    inBuffer-&gt;mAudioDataByteSize,           <span class="comment">// 4</span></span><br><span class="line">    inPacketDesc,                           <span class="comment">// 5</span></span><br><span class="line">    pAqData-&gt;mCurrentPacket,                <span class="comment">// 6</span></span><br><span class="line">    &amp;inNumPackets,                          <span class="comment">// 7</span></span><br><span class="line">    inBuffer-&gt;mAudioData                    <span class="comment">// 8</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>AudioFileWritePackets</code>å‡½æ•°ï¼ˆåœ¨<code>AudioFile.h</code>å£°æ˜ï¼‰ï¼ŒæŠŠç¼“å†²åŒºçš„å†…å®¹å†™å…¥éŸ³é¢‘æ•°æ®æ–‡ä»¶ä¸­ã€‚</li><li>éŸ³é¢‘æ–‡ä»¶å¯¹è±¡ï¼ˆç±»å‹ä¸º<code>AudioFileID</code>ï¼‰è¡¨ç¤ºè¦å†™åˆ°çš„éŸ³é¢‘æ–‡ä»¶ã€‚<code>pAqData</code>å˜é‡æ˜¯æŒ‡å‘<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW5">æ¸…å•2-1</a>æè¿°çš„æ•°æ®ç»“æ„çš„æŒ‡é’ˆã€‚</li><li>ä½¿ç”¨<code>false</code>å€¼æ¥è¡¨è¾¾å†™å…¥æ˜¯å‡½æ•°ä¸åº”ç¼“å­˜æ•°æ®ã€‚</li><li>æ­£åœ¨å†™å…¥çš„éŸ³é¢‘æ•°æ®çš„å­—èŠ‚æ•°ã€‚<code>inBuffer</code>å˜é‡éŸ³é¢‘é˜Ÿåˆ—ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚</li><li>éŸ³é¢‘æ•°æ®åŒ…æè¿°æ•°ç»„ã€‚<code>NULL</code>å€¼è¡¨ç¤ºä¸éœ€è¦æ•°æ®åŒ…æè¿°ï¼ˆä¾‹å¦‚ï¼ŒCBRéŸ³é¢‘æ•°æ®ï¼‰ã€‚</li><li>è¦å†™å…¥çš„ç¬¬ä¸€ä¸ªæ•°æ®åŒ…çš„ç´¢å¼•ã€‚</li><li>è¾“å…¥æ—¶ï¼Œè¡¨ç¤ºè¦å†™å…¥çš„æ•°æ®åŒ…æ•°é‡ã€‚è¾“å‡ºæ—¶ï¼Œè¡¨ç¤ºå®é™…å†™å…¥çš„æ•°æ®åŒ…æ•°é‡ã€‚</li><li>å°†æ–°çš„éŸ³é¢‘æ•°æ®å†™å…¥éŸ³é¢‘æ–‡ä»¶ã€‚</li></ol><h3 id="æ’é˜ŸéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº">æ’é˜ŸéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº</h3><p>ç°åœ¨ï¼ŒéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„éŸ³é¢‘æ•°æ®å·²ç»è¢«å†™å…¥éŸ³é¢‘æ–‡ä»¶ï¼Œå›è°ƒå¯¹ç¼“å†²åŒºè¿›è¡Œæ’é˜Ÿï¼Œå¦‚æ¸…å•2-4æ‰€ç¤ºã€‚ä¸€æ—¦å›åˆ°ç¼“å†²åŒºé˜Ÿåˆ—ä¸­ï¼Œç¼“å†²åŒºå°±å¤„äºæ’é˜ŸçŠ¶æ€ï¼Œå‡†å¤‡æ¥å—æ›´å¤šä¼ å…¥çš„éŸ³é¢‘æ•°æ®ã€‚</p><p><strong>æ¸…å•2-4</strong> å†™å…¥ç£ç›˜åæ’é˜ŸéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AudioQueueEnqueueBuffer (                    <span class="comment">// 1</span></span><br><span class="line">    pAqData-&gt;mQueue,                         <span class="comment">// 2</span></span><br><span class="line">    inBuffer,                                <span class="comment">// 3</span></span><br><span class="line">    <span class="number">0</span>,                                       <span class="comment">// 4</span></span><br><span class="line">    <span class="literal">NULL</span>                                     <span class="comment">// 5</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>AudioQueueEnqueueBuffer</code>å‡½æ•°æŠŠéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ·»åŠ åˆ°éŸ³é¢‘é˜Ÿåˆ—çš„ç¼“å†²åŒºé˜Ÿåˆ—ä¸­ã€‚</li><li>æŠŠæŒ‡å®šçš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ·»åŠ åˆ°éŸ³é¢‘é˜Ÿåˆ—ã€‚<code>pAqData</code>å˜é‡æŒ‡å‘æ¸…å•2-1æè¿°çš„æ•°æ®ç»“æ„æŒ‡é’ˆã€‚</li><li>è¦æ’é˜Ÿçš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ•°æ®ä¸­çš„æ•°æ®åŒ…æè¿°æ•°é‡ã€‚è®¾ä¸º<code>0</code>ï¼Œå› ä¸ºè¯¥å‚æ•°æœªç”¨äºå½•åˆ¶ã€‚</li><li>æ•°æ®åŒ…æè¿°æ•°ç»„ï¼Œæè¿°éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„æ•°æ®ã€‚è®¾ä¸º<code>NULL</code>ï¼Œå› ä¸ºè¯¥å‚æ•°æœªç”¨äºå½•åˆ¶ã€‚</li></ol><h3 id="ä¸€ä¸ªå®Œæ•´çš„éŸ³é¢‘å½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°">ä¸€ä¸ªå®Œæ•´çš„éŸ³é¢‘å½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°</h3><p>æ¸…å•2-5å±•ç¤ºäº†å®Œæ•´çš„éŸ³é¢‘å½•åˆ¶ä¸­éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°çš„åŸºæœ¬å½¢å¼ã€‚ä¸æœ¬æ–‡æ¡£çš„å…¶ä»–ä»£ç ä¸€æ ·ï¼Œè¯¥æ¸…å•ä¸åŒ…æ‹¬é”™è¯¯å¤„ç†ã€‚</p><p><strong>æ¸…å•2-5</strong>Â ä¸€ä¸ªéŸ³é¢‘å½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> HandleInputBuffer (</span><br><span class="line">    <span class="keyword">void</span>                                 *aqData,</span><br><span class="line">    AudioQueueRef                        inAQ,</span><br><span class="line">    AudioQueueBufferRef                  inBuffer,</span><br><span class="line">    <span class="keyword">const</span> AudioTimeStamp                 *inStartTime,</span><br><span class="line">    <span class="built_in">UInt32</span>                               inNumPackets,</span><br><span class="line">    <span class="keyword">const</span> AudioStreamPacketDescription   *inPacketDesc</span><br><span class="line">) &#123;</span><br><span class="line">    AQRecorderState *pAqData = (AQRecorderState *) aqData;               <span class="comment">// 1</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (inNumPackets == <span class="number">0</span> &amp;&amp;                                             <span class="comment">// 2</span></span><br><span class="line">          pAqData-&gt;mDataFormat.mBytesPerPacket != <span class="number">0</span>)</span><br><span class="line">       inNumPackets =</span><br><span class="line">           inBuffer-&gt;mAudioDataByteSize / pAqData-&gt;mDataFormat.mBytesPerPacket;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (AudioFileWritePackets (                                          <span class="comment">// 3</span></span><br><span class="line">            pAqData-&gt;mAudioFile,</span><br><span class="line">            <span class="literal">false</span>,</span><br><span class="line">            inBuffer-&gt;mAudioDataByteSize,</span><br><span class="line">            inPacketDesc,</span><br><span class="line">            pAqData-&gt;mCurrentPacket,</span><br><span class="line">            &amp;inNumPackets,</span><br><span class="line">            inBuffer-&gt;mAudioData</span><br><span class="line">        ) == noErr) &#123;</span><br><span class="line">            pAqData-&gt;mCurrentPacket += inNumPackets;                     <span class="comment">// 4</span></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">if</span> (pAqData-&gt;mIsRunning == <span class="number">0</span>)                                         <span class="comment">// 5</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">    AudioQueueEnqueueBuffer (                                            <span class="comment">// 6</span></span><br><span class="line">        pAqData-&gt;mQueue,</span><br><span class="line">        inBuffer,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>å®ä¾‹åŒ–æ—¶æä¾›ç»™éŸ³é¢‘é˜Ÿåˆ—å¯¹è±¡çš„ç»“æ„ä½“ï¼ŒåŒ…å«ä»£è¡¨è¦è®°å½•åˆ°å…¶ä¸­çš„éŸ³é¢‘æ–‡ä»¶çš„å¯¹è±¡ï¼Œä»¥åŠå„ç§çŠ¶æ€æ•°æ®ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW15">Define a Custom Structure to Manage State</a>ã€‚</li><li>å¦‚æœéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºåŒ…å«CBRæ•°æ®ï¼Œåˆ™éœ€è¦è®¡ç®—ç¼“å†²åŒºçš„æ•°æ®åŒ…æ•°é‡ã€‚è¯¥æ•°å€¼ç­‰äºç¼“å†²åŒºä¸­æ•°æ®çš„æ€»å­—èŠ‚é™¤ä»¥æ¯ä¸ªæ•°æ®åŒ…å›ºå®šçš„å­—èŠ‚æ•°ã€‚å¯¹äºVBRæ•°æ®ï¼ŒéŸ³é¢‘é˜Ÿåˆ—åœ¨è°ƒç”¨å›è°ƒæ—¶ä¼šæä¾›ç¼“å†²åŒºä¸­çš„æ•°æ®åŒ…æ•°é‡ã€‚</li><li>æŠŠç¼“å†²åŒºçš„å†…å®¹å†™å…¥åˆ°éŸ³é¢‘æ•°æ®æ–‡ä»¶ä¸­ã€‚æœ‰å…³è¯¦ç»†çš„è¯´æ˜ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW3">Writing an Audio Queue Buffer to Disk</a>ã€‚</li><li>å¦‚æœæˆåŠŸå†™å…¥éŸ³é¢‘æ•°æ®ï¼Œéœ€è¦å¢åŠ éŸ³é¢‘æ•°æ®æ–‡ä»¶çš„æ•°æ®åŒ…ç´¢å¼•ï¼Œä»¥å‡†å¤‡å†™å…¥ä¸‹ä¸€ä¸ªç¼“å†²åŒºçš„éŸ³é¢‘æ•°æ®ã€‚</li><li>å¦‚æœéŸ³é¢‘é˜Ÿåˆ—å·²åœæ­¢ï¼Œåˆ™è¿”å›ã€‚</li><li>å…¥é˜Ÿè¯¥å†™å…¥éŸ³é¢‘æ–‡ä»¶çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚æœ‰å…³è¯¦ç»†çš„è¯´æ˜ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW8">Enqueuing an Audio Queue Buffer</a>ã€‚</li></ol><h2 id="ç¼–å†™å‡½æ•°è®¡ç®—ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°">ç¼–å†™å‡½æ•°è®¡ç®—ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°</h2><p>éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡å¸Œæœ›ç¨‹åºä¸ºä½¿ç”¨çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæŒ‡å®šå¤§å°ã€‚æ¸…å•2-6å±•ç¤ºäº†ä¸€ç§æ‰§è¡Œè¯¥æ“ä½œçš„æ–¹æ³•ã€‚å®ƒå¾—å‡ºçš„ç¼“å†²åŒºå¤§å°è¶³ä»¥å®¹çº³ç»™å®šçš„éŸ³é¢‘æ—¶é•¿ã€‚</p><p>è¯¥è®¡ç®—è€ƒè™‘äº†è¦å½•åˆ¶åˆ°çš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚è¯¥æ ¼å¼åŒ…å«å¯èƒ½å½±å“ç¼“å†²åŒºå¤§å°çš„æ‰€æœ‰å› ç´ ï¼Œä¾‹å¦‚éŸ³é¢‘é€šé“çš„æ•°é‡ã€‚</p><p><strong>æ¸…å•2-6</strong> å¾—å‡ºéŸ³é¢‘å½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å¤§å°</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> DeriveBufferSize (</span><br><span class="line">    AudioQueueRef                audioQueue,                  <span class="comment">// 1</span></span><br><span class="line">    AudioStreamBasicDescription  &amp;ASBDescription,             <span class="comment">// 2</span></span><br><span class="line">    Float64                      seconds,                     <span class="comment">// 3</span></span><br><span class="line">    <span class="built_in">UInt32</span>                       *outBufferSize               <span class="comment">// 4</span></span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> maxBufferSize = <span class="number">0x50000</span>;                 <span class="comment">// 5</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> maxPacketSize = ASBDescription.mBytesPerPacket;       <span class="comment">// 6</span></span><br><span class="line">    <span class="keyword">if</span> (maxPacketSize == <span class="number">0</span>) &#123;                                 <span class="comment">// 7</span></span><br><span class="line">        <span class="built_in">UInt32</span> maxVBRPacketSize = <span class="keyword">sizeof</span>(maxPacketSize);</span><br><span class="line">        AudioQueueGetProperty (</span><br><span class="line">                audioQueue,</span><br><span class="line">                kAudioQueueProperty_MaximumOutputPacketSize,</span><br><span class="line">                <span class="comment">// in Mac OS X v10.5, instead use</span></span><br><span class="line">                <span class="comment">//   kAudioConverterPropertyMaximumOutputPacketSize</span></span><br><span class="line">                &amp;maxPacketSize,</span><br><span class="line">                &amp;maxVBRPacketSize</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    Float64 numBytesForTime =</span><br><span class="line">        ASBDescription.mSampleRate * maxPacketSize * seconds; <span class="comment">// 8</span></span><br><span class="line">    *outBufferSize =</span><br><span class="line">    <span class="built_in">UInt32</span> (numBytesForTime &lt; maxBufferSize ?</span><br><span class="line">        numBytesForTime : maxBufferSize);                     <span class="comment">// 9</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>é…ç½®ç¼“å†²åŒºå¤§å°çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—çš„<code>AudioStreamBasicDescription</code>ç»“æ„ä½“ã€‚</li><li>ä¸ºæ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæŒ‡å®šçš„å¤§å°ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œæ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°ä¸Šé™ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œä¸Šé™è®¾ä¸º320 KBã€‚è¿™ç›¸å½“äºä»¥96 kHzçš„é‡‡æ ·ç‡é‡‡é›†5ç§’çš„24ä½ç«‹ä½“å£°éŸ³é¢‘ã€‚</li><li>å¯¹äºCBRéŸ³é¢‘æ•°æ®ï¼Œåˆ™ä»<code>AudioStreamBasicDescription</code>ç»“æ„ä½“ä¸­è·å–å›ºå®šçš„æ•°æ®åŒ…å¤§å°ã€‚ä½¿ç”¨è¯¥å€¼ä½œä¸ºæœ€å¤§æ•°æ®åŒ…å¤§å°ã€‚ è¯¥èµ‹å€¼ä¼šæœ‰å‰¯ä½œç”¨ï¼Œè¿™å–å†³äºè¦å½•åˆ¶çš„éŸ³é¢‘æ•°æ®æ—¶CBRè¿˜æ˜¯VBRã€‚å¦‚æœæ˜¯VBRï¼Œåˆ™éŸ³é¢‘é˜Ÿåˆ—çš„<code>AudioStreamBasicDescription</code>ä¼šæŠŠbytes-per-packetè®¾ä¸º<code>0</code>ã€‚</li><li>å¯¹äºVBRéŸ³é¢‘æ•°æ®ï¼ŒæŸ¥è¯¢éŸ³é¢‘é˜Ÿåˆ—ä»¥è·å–æœ€å¤§çš„æ•°æ®åŒ…ä¼°ç®—å¤§å°ã€‚</li><li>å¾—å‡ºç¼“å†²åŒºå¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li>å¦‚æœéœ€è¦ï¼ŒæŠŠç¼“å†²åŒºå¤§å°é™åˆ¶ä¸ºä¹‹å‰è®¾ç½®çš„ä¸Šé™ã€‚</li></ol><h2 id="è®¾ç½®éŸ³é¢‘æ–‡ä»¶magic-cookie">è®¾ç½®éŸ³é¢‘æ–‡ä»¶Magic Cookie</h2><p>æŸäº›å‹ç¼©çš„éŸ³é¢‘æ ¼å¼ï¼ˆä¾‹å¦‚MPEG 4 AACï¼‰ï¼Œåˆ©ç”¨ç»“æ„ä½“åŒ…å«éŸ³é¢‘å…ƒæ•°æ®ã€‚è¿™äº›ç»“æ„ä½“ç§°ä¸º<strong>magic cookies</strong>ã€‚ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡ä»¥è¿™ç§æ ¼å¼å½•åˆ¶æ—¶ï¼Œå¿…é¡»å…ˆä»éŸ³é¢‘é˜Ÿåˆ—ä¸­è·å–magic cookieï¼Œç„¶åå†å°†å…¶æ·»åŠ åˆ°éŸ³é¢‘æ–‡ä»¶ä¸­ï¼Œç„¶åå¼€å§‹å½•åˆ¶ã€‚</p><p>æ¸…å•2-7å±•ç¤ºäº†å¦‚ä½•ä»éŸ³é¢‘é˜Ÿåˆ—ä¸­è·å–magic cookieï¼Œå¹¶å°†å…¶åº”ç”¨äºéŸ³é¢‘æ–‡ä»¶ä¸­ã€‚ä»£ç ä¼šåœ¨å½•åˆ¶ä¹‹å‰è°ƒç”¨è¯¥å‡½æ•°ï¼Œç„¶ååœ¨å½•åˆ¶åå†æ¬¡è°ƒç”¨ï¼Œå› ä¸ºæŸäº›ç¼–è§£ç å™¨ä¼šåœ¨å½•åˆ¶åœæ­¢æ—¶æ›´æ–°magic cookieæ•°æ®ã€‚</p><p><strong>æ¸…å•2-7</strong> ç»™éŸ³é¢‘æ–‡ä»¶è®¾ç½®magic cookie</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">OSStatus SetMagicCookieForFile (</span><br><span class="line">    AudioQueueRef inQueue,                                      <span class="comment">// 1</span></span><br><span class="line">    AudioFileID   inFile                                        <span class="comment">// 2</span></span><br><span class="line">) &#123;</span><br><span class="line">    OSStatus result = noErr;                                    <span class="comment">// 3</span></span><br><span class="line">    <span class="built_in">UInt32</span> cookieSize;                                          <span class="comment">// 4</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">            AudioQueueGetPropertySize (                         <span class="comment">// 5</span></span><br><span class="line">                inQueue,</span><br><span class="line">                kAudioQueueProperty_MagicCookie,</span><br><span class="line">                &amp;cookieSize</span><br><span class="line">            ) == noErr</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">char</span>* magicCookie =</span><br><span class="line">            (<span class="keyword">char</span> *) malloc (cookieSize);                       <span class="comment">// 6</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">                AudioQueueGetProperty (                         <span class="comment">// 7</span></span><br><span class="line">                    inQueue,</span><br><span class="line">                    kAudioQueueProperty_MagicCookie,</span><br><span class="line">                    magicCookie,</span><br><span class="line">                    &amp;cookieSize</span><br><span class="line">                ) == noErr</span><br><span class="line">        )</span><br><span class="line">            result =    AudioFileSetProperty (                  <span class="comment">// 8</span></span><br><span class="line">                            inFile,</span><br><span class="line">                            kAudioFilePropertyMagicCookieData,</span><br><span class="line">                            cookieSize,</span><br><span class="line">                            magicCookie</span><br><span class="line">                        );</span><br><span class="line">        free (magicCookie);                                     <span class="comment">// 9</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;                                              <span class="comment">// 10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>å½•åˆ¶åˆ°çš„éŸ³é¢‘æ–‡ä»¶ã€‚</li><li>ç»“æœå˜é‡ï¼Œè¡¨è¾¾è¯¥å‡½æ•°æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚</li><li>ç”¨äºä¿å­˜magic cookieæ•°æ®å¤§å°çš„å˜é‡ã€‚</li><li>ä»éŸ³é¢‘é˜Ÿåˆ—è·å–magic cookieæ•°æ®å¤§å°ï¼Œå¹¶å­˜å‚¨åœ¨<code>cookieSize</code>å˜é‡ä¸­ã€‚</li><li>åˆ†é…ä¸€ä¸ªå­—èŠ‚æ•°æ®æ¥ä¿å­˜magic cookieä¿¡æ¯ã€‚</li><li>é€šè¿‡æŸ¥è¯¢éŸ³é¢‘é˜Ÿåˆ—çš„<code>kAudioQueueProperty_MagicCookie</code>å±æ€§è·å–magic cookieã€‚</li><li>è®¾ç½®å½•åˆ¶åˆ°çš„éŸ³é¢‘æ–‡ä»¶çš„magic cookieã€‚<code>AudioFileSetProperty</code>å‡½æ•°åœ¨<code>AudioFile.h</code>å¤´æ–‡ä»¶ä¸­å£°æ˜ã€‚</li><li>é‡Šæ”¾ä¸´æ—¶magic cookieå˜é‡çš„å†…å­˜ã€‚</li><li>è¿”å›è¯¥å‡½æ•°çš„æˆåŠŸæˆ–å¤±è´¥çŠ¶æ€ã€‚</li></ol><h2 id="è®¾ç½®éŸ³é¢‘æ ¼å¼è¿›è¡Œå½•åˆ¶">è®¾ç½®éŸ³é¢‘æ ¼å¼è¿›è¡Œå½•åˆ¶</h2><p>æœ¬èŠ‚ä»‹ç»å¦‚ä½•ä¸ºéŸ³é¢‘é˜Ÿåˆ—è®¾ç½®éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚éŸ³é¢‘é˜Ÿåˆ—ä½¿ç”¨è¯¥æ ¼å¼è®°å½•åˆ°æ–‡ä»¶ã€‚</p><p>è¦è®¾ç½®éŸ³é¢‘æ•°æ®æ ¼å¼ï¼Œéœ€è¦æŒ‡å®šï¼š</p><ul><li>éŸ³é¢‘æ•°æ®æ ¼å¼ç±»å‹ï¼ˆå¦‚çº¿æ€§PCMã€AACç­‰ï¼‰</li><li>é‡‡æ ·ç‡ï¼ˆå¦‚44.1 kHzï¼‰</li><li>éŸ³é¢‘é€šé“æ•°ï¼ˆå¦‚2ï¼Œç«‹ä½“å£°ï¼‰</li><li>ä½æ·±ï¼ˆå¦‚16ä½ï¼‰</li><li>æ¯æ•°æ®åŒ…å¸§æ•°é‡ï¼ˆå¦‚çº¿æ€§PCMï¼Œæ¯åŒ…ä¸€å¸§ï¼‰</li><li>éŸ³é¢‘æ–‡ä»¶ç±»å‹ï¼ˆå¦‚CAFã€AIFFç­‰ï¼‰</li><li>æ–‡ä»¶ç±»å‹æ‰€éœ€çš„éŸ³é¢‘æ•°æ®æ ¼å¼çš„è¯¦ç»†ä¿¡æ¯</li></ul><p>æ¸…å•2-8å†™æ­»äº†ç”¨æ¥å½•åˆ¶çš„éŸ³é¢‘æ ¼å¼çš„æ¯ä¸ªå±æ€§å€¼ã€‚åœ¨ç”Ÿäº§ä»£ç ä¸­ï¼Œé€šå¸¸å…è®¸ç”¨æˆ·éƒ¨åˆ†æˆ–å…¨éƒ¨æŒ‡å®šéŸ³é¢‘æ ¼å¼ã€‚æ— è®ºé‡‡ç”¨å“ªç§æ–¹å¼ï¼Œç›®æ ‡éƒ½æ˜¯å¡«å……<code>AQRecorderState</code>è‡ªå®šä¹‰ç»“æ„ä½“çš„<code>mDataFormat</code>å­—æ®µï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW15">Define a Custom Structure to Manage State</a>ä¸­çš„è‡ªå®šä¹‰ç»“æ„ä½“ã€‚</p><p><strong>æ¸…å•2-8</strong> æŒ‡å®šéŸ³é¢‘é˜Ÿåˆ—çš„éŸ³é¢‘æ•°æ®æ ¼å¼</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">AQRecorderState aqData;                                       <span class="comment">// 1</span></span><br><span class="line"> </span><br><span class="line">aqData.mDataFormat.mFormatID         = kAudioFormatLinearPCM; <span class="comment">// 2</span></span><br><span class="line">aqData.mDataFormat.mSampleRate       = <span class="number">44100.0</span>;               <span class="comment">// 3</span></span><br><span class="line">aqData.mDataFormat.mChannelsPerFrame = <span class="number">2</span>;                     <span class="comment">// 4</span></span><br><span class="line">aqData.mDataFormat.mBitsPerChannel   = <span class="number">16</span>;                    <span class="comment">// 5</span></span><br><span class="line">aqData.mDataFormat.mBytesPerPacket   =                        <span class="comment">// 6</span></span><br><span class="line">   aqData.mDataFormat.mBytesPerFrame =</span><br><span class="line">      aqData.mDataFormat.mChannelsPerFrame * <span class="keyword">sizeof</span> (SInt16);</span><br><span class="line">aqData.mDataFormat.mFramesPerPacket  = <span class="number">1</span>;                     <span class="comment">// 7</span></span><br><span class="line"> </span><br><span class="line">AudioFileTypeID fileType             = kAudioFileAIFFType;    <span class="comment">// 8</span></span><br><span class="line">aqData.mDataFormat.mFormatFlags =                             <span class="comment">// 9</span></span><br><span class="line">    kLinearPCMFormatFlagIsBigEndian</span><br><span class="line">    | kLinearPCMFormatFlagIsSignedInteger</span><br><span class="line">    | kLinearPCMFormatFlagIsPacked;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>åˆ›å»º<code>AQRecorderState</code>ç»“æ„ä½“å®ä¾‹ã€‚ç»“æ„ä½“çš„<code>mDataFormat</code>å­—æ®µåŒ…å«ä¸€ä¸ª<code>AudioStreamBasicDescription</code>ç»“æ„ä½“ã€‚åœ¨<code>mDataFormat</code>å­—æ®µä¸­è®¾ç½®çš„å€¼æä¾›äº†éŸ³é¢‘é˜Ÿåˆ—çš„åˆå§‹éŸ³é¢‘æ ¼å¼ï¼Œè¿™ä¹Ÿæ˜¯è®°å½•åˆ°æ–‡ä»¶çš„éŸ³é¢‘æ ¼å¼ã€‚åœ¨<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW9">æ¸…å•2-10</a>ä¸­ï¼Œä½ å¯ä»¥è·å¾—éŸ³é¢‘æ ¼å¼çš„å®Œæ•´è§„èŒƒï¼ŒCore Audioæ ¹æ®æ ¼å¼ç±»å‹å’Œæ–‡ä»¶ç±»å‹æä¾›äº†ç›¸å…³è§„èŒƒã€‚</li><li>æŠŠéŸ³é¢‘æ•°æ®æ ¼å¼ç±»å‹å®šä¹‰ä¸ºçº¿æ€§PCMã€‚æœ‰å…³å¯ç”¨æ•°æ®æ ¼å¼çš„å®Œæ•´åˆ—è¡¨ï¼Œå¯å‚é˜…_<a href="https://developer.apple.com/documentation/coreaudio/core_audio_data_types">Core Audio Data Types Reference</a>_ã€‚</li><li>æŠŠé‡‡æ ·ç‡è®¾ä¸º44.1 kHzã€‚</li><li>é€šé“æ•°è®¾ä¸º2ã€‚</li><li>æ¯ä¸ªé€šé“ä½æ·±è®¾ä¸º16ã€‚</li><li>æ¯ä¸ªæ•°æ®åŒ…å­—èŠ‚æ•°å’Œæ¯å¸§å­—èŠ‚æ•°è®¾ä¸º4ï¼ˆå³2ä¸ªé€šé“ä¹˜ä»¥æ¯ä¸ªæ ·æœ¬2ä¸ªå­—èŠ‚ï¼‰ã€‚</li><li>æ¯ä¸ªæ•°æ®åŒ…å¸§æ•°é‡è®¾ä¸º1ã€‚</li><li>æ–‡ä»¶ç±»å‹è®¾ä¸ºAIFFã€‚å‚é˜…<code>AudioFile.h</code>å¤´æ–‡ä»¶çš„ç±»å‹ï¼Œå¯è·å¾—å¯ç”¨ç±»å‹çš„å®Œæ•´åˆ—è¡¨ã€‚å¯ä»¥æŒ‡å®šä»»æ„å·²å®‰è£…çš„è§£ç å™¨çš„æ–‡ä»¶ç±»å‹ï¼Œå¦‚<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW14">Using Codecs and Audio Data Formats</a>æ‰€è¿°ã€‚</li><li>è®¾ç½®æŒ‡å®šæ–‡ä»¶ç±»å‹æ‰€éœ€çš„æ ¼å¼æ ‡å¿—ã€‚</li></ol><h2 id="åˆ›å»ºä¸€ä¸ªå½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—">åˆ›å»ºä¸€ä¸ªå½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—</h2><p>ç°åœ¨ï¼Œåœ¨è®¾ç½®äº†å½•åˆ¶é»‘ç™½ä½ å‡½æ•°å’ŒéŸ³é¢‘æ•°æ®æ ¼å¼ä¹‹åï¼Œåˆ›å»ºå’Œé…ç½®ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</p><h3 id="åˆ›å»ºå½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—">åˆ›å»ºå½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—</h3><p>æ¸…å•2-9å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºå½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—ã€‚æ³¨æ„ï¼Œ<code>AudioQueueNewInput</code>å‡½æ•°ä½¿ç”¨åœ¨ä¹‹å‰æ­¥éª¤ä¸­é…ç½®çš„å›è°ƒå‡½æ•°ã€è‡ªå®šä¹‰ç»“æ„ä½“å’ŒéŸ³é¢‘æ•°æ®æ ¼å¼ã€‚</p><p><strong>æ¸…å•2-9</strong> åˆ›å»ºå½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AudioQueueNewInput (                              <span class="comment">// 1</span></span><br><span class="line">    &amp;aqData.mDataFormat,                          <span class="comment">// 2</span></span><br><span class="line">    HandleInputBuffer,                            <span class="comment">// 3</span></span><br><span class="line">    &amp;aqData,                                      <span class="comment">// 4</span></span><br><span class="line">    <span class="literal">NULL</span>,                                         <span class="comment">// 5</span></span><br><span class="line">    kCFRunLoopCommonModes,                        <span class="comment">// 6</span></span><br><span class="line">    <span class="number">0</span>,                                            <span class="comment">// 7</span></span><br><span class="line">    &amp;aqData.mQueue                                <span class="comment">// 8</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>AudioQueueNewInput</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„å½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>å½•åˆ¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW4">Set Up an Audio Format for Recording</a>ã€‚</li><li>äºå½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨çš„å›è°ƒå‡½æ•°ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW24">Write a Recording Audio Queue Callback</a>ã€‚</li><li>å½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—çš„è‡ªå®šä¹‰æ•°æ®ç»“æ„ä½“ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW15">Define a Custom Structure to Manage State</a>ã€‚</li><li>è°ƒç”¨å›è°ƒå‡½æ•°çš„run loopã€‚ä½¿ç”¨<code>NULL</code>æŒ‡å®šé»˜è®¤è¡Œä¸ºï¼Œå›è°ƒå‡½æ•°å°†åœ¨å†…éƒ¨çš„éŸ³é¢‘é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹æ‰§è¡Œã€‚è¿™æ—¶å…¸å‹çš„ç”¨æ³•ï¼Œå…è®¸éŸ³é¢‘é˜Ÿåˆ—åœ¨ç¨‹åºçš„ç”¨æˆ·ç•Œé¢çº¿ç¨‹ç­‰å¾…ç”¨æˆ·åœæ­¢å½•åˆ¶çš„åŒæ—¶è¿›è¡Œå½•åˆ¶ã€‚</li><li>run loopæ¨¡å¼ã€‚é€šå¸¸ä½¿ç”¨<code>kCFRunLoopCommonModes</code>ã€‚</li><li>ä¿ç•™å‚æ•°ï¼Œå¿…é¡»ä¸º<code>0</code>ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œæ–°åˆ†é…çš„å½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—ã€‚</li></ol><h3 id="ä»éŸ³é¢‘é˜Ÿåˆ—è·å–å®Œæ•´çš„éŸ³é¢‘æ ¼å¼">ä»éŸ³é¢‘é˜Ÿåˆ—è·å–å®Œæ•´çš„éŸ³é¢‘æ ¼å¼</h3><p>å½“éŸ³é¢‘é˜Ÿåˆ—åˆ›å»ºåï¼ˆå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW25">Creating a Recording Audio Queue</a>ï¼‰ï¼Œ<code>AudioStreamBasicDescription</code>å¯èƒ½æ¯”ä½ å¡«å†™çš„æ›´å®Œæ•´ï¼Œå°¤å…¶æ˜¯å‹ç¼©æ ¼å¼ã€‚è¦è·å–å®Œæ•´çš„æ ¼å¼æè¿°ï¼Œè°ƒç”¨æ¸…å•2-10çš„<code>AudioQueueGetProperty</code>å‡½æ•°ã€‚åˆ›å»ºè¦å½•åˆ¶åˆ°çš„éŸ³é¢‘æ–‡ä»¶æ—¶ï¼Œéœ€ä½¿ç”¨å®Œæ•´çš„éŸ³é¢‘æ ¼å¼ï¼ˆå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW26">Create an Audio File</a>ï¼‰ã€‚</p><p><strong>æ¸…å•2-10</strong> ä»éŸ³é¢‘é˜Ÿåˆ—è·å–éŸ³é¢‘æ ¼å¼</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UInt32</span> dataFormatSize = <span class="keyword">sizeof</span> (aqData.mDataFormat);       <span class="comment">// 1</span></span><br><span class="line"> </span><br><span class="line">AudioQueueGetProperty (                                    <span class="comment">// 2</span></span><br><span class="line">    aqData.mQueue,                                         <span class="comment">// 3</span></span><br><span class="line">    kAudioQueueProperty_StreamDescription,                 <span class="comment">// 4</span></span><br><span class="line">    <span class="comment">// in Mac OS X, instead use</span></span><br><span class="line">    <span class="comment">//    kAudioConverterCurrentInputStreamDescription</span></span><br><span class="line">    &amp;aqData.mDataFormat,                                   <span class="comment">// 5</span></span><br><span class="line">    &amp;dataFormatSize                                        <span class="comment">// 6</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>è·å–åœ¨æŸ¥è¯¢éŸ³é¢‘é˜Ÿåˆ—æœ‰å…³å…¶éŸ³é¢‘æ•°æ®æ ¼å¼æ—¶è¦ä½¿ç”¨çš„é¢„æœŸå±æ€§å€¼å¤§å°ã€‚</li><li><code>AudioQueueGetProperty</code>å‡½æ•°è·å–éŸ³é¢‘é˜Ÿåˆ—ä¸­æŒ‡å®šå±æ€§çš„å€¼ã€‚</li><li>ç”¨äºè·å–éŸ³é¢‘æ•°æ®æ ¼å¼çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>ç”¨äºè·å–éŸ³é¢‘é˜Ÿåˆ—çš„æ•°æ®æ ¼å¼å€¼çš„å±æ€§IDã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œä»éŸ³é¢‘é˜Ÿåˆ—è·å¾—çš„<code>AudioStreamBasicDescription</code>ç»“æ„ä½“å½¢å¼çš„å®Œæ•´éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚</li><li>è¾“å…¥æ—¶ï¼Œæ˜¯<code>AudioStreamBasicDescription</code>çš„é¢„æœŸå¤§å°ã€‚è¾“å‡ºæ—¶ï¼Œæ˜¯å…¶å®é™…å¤§å°ã€‚åœ¨å½•åˆ¶ç¨‹åºä¸­ä¸éœ€è¦ä½¿ç”¨è¯¥å€¼ã€‚</li></ol><h2 id="åˆ›å»ºéŸ³é¢‘æ–‡ä»¶">åˆ›å»ºéŸ³é¢‘æ–‡ä»¶</h2><p>åˆ›å»ºå¹¶é…ç½®éŸ³é¢‘é˜Ÿåˆ—åï¼Œå°†åˆ›å»ºä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼ŒæŠŠéŸ³é¢‘æ•°æ®è®°å½•åˆ°éŸ³é¢‘æ–‡ä»¶ä¸­ï¼Œå¦‚æ¸…å•2-11æ‰€ç¤ºã€‚éŸ³é¢‘æ–‡ä»¶ä½¿ç”¨ä¹‹å‰å­˜å‚¨åœ¨éŸ³é¢‘é˜Ÿåˆ—çš„è‡ªå®šä¹‰ç»“æ„ä½“ä¸­çš„æ•°æ®æ ¼å¼å’Œæ–‡ä»¶æ ¼å¼è§„èŒƒã€‚</p><p><strong>æ¸…å•2-11</strong> åˆ›å»ºä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶è¿›è¡Œå½•åˆ¶</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFURLRef</span> audioFileURL =</span><br><span class="line">    <span class="built_in">CFURLCreateFromFileSystemRepresentation</span> (            <span class="comment">// 1</span></span><br><span class="line">        <span class="literal">NULL</span>,                                            <span class="comment">// 2</span></span><br><span class="line">        (<span class="keyword">const</span> <span class="built_in">UInt8</span> *) filePath,                        <span class="comment">// 3</span></span><br><span class="line">        strlen (filePath),                               <span class="comment">// 4</span></span><br><span class="line">        <span class="literal">false</span>                                            <span class="comment">// 5</span></span><br><span class="line">    );</span><br><span class="line"> </span><br><span class="line">AudioFileCreateWithURL (                                 <span class="comment">// 6</span></span><br><span class="line">    audioFileURL,                                        <span class="comment">// 7</span></span><br><span class="line">    fileType,                                            <span class="comment">// 8</span></span><br><span class="line">    &amp;aqData.mDataFormat,                                 <span class="comment">// 9</span></span><br><span class="line">    kAudioFileFlags_EraseFile,                           <span class="comment">// 10</span></span><br><span class="line">    &amp;aqData.mAudioFile                                   <span class="comment">// 11</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>CFURLCreateFromFileSystemRepresentation</code>å‡½æ•°ï¼ˆåœ¨<code>CFURL.h</code>å¤´æ–‡ä»¶ä¸­å£°æ˜ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªCFURLå¯¹è±¡ï¼Œè¯¥å¯¹è±¡è¡¨ç¤ºè¦å½•åˆ¶åˆ°å…¶ä¸­çš„æ–‡ä»¶ã€‚</li><li>ä½¿ç”¨<code>NULL</code>æˆ–<code>kCFAllocatorDefault</code>ï¼Œä½¿ç”¨å½“å‰é»˜è®¤çš„å†…å­˜åˆ†é…å™¨ã€‚</li><li>æƒ³è¦è½¬æ¢ä¸ºCFURLçš„æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ã€‚åœ¨ç”Ÿäº§ä»£ç ä¸­ï¼Œé€šå¸¸ä¼šä»ç”¨æˆ·è·å–<code>filePath</code>å€¼ã€‚</li><li>æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ä¸­çš„å­—èŠ‚æ•°ã€‚</li><li><code>false</code>å€¼è¡¨ç¤º<code>filePath</code>ä»£è¡¨æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç›®å½•ã€‚</li><li><code>AudioFileCreateWithURL</code>å‡½æ•°ï¼ˆæ¥è‡ª<code>AudioFile.h</code>å¤´æ–‡ä»¶ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„éŸ³é¢‘æ–‡ä»¶ï¼Œæˆ–åˆå§‹åŒ–ä¸€ä¸ªç°æœ‰æ–‡ä»¶ã€‚</li><li>ç”¨äºåˆ›å»ºæ–°çš„éŸ³é¢‘æ–‡ä»¶æˆ–ä½¿ç”¨ç°åœ¨æ–‡ä»¶è¿›è¡Œåˆå§‹åŒ–çš„URLã€‚è¯¥URLæ˜¯ä»ç¬¬ä¸€æ­¥<code>CFURLCreateFromFileSystemRepresentation</code>è·å¾—çš„ã€‚</li><li>æ–°æ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ã€‚åœ¨æœ¬ç« çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œä¹‹å‰å·²é€šè¿‡<code>kAudioFileAIFFType</code>è®¾ç½®ä¸ºAIFFç±»å‹ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW4">Set Up an Audio Format for Recording</a>ã€‚</li><li>å°†è®°å½•åˆ°æ–‡ä»¶ä¸­çš„éŸ³é¢‘æ•°æ®æ ¼å¼ï¼ŒæŒ‡å®šä¸º<code>AudioStreamBasicDescription</code>ç»“æ„ä½“ã€‚åœ¨æœ¬ç« çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œä¹Ÿå·²åœ¨â€œ<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW4">Set Up an Audio Format for Recording</a>â€ä¸­è¿›è¡Œäº†è®¾ç½®ã€‚</li><li>å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™åˆ é™¤è¯¥æ–‡ä»¶ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼ŒéŸ³é¢‘æ–‡ä»¶å¯¹è±¡ï¼ˆ<code>AudioFileID</code>ç±»å‹ï¼‰è¡¨ç¤ºè¦å½•åˆ¶åˆ°çš„éŸ³é¢‘æ–‡ä»¶ã€‚</li></ol><h2 id="è®¾ç½®éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°">è®¾ç½®éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°</h2><p>åœ¨å‡†å¤‡åœ¨å½•åˆ¶æ˜¯ä½¿ç”¨ä¸€ç»„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºä¹‹å‰ï¼Œè°ƒç”¨ä¹‹å‰çš„<code>DeriveBufferSize</code>å‡½æ•°ï¼ˆå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW14">Write a Function to Derive Recording Audio Queue Buffer Size</a>ï¼‰ã€‚å¯ä»¥æŠŠè¯¥å¤§å°åˆ†é…ç»™æ­£åœ¨ä½¿ç”¨çš„å½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—ï¼Œå¦‚æ¸…å•2-12æ‰€ç¤ºï¼š</p><p><strong>æ¸…å•2-12</strong> è®¾ç½®éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DeriveBufferSize (                               <span class="comment">// 1</span></span><br><span class="line">    aqData.mQueue,                               <span class="comment">// 2</span></span><br><span class="line">    aqData.mDataFormat,                          <span class="comment">// 3</span></span><br><span class="line">    <span class="number">0.5</span>,                                         <span class="comment">// 4</span></span><br><span class="line">    &amp;aqData.bufferByteSize                       <span class="comment">// 5</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>DeriveBufferSize</code>å‡½æ•°ï¼ˆå®šä¹‰åœ¨<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW14">Write a Function to Derive Recording Audio Queue Buffer Size</a>ï¼‰ï¼Œè®¾ç½®åˆé€‚çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°ã€‚</li><li>é…ç½®ç¼“å†²åŒºå¤§å°çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>åœ¨å½•åˆ¶çš„æ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW4">Set Up an Audio Format for Recording</a>ã€‚</li><li>æ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºåº”ä¿ç•™çš„ç§’æ•°ã€‚æ­¤å¤„è®¾ç½®åŠç§’æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œæ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚è¯¥å€¼æ”¾åœ¨éŸ³é¢‘é˜Ÿåˆ—çš„è‡ªå®šä¹‰ç»“æ„ä½“ä¸­ã€‚</li></ol><h2 id="å‡†å¤‡ä¸€ç»„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº">å‡†å¤‡ä¸€ç»„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº</h2><p>ç°åœ¨ï¼Œè¯·æ±‚éŸ³é¢‘é˜Ÿåˆ—ï¼ˆåœ¨<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW2">Create a Recording Audio Queue</a>åˆ›å»ºçš„ï¼‰å‡†å¤‡ä¸€ç»„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚æ¸…å•2-13å±•ç¤ºäº†å¦‚ä½•æ“ä½œã€‚</p><p><strong>æ¸…å•2-13</strong> å‡†å¤‡ä¸€ç»„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; kNumberBuffers; ++i) &#123;           <span class="comment">// 1</span></span><br><span class="line">    AudioQueueAllocateBuffer (                       <span class="comment">// 2</span></span><br><span class="line">        aqData.mQueue,                               <span class="comment">// 3</span></span><br><span class="line">        aqData.bufferByteSize,                       <span class="comment">// 4</span></span><br><span class="line">        &amp;aqData.mBuffers[i]                          <span class="comment">// 5</span></span><br><span class="line">    );</span><br><span class="line"> </span><br><span class="line">    AudioQueueEnqueueBuffer (                        <span class="comment">// 6</span></span><br><span class="line">        aqData.mQueue,                               <span class="comment">// 7</span></span><br><span class="line">        aqData.mBuffers[i],                          <span class="comment">// 8</span></span><br><span class="line">        <span class="number">0</span>,                                           <span class="comment">// 9</span></span><br><span class="line">        <span class="literal">NULL</span>                                         <span class="comment">// 10</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>éå†åˆ†é…å’Œå…¥é˜Ÿæ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚</li><li><code>AudioQueueAllocateBuffer</code>å‡½æ•°è¯·æ±‚éŸ³é¢‘é˜Ÿåˆ—åˆ†é…éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚</li><li>æ‰§è¡Œåˆ†é…å¹¶æŒæœ‰ç¼“å†²åŒºçš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>åˆ†é…çš„æ–°éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW14">Write a Function to Derive Recording Audio Queue Buffer Size</a>ã€‚</li><li>åœ¨è¾“å‡ºæ—¶ï¼Œæ˜¯æ–°åˆ†é…çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚æŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆæ”¾åœ¨å’ŒéŸ³é¢‘é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨çš„è‡ªå®šä¹‰ç»“æ„ä½“ä¸­ã€‚</li><li><code>AudioQueueEnqueueBuffer</code>å‡½æ•°æŠŠéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ·»åŠ åˆ°ç¼“å†²åŒºé˜Ÿåˆ—çš„æœ«å°¾ã€‚</li><li>å‘å…¶æ·»åŠ ç¼“å†²åŒºçš„ç¼“å†²åŒºé˜Ÿåˆ—çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>æ­£åœ¨å…¥é˜Ÿçš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚</li><li>ç¼“å†²åŒºå…¥é˜Ÿæ—¶æœªä½¿ç”¨è¯¥å‚æ•°ã€‚</li><li>ç¼“å†²åŒºå…¥é˜Ÿæ—¶æœªä½¿ç”¨è¯¥å‚æ•°ã€‚</li></ol><h2 id="å½•åˆ¶éŸ³é¢‘">å½•åˆ¶éŸ³é¢‘</h2><p>æœ‰äº†å‰é¢çš„ä»£ç ï¼Œå½•åˆ¶è¿‡ç¨‹æ˜¾å¾—æ ¼å¤–ç®€å•ï¼Œå¦‚æ¸…å•2-14æ‰€ç¤ºã€‚</p><p><strong>æ¸…å•2-14</strong> å½•åˆ¶éŸ³é¢‘</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">aqData.mCurrentPacket = <span class="number">0</span>;                           <span class="comment">// 1</span></span><br><span class="line">aqData.mIsRunning = <span class="literal">true</span>;                            <span class="comment">// 2</span></span><br><span class="line"> </span><br><span class="line">AudioQueueStart (                                    <span class="comment">// 3</span></span><br><span class="line">    aqData.mQueue,                                   <span class="comment">// 4</span></span><br><span class="line">    <span class="literal">NULL</span>                                             <span class="comment">// 5</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">// Wait, on user interface thread, until user stops the recording</span></span><br><span class="line">AudioQueueStop (                                     <span class="comment">// 6</span></span><br><span class="line">    aqData.mQueue,                                   <span class="comment">// 7</span></span><br><span class="line">    <span class="literal">true</span>                                             <span class="comment">// 8</span></span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">aqData.mIsRunning = <span class="literal">false</span>;                           <span class="comment">// 9</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li>åˆå§‹åŒ–æ•°æ®åŒ…ç´¢å¼•ä¸º<code>0</code>ï¼Œåœ¨éŸ³é¢‘æ–‡ä»¶çš„å¼€å¤´å¼€å§‹å½•åˆ¶ã€‚</li><li>åœ¨è‡ªå®šä¹‰ç»“æ„ä½“ä¸­è®¾ç½®æ ‡å¿—ï¼Œä»¥æŒ‡ç¤ºéŸ³é¢‘é˜Ÿåˆ—æ­£åœ¨è¿è¡Œã€‚å½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°ä½¿ç”¨è¯¥æ ‡å¿—ã€‚</li><li><code>AudioQueueStart</code>å‡½æ•°åœ¨å…¶è‡ªå·±çš„çº¿ç¨‹ä¸Šå¯åŠ¨éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—å¼€å§‹ã€‚</li><li>ä½¿ç”¨<code>NULL</code>è¡¨ç¤ºéŸ³é¢‘é˜Ÿåˆ—åº”ç«‹å³å¼€å§‹å½•åˆ¶ã€‚</li><li><code>AudioQueueStop</code>å‡½æ•°åœæ­¢å¹¶é‡ç½®å½•åˆ¶éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—åœæ­¢ã€‚</li><li>ä½¿ç”¨<code>true</code>æ¥åŒæ­¥åœæ­¢ã€‚æœ‰å…³åŒæ­¥å’Œå¼‚æ­¥çš„è¯´æ˜ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW17">Audio Queue Control and State</a>ã€‚</li><li>åœ¨è‡ªå®šä¹‰ç»“æ„ä½“ä¸­è®¾ç½®æ ‡å¿—ï¼Œä»¥è¡¨ç¤ºéŸ³é¢‘é˜Ÿåˆ—è¿˜æ²¡è¿è¡Œã€‚</li></ol><h2 id="å½•åˆ¶åæ¸…ç†">å½•åˆ¶åæ¸…ç†</h2><p>å®Œæˆå½•åˆ¶åï¼Œéœ€è¦å¤„ç†éŸ³é¢‘é˜Ÿåˆ—å¹¶å…³é—­éŸ³é¢‘æ–‡ä»¶ï¼Œå¦‚æ¸…å•2-15æ‰€ç¤ºã€‚</p><p><strong>æ¸…å•2-15</strong> å½•åˆ¶åæ¸…ç†</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AudioQueueDispose (                                 <span class="comment">// 1</span></span><br><span class="line">    aqData.mQueue,                                  <span class="comment">// 2</span></span><br><span class="line">    <span class="literal">true</span>                                            <span class="comment">// 3</span></span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">AudioFileClose (aqData.mAudioFile);                 <span class="comment">// 4</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¯¥ä»£ç çš„å·¥ä½œæ–¹å¼ï¼š</p><ol type="1"><li><code>AudioQueueDispose</code>å‡½æ•°å¤„ç†éŸ³é¢‘é˜Ÿåˆ—åŠå…¶æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬ç¼“å†²åŒºã€‚</li><li>è¦å¤„ç†çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>ä½¿ç”¨<code>true</code>æ¥åŒæ­¥ï¼ˆå³ç«‹å³ï¼‰å¤„ç†éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>å…³é—­ç”¨äºå½•åˆ¶çš„éŸ³é¢‘æ–‡ä»¶ã€‚<code>AudioFileClose</code>å‡½æ•°åœ¨<code>AudioFile.h</code>å¤´æ–‡ä»¶ä¸­å£°æ˜ã€‚</li></ol><h2 id="æ€»ç»“">æ€»ç»“</h2><ul><li>ä½¿ç”¨å½•åˆ¶åŠŸèƒ½ä¸€èˆ¬æ­¥éª¤ï¼š<ol type="1"><li>å®šä¹‰è‡ªå®šä¹‰ç»“æ„ä½“æ¥ç®¡ç†çŠ¶æ€ã€æ ¼å¼ä»¥åŠè·¯å¾„ä¿¡æ¯ç­‰ã€‚</li><li>ç¼–å†™å›è°ƒå‡½æ•°æ¥æ‰§è¡Œå®é™…çš„å½•åˆ¶æ•°æ®å¤„ç†ã€‚</li><li>å¡«å……è‡ªå®šä¹‰ç»“æ„ä½“ä¸­çš„å„ä¸ªå­—æ®µï¼ŒåŒ…æ‹¬å½•åˆ¶åˆ°çš„æ–‡ä»¶çš„æ•°æ®æµã€æ–‡ä»¶è·¯å¾„ã€‚</li><li>åˆ›å»ºéŸ³é¢‘é˜Ÿåˆ—ã€éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€è¦å†™å…¥çš„æ–‡ä»¶ã€‚</li><li>é€šçŸ¥éŸ³é¢‘é˜Ÿåˆ—å¼€å§‹å½•åˆ¶ã€‚</li><li>å½•åˆ¶å®Œæ¯•åï¼Œé€šçŸ¥éŸ³é¢‘é˜Ÿåˆ—åœæ­¢å½•åˆ¶ï¼Œç„¶åé‡Šæ”¾ã€‚è¿™åŒæ—¶ä¼šé‡Šæ”¾å®ƒæ‰€æ‹¥æœ‰çš„æ‰€æœ‰ç¼“å†²åŒºã€‚</li></ol></li><li>å¯¹äºä½¿ç”¨OCã€Swiftä»£ç ï¼Œå¯ä»¥ç›´æ¥æŠŠç»“æ„ä½“çš„å­—æ®µç›´æ¥åˆ†æ•£åˆ°ç±»å®šä¹‰ä¸­ã€‚</li><li>å½•åˆ¶å›è°ƒå‡½æ•°ä»»åŠ¡ï¼š<ul><li>æŠŠå¡«å……è¿›éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ã€‚</li><li>æŠŠå†™å…¥æ–‡ä»¶çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ’é˜Ÿåˆ°é˜Ÿåˆ—ä¸­ã€‚è¿™æ ·æ‰å¯ä»¥æ¥å—æ›´å¤šæ•°æ®ã€‚</li></ul></li><li>å›è°ƒå‡½æ•°ä¸­çš„<code>const AudioStreamPacketDescription  *inPacketDesc</code>åŒ…å«VBRåŒ…æè¿°çš„æ•°é‡ï¼ˆ<code>mVariableFramesInPacket</code>ï¼‰ï¼Œå¦‚æœæ˜¯0åˆ™è¡¨ç¤ºè¿™æ˜¯CBRæ•°æ®ã€‚è¯¥æ•°æ®æ¥è‡ªç¼–ç å™¨ã€‚</li><li>æ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ—¶é•¿å¯ä»¥è®¾ç½®ä¸º0.5ç§’ã€‚</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å½“ä½ ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡è¿›è¡Œå½•åˆ¶çš„æ—¶å€™ï¼Œä½ å¯ä»¥å°†éŸ³é¢‘å½•åˆ¶åˆ°ä»»ä½•åœ°æ–¹ï¼šç£ç›˜æ–‡ä»¶ã€ç½‘ç»œè¿æ¥æˆ–å†…å­˜å¯¹è±¡ç­‰ç­‰ã€‚æœ¬ç« å°†ä»‹ç»ä¸­æœ€å¸¸è§çš„ä¸€ç§æƒ…å†µï¼Œå°†éŸ³é¢‘å½•åˆ¶åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Audio Queue Services Programming Guide" scheme="https://bqlin.github.io/tags/Audio-Queue-Services-Programming-Guide/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>Audio Queue Services Programming Guideï¼šå…³äºéŸ³é¢‘é˜Ÿåˆ—</title>
    <link href="https://bqlin.github.io/posts/audio_queue_services_pg_about_audio_queues/"/>
    <id>https://bqlin.github.io/posts/audio_queue_services_pg_about_audio_queues/</id>
    <published>2021-09-27T04:16:11.000Z</published>
    <updated>2021-09-27T04:16:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬ç« å°†å­¦ä¹ åˆ°éŸ³é¢‘é˜Ÿåˆ—çš„åŠŸèƒ½ã€æ¶æ„å’Œå†…éƒ¨å·¥ä½œåŸç†ã€‚æœ¬æ–‡ä»‹ç»éŸ³é¢‘é˜Ÿåˆ—ç”¨æ¥æ’­æ”¾æˆ–å½•åˆ¶æ‰€ç”¨çš„éŸ³é¢‘é˜Ÿåˆ—ï¼ˆaudio queuesï¼‰ã€éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼ˆaudio queue buffersï¼‰å’Œå›è°ƒå‡½æ•°ï¼Œä½ è¿˜å¯ä»¥æ‰¾åˆ°å…³äºéŸ³é¢‘é˜Ÿåˆ—çŠ¶æ€å’Œå‚æ•°çš„ä¿¡æ¯ï¼Œæˆªè‡³åˆ°æœ¬ç« çš„ç»“å°¾ï¼Œä½ å°†ä¼šè·å¾—æœ‰æ•ˆä½¿ç”¨è¯¥æŠ€æœ¯çš„æ¦‚å¿µæ€§ç†è§£ã€‚</p><span id="more"></span><h2 id="ä»€ä¹ˆæ˜¯éŸ³é¢‘é˜Ÿåˆ—">ä»€ä¹ˆæ˜¯éŸ³é¢‘é˜Ÿåˆ—ï¼Ÿ</h2><p>åœ¨iOSå’ŒMac OS Xä¸­ï¼Œ<strong>éŸ³é¢‘é˜Ÿåˆ—</strong>æ˜¯ä¸€ä¸ªç”¨æ¥å½•åˆ¶å’Œæ’­æ”¾éŸ³é¢‘çš„è½¯ä»¶å¯¹è±¡ï¼Œä½¿ç”¨<code>AudioQueueRef</code>ä¸é€æ˜æ•°æ®ç±»å‹æ¥è¡¨ç¤ºï¼ˆåœ¨<code>AudioQueue.h</code>å¤´æ–‡ä»¶ä¸­å£°æ˜ï¼‰ã€‚</p><p>éŸ³é¢‘é˜Ÿåˆ—å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><ul><li>è¿æ¥éŸ³é¢‘ç¡¬ä»¶</li><li>å†…å­˜ç®¡ç†</li><li>æ ¹æ®éœ€è¦ä¸ºå·²å‹ç¼©çš„éŸ³é¢‘æ ¼å¼å¼•å…¥ç¼–ç å™¨</li><li>åª’ä½“çš„å½•åˆ¶æˆ–æ’­æ”¾</li></ul><p>ä½ å¯ä»¥å°†éŸ³é¢‘é˜Ÿåˆ—é…åˆå…¶ä»–Core Audioçš„æ¥å£ä½¿ç”¨ï¼Œå†åŠ ä¸Šç›¸å¯¹å°‘é‡çš„è‡ªå®šä¹‰ä»£ç å°±å¯ä»¥åœ¨ç¨‹åºä¸­åˆ›å»ºä¸€å¥—å®Œæ•´çš„æ•°å­—éŸ³é¢‘å½•åˆ¶æˆ–æ’­æ”¾è§£å†³æ–¹æ¡ˆã€‚</p><h3 id="éŸ³é¢‘é˜Ÿåˆ—æ¶æ„">éŸ³é¢‘é˜Ÿåˆ—æ¶æ„</h3><p>æ‰€æœ‰çš„éŸ³é¢‘é˜Ÿåˆ—éƒ½å«æœ‰ç›¸åŒçš„åŸºç¡€ç»“æ„ï¼ŒåŒ…å«ä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š</p><ul><li>ä¸€ç»„<strong>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼ˆaudio queue buffersï¼‰</strong>ï¼Œæ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºéƒ½æ˜¯ä¸€ä¸ªå­˜å‚¨éŸ³é¢‘æ•°æ®çš„ä¸´æ—¶ä»“åº“ã€‚</li><li>ä¸€ä¸ª<strong>ç¼“å†²åŒºé˜Ÿåˆ—ï¼ˆbuffer queueï¼‰</strong>ï¼Œä¸€ä¸ªåŒ…å«éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„æœ‰åºåˆ—è¡¨ã€‚</li><li>ä¸€ä¸ªä½ è‡ªå·±ç¼–å†™çš„<strong>éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°ï¼ˆaudio queue callbackï¼‰</strong>ã€‚</li></ul><p>æ¶æ„å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºè¿™ä¸ªéŸ³é¢‘é˜Ÿåˆ—æ˜¯ç”¨æ¥å½•åˆ¶è¿˜æ˜¯ç”¨æ¥æ’­æ”¾çš„ã€‚ä¸åŒä¹‹å¤„åœ¨äºéŸ³é¢‘é˜Ÿåˆ—å¦‚ä½•è¿æ¥åˆ°å®ƒçš„è¾“å…¥å’Œè¾“å…¥ï¼Œè¿˜æœ‰å®ƒçš„å›è°ƒå‡½æ•°æ‰€æ‰®æ¼”çš„è§’è‰²ã€‚</p><h4 id="ç”¨æ¥å½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—">ç”¨æ¥å½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—</h4><p>ç”¨äºå½•åˆ¶çš„çš„éŸ³é¢‘é˜Ÿåˆ—ï¼Œä½¿ç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1501687-audioqueuenewinput"><code>AudioQueueNewInput</code></a>å‡½æ•°åˆ›å»ºï¼Œå¦‚å›¾1-1çš„ç»“æ„ã€‚</p><p><strong>å›¾1-1</strong> ç”¨äºå½•åˆ¶çš„çš„éŸ³é¢‘é˜Ÿåˆ—</p><figure><img src="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/Art/recording_architecture_2x.png" alt="Architecture for a recording audio queue" /><figcaption aria-hidden="true">Architecture for a recording audio queue</figcaption></figure><p>ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—çš„è¾“å…¥ç«¯ä¸€èˆ¬è¿æ¥åˆ°å¤–éƒ¨çš„éŸ³é¢‘ç¡¬ä»¶ä¸Šï¼Œæ¯”å¦‚è¯´éº¦å…‹é£ã€‚åœ¨iOSä¸­ï¼ŒéŸ³é¢‘æ¥è‡ªäºç”±ç”¨æˆ·è¿æ¥çš„è®¾å¤‡ï¼šå†…ç½®çš„éº¦å…‹é£æˆ–è€…è€³æœºéº¦å…‹é£ï¼Œå¦‚åœ¨Mac OS Xä¸‹ï¼ŒéŸ³é¢‘æ¥è‡ªäºç”±ç”¨æˆ·åœ¨ç³»ç»Ÿé¦–é€‰é¡¹ä¸­è®¾ç½®çš„ç³»ç»Ÿé»˜è®¤éŸ³é¢‘è¾“å…¥è®¾å¤‡ã€‚</p><p>ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—çš„è¾“å…¥ç«¯åˆ©ç”¨äº†ä½ è‡ªå·±å†™çš„å›è°ƒå‡½æ•°ï¼Œå½“å½•åˆ¶éŸ³é¢‘åˆ°ç£ç›˜ä¸Šçš„æ—¶å€™ï¼Œå›è°ƒå‡½æ•°å°†å­˜æœ‰ä»éŸ³é¢‘é˜Ÿåˆ—ä¸­æ¥æ”¶åˆ°çš„æ–°çš„éŸ³é¢‘æ•°æ®çš„ç¼“å†²åŒºå†™å…¥åˆ°éŸ³é¢‘æ–‡ä»¶ä¸­ã€‚ç„¶è€Œï¼Œç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—ä¹Ÿå¯ä»¥ç”¨å…¶ä»–æ–¹æ³•æ¥ä½¿ç”¨ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä¸­ä¸€ç§ï¼Œæ¯”å¦‚è¯´ï¼Œåœ¨ä¸€ä¸ªå®æ—¶çš„åˆ†æä»ªä¸­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ çš„å›è°ƒå‡½æ•°ä¼šç›´æ¥å‘ç¨‹åºæä¾›éŸ³é¢‘æ•°æ®ï¼Œè€Œä¸æ˜¯å°†å®ƒå†™å…¥ç£ç›˜ã€‚</p><p>æ›´å¤šå…³äºè¯¥å›è°ƒçš„çŸ¥è¯†ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW10">The Recording Audio Queue Callback Function</a>ã€‚</p><p>æ¯ä¸€ä¸ªéŸ³é¢‘é˜Ÿåˆ—ï¼Œæ— è®ºæ˜¯ç”¨äºå½•åˆ¶è¿˜æ˜¯ç”¨äºæ’­æ”¾ï¼Œéƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚è¿™äº›ç¼“å†²åŒºæ’åˆ—åœ¨ä¸€ä¸ªç‰¹æ®Šçš„è¢«ç§°ä¸ºç¼“å†²åŒºé˜Ÿåˆ—ï¼ˆbuffer queueï¼‰çš„åºåˆ—ä¸­ã€‚å¦‚å›¾æ‰€ç¤ºï¼ŒéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ˜¯æŒ‰ç…§ä»–ä»¬è¢«å¡«å……çš„é¡ºåºç¼–å·çš„â€”â€”è¿™ä¹Ÿæ˜¯å’ŒæŠŠä»–ä»¬äº¤ä»˜ç»™å›è°ƒå‡½æ•°çš„é¡ºåºæ˜¯ç›¸åŒçš„ã€‚æœ‰å…³éŸ³é¢‘é˜Ÿåˆ—æ˜¯å¦‚ä½•ä½¿ç”¨ç¼“å†²åŒºï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW9">The Buffer Queue and Enqueuing</a>ã€‚</p><h4 id="ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—">ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—</h4><p>ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—ï¼Œä½¿ç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1503207-audioqueuenewoutput"><code>AudioQueueNewOutput</code></a>å‡½æ•°åˆ›å»ºï¼Œå¦‚å›¾1-2ç»“æ„ã€‚</p><p><strong>å›¾1-2</strong> ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—</p><figure><img src="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/Art/playback_architecture_2x.png" alt="Architecture for a playback audio queue" /><figcaption aria-hidden="true">Architecture for a playback audio queue</figcaption></figure><p>åœ¨ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—ä¸­ï¼Œå›è°ƒå‡½æ•°æ˜¯åœ¨è¾“å…¥ç«¯çš„ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°çš„èŒè´£å°±æ˜¯ä»ç£ç›˜ï¼ˆæˆ–å…¶ä»–æ¥æºï¼‰ä¸­è·å–éŸ³é¢‘æ•°æ®ï¼Œç„¶åå°†å®ƒäº¤ä»˜ç»™éŸ³é¢‘é˜Ÿåˆ—ã€‚å½“æ²¡æœ‰æ›´å¤šéŸ³é¢‘æ•°æ®éœ€è¦æ’­æ”¾çš„æ—¶å€™å‘Šè¯‰éŸ³é¢‘é˜Ÿåˆ—åœæ­¢ã€‚æ›´å¤šå…³äºè¿™ä¸ªå›è°ƒå‡½æ•°çš„çŸ¥è¯†ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW11">The Playback Audio Queue Callback Function</a>ã€‚</p><p>ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—çš„è¾“å‡ºç«¯ä¸€èˆ¬éƒ½æ˜¯è¿æ¥åˆ°å¤–éƒ¨çš„éŸ³é¢‘è®¾å¤‡çš„ï¼Œæ¯”å¦‚è¯´æ‰¬å£°å™¨ã€‚åœ¨iOSä¸­ï¼ŒéŸ³é¢‘é€šè¿‡ç”¨æˆ·é€‰æ‹©çš„è®¾å¤‡æ’­æ”¾ï¼Œå¦‚æ¥æ”¶è€…æ˜¯è€³æœºã€‚åœ¨Mac OS Xä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒéŸ³é¢‘ä¼šé€šè¿‡ç”¨æˆ·åœ¨ç³»ç»Ÿé¦–é€‰é¡¹ä¸­è®¾ç½®çš„é»˜è®¤éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¸­è¾“å‡ºã€‚</p><h3 id="éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº">éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒº</h3><p><strong>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼ˆaudio queue bufferï¼‰</strong>æ˜¯ä¸€ä¸ª<a href="https://developer.apple.com/documentation/audiotoolbox/audioqueuebuffer"><code>AudioQueueBuffer</code></a>ç±»å‹çš„æ•°æ®ç»“æ„ï¼ˆåœ¨<code>AudioQueue.h</code>å¤´æ–‡ä»¶ä¸­å£°æ˜ï¼‰ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> AudioQueueBuffer &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">UInt32</span>   mAudioDataBytesCapacity;</span><br><span class="line">    <span class="keyword">void</span> *<span class="keyword">const</span>    mAudioData;</span><br><span class="line">    <span class="built_in">UInt32</span>         mAudioDataByteSize;</span><br><span class="line">    <span class="keyword">void</span>           *mUserData;</span><br><span class="line">&#125; AudioQueueBuffer;</span><br><span class="line"><span class="keyword">typedef</span> AudioQueueBuffer *AudioQueueBufferRef;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­çš„<code>mAudioData</code>å­—æ®µï¼ŒæŒ‡å‘äº†ç¼“å†²åŒºæœ¬èº«ï¼šä¸€ä¸ªç”¨æ¥å½“ä½œæš‚æ—¶å­˜æ”¾å½•åˆ¶æˆ–æ’­æ”¾éŸ³é¢‘æ•°æ®çš„å®¹å™¨çš„å†…å­˜ï¼Œå…¶ä»–å­—æ®µä¸­çš„æ•°æ®ç”¨æ¥è¾…åŠ©éŸ³é¢‘é˜Ÿåˆ—ç®¡ç†è¿™ä¸ªç¼“å†²åŒºã€‚</p><p>éŸ³é¢‘é˜Ÿåˆ—å¯ä»¥ä½¿ç”¨ä»»æ„æ•°é‡çš„ç¼“å†²åŒºã€‚ä¸€èˆ¬æƒ…å†µä¸‹è®¾ç½®ä¸º3ï¼Œè¿™æ ·å°±å¯ä»¥è®©ä¸€ä¸ªç¼“å†²åŒºå¿™äºå°†æ•°æ®å†™å…¥ç£ç›˜ï¼ŒåŒæ—¶å¦ä¸€ä¸ªç¼“å†²åŒºåœ¨å¡«å……æ–°çš„éŸ³é¢‘æ•°æ®ï¼Œç¬¬ä¸‰ä¸ªç¼“å†²åŒºåœ¨éœ€è¦åšç£ç›˜I/Oå»¶è¿Ÿè¡¥å¿çš„æ—¶å€™ä½¿ç”¨ã€‚å›¾1-3å±•ç¤ºäº†è¿™ä¸ªè¿‡ç¨‹ã€‚</p><p>éŸ³é¢‘é˜Ÿåˆ—è´Ÿè´£å¯¹å®ƒçš„ç¼“å†²åŒºè¿›è¡Œå†…å­˜ç®¡ç†ï¼š</p><ul><li>å½“è°ƒç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1502248-audioqueueallocatebuffer"><code>AudioQueueAllocateBuffer</code></a>å‡½æ•°çš„æ—¶ï¼ŒéŸ³é¢‘é˜Ÿåˆ—åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºã€‚</li><li>å½“é€šè¿‡è°ƒç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1502229-audioqueuedispose"><code>AudioQueueDispose</code></a>å‡½æ•°é‡Šæ”¾ä¸€ä¸ªéŸ³é¢‘é˜Ÿåˆ—çš„æ—¶ï¼Œè¿™ä¸ªéŸ³é¢‘é˜Ÿåˆ—é‡Šæ”¾æ‰å®ƒæ‹¥æœ‰çš„ç¼“å†²åŒºã€‚</li></ul><p>è¿™æé«˜äº†æ·»åŠ åˆ°ç¨‹åºä¸­å½•åˆ¶å’Œæ’­æ”¾åŠŸèƒ½çš„å¥å£®æ€§ã€‚åŒæ—¶å®ƒä¹Ÿå¸®åŠ©ä½ ä¼˜åŒ–èµ„æºçš„ä½¿ç”¨ã€‚</p><p>å…³äºAudioQueueBufferæ•°æ®ç»“æ„çš„å®Œæ•´æè¿°ï¼Œå‚é˜…_<a href="https://developer.apple.com/documentation/audiotoolbox/audio_queue_services">Audio Queue Services Reference</a>ã€‚_</p><h3 id="ç¼“å†²åŒºé˜Ÿåˆ—å’Œå…¥é˜Ÿ">ç¼“å†²åŒºé˜Ÿåˆ—å’Œå…¥é˜Ÿ</h3><p>ä¼ é€’ç»™éŸ³é¢‘é˜Ÿåˆ—çš„ç¼“å†²åŒºé˜Ÿåˆ—ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡ï¼ˆAudio Queue Servicesï¼‰ï¼Œåœ¨<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW12">Audio Queue Architecture</a>ä¸­ï¼Œå°†æåŠç¼“å†²åŒºé˜Ÿåˆ—ï¼Œä¸€ä¸ªç¼“å†²åŒºçš„æœ‰åºåˆ—è¡¨ï¼Œå…¶ä¸­æè¿°äº†éŸ³é¢‘é˜Ÿåˆ—å¯¹è±¡å¦‚ä½•é…åˆå›è°ƒå‡½æ•°åœ¨å½•åˆ¶æˆ–æ’­æ”¾çš„è¿‡ç¨‹ä¸­ç®¡ç†ç¼“å†²åŒºé˜Ÿåˆ—ã€‚å°¤å…¶æ˜¯<strong>å…¥é˜Ÿ</strong>éŸ³é¢‘é˜Ÿåˆ—ï¼Œå³ç¼“å†²åŒºé˜Ÿåˆ—å¯¹éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„é™„åŠ æ“ä½œã€‚æ— è®ºæ˜¯åœ¨å®ç°å½•åˆ¶æˆ–è€…æ’­æ”¾ï¼Œå…¥é˜Ÿéƒ½æ˜¯ä½ åœ¨å›è°ƒå‡½æ•°ä¸­éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚</p><h4 id="å½•åˆ¶è¿‡ç¨‹">å½•åˆ¶è¿‡ç¨‹</h4><p>å½“è¿›è¡Œå½•åˆ¶æ—¶ï¼Œä¸€ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¡«å……äº†ä»è¾“å…¥è®¾å¤‡ï¼ˆå¦‚éº¦å…‹é£ï¼‰ä¸­è·å–çš„éŸ³é¢‘æ•°æ®ã€‚ç¼“å†²åŒºé˜Ÿåˆ—ä¸­çš„å…¶ä»–ç¼“å†²åŒºå°†åœ¨å½“å‰ç¼“å†²åŒºçš„æœ«å°¾ä¾æ¬¡æ’é˜Ÿç­‰å¾…å¡«å……éŸ³é¢‘æ•°æ®ã€‚</p><p>éŸ³é¢‘é˜Ÿåˆ—å°†æŒ‰ç…§ç¼“å†²åŒºå¡«å……çš„é¡ºåºæŠŠå·²å¡«å……è¿‡éŸ³é¢‘æ•°æ®çš„ç¼“å†²åŒºäº¤ä»˜ç»™ä½ çš„å›è°ƒå‡½æ•°ã€‚å›¾1-3å±•ç¤ºäº†å½“ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—å½•åˆ¶æ—¶çš„è¿‡ç¨‹ã€‚</p><p><strong>å›¾1-3</strong> å½•åˆ¶è¿‡ç¨‹</p><figure><img src="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/Art/recording_callback_function_2x.png" alt="Illustration of the recording process when using an audio queue" /><figcaption aria-hidden="true">Illustration of the recording process when using an audio queue</figcaption></figure><ol type="1"><li>å½•åˆ¶å¼€å§‹ï¼ŒéŸ³é¢‘é˜Ÿåˆ—ç”¨è·å–çš„æ•°æ®å¡«å……ç¼“å†²åŒºã€‚</li><li>ç¬¬ä¸€ä¸ªç¼“å†²åŒºå¡«å……å®Œæ¯•ï¼ŒéŸ³é¢‘é˜Ÿåˆ—è°ƒç”¨å›è°ƒå‡½æ•°æ¥å¤„ç†è¿™ä¸ªè¢«å¡«å……æ»¡çš„ç¼“å†²åŒºï¼ˆç¼“å†²åŒºä¸€ï¼‰ã€‚</li><li>å›è°ƒå‡½æ•°å°†ç¼“å†²åŒºçš„å†…å®¹å†™åˆ°éŸ³é¢‘æ–‡ä»¶ä¸­ã€‚åŒæ—¶ï¼ŒéŸ³é¢‘é˜Ÿåˆ—å°†å¦ä¸€ä¸ªç¼“å†²åŒºï¼ˆç¼“å†²åŒºäºŒï¼‰å¡«å……æ–°è·å–çš„æ•°æ®ã€‚</li><li>å›è°ƒå‡½æ•°å°†åˆšåˆšå†™å…¥ç£ç›˜çš„ç¼“å†²åŒºï¼ˆç¼“å†²åŒºä¸€ï¼‰å…¥é˜Ÿï¼Œä½¿å®ƒé‡æ–°é‡æ–°å›åˆ°è¢«å¡«å……çš„é˜Ÿåˆ—ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—å†ä¸€æ¬¡è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªå¡«å……å®Œæ¯•çš„ç¼“å†²åŒºï¼ˆç¼“å†²åŒºäºŒï¼‰ã€‚</li><li>å›è°ƒå‡½æ•°å°†è¿™ä¸ªç¼“å†²åŒºçš„å†…å®¹å†™å…¥åˆ°éŸ³é¢‘æ–‡ä»¶ã€‚</li></ol><p>è¿™ç§ç¨³å®šçŠ¶æ€ä¼šä¸€ç›´æŒç»­åˆ°ç”¨æˆ·åœæ­¢å½•åˆ¶ã€‚</p><h4 id="æ’­æ”¾è¿‡ç¨‹">æ’­æ”¾è¿‡ç¨‹</h4><p>å½“è¿›è¡Œæ’­æ”¾çš„æ—¶å€™ï¼ŒéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå°†è¢«ä¼ é€åˆ°è¾“å‡ºè®¾å¤‡ï¼ˆå¦‚æ‰¬å£°å™¨ï¼‰ã€‚ç¼“å†²åŒºé˜Ÿåˆ—ä¸­å…¶ä»–çš„ç¼“å†²åŒºè®²æŒ‰é¡ºåºæ’åœ¨å½“å‰ç¼“å†²åŒºæœ«å°¾ç­‰å¾…æ’­æ”¾ã€‚</p><p>éŸ³é¢‘é˜Ÿåˆ—å°†å·²ç»æ’­æ”¾è¿‡çš„éŸ³é¢‘æ•°æ®æŒ‰ç…§ä»–ä»¬æ’­æ”¾çš„é¡ºåºäº¤ä»˜ç»™ä½ çš„å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°å°†æ–°çš„éŸ³é¢‘æ•°æ®è¯»å–åˆ°ä¸€ä¸ªç¼“å†²åŒºä¸­ï¼Œç„¶åå°†å®ƒå…¥é˜Ÿã€‚å›¾1-4å±•ç¤ºäº†å½“ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æ’­æ”¾æ—¶çš„è¿‡ç¨‹ã€‚</p><p><strong>å›¾1-4</strong> æ’­æ”¾è¿‡ç¨‹</p><figure><img src="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/Art/playback_callback_function_2x.png" alt="Illustration of the playback process when using an audio queue" /><figcaption aria-hidden="true">Illustration of the playback process when using an audio queue</figcaption></figure><ol type="1"><li>ç¨‹åºå¯åŠ¨ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—ï¼Œç¨‹åºå¯¹æ¯ä¸€ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºè°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå¡«å……è¿™äº›ç¼“å†²åŒºå¹¶ä¸”å°†å®ƒä»¬åŠ å…¥ç¼“å†²åŒºé˜Ÿåˆ—ã€‚</li><li>å¯åŠ¨æ“ä½œä¼šç¡®ä¿å½“ç¨‹åºè°ƒç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1502689-audioqueuestart"><code>AudioQueueStart</code></a>å‡½æ•°ä¹‹åï¼Œæ’­æ”¾å¯ä»¥ç«‹å³æ‰§è¡Œã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—å°†ç¬¬ä¸€ä¸ªç¼“å†²åŒºï¼ˆç¼“å†²åŒºä¸€ï¼‰äº¤ä»˜ç»™è¾“å‡ºè®¾å¤‡ã€‚å½“ç¬¬ä¸€ä¸ªç¼“å†²åŒºè¢«æ’­æ”¾å®Œæ¯•ä¹‹åï¼Œç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—å°±è¿›å…¥äº†ä¸€ä¸ªç¨³å®šçš„å¾ªç¯çŠ¶æ€ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—å¼€å§‹æ’­æ”¾ä¸‹ä¸€ä¸ªç¼“å†²åŒºï¼ˆç¼“å†²åŒºäºŒï¼‰ã€‚</li><li>è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå¤„ç†åˆšåˆšæ’­æ”¾å®Œçš„é‚£ä¸ªç¼“å†²åŒºï¼ˆç¼“å†²åŒºä¸€ï¼‰ã€‚</li><li>è¿™ä¸ªå›è°ƒå‡½æ•°ä»éŸ³é¢‘æ–‡ä»¶ä¸­è¯»å–æ•°æ®å¡«å……ç¼“å†²åŒºç„¶åå…¥é˜Ÿæ’­æ”¾ã€‚</li></ol><h4 id="æ§åˆ¶æ’­æ”¾è¿‡ç¨‹">æ§åˆ¶æ’­æ”¾è¿‡ç¨‹</h4><p>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ€»æ˜¯æŒ‰ç…§ä»–ä»¬å…¥é˜Ÿçš„é¡ºåºè¿›è¡Œæ’­æ”¾ï¼Œç„¶è€Œï¼Œåœ¨æ’­æ”¾è¿‡ç¨‹ä¸­ï¼ŒéŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æä¾›äº†<a href="https://developer.apple.com/documentation/audiotoolbox/1503258-audioqueueenqueuebufferwithparam"><code>AudioQueueEnqueueBufferWithParameters</code></a>å‡½æ•°æ¥è¿›è¡Œä¸€äº›æ§åˆ¶ï¼Œè¿™ä¸ªå‡½æ•°æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li>è®¾ç½®ç¼“å†²åŒºçš„ç²¾ç¡®æ’­æ”¾æ—¶é—´ï¼Œè¿™å¯ä»¥å®ç°éŸ³é¢‘åŒæ­¥ã€‚</li><li>æˆªæ–­éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¼€å¤´æˆ–ç»“å°¾çš„å¸§ï¼Œè¿™å¯ä»¥è®©ä½ å»é™¤å¼€å¤´æˆ–ç»“å°¾çš„é™éŸ³ã€‚</li><li>åœ¨ç¼“å†²åŒºçš„ç²’åº¦ä¸Šè®¾ç½®æ’­æ”¾å¢ç›Šã€‚</li></ul><p>å…³äºæ›´å¤šæ’­æ”¾å¢ç›Šçš„ä¿¡æ¯ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW15">Audio Queue Parameters</a>ï¼Œå¦‚æœè¦äº†è§£å¯¹<code>AudioQueueEnqueueBufferWithParameters</code>å‡½æ•°çš„å®Œæ•´æè¿°ï¼Œå‚é˜…_<a href="https://developer.apple.com/documentation/audiotoolbox/audio_queue_services">Audio Queue Services Reference</a>_ã€‚</p><h3 id="éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°">éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡çš„å¤§éƒ¨åˆ†ç¼–ç¨‹ä»»åŠ¡éƒ½åœ¨ç¼–ç¨‹éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°ä¸Šã€‚</p><p>åœ¨å½•åˆ¶æˆ–æ’­æ”¾è¿‡ç¨‹ä¸­ï¼ŒéŸ³é¢‘é˜Ÿåˆ—å°†åå¤è°ƒç”¨å®ƒæ‰€æ‹¥æœ‰çš„éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°ã€‚è°ƒç”¨çš„æ—¶é—´é—´éš”å–å†³äºéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„å®¹é‡ï¼Œä¸€èˆ¬æ¥ä¸€è¯´è¿™ä¸ªæ—¶é—´åœ¨åŠç§’åˆ°å‡ ç§’ã€‚</p><p>æ— è®ºå¯¹äºå½•åˆ¶æˆ–è€…æ’­æ”¾ï¼ŒéŸ³é¢‘é˜Ÿåˆ—å›è°ƒçš„ä¸€ä¸ªèŒè´£å°±æ˜¯è¿”å›ä¸€ä¸ªç¼“å†²åŒºé˜Ÿåˆ—çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºã€‚å›è°ƒå‡½æ•°ä½¿ç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1502779-audioqueueenqueuebuffer"><code>AudioQueueEnqueueBuffer</code></a>å‡½æ•°å°†ä¸€ä¸ªç¼“å†²åŒºåŠ å…¥åˆ°ç¼“å†²åŒºé˜Ÿåˆ—çš„æœ«å°¾ã€‚å¯¹äºæ’­æ”¾æ¥è¯´ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1503258-audioqueueenqueuebufferwithparam"><code>AudioQueueEnqueueBufferWithParameters</code></a>å‡½æ•°æ¥è·å¾—æ›´å¤šçš„æ§åˆ¶ã€‚</p><h4 id="ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°">ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°</h4><p>æœ¬èŠ‚ä»‹ç»äº†ä¸€èˆ¬æƒ…å†µä¸‹ï¼ˆå°†éŸ³é¢‘å½•åˆ¶åˆ°ç£ç›˜ä¸Šï¼‰çš„å›è°ƒå‡½æ•°ã€‚ä»¥ä¸‹æ˜¯ç”¨äºå½•åˆ¶çš„å›è°ƒå‡½æ•°çš„åŸå‹ï¼ˆåœ¨<code>AudioQueue.h</code>å¤´æ–‡ä»¶ä¸­å£°æ˜ï¼‰ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AudioQueueInputCallback (</span><br><span class="line">    <span class="keyword">void</span>                               *inUserData,</span><br><span class="line">    AudioQueueRef                      inAQ,</span><br><span class="line">    AudioQueueBufferRef                inBuffer,</span><br><span class="line">    <span class="keyword">const</span> AudioTimeStamp               *inStartTime,</span><br><span class="line">    <span class="built_in">UInt32</span>                             inNumberPacketDescriptions,</span><br><span class="line">    <span class="keyword">const</span> AudioStreamPacketDescription *inPacketDescs</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—ï¼Œåœ¨è°ƒç”¨å›è°ƒå‡½æ•°çš„æ—¶å€™ï¼Œæä¾›äº†æŠŠä¸‹ä¸€ç»„éŸ³é¢‘æ•°æ®å†™å…¥åˆ°æ–‡ä»¶çš„ä¸€åˆ‡ä¿¡æ¯ï¼š</p><ul><li><code>inUserData</code>ï¼šé€šå¸¸æ˜¯ä¸€ä¸ªç”¨æ¥ä¿å­˜éŸ³é¢‘é˜Ÿåˆ—å’Œå®ƒçš„ç¼“å†²åŒºçŠ¶æ€ä¿¡æ¯çš„è‡ªå®šä¹‰ç»“æ„ï¼Œæˆ–è€…ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶å¯¹è±¡ ï¼ˆ<code>AudioFileID</code>ç±»å‹ï¼‰è¡¨ç¤ºæ­£åœ¨å†™å…¥çš„æ–‡ä»¶ï¼Œæˆ–è€…è¯¥æ–‡ä»¶çš„éŸ³é¢‘æ ¼å¼ä¿¡æ¯ã€‚</li><li><code>inAQ</code>ï¼šæ˜¯è°ƒç”¨å›è°ƒå‡½æ•°çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li><code>inBuffer</code>ï¼šæ˜¯ä¸€ä¸ªè¢«éŸ³é¢‘é˜Ÿåˆ—å¡«å……æ–°çš„éŸ³é¢‘æ•°æ®çš„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼Œå®ƒåŒ…å«äº†å›è°ƒå‡½æ•°å†™å…¥æ–‡ä»¶æ‰€éœ€è¦çš„æ–°æ•°æ®ã€‚æ•°æ®å·²ç»æ ¹æ®ä½ åœ¨è‡ªå·±æŒ‡å®šçš„è‡ªå®šä¹‰ç»“æ„ï¼ˆç”±<code>inUserData</code>å‚æ•°ä¼ å…¥ï¼‰ä¸­æŒ‡å®šçš„æ ¼å¼æ ¼å¼åŒ–ã€‚æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AboutAudioQueues/AboutAudioQueues.html#//apple_ref/doc/uid/TP40005343-CH5-SW14">Using Codecs and Audio Data Formats</a>ã€‚</li><li><code>inStartTime</code>ï¼šæ˜¯ç¼“å†²åŒºä¸­çš„é¦–ä¸ªé‡‡æ ·çš„å‚è€ƒæ—¶é—´ï¼Œå¯¹äºåŸºæœ¬çš„å½•åˆ¶ï¼Œä½ çš„å›è°ƒå‡½æ•°ä¸ä¼šä½¿ç”¨è¿™ä¸ªå‚æ•°ã€‚</li><li><code>inNumberPacketDescriptions</code>ï¼šæ˜¯<code>inPacketDescs</code>å‚æ•°ä¸­åŒ…æè¿°ç¬¦ï¼ˆpacket descriptionsï¼‰çš„æ•°é‡ï¼Œå¦‚æœä½ æ­£åœ¨å½•åˆ¶ä¸€ä¸ªVBRï¼ˆå¯å˜æ¯”ç‰¹ç‡ï¼ˆvariable bitrateï¼‰ï¼‰æ ¼å¼ï¼ŒéŸ³é¢‘é˜Ÿåˆ—å°†å›è°ƒè¯¥å‚æ•°ç»™ä½ ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥è®©ä½ ä¼ é€’ç»™<a href="https://developer.apple.com/documentation/audiotoolbox/1502135-audiofilewritepackets"><code>AudioFileWritePackets</code></a>å‡½æ•°ã€‚CBRï¼ˆå¸¸é‡æ¯”ç‰¹ç‡ï¼ˆconstant bitrateï¼‰ï¼‰ æ ¼å¼ä¸ä½¿ç”¨åŒ…æè¿°ã€‚å¯¹äºCBRå½•åˆ¶ï¼ŒéŸ³é¢‘é˜Ÿåˆ—ä¼šè®¾ç½®è¿™ä¸ªå‚æ•°å¹¶ä¸”å°†<code>inPacketDescs</code>è¿™ä¸ªå‚æ•°è®¾ç½®ä¸º<code>NULL</code>ã€‚</li><li><code>inPacketDescs</code>ï¼šæ˜¯ä¸€ç»„å¯¹åº”äºç¼“å†²åŒºä¸­é‡‡æ ·çš„åŒ…æè¿°ç¬¦ï¼ŒéŸ³é¢‘é˜Ÿåˆ—æä¾›äº†è¿™ä¸ªå‚æ•°çš„å€¼ï¼Œå¦‚æœéŸ³é¢‘æ–‡ä»¶æ˜¯VBRæ ¼å¼çš„ï¼Œå›è°ƒå‡½æ•°å¯ä»¥å°†è¿™ä¸ªå€¼ä¼ é€’ç»™<code>AudioFileWritePackets</code>å‡½æ•°ï¼ˆåœ¨<code>AudioFile.h</code>å¤´æ–‡ä»¶ä¸­å£°æ˜ï¼‰ã€‚</li></ul><p>å¦‚æœè¦äº†è§£æ›´å¤šå…³äºç”¨äºå½•åˆ¶çš„å›è°ƒå‡½æ•°çš„ä¿¡æ¯ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW1">Recording Audio</a>å’Œ<a href="https://developer.apple.com/documentation/audiotoolbox/audio_queue_services">Audio Queue Services Reference</a>ã€‚</p><h4 id="ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°">ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°</h4><p>æœ¬èŠ‚ä»‹ç»äº†ä¸€èˆ¬æƒ…å†µä¸‹ï¼ˆä»ç£ç›˜æ–‡ä»¶æ’­æ”¾éŸ³é¢‘çš„å›è°ƒå‡½æ•°ã€‚ ä¸‹é¢æ˜¯ç”¨äºæ’­æ”¾çš„å›è°ƒå‡½æ•°çš„åŸå‹ï¼ˆåœ¨<code>AudioQueue.h</code>å¤´æ–‡ä»¶ä¸­å£°æ˜ï¼‰ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AudioQueueOutputCallback (</span><br><span class="line">    <span class="keyword">void</span>                  *inUserData,</span><br><span class="line">    AudioQueueRef         inAQ,</span><br><span class="line">    AudioQueueBufferRef   inBuffer</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—ï¼Œåœ¨è°ƒç”¨å›è°ƒå‡½æ•°çš„æ—¶å€™ï¼Œæä¾›äº†ä»æ–‡ä»¶è¯»å–ä¸‹ä¸€ç»„éŸ³é¢‘æ•°æ®æ‰€éœ€çš„ä¿¡æ¯ï¼š</p><ul><li><p><code>inUserData</code>ï¼šä¸€èˆ¬æ¥è¯´æ˜¯ä¸€ä¸ªä½ åˆ›å»ºçš„åŒ…å«éŸ³é¢‘é˜Ÿåˆ—å’Œå®ƒçš„ç¼“å†²åŒºçš„çš„çŠ¶æ€ä¿¡æ¯çš„è‡ªå®šä¹‰ç»“æ„ï¼›æˆ–è€…ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶å¯¹è±¡ ï¼ˆ<code>AudioFileID</code>ç±»å‹ï¼‰è¡¨ç¤ºè¦å†™å…¥çš„æ–‡ä»¶ï¼›æˆ–è€…æ–‡ä»¶çš„éŸ³é¢‘æ•°æ®æ ¼å¼ä¿¡æ¯ã€‚ åœ¨æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—çš„æƒ…å†µä¸‹ï¼Œå›è°ƒå‡½æ•°ä¼šåœ¨è¿™ä¸ªç»“æ„ä½“ä¸­ç”¨ä¸€ä¸ªå­—æ®µä¿æŒå¯¹å½“å‰åŒ…çš„ç´¢å¼•ã€‚</p></li><li><p><code>inAQ</code>ï¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°çš„éŸ³é¢‘é˜Ÿåˆ—ã€‚</p></li><li><p><code>inBuffer</code>ï¼šä¸€ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼Œç”±éŸ³é¢‘é˜Ÿåˆ—æä¾›ï¼Œå›è°ƒå°†å¡«å……ä»æ­£åœ¨æ’­æ”¾çš„æ–‡ä»¶ä¸­è¯»å–çš„ä¸‹ä¸€ç»„æ•°æ®ã€‚</p></li></ul><p>å¦‚æœç¨‹åºåœ¨æ’­æ”¾VBRæ•°æ®ï¼Œå›è°ƒå‡½æ•°éœ€è¦å¾—åˆ°æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘æ•°æ®çš„åŒ…æ•°æ®ï¼Œå®ƒé€šè¿‡è°ƒç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1503274-audiofilereadpackets"><code>AudioFileReadPackets</code></a>å‡½æ•°æ¥å®ç°ï¼Œè¿™ä¸ªå‡½æ•°å£°æ˜äº<code>AudioFile.h</code>å¤´æ–‡ä»¶ï¼Œå›è°ƒå‡½æ•°éšåæŠŠåŒ…ä¿¡æ¯æ”¾åˆ°è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ä¸­ï¼Œä»¥ä¾›éŸ³é¢‘é˜Ÿåˆ—ä½¿ç”¨ã€‚</p><p>å…³äºæ’­æ”¾å›è°ƒçš„æ›´å¤šä¿¡æ¯ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW1">Playing Audio</a>å’Œ<a href="https://developer.apple.com/documentation/audiotoolbox/audio_queue_services">Audio Queue Services Reference</a>ã€‚</p><h2 id="ä½¿ç”¨ç¼–ç å’ŒéŸ³é¢‘æ•°æ®æ ¼å¼">ä½¿ç”¨ç¼–ç å’ŒéŸ³é¢‘æ•°æ®æ ¼å¼</h2><p>éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æ ¹æ®é‡‡ç”¨çš„ç¼–è§£ç å™¨åœ¨éŸ³é¢‘æ ¼å¼ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚å½•åˆ¶æˆ–æ’­æ”¾ç¨‹åºå¯ä»¥ä½¿ç”¨ä»»æ„å·²ç»å®‰è£…è¿‡ç›¸åº”ç¼–ç å™¨çš„æ ¼å¼ï¼Œä¸éœ€è¦å†™è‡ªå®šä¹‰çš„ä»£ç æ¥å¤„ç†å„ç§éŸ³é¢‘æ ¼å¼ã€‚å°¤å…¶æ˜¯ä½ çš„å›è°ƒå‡½æ•°ä¸éœ€è¦çŸ¥é“å…¶æ•°æ®æ ¼å¼ã€‚</p><p>æ¯ä¸ªéŸ³é¢‘é˜Ÿåˆ—åœ¨<code>AudioStreamBasicDescription</code>ç»“æ„ä½“ä¸­éƒ½æœ‰ä¸€ä¸ªå­—æ®µè¡¨ç¤ºéŸ³é¢‘æ•°æ®æ ¼å¼ã€‚å½“ä½ åœ¨<code>mFormatID</code>å­—æ®µä¸­æŒ‡å®šæ ¼å¼æ—¶ï¼ŒéŸ³é¢‘é˜Ÿåˆ—ä¼šä½¿ç”¨ç›¸åº”çš„è§£ç å™¨ã€‚ç„¶åæŒ‡å®šé‡‡æ ·ç‡å’Œå£°é“æ•°ï¼Œè¿™äº›å°±æ˜¯æ‰€æœ‰ä½ éœ€è¦åšçš„ã€‚è®¾ç½®éŸ³é¢‘æ•°æ®æ ¼å¼çš„ç¤ºä¾‹ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW1">Recording Audio</a>å’Œ<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQPlayback/PlayingAudio.html#//apple_ref/doc/uid/TP40005343-CH3-SW1">Playing Audio</a>ã€‚</p><p>ç”¨äºå½•åˆ¶çš„éŸ³é¢‘é˜Ÿåˆ—æŒ‰ç…§å›¾1-5ä¸­çš„æµç¨‹ä½¿ç”¨å·²å®‰è£…çš„ç¼–ç å™¨ã€‚</p><p><strong>å›¾1-5</strong> åœ¨å½•åˆ¶éŸ³é¢‘çš„æ—¶å€™è¿›è¡ŒéŸ³é¢‘æ ¼å¼è½¬æ¢</p><figure><img src="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/Art/recording_codec_2x.png" alt="Using a code when recording with an audio queue" /><figcaption aria-hidden="true">Using a code when recording with an audio queue</figcaption></figure><ol type="1"><li>ç¨‹åºå‘Šè¯‰éŸ³é¢‘é˜Ÿåˆ—å¼€å§‹å½•åˆ¶ï¼ŒåŒæ—¶ä¹Ÿå‘Šè¯‰å®ƒæ‰€è¦ä½¿ç”¨çš„éŸ³é¢‘æ ¼å¼ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—è·å–æ–°çš„éŸ³é¢‘æ•°æ®ï¼Œå¹¶ä¸”æ ¹æ®ä½ æŒ‡å®šçš„æ ¼å¼ä½¿ç”¨ç›¸åº”çš„ç¼–ç å™¨è½¬æ¢éŸ³é¢‘æ•°æ®ã€‚ç„¶åéŸ³é¢‘é˜Ÿåˆ—è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå°†é€‚å½“çš„æ ¼å¼åŒ–è¿‡çš„éŸ³é¢‘æ•°æ®æ”¾è¿›ç¼“å†²åŒºä¸­ã€‚</li><li>å›è°ƒå‡½æ•°å°†æ ¼å¼åŒ–åçš„éŸ³é¢‘æ•°æ®å†™å…¥ç£ç›˜ã€‚å›è°ƒå‡½æ•°ä¸éœ€è¦çŸ¥é“æ•°æ®æ ¼å¼ã€‚</li></ol><p>ç”¨äºæ’­æ”¾çš„éŸ³é¢‘é˜Ÿåˆ—æŒ‰ç…§å›¾1-6çš„æµç¨‹ä½¿ç”¨å·²å®‰è£…çš„ç¼–ç å™¨ã€‚</p><p><strong>å›¾1-6</strong> åœ¨æ’­æ”¾è¿‡ç¨‹ä¸­è¿›è¡ŒéŸ³é¢‘æ ¼å¼è½¬æ¢</p><figure><img src="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/Art/playback_codec_2x.png" alt="Using a codec when playing a file with an audio queue" /><figcaption aria-hidden="true">Using a codec when playing a file with an audio queue</figcaption></figure><ol type="1"><li>ç¨‹åºå‘Šè¯‰éŸ³é¢‘é˜Ÿåˆ—å¼€å§‹æ’­æ”¾ï¼ŒåŒæ—¶ä¹Ÿå‘Šè¯‰äº†å®ƒå°†è¦æ’­æ”¾æ”¾çš„éŸ³é¢‘æ–‡ä»¶çš„æ•°æ®æ ¼å¼ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—è°ƒç”¨å›è°ƒå‡½æ•°æ¥ä»éŸ³é¢‘æ–‡ä»¶ä¸­è¯»å–éŸ³é¢‘æ•°æ®ã€‚å›è°ƒå‡½æ•°æŒ‰ç…§å®ƒçš„åŸå§‹æ ¼å¼å°†éŸ³é¢‘æ•°æ®äº¤ä»˜ç»™éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—ä½¿ç”¨å¯¹åº”çš„è§£ç å™¨å°†éŸ³é¢‘äº¤ä»˜ç»™ç›®æ ‡è¾“å‡ºè®¾å¤‡ã€‚</li></ol><p>éŸ³é¢‘é˜Ÿåˆ—å¯ä»¥ä½¿ç”¨ä»»æ„å·²å®‰è£…çš„ç¼–ç å™¨ï¼Œæ— è®ºæ˜¯Mac OS XåŸç”Ÿçš„è¿˜æ˜¯ç¬¬ä¸‰æ–¹çš„ã€‚ä½ å¯ä»¥é€šè¿‡æŒ‡å®šéŸ³é¢‘é˜Ÿåˆ—çš„<code>AudioStreamBasicDescription</code>ç»“æ„ä½“ä¸­å››å­—èŠ‚ç¼–ç IDæ¥æŒ‡å®šå°†è¦ä½¿ç”¨çš„ç¼–ç å™¨ã€‚è¯¥å­—æ®µçš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/AQRecord/RecordingAudio.html#//apple_ref/doc/uid/TP40005343-CH4-SW1">Recording Audio</a>ã€‚</p><p>Mac OS XåŒ…å«å¤§é‡çš„ç¼–ç å™¨ï¼Œåœ¨<code>CoreAudioTypes.h</code>å¤´æ–‡ä»¶ä¸­çš„format IDsæšä¸¾å€¼ä¸­åˆ—å‡ºï¼Œå¹¶ä¸”è®°å½•åœ¨_<a href="https://developer.apple.com/documentation/coreaudio/core_audio_data_types">Core Audio Data Types Reference</a>_ä¸­ã€‚ä½ å¯ä»¥ä½¿ç”¨Audio Toolboxæ¡†æ¶ä¸­<code>AudioFormat.h</code>å¤´æ–‡ä»¶ä¸­çš„æ¥å£æ¥æŸ¥è¯¢å½“å‰ç³»ç»Ÿå¯ç”¨çš„ç¼–ç å™¨ã€‚ä½ å¯ä»¥ä½¿ç”¨Fiendishthngsç¨‹åºæ¥æ˜¾ç¤ºç³»ç»Ÿçš„ç¼–ç å™¨ï¼Œè¯¥ç¤ºä¾‹ä»£ç å¯ä»¥ä»<a href="http://developer.apple.com/samplecode/Fiendishthngs/.">http://developer.apple.com/samplecode/Fiendishthngs/</a>è·å¾—ã€‚</p><h2 id="éŸ³é¢‘é˜Ÿåˆ—æ§åˆ¶å’ŒçŠ¶æ€">éŸ³é¢‘é˜Ÿåˆ—æ§åˆ¶å’ŒçŠ¶æ€</h2><p>éŸ³é¢‘é˜Ÿåˆ—çš„ç”Ÿå‘½å‘¨æœŸä»åˆ›å»ºåˆ°åºŸå¼ƒã€‚ç¨‹åºç®¡ç†å™¨ç”Ÿå‘½å‘¨æœŸï¼Œä¸”æ§åˆ¶éŸ³é¢‘é˜Ÿåˆ—çš„çŠ¶æ€ï¼Œé€šè¿‡ä½¿ç”¨<code>AudioQueue.h</code>å¤´æ–‡ä»¶ä¸­çš„å…­ä¸ªå‡½æ•°ï¼š</p><ul><li><strong>Start</strong>ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1502689-audioqueuestart"><code>AudioQueueStart</code></a>ï¼‰ï¼šåˆå§‹åŒ–å½•åˆ¶æˆ–è€…æ’­æ”¾ã€‚</li><li><strong>Prime</strong> ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1503220-audioqueueprime"><code>AudioQueuePrime</code></a>ï¼‰ï¼šå¯¹äºæ’­æ”¾, åœ¨è°ƒç”¨<code>AudioQueueStart</code>ä¹‹å‰è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä»¥ç¡®ä¿æœ‰æ•°æ®å¯ç«‹å³ç”¨äºéŸ³é¢‘é˜Ÿåˆ—çš„æ’­æ”¾ã€‚è¿™ä¸ªå‡½æ•°ä¸åœ¨å½•åˆ¶ä¸­ä½¿ç”¨ã€‚</li><li><strong>Stop</strong>ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1501970-audioqueuestop"><code>AudioQueueStop</code></a>ï¼‰ï¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥é‡ç½®éŸ³é¢‘é˜Ÿåˆ— ï¼ˆå‚è€ƒä¸‹é¢å¯¹<code>AudioQueueReset</code>çš„æè¿°ï¼‰ï¼Œç„¶ååœæ­¢å½•åˆ¶æˆ–æ’­æ”¾ã€‚å½“æ²¡æœ‰æ›´å¤šçš„æ•°æ®è¦æ’­æ”¾æ—¶ï¼Œæ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—å›è°ƒè°ƒç”¨è¯¥å‡½æ•°ã€‚</li><li><strong>Pause</strong>ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1502109-audioqueuepause"><code>AudioQueuePause</code></a>ï¼‰ï¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥åœ¨ä¸å½±å“ç¼“å†²åŒºå’Œä¸é‡ç½®éŸ³é¢‘é˜Ÿåˆ—çš„æƒ…å†µä¸‹åœæ­¢å½•åˆ¶æˆ–æ’­æ”¾ã€‚å¦‚æœéœ€è¦æ¢å¤ï¼Œè°ƒç”¨<code>AudioQueueStart</code>å‡½æ•°ã€‚</li><li><strong>Flush</strong> ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1502477-audioqueueflush"><code>AudioQueueFlush</code></a>ï¼‰ï¼šåœ¨å¯¹æœ€åä¸€ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºè¿›è¡Œæ’é˜Ÿåè°ƒç”¨ï¼Œä»¥ç¡®ä¿æ‰€æœ‰ç¼“å†²çš„æ•°æ®ä»¥åŠæ‰€æœ‰æ­£åœ¨å¤„ç†çš„éŸ³é¢‘æ•°æ®è¢«è®°å½•æˆ–æ’­æ”¾ã€‚</li><li><strong>Reset</strong> ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1502329-audioqueuereset"><code>AudioQueueReset</code></a>ï¼‰ï¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥ç«‹å³è®©éŸ³é¢‘é˜Ÿåˆ—é™éŸ³ã€‚ç§»é™¤ä¹‹å‰è°ƒåº¦è¿‡çš„ç¼“å†²åŒºï¼Œå¹¶ä¸”é‡ç½®æ‰€æœ‰è§£ç å™¨å’ŒDSPçŠ¶æ€ã€‚</li></ul><p>ä½ å¯ä»¥åœ¨åŒæ­¥æˆ–å¼‚æ­¥æ¨¡å¼ä¸‹ä½¿ç”¨<code>AudioQueueStop</code>å‡½æ•°ï¼š</p><ul><li><strong>åŒæ­¥</strong>ï¼šç«‹åˆ»åœæ­¢ï¼Œä¸è€ƒè™‘ä¹‹å‰ç¼“å†²çš„éŸ³é¢‘æ•°æ®ã€‚</li><li><strong>å¼‚æ­¥</strong>ï¼šåœ¨æ‰€æœ‰å·²å…¥é˜Ÿçš„ç¼“å†²åŒºæ’­æ”¾æˆ–å½•åˆ¶å®Œæ¯•ä¹‹åå†åœæ­¢ã€‚</li></ul><p>æ‰€æœ‰è¿™äº›å‡½æ•°çš„å®Œæ•´æè¿°å’ŒåŒæ­¥å¼‚æ­¥åœæ­¢éŸ³é¢‘é˜Ÿåˆ—çš„æ›´å¤šä¿¡æ¯ï¼Œå‚é˜…_<a href="https://developer.apple.com/documentation/audiotoolbox/audio_queue_services">Audio Queue Services Reference</a>_ã€‚</p><h2 id="éŸ³é¢‘é˜Ÿåˆ—å‚æ•°">éŸ³é¢‘é˜Ÿåˆ—å‚æ•°</h2><p>éŸ³é¢‘é˜Ÿåˆ—é€šè¿‡<strong>å‚æ•°ï¼ˆparametersï¼‰</strong>è°ƒæ•´é…ç½®ã€‚æ¯ä¸ªå‚æ•°éƒ½ä½¿ç”¨æšä¸¾å€¼ä½œä¸ºé”®ï¼Œæµ®ç‚¹æ•°ä½œä¸ºå€¼ã€‚å‚æ•°ä¸€èˆ¬äºæ’­æ”¾ï¼Œä¸ç”¨äºå½•åˆ¶ã€‚</p><p>åœ¨Mac OS X v10.5ä¸­ï¼Œåªæœ‰æ’­æ”¾å¢ç›Šå‚æ•°ã€‚å¯ä»¥é€šè¿‡ä½¿ç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/kaudioqueueparam_volume"><code>kAudioQueueParam_Volume</code></a>å¸¸é‡æ¥è·å–æˆ–è®¾ç½®å®ƒçš„å€¼ï¼Œå®ƒçš„æœ‰æ•ˆèŒƒå›´åœ¨0.0ï¼ˆé™éŸ³ï¼‰åˆ°1.0ï¼ˆå•ä½å¢ç›Šï¼‰ã€‚</p><p>ç¨‹åºå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹æ³•æ¥è®¾ç½®éŸ³é¢‘é˜Ÿåˆ—å‚æ•°ï¼š</p><ul><li>å¯¹äºæ¯ä¸€ä¸ªéŸ³é¢‘é˜Ÿåˆ—ï¼Œä½¿ç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1503293-audioqueuesetparameter"><code>AudioQueueSetParameter</code></a>å‡½æ•°ï¼Œè¿™å¯ä»¥è®©ä½ ç›´æ¥æ”¹å˜éŸ³é¢‘é˜Ÿåˆ—çš„è®¾ç½®ï¼Œè¿™ä¸ªæ”¹å˜æ˜¯ç«‹åˆ»ç”Ÿæ•ˆçš„ã€‚</li><li>å¯¹äºæ¯ä¸€ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼Œè°ƒç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1503258-audioqueueenqueuebufferwithparam"><code>AudioQueueEnqueueBufferWithParameters</code></a>å‡½æ•°ã€‚è¿™å¯ä»¥è®©ä½ åœ¨å°†éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå…¥é˜Ÿçš„æ—¶å€™è®¾ç½®éŸ³é¢‘é˜Ÿåˆ—è®¾ç½®ã€‚è¿™ç§ä¿®æ”¹åªä¼šåœ¨æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„æ—¶å€™ç”Ÿæ•ˆã€‚</li></ul><p>è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼ŒéŸ³é¢‘é˜Ÿåˆ—çš„å‚æ•°è®¾ç½®ä¼šä¸€ç›´ä¿ç•™åˆ°ä½ æ”¹å˜å®ƒä»¬ä¸ºæ­¢ã€‚</p><p>å¯ä»¥é€šè¿‡è°ƒç”¨<a href="https://developer.apple.com/documentation/audiotoolbox/1503353-audioqueuegetparameter"><code>AudioQueueGetParameter</code></a>å‡½æ•°æ¥è·å–éŸ³é¢‘é˜Ÿåˆ—å½“å‰çš„å‚æ•°ã€‚è¯¥å‡½æ•°çš„å®Œæ•´æè¿°å’Œè·å–å’Œè®¾ç½®å‚æ•°å€¼çš„æ–¹æ³•ï¼Œå‚é˜…_<a href="https://developer.apple.com/documentation/audiotoolbox/audio_queue_services">Audio Queue Services Reference</a>_ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><ul><li>éŸ³é¢‘é˜Ÿåˆ—å·¥ä½œï¼š<ul><li>è¿æ¥éŸ³é¢‘ç¡¬ä»¶</li><li>å†…å­˜ç®¡ç†</li><li>æ ¹æ®éœ€è¦ä¸ºå·²å‹ç¼©çš„éŸ³é¢‘æ ¼å¼å¼•å…¥ç¼–ç å™¨</li><li>åª’ä½“çš„å½•åˆ¶æˆ–æ’­æ”¾</li></ul></li><li>ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—çš„åŸºæœ¬ç»„æˆï¼š<ul><li>ä¸€ç»„éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼Œæ¯ä¸ªç¼“å†²åŒºä¸´æ—¶å­˜å‚¨éŸ³é¢‘æ•°æ®ã€‚</li><li>ç¼“å†²åŒºé˜Ÿåˆ—ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—å›è°ƒå‡½æ•°ã€‚</li></ul></li><li>éŸ³é¢‘é˜Ÿåˆ—æŒ‰ç”¨é€”åˆ†ç±»ï¼š<ul><li>å½•åˆ¶<ul><li>è¾“å…¥ç«¯ï¼šéŸ³é¢‘è¾“å…¥ç¡¬ä»¶ã€‚</li><li>è¾“å‡º/å›è°ƒï¼šéŸ³é¢‘æ•°æ®</li></ul></li><li>æ’­æ”¾<ul><li>è¾“å…¥/å›è°ƒï¼šè·å–éŸ³é¢‘æ•°æ®å¹¶äº¤ä»˜ç»™éŸ³é¢‘é˜Ÿåˆ—ã€‚ä¸”å½“æ²¡æœ‰æ›´å¤šéŸ³é¢‘æ•°æ®è¦æ’­æ”¾æ—¶åœæ­¢éŸ³é¢‘é˜Ÿåˆ—ã€‚</li><li>è¾“å‡ºï¼šéŸ³é¢‘è¾“å‡ºè®¾å¤‡ã€‚</li></ul></li></ul></li><li>éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºæ•°é‡ä¸€èˆ¬è®¾ç½®ä¸º3ï¼Œå¯¹åº”å½•åˆ¶ï¼šä¸€ä¸ªç”¨äºå†™å…¥ç£ç›˜ï¼Œä¸€ä¸ªå¡«å……æ–°éŸ³é¢‘æ•°æ®ï¼Œä¸€ä¸ªåœ¨éœ€è¦ç£ç›˜I/Oå»¶è¿Ÿè¡¥å¿æ—¶ä½¿ç”¨ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—ç®¡ç†äº†éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºçš„ç”Ÿå‘½å‘¨æœŸ/å†…å­˜ï¼š<code>AudioQueueAllocateBuffer</code>åˆ›å»ºï¼Œ<code>AudioQueueDispose</code>é‡Šæ”¾éŸ³é¢‘é˜Ÿåˆ—æ—¶ä¹Ÿä¸€èµ·é‡Šæ”¾å…¶ç¼“å†²åŒºã€‚</li><li>æ’­æ”¾è¿‡ç¨‹é€šè¿‡<code>AudioQueueEnqueueBufferWithParameters</code>æ¥å®ç°æ’­æ”¾æ§åˆ¶ï¼š<ul><li>è®¾ç½®ç¼“å†²åŒºçš„ç²¾ç¡®æ’­æ”¾æ—¶é—´ï¼Œè¿™å¯ä»¥å®ç°éŸ³é¢‘åŒæ­¥ã€‚</li><li>æˆªæ–­éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºå¼€å¤´æˆ–ç»“å°¾çš„å¸§ï¼Œè¿™å¯ä»¥è®©ä½ å»é™¤å¼€å¤´æˆ–ç»“å°¾çš„é™éŸ³ã€‚</li><li>åœ¨ç¼“å†²åŒºçš„ç²’åº¦ä¸Šè®¾ç½®æ’­æ”¾å¢ç›Šã€‚</li></ul></li><li>éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡çš„ç¼–ç å¤§éƒ¨åˆ†éƒ½åœ¨å…¶å›è°ƒå‡½æ•°ä¸Šã€‚å½•åˆ¶ä½¿ç”¨<code>AudioQueueInputCallback</code>å‡½æ•°åŸå‹ï¼Œæ’­æ”¾ä½¿ç”¨<code>AudioQueueOutputCallback</code>å‡½æ•°åŸå‹ã€‚</li><li>å›è°ƒå‡½æ•°è°ƒç”¨çš„é—´éš”å–å†³äºç¼“å†²åŒºçš„å®¹é‡ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—å›è°ƒçš„ä»»åŠ¡æ˜¯è¿”å›é˜Ÿåˆ—ç¼“å†²åŒºã€‚ä½¿ç”¨<code>AudioQueueEnqueueBuffer</code>å…¥é˜Ÿç¼“å†²åŒºã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—åœ¨å½•åˆ¶å’Œæ’­æ”¾è¿‡ç¨‹ä¸­éƒ½å¯ä»¥è¿›è¡Œæ ¼å¼è½¬æ¢ã€‚å›è°ƒå‡½æ•°ä¸éœ€è¦çŸ¥é“éŸ³é¢‘æ ¼å¼ï¼Œå› ä¸ºéŸ³é¢‘ç¼–ç å™¨éƒ½æ˜¯æå‰ç»™éŸ³é¢‘é˜Ÿåˆ—é…ç½®çš„ã€‚</li><li>éŸ³é¢‘é˜Ÿåˆ—çš„çŠ¶æ€æ§åˆ¶ï¼š<ul><li><strong>Start</strong>ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1502689-audioqueuestart"><code>AudioQueueStart</code></a>ï¼‰ï¼šåˆå§‹åŒ–å½•åˆ¶æˆ–è€…æ’­æ”¾ã€‚</li><li><strong>Prime</strong> ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1503220-audioqueueprime"><code>AudioQueuePrime</code></a>ï¼‰ï¼šä»…ç”¨äºæ’­æ”¾, åœ¨è°ƒç”¨<code>AudioQueueStart</code>ä¹‹å‰è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä»¥ç¡®ä¿æœ‰æ•°æ®å¯ç«‹å³ç”¨äºéŸ³é¢‘é˜Ÿåˆ—çš„æ’­æ”¾ã€‚</li><li><strong>Stop</strong>ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1501970-audioqueuestop"><code>AudioQueueStop</code></a>ï¼‰ï¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥é‡ç½®éŸ³é¢‘é˜Ÿåˆ— ï¼ˆå‚è€ƒä¸‹é¢å¯¹<code>AudioQueueReset</code>çš„æè¿°ï¼‰ï¼Œç„¶ååœæ­¢å½•åˆ¶æˆ–æ’­æ”¾ã€‚å½“æ²¡æœ‰æ›´å¤šçš„æ•°æ®è¦æ’­æ”¾æ—¶ï¼Œå›è°ƒä¸­è°ƒç”¨è¯¥å‡½æ•°ã€‚</li><li><strong>Pause</strong>ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1502109-audioqueuepause"><code>AudioQueuePause</code></a>ï¼‰ï¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥åœ¨ä¸å½±å“ç¼“å†²åŒºå’Œä¸é‡ç½®éŸ³é¢‘é˜Ÿåˆ—çš„æƒ…å†µä¸‹åœæ­¢å½•åˆ¶æˆ–æ’­æ”¾ã€‚å¦‚æœéœ€è¦æ¢å¤ï¼Œè°ƒç”¨<code>AudioQueueStart</code>å‡½æ•°ã€‚</li><li><strong>Flush</strong> ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1502477-audioqueueflush"><code>AudioQueueFlush</code></a>ï¼‰ï¼šåœ¨å¯¹æœ€åä¸€ä¸ªéŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºè¿›è¡Œæ’é˜Ÿåè°ƒç”¨ï¼Œä»¥ç¡®ä¿æ‰€æœ‰ç¼“å†²çš„æ•°æ®ä»¥åŠæ‰€æœ‰æ­£åœ¨å¤„ç†çš„éŸ³é¢‘æ•°æ®è¢«è®°å½•æˆ–æ’­æ”¾ã€‚</li><li><strong>Reset</strong> ï¼ˆ<a href="https://developer.apple.com/documentation/audiotoolbox/1502329-audioqueuereset"><code>AudioQueueReset</code></a>ï¼‰ï¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥ç«‹å³è®©éŸ³é¢‘é˜Ÿåˆ—é™éŸ³ã€‚ç§»é™¤ä¹‹å‰è°ƒåº¦è¿‡çš„ç¼“å†²åŒºï¼Œå¹¶ä¸”é‡ç½®æ‰€æœ‰è§£ç å™¨å’ŒDSPçŠ¶æ€ã€‚</li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬ç« å°†å­¦ä¹ åˆ°éŸ³é¢‘é˜Ÿåˆ—çš„åŠŸèƒ½ã€æ¶æ„å’Œå†…éƒ¨å·¥ä½œåŸç†ã€‚æœ¬æ–‡ä»‹ç»éŸ³é¢‘é˜Ÿåˆ—ç”¨æ¥æ’­æ”¾æˆ–å½•åˆ¶æ‰€ç”¨çš„éŸ³é¢‘é˜Ÿåˆ—ï¼ˆaudio queuesï¼‰ã€éŸ³é¢‘é˜Ÿåˆ—ç¼“å†²åŒºï¼ˆaudio queue buffersï¼‰å’Œå›è°ƒå‡½æ•°ï¼Œä½ è¿˜å¯ä»¥æ‰¾åˆ°å…³äºéŸ³é¢‘é˜Ÿåˆ—çŠ¶æ€å’Œå‚æ•°çš„ä¿¡æ¯ï¼Œæˆªè‡³åˆ°æœ¬ç« çš„ç»“å°¾ï¼Œä½ å°†ä¼šè·å¾—æœ‰æ•ˆä½¿ç”¨è¯¥æŠ€æœ¯çš„æ¦‚å¿µæ€§ç†è§£ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Audio Queue Services Programming Guide" scheme="https://bqlin.github.io/tags/Audio-Queue-Services-Programming-Guide/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>Audio Queue Services Programming Guide</title>
    <link href="https://bqlin.github.io/posts/audio_queue_services_pg_introduction/"/>
    <id>https://bqlin.github.io/posts/audio_queue_services_pg_introduction/</id>
    <published>2021-09-27T04:15:11.000Z</published>
    <updated>2021-09-27T04:15:11.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä»‹ç»">ä»‹ç»</h1><p>æœ¬æ–‡æ¡£ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡ï¼ˆAudio Queue Servicesï¼‰ï¼Œè¿™æ˜¯CoreÂ Audioçš„AudioÂ Toolboxæ¡†æ¶ä¸­çš„ä¸€ä¸ªCè¯­è¨€ç¼–ç¨‹æ¥å£ã€‚</p><span id="more"></span><h2 id="ä»€ä¹ˆæ˜¯éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡">ä»€ä¹ˆæ˜¯éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡</h2><p>åœ¨iOSå’ŒMac OS Xä¸­ï¼ŒéŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æä¾›äº†ä¸€ç§ç›´æ¥ã€ä½å¼€é”€çš„çš„æ–¹å¼æ¥å½•åˆ¶å’Œæ’­æ”¾éŸ³é¢‘ã€‚è¿™ä¹Ÿæ˜¯å‘iOSå’ŒMac OS Xç¨‹åºä¸­æ·»åŠ å½•åˆ¶å’Œæ’­æ”¾åŠŸèƒ½æ‰€æ¨èä½¿ç”¨çš„æŠ€æœ¯ã€‚</p><p>éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡å…è®¸ä½ å½•åˆ¶å’Œæ’­æ”¾ä»¥ä¸‹æ ¼å¼çš„éŸ³é¢‘ï¼š</p><ul><li>Linear PCMï¼ˆçº¿æ€§PCMï¼‰ã€‚</li><li>ä»»ä½•ä½ æ­£åœ¨è¿›è¡Œå¼€å‘çš„è‹¹æœå¹³å°æ‰€åŸç”Ÿæ”¯æŒçš„å‹ç¼©æ ¼å¼ã€‚</li><li>ä»»ä½•ç”¨æˆ·å·²ç»å®‰è£…ç›¸åº”ç¼–ç å™¨çš„å…¶ä»–æ ¼å¼ã€‚</li></ul><p>éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æ˜¯é«˜çº§çš„ã€‚å®ƒè®©ç¨‹åºä½¿ç”¨å½•éŸ³å’Œæ’­æ”¾è®¾å¤‡ï¼ˆæ¯”å¦‚éº¦å…‹é£å’Œæ‰¬å£°å™¨ï¼‰è€Œä¸éœ€è¦äº†è§£ç¡¬ä»¶æ¥å£çš„çŸ¥è¯†ã€‚ä¹Ÿå¯ä»¥è®©ä½ ä½¿ç”¨å¤æ‚çš„ç¼–ç å™¨è€Œä¸ç”¨äº†è§£ç¼–ç å™¨çš„å·¥ä½œæœºåˆ¶ã€‚</p><p>åŒæ—¶ï¼ŒéŸ³é¢‘é˜Ÿåˆ—æœåŠ¡ä¹Ÿæ”¯æŒä¸€äº›é«˜çº§åŠŸèƒ½ã€‚æä¾›äº†é«˜ç²¾åº¦çš„æ—¶é—´æ§åˆ¶æ¥æ”¯æŒæ’­æ”¾è¿›åº¦å’ŒåŒæ­¥ã€‚ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥åŒæ­¥å¤šä¸ªéŸ³é¢‘é˜Ÿåˆ—ä»¥åŠè®©è§†é¢‘å’ŒéŸ³é¢‘åŒæ­¥ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong>éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æä¾›äº†ä¸€äº›ç±»ä¼¼äºä¹‹å‰åœ¨Mac OS Xä¸­Sound Manageræä¾›çš„åŠŸèƒ½ï¼Œå®ƒé™„åŠ äº†ä¾‹å¦‚åŒæ­¥çš„åŠŸèƒ½ï¼ŒSound Manageråœ¨Mac OS X10.5ä¸­å·²ç»åºŸå¼ƒäº†ï¼Œå¹¶ä¸”ä¸èƒ½å’Œ64ä½ç¨‹åºä¸€èµ·å·¥ä½œï¼Œè‹¹æœå»ºè®®æ–°çš„Mac OS Xç¨‹åºä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡å¹¶å°†æ—§çš„ç¨‹åºç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æ¥æ›¿æ¢Sound Managerã€‚</p></blockquote><p>éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æ˜¯çº¯Cæ¥å£çš„ï¼Œä½ å¯ä»¥æŠŠå®ƒä½¿ç”¨åœ¨Cocoaå’ŒMac OS Xå‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œä¸ºäº†ä½¿ä½ æ›´åŠ ä¸“æ³¨äºéŸ³é¢‘é˜Ÿåˆ—æœåŠ¡ï¼Œæœ¬æ–‡æ¡£ä¸­çš„ç¤ºä¾‹ä»£ç é€šè¿‡ä½¿ç”¨Core Audio SDKä¸­çš„C++ç±»è¿›è¡Œäº†ç®€åŒ–ï¼Œç„¶è€Œï¼Œæ— è®ºæ˜¯è¿™ä¸ªSDKè¿˜æ˜¯C++è¯­è¨€éƒ½ä¸æ˜¯ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡æ‰€å¿…éœ€çš„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ä»‹ç»&quot;&gt;ä»‹ç»&lt;/h1&gt;
&lt;p&gt;æœ¬æ–‡æ¡£ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨éŸ³é¢‘é˜Ÿåˆ—æœåŠ¡ï¼ˆAudio Queue Servicesï¼‰ï¼Œè¿™æ˜¯CoreÂ Audioçš„AudioÂ Toolboxæ¡†æ¶ä¸­çš„ä¸€ä¸ªCè¯­è¨€ç¼–ç¨‹æ¥å£ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Audio Queue Services Programming Guide" scheme="https://bqlin.github.io/tags/Audio-Queue-Services-Programming-Guide/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>Concurrency Programming Guideï¼šæœ¯è¯­è¡¨</title>
    <link href="https://bqlin.github.io/posts/concurrency_pg_glossary/"/>
    <id>https://bqlin.github.io/posts/concurrency_pg_glossary/</id>
    <published>2021-09-08T09:45:58.000Z</published>
    <updated>2021-10-24T04:12:53.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>ç¨‹åº application</strong></p><p>A specific style of <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW13">program</a> that displays a graphical interface to the user.</p><p>ä¸€ç§ç‰¹å®šé£æ ¼çš„å‘ç”¨æˆ·æ˜¾ç¤ºå›¾å½¢ç•Œé¢çš„<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW13">program</a>ã€‚</p><span id="more"></span><hr /><p><strong>å¼‚æ­¥è®¾è®¡æ³• asynchronous design approach</strong></p><p>The principle of organizing an application around blocks of code that can be run concurrently with an applicationâ€™s main thread or other threads of execution. Asynchronous tasks are started by one thread but actually run on a different thread, taking advantage of additional processor resources to finish their work more quickly.</p><p>å›´ç»•å¯ä¸ç¨‹åºä¸»çº¿ç¨‹æˆ–å…¶ä»–æ‰§è¡Œçº¿ç¨‹åŒæ—¶è¿è¡Œçš„blockæ¥ç»„ç»‡ç¨‹åºçš„åŸåˆ™ã€‚å¼‚æ­¥ä»»åŠ¡ç”±ä¸€ä¸ªçº¿ç¨‹å¯åŠ¨ï¼Œä½†å®é™…ä¸Šåœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¿è¡Œï¼Œåˆ©ç”¨é¢å¤–çš„å¤„ç†å™¨èµ„æºï¼Œæ›´å¿«å®Œæˆå·¥ä½œã€‚</p><hr /><p><strong>block object</strong></p><p>A C construct for encapsulating inline code and data so that it can be performed later. You use blocks to encapsulate tasks you want to perform, either inline in the current thread or on a separate thread using a dispatch queue. For more information, see <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Blocks/Articles/00_Introduction.html#//apple_ref/doc/uid/TP40007502">Blocks Programming Topics</a>.</p><p>ä¸€ç§Cç»“æ„ï¼Œç”¨äºå°è£…å†…è”ä»£ç å’Œæ•°æ®ï¼Œä»¥ä¾¿ä»¥åæ‰§è¡Œã€‚ä½ å¯ä»¥ä½¿ç”¨blockæ¥å°è£…ä½ æƒ³æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¯ä»¥åœ¨å½“å‰çº¿ç¨‹ä¸­å†…è”ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—ã€‚äº†è§£æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Blocks/Articles/00_Introduction.html#//apple_ref/doc/uid/TP40007502">Blocks Programming Topics</a>ã€‚</p><hr /><p><strong>å¹¶å‘æ“ä½œ concurrent operation</strong></p><p>An operation object that does not perform its task in the thread from which its <code>start</code> method was called. A concurrent operation typically sets up its own thread or calls an interface that sets up a separate thread on which to perform the work.</p><p>ä¸€ä¸ªæ“ä½œå¯¹è±¡ï¼Œå®ƒä¸åœ¨è°ƒç”¨å…¶<code>start</code>æ–¹æ³•çš„çº¿ç¨‹ä¸­æ‰§è¡Œå…¶ä»»åŠ¡ã€‚ä¸€ä¸ªå¹¶å‘æ“ä½œé€šå¸¸ä¼šè®¾ç½®è‡ªå·±çš„çº¿ç¨‹ï¼Œæˆ–è€…è°ƒç”¨ä¸€ä¸ªæ¥å£ï¼Œè®¾ç½®ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥æ‰§è¡Œå·¥ä½œã€‚</p><hr /><p><strong>æ¡ä»¶ condition</strong></p><p>A construct used to synchronize access to a resource. A thread waiting on a condition is not allowed to proceed until another thread explicitly signals the condition.</p><p>ä¸€ä¸ªç”¨äºåŒæ­¥è®¿é—®èµ„æºçš„ç»“æ„ã€‚åœ¨ä¸€ä¸ªæ¡ä»¶ä¸‹ç­‰å¾…çš„çº¿ç¨‹ä¸å…è®¸ç»§ç»­è¿›è¡Œï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ˜ç¡®å‘å‡ºæ¡ä»¶ä¿¡å·ã€‚</p><hr /><p><strong>å…³é”®éƒ¨åˆ† critical section</strong></p><p>A portion of code that must be executed by only one thread at a time.</p><p>ä¸€æ¬¡åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„éƒ¨åˆ†ä»£ç ã€‚</p><hr /><p><strong>è‡ªå®šä¹‰æº custom source</strong></p><p>A <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW19">dispatch source</a> used to process application-defined events. A custom source calls your custom event handler in response to events that your application generates.</p><p>ä¸€ä¸ªç”¨äºhandlerå®šä¹‰çš„äº‹ä»¶çš„è°ƒåº¦æºã€‚è‡ªå®šä¹‰æºè°ƒç”¨è‡ªå®šä¹‰äº‹ä»¶handlerï¼Œä»¥å“åº”ç¨‹åºäº§ç”Ÿçš„äº‹ä»¶ã€‚</p><hr /><p><strong>æè¿°ç¬¦ descriptor</strong></p><p>An abstract identifier used to access a file, socket, or other system resource.</p><p>ç”¨äºè®¿é—®æ–‡ä»¶ã€å¥—æ¥å­—æˆ–å…¶ä»–ç³»ç»Ÿèµ„æºçš„ä¸€ä¸ªæŠ½è±¡æ ‡è¯†ç¬¦ã€‚</p><hr /><p><strong>è°ƒåº¦é˜Ÿåˆ— dispatch queue</strong></p><p>A <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW23">Grand Central Dispatch (GCD)</a> structure that you use to execute your applicationâ€™s tasks. GCD defines dispatch queues for executing tasks either serially or concurrently.</p><p>ä¸€ä¸ªGCDæ•°æ®ç»“æ„ï¼Œç”¨å®ƒæ¥æ‰§è¡Œç¨‹åºçš„ä»»åŠ¡ã€‚GCDå®šä¹‰äº†ç”¨äºä¸²è¡Œæˆ–å¹¶å‘æ‰§è¡Œä»»åŠ¡çš„è°ƒåº¦é˜Ÿåˆ—ã€‚</p><hr /><p><strong>è°ƒåº¦æº dispatch source</strong></p><p>A <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW23">Grand Central Dispatch (GCD)</a> data structure that you create to process system-related events.</p><p>ä¸€ä¸ªGCDæ•°æ®ç»“æ„ï¼Œåˆ›å»ºå®ƒæ¥å¤„ç†ç³»ç»Ÿç›¸å…³äº‹ä»¶ã€‚</p><hr /><p><strong>æè¿°ç¬¦è°ƒåº¦æº descriptor dispatch source</strong></p><p>A <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW19">dispatch source</a> used to process file-related events. A file descriptor source calls your custom event handler either when file data is available for reading or writing or in response to file system changes.</p><p>ä¸€ä¸ªç”¨äºå¤„ç†æ–‡ä»¶ç›¸å…³äº‹ä»¶çš„è°ƒåº¦æºã€‚æ–‡ä»¶æè¿°ç¬¦æºåœ¨æ–‡ä»¶æ•°æ®å¯ä¾›è¯»å†™æ—¶æˆ–åœ¨æ–‡ä»¶ç³»ç»Ÿå˜åŒ–æ—¶è°ƒç”¨è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨ã€‚</p><hr /><p><strong>åŠ¨æ€å…±äº«åº“ dynamic shared library</strong></p><p>A binary executable that is loaded dynamically into an applicationâ€™s process space rather than linked statically as part of the application binary.</p><p>ä¸€ä¸ªäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒè¢«åŠ¨æ€åŠ è½½åˆ°ç¨‹åºçš„è¿›ç¨‹ç©ºé—´ï¼Œè€Œä¸æ˜¯ä½œä¸ºç¨‹åºäºŒè¿›åˆ¶çš„ä¸€éƒ¨åˆ†é™æ€é“¾æ¥ã€‚</p><hr /><p><strong>framework</strong></p><p>A type of bundle that packages a dynamic shared library with the resources and header files that support that library. For more information, see <a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPFrameworks/Frameworks.html#//apple_ref/doc/uid/10000183i">Framework Programming Guide</a>.</p><p>ä¸€ç§æ†ç»‘ç±»å‹ï¼Œå°†åŠ¨æ€å…±äº«åº“ä¸æ”¯æŒè¯¥åº“çš„èµ„æºå’Œå¤´æ–‡ä»¶æ‰“åŒ…ã€‚æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPFrameworks/Frameworks.html#//apple_ref/doc/uid/10000183i">Framework Programming Guide</a>ã€‚</p><hr /><p><strong>å…¨å±€è°ƒåº¦é˜Ÿåˆ— global dispatch queue</strong></p><p>A <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW9">dispatch queue</a> provided to your application automatically by <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW23">Grand Central Dispatch (GCD)</a>. You do not have to create global queues yourself or retain or release them. Instead, you retrieve them using the system-provided functions.</p><p>ç”±GCDè‡ªåŠ¨æä¾›ç»™ç¨‹åºçš„ä¸€ä¸ªè°ƒåº¦é˜Ÿåˆ—ã€‚ä½ ä¸éœ€è¦è‡ªå·±åˆ›å»ºå…¨å±€é˜Ÿåˆ—ï¼Œä¹Ÿä¸éœ€è¦ä¿ç•™æˆ–é‡Šæ”¾å®ƒä»¬ã€‚ç›¸åï¼Œä½ å¯ä»¥ä½¿ç”¨ç³»ç»Ÿæä¾›çš„å‡½æ•°æ¥æ£€ç´¢å®ƒä»¬ã€‚</p><hr /><p><strong>Grand Central Dispatch (GCD)</strong></p><p>A technology for executing asynchronous tasks concurrently. GCD is available in OS X v10.6 and later and iOS 4.0 and later.</p><p>ä¸€ç§ç”¨äºå¹¶å‘æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„æŠ€æœ¯ã€‚GCDåœ¨OS X v10.6åŠä»¥åç‰ˆæœ¬å’ŒiOS 4.0åŠä»¥åç‰ˆæœ¬ä¸­å¯ç”¨ã€‚</p><hr /><p><strong>è¾“å…¥æº input source</strong></p><p>A source of asynchronous events for a thread. Input sources can be port based or manually triggered and must be attached to the threadâ€™s run loop.</p><p>ä¸€ä¸ªçº¿ç¨‹çš„å¼‚æ­¥äº‹ä»¶çš„æ¥æºã€‚è¾“å…¥æºå¯ä»¥æ˜¯åŸºäºç«¯å£çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ‰‹åŠ¨è§¦å‘çš„ï¼Œå¿…é¡»è¿æ¥åˆ°çº¿ç¨‹çš„run loopã€‚</p><hr /><p><strong>å¯è¿æ¥çº¿ç¨‹ joinable thread</strong></p><p>A thread whose resources are not reclaimed immediately upon termination. Joinable threads must be explicitly detached or be joined by another thread before the resources can be reclaimed. Joinable threads provide a return value to the thread that joins with them.</p><p>ä¸€ä¸ªçº¿ç¨‹ï¼Œå…¶èµ„æºåœ¨ç»ˆæ­¢æ—¶ä¸ä¼šè¢«ç«‹å³å›æ”¶ã€‚å¯åŠ å…¥çš„çº¿ç¨‹å¿…é¡»æ˜ç¡®åœ°è¢«åˆ†ç¦»æˆ–è¢«å¦ä¸€ä¸ªçº¿ç¨‹åŠ å…¥ï¼Œç„¶åæ‰å¯ä»¥å›æ”¶èµ„æºã€‚å¯åŠ å…¥çš„çº¿ç¨‹ä¸ºä¸ä¹‹åŠ å…¥çš„çº¿ç¨‹æä¾›ä¸€ä¸ªè¿”å›å€¼ã€‚</p><p><strong>åº“ library</strong></p><p>A UNIX feature for monitoring low-level system events. For more information see the <code>kqueue</code> man page.</p><p>ä¸€ä¸ªUNIXåŠŸèƒ½ï¼Œç”¨äºç›‘æ§ä½çº§åˆ«çš„ç³»ç»Ÿäº‹ä»¶ã€‚æ›´å¤šä¿¡æ¯å¯å‚é˜… <code>kqueue</code> man pageã€‚</p><hr /><p><strong>Mach port dispatch source</strong></p><p>A <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW19">dispatch source</a> used to process events arriving on a Mach port.</p><p>ä¸€ä¸ªç”¨äºå¤„ç†åˆ°è¾¾Machç«¯å£äº‹ä»¶çš„è°ƒåº¦æºã€‚</p><hr /><p><strong>ä¸»çº¿ç¨‹ main thread</strong></p><p>A special type of <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW1">thread</a> created when its owning process is created. When the main thread of a program exits, the process ends.</p><p>ä¸€ä¸ªç‰¹æ®Šç±»å‹çš„çº¿ç¨‹ï¼Œåœ¨å…¶æ‰€å±çš„è¿›ç¨‹è¢«åˆ›å»ºæ—¶åˆ›å»ºã€‚å½“ä¸€ä¸ªç¨‹åºçš„ä¸»çº¿ç¨‹é€€å‡ºæ—¶ï¼Œè¯¥è¿›ç¨‹å°±ç»“æŸäº†ã€‚</p><hr /><p><strong>äº’æ–¥é” mutex</strong></p><p>A lock that provides mutually exclusive access to a shared resource. A mutex lock can be held by only one thread at a time. Attempting to acquire a mutex held by a different thread puts the current thread to sleep until the lock is finally acquired.</p><p>ä¸€ä¸ªæä¾›å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®çš„é”ã€‚ä¸€ä¸ªäº’æ–¥é”åœ¨åŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ã€‚è¯•å›¾è·å–ä¸€ä¸ªç”±ä¸åŒçº¿ç¨‹æŒæœ‰çš„äº’æ–¥é”ä¼šä½¿å½“å‰çº¿ç¨‹é™·å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°æœ€ç»ˆè·å¾—è¯¥é”ã€‚</p><hr /><p><strong>Open Computing Language (OpenCL)</strong></p><p>A standards-based technology for performing general-purpose computations on a computerâ€™s graphics processor. For more information, see <a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/OpenCL_MacProgGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008312">OpenCL Programming Guide for Mac</a>.</p><p>ä¸€ç§åŸºäºæ ‡å‡†çš„æŠ€æœ¯ï¼Œç”¨äºåœ¨è®¡ç®—æœºçš„å›¾å½¢å¤„ç†å™¨ä¸Šè¿›è¡Œé€šç”¨è®¡ç®—ã€‚æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/OpenCL_MacProgGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008312">OpenCL Programming Guide for Mac</a>ã€‚</p><hr /><p><strong>æ“ä½œå¯¹è±¡ operation object</strong></p><p>An instance of the <code>NSOperation</code> class. Operation objects wrap the code and data associated with a task into an executable unit.</p><p><code>NSOperation</code>ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚æ“ä½œå¯¹è±¡å°†ä¸ä¸€ä¸ªä»»åŠ¡ç›¸å…³çš„ä»£ç å’Œæ•°æ®åŒ…è£…æˆä¸€ä¸ªå¯æ‰§è¡Œçš„å•å…ƒã€‚</p><hr /><p><strong>æ“ä½œé˜Ÿåˆ— operation queue</strong></p><p>An instance of the <code>NSOperationQueue</code> class. Operation queues manage the execution of operation objects.</p><p><code>NSOperationQueue</code>ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚æ“ä½œé˜Ÿåˆ—ç®¡ç†æ“ä½œå¯¹è±¡çš„æ‰§è¡Œã€‚</p><hr /><p><strong>ç§æœ‰è°ƒåº¦é˜Ÿåˆ— private dispatch queue</strong></p><p>A <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW9">dispatch queue</a> that you create, retain, and release explicitly.</p><p>è‡ªå·±æ˜ç¡®åˆ›å»ºã€ä¿ç•™å’Œé‡Šæ”¾çš„è°ƒåº¦é˜Ÿåˆ—ã€‚</p><hr /><p><strong>è¿›ç¨‹ process</strong></p><p>The runtime instance of an application or program. A process has its own virtual memory space and system resources (including port rights) that are independent of those assigned to other programs. A process always contains at least one thread (the main thread) and may contain any number of additional threads.</p><p>ä¸€ä¸ªç¨‹åºæˆ–ç¨‹åºçš„è¿è¡Œæ—¶å®ä¾‹ã€‚ä¸€ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„è™šæ‹Ÿå†…å­˜ç©ºé—´å’Œç³»ç»Ÿèµ„æºï¼ˆåŒ…æ‹¬ç«¯å£æƒé™ï¼‰ï¼Œç‹¬ç«‹äºåˆ†é…ç»™å…¶ä»–ç¨‹åºçš„èµ„æºã€‚ä¸€ä¸ªè¿›ç¨‹æ€»æ˜¯åŒ…å«è‡³å°‘ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œå¹¶å¯èƒ½åŒ…å«ä»»ä½•æ•°é‡çš„é™„åŠ çº¿ç¨‹ã€‚</p><hr /><p><strong>è¿›ç¨‹è°ƒåº¦æº process dispatch source</strong></p><p>A <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW19">dispatch source</a> used to handle process-related events. A process source calls your custom event handler in response to changes to the process you specify.</p><p>ç”¨äºå¤„ç†ä¸è¿›ç¨‹æœ‰å…³çš„äº‹ä»¶çš„è°ƒåº¦æºã€‚è¿›ç¨‹æºåœ¨å“åº”æŒ‡å®šçš„è¿›ç¨‹çš„å˜åŒ–æ—¶è°ƒç”¨è‡ªå®šä¹‰äº‹ä»¶handlerã€‚</p><hr /><p><strong>ç¨‹åº program</strong></p><p>A combination of code and resources that can be run to perform some task. Programs need not have a graphical user interface, although graphical applications are also considered programs.</p><p>ä¸€ä¸ªä»£ç å’Œèµ„æºçš„ç»„åˆï¼Œå¯ä»¥è¿è¡Œä»¥æ‰§è¡Œä¸€äº›ä»»åŠ¡ã€‚ç¨‹åºä¸éœ€è¦æœ‰å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼Œå°½ç®¡å›¾å½¢åº”ç”¨ç¨‹åºä¹Ÿè¢«è®¤ä¸ºæ˜¯ç¨‹åºã€‚</p><hr /><p><strong>å¯é‡å…¥çš„ reentrant</strong></p><p>Code that can be started on a new thread safely while it is already running on another thread.</p><p>å½“ä»£ç å·²ç»åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œæ—¶ï¼Œå¯ä»¥åœ¨å¦ä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸Šå®‰å…¨å¯åŠ¨ã€‚</p><hr /><p><strong>run loop</strong></p><p>An event-processing loop, during which events are received and dispatched to appropriate handlers.</p><p>ä¸€ä¸ªäº‹ä»¶å¤„ç†çš„å¾ªç¯ï¼Œåœ¨è¿™ä¸ªå¾ªç¯ä¸­ï¼Œäº‹ä»¶è¢«æ¥æ”¶å¹¶è°ƒåº¦ç»™é€‚å½“çš„handlerã€‚</p><hr /><p><strong>run loop mode</strong></p><p>A collection of input sources, timer sources, and run loop observers associated with a particular name. When run in a specific â€œmode,â€ a run loop monitors only the sources and observers associated with that mode.</p><p>ä¸€ä¸ªè¾“å…¥æºã€å®šæ—¶å™¨æºå’Œrun loopè§‚å¯Ÿè€…çš„é›†åˆï¼Œä¸ä¸€ä¸ªç‰¹å®šçš„åç§°ç›¸å…³è”ã€‚å½“åœ¨ä¸€ä¸ªç‰¹å®šçš„æ¨¡å¼ä¸‹è¿è¡Œæ—¶ï¼Œä¸€ä¸ªrun loopåªç›‘æ§ä¸è¯¥æ¨¡å¼ç›¸å…³çš„æºå’Œè§‚å¯Ÿè€…ã€‚</p><hr /><p><strong>run loop object</strong></p><p>An instance of the <code>NSRunLoop</code> class or <code>CFRunLoopRef</code> opaque type. These objects provide the interface for implementing an event-processing loop in a thread.</p><p><code>NSRunLoop</code>ç±»æˆ–<code>CFRunLoopRef</code>ä¸é€æ˜ç±»å‹çš„å®ä¾‹ã€‚è¿™äº›å¯¹è±¡æä¾›äº†åœ¨çº¿ç¨‹ä¸­å®ç°äº‹ä»¶å¤„ç†å¾ªç¯çš„æ¥å£ã€‚</p><hr /><p><strong>run loop observer</strong></p><p>A recipient of notifications during different phases of a run loopâ€™s execution.</p><p>åœ¨run loopæ‰§è¡Œçš„ä¸åŒé˜¶æ®µï¼Œæ˜¯é€šçŸ¥çš„æ¥æ”¶è€…ã€‚</p><hr /><p><strong>ä¿¡å·é‡ semaphore</strong></p><p>A protected variable that restricts access to a shared resource. Mutexes and conditions are both different types of semaphore.</p><p>ä¸€ä¸ªå—ä¿æŠ¤çš„å˜é‡ï¼Œé™åˆ¶å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚äº’æ–¥é”å’Œæ¡ä»¶éƒ½æ˜¯ä¸åŒç±»å‹çš„ä¿¡å·é‡ã€‚</p><hr /><p><strong>ä¿¡å· signal</strong></p><p>A UNIX mechanism for manipulating a process from outside its domain. The system uses signals to deliver important messages to an application, such as whether the application executed an illegal instruction. For more information see the <code>signal</code> man page.</p><p>ä¸€ç§UNIXæœºåˆ¶ï¼Œç”¨äºä»ä¸€ä¸ªè¿›ç¨‹çš„åŸŸå¤–æ“çºµè¯¥è¿›ç¨‹ã€‚ç³»ç»Ÿä½¿ç”¨ä¿¡å·å‘ç¨‹åºä¼ é€’é‡è¦ä¿¡æ¯ï¼Œä¾‹å¦‚ç¨‹åºæ˜¯å¦æ‰§è¡Œäº†éæ³•æŒ‡ä»¤ã€‚æ›´å¤šä¿¡æ¯å¯å‚é˜… <code>signal</code> man pageã€‚</p><hr /><p><strong>ä¿¡å·è°ƒåº¦æº signal dispatch source</strong></p><p>A <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW19">dispatch source</a> used to process UNIX signals. A signal source calls your custom event handler whenever the process receives a UNIX signal.</p><p>ç”¨äºå¤„ç†UNIXä¿¡å·çš„è°ƒåº¦æºã€‚å½“è¿›ç¨‹æ”¶åˆ°UNIXä¿¡å·æ—¶ï¼Œä¿¡å·æºä¼šè°ƒç”¨è‡ªå®šä¹‰äº‹ä»¶handlerã€‚</p><hr /><p><strong>ä»»åŠ¡ task</strong></p><p>A quantity of work to be performed. Although some technologies (most notably Carbon Multiprocessing Services) use this term differently, the preferred usage is as an abstract concept indicating some quantity of work to be performed.</p><p>ä¸€ä¸ªè¦æ‰§è¡Œçš„å·¥ä½œæ•°é‡ã€‚å°½ç®¡ä¸€äº›æŠ€æœ¯ï¼ˆæœ€æ˜æ˜¾çš„æ˜¯Carbonå¤šå¤„ç†æœåŠ¡ï¼‰ä»¥ä¸åŒçš„æ–¹å¼ä½¿ç”¨è¿™ä¸ªæœ¯è¯­ï¼Œä½†é¦–é€‰çš„ç”¨æ³•æ˜¯ä½œä¸ºä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œè¡¨ç¤ºè¦æ‰§è¡Œçš„ä¸€äº›å·¥ä½œçš„æ•°é‡ã€‚</p><hr /><p><strong>çº¿ç¨‹ thread</strong></p><p>A flow of execution in a process. Each thread has its own stack space but otherwise shares memory with other threads in the same process.</p><p>ä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ‰§è¡Œæµã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å †æ ˆç©ºé—´ï¼Œä½†åœ¨å…¶ä»–æ–¹é¢ä¸åŒä¸€è¿›ç¨‹ä¸­çš„å…¶ä»–çº¿ç¨‹å…±äº«å†…å­˜ã€‚</p><hr /><p><strong>å®šæ—¶å™¨è°ƒåº¦æº timer dispatch source</strong></p><p>A <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW19">dispatch source</a> used to process periodic events. A timer source calls your custom event handler at regular, time-based intervals.</p><p>ç”¨äºå¤„ç†å‘¨æœŸæ€§äº‹ä»¶çš„è°ƒåº¦æºã€‚å®šæ—¶å™¨æºå®šæœŸã€åŸºäºæ—¶é—´çš„é—´éš”è°ƒç”¨è‡ªå®šä¹‰äº‹ä»¶handlerã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;ç¨‹åº application&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;A specific style of &lt;a href=&quot;https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW13&quot;&gt;program&lt;/a&gt; that displays a graphical interface to the user.&lt;/p&gt;
&lt;p&gt;ä¸€ç§ç‰¹å®šé£æ ¼çš„å‘ç”¨æˆ·æ˜¾ç¤ºå›¾å½¢ç•Œé¢çš„&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Glossary/Glossary.html#//apple_ref/doc/uid/TP40008091-CH104-SW13&quot;&gt;program&lt;/a&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Concurrency Programming Guide" scheme="https://bqlin.github.io/tags/Concurrency-Programming-Guide/"/>
    
    <category term="å¤šçº¿ç¨‹" scheme="https://bqlin.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Concurrency Programming Guideï¼šè¿ç§»çº¿ç¨‹ä»£ç </title>
    <link href="https://bqlin.github.io/posts/concurrency_pg_migrating_away_from_threads/"/>
    <id>https://bqlin.github.io/posts/concurrency_pg_migrating_away_from_threads/</id>
    <published>2021-09-08T09:44:58.000Z</published>
    <updated>2021-10-24T04:12:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥è°ƒæ•´ç°æœ‰çš„çº¿ç¨‹ä»£ç ï¼Œä»¥åˆ©ç”¨Grand Central Dispatchå’Œæ“ä½œå¯¹è±¡çš„ä¼˜åŠ¿ã€‚è™½ç„¶ä¸æ˜¯åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½èƒ½æ‘†è„±çº¿ç¨‹ï¼Œä½†åœ¨ä½ è¿›è¡Œè½¬æ¢çš„åœ°æ–¹ï¼Œæ€§èƒ½ï¼ˆä»¥åŠä»£ç çš„ç®€å•æ€§ï¼‰å¯ä»¥å¾—åˆ°æå¤§çš„æ”¹å–„ã€‚å…·ä½“æ¥è¯´ï¼Œä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—å’Œæ“ä½œé˜Ÿåˆ—è€Œå–ä»£çº¿ç¨‹æœ‰å‡ ä¸ªä¼˜åŠ¿ï¼š</p><span id="more"></span><ul><li>å‡å°‘äº†ç¨‹åºä¸ºåœ¨å†…å­˜ç©ºé—´ä¸­å­˜å‚¨çº¿ç¨‹å †æ ˆçš„å†…å­˜å ç”¨ã€‚</li><li>æ¶ˆé™¤äº†åˆ›å»ºå’Œé…ç½®çº¿ç¨‹æ‰€éœ€çš„ä»£ç ã€‚</li><li>æ¶ˆé™¤äº†ç®¡ç†å’Œå®‰æ’çº¿ç¨‹å·¥ä½œæ‰€éœ€çš„ä»£ç ã€‚</li><li>å‡å°‘äº†ä»£ç é‡ã€‚</li></ul><p>æœ¬ç« æä¾›äº†ä¸€äº›æŠ€å·§å’ŒæŒ‡å—ï¼Œè¯´æ˜å¦‚ä½•æ›¿æ¢ç°æœ‰çš„åŸºäºçº¿ç¨‹çš„ä»£ç ï¼Œè½¬è€Œä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—å’Œæ“ä½œé˜Ÿåˆ—æ¥å®ç°ç›¸åŒç±»å‹çš„è¡Œä¸ºã€‚</p><h2 id="ç”¨è°ƒåº¦é˜Ÿåˆ—æ›¿æ¢çº¿ç¨‹">ç”¨è°ƒåº¦é˜Ÿåˆ—æ›¿æ¢çº¿ç¨‹</h2><p>è¦äº†è§£å¦‚ä½•ç”¨è°ƒåº¦é˜Ÿåˆ—æ›¿æ¢çº¿ç¨‹ï¼Œé¦–å…ˆè¦è€ƒè™‘åœ¨ç¨‹åºä¸­ä½¿ç”¨çº¿ç¨‹çš„ä¸€äº›æ–¹å¼ï¼š</p><ul><li><strong>å•ä¸€ä»»åŠ¡çº¿ç¨‹</strong>ã€‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä¸€ä¸ªå•ä¸€çš„ä»»åŠ¡ï¼Œå½“ä»»åŠ¡å®Œæˆåé‡Šæ”¾è¯¥çº¿ç¨‹ã€‚</li><li><strong>å·¥ä½œçº¿ç¨‹</strong>ã€‚åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‰¹å®šçš„ä»»åŠ¡ã€‚å®šæœŸå‘æ¯ä¸ªçº¿ç¨‹è°ƒåº¦ä»»åŠ¡ã€‚</li><li><strong>çº¿ç¨‹æ± </strong>ã€‚åˆ›å»ºä¸€ä¸ªé€šç”¨çº¿ç¨‹æ± ï¼Œå¹¶ä¸ºæ¯ä¸ªçº¿ç¨‹è®¾ç½®run loopã€‚å½“ä½ æœ‰ä»»åŠ¡è¦æ‰§è¡Œæ—¶ï¼Œä»æ± å­é‡Œå–ä¸€ä¸ªçº¿ç¨‹ï¼ŒæŠŠä»»åŠ¡è°ƒåº¦ç»™å®ƒã€‚å¦‚æœæ²¡æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼Œå°±æŠŠä»»åŠ¡æ’å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…å¯ç”¨çš„çº¿ç¨‹ã€‚</li></ul><p>å°½ç®¡è¿™äº›çœ‹èµ·æ¥æ˜¯æˆªç„¶ä¸åŒçš„æŠ€æœ¯ï¼Œä½†å®ƒä»¬å®é™…ä¸Šåªæ˜¯åŒä¸€åŸåˆ™çš„å˜ç§ã€‚åœ¨ä»¥ä¸Šçš„æ¯ç§ä½¿ç”¨æ–¹å¼ï¼Œçº¿ç¨‹éƒ½è¢«ç”¨æ¥è¿è¡Œç¨‹åºå¿…é¡»æ‰§è¡Œçš„ä¸€äº›ä»»åŠ¡ã€‚å®ƒä»¬ä¹‹é—´å”¯ä¸€çš„åŒºåˆ«æ˜¯ç”¨äºç®¡ç†çº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—çš„ä»£ç ã€‚é€šè¿‡ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—å’Œæ“ä½œé˜Ÿåˆ—ï¼Œå¯ä»¥æ¶ˆé™¤æ‰€æœ‰çº¿ç¨‹å’Œçº¿ç¨‹é€šä¿¡çš„ä»£ç ï¼Œè®©ä½ ä¸“æ³¨äºè¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚</p><p>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ä¸Šè¿°çº¿ç¨‹æ¨¡å‹ï¼Œä½ åº”è¯¥å’Œæ¸…æ¥šç¨‹åºè¦æ‰§è¡Œä»»åŠ¡ç±»å‹ã€‚ä¸å…¶å°†ä¸€ä¸ªä»»åŠ¡æäº¤ç»™ä½ çš„ä¸€ä¸ªè‡ªå®šä¹‰çº¿ç¨‹ï¼Œä¸å¦‚å°è¯•å°†è¯¥ä»»åŠ¡å°è£…åœ¨ä¸€ä¸ªæ“ä½œå¯¹è±¡æˆ–ä¸€ä¸ªblockå¯¹è±¡ä¸­ï¼Œå¹¶å°†å…¶è°ƒåº¦åˆ°é€‚å½“çš„é˜Ÿåˆ—ä¸­ã€‚å¯¹äºé‚£äº›ä¸æ˜¯ç‰¹åˆ«æœ‰äº‰è®®çš„ä»»åŠ¡ï¼ˆä¸éœ€è¦é”çš„ä»»åŠ¡ï¼‰ï¼Œä½ åº”è¯¥èƒ½è¿›è¡Œä»¥ä¸‹çš„ç›´æ¥æ›¿æ¢ï¼š</p><ul><li>å¯¹äºå•ä¸ªä»»åŠ¡çº¿ç¨‹ï¼Œå°†ä»»åŠ¡å°è£…åœ¨ä¸€ä¸ªblockæˆ–æ“ä½œå¯¹è±¡ä¸­ï¼Œå¹¶å°†å…¶æäº¤ç»™ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ã€‚</li><li>å¯¹äºå·¥ä½œçº¿ç¨‹ï¼Œä½ éœ€è¦å†³å®šæ˜¯ä½¿ç”¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—è¿˜æ˜¯ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ã€‚å¦‚æœä½ ä½¿ç”¨å·¥ä½œç°åœºæ¥åŒæ­¥æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡é›†ï¼Œè¯·ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—ã€‚å¦‚æœä½ ç¡®å®ä½¿ç”¨å·¥ä½œç°åœºæ¥æ‰§è¡Œæ²¡æœ‰ç›¸äº’ä¾èµ–å…³ç³»çš„ä»»æ„ä»»åŠ¡ï¼Œåˆ™ä½¿ç”¨å¹¶å‘é˜Ÿåˆ—ã€‚</li><li>å¯¹äºçº¿ç¨‹æ± ï¼Œå°†ä½ çš„ä»»åŠ¡å°è£…åœ¨ä¸€ä¸ªblockæˆ–æ“ä½œå¯¹è±¡ä¸­ï¼Œå¹¶å°†å®ƒä»¬è°ƒåº¦åˆ°ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚</li></ul><p>å½“ç„¶ï¼Œåƒè¿™æ ·ç®€å•çš„æ›¿æ¢å¯èƒ½å¹¶ä¸æ˜¯åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½é€‚ç”¨ã€‚å¦‚æœä½ æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å­˜åœ¨äº‰å¤ºå…±äº«èµ„æºï¼Œç†æƒ³çš„è§£å†³æ–¹æ¡ˆæ˜¯é¦–å…ˆå°è¯•æ¶ˆé™¤æˆ–å°½é‡å‡å°‘è¿™ç§äº‰å¤ºã€‚å¦‚æœä½ æœ‰åŠæ³•é‡æ„ä½ çš„ä»£ç ä»¥æ¶ˆé™¤å¯¹å…±äº«èµ„æºçš„ç›¸äº’ä¾èµ–ï¼Œè¿™å½“ç„¶æ˜¯æœ€å¥½çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœåšä¸åˆ°ï¼Œæˆ–è€…æ•ˆç‡è¾ƒä½ï¼Œé‚£ä¹ˆè¿˜æ˜¯æœ‰åŠæ³•åˆ©ç”¨é˜Ÿåˆ—çš„ä¼˜åŠ¿ã€‚é˜Ÿåˆ—çš„ä¸€å¤§ä¼˜åŠ¿æ˜¯ï¼Œå®ƒä»¬æä¾›äº†ä¸€ç§æ›´å¯é¢„æµ‹çš„æ–¹å¼æ¥æ‰§è¡Œä½ çš„ä»£ç ã€‚è¿™ç§å¯é¢„æµ‹æ€§æ„å‘³ç€ä»æœ‰åŠæ³•åœ¨ä¸ä½¿ç”¨é”æˆ–å…¶ä»–é‡é‡çº§åŒæ­¥æœºåˆ¶çš„æƒ…å†µä¸‹åŒæ­¥æ‰§è¡Œä½ çš„ä»£ç ã€‚ä½ å¯ä»¥ä½¿ç”¨é˜Ÿåˆ—æ¥æ‰§è¡Œè®¸å¤šç›¸åŒçš„ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é”ã€‚</p><ul><li>å¦‚æœæ˜¯å¿…é¡»æŒ‰ç‰¹å®šé¡ºåºæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¯ä»¥æŠŠå®ƒä»¬æäº¤ç»™ä¸€ä¸ªä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—ã€‚æˆ–ä½¿ç”¨æ“ä½œå¯¹è±¡ä¾èµ–æ¥ç¡®ä¿ä»¥ç‰¹å®šçš„é¡ºåºæ‰§è¡Œã€‚</li><li>å¦‚æœç›®å‰ä½¿ç”¨é”æ¥ä¿æŠ¤ä¸€ä¸ªå…±äº«èµ„æºï¼Œåˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—æ¥æ‰§è¡Œä»»ä½•ä¿®æ”¹è¯¥èµ„æºçš„ä»»åŠ¡ã€‚ç„¶åï¼Œä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—å°†å–ä»£ç°æœ‰çš„é”ä½œä¸ºåŒæ­¥æœºåˆ¶çš„ä»£ç ã€‚å…³äºæ‘†è„±é”çš„æ›´å¤šæŠ€æœ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/ThreadMigration/ThreadMigration.html#//apple_ref/doc/uid/TP40008091-CH105-SW3">Eliminating Lock-Based Code</a>ã€‚</li><li>å¦‚æœåœ¨ç”¨çº¿ç¨‹è¿æ¥æ¥ç­‰å¾…åå°ä»»åŠ¡çš„å®Œæˆï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨è°ƒåº¦ç»„æ¥æ›¿æ¢ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨<code>NSBlockOperation</code>å¯¹è±¡æˆ–æ“ä½œå¯¹è±¡ä¾èµ–æ¥å®ç°ç±»ä¼¼çš„ç»„å®Œæˆè¡Œä¸ºã€‚å…³äºå¦‚ä½•è·Ÿè¸ªæ‰§è¡Œä»»åŠ¡çš„ç»„ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/ThreadMigration/ThreadMigration.html#//apple_ref/doc/uid/TP40008091-CH105-SW6">Replacing Thread Joins</a>ã€‚</li><li>å¦‚æœåœ¨ä½¿ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…ç®—æ³•æ¥ç®¡ç†æœ‰é™èµ„æºæ± ï¼Œå¯ä»¥è€ƒè™‘å°†å®ç°æ”¹ä¸º<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/ThreadMigration/ThreadMigration.html#//apple_ref/doc/uid/TP40008091-CH105-SW7">ä¿®æ”¹ç”Ÿäº§è€…-æ¶ˆè´¹è€…å®ç°</a>ä¸­æ‰€è¿°çš„æ–¹æ¡ˆã€‚</li><li>å¦‚æœåœ¨ä½¿ç”¨çº¿ç¨‹ä»æè¿°ç¬¦ä¸­è¯»å†™ï¼Œæˆ–ç›‘è§†æ–‡ä»¶æ“ä½œï¼Œå¯ä»¥æ”¹ç”¨è°ƒåº¦æºå®ç°ã€‚</li></ul><p>é‡è¦çš„æ˜¯è¦è®°ä½ï¼Œé˜Ÿåˆ—å¹¶ä¸æ˜¯å–ä»£çº¿ç¨‹çš„ä¸‡é‡‘æ²¹ã€‚é˜Ÿåˆ—æä¾›çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹é€‚ç”¨äºå…è®¸å»¶è¿Ÿçš„åœºæ™¯ã€‚å³ä½¿é˜Ÿåˆ—æä¾›äº†é…ç½®ä»»åŠ¡æ‰§è¡Œä¼˜å…ˆçº§çš„æ–¹æ³•ï¼Œä½†è¾ƒé«˜çš„æ‰§è¡Œä¼˜å…ˆçº§å¹¶ä¸èƒ½ä¿è¯ä»»åŠ¡åœ¨ç‰¹å®šçš„æ—¶é—´æ‰§è¡Œã€‚å› æ­¤ï¼Œåœ¨éœ€è¦å°½å¯èƒ½é¿å…å»¶è¿Ÿçš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ä»ç„¶æ˜¯ä¸€ä¸ªæ›´åˆé€‚çš„é€‰æ‹©ï¼Œä¾‹å¦‚åœ¨éŸ³é¢‘å’Œè§†é¢‘æ’­æ”¾çš„åœºæ™¯ã€‚</p><h2 id="æ¶ˆé™¤åŸºäºé”çš„ä»£ç ">æ¶ˆé™¤åŸºäºé”çš„ä»£ç </h2><p>å¯¹äºçº¿ç¨‹ä»£ç ï¼Œé”æ˜¯åŒæ­¥è®¿é—®çº¿ç¨‹é—´å…±äº«èµ„æºçš„ä¼ ç»Ÿæ–¹å¼ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œé”çš„ä½¿ç”¨æ˜¯æœ‰ä»£ä»·çš„ã€‚å³ä½¿åœ¨æ— ç«æ€æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨é”ä¹Ÿä¼šæœ‰æ€§èƒ½æŸå¤±ã€‚è€Œåœ¨ç«æ€æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œä¸€æˆ–å¤šä¸ªçº¿ç¨‹æœ‰å¯èƒ½åœ¨ç­‰å¾…é”è¢«é‡Šæ”¾çš„è¿‡ç¨‹ä¸­é˜»å¡ä¸ç¡®å®šçš„æ—¶é—´ã€‚</p><p>ç”¨é˜Ÿåˆ—å–ä»£åŸºäºé”çš„ä»£ç ï¼Œå¯ä»¥æ¶ˆé™¤è®¸å¤šä¸é”ç›¸å…³çš„æŸè€—ï¼ŒåŒæ—¶ä¹Ÿç®€åŒ–äº†å‰©ä½™çš„ä»£ç ã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—æ¥ä¸²è¡Œè®¿é—®è¯¥èµ„æºï¼Œè€Œä¸æ˜¯ä½¿ç”¨é”æ¥ä¿æŠ¤ä¸€ä¸ªå…±äº«èµ„æºã€‚é˜Ÿåˆ—ä¸ä¼šåƒé”é‚£æ ·å¸¦æ¥æ€§èƒ½æŸè€—ã€‚ä¾‹å¦‚ï¼Œæ’é˜Ÿçš„ä»»åŠ¡ä¸éœ€è¦è¿›å…¥å†…æ ¸æ¥è·å–äº’æ–¥é”ã€‚</p><p>å½“æ’é˜Ÿä»»åŠ¡æ—¶ï¼Œä½ åªéœ€å†³å®šæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥è¿›è¡Œã€‚å¼‚æ­¥æäº¤ä»»åŠ¡å¯ä»¥è®©å½“å‰çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ç»§ç»­è¿è¡Œã€‚åŒæ­¥æäº¤ä»»åŠ¡åˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹çš„è¿è¡Œï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚è¿™ä¸¤ä¸ªæƒ…å†µéƒ½æœ‰é€‚å½“çš„ç”¨é€”ï¼Œä½†åªè¦æœ‰å¯èƒ½ï¼Œå¼‚æ­¥æäº¤ä»»åŠ¡è‚¯å®šæ˜¯æ›´ä¼˜çš„ã€‚</p><p>ä¸‹é¢å‡ èŠ‚å°†å‘ä½ å±•ç¤ºå¦‚ä½•ç”¨ç­‰ä»·çš„åŸºäºé˜Ÿåˆ—çš„ä»£ç æ¥æ›¿æ¢ç°æœ‰çš„åŸºäºé”çš„ä»£ç ã€‚</p><h3 id="å®ç°å¼‚æ­¥é”">å®ç°å¼‚æ­¥é”</h3><p>å¼‚æ­¥é”æ˜¯ä¸€ç§ä¿æŠ¤å…±äº«èµ„æºçš„æ–¹å¼ï¼Œå®ƒä¸ä¼šé˜»å¡ä»»ä½•ä¿®æ”¹è¯¥èµ„æºçš„ä»£ç ã€‚å½“ä½ éœ€è¦ä¿®æ”¹ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä¼šå½±å“å…¶ä»–çš„ä»»åŠ¡æ—¶ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨å¼‚æ­¥é”ã€‚ä½¿ç”¨ä¼ ç»Ÿçš„çº¿ç¨‹ï¼Œé€šå¸¸çš„æ–¹å¼æ˜¯ä¸ºå…±äº«èµ„æºåŠ é”ï¼Œç„¶åè¿›è¡Œå¿…è¦çš„ä¿®æ”¹ï¼Œé‡Šæ”¾é”ï¼Œç„¶åç»§ç»­å®Œæˆä»»åŠ¡ã€‚ç„¶è€Œï¼Œä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—ï¼Œè°ƒç”¨çš„ä»£ç å¯ä»¥å¼‚æ­¥åœ°è¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸å¿…ç­‰å¾…è¿™äº›ä¿®æ”¹å®Œæˆã€‚</p><p>æ¸…å•5-1æ˜¾ç¤ºäº†ä¸€ä¸ªå¼‚æ­¥é”å®ç°çš„ä¾‹å­ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå—ä¿æŠ¤çš„èµ„æºå®šä¹‰äº†è‡ªå·±çš„ä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—ã€‚è°ƒç”¨ä»£ç å‘è¿™ä¸ªé˜Ÿåˆ—æäº¤ä¸€ä¸ªblockå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«éœ€è¦å¯¹èµ„æºè¿›è¡Œçš„ä¿®æ”¹ã€‚å› ä¸ºé˜Ÿåˆ—æœ¬èº«æ˜¯ä¸²è¡Œæ‰§è¡Œblockçš„ï¼Œæ‰€ä»¥å¯¹èµ„æºçš„ä¿®æ”¹ä¿è¯æŒ‰ç…§æ¥æ”¶çš„é¡ºåºè¿›è¡Œï¼›ä½†æ˜¯ï¼Œå› ä¸ºä»»åŠ¡æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è°ƒç”¨çº¿ç¨‹ä¸ä¼šé˜»å¡ã€‚</p><p><strong>æ¸…å•5-1</strong> å¼‚æ­¥ä¿®æ”¹ä¿æŠ¤çš„èµ„æº</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(obj-&gt;serial_queue, ^&#123;</span><br><span class="line">   <span class="comment">// Critical section</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="åŒæ­¥æ‰§è¡Œå…³é”®ä»£ç ">åŒæ­¥æ‰§è¡Œå…³é”®ä»£ç </h3><p>å¦‚æœå½“å‰çš„ä»£ç åœ¨æŸä¸ªä»»åŠ¡å®Œæˆä¹‹å‰ä¸èƒ½ç»§ç»­ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>dispatch_sync</code>å‡½æ•°åŒæ­¥æäº¤è¯¥ä»»åŠ¡ã€‚è¿™ä¸ªå‡½æ•°å°†ä»»åŠ¡æ·»åŠ åˆ°ä¸€ä¸ªè°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œç„¶åé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚æ ¹æ®ä½ çš„éœ€è¦ï¼Œè°ƒåº¦é˜Ÿåˆ—æœ¬èº«å¯ä»¥æ˜¯ä¸€ä¸ªä¸²è¡Œæˆ–å¹¶å‘é˜Ÿåˆ—ã€‚å› ä¸ºè¿™ä¸ªå‡½æ•°ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ‰€ä»¥ä½ åº”è¯¥åªåœ¨å¿…è¦æ—¶ä½¿ç”¨å®ƒã€‚æ¸…å•5-2æ˜¾ç¤ºäº†ä½¿ç”¨<code>dispatch_sync</code>æ¥åŒ…è£…ä»£ç çš„å…³é”®éƒ¨åˆ†çš„æŠ€æœ¯ã€‚</p><p><strong>æ¸…å•5-2</strong> åŒæ­¥æ‰§è¡Œå…³é”®ä»£ç </p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_sync</span>(my_queue, ^&#123;</span><br><span class="line">   <span class="comment">// Critical section</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ å·²ç»åœ¨ä½¿ç”¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—æ¥ä¿æŠ¤å…±äº«èµ„æºï¼ŒåŒæ­¥è°ƒåº¦åˆ°è¯¥é˜Ÿåˆ—å¹¶ä¸ä¼šæ¯”å¼‚æ­¥è°ƒåº¦æ›´èƒ½ä¿æŠ¤å…±äº«èµ„æºã€‚ä½¿ç”¨åŒæ­¥è°ƒåº¦çš„æ˜¯ä¸ºäº†é˜»å¡å½“å‰ä»£ç ï¼Œç›´åˆ°å…³é”®éƒ¨åˆ†å®Œæˆã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³ä»å…±äº«èµ„æºä¸­è·å–ä¸€äº›å€¼å¹¶ç«‹å³ä½¿ç”¨å®ƒï¼Œä½ å°±éœ€è¦åŒæ­¥è°ƒåº¦ã€‚å¦‚æœå½“å‰ä»£ç ä¸éœ€è¦ç­‰å¾…å…³é”®éƒ¨åˆ†çš„å®Œæˆï¼Œæˆ–è€…å®ƒå¯ä»¥ç®€å•åœ°æäº¤åç»­ä»»åŠ¡åˆ°åŒä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ä¸­ï¼Œé‚£ä¹ˆå¼‚æ­¥æäº¤å¾€å¾€æ˜¯é¦–é€‰ã€‚</p><h2 id="æ”¹è¿›å¾ªç¯ä»£ç ">æ”¹è¿›å¾ªç¯ä»£ç </h2><p>å¦‚æœä»£ç æœ‰å¾ªç¯ï¼Œå¹¶ä¸”æ¯æ¬¡é€šè¿‡å¾ªç¯æ‰€åšçš„å·¥ä½œä¸å…¶ä»–è¿­ä»£ä¸­çš„å·¥ä½œæ— å…³ï¼Œä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨<code>dispatch_apply</code>æˆ–<code>dispatch_apply_f</code>å‡½æ•°é‡æ–°å®ç°è¯¥å¾ªç¯ä»£ç ã€‚è¿™äº›å‡½æ•°æŠŠå¾ªç¯çš„æ¯ä¸ªè¿­ä»£å•ç‹¬æäº¤ç»™ä¸€ä¸ªè°ƒåº¦é˜Ÿåˆ—è¿›è¡Œå¤„ç†ã€‚å½“ä¸å¹¶å‘é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥è®©ä½ å¹¶å‘åœ°æ‰§è¡Œå¾ªç¯è¿­ä»£ã€‚</p><p>å¦‚æœä½ çš„å¾ªç¯çš„æ¯æ¬¡è¿­ä»£éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„è¯ï¼Œä½ ä¹Ÿè®¸åº”è¯¥è€ƒè™‘ä½¿ç”¨ <code>dispatch_apply</code> æˆ– <code>dispatch_apply_f</code> é‡æ–°å®ç°ä½ çš„å¾ªç¯ã€‚è¿™ä¸¤ä¸ªå‡½æ•°å°†æ¯ä¸ªè¿­ä»£æäº¤ç»™é˜Ÿåˆ—å¤„ç†ã€‚å½“å’Œå¹¶è¡Œé˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿™ä¸ªç‰¹æ€§è®©ä½ èƒ½å¤ŸåŒæ—¶è¿›è¡Œå¤šä¸ªè¿­ä»£ã€‚</p><p><code>dispatch_apply</code>å’Œ<code>dispatch_apply_f</code>å‡½æ•°æ˜¯åŒæ­¥å‡½æ•°è°ƒç”¨ï¼Œå®ƒä»¬ä¼šé˜»å¡å½“å‰æ‰§è¡Œçº¿ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰çš„å¾ªç¯è¿­ä»£å®Œæˆã€‚å½“æäº¤ç»™ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—æ—¶ï¼Œå¾ªç¯è¿­ä»£çš„æ‰§è¡Œé¡ºåºä¸è¢«ä¿è¯ã€‚è¿è¡Œæ¯ä¸ªè¿­ä»£çš„çº¿ç¨‹å¯èƒ½ä¼šé˜»å¡ï¼Œå¯¼è‡´ä¸€ä¸ªç»™å®šçš„è¿­ä»£åœ¨å®ƒå‘¨å›´çš„å…¶ä»–è¿­ä»£ä¹‹å‰æˆ–ä¹‹åå®Œæˆã€‚å› æ­¤ï¼Œåœ¨ä¸ºæ¯ä¸ªå¾ªç¯è¿­ä»£ä½¿ç”¨çš„blockå¯¹è±¡æˆ–å‡½æ•°å¿…é¡»æ˜¯å¯é‡å…¥çš„ã€‚</p><p>æ¸…å•5-3æ˜¾ç¤ºäº†å¦‚ä½•ç”¨åŸºäºGCDæ¥æ›¿æ¢forå¾ªç¯ã€‚ä¼ é€’ç»™<code>dispatch_apply</code>æˆ–<code>dispatch_apply_f</code>çš„blockæˆ–å‡½æ•°å¿…é¡»å–ä¸€ä¸ªæ•´æ•°å€¼ï¼Œè¡¨ç¤ºå½“å‰å¾ªç¯çš„è¿­ä»£ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä»£ç åªæ˜¯å°†å½“å‰çš„å¾ªç¯ç¼–å·æ‰“å°åˆ°æ§åˆ¶å°ã€‚</p><p><strong>æ¸…å•5-3</strong> é€æ­¥æ›¿æ¢forå¾ªç¯</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">dispatch_apply(count, queue, ^(size_t i) &#123;</span><br><span class="line">   printf(<span class="string">&quot;%u\n&quot;</span>, i);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å°½ç®¡å‰é¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½†å®ƒå±•ç¤ºäº†ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—æ›¿æ¢å¾ªç¯çš„åŸºæœ¬æŠ€æœ¯ã€‚å°½ç®¡è¿™å¯èƒ½æ˜¯æé«˜åŸºäºå¾ªç¯çš„ä»£ç æ€§èƒ½çš„ä¸€ä¸ªå¥½æ–¹æ³•ï¼Œä½†ä½ ä»å¿…é¡»è¾¨è¯åœ°ä½¿ç”¨è¿™ç§æŠ€æœ¯ã€‚å°½ç®¡è°ƒåº¦é˜Ÿåˆ—çš„å¼€é”€å¾ˆä½ï¼Œä½†åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šè°ƒåº¦æ¯ä¸ªå¾ªç¯è¿­ä»£ä»æœ‰æˆæœ¬ã€‚å› æ­¤ï¼Œä½ åº”è¯¥ç¡®ä¿ä½ çš„å¾ªç¯ä»£ç åšäº†è¶³å¤Ÿå¤šçš„å·¥ä½œæ¥æŠµæ¶ˆè¿™äº›æˆæœ¬ã€‚ç¡®åˆ‡åœ°è¯´ï¼Œéœ€è¦åšå¤šå°‘å·¥ä½œæ˜¯ä½ å¿…é¡»ä½¿ç”¨æ€§èƒ½å·¥å…·æ¥è¡¡é‡çš„äº‹æƒ…ã€‚</p><p>å¢åŠ æ¯ä¸ªå¾ªç¯è¿­ä»£çš„å·¥ä½œé‡çš„ä¸€ä¸ªç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨stridingã€‚ä½¿ç”¨stridingé‡å†™ä½ çš„blockï¼Œä»¥æ¯æ¬¡æ‰§è¡ŒåŸå§‹å¾ªç¯çš„å¤šä¸ªè¿­ä»£ã€‚ç„¶åï¼Œå°†æŒ‡å®šç»™<code>dispatch_apply</code>å‡½æ•°çš„è®¡æ•°å€¼æŒ‰æ¯”ä¾‹å‡å°‘ã€‚æ¸…å•5-4æ˜¾ç¤ºäº†å¦‚ä½•ä¸ºæ¸…å•5-3ä¸­çš„å¾ªç¯ä»£ç å®ç°stridingã€‚åœ¨æ¸…å•5-4ä¸­ï¼Œè¯¥blockè°ƒç”¨<code>printf</code>è¯­å¥çš„æ¬¡æ•°ä¸strideå€¼ç›¸åŒï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯137ã€‚(å®é™…çš„strideå€¼æ˜¯ä½ åº”è¯¥æ ¹æ®ä½ çš„ä»£ç æ‰€åšçš„å·¥ä½œæ¥é…ç½®çš„)ã€‚å› ä¸ºåœ¨å°†æ€»çš„è¿­ä»£æ¬¡æ•°é™¤ä»¥strideå€¼æ—¶ï¼Œä¼šæœ‰å‰©ä½™çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥ä»»ä½•å‰©ä½™çš„è¿­ä»£éƒ½æ˜¯ç›´æ¥æ‰§è¡Œçš„ã€‚</p><p><strong>æ¸…å•5-4</strong> å‘è°ƒåº¦çš„forå¾ªç¯å¢åŠ æ­¥å¹…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int stride = 137;</span><br><span class="line">dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line"> </span><br><span class="line">dispatch_apply(count / stride, queue, ^(size_t idx)&#123;</span><br><span class="line">    size_t j = idx * stride;</span><br><span class="line">    size_t j_stop = j + stride;</span><br><span class="line">    do &#123;</span><br><span class="line">       printf(&quot;%u\n&quot;, (unsigned int)j++);</span><br><span class="line">    &#125;while (j &lt; j_stop);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">size_t i;</span><br><span class="line">for (i = count - (count % stride); i &lt; count; i++)</span><br><span class="line">   printf(&quot;%u\n&quot;, (unsigned int)i);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨strideæœ‰ä¸€äº›æ˜ç¡®çš„æ€§èƒ½ä¼˜åŠ¿ã€‚å°¤å…¶æ˜¯å½“åŸå§‹å¾ªç¯è¿­ä»£æ¬¡æ•°è¾ƒå¤šæ—¶ã€‚åŒæ—¶è°ƒåº¦è¾ƒå°‘çš„blockæ„å‘³ç€èŠ±åœ¨æ‰§è¡Œè¿™äº›blockçš„ä»£ç ä¸Šçš„æ—¶é—´æ¯”è°ƒåº¦å®ƒä»¬çš„æ—¶é—´å¤šã€‚ä¸è¿‡å’Œä»»ä½•æ€§èƒ½æŒ‡æ ‡ä¸€æ ·ï¼Œä½ å¯èƒ½è¦è°ƒæ•´stridingçš„å€¼æ¥è¾¾åˆ°æœ€ä½³æ€§èƒ½ã€‚</p><h2 id="æ›¿æ¢çº¿ç¨‹è¿æ¥">æ›¿æ¢çº¿ç¨‹è¿æ¥</h2><p>çº¿ç¨‹è¿æ¥å…è®¸ä½ ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œç„¶åè®©å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°è¿™äº›çº¿ç¨‹å®Œæˆã€‚ä¸ºäº†å®ç°çº¿ç¨‹è¿æ¥ï¼Œä¸€ä¸ªçˆ¶çº¿ç¨‹ä¼šåˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹ä½œä¸º<em>å¯è¿æ¥çº¿ç¨‹</em>ã€‚å½“çˆ¶çº¿ç¨‹åœ¨æ²¡æœ‰å­çº¿ç¨‹çš„ç»“æœçš„æƒ…å†µä¸‹ä¸èƒ½å†å–å¾—è¿›å±•æ—¶ï¼Œå®ƒå°±ä¸å­çº¿ç¨‹è¿æ¥ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šé˜»å¡çˆ¶çº¿ç¨‹ï¼Œç›´åˆ°å­çº¿ç¨‹å®Œæˆå…¶ä»»åŠ¡å¹¶é€€å‡ºï¼Œè¿™æ—¶ï¼Œçˆ¶çº¿ç¨‹å¯ä»¥ä»å­çº¿ç¨‹ä¸­æ”¶é›†ç»“æœå¹¶ç»§ç»­åŸæ¥çš„å·¥ä½œã€‚å¦‚æœçˆ¶çº¿ç¨‹éœ€è¦ä¸å¤šä¸ªå­çº¿ç¨‹è¿æ¥ï¼Œå®ƒåªèƒ½é€ä¸ªè¿›è¡Œã€‚</p><p>è°ƒåº¦ç»„æä¾›äº†ç±»ä¼¼äºçº¿ç¨‹è¿æ¥çš„è¯­ä¹‰ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›é¢å¤–çš„ä¼˜åŠ¿ã€‚ä¸çº¿ç¨‹è¿æ¥ä¸€æ ·ï¼Œè°ƒåº¦ç»„æ˜¯ä¸€ç§è®©çº¿ç¨‹é˜»å¡çš„æ–¹å¼ï¼Œç›´åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå­ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚ä¸çº¿ç¨‹è¿æ¥ä¸åŒï¼Œè°ƒåº¦ç»„åŒæ—¶ç­‰å¾…å…¶æ‰€æœ‰å­ä»»åŠ¡ã€‚å› ä¸ºè°ƒåº¦ç»„ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—æ¥æ‰§è¡Œå·¥ä½œï¼Œæ‰€ä»¥å®ƒä»¬éå¸¸é«˜æ•ˆã€‚</p><p>è¦ä½¿ç”¨è°ƒåº¦ç»„æ¥æ‰§è¡Œç”±å¯è¿æ¥çº¿ç¨‹æ‰§è¡Œçš„ç›¸åŒå·¥ä½œï¼Œä½ è¦åšçš„æ˜¯ï¼š</p><ol type="1"><li>ä½¿ç”¨<code>dispatch_group_create</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªè°ƒåº¦ç»„ã€‚</li><li>ä½¿ç”¨<code>dispatch_group_async</code>æˆ–<code>dispatch_group_async_f</code>å‡½æ•°å‘è¯¥ç»„æ·»åŠ ä»»åŠ¡ã€‚æäº¤ç»™ç»„çš„æ¯ä¸ªä»»åŠ¡éƒ½è¡¨ç¤ºåœ¨ä¸€ä¸ªå¯åŠ å…¥çš„çº¿ç¨‹ä¸Šæ‰§è¡Œçš„å·¥ä½œã€‚</li><li>å½“å½“å‰çº¿ç¨‹ä¸èƒ½å†å‘å‰æ¨è¿›æ—¶ï¼Œè°ƒç”¨<code>dispatch_group_wait</code>å‡½æ•°æ¥ç­‰å¾…è¯¥ç»„ã€‚è¿™ä¸ªå‡½æ•°ä¼šé˜»æ­¢å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è¯¥ç»„ä¸­çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆæ‰§è¡Œã€‚</li></ol><p>å¦‚æœä½ ä½¿ç”¨æ“ä½œå¯¹è±¡æ¥å®ç°ä½ çš„ä»»åŠ¡ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¾èµ–å…³ç³»å®ç°çº¿ç¨‹è¿æ¥ã€‚ä¸å…¶è®©ä¸€ä¸ªçˆ¶çº¿ç¨‹ç­‰å¾…ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡å®Œæˆï¼Œä¸å¦‚å°†çˆ¶çº¿ç¨‹çš„ä»£ç ç§»åˆ°ä¸€ä¸ªæ“ä½œå¯¹è±¡ä¸­ã€‚ç„¶åï¼Œä½ å°†åœ¨çˆ¶æ“ä½œå¯¹è±¡å’Œä»»ä½•æ•°é‡çš„å­æ“ä½œå¯¹è±¡ä¹‹é—´å»ºç«‹ä¾èµ–å…³ç³»ï¼Œä»¥å®Œæˆé€šå¸¸ç”±å¯è¿æ¥çº¿ç¨‹æ‰§è¡Œçš„å·¥ä½œã€‚å¯¹å…¶ä»–æ“ä½œå¯¹è±¡çš„ä¾èµ–å…³ç³»å¯ä»¥é˜»å¡çˆ¶æ“ä½œå¯¹è±¡çš„æ‰§è¡Œï¼Œç›´åˆ°æ‰€æœ‰çš„æ“ä½œéƒ½å®Œæˆã€‚</p><p>å…³äºå¦‚ä½•ä½¿ç”¨è°ƒåº¦ç»„çš„ä¾‹å­ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW25">Waiting on Groups of Queued Tasks</a>ã€‚å…³äºè®¾ç½®æ“ä½œå¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW17">Configuring Interoperation Dependencies</a>ã€‚</p><h2 id="æ”¹å˜ç”Ÿäº§è€…-æ¶ˆè´¹è€…çš„å®ç°æ–¹å¼">æ”¹å˜ç”Ÿäº§è€…-æ¶ˆè´¹è€…çš„å®ç°æ–¹å¼</h2><p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹å¯ä»¥è®©ä½ ç®¡ç†æœ‰é™åŠ¨æ€ç”Ÿäº§çš„èµ„æºã€‚å½“ç”Ÿäº§è€…åˆ›å»ºæ–°çš„èµ„æºï¼ˆæˆ–ä»»åŠ¡ï¼‰æ—¶ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…ç­‰å¾…è¿™äº›èµ„æºï¼ˆæˆ–ä»»åŠ¡ï¼‰å°±ç»ªï¼Œå¹¶åœ¨å®ƒä»¬å°±ç»ªæ—¶æ¶ˆè´¹å®ƒä»¬ã€‚å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹çš„å…¸å‹æœºåˆ¶æ˜¯æ¡ä»¶ï¼ˆconditionsï¼‰æˆ–ä¿¡å·é‡ã€‚</p><p>ä½¿ç”¨æ¡ä»¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹é€šå¸¸åšä»¥ä¸‹äº‹æƒ…ï¼š</p><ol type="1"><li>é”å®šä¸æ¡ä»¶ç›¸å…³çš„äº’æ–¥é”ï¼ˆä½¿ç”¨<code>pthread_mutex_lock</code>ï¼‰ã€‚</li><li>ç”Ÿäº§å°†è¢«æ¶ˆè´¹çš„èµ„æºæˆ–ä»»åŠ¡ã€‚</li><li>å‘æ¡ä»¶å˜é‡å‘å‡ºä¿¡å·ï¼Œè¡¨ç¤ºæœ‰èµ„æºè¦æ¶ˆè€—ï¼ˆä½¿ç”¨<code>pthread_cond_signal</code>ï¼‰ã€‚</li><li>è§£é”äº’æ–¥é”ï¼ˆä½¿ç”¨<code>pthread_mutex_unlock</code>ï¼‰ã€‚</li></ol><p>ç›¸åº”çš„æ¶ˆè´¹çº¿ç¨‹ä¼šåšä»¥ä¸‹äº‹æƒ…ï¼š</p><ol type="1"><li>é”å®šä¸è¯¥æ¡ä»¶ç›¸å…³çš„äº’æ–¥é”ï¼ˆä½¿ç”¨<code>pthread_mutex_lock</code>ï¼‰ã€‚</li><li>è®¾ç½®ä¸€ä¸ª<code>while</code>å¾ªç¯ï¼Œåšä»¥ä¸‹å·¥ä½œï¼š<ol type="1"><li>æ£€æŸ¥æ˜¯å¦çœŸçš„æœ‰ä»»åŠ¡è¦æ‰§è¡Œã€‚</li><li>å¦‚æœæ²¡æœ‰ä»»åŠ¡è¦æ‰§è¡Œï¼ˆæˆ–è€…æ²¡æœ‰å¯ç”¨çš„èµ„æºï¼‰ï¼Œè°ƒç”¨<code>pthread_cond_wait</code>æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æœ‰ç›¸åº”çš„ä¿¡å·é‡å‡ºç°ã€‚</li></ol></li><li>è·å–ç”Ÿäº§è€…æä¾›çš„ä»»åŠ¡ï¼ˆæˆ–èµ„æºï¼‰ã€‚</li><li>è§£é”äº’æ–¥é”ï¼ˆä½¿ç”¨<code>pthread_mutex_unlock</code>ï¼‰ã€‚</li><li>å¤„ç†ä»»åŠ¡ã€‚</li></ol><p>é€šè¿‡è°ƒåº¦é˜Ÿåˆ—ï¼Œä½ å¯ä»¥å°†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å®ç°ç®€åŒ–ä¸ºå•ä¸€çš„è°ƒç”¨ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">   <span class="comment">// Process a work item.</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å½“ä½ çš„ç”Ÿäº§è€…æœ‰ä»»åŠ¡è¦æ‰§è¡Œæ—¶ï¼Œå®ƒæ‰€è¦åšçš„å°±æ˜¯å°†è¯¥ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œè®©é˜Ÿåˆ—å¤„ç†è¯¥ä»»åŠ¡ã€‚å‰é¢çš„ä»£ç ä¸­å”¯ä¸€æ”¹å˜çš„éƒ¨åˆ†æ˜¯é˜Ÿåˆ—ç±»å‹ã€‚å¦‚æœç”Ÿäº§è€…ç”Ÿæˆçš„ä»»åŠ¡éœ€è¦æŒ‰ç…§ç‰¹å®šçš„é¡ºåºæ‰§è¡Œï¼Œå°±ä½¿ç”¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚å¦‚æœç”Ÿäº§è€…ç”Ÿæˆçš„ä»»åŠ¡å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œå°±æŠŠå®ƒä»¬æ·»åŠ åˆ°ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½åœ°åŒæ—¶æ‰§è¡Œå®ƒä»¬ã€‚</p><h2 id="æ›¿æ¢ä¿¡å·é‡ä»£ç ">æ›¿æ¢ä¿¡å·é‡ä»£ç </h2><p>å¦‚æœä½ ç›®å‰åœ¨ä½¿ç”¨ä¿¡å·é‡æ¥é™åˆ¶å¯¹å…±äº«èµ„æºçš„è®¿é—®ï¼Œä½ åº”è€ƒè™‘ä½¿ç”¨è°ƒåº¦ä¿¡å·é‡æ¥ä»£æ›¿ã€‚ä¼ ç»Ÿçš„ä¿¡å·é‡æ€»æ˜¯éœ€è¦è°ƒç”¨å†…æ ¸æ¥æµ‹è¯•ä¿¡å·é‡ã€‚ç›¸åï¼Œè°ƒåº¦ä¿¡å·é‡åœ¨ç”¨æˆ·ç©ºé—´ä¸­å¿«é€Ÿæµ‹è¯•ä¿¡å·é‡çš„çŠ¶æ€ï¼Œå¹¶ä¸”åªæœ‰åœ¨æµ‹è¯•å¤±è´¥å’Œè°ƒç”¨çº¿ç¨‹éœ€è¦è¢«é˜»å¡æ—¶æ‰ä¼šè¿›å…¥å†…æ ¸ã€‚è¿™ç§è¡Œä¸ºçš„ç»“æœæ˜¯ï¼Œåœ¨æ²¡æœ‰ç«æ€æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œè°ƒåº¦ä¿¡å·é‡æ¯”ä¼ ç»Ÿä¿¡å·é‡å¿«å¾—å¤šã€‚ä¸è¿‡åœ¨å…¶ä»–æ–¹é¢ï¼Œè°ƒåº¦ä¿¡å·é‡æä¾›äº†ä¸ä¼ ç»Ÿä¿¡å·é‡ç›¸åŒçš„è¡Œä¸ºã€‚</p><p>å…³äºå¦‚ä½•ä½¿ç”¨è°ƒåº¦ä¿¡å·çš„ä¾‹å­ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW24">Using Dispatch Semaphores to Regulate the Use of Finite Resources</a>ã€‚</p><h2 id="æ›¿æ¢run-loopä»£ç ">æ›¿æ¢Run-Loopä»£ç </h2><p>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨run loopæ¥ç®¡ç†ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œçš„å·¥ä½œï¼Œä½ å¯èƒ½ä¼šå‘ç°é˜Ÿåˆ—çš„å®ç°å’Œç»´æŠ¤è¦ç®€å•å¾—å¤šã€‚è®¾ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„run loopåŒ…æ‹¬è®¾ç½®åº•å±‚çº¿ç¨‹å’Œrun loopæœ¬èº«ã€‚run loopçš„ä»£ç åŒ…æ‹¬è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªrun loopæºï¼Œå¹¶ç¼–å†™å›è°ƒæ¥å¤„ç†åˆ°è¾¾è¿™äº›æºçš„äº‹ä»¶ã€‚æ‰€æœ‰çš„è¿™äº›ï¼Œä½ å¯ä»¥ç®€å•åœ°åˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œå¹¶å‘å…¶è°ƒåº¦ä»»åŠ¡ã€‚å› æ­¤ï¼Œä½ å¯ä»¥ç”¨ä¸€è¡Œä»£ç å–ä»£æ‰€æœ‰çš„çº¿ç¨‹å’Œrun loopåˆ›å»ºä»£ç ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> myNewRunLoop = dispatch_queue_create(<span class="string">&quot;com.apple.MyQueue&quot;</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>å› ä¸ºé˜Ÿåˆ—ä¼šè‡ªåŠ¨æ‰§è¡Œæ·»åŠ çš„ä»»åŠ¡ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦é¢å¤–çš„ä»£ç æ¥ç®¡ç†é˜Ÿåˆ—ã€‚ä½ ä¸éœ€è¦åˆ›å»ºæˆ–é…ç½®çº¿ç¨‹ï¼Œä¹Ÿä¸éœ€è¦åˆ›å»ºæˆ–é™„åŠ ä»»ä½•run loopæºã€‚æ­¤å¤–ï¼Œä½ å¯ä»¥é€šè¿‡ç®€å•åœ°å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­æ¥æ‰§è¡Œæ–°çš„å·¥ä½œç±»å‹ã€‚è¦å¯¹run loopåšåŒæ ·çš„äº‹æƒ…ï¼Œä½ éœ€è¦ä¿®æ”¹ä½ ç°æœ‰çš„run loopæºæˆ–åˆ›å»ºä¸€ä¸ªæ–°çš„run loopæºæ¥å¤„ç†æ–°çš„æ•°æ®ã€‚</p><p>run loopçš„ä¸€ä¸ªå¸¸è§é…ç½®æ˜¯å¤„ç†å¼‚æ­¥åˆ°è¾¾ç½‘ç»œå¥—æ¥å­—ä¸Šçš„æ•°æ®ã€‚ä¸å…¶ä¸ºè¿™ç§ç±»å‹çš„è¡Œä¸ºé…ç½®ä¸€ä¸ªrun loopï¼Œä½ å¯ä»¥ä¸ºæ‰€éœ€çš„é˜Ÿåˆ—é™„åŠ ä¸€ä¸ªè°ƒåº¦æºã€‚ä¸ä¼ ç»Ÿçš„run loopæºç›¸æ¯”ï¼Œè°ƒåº¦æºè¿˜æä¾›äº†æ›´å¤šå¤„ç†æ•°æ®çš„é€‰é¡¹ã€‚é™¤äº†å¤„ç†å®šæ—¶å™¨å’Œç½‘ç»œç«¯å£äº‹ä»¶å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨è°ƒåº¦æºæ¥è¯»å†™æ–‡ä»¶ã€ç›‘æ§æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡ã€ç›‘æ§è¿›ç¨‹å’Œç›‘æ§ä¿¡å·ã€‚ä½ ç”šè‡³å¯ä»¥å®šä¹‰è‡ªå®šä¹‰è°ƒåº¦æºï¼Œä»ä½ ä»£ç çš„å…¶ä»–éƒ¨åˆ†å¼‚æ­¥è§¦å‘å®ƒä»¬ã€‚å…³äºè®¾ç½®è°ƒåº¦æºçš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href=".%2F04%20Dispatch%20Sources.md">è°ƒåº¦æº</a>ã€‚</p><h2 id="å…¼å®¹posixçº¿ç¨‹">å…¼å®¹POSIXçº¿ç¨‹</h2><p>ç”±äºGrand Central Dispatchç®¡ç†ç€ä½ æä¾›çš„ä»»åŠ¡å’Œè¿™äº›ä»»åŠ¡è¿è¡Œçš„çº¿ç¨‹ä¹‹é—´çš„å…³ç³»ï¼Œä½ ä¸€èˆ¬åº”è¯¥é¿å…ä»ä½ çš„ä»»åŠ¡ä»£ç ä¸­è°ƒç”¨POSIXçº¿ç¨‹ä¾‹ç¨‹ã€‚å¦‚æœä½ å› ä¸ºæŸäº›åŸå› éœ€è¦è°ƒç”¨å®ƒä»¬ï¼Œä½ åº”è¯¥éå¸¸å°å¿ƒåœ°å¯¹å¾…ä½ æ‰€è°ƒç”¨çš„ä¾‹ç¨‹ï¼ˆroutinesï¼‰ã€‚æœ¬èŠ‚ä¸ºä½ æä¾›äº†ä¸€ä¸ªæŒ‡å—ï¼Œè¯´æ˜å“ªäº›ä¾‹ç¨‹å¯ä»¥å®‰å…¨è°ƒç”¨ï¼Œå“ªäº›ä¾‹ç¨‹ä¸å¯ä»¥ä»ä½ çš„é˜Ÿåˆ—ä»»åŠ¡ä¸­è°ƒç”¨ã€‚è¿™ä¸ªåˆ—è¡¨å¹¶ä¸å®Œæ•´ï¼Œä½†åº”è¯¥ç»™ä½ ä¸€ä¸ªæŒ‡ç¤ºï¼Œå“ªäº›æ˜¯å®‰å…¨çš„è°ƒç”¨ï¼Œå“ªäº›æ˜¯ä¸å®‰å…¨çš„ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œç¨‹åºä¸èƒ½åˆ é™¤æˆ–æ”¹å˜ä¸æ˜¯å®ƒåˆ›å»ºçš„å¯¹è±¡æˆ–æ•°æ®ç»“æ„ã€‚å› æ­¤ï¼Œä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—æ‰§è¡Œçš„blockå¯¹è±¡ä¸èƒ½è°ƒç”¨ä»¥ä¸‹å‡½æ•°ï¼š</p><ul><li><code>pthread_detach</code></li><li><code>pthread_cancel</code></li><li><code>pthread_join</code></li><li><code>pthread_kill</code></li><li><code>pthread_exit</code></li></ul><p>å°½ç®¡åœ¨ä»»åŠ¡è¿è¡Œæ—¶æ˜¯å¯ä»¥ä¿®æ”¹ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€çš„ï¼Œä½†ä½ å¿…é¡»åœ¨ä½ çš„ä»»åŠ¡è¿”å›ä¹‹å‰å°†çº¿ç¨‹è¿”å›åˆ°å®ƒçš„åŸå§‹çŠ¶æ€ã€‚å› æ­¤ï¼Œåªè¦ä½ æŠŠçº¿ç¨‹è¿”å›åˆ°å®ƒçš„åŸå§‹çŠ¶æ€ï¼Œè°ƒç”¨ä»¥ä¸‹å‡½æ•°æ˜¯å®‰å…¨çš„ï¼š</p><ul><li><code>pthread_setcancelstate</code></li><li><code>pthread_setcanceltype</code></li><li><code>pthread_setschedparam</code></li><li><code>pthread_sigmask</code></li><li><code>pthread_setspecific</code></li></ul><p>ç”¨äºæ‰§è¡Œä¸€ä¸ªç»™å®šblockçš„åº•å±‚çº¿ç¨‹å¯ä»¥åœ¨ä¸åŒçš„è°ƒç”¨ä¸­è¿›è¡Œä¿®æ”¹ã€‚å› æ­¤ï¼Œç¨‹åºä¸åº”è¯¥ä¾èµ–ä»¥ä¸‹å‡½æ•°åœ¨blockçš„è°ƒç”¨ä¹‹é—´è¿”å›å¯é¢„æµ‹çš„ç»“æœï¼š</p><ul><li><code>pthread_self</code></li><li><code>pthread_getschedparam</code></li><li><code>pthread_get_stacksize_np</code></li><li><code>pthread_get_stackaddr_np</code></li><li><code>pthread_mach_thread_np</code></li><li><code>pthread_from_mach_thread_np</code></li><li><code>pthread_getspecific</code></li></ul><p><strong>é‡è¦æé†’ï¼š</strong>blockå¿…é¡»æ•è·å¹¶æŠ‘åˆ¶åœ¨å…¶ä¸­æŠ›å‡ºçš„ä»»ä½•è¯­è¨€çº§å¼‚å¸¸ã€‚åœ¨blockçš„æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„å…¶ä»–é”™è¯¯åŒæ ·åº”è¯¥ç”±blockæ¥å¤„ç†ï¼Œæˆ–è€…ç”¨æ¥é€šçŸ¥ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ã€‚</p><p>å…³äºPOSIXçº¿ç¨‹å’Œæœ¬èŠ‚ä¸­æåˆ°çš„å‡½æ•°çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<code>pthread</code> man pagesã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><ul><li>å¼‚æ­¥æ·»åŠ ä»»åŠ¡åˆ°ä¸²è¡Œé˜Ÿåˆ—å®ç°äº†å¼‚æ­¥é”ã€‚</li><li>å…³é”®ä»£ç ä½¿ç”¨åŒæ­¥æ–¹å¼è¿›å…¥ä¸²è¡Œã€å¹¶å‘é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚</li><li>ç”¨è°ƒåº¦ç»„æ›¿æ¢çº¿ç¨‹è¿æ¥ã€‚</li><li>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹å¯ä»¥ç›´æ¥ç”¨ç»™é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡å®ç°ã€‚å¦‚æœç”Ÿäº§è€…ç”Ÿæˆçš„ä»»åŠ¡éœ€è¦æŒ‰ç…§ç‰¹å®šçš„é¡ºåºæ‰§è¡Œï¼Œå°±ä½¿ç”¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚å¦‚æœç”Ÿäº§è€…ç”Ÿæˆçš„ä»»åŠ¡å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œå°±æŠŠå®ƒä»¬æ·»åŠ åˆ°ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½åœ°åŒæ—¶æ‰§è¡Œå®ƒä»¬ã€‚</li><li>run loopä»£ç å¯ä»¥ç›´æ¥ç”¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—æˆ–è°ƒåº¦æºå®ç°ã€‚</li><li>å¦‚æœå¯¹å®æ—¶æ€§è¦æ±‚éå¸¸ä¸¥æ ¼ï¼Œé‚£ä¹ˆè¿˜æ˜¯å»ºè®®ä½¿ç”¨çº¿ç¨‹å®ç°ã€‚</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥è°ƒæ•´ç°æœ‰çš„çº¿ç¨‹ä»£ç ï¼Œä»¥åˆ©ç”¨Grand Central Dispatchå’Œæ“ä½œå¯¹è±¡çš„ä¼˜åŠ¿ã€‚è™½ç„¶ä¸æ˜¯åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½èƒ½æ‘†è„±çº¿ç¨‹ï¼Œä½†åœ¨ä½ è¿›è¡Œè½¬æ¢çš„åœ°æ–¹ï¼Œæ€§èƒ½ï¼ˆä»¥åŠä»£ç çš„ç®€å•æ€§ï¼‰å¯ä»¥å¾—åˆ°æå¤§çš„æ”¹å–„ã€‚å…·ä½“æ¥è¯´ï¼Œä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—å’Œæ“ä½œé˜Ÿåˆ—è€Œå–ä»£çº¿ç¨‹æœ‰å‡ ä¸ªä¼˜åŠ¿ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Concurrency Programming Guide" scheme="https://bqlin.github.io/tags/Concurrency-Programming-Guide/"/>
    
    <category term="å¤šçº¿ç¨‹" scheme="https://bqlin.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Concurrency Programming Guideï¼šè°ƒåº¦æº</title>
    <link href="https://bqlin.github.io/posts/concurrency_pg_dispatch_sources/"/>
    <id>https://bqlin.github.io/posts/concurrency_pg_dispatch_sources/</id>
    <published>2021-09-08T09:43:58.000Z</published>
    <updated>2021-10-24T04:12:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ¯å½“ä½ ä¸åº•å±‚ç³»ç»Ÿæ‰“äº¤é“æ—¶ï¼Œå¿…é¡»å‡†å¤‡å¥½è¯¥ä»»åŠ¡å¯èƒ½éœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´ã€‚å¯¹å†…æ ¸æˆ–å…¶ä»–ç³»ç»Ÿå±‚çš„è°ƒç”¨æ¶‰åŠåˆ°ä¸Šä¸‹æ–‡çš„æ”¹å˜ï¼Œä¸å‘ç”Ÿåœ¨è¿›ç¨‹ä¸­çš„è°ƒç”¨ç›¸æ¯”ï¼Œè¿™ç§æ”¹å˜æ˜¯ç›¸å½“æ˜‚è´µçš„ã€‚å› æ­¤ï¼Œè®¸å¤šç³»ç»Ÿåº“æä¾›äº†å¼‚æ­¥æ¥å£ï¼Œå…è®¸ä½ çš„ä»£ç å‘ç³»ç»Ÿæäº¤ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶åœ¨å¤„ç†è¯¥è¯·æ±‚æ—¶ç»§ç»­åšå…¶ä»–å·¥ä½œã€‚Grand Central Dispatchå»ºç«‹åœ¨è¿™ç§ä¸€èˆ¬è¡Œä¸ºçš„åŸºç¡€ä¸Šï¼Œå…è®¸ä½ æäº¤è¯·æ±‚ï¼Œå¹¶ä½¿ç”¨blockå’Œè°ƒåº¦é˜Ÿåˆ—å°†ç»“æœåé¦ˆç»™ä½ çš„ä»£ç ã€‚</p><span id="more"></span><h2 id="å…³äºè°ƒåº¦æº">å…³äºè°ƒåº¦æº</h2><p><em>è°ƒåº¦æº</em>æ˜¯ä¸€ä¸ªåŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œå®ƒåè°ƒç‰¹å®šçš„åº•å±‚ç³»ç»Ÿäº‹ä»¶çš„å¤„ç†ã€‚Grand Central Dispatchæ”¯æŒä»¥ä¸‹ç±»å‹çš„è°ƒåº¦æºï¼š</p><ul><li><em>è®¡æ—¶å™¨è°ƒåº¦æº</em>äº§ç”Ÿå®šæœŸé€šçŸ¥ã€‚</li><li><em>ä¿¡å·è°ƒåº¦æº</em>åœ¨UNIXä¿¡å·åˆ°è¾¾æ—¶å‘å‡ºé€šçŸ¥ã€‚</li><li><em>æè¿°ç¬¦æº</em>é€šçŸ¥ä½ å„ç§åŸºäºæ–‡ä»¶å’Œå¥—æ¥å­—çš„æ“ä½œï¼Œä¾‹å¦‚ï¼š<ul><li>å½“æ•°æ®å¯ä¾›è¯»å–æ—¶ï¼›</li><li>å½“å¯ä»¥å†™å…¥æ•°æ®æ—¶ï¼›</li><li>å½“æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è¢«åˆ é™¤ã€ç§»åŠ¨æˆ–é‡å‘½åæ—¶ï¼›</li><li>å½“æ–‡ä»¶å…ƒä¿¡æ¯å‘ç”Ÿå˜åŒ–æ—¶ï¼›</li></ul></li><li><em>è¿›ç¨‹è°ƒåº¦æº</em>é€šçŸ¥ä½ ä¸è¿›ç¨‹æœ‰å…³çš„äº‹ä»¶ï¼Œå¦‚ï¼š<ul><li>å½“ä¸€ä¸ªè¿›ç¨‹é€€å‡ºæ—¶ï¼›</li><li>å½“ä¸€ä¸ªè¿›ç¨‹å‘å‡ºä¸€ä¸ª<code>fork</code>æˆ–<code>exec</code>ç±»å‹çš„è°ƒç”¨æ—¶ï¼›</li><li>å½“ä¸€ä¸ªä¿¡å·è¢«ä¼ é€’ç»™è¿›ç¨‹æ—¶ï¼›</li></ul></li><li><em>æœºå™¨ç«¯å£è°ƒåº¦æº</em>é€šçŸ¥ä¸æœºå™¨æœ‰å…³çš„äº‹ä»¶ã€‚</li><li><em>è‡ªå®šä¹‰è°ƒåº¦æº</em>å¯ä»¥ç”±è‡ªå·±å®šä¹‰å’Œè§¦å‘ã€‚</li></ul><p>è°ƒåº¦æºå–ä»£é€šå¸¸ç”¨äºå¤„ç†ç³»ç»Ÿç›¸å…³äº‹ä»¶çš„å¼‚æ­¥å›è°ƒå‡½æ•°ã€‚å½“ä½ é…ç½®ä¸€ä¸ªè°ƒåº¦æºæ—¶ï¼ŒæŒ‡å®šä½ æƒ³ç›‘æ§çš„äº‹ä»¶å’Œè°ƒåº¦é˜Ÿåˆ—ï¼Œä»¥åŠç”¨æ¥å¤„ç†è¿™äº›äº‹ä»¶çš„ä»£ç ã€‚ä½ å¯ä»¥ä½¿ç”¨blockå¯¹è±¡æˆ–å‡½æ•°æŒ‡å®šä½ çš„ä»£ç ã€‚å½“ä¸€ä¸ªæ„Ÿå…´è¶£çš„äº‹ä»¶åˆ°æ¥æ—¶ï¼Œè°ƒåº¦æºä¼šå°†ä½ çš„blockæˆ–å‡½æ•°æäº¤ç»™æŒ‡å®šçš„è°ƒåº¦é˜Ÿåˆ—æ¥æ‰§è¡Œã€‚</p><p>ä¸æ‰‹åŠ¨æäº¤åˆ°é˜Ÿåˆ—çš„ä»»åŠ¡ä¸åŒï¼Œè°ƒåº¦æºä¸ºç¨‹åºæä¾›äº†ä¸€ä¸ªæŒç»­çš„äº‹ä»¶æºã€‚åœ¨ä½ æ˜ç¡®å–æ¶ˆå®ƒä¹‹å‰ï¼Œä¸€ä¸ªè°ƒåº¦æºä¸€ç›´è¿æ¥åˆ°å®ƒçš„è°ƒåº¦é˜Ÿåˆ—ã€‚åœ¨è¿æ¥æœŸé—´ï¼Œæ¯å½“ç›¸åº”çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå®ƒéƒ½ä¼šå‘è°ƒåº¦é˜Ÿåˆ—æäº¤å…¶ç›¸å…³çš„ä»»åŠ¡ä»£ç ã€‚æœ‰äº›äº‹ä»¶ï¼Œå¦‚å®šæ—¶å™¨äº‹ä»¶ï¼Œä¼šå®šæœŸå‘ç”Ÿï¼Œä½†å¤§å¤šæ•°äº‹ä»¶åªæ˜¯åœ¨ç‰¹å®šæ¡ä»¶å‡ºç°æ—¶é›¶æ˜Ÿåœ°å‘ç”Ÿã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œè°ƒåº¦æºä¿ç•™å…¶ç›¸å…³çš„è°ƒåº¦é˜Ÿåˆ—ï¼Œä»¥é˜²æ­¢å®ƒåœ¨äº‹ä»¶å¯èƒ½ä»åœ¨ç­‰å¾…æ—¶è¢«è¿‡æ—©é‡Šæ”¾ã€‚</p><p>ä¸ºäº†é˜²æ­¢äº‹ä»¶ç§¯å‹åœ¨è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œè°ƒåº¦æºå®æ–½äº†ä¸€ä¸ªäº‹ä»¶åˆå¹¶ï¼ˆcoalescingï¼‰æ–¹æ¡ˆã€‚å¦‚æœä¸€ä¸ªæ–°çš„äº‹ä»¶åœ¨å‰ä¸€ä¸ªäº‹ä»¶çš„handlerè¢«å–æ¶ˆæ’é˜Ÿå¹¶æ‰§è¡Œä¹‹å‰åˆ°è¾¾ï¼Œè°ƒåº¦æºå°±ä¼šå°†æ–°çš„äº‹ä»¶æ•°æ®ä¸æ—§äº‹ä»¶çš„æ•°æ®åˆå¹¶èµ·æ¥ã€‚æ ¹æ®äº‹ä»¶çš„ç±»å‹ï¼Œåˆå¹¶å¯èƒ½ä¼šå–ä»£æ—§äº‹ä»¶æˆ–æ›´æ–°å…¶æŒæœ‰çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåŸºäºä¿¡å·çš„è°ƒåº¦æºåªæä¾›å…³äºæœ€è¿‘çš„ä¿¡å·ä¿¡æ¯ï¼Œä½†ä¹ŸæŠ¥å‘Šè‡ªä¸Šæ¬¡è°ƒç”¨äº‹ä»¶handlerä»¥æ¥ï¼Œæ€»å…±æœ‰å¤šå°‘ä¿¡å·è¢«ä¼ é€’ã€‚</p><h2 id="åˆ›å»ºè°ƒåº¦æº">åˆ›å»ºè°ƒåº¦æº</h2><p>åˆ›å»ºä¸€ä¸ªè°ƒåº¦æºåŒ…æ‹¬åˆ›å»ºäº‹ä»¶æºå’Œè°ƒåº¦æºæœ¬èº«ã€‚äº‹ä»¶æºæ˜¯å¤„ç†è¿™äº›äº‹ä»¶æ‰€éœ€çš„ä»»ä½•æœ¬åœ°æ•°æ®ç»“æ„ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªåŸºäºæè¿°ç¬¦çš„è°ƒåº¦æºï¼Œä½ éœ€è¦æ‰“å¼€æè¿°ç¬¦ï¼Œè€Œå¯¹äºä¸€ä¸ªåŸºäºè¿›ç¨‹çš„æºï¼Œä½ éœ€è¦è·å¾—ç›®æ ‡ç¨‹åºçš„è¿›ç¨‹IDã€‚å½“ä½ æœ‰äº†ä½ çš„äº‹ä»¶æºï¼Œä½ å°±å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹æ³•åˆ›å»ºç›¸åº”çš„è°ƒåº¦æºï¼š</p><ol type="1"><li>ä½¿ç”¨ <code>dispatch_source_create</code> å‡½æ•°åˆ›å»ºè°ƒåº¦æºã€‚</li><li>é…ç½®è°ƒåº¦æºï¼š<ul><li>ä¸ºè°ƒåº¦æºåˆ†é…ä¸€ä¸ªäº‹ä»¶handlerï¼›å¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html#//apple_ref/doc/uid/TP40008091-CH103-SW13">Writing and Installing an Event Handler</a>ã€‚</li><li>å¯¹äºå®šæ—¶å™¨æºï¼Œä½¿ç”¨<code>dispatch_source_set_timer</code>å‡½æ•°è®¾ç½®å®šæ—¶å™¨ä¿¡æ¯ï¼›å¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html#//apple_ref/doc/uid/TP40008091-CH103-SW2">Creating a Timer</a>ã€‚</li></ul></li><li>å¯ä»¥é€‰æ‹©ç»™è°ƒåº¦æºåˆ†é…ä¸€ä¸ªå–æ¶ˆhandlerï¼›å¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html#//apple_ref/doc/uid/TP40008091-CH103-SW14">Installing a Cancellation Handler</a>ã€‚</li><li>è°ƒç”¨<code>dispatch_resume</code>å‡½æ•°å¼€å§‹å¤„ç†äº‹ä»¶ï¼›å¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html#//apple_ref/doc/uid/TP40008091-CH103-SW8">Suspending and Resuming Dispatch Sources</a>ã€‚</li></ol><p>ç”±äºè°ƒåº¦æºåœ¨ä½¿ç”¨å‰éœ€è¦ä¸€äº›é¢å¤–çš„é…ç½®ï¼Œ<code>dispatch_source_create</code>å‡½æ•°åœ¨æš‚åœçŠ¶æ€ä¸‹è¿”å›è°ƒåº¦æºã€‚åœ¨æš‚åœçŠ¶æ€ä¸‹ï¼Œè°ƒåº¦æºæ¥æ”¶äº‹ä»¶ä½†ä¸å¤„ç†å®ƒä»¬ã€‚è¿™ä½¿ä½ æœ‰æ—¶é—´é…ç½®ä¸€ä¸ªäº‹ä»¶handlerï¼Œå¹¶æ‰§è¡Œå¤„ç†å®é™…äº‹ä»¶æ‰€éœ€çš„å…¶ä»–é…ç½®ã€‚</p><p>ä¸‹é¢çš„ç« èŠ‚å‘ä½ å±•ç¤ºäº†å¦‚ä½•é…ç½®è°ƒåº¦æºã€‚å…³äºå±•ç¤ºå¦‚ä½•é…ç½®ç‰¹å®šç±»å‹çš„è°ƒåº¦æºçš„è¯¦ç»†ä¾‹å­ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html#//apple_ref/doc/uid/TP40008091-CH103-SW22">Dispatch Source Examples</a>ã€‚å…³äºç”¨æ¥åˆ›å»ºå’Œé…ç½®è°ƒåº¦æºçš„å‡½æ•°çš„å…¶ä»–ä¿¡æ¯ï¼Œå¯å‚é˜…<em>Grand Central Dispatch (GCD) Reference</em>ã€‚</p><h3 id="ç¼–å†™å’Œé…ç½®ä¸€ä¸ªäº‹ä»¶handler">ç¼–å†™å’Œé…ç½®ä¸€ä¸ªäº‹ä»¶Handler</h3><p>ä¸ºäº†å¤„ç†ç”±è°ƒåº¦æºäº§ç”Ÿçš„äº‹ä»¶ï¼Œä½ å¿…é¡»å®šä¹‰ä¸€ä¸ªäº‹ä»¶handleræ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚äº‹ä»¶handleræ˜¯ä¸€ä¸ªå‡½æ•°æˆ–blockå¯¹è±¡ï¼Œç”¨<code>dispatch_source_set_event_handler</code>æˆ–<code>dispatch_source_set_event_handler_f</code>å‡½æ•°å°†å…¶é…ç½®åœ¨è°ƒåº¦æºä¸Šã€‚å½“ä¸€ä¸ªäº‹ä»¶åˆ°æ¥æ—¶ï¼Œè°ƒåº¦æºä¼šå°†äº‹ä»¶handleræäº¤ç»™æŒ‡å®šçš„è°ƒåº¦é˜Ÿåˆ—è¿›è¡Œå¤„ç†ã€‚</p><p>ä½ çš„äº‹ä»¶handlerçš„ä¸»ä½“è´Ÿè´£å¤„ç†ä»»ä½•åˆ°è¾¾çš„äº‹ä»¶ã€‚å¦‚æœä½ çš„äº‹ä»¶handlerå·²ç»åœ¨é˜Ÿåˆ—ä¸­å¹¶ç­‰å¾…å¤„ç†ä¸€ä¸ªäº‹ä»¶ï¼Œå½“ä¸€ä¸ªæ–°çš„äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œè°ƒåº¦æºä¼šå°†è¿™ä¸¤ä¸ªäº‹ä»¶åˆå¹¶èµ·æ¥ã€‚ä¸€ä¸ªäº‹ä»¶handleré€šå¸¸åªçœ‹åˆ°æœ€è¿‘çš„äº‹ä»¶çš„ä¿¡æ¯ï¼Œä½†æ ¹æ®è°ƒåº¦æºçš„ç±»å‹ï¼Œå®ƒä¹Ÿå¯ä»¥è·å¾—å…¶ä»–å·²ç»å‘ç”Ÿå¹¶è¢«åˆå¹¶çš„äº‹ä»¶çš„ä¿¡æ¯ã€‚å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªæ–°çš„äº‹ä»¶åœ¨äº‹ä»¶handlerå¼€å§‹æ‰§è¡Œååˆ°è¾¾ï¼Œè°ƒåº¦æºä¼šä¿ç•™è¿™äº›äº‹ä»¶ï¼Œç›´åˆ°å½“å‰äº‹ä»¶handleræ‰§è¡Œå®Œæ¯•ã€‚è¿™æ—¶ï¼Œå®ƒå°†äº‹ä»¶handlerä¸æ–°çš„äº‹ä»¶ä¸€èµ·å†æ¬¡æäº¤ç»™é˜Ÿåˆ—ã€‚</p><p>åŸºäºå‡½æ•°çš„äº‹ä»¶handleræ¥å—ä¸€ä¸ªå•ä¸€çš„ä¸Šä¸‹æ–‡æŒ‡é’ˆï¼ŒåŒ…å«è°ƒåº¦æºå¯¹è±¡ï¼Œå¹¶ä¸”ä¸è¿”å›ä»»ä½•å€¼ã€‚åŸºäºblockçš„äº‹ä»¶handlerä¸æ¥å—å‚æ•°ï¼Œä¹Ÿæ²¡æœ‰è¿”å›å€¼ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Block-based event handler</span></span><br><span class="line"><span class="keyword">void</span> (^dispatch_block_t)(<span class="keyword">void</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Function-based event handler</span></span><br><span class="line"><span class="keyword">void</span> (*dispatch_function_t)(<span class="keyword">void</span> *)</span><br></pre></td></tr></table></figure><p>åœ¨äº‹ä»¶handlerä¸­ï¼Œä½ å¯ä»¥ä»è°ƒåº¦æºæœ¬èº«è·å¾—å…³äºç»™å®šäº‹ä»¶çš„ä¿¡æ¯ã€‚å°½ç®¡åŸºäºå‡½æ•°çš„äº‹ä»¶handlerè¢«ä¼ é€’ä¸€ä¸ªæŒ‡å‘è°ƒåº¦æºçš„æŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œä½†åŸºäºblockçš„äº‹ä»¶handlerå¿…é¡»è‡ªå·±æ•è·è¿™ä¸ªæŒ‡é’ˆã€‚ä½ å¯ä»¥é€šè¿‡æ­£å¸¸å¼•ç”¨åŒ…å«è°ƒåº¦æºçš„å˜é‡æ¥å®ç°æ•è·æŒ‡é’ˆã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç ç‰‡æ®µæ•è·äº†<code>source</code>å˜é‡ï¼Œå®ƒè¢«å£°æ˜åœ¨blockçš„èŒƒå›´ä¹‹å¤–ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_t source = dispatch_source_create(DISPATCH_SOURCE_TYPE_READ,</span><br><span class="line">                                 myDescriptor, <span class="number">0</span>, myQueue);</span><br><span class="line">dispatch_source_set_event_handler(source, ^&#123;</span><br><span class="line">   <span class="comment">// Get some data from the source variable, which is captured</span></span><br><span class="line">   <span class="comment">// from the parent context.</span></span><br><span class="line">   size_t estimated = dispatch_source_get_data(source);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Continue reading the descriptor...</span></span><br><span class="line">&#125;);</span><br><span class="line">dispatch_resume(source);</span><br></pre></td></tr></table></figure><p>åœ¨blockå†…æ•è·å˜é‡é€šå¸¸æ˜¯ä¸ºäº†è·å¾—æ›´å¤§çš„çµæ´»æ€§å’ŒåŠ¨æ€æ€§ã€‚å½“ç„¶ï¼Œæ•è·çš„å˜é‡åœ¨blockå†…é»˜è®¤ä¸ºåªè¯»ã€‚å°½ç®¡blockåŠŸèƒ½æä¾›äº†å¯¹ç‰¹å®šæƒ…å†µä¸‹ä¿®æ”¹æ•è·å˜é‡çš„æ”¯æŒï¼Œä½†ä½ ä¸åº”è¯¥è¯•å›¾åœ¨ä¸è°ƒåº¦æºç›¸å…³çš„äº‹ä»¶handlerä¸­è¿™æ ·åšã€‚è°ƒåº¦æºæ€»æ˜¯å¼‚æ­¥åœ°æ‰§è¡Œå®ƒä»¬çš„äº‹ä»¶handlerï¼Œæ‰€ä»¥å½“ä½ çš„äº‹ä»¶handleræ‰§è¡Œæ—¶ï¼Œä½ æ•è·çš„ä»»ä½•å˜é‡çš„å®šä¹‰ä½œç”¨åŸŸå¾ˆå¯èƒ½å·²ç»æ¶ˆå¤±ã€‚å…³äºå¦‚ä½•åœ¨blockå†…æ•è·å’Œä½¿ç”¨å˜é‡çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Blocks/Articles/00_Introduction.html#//apple_ref/doc/uid/TP40007502">Blocks Programming Topics</a>ã€‚</p><p>è¡¨4-1åˆ—å‡ºäº†å¯ä»¥ä»äº‹ä»¶handlerä»£ç ä¸­è°ƒç”¨çš„å‡½æ•°ï¼Œä»¥è·å–äº‹ä»¶çš„ä¿¡æ¯ã€‚</p><p><strong>Table 4-1</strong> ä»è°ƒåº¦æºè·å–æ•°æ®</p><p><code>dispatch_source_get_handle</code>ï¼šè¯¥å‡½æ•°è¿”å›è°ƒåº¦æºæ‰€ç®¡ç†çš„åº•å±‚ç³»ç»Ÿæ•°æ®ç±»å‹ã€‚</p><ul><li>å¯¹äºæè¿°ç¬¦è°ƒåº¦æºï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªåŒ…å«ä¸è°ƒåº¦æºç›¸å…³çš„æè¿°ç¬¦çš„<code>int</code>ç±»å‹ã€‚</li><li>å¯¹äºä¸€ä¸ªä¿¡å·è°ƒåº¦æºï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ª<code>int</code>ç±»å‹ï¼ŒåŒ…å«æœ€è¿‘äº‹ä»¶çš„ä¿¡å·ç¼–å·ã€‚</li><li>å¯¹äºä¸€ä¸ªè¿›ç¨‹è°ƒåº¦æºï¼Œæ­¤å‡½æ•°è¿”å›ä¸€ä¸ª<code>pid_t</code>æ•°æ®ç»“æ„ï¼Œç”¨äºè¢«ç›‘æ§çš„è¿›ç¨‹ã€‚</li><li>å¯¹äºä¸€ä¸ªMachç«¯å£è°ƒåº¦æºï¼Œæ­¤å‡½æ•°è¿”å›ä¸€ä¸ª<code>mach_port_t</code>æ•°æ®ç»“æ„ã€‚</li><li>å¯¹äºå…¶ä»–è°ƒåº¦æºï¼Œæ­¤å‡½æ•°è¿”å›çš„å€¼æ˜¯æœªå®šä¹‰çš„ã€‚</li></ul><p><code>dispatch_source_get_data</code> ï¼šæ­¤å‡½æ•°è¿”å›ä¸äº‹ä»¶ç›¸å…³çš„ä»»ä½•æœªå†³ï¼ˆpendingï¼‰æ•°æ®ã€‚</p><ul><li><p>å¯¹äºä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®çš„æè¿°ç¬¦è°ƒåº¦æºï¼Œè¯¥å‡½æ•°è¿”å›å¯ä¾›è¯»å–çš„å­—èŠ‚æ•°ã€‚</p></li><li><p>å¯¹äºå‘æ–‡ä»¶å†™æ•°æ®çš„æè¿°ç¬¦è°ƒåº¦æºï¼Œå¦‚æœæœ‰ç©ºé—´å¯ä¾›å†™å…¥ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæ­£æ•´æ•°ã€‚</p></li><li><p>å¯¹äºç›‘è§†æ–‡ä»¶ç³»ç»Ÿæ´»åŠ¨çš„æè¿°ç¬¦è°ƒåº¦æºï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ª<code>dispatch_source_vnode_flags_t</code>æšä¸¾ï¼Œè¡¨ç¤ºæ‰€å‘ç”Ÿçš„äº‹ä»¶çš„ç±»å‹ã€‚</p></li><li><p>å¯¹äºä¸€ä¸ªè¿›ç¨‹è°ƒåº¦æºï¼Œè¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ª<code>dispatch_source_proc_flags_t</code>æšä¸¾ï¼Œè¡¨ç¤ºå‘ç”Ÿçš„äº‹ä»¶ç±»å‹ã€‚</p></li><li><p>å¯¹äºMachç«¯å£è°ƒåº¦æºï¼Œæ­¤å‡½æ•°è¿”å›ä¸€ä¸ª<code>dispatch_source_machport_flags_t</code>æšä¸¾ï¼Œè¡¨ç¤ºå‘ç”Ÿçš„äº‹ä»¶ç±»å‹ã€‚</p></li><li><p>å¯¹äºè‡ªå®šä¹‰è°ƒåº¦æºï¼Œæ­¤å‡½æ•°è¿”å›ä»ç°æœ‰æ•°æ®å’Œä¼ é€’ç»™<code>dispatch_source_merge_data</code>å‡½æ•°çš„æ–°æ•°æ®åˆ›å»ºçš„æ–°æ•°æ®å€¼ã€‚</p></li></ul><p><code>dispatch_source_get_mask</code>ï¼šè¯¥å‡½æ•°è¿”å›ç”¨äºåˆ›å»ºè°ƒåº¦æºçš„äº‹ä»¶æ ‡å¿—ã€‚</p><ul><li><p>å¯¹äºä¸€ä¸ªè¿›ç¨‹è°ƒåº¦æºï¼Œè¯¥å‡½æ•°è¿”å›è°ƒåº¦æºæ‰€æ¥æ”¶çš„äº‹ä»¶çš„æ©ç ï¼ˆ<code>dispatch_source_proc_flags_t</code>ï¼‰ã€‚</p></li><li><p>å¯¹äºå…·æœ‰å‘é€æƒé™çš„Machç«¯å£è°ƒåº¦æºï¼Œæ­¤å‡½æ•°è¿”å›æ‰€éœ€äº‹ä»¶çš„æ©ç ï¼ˆ<code>dispatch_source_mach_send_flags_t</code>ï¼‰ã€‚</p></li><li><p>å¯¹äºä¸€ä¸ªè‡ªå®šä¹‰ORè°ƒåº¦æºï¼Œæ­¤å‡½æ•°è¿”å›ç”¨äºåˆå¹¶æ•°æ®å€¼çš„æ©ç ã€‚</p></li></ul><p>å…³äºå¦‚ä½•ä¸ºç‰¹å®šç±»å‹çš„è°ƒåº¦æºç¼–å†™å’Œé…ç½®äº‹ä»¶handlerçš„ä¾‹å­ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html#//apple_ref/doc/uid/TP40008091-CH103-SW22">Dispatch Source Examples</a>ã€‚</p><h3 id="é…ç½®å–æ¶ˆhandler">é…ç½®å–æ¶ˆHandler</h3><p>å–æ¶ˆhandlerç”¨äºåœ¨è°ƒåº¦æºè¢«é‡Šæ”¾ä¹‹å‰å¯¹å…¶è¿›è¡Œæ¸…ç†ã€‚å¯¹äºå¤§å¤šæ•°ç±»å‹çš„è°ƒåº¦æºï¼Œå–æ¶ˆhandleræ˜¯å¯é€‰çš„ï¼Œåªæœ‰å½“ä½ æœ‰ä¸€äº›ä¸è°ƒåº¦æºç»‘å®šçš„è‡ªå®šä¹‰è¡Œä¸ºä¹Ÿéœ€è¦è¢«æ›´æ–°æ—¶æ‰æœ‰å¿…è¦ã€‚ç„¶è€Œï¼Œå¯¹äºä½¿ç”¨æè¿°ç¬¦æˆ–Machç«¯å£çš„è°ƒåº¦æºï¼Œä½ å¿…é¡»æä¾›ä¸€ä¸ªå–æ¶ˆhandleræ¥å…³é—­æè¿°ç¬¦æˆ–é‡Šæ”¾Machç«¯å£ã€‚å¦‚æœä¸è¿™æ ·åšï¼Œè¿™äº›ç»“æ„ä½“è¢«ä½ çš„ä»£ç å’Œç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†æ— æ„åœ°é‡ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä»£ç ä¸­å‡ºç°å¾®å¦™çš„é”™è¯¯ã€‚</p><p>å¯ä»¥åœ¨ä»»ä½•æ—¶å€™é…ç½®å–æ¶ˆhandlerï¼Œä½†é€šå¸¸åœ¨åˆ›å»ºè°ƒåº¦æºæ—¶è¿›è¡Œé…ç½®ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>dispatch_source_set_cancel_handler</code>æˆ–<code>dispatch_source_set_cancel_handler_f</code>å‡½æ•°æ¥é…ç½®å–æ¶ˆhandlerï¼Œè¿™å–å†³äºä½ æƒ³åœ¨å®ç°ä¸­ä½¿ç”¨ä¸€ä¸ªblockå¯¹è±¡è¿˜æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚ä¸‹é¢çš„ä¾‹å­æ˜¾ç¤ºäº†ä¸€ä¸ªç®€å•çš„å–æ¶ˆhandlerï¼Œå®ƒå…³é—­äº†ä¸€ä¸ªä¸ºè°ƒåº¦æºæ‰“å¼€çš„æè¿°ç¬¦ã€‚<code>fd</code>å˜é‡æ˜¯ä¸€ä¸ªåŒ…å«æè¿°ç¬¦çš„æ•è·å˜é‡ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_set_cancel_handler(mySource, ^&#123;</span><br><span class="line">   close(fd); <span class="comment">// Close a file descriptor opened earlier.</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹ç›®æ ‡é˜Ÿåˆ—">ä¿®æ”¹ç›®æ ‡é˜Ÿåˆ—</h3><p>å°½ç®¡ä½ åœ¨åˆ›å»ºè°ƒåº¦æºæ—¶æŒ‡å®šäº†è¿è¡Œäº‹ä»¶å’Œå–æ¶ˆhandlerçš„é˜Ÿåˆ—ï¼Œä½†ä½ å¯ä»¥åœ¨ä»»ä½•æ—¶å€™ä½¿ç”¨ <code>dispatch_set_target_queue</code> å‡½æ•°æ”¹å˜è¯¥é˜Ÿåˆ—ã€‚é€šè¿‡è¿™æ ·ä½ å¯ä»¥æ”¹å˜è°ƒåº¦æºçš„äº‹ä»¶å¤„ç†çš„ä¼˜å…ˆçº§ã€‚</p><p>ä¿®æ”¹è°ƒåº¦æºçš„é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œè°ƒåº¦æºä¼šå°½æœ€å¤§åŠªåŠ›å°½å¿«åšå‡ºä¿®æ”¹ã€‚å¦‚æœä¸€ä¸ªäº‹ä»¶handlerå·²ç»åœ¨é˜Ÿåˆ—ä¸­å¹¶ç­‰å¾…å¤„ç†ï¼Œå®ƒå°†åœ¨ä¹‹å‰çš„é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚ç„¶è€Œï¼Œåœ¨ä½ ä¿®æ”¹çš„æ—¶å€™ï¼Œå…¶ä»–åˆ°è¾¾çš„äº‹ä»¶å¯ä»¥åœ¨ä»»ä¸€é˜Ÿåˆ—ä¸­å¤„ç†ã€‚</p><h3 id="å…³è”è‡ªå®šä¹‰æ•°æ®ä¸è°ƒåº¦æº">å…³è”è‡ªå®šä¹‰æ•°æ®ä¸è°ƒåº¦æº</h3><p>åƒGrand Central Dispatchä¸­çš„è®¸å¤šå…¶ä»–æ•°æ®ç±»å‹ä¸€æ ·ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>dispatch_set_context</code>å‡½æ•°æ¥å°†è‡ªå®šä¹‰æ•°æ®ä¸è°ƒåº¦æºå…³è”èµ·æ¥ã€‚å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡æŒ‡é’ˆæ¥å­˜å‚¨äº‹ä»¶handleråœ¨å¤„ç†äº‹ä»¶æ—¶éœ€è¦çš„ä»»ä½•æ•°æ®ã€‚å¦‚æœä½ ç¡®å®åœ¨ä¸Šä¸‹æ–‡æŒ‡é’ˆä¸­å­˜å‚¨äº†ä»»ä½•è‡ªå®šä¹‰æ•°æ®ï¼Œä½ ä¹Ÿåº”è¯¥è®¾ç½®ä¸€ä¸ªå–æ¶ˆhandlerï¼Œä»¥ä¾¿åœ¨ä¸å†éœ€è¦è°ƒåº¦æºæ—¶é‡Šæ”¾è¿™äº›æ•°æ®ã€‚</p><p>å¦‚æœä½ ä½¿ç”¨blockæ¥å®ç°ä½ çš„äº‹ä»¶handlerï¼Œä¹Ÿå¯ä»¥æ•è·å±€éƒ¨å˜é‡å¹¶åœ¨åŸºäºblockçš„ä»£ç ä¸­ä½¿ç”¨å®ƒä»¬ã€‚å°½ç®¡è¿™å¯èƒ½å‡è½»äº†åœ¨è°ƒåº¦æºçš„ä¸Šä¸‹æ–‡æŒ‡é’ˆä¸­å­˜å‚¨æ•°æ®çš„éœ€è¦ï¼Œä½†ä½ åº”è¯¥å§‹ç»ˆè°¨æ…åœ°ä½¿ç”¨è¿™ä¸€åŠŸèƒ½ã€‚å› ä¸ºè°ƒåº¦æºåœ¨ç¨‹åºä¸­å¯èƒ½æ˜¯é•¿æœŸå­˜åœ¨çš„ï¼Œåœ¨æ•è·åŒ…å«æŒ‡é’ˆçš„å˜é‡æ—¶åº”è¯¥å°å¿ƒã€‚å¦‚æœæŒ‡é’ˆæ‰€æŒ‡å‘çš„æ•°æ®åœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«é‡Šæ”¾ï¼Œä½ åº”è¯¥å¤åˆ¶è¯¥æ•°æ®æˆ–ä¿ç•™å®ƒã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œä½ éƒ½éœ€è¦é…ç½®ä¸€ä¸ªå–æ¶ˆhandleræ¥é‡Šæ”¾è¿™äº›æ•°æ®ã€‚</p><h3 id="è°ƒåº¦æºçš„å†…å­˜ç®¡ç†">è°ƒåº¦æºçš„å†…å­˜ç®¡ç†</h3><p>åƒå…¶ä»–è°ƒåº¦å¯¹è±¡ä¸€æ ·ï¼Œè°ƒåº¦æºä¹Ÿæ˜¯æœ‰å¼•ç”¨è®¡æ•°çš„æ•°æ®ç±»å‹ã€‚ä¸€ä¸ªè°ƒåº¦æºçš„åˆå§‹å¼•ç”¨è®¡æ•°ä¸º1ï¼Œå¯ä»¥ä½¿ç”¨<code>dispatch_retain</code>å’Œ<code>dispatch_release</code>å‡½æ•°ä¿ç•™å’Œé‡Šæ”¾ã€‚å½“ä¸€ä¸ªé˜Ÿåˆ—çš„å¼•ç”¨è®¡æ•°è¾¾åˆ°0æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡Šæ”¾è°ƒåº¦æºçš„æ•°æ®ç»“æ„ã€‚</p><p>ç”±äºå®ƒä»¬çš„ä½¿ç”¨æ–¹å¼ï¼Œè°ƒåº¦æºçš„æ‰€æœ‰æƒå¯ä»¥ç”±å†…éƒ¨ç®¡ç†ï¼Œä¹Ÿå¯ä»¥ç”±å¤–éƒ¨ç®¡ç†ã€‚å¯¹äºå¤–éƒ¨æ‰€æœ‰æƒï¼Œå¦ä¸€ä¸ªå¯¹è±¡æˆ–ä¸€æ®µä»£ç æ‹¥æœ‰è°ƒåº¦æºçš„æ‰€æœ‰æƒï¼Œå¹¶è´Ÿè´£åœ¨ä¸å†éœ€è¦å®ƒæ—¶å°†å…¶é‡Šæ”¾ã€‚å¯¹äºå†…éƒ¨æ‰€æœ‰æƒï¼Œè°ƒåº¦æºæŒæœ‰è‡ªå·±ï¼Œå¹¶è´Ÿè´£åœ¨é€‚å½“çš„æ—¶å€™é‡Šæ”¾è‡ªå·±ã€‚å°½ç®¡å¤–éƒ¨æ‰€æœ‰æƒéå¸¸æ™®éï¼Œä½†åœ¨ä½ æƒ³åˆ›å»ºä¸€ä¸ªè‡ªä¸»çš„è°ƒåº¦æºå¹¶è®©å®ƒç®¡ç†ä½ çš„ä»£ç çš„æŸäº›è¡Œä¸ºè€Œä¸è¿›è¡Œä»»ä½•è¿›ä¸€æ­¥çš„äº¤äº’çš„æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨å†…éƒ¨æ‰€æœ‰æƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªè°ƒåº¦æºè¢«è®¾è®¡ä¸ºå“åº”ä¸€ä¸ªå•ä¸€çš„å…¨å±€äº‹ä»¶ï¼Œä½ å¯èƒ½ä¼šè®©å®ƒå¤„ç†è¯¥äº‹ä»¶ï¼Œç„¶åç«‹å³é€€å‡ºã€‚</p><h2 id="è°ƒåº¦æºç¤ºä¾‹">è°ƒåº¦æºç¤ºä¾‹</h2><p>ä¸‹é¢çš„ç« èŠ‚å‘ä½ å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºå’Œé…ç½®ä¸€äº›æ›´å¸¸ç”¨çš„è°ƒåº¦æºã€‚å…³äºé…ç½®ç‰¹å®šç±»å‹çš„è°ƒåº¦æºçš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<em>Grand Central Dispatch (GCD) Reference</em>ã€‚</p><h3 id="åˆ›å»ºå®šæ—¶å™¨">åˆ›å»ºå®šæ—¶å™¨</h3><p>å®šæ—¶å™¨è°ƒåº¦æºä»¥å®šæœŸã€åŸºäºæ—¶é—´çš„é—´éš”äº§ç”Ÿäº‹ä»¶ã€‚ä½ å¯ä»¥ä½¿ç”¨å®šæ—¶å™¨æ¥å¯åŠ¨éœ€è¦å®šæœŸæ‰§è¡Œçš„ç‰¹å®šä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œæ¸¸æˆå’Œå…¶ä»–å›¾å½¢å¯†é›†å‹çš„ç¨‹åºå¯ä»¥ä½¿ç”¨å®šæ—¶å™¨æ¥å¯åŠ¨å±å¹•æˆ–åŠ¨ç”»çš„æ›´æ–°ã€‚ä½ ä¹Ÿå¯ä»¥è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨å¹¶ä½¿ç”¨äº§ç”Ÿçš„äº‹ä»¶æ¥æ£€æŸ¥ç»å¸¸æ›´æ–°çš„æœåŠ¡å™¨ä¸Šçš„æ–°ä¿¡æ¯ã€‚</p><p>æ‰€æœ‰çš„å®šæ—¶å™¨è°ƒåº¦æºéƒ½æ˜¯é—´éš”æ€§çš„å®šæ—¶å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦åˆ›å»ºï¼Œå®ƒä»¬å°±ä¼šæŒ‰ç…§ä½ æŒ‡å®šçš„æ—¶é—´é—´éš”å®šæœŸå‘é€äº‹ä»¶ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨è°ƒåº¦æºæ—¶ï¼Œä½ å¿…é¡»æŒ‡å®šçš„ä¸€ä¸ªå€¼æ˜¯ä¸€ä¸ªleewayå€¼ï¼Œä»¥ä½¿ç³»ç»ŸçŸ¥é“å®šæ—¶å™¨äº‹ä»¶çš„æ‰€éœ€ç²¾åº¦ã€‚leewayå€¼è®©ç³»ç»Ÿåœ¨å¦‚ä½•ç®¡ç†ç”µæºå’Œå”¤é†’å†…æ ¸æ–¹é¢æœ‰ä¸€å®šçš„çµæ´»æ€§ã€‚ä¾‹å¦‚ï¼Œç³»ç»Ÿå¯èƒ½ä¼šä½¿ç”¨leewayå€¼æ¥æå‰æˆ–æ¨è¿Ÿå¯åŠ¨æ—¶é—´ï¼Œå¹¶ä½¿å…¶ä¸å…¶ä»–ç³»ç»Ÿäº‹ä»¶æ›´å¥½åœ°åè°ƒã€‚å› æ­¤ï¼Œä½ åº”è¯¥å°½å¯èƒ½ä¸ºä½ è‡ªå·±çš„å®šæ—¶å™¨æŒ‡å®šä¸€ä¸ªleewayå€¼ã€‚</p><p><strong>æ³¨æ„ï¼š</strong>å³ä½¿ä½ æŒ‡å®šäº†ä¸€ä¸ª0çš„leewayå€¼ï¼Œä½ ä¹Ÿä¸åº”è¯¥æœŸæœ›å®šæ—¶å™¨åœ¨ä½ è¦æ±‚çš„ç²¾ç¡®çº³ç§’å¤„å¯åŠ¨ã€‚ç³»ç»Ÿä¼šå°½åŠ›æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œä½†ä¸èƒ½ä¿è¯ç²¾ç¡®çš„å¯åŠ¨æ—¶é—´ã€‚</p><p>å½“è®¡ç®—æœºè¿›å…¥ç¡çœ çŠ¶æ€æ—¶ï¼Œæ‰€æœ‰çš„å®šæ—¶å™¨è°ƒåº¦æºéƒ½è¢«æš‚åœã€‚å½“è®¡ç®—æœºå”¤é†’æ—¶ï¼Œè¿™äº›å®šæ—¶å™¨è°ƒåº¦æºä¹Ÿä¼šè¢«è‡ªåŠ¨å”¤é†’ã€‚æ ¹æ®å®šæ—¶å™¨çš„é…ç½®ï¼Œè¿™ç§æ€§è´¨çš„æš‚åœå¯èƒ½ä¼šå½±å“å®šæ—¶å™¨ä¸‹ä¸€æ¬¡è§¦å‘çš„æ—¶é—´ã€‚å¦‚æœä½ ä½¿ç”¨<code>dispatch_time</code>å‡½æ•°æˆ–<code>DISPATCH_TIME_NOW</code>å¸¸æ•°æ¥è®¾ç½®ä½ çš„å®šæ—¶å™¨è°ƒåº¦æºï¼Œå®šæ—¶å™¨è°ƒåº¦æºä¼šä½¿ç”¨é»˜è®¤çš„ç³»ç»Ÿæ—¶é’Ÿæ¥å†³å®šä½•æ—¶å¯åŠ¨ã€‚ç„¶è€Œï¼Œå½“è®¡ç®—æœºå¤„äºç¡çœ çŠ¶æ€æ—¶ï¼Œé»˜è®¤çš„æ—¶é’Ÿä¸ä¼šå‰è¿›ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå½“ä½ ä½¿ç”¨<code>dispatch_walltime</code>å‡½æ•°è®¾ç½®ä½ çš„å®šæ—¶å™¨è°ƒåº¦æºæ—¶ï¼Œå®šæ—¶å™¨è°ƒåº¦æºä¼šè·Ÿè¸ªå…¶è§¦å‘æ—¶é—´åˆ°ç»å¯¹ï¼ˆwallï¼‰çš„æ—¶é’Ÿæ—¶é—´ã€‚åè€…é€šå¸¸é€‚ç”¨äºè§¦å‘é—´éš”æ¯”è¾ƒå¤§çš„å®šæ—¶å™¨ï¼Œå› ä¸ºå®ƒå¯ä»¥é˜²æ­¢äº‹ä»¶æ—¶é—´ä¹‹é—´æœ‰å¤ªå¤§çš„æ¼‚ç§»ã€‚</p><p>æ¸…å•4-1æ˜¾ç¤ºäº†ä¸€ä¸ªå®šæ—¶å™¨çš„ä¾‹å­ï¼Œå®ƒæ¯30ç§’è§¦å‘ä¸€æ¬¡ï¼Œleewayä¸º1ç§’ã€‚å› ä¸ºå®šæ—¶å™¨çš„æ—¶é—´é—´éš”æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä½¿ç”¨<code>dispatch_walltime</code>å‡½æ•°æ¥åˆ›å»ºè°ƒåº¦æºã€‚è®¡æ—¶å™¨çš„ç¬¬ä¸€æ¬¡è§¦å‘ç«‹å³å‘ç”Ÿï¼Œéšåçš„äº‹ä»¶æ¯30ç§’åˆ°è¾¾ã€‚<code>MyPeriodicTask</code>å’Œ<code>MyStoreTimer</code>ç¬¦å·ä»£è¡¨è‡ªå®šä¹‰å‡½æ•°ï¼Œç¼–å†™è¿™äº›å‡½æ•°æ¥å®ç°å®šæ—¶å™¨è¡Œä¸ºï¼Œå¹¶å°†å®šæ—¶å™¨å­˜å‚¨åœ¨ç¨‹åºæ•°æ®ç»“æ„çš„æŸä¸ªåœ°æ–¹ã€‚</p><p>ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªé—´éš” 30s leeaway 1s çš„timerã€‚å› ä¸ºé—´éš”è¾ƒå¤§ï¼Œdispatch source ä½¿ç”¨ <code>dispatch_walltime</code> æ¥åˆ›å»ºçš„ã€‚timer åˆæ¬¡ä¼šç«‹å³ fireï¼Œä¹‹åæ¯ 30s åˆ°è¾¾ä¸€æ¬¡ã€‚</p><p><strong>æ¸…å•4-1</strong> åˆ›å»ºå®šæ—¶å™¨æ•°æ®æº</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_t CreateDispatchTimer(uint64_t interval,</span><br><span class="line">              uint64_t leeway,</span><br><span class="line">              <span class="built_in">dispatch_queue_t</span> queue,</span><br><span class="line">              dispatch_block_t block)</span><br><span class="line">&#123;</span><br><span class="line">   dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER,</span><br><span class="line">                                                     <span class="number">0</span>, <span class="number">0</span>, queue);</span><br><span class="line">   <span class="keyword">if</span> (timer)</span><br><span class="line">   &#123;</span><br><span class="line">      dispatch_source_set_timer(timer, dispatch_walltime(<span class="literal">NULL</span>, <span class="number">0</span>), interval, leeway);</span><br><span class="line">      dispatch_source_set_event_handler(timer, block);</span><br><span class="line">      dispatch_resume(timer);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> timer;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">void</span> MyCreateTimer()</span><br><span class="line">&#123;</span><br><span class="line">   dispatch_source_t aTimer = CreateDispatchTimer(<span class="number">30</span>ull * <span class="built_in">NSEC_PER_SEC</span>,</span><br><span class="line">                               <span class="number">1</span>ull * <span class="built_in">NSEC_PER_SEC</span>,</span><br><span class="line">                               dispatch_get_main_queue(),</span><br><span class="line">                               ^&#123; MyPeriodicTask(); &#125;);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Store it somewhere for later use.</span></span><br><span class="line">    <span class="keyword">if</span> (aTimer)</span><br><span class="line">    &#123;</span><br><span class="line">        MyStoreTimer(aTimer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°½ç®¡åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨è°ƒåº¦æºæ˜¯æ¥æ”¶åŸºäºæ—¶é—´çš„äº‹ä»¶çš„ä¸»è¦æ–¹å¼ï¼Œä½†ä¹Ÿæœ‰å…¶ä»–é€‰æ‹©ã€‚å¦‚æœä½ æƒ³åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”åæ‰§è¡Œä¸€æ¬¡blockï¼Œä½ å¯ä»¥ä½¿ç”¨<code>dispatch_after</code>æˆ–<code>dispatch_after_f</code>å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ä¸<code>dispatch_async</code>å‡½æ•°å¾ˆç›¸ä¼¼ï¼Œåªæ˜¯å®ƒå…è®¸ä½ æŒ‡å®šä¸€ä¸ªæ—¶é—´å€¼ï¼Œåœ¨è¿™ä¸ªæ—¶é—´å€¼ä¸Šå°†blockæäº¤ç»™é˜Ÿåˆ—ã€‚æ ¹æ®ä½ çš„éœ€è¦ï¼Œæ—¶é—´å€¼å¯ä»¥æŒ‡å®šä¸ºä¸€ä¸ªç›¸å¯¹çš„æˆ–ç»å¯¹çš„æ—¶é—´å€¼ã€‚</p><h3 id="ä»æè¿°ç¬¦ä¸­è¯»å–æ•°æ®">ä»æè¿°ç¬¦ä¸­è¯»å–æ•°æ®</h3><p>è¦ä»æ–‡ä»¶æˆ–å¥—æ¥å­—ä¸­è¯»å–æ•°æ®ï¼Œä½ å¿…é¡»æ‰“å¼€æ–‡ä»¶æˆ–å¥—æ¥å­—ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª<code>DISPATCH_SOURCE_TYPE_READ</code>ç±»å‹çš„è°ƒåº¦æºã€‚æŒ‡å®šçš„äº‹ä»¶handleråº”è¯¥èƒ½å¤Ÿè¯»å–å’Œå¤„ç†æ–‡ä»¶æè¿°ç¬¦çš„å†…å®¹ã€‚åœ¨å¤„ç†æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œè¿™ç›¸å½“äºè¯»å–æ–‡ä»¶æ•°æ®ï¼ˆæˆ–è¯¥æ•°æ®çš„ä¸€ä¸ªå­é›†ï¼‰ï¼Œå¹¶ä¸ºç¨‹åºåˆ›å»ºé€‚å½“çš„æ•°æ®ç»“æ„ã€‚å¯¹äºç½‘ç»œå¥—æ¥å­—ï¼Œè¿™æ¶‰åŠåˆ°å¤„ç†æ–°æ”¶åˆ°çš„ç½‘ç»œæ•°æ®ã€‚</p><p>æ¯å½“è¯»å–æ•°æ®æ—¶ï¼Œä½ åº”è¯¥å§‹ç»ˆå°†æè¿°ç¬¦é…ç½®ä¸ºä½¿ç”¨éé˜»å¡æ“ä½œã€‚å°½ç®¡å¯ä»¥ä½¿ç”¨<code>dispatch_source_get_data</code>å‡½æ•°æ¥æŸ¥çœ‹æœ‰å¤šå°‘æ•°æ®å¯ä¾›è¯»å–ï¼Œä½†è¯¥å‡½æ•°è¿”å›çš„å€¼åœ¨ä½ è°ƒç”¨æ—¶å’Œä½ å®é™…è¯»å–æ•°æ®æ—¶å¯èƒ½å‘ç”Ÿå˜åŒ–ã€‚å¦‚æœåº•å±‚æ–‡ä»¶è¢«æˆªæ–­æˆ–å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œä»æè¿°ç¬¦ä¸­è¯»å–çš„æ•°æ®ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œä»è€Œä½¿ä½ çš„äº‹ä»¶handleråœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¡æ­»ï¼Œé˜»å¡è°ƒåº¦é˜Ÿåˆ—å…¶ä»–ä»»åŠ¡ã€‚å¯¹äºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œè¿™å¯èƒ½ä¼šä½¿é˜Ÿåˆ—é€ æˆæ­»é”ï¼Œç”šè‡³å¯¹äºä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ï¼Œè¿™ä¹Ÿä¼šå‰Šå‡å¯å¯åŠ¨çš„æ–°ä»»åŠ¡çš„æ•°é‡ã€‚</p><p>æ¸…å•4-2æ˜¾ç¤ºäº†ä¸€ä¸ªé…ç½®è°ƒåº¦æºä»¥ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®çš„ä¾‹å­ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œäº‹ä»¶handlerå°†æŒ‡å®šæ–‡ä»¶çš„å…¨éƒ¨å†…å®¹è¯»å…¥ä¸€ä¸ªç¼“å†²åŒºï¼Œå¹¶è°ƒç”¨ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°æ¥å¤„ç†è¿™äº›æ•°æ®ã€‚è¯¥å‡½æ•°çš„è°ƒç”¨è€…å°†ä½¿ç”¨è¿”å›çš„è°ƒåº¦æºï¼Œåœ¨è¯»å–æ“ä½œå®Œæˆåå–æ¶ˆå®ƒã€‚ä¸ºäº†ç¡®ä¿è°ƒåº¦é˜Ÿåˆ—åœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ä¸ä¼šå‡ºç°ä¸å¿…è¦çš„é˜»å¡ï¼Œæœ¬ä¾‹ä½¿ç”¨<code>fcntl</code>å‡½æ•°æ¥é…ç½®æ–‡ä»¶æè¿°ç¬¦ï¼Œä½¿å…¶æ‰§è¡Œéé˜»å¡æ“ä½œã€‚é…ç½®åœ¨è°ƒåº¦æºä¸Šçš„å–æ¶ˆhandlerç¡®ä¿æ–‡ä»¶æè¿°ç¬¦åœ¨æ•°æ®è¢«è¯»å–åè¢«å…³é—­ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_t ProcessContentsOfFile(<span class="keyword">const</span> <span class="keyword">char</span>* filename)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// Prepare the file for reading.</span></span><br><span class="line">   <span class="keyword">int</span> fd = open(filename, O_RDONLY);</span><br><span class="line">   <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   fcntl(fd, F_SETFL, O_NONBLOCK);  <span class="comment">// Avoid blocking the read operation</span></span><br><span class="line"> </span><br><span class="line">   <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">   dispatch_source_t readSource = dispatch_source_create(DISPATCH_SOURCE_TYPE_READ,</span><br><span class="line">                                   fd, <span class="number">0</span>, queue);</span><br><span class="line">   <span class="keyword">if</span> (!readSource)</span><br><span class="line">   &#123;</span><br><span class="line">      close(fd);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Install the event handler</span></span><br><span class="line">   dispatch_source_set_event_handler(readSource, ^&#123;</span><br><span class="line">      size_t estimated = dispatch_source_get_data(readSource) + <span class="number">1</span>;</span><br><span class="line">      <span class="comment">// Read the data into a text buffer.</span></span><br><span class="line">      <span class="keyword">char</span>* buffer = (<span class="keyword">char</span>*)malloc(estimated);</span><br><span class="line">      <span class="keyword">if</span> (buffer)</span><br><span class="line">      &#123;</span><br><span class="line">         ssize_t actual = read(fd, buffer, (estimated));</span><br><span class="line">         Boolean done = MyProcessFileData(buffer, actual);  <span class="comment">// Process the data.</span></span><br><span class="line"> </span><br><span class="line">         <span class="comment">// Release the buffer when done.</span></span><br><span class="line">         free(buffer);</span><br><span class="line"> </span><br><span class="line">         <span class="comment">// If there is no more data, cancel the source.</span></span><br><span class="line">         <span class="keyword">if</span> (done)</span><br><span class="line">            dispatch_source_cancel(readSource);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Install the cancellation handler</span></span><br><span class="line">   dispatch_source_set_cancel_handler(readSource, ^&#123;close(fd);&#125;);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Start reading the file.</span></span><br><span class="line">   dispatch_resume(readSource);</span><br><span class="line">   <span class="keyword">return</span> readSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè‡ªå®šä¹‰çš„<code>MyProcessFileData</code>å‡½æ•°å†³å®šäº†ä»€ä¹ˆæ—¶å€™å·²ç»è¯»å–äº†è¶³å¤Ÿçš„æ–‡ä»¶æ•°æ®ï¼Œä»€ä¹ˆæ—¶å€™å–æ¶ˆè°ƒåº¦æºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºä»æè¿°ç¬¦ä¸­è¯»å–æ•°æ®è€Œé…ç½®çš„è°ƒåº¦æºä¼šåœ¨ä»æœ‰æ•°æ®éœ€è¦è¯»å–æ—¶é‡å¤è°ƒåº¦å…¶äº‹ä»¶handlerã€‚å¦‚æœå¥—æ¥å­—è¿æ¥å…³é—­æˆ–åˆ°è¾¾æ–‡ä»¶çš„æœ«å°¾ï¼Œè°ƒåº¦æºä¼šè‡ªåŠ¨åœæ­¢è°ƒåº¦äº‹ä»¶handlerã€‚å¦‚æœç¡®å®šä¸éœ€è¦ä¸€ä¸ªè°ƒåº¦æºï¼Œå¯ä»¥è‡ªå·±ç›´æ¥å–æ¶ˆå®ƒã€‚</p><h3 id="æŠŠæ•°æ®å†™å…¥æè¿°ç¬¦ä¸­">æŠŠæ•°æ®å†™å…¥æè¿°ç¬¦ä¸­</h3><p>å‘æ–‡ä»¶æˆ–å¥—æ¥å­—å†™æ•°æ®çš„è¿‡ç¨‹ä¸è¯»æ•°æ®çš„è¿‡ç¨‹éå¸¸ç›¸ä¼¼ã€‚åœ¨ä¸ºå†™æ“ä½œé…ç½®æè¿°ç¬¦åï¼Œä½ è¦åˆ›å»ºä¸€ä¸ª<code>DISPATCH_SOURCE_TYPE_WRITE</code>ç±»å‹çš„è°ƒåº¦æºã€‚ä¸€æ—¦è¯¥è°ƒåº¦æºè¢«åˆ›å»ºï¼Œç³»ç»Ÿå°±ä¼šè°ƒç”¨ä½ çš„äº‹ä»¶handlerï¼Œè®©å®ƒæœ‰æœºä¼šå¼€å§‹å‘æ–‡ä»¶æˆ–å¥—æ¥å­—å†™å…¥æ•°æ®ã€‚å½“ä½ å†™å®Œæ•°æ®åï¼Œä½¿ç”¨<code>dispatch_source_cancel</code>å‡½æ•°æ¥å–æ¶ˆè°ƒåº¦æºã€‚</p><p>æ— è®ºä»€ä¹ˆæ—¶å€™å†™æ•°æ®ï¼Œä½ éƒ½åº”è¯¥å°†æ–‡ä»¶æè¿°ç¬¦é…ç½®ä¸ºä½¿ç”¨éé˜»å¡æ“ä½œã€‚å°½ç®¡ä½ å¯ä»¥ä½¿ç”¨<code>dispatch_source_get_data</code>å‡½æ•°æ¥æŸ¥çœ‹æœ‰å¤šå°‘ç©ºé—´å¯ä¾›å†™å…¥ï¼Œä½†è¯¥å‡½æ•°è¿”å›çš„å€¼åªæ˜¯æŒ‡å¯¼æ€§çš„ï¼Œåœ¨ä½ è°ƒç”¨æ—¶å’Œä½ å®é™…å†™å…¥æ•°æ®æ—¶å¯èƒ½å‘ç”Ÿå˜åŒ–ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œå‘ä¸€ä¸ªé˜»å¡çš„æ–‡ä»¶æè¿°ç¬¦å†™å…¥æ•°æ®å¯èƒ½ä¼šä½¿ä½ çš„äº‹ä»¶handleråœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¡æ­»ï¼Œå¹¶é˜»å¡è°ƒåº¦é˜Ÿåˆ—å…¶ä»–ä»»åŠ¡ã€‚å¯¹äºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œè¿™å¯èƒ½ä¼šä½¿ä½ çš„é˜Ÿåˆ—é€ æˆæ­»é”ï¼Œç”šè‡³å¯¹äºä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ï¼Œè¿™ä¹Ÿä¼šå‰Šå‡å¯ä»¥å¯åŠ¨çš„æ–°ä»»åŠ¡çš„æ•°é‡ã€‚</p><p>æ¸…å•4-3æ˜¾ç¤ºäº†ä½¿ç”¨è°ƒåº¦æºå‘æ–‡ä»¶å†™å…¥æ•°æ®çš„åŸºæœ¬æ–¹æ³•ã€‚åœ¨åˆ›å»ºæ–°æ–‡ä»¶åï¼Œè¯¥å‡½æ•°å°†äº§ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™å…¶äº‹ä»¶handlerã€‚è¢«æ”¾å…¥æ–‡ä»¶çš„æ•°æ®æ˜¯ç”±<code>MyGetData</code>å‡½æ•°æä¾›çš„ï¼Œä½ å¯ä»¥ç”¨éœ€è¦çš„ä»»ä½•ä»£ç æ¥æ›¿æ¢å®ƒï¼Œä»¥ç”Ÿæˆæ–‡ä»¶çš„æ•°æ®ã€‚å°†æ•°æ®å†™å…¥æ–‡ä»¶åï¼Œäº‹ä»¶handlerå–æ¶ˆäº†è°ƒåº¦æºï¼Œä»¥é˜²æ­¢å®ƒè¢«å†æ¬¡è°ƒç”¨ã€‚ç„¶åï¼Œè°ƒåº¦æºçš„æ‰€æœ‰è€…å°†è´Ÿè´£é‡Šæ”¾å®ƒã€‚</p><p><strong>æ¸…å•4-3</strong> å‘æ–‡ä»¶å†™å…¥æ•°æ®</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_t WriteDataToFile(<span class="keyword">const</span> <span class="keyword">char</span>* filename)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(filename, O_WRONLY | O_CREAT | O_TRUNC,</span><br><span class="line">                      (S_IRUSR | S_IWUSR | S_ISUID | S_ISGID));</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    fcntl(fd, F_SETFL); <span class="comment">// Block during the write.</span></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">    dispatch_source_t writeSource = dispatch_source_create(DISPATCH_SOURCE_TYPE_WRITE,</span><br><span class="line">                            fd, <span class="number">0</span>, queue);</span><br><span class="line">    <span class="keyword">if</span> (!writeSource)</span><br><span class="line">    &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    dispatch_source_set_event_handler(writeSource, ^&#123;</span><br><span class="line">        size_t bufferSize = MyGetDataSize();</span><br><span class="line">        <span class="keyword">void</span>* buffer = malloc(bufferSize);</span><br><span class="line"> </span><br><span class="line">        size_t actual = MyGetData(buffer, bufferSize);</span><br><span class="line">        write(fd, buffer, actual);</span><br><span class="line"> </span><br><span class="line">        free(buffer);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Cancel and release the dispatch source when done.</span></span><br><span class="line">        dispatch_source_cancel(writeSource);</span><br><span class="line">    &#125;);</span><br><span class="line"> </span><br><span class="line">    dispatch_source_set_cancel_handler(writeSource, ^&#123;close(fd);&#125;);</span><br><span class="line">    dispatch_resume(writeSource);</span><br><span class="line">    <span class="keyword">return</span> (writeSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç›‘æ§æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡">ç›‘æ§æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡</h3><p>å¦‚æœä½ æƒ³ç›‘è§†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡çš„å˜åŒ–ï¼Œä½ å¯ä»¥è®¾ç½®ä¸€ä¸ª<code>DISPATCH_SOURCE_TYPE_VNODE</code>ç±»å‹çš„è°ƒåº¦æºã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ç§ç±»å‹çš„è°ƒåº¦æºï¼Œåœ¨æ–‡ä»¶è¢«åˆ é™¤ã€å†™å…¥æˆ–é‡å‘½åæ—¶æ¥æ”¶é€šçŸ¥ã€‚ä½ ä¹Ÿå¯ä»¥ç”¨å®ƒåœ¨æ–‡ä»¶çš„ç‰¹å®šç±»å‹çš„å…ƒä¿¡æ¯ï¼ˆå¦‚å®ƒçš„å¤§å°å’Œé“¾æ¥æ•°ï¼‰å‘ç”Ÿå˜åŒ–æ—¶å¾—åˆ°é€šçŸ¥ã€‚</p><p><strong>æ³¨æ„ï¼š</strong>ä½ ä¸ºè°ƒåº¦æºæŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦å¿…é¡»åœ¨æºæœ¬èº«å¤„ç†äº‹ä»¶æ—¶ä¿æŒæ‰“å¼€ã€‚</p><p>æ¸…å•4-4æ˜¾ç¤ºäº†ä¸€ä¸ªä¾‹å­ï¼Œå®ƒç›‘è§†ä¸€ä¸ªæ–‡ä»¶åå˜åŒ–ï¼Œå¹¶åœ¨å®ƒå‘ç”Ÿå˜åŒ–æ—¶æ‰§è¡Œä¸€äº›è‡ªå®šä¹‰è¡Œä¸ºã€‚(ä½ å¯ä»¥æä¾›å®é™…çš„è¡Œä¸ºæ¥ä»£æ›¿ä¾‹å­ä¸­è°ƒç”¨çš„ <code>MyUpdateFileName</code> å‡½æ•°ã€‚)å› ä¸ºä¸€ä¸ªæè¿°ç¬¦æ˜¯ä¸“é—¨ä¸ºè°ƒåº¦æºæ‰“å¼€çš„ï¼Œæ‰€ä»¥è°ƒåº¦æºåŒ…å«ä¸€ä¸ªå…³é—­æè¿°ç¬¦çš„å–æ¶ˆhandlerã€‚å› ä¸ºæœ¬ä¾‹åˆ›å»ºçš„æ–‡ä»¶æè¿°ç¬¦ä¸åº•å±‚æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡ç›¸å…³è”ï¼Œç›¸åŒçš„è°ƒåº¦æºå¯ä»¥ç”¨æ¥æ£€æµ‹ä»»ä½•æ•°é‡çš„æ–‡ä»¶åå˜åŒ–ã€‚</p><p><strong>æ¸…å•4-4</strong> è§‚å¯Ÿæ–‡ä»¶åå˜åŒ–</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_t MonitorNameChangesToFile(<span class="keyword">const</span> <span class="keyword">char</span>* filename)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">int</span> fd = open(filename, O_EVTONLY);</span><br><span class="line">   <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">   dispatch_source_t source = dispatch_source_create(DISPATCH_SOURCE_TYPE_VNODE,</span><br><span class="line">                fd, DISPATCH_VNODE_RENAME, queue);</span><br><span class="line">   <span class="keyword">if</span> (source)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">// Copy the filename for later use.</span></span><br><span class="line">      <span class="keyword">int</span> length = strlen(filename);</span><br><span class="line">      <span class="keyword">char</span>* newString = (<span class="keyword">char</span>*)malloc(length + <span class="number">1</span>);</span><br><span class="line">      newString = strcpy(newString, filename);</span><br><span class="line">      dispatch_set_context(source, newString);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Install the event handler to process the name change</span></span><br><span class="line">      dispatch_source_set_event_handler(source, ^&#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span>*  oldFilename = (<span class="keyword">char</span>*)dispatch_get_context(source);</span><br><span class="line">            MyUpdateFileName(oldFilename, fd);</span><br><span class="line">      &#125;);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Install a cancellation handler to free the descriptor</span></span><br><span class="line">      <span class="comment">// and the stored string.</span></span><br><span class="line">      dispatch_source_set_cancel_handler(source, ^&#123;</span><br><span class="line">          <span class="keyword">char</span>* fileStr = (<span class="keyword">char</span>*)dispatch_get_context(source);</span><br><span class="line">          free(fileStr);</span><br><span class="line">          close(fd);</span><br><span class="line">      &#125;);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Start processing events.</span></span><br><span class="line">      dispatch_resume(source);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      close(fd);</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">return</span> source;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç›‘æ§ä¿¡å·">ç›‘æ§ä¿¡å·</h3><p>UNIXä¿¡å·å…è®¸ä»ä¸€ä¸ªç¨‹åºå¤–å¯¹å…¶è¿›è¡Œæ“çºµã€‚ä¸€ä¸ªç¨‹åºå¯ä»¥æ¥æ”¶è®¸å¤šä¸åŒç±»å‹çš„ä¿¡å·ï¼Œä»ä¸å¯æ¢å¤çš„é”™è¯¯ï¼ˆå¦‚éæ³•æŒ‡ä»¤ï¼‰åˆ°é‡è¦ä¿¡æ¯çš„é€šçŸ¥ï¼ˆå¦‚ä¸€ä¸ªå­è¿›ç¨‹é€€å‡ºæ—¶ï¼‰ã€‚ä¼ ç»Ÿä¸Šï¼Œç¨‹åºä½¿ç”¨<code>sigaction</code>å‡½æ•°æ¥é…ç½®ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨ä¿¡å·åˆ°è¾¾åç«‹å³åŒæ­¥å¤„ç†ã€‚å¦‚æœä½ åªæ˜¯æƒ³å¾—åˆ°ä¿¡å·åˆ°è¾¾çš„é€šçŸ¥ï¼Œè€Œä¸æ˜¯çœŸçš„æƒ³å¤„ç†ä¿¡å·ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªä¿¡å·è°ƒåº¦æºæ¥å¼‚æ­¥å¤„ç†ä¿¡å·ã€‚</p><p>ä¿¡å·è°ƒåº¦æºä¸èƒ½æ›¿ä»£ä½¿ç”¨<code>sigaction</code>å‡½æ•°é…ç½®çš„åŒæ­¥ä¿¡å·handlerã€‚åŒæ­¥ä¿¡å·handlerå®é™…ä¸Šå¯ä»¥æ•è·ä¸€ä¸ªä¿¡å·å¹¶é˜²æ­¢å®ƒç»ˆæ­¢ç¨‹åºã€‚ä¿¡å·è°ƒåº¦æºå…è®¸ä½ åªç›‘æ§ä¿¡å·çš„åˆ°è¾¾ã€‚æ­¤å¤–ï¼Œä½ ä¸èƒ½ä½¿ç”¨ä¿¡å·è°ƒåº¦æºæ¥æ£€ç´¢æ‰€æœ‰ç±»å‹çš„ä¿¡å·ã€‚å…·ä½“æ¥è¯´ï¼Œä½ ä¸èƒ½ç”¨å®ƒä»¬æ¥ç›‘æ§<code>SIGILL</code>ã€<code>SIGBUS</code>å’Œ<code>SIGSEGV</code>ä¿¡å·ã€‚</p><p>å› ä¸ºä¿¡å·è°ƒåº¦æºæ˜¯åœ¨è°ƒåº¦é˜Ÿåˆ—ä¸Šå¼‚æ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¸å—ä¸€äº›ä¸åŒæ­¥ä¿¡å·handlerçš„é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä»ä¿¡å·è°ƒåº¦æºçš„äº‹ä»¶handlerä¸­è°ƒç”¨çš„å‡½æ•°ã€‚è¿™ç§çµæ´»æ€§å¢åŠ çš„ä»£ä»·æ˜¯ï¼Œåœ¨ä¿¡å·åˆ°è¾¾å’Œè°ƒåº¦æºçš„äº‹ä»¶handlerè¢«è°ƒç”¨ä¹‹é—´å¯èƒ½ä¼šæœ‰ä¸€äº›å»¶è¿Ÿã€‚</p><p>æ¸…å•4-5æ˜¾ç¤ºäº†å¦‚ä½•é…ç½®ä¸€ä¸ªä¿¡å·è°ƒåº¦æºæ¥å¤„ç†<code>SIGHUP</code>ä¿¡å·ã€‚è°ƒåº¦æºçš„äº‹ä»¶handlerè°ƒç”¨äº†<code>MyProcessSIGHUP</code>å‡½æ•°ï¼Œä½ å¯ä»¥åœ¨æ­¤å®ç°è‡ªå·±çš„å¤„ç†ä¿¡å·é€»è¾‘ã€‚</p><p><strong>æ¸…å•4-5</strong> é…ç½®blockç›‘æ§ä¿¡å·</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InstallSignalHandler()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// Make sure the signal does not terminate the application.</span></span><br><span class="line">   signal(SIGHUP, SIG_IGN);</span><br><span class="line"> </span><br><span class="line">   <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">   dispatch_source_t source = dispatch_source_create(DISPATCH_SOURCE_TYPE_SIGNAL, SIGHUP, <span class="number">0</span>, queue);</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">if</span> (source)</span><br><span class="line">   &#123;</span><br><span class="line">      dispatch_source_set_event_handler(source, ^&#123;</span><br><span class="line">         MyProcessSIGHUP();</span><br><span class="line">      &#125;);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Start processing signals</span></span><br><span class="line">      dispatch_resume(source);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æ­£åœ¨ä¸ºä¸€ä¸ªè‡ªå®šä¹‰çš„æ¡†æ¶å¼€å‘ä»£ç ï¼Œä½¿ç”¨ä¿¡å·è°ƒåº¦æºçš„ä¸€ä¸ªå¥½å¤„æ˜¯ä»£ç å¯ä»¥ç‹¬ç«‹äºä»»ä½•é“¾æ¥åˆ°å®ƒçš„ç¨‹åºæ¥ç›‘æ§ä¿¡å·ã€‚ä¿¡å·è°ƒåº¦æºä¸ä¼šå¹²æ‰°å…¶ä»–è°ƒåº¦æºæˆ–ç¨‹åºå¯èƒ½é…ç½®çš„ä»»ä½•åŒæ­¥ä¿¡å·handlerã€‚</p><h3 id="ç›‘æ§è¿›ç¨‹">ç›‘æ§è¿›ç¨‹</h3><p>è¿›ç¨‹è°ƒåº¦æºå¯ä»¥è®©ä½ ç›‘æ§ä¸€ä¸ªç‰¹å®šè¿›ç¨‹çš„è¡Œä¸ºï¼Œå¹¶ä½œå‡ºé€‚å½“çš„å“åº”ã€‚ä¸€ä¸ªçˆ¶è¿›ç¨‹å¯ä»¥ä½¿ç”¨è¿™ç§è°ƒåº¦æºæ¥ç›‘è§†å®ƒæ‰€åˆ›å»ºçš„ä»»ä½•å­è¿›ç¨‹ã€‚ä¾‹å¦‚ï¼Œçˆ¶è¿›ç¨‹å¯ä»¥ç”¨å®ƒæ¥ç›‘è§†ä¸€ä¸ªå­è¿›ç¨‹çš„ç»“æŸã€‚åŒæ ·åœ°ï¼Œä¸€ä¸ªå­è¿›ç¨‹å¯ä»¥ç”¨å®ƒæ¥ç›‘è§†å®ƒçš„çˆ¶è¿›ç¨‹ï¼Œå¹¶åœ¨çˆ¶è¿›ç¨‹é€€å‡ºæ—¶é€€å‡ºã€‚</p><p>æ¸…å•4-6æ˜¾ç¤ºäº†é…ç½®ä¸€ä¸ªè°ƒåº¦æºä»¥ç›‘è§†çˆ¶è¿›ç¨‹ç»ˆæ­¢çš„æ­¥éª¤ã€‚å½“çˆ¶è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œè°ƒåº¦æºè®¾ç½®ä¸€äº›å†…éƒ¨çŠ¶æ€ä¿¡æ¯ï¼Œè®©å­è¿›ç¨‹çŸ¥é“å®ƒåº”è¯¥é€€å‡ºã€‚(ç¨‹åºéœ€è¦å®ç°<code>MySetAppExitFlag</code>å‡½æ•°æ¥ä¸ºç»ˆæ­¢è®¾ç½®ä¸€ä¸ªé€‚å½“çš„æ ‡å¿—ã€‚) ç”±äºè°ƒåº¦æºè‡ªä¸»è¿è¡Œï¼Œå› æ­¤æŒæœ‰è‡ªå·±ï¼Œå®ƒä¹Ÿä¼šåœ¨é¢„æœŸç¨‹åºå…³é—­çš„æƒ…å†µä¸‹å–æ¶ˆå’Œé‡Šæ”¾è‡ªå·±ã€‚</p><p><strong>æ¸…å•4-6</strong> ç›‘æ§çˆ¶è¿›ç¨‹çš„ç»ˆæ­¢</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MonitorParentProcess()</span><br><span class="line">&#123;</span><br><span class="line">   pid_t parentPID = getppid();</span><br><span class="line"> </span><br><span class="line">   <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">   dispatch_source_t source = dispatch_source_create(DISPATCH_SOURCE_TYPE_PROC,</span><br><span class="line">                                                      parentPID, DISPATCH_PROC_EXIT, queue);</span><br><span class="line">   <span class="keyword">if</span> (source)</span><br><span class="line">   &#123;</span><br><span class="line">      dispatch_source_set_event_handler(source, ^&#123;</span><br><span class="line">         MySetAppExitFlag();</span><br><span class="line">         dispatch_source_cancel(source);</span><br><span class="line">         dispatch_release(source);</span><br><span class="line">      &#125;);</span><br><span class="line">      dispatch_resume(source);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å–æ¶ˆè°ƒåº¦æº">å–æ¶ˆè°ƒåº¦æº</h2><p>è°ƒåº¦æºä¸€ç›´å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°ä½ ä½¿ç”¨<code>dispatch_source_cancel</code>å‡½æ•°æ˜¾å¼å–æ¶ˆå®ƒä»¬ã€‚å–æ¶ˆä¸€ä¸ªè°ƒåº¦æºä¼šåœæ­¢æ–°äº‹ä»¶çš„ä¼ é€’ï¼Œå¹¶ä¸”ä¸èƒ½è¢«æ’¤é”€ã€‚å› æ­¤ï¼Œé€šå¸¸å–æ¶ˆä¸€ä¸ªè°ƒåº¦æºï¼Œç„¶åå°±ç«‹å³é‡Šæ”¾å®ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RemoveDispatchSource(dispatch_source_t mySource)</span><br><span class="line">&#123;</span><br><span class="line">   dispatch_source_cancel(mySource);</span><br><span class="line">   dispatch_release(mySource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å–æ¶ˆä¸€ä¸ªè°ƒåº¦æºæ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚å°½ç®¡åœ¨ä½ è°ƒç”¨<code>dispatch_source_cancel</code>å‡½æ•°åï¼Œæ²¡æœ‰æ–°çš„äº‹ä»¶è¢«å¤„ç†ï¼Œä½†å·²ç»è¢«è°ƒåº¦æºå¤„ç†çš„äº‹ä»¶è¿˜æ˜¯ç»§ç»­è¢«å¤„ç†ã€‚åœ¨å¤„ç†å®Œä»»ä½•æœ€ç»ˆäº‹ä»¶åï¼Œå¦‚æœæœ‰å–æ¶ˆhandlerï¼Œè°ƒåº¦æºä¼šæ‰§è¡Œå…¶å–æ¶ˆhandlerã€‚</p><p>å–æ¶ˆhandleræ˜¯ä½ é‡Šæ”¾å†…å­˜æˆ–æ¸…ç†ä»£è¡¨è°ƒåº¦æºè·å–çš„ä»»ä½•èµ„æºçš„æœºä¼šã€‚å¦‚æœè°ƒåº¦æºä½¿ç”¨æè¿°ç¬¦æˆ–machç«¯å£ï¼Œä½ å¿…é¡»æä¾›ä¸€ä¸ªå–æ¶ˆhandlerï¼Œä»¥ä¾¿åœ¨å–æ¶ˆå‘ç”Ÿæ—¶å…³é—­æè¿°ç¬¦æˆ–é”€æ¯ç«¯å£ã€‚å…¶ä»–ç±»å‹çš„è°ƒåº¦æºä¸éœ€è¦å–æ¶ˆhandlerï¼Œä½†å¦‚æœä½ å°†ä»»ä½•å†…å­˜æˆ–æ•°æ®ä¸è°ƒåº¦æºå…³è”ï¼Œä»åº”æä¾›ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨è°ƒåº¦æºçš„ä¸Šä¸‹æ–‡æŒ‡é’ˆä¸­å­˜å‚¨æ•°æ®ï¼Œä½ åº”æä¾›å–æ¶ˆhandlerã€‚å…³äºå–æ¶ˆhandlerçš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html#//apple_ref/doc/uid/TP40008091-CH103-SW14">Installing a Cancellation Handler</a>ã€‚</p><h2 id="æš‚åœå’Œæ¢å¤è°ƒåº¦æº">æš‚åœå’Œæ¢å¤è°ƒåº¦æº</h2><p>ä½ å¯ä»¥ä½¿ç”¨<code>dispatch_suspend</code>å’Œ<code>dispatch_resume</code>æ–¹æ³•æš‚åœå’Œæ¢å¤è°ƒåº¦æºäº‹ä»¶çš„ä¼ é€’ã€‚è¿™äº›æ–¹æ³•ä¸ºè°ƒåº¦å¯¹è±¡å¢åŠ å’Œå‡å°‘æš‚åœè®¡æ•°ã€‚å› æ­¤ï¼Œä½ å¿…é¡»åœ¨æ¯æ¬¡å¹³è¡¡è°ƒç”¨<code>dispatch_suspend</code>ä¸è°ƒç”¨<code>dispatch_resume</code>ã€‚</p><p>å½“æš‚åœä¸€ä¸ªè°ƒåº¦æºæ—¶ï¼Œä»»ä½•åœ¨è¯¥è°ƒåº¦æºè¢«æš‚åœæ—¶å‘ç”Ÿçš„äº‹ä»¶éƒ½ä¼šè¢«æ”¶é›†èµ·æ¥ï¼Œç›´åˆ°é˜Ÿåˆ—æ¢å¤ã€‚å½“é˜Ÿåˆ—æ¢å¤æ—¶ï¼Œä¸æ˜¯å‘é€æ‰€æœ‰çš„äº‹ä»¶ï¼Œè€Œæ˜¯åœ¨å‘é€å‰å°†è¿™äº›äº‹ä»¶åˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨ç›‘æ§ä¸€ä¸ªæ–‡ä»¶çš„åç§°å˜åŒ–ï¼Œå‘é€çš„äº‹ä»¶å°†åªåŒ…æ‹¬æœ€åçš„åç§°å˜åŒ–ã€‚ä»¥è¿™ç§æ–¹å¼åˆå¹¶äº‹ä»¶ï¼Œå¯ä»¥é˜²æ­¢å®ƒä»¬åœ¨é˜Ÿåˆ—ä¸­å †ç§¯ï¼Œå¹¶åœ¨å·¥ä½œæ¢å¤æ—¶è®©ä½ çš„ç¨‹åºåº”ä»˜ä¸æ¥ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><ul><li>è°ƒåº¦æºç”¨äºç›‘å¬åº•å±‚ï¼ˆç³»ç»Ÿã€å†…æ ¸ï¼‰äº‹ä»¶ï¼Œå®ç°å¤„ç†äº‹ä»¶å¼‚æ­¥å›è°ƒã€‚æ—¢ç„¶æ˜¯ç”¨äºç›‘å¬ï¼Œå¯¹åº”çš„å°±è¯¥ä¸»åŠ¨å–æ¶ˆã€‚</li><li>åœ¨Swiftä¸­ï¼Œæ ¹æ®è°ƒåº¦æºç±»å‹ï¼Œæœ‰å¯¹åº”çš„åè®®ã€‚ä½†åˆ›å»ºéƒ½æ˜¯ä½¿ç”¨DispatchSourceå¯¹åº”çš„makeç±»å·¥å‚æ–¹æ³•åˆ›å»ºç‰¹å®šç±»å‹çš„è°ƒåº¦æºã€‚è¿™æ ·æ¥æ”¶çš„è°ƒåº¦æºè¿”å›å€¼å°±å¯ä»¥è°ƒç”¨ç‰¹å®šç±»å‹åè®®çš„å…·ä½“æ–¹æ³•ã€‚</li><li>è°ƒåº¦æºçš„é€šç”¨æ–¹æ³•éƒ½å®šä¹‰åœ¨DispatchSourceProtocolã€‚<ul><li>é…ç½®ï¼š<code>setRegistrationHandler</code>ã€<code>setEventHandler</code>ã€<code>setCancelHandler</code></li><li>åŸºæœ¬æ“ä½œï¼š<code>activate</code>ã€<code>cancel</code>ã€<code>suspend</code>ã€<code>resume</code>ã€</li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ¯å½“ä½ ä¸åº•å±‚ç³»ç»Ÿæ‰“äº¤é“æ—¶ï¼Œå¿…é¡»å‡†å¤‡å¥½è¯¥ä»»åŠ¡å¯èƒ½éœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´ã€‚å¯¹å†…æ ¸æˆ–å…¶ä»–ç³»ç»Ÿå±‚çš„è°ƒç”¨æ¶‰åŠåˆ°ä¸Šä¸‹æ–‡çš„æ”¹å˜ï¼Œä¸å‘ç”Ÿåœ¨è¿›ç¨‹ä¸­çš„è°ƒç”¨ç›¸æ¯”ï¼Œè¿™ç§æ”¹å˜æ˜¯ç›¸å½“æ˜‚è´µçš„ã€‚å› æ­¤ï¼Œè®¸å¤šç³»ç»Ÿåº“æä¾›äº†å¼‚æ­¥æ¥å£ï¼Œå…è®¸ä½ çš„ä»£ç å‘ç³»ç»Ÿæäº¤ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶åœ¨å¤„ç†è¯¥è¯·æ±‚æ—¶ç»§ç»­åšå…¶ä»–å·¥ä½œã€‚Grand Central Dispatchå»ºç«‹åœ¨è¿™ç§ä¸€èˆ¬è¡Œä¸ºçš„åŸºç¡€ä¸Šï¼Œå…è®¸ä½ æäº¤è¯·æ±‚ï¼Œå¹¶ä½¿ç”¨blockå’Œè°ƒåº¦é˜Ÿåˆ—å°†ç»“æœåé¦ˆç»™ä½ çš„ä»£ç ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Concurrency Programming Guide" scheme="https://bqlin.github.io/tags/Concurrency-Programming-Guide/"/>
    
    <category term="å¤šçº¿ç¨‹" scheme="https://bqlin.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Concurrency Programming Guideï¼šè°ƒåº¦é˜Ÿåˆ—</title>
    <link href="https://bqlin.github.io/posts/concurrency_pg_dispatch_queues/"/>
    <id>https://bqlin.github.io/posts/concurrency_pg_dispatch_queues/</id>
    <published>2021-09-08T09:42:58.000Z</published>
    <updated>2021-11-13T09:49:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>Grand Central Dispatchï¼ˆGCDï¼‰è°ƒåº¦é˜Ÿåˆ—æ˜¯æ‰§è¡Œä»»åŠ¡çš„å¼ºå¤§å·¥å…·ã€‚è°ƒåº¦é˜Ÿåˆ—è®©ä½ å¯ä»¥ç›¸å¯¹äºè°ƒç”¨è€…å¼‚æ­¥æˆ–åŒæ­¥åœ°æ‰§è¡Œä»»æ„çš„ä»£ç å—ã€‚ä½ å¯ä»¥ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—æ¥æ‰§è¡Œå‡ ä¹æ‰€æœ‰ä½ è¿‡å»åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ä»»åŠ¡ã€‚è°ƒåº¦é˜Ÿåˆ—çš„ä¼˜ç‚¹æ˜¯ä½¿ç”¨èµ·æ¥æ›´ç®€å•ï¼Œæ‰§è¡Œä»»åŠ¡çš„æ•ˆç‡ç›¸æ¯”çº¿ç¨‹ä»£ç é«˜å¾—å¤šã€‚</p><p>æœ¬ç« ä»‹ç»äº†è°ƒåº¦é˜Ÿåˆ—ï¼Œä»¥åŠå¦‚ä½•æ‰§è¡Œç¨‹åºä¸­çš„ä¸€èˆ¬ä»»åŠ¡ã€‚å¦‚æœä½ æƒ³ç”¨è°ƒåº¦é˜Ÿåˆ—æ›¿æ¢ç°æœ‰çš„çº¿ç¨‹ä»£ç ï¼Œå¯å‚é˜…<a href=".%2F05%20Migrating%20Away%20from%20Threads.md">è¿ç§»çº¿ç¨‹ä»£ç </a>ã€‚</p><span id="more"></span><h2 id="å…³äºè°ƒåº¦é˜Ÿåˆ—">å…³äºè°ƒåº¦é˜Ÿåˆ—</h2><p>è°ƒåº¦é˜Ÿåˆ—æ˜¯åœ¨ç¨‹åºä¸­å¼‚æ­¥å’Œå¹¶å‘åœ°æ‰§è¡Œä»»åŠ¡çš„ä¸€ç§ç®€å•æ–¹æ³•ã€‚ä¸€ä¸ª<em>ä»»åŠ¡</em>åªæ˜¯ç¨‹åºéœ€è¦æ‰§è¡Œçš„ä¸€äº›å·¥ä½œã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œä¸€äº›è®¡ç®—ï¼Œåˆ›å»ºæˆ–ä¿®æ”¹ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå¤„ç†ä»æ–‡ä»¶ä¸­è¯»å–çš„ä¸€äº›æ•°æ®ï¼Œæˆ–ä»»ä½•æ•°é‡çš„äº‹æƒ…ã€‚å®šä¹‰ä»»åŠ¡çš„æ–¹å¼æ˜¯å°†ç›¸åº”çš„ä»£ç æ”¾åœ¨ä¸€ä¸ªå‡½æ•°æˆ–ä¸€ä¸ªblockå¯¹è±¡ä¸­ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ä¸€ä¸ªè°ƒåº¦é˜Ÿåˆ—ä¸­ã€‚</p><p>è°ƒåº¦é˜Ÿåˆ—æ˜¯ä¸€ä¸ªç±»ä¼¼äºå¯¹è±¡çš„ç»“æ„ï¼Œç®¡ç†æäº¤ç»™å®ƒçš„ä»»åŠ¡ã€‚æ‰€æœ‰è°ƒåº¦é˜Ÿåˆ—éƒ½æ˜¯å…ˆå…¥å…ˆå‡ºçš„æ•°æ®ç»“æ„ã€‚å› æ­¤ï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ€»æ˜¯æŒ‰ç…§å®ƒä»¬è¢«æ·»åŠ çš„ç›¸åŒé¡ºåºå¯åŠ¨ã€‚GCDå·²ç»æä¾›äº†ä¸€äº›è°ƒåº¦é˜Ÿåˆ—ï¼Œä½†ä½ ä¹Ÿå¯ä»¥ä¸ºç‰¹å®šçš„ç›®çš„è€Œåˆ›å»ºå…¶ä»–è°ƒåº¦é˜Ÿåˆ—ã€‚è¡¨3-1åˆ—å‡ºäº†ç¨‹åºå¯ç”¨çš„è°ƒåº¦é˜Ÿåˆ—çš„ç±»å‹åŠå…¶ç”¨æ³•ã€‚</p><p><strong>è¡¨3-1</strong> è°ƒåº¦é˜Ÿåˆ—ç±»å‹</p><table><colgroup><col style="width: 14%" /><col style="width: 85%" /></colgroup><thead><tr class="header"><th>ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr class="odd"><td>ä¸²è¡Œ</td><td>ä¸²è¡Œé˜Ÿåˆ—ï¼ˆä¹Ÿç§°ä¸º<em>ç§æœ‰è°ƒåº¦é˜Ÿåˆ—</em>ï¼‰æŒ‰ç…§æ·»åŠ åˆ°é˜Ÿåˆ—çš„é¡ºåºï¼Œä¸€æ¬¡æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚å½“å‰æ‰§è¡Œçš„ä»»åŠ¡åœ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸Šè¿è¡Œï¼ˆå¯ä»¥å› ä»»åŠ¡è€Œå¼‚ï¼‰ï¼Œè¯¥çº¿ç¨‹ç”±è°ƒåº¦é˜Ÿåˆ—ç®¡ç†ã€‚ä¸²è¡Œé˜Ÿåˆ—é€šå¸¸ç”¨äºåŒæ­¥è®¿é—®ç‰¹å®šçš„èµ„æºã€‚<br />ä½ å¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºè¶³å¤Ÿå¤šçš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—ç›¸å¯¹äºæ‰€æœ‰å…¶ä»–é˜Ÿåˆ—éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœä½ åˆ›å»ºäº†å››ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—ä¸€æ¬¡åªæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä½†æœ€å¤šå¯ä»¥æœ‰å››ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œæ¯ä¸ªé˜Ÿåˆ—ä¸€ä¸ªã€‚æœ‰å…³å¦‚ä½•åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—çš„ä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW6">Creating Serial Dispatch Queues</a>ã€‚</td></tr><tr class="even"><td>å¹¶å‘</td><td>å¹¶å‘é˜Ÿåˆ—ï¼ˆä¹Ÿè¢«ç§°ä¸º<em>å…¨å±€è°ƒåº¦é˜Ÿåˆ—</em>çš„ä¸€ç§ç±»å‹ï¼‰åŒæ—¶æ‰§è¡Œä¸€æˆ–å¤šä¸ªä»»åŠ¡ï¼Œä½†ä»»åŠ¡ä»ç„¶æŒ‰ç…§å®ƒä»¬è¢«æ·»åŠ åˆ°é˜Ÿåˆ—çš„é¡ºåºå¯åŠ¨ã€‚å½“å‰æ‰§è¡Œçš„ä»»åŠ¡åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¿è¡Œï¼Œè¿™äº›çº¿ç¨‹ç”±è°ƒåº¦é˜Ÿåˆ—ç®¡ç†ã€‚åœ¨ä»»ä½•æ—¶å€™æ‰§è¡Œçš„ä»»åŠ¡çš„ç¡®åˆ‡æ•°é‡æ˜¯æ ¹æ®ç³»ç»Ÿæ¡ä»¶è€Œå†³å®šã€‚<br />åœ¨iOS 5å’Œæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®š<code>DISPATCH_QUEUE_CONCURRENT</code>é˜Ÿåˆ—ç±»å‹ï¼Œè‡ªå·±åˆ›å»ºå¹¶å‘çš„è°ƒåº¦é˜Ÿåˆ—ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰å››ä¸ªé¢„å®šä¹‰çš„å…¨å±€å¹¶å‘é˜Ÿåˆ—ä¾›ç¨‹åºä½¿ç”¨ã€‚å…³äºå¦‚ä½•è·å¾—å…¨å±€å¹¶å‘é˜Ÿåˆ—çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW5">Getting the Global Concurrent Dispatch Queues</a>ã€‚</td></tr><tr class="odd"><td>ä¸»è°ƒåº¦é˜Ÿåˆ—</td><td>ä¸»è°ƒåº¦é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå…¨å±€å¯ç”¨çš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œåœ¨ç¨‹åºçš„ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ã€‚è¿™ä¸ªé˜Ÿåˆ—ä¸ç¨‹åºçš„run loopï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰é…åˆå·¥ä½œï¼Œå°†é˜Ÿåˆ—ä»»åŠ¡çš„æ‰§è¡Œä¸è¿æ¥åˆ°run loopçš„å…¶ä»–äº‹ä»¶æºçš„æ‰§è¡Œäº¤é”™è¿›è¡Œã€‚å› ä¸ºå®ƒåœ¨ç¨‹åºçš„ä¸»çº¿ç¨‹ä¸Šè¿è¡Œï¼Œæ‰€ä»¥ä¸»é˜Ÿåˆ—ç»å¸¸è¢«ç”¨ä½œç¨‹åºçš„å…³é”®åŒæ­¥ç‚¹ã€‚<br />è™½ç„¶ä½ ä¸éœ€è¦åˆ›å»ºä¸»è°ƒåº¦é˜Ÿåˆ—ï¼Œä½†ä½ éœ€è¦ç¡®ä¿ç¨‹åºé€‚å½“åœ°ä½¿ç”¨å®ƒã€‚å…³äºå¦‚ä½•ç®¡ç†è¯¥é˜Ÿåˆ—çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW15">Performing Tasks on the Main Thread</a>ã€‚</td></tr></tbody></table><p>å½“æ¶‰åŠåˆ°å‘ç¨‹åºæ·»åŠ å¹¶å‘ç‰¹æ€§æ—¶ï¼Œè°ƒåº¦é˜Ÿåˆ—æ¯”çº¿ç¨‹æœ‰å‡ ä¸ªä¼˜åŠ¿ã€‚æœ€ç›´æ¥çš„ä¼˜åŠ¿æ˜¯å·¥ä½œé˜Ÿåˆ—ç¼–ç¨‹æ¨¡å‹çš„ç®€å•æ€§ã€‚å¯¹äºçº¿ç¨‹ï¼Œä½ å¿…é¡»ä¸ºè¦æ‰§è¡Œçš„å·¥ä½œä»¥åŠçº¿ç¨‹æœ¬èº«çš„åˆ›å»ºå’Œç®¡ç†ç¼–å†™ä»£ç ã€‚è°ƒåº¦é˜Ÿåˆ—è®©ä½ ä¸“æ³¨äºä½ çœŸæ­£æƒ³è¦æ‰§è¡Œçš„å·¥ä½œï¼Œè€Œä¸å¿…æ‹…å¿ƒçº¿ç¨‹çš„åˆ›å»ºå’Œç®¡ç†ã€‚ç›¸åï¼Œç³»ç»Ÿä¸ºä½ å¤„ç†æ‰€æœ‰çš„çº¿ç¨‹åˆ›å»ºå’Œç®¡ç†ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œç³»ç»Ÿèƒ½å¤Ÿæ¯”ä»»ä½•å•ä¸ªç¨‹åºæ›´æœ‰æ•ˆåœ°ç®¡ç†çº¿ç¨‹ã€‚ç³»ç»Ÿå¯ä»¥æ ¹æ®å¯ç”¨çš„èµ„æºå’Œå½“å‰çš„ç³»ç»Ÿæ¡ä»¶ï¼ŒåŠ¨æ€åœ°æ‰©å±•çº¿ç¨‹çš„æ•°é‡ã€‚æ­¤å¤–ï¼Œç³»ç»Ÿé€šå¸¸èƒ½å¤Ÿæ¯”ä½ è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹æ›´å¿«åœ°å¼€å§‹è¿è¡Œä½ çš„ä»»åŠ¡ã€‚</p><p>å°½ç®¡ä½ å¯èƒ½è®¤ä¸ºä¸ºè°ƒåº¦é˜Ÿåˆ—é‡å†™ä»£ç ä¼šå¾ˆå›°éš¾ï¼Œä½†ä¸ºè°ƒåº¦é˜Ÿåˆ—ç¼–å†™ä»£ç å¾€å¾€æ¯”ä¸ºçº¿ç¨‹å†™ä»£ç è¦å®¹æ˜“ã€‚ç¼–å†™ä»£ç çš„å…³é”®æ˜¯è®¾è®¡è‡ªæˆä¸€ä½“ä¸”èƒ½å¤Ÿå¼‚æ­¥è¿è¡Œçš„ä»»åŠ¡ã€‚ï¼ˆè¿™å¯¹çº¿ç¨‹å’Œè°ƒåº¦é˜Ÿåˆ—éƒ½æ˜¯å¦‚æ­¤ã€‚ï¼‰ç„¶è€Œï¼Œè°ƒåº¦é˜Ÿåˆ—çš„ä¼˜åŠ¿åœ¨äºå¯é¢„æµ‹æ€§ã€‚å¦‚æœä½ æœ‰ä¸¤ä¸ªè®¿é—®åŒä¸€å…±äº«èµ„æºçš„ä»»åŠ¡ï¼Œä½†åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¿è¡Œï¼Œä»»ä½•ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥å…ˆä¿®æ”¹èµ„æºï¼Œä½ éœ€è¦ä½¿ç”¨ä¸€ä¸ªé”æ¥ç¡®ä¿ä¸¤ä¸ªä»»åŠ¡ä¸ä¼šåŒæ—¶ä¿®æ”¹è¯¥èµ„æºã€‚æœ‰äº†è°ƒåº¦é˜Ÿåˆ—ï¼Œä½ å¯ä»¥å°†ä¸¤ä¸ªä»»åŠ¡æ·»åŠ åˆ°ä¸€ä¸ªä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œä»¥ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™åªæœ‰ä¸€ä¸ªä»»åŠ¡ä¿®æ”¹èµ„æºã€‚è¿™ç§åŸºäºé˜Ÿåˆ—çš„åŒæ­¥æ¯”é”æ›´æœ‰æ•ˆï¼Œå› ä¸ºé”åœ¨æœ‰äº‰è®®å’Œæ— äº‰è®®çš„æƒ…å†µä¸‹æ€»æ˜¯éœ€è¦ä¸€ä¸ªæ˜‚è´µçš„å†…æ ¸é™·é˜±ï¼ˆkernel trapï¼‰ï¼Œè€Œè°ƒåº¦é˜Ÿåˆ—ä¸»è¦åœ¨ç¨‹åºçš„è¿›ç¨‹ç©ºé—´å·¥ä½œï¼Œåªæœ‰åœ¨ç»å¯¹å¿…è¦æ—¶æ‰ä¼šå‘ä¸‹è°ƒç”¨å†…æ ¸ã€‚</p><p>å°½ç®¡ä½ ä¼šæ­£ç¡®åœ°æŒ‡å‡ºï¼Œåœ¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ä¸­è¿è¡Œçš„ä¸¤ä¸ªä»»åŠ¡ä¸ä¼šå¹¶å‘è¿è¡Œï¼Œä½†ä½ å¿…é¡»è®°ä½ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å–å¾—ä¸€ä¸ªé”ï¼Œé‚£ä¹ˆçº¿ç¨‹æä¾›çš„ä»»ä½•å¹¶å‘æ€§éƒ½ä¼šä¸¢å¤±æˆ–å¤§å¤§é™ä½ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œçº¿ç¨‹æ¨¡å‹éœ€è¦åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œè¿™éœ€è¦å ç”¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„å†…å­˜ã€‚è°ƒåº¦é˜Ÿåˆ—ä¸ä¼šä¸ºå®ƒä»¬çš„çº¿ç¨‹è€Œæ¶ˆè€—åŒæ ·çš„å†…å­˜ï¼Œè€Œä¸”ä»–ä»¬ä½¿ç”¨çš„çº¿ç¨‹ä¼šä¿æŒæŒç»­å·¥ä½œï¼Œä¸ä¼šè¢«é˜»å¡ã€‚</p><p>å…³äºè°ƒåº¦é˜Ÿåˆ—ï¼Œéœ€è¦è®°ä½çš„å…¶ä»–ä¸€äº›å…³é”®ç‚¹ï¼š</p><ul><li><p>è°ƒåº¦é˜Ÿåˆ—ç›¸å¯¹äºå…¶ä»–è°ƒåº¦é˜Ÿåˆ—æ¥è¯´ï¼Œæ˜¯åŒæ—¶æ‰§è¡Œå…¶ä»»åŠ¡çš„ã€‚ä»»åŠ¡çš„ä¸²è¡Œæ˜¯ç›¸å¯¹äºä¸€ä¸ªè°ƒåº¦é˜Ÿåˆ—è€Œè¨€çš„ã€‚</p></li><li><p>ç³»ç»Ÿå†³å®šäº†åœ¨ä»»ä½•æ—¶å€™æ‰§è¡Œçš„ä»»åŠ¡æ€»æ•°ã€‚å› æ­¤ï¼Œä¸€ä¸ªåœ¨100ä¸ªä¸åŒé˜Ÿåˆ—ä¸­æœ‰100ä¸ªä»»åŠ¡çš„ç¨‹åºå¯èƒ½ä¸ä¼šå¹¶å‘åœ°æ‰§è¡Œæ‰€æœ‰è¿™äº›ä»»åŠ¡ï¼ˆé™¤éå®ƒæœ‰100ä¸ªæˆ–æ›´å¤šçš„æœ‰æ•ˆå†…æ ¸ï¼‰ã€‚</p></li><li><p>ç³»ç»Ÿåœ¨é€‰æ‹©å¯åŠ¨å“ªäº›æ–°ä»»åŠ¡æ—¶ï¼Œä¼šè€ƒè™‘åˆ°é˜Ÿåˆ—çš„ä¼˜å…ˆçº§ã€‚å…³äºå¦‚ä½•è®¾ç½®ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—çš„ä¼˜å…ˆçº§ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW7">Providing a Clean Up Function For a Queue</a>ã€‚</p></li><li><p>é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åœ¨è¢«æ·»åŠ åˆ°é˜Ÿåˆ—æ—¶ï¼Œå¿…é¡»å‡†å¤‡å¥½æ‰§è¡Œã€‚ï¼ˆå¦‚æœä¹‹å‰ä½¿ç”¨è¿‡Cocoaæ“ä½œå¯¹è±¡ï¼Œè¯·æ³¨æ„è¿™ç§è¡Œä¸ºä¸æ“ä½œå¯¹è±¡ä½¿ç”¨çš„æ¨¡å‹ä¸åŒã€‚ï¼‰</p></li><li><p>ç§æœ‰è°ƒåº¦é˜Ÿåˆ—æ˜¯å¼•ç”¨è®¡æ•°çš„å¯¹è±¡ã€‚é™¤äº†åœ¨ä½ è‡ªå·±çš„ä»£ç ä¸­ä¿ç•™é˜Ÿåˆ—å¤–ï¼Œè¦æ³¨æ„è°ƒåº¦æºä¹Ÿå¯ä»¥é™„åŠ åˆ°é˜Ÿåˆ—ä¸Šï¼Œä¹Ÿä¼šå¢åŠ å…¶ä¿ç•™è®¡æ•°ã€‚å› æ­¤ï¼Œä½ å¿…é¡»ç¡®ä¿æ‰€æœ‰çš„è°ƒåº¦æºéƒ½è¢«å–æ¶ˆï¼Œæ‰€æœ‰çš„ä¿ç•™è°ƒç”¨éƒ½ä¸é€‚å½“çš„é‡Šæ”¾è°ƒç”¨ç›¸å¹³è¡¡ã€‚å…³äºä¿ç•™å’Œé‡Šæ”¾é˜Ÿåˆ—çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW11">Memory Management for Dispatch Queues</a>ã€‚å…³äºè°ƒåº¦æºçš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href=".%2F04%20Dispatch%20Sources.md">è°ƒåº¦æº</a>ã€‚</p></li></ul><h2 id="é˜Ÿåˆ—ç›¸å…³æŠ€æœ¯">é˜Ÿåˆ—ç›¸å…³æŠ€æœ¯</h2><p>é™¤äº†è°ƒåº¦é˜Ÿåˆ—ä¹‹å¤–ï¼ŒGrand Central Dispatchè¿˜æä¾›äº†ä¸€äº›ä½¿ç”¨é˜Ÿåˆ—æ¥å¸®åŠ©ç®¡ç†ä»£ç çš„æŠ€æœ¯ã€‚è¡¨3-2åˆ—å‡ºäº†è¿™äº›æŠ€æœ¯ï¼Œå¹¶æä¾›äº†é“¾æ¥ï¼Œä½ å¯ä»¥åœ¨é‚£é‡Œæ‰¾åˆ°å…³äºå®ƒä»¬çš„æ›´å¤šä¿¡æ¯ã€‚</p><p><strong>è¡¨3-2</strong> ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—çš„æŠ€æœ¯</p><table><colgroup><col style="width: 14%" /><col style="width: 85%" /></colgroup><thead><tr class="header"><th>æŠ€æœ¯</th><th>æè¿°</th></tr></thead><tbody><tr class="odd"><td>è°ƒåº¦ç»„</td><td>è°ƒåº¦ç»„æ˜¯ä¸€ç§ç›‘è§†ä¸€ç»„blockå¯¹è±¡å®Œæˆçš„æ–¹å¼ã€‚ä½ å¯ä»¥æ ¹æ®ä½ çš„éœ€è¦åŒæ­¥æˆ–å¼‚æ­¥åœ°ç›‘è§†è¿™äº›blockã€‚å¯¹äºä¾èµ–å…¶ä»–ä»»åŠ¡å®Œæˆçš„ä»£ç ï¼Œç»„æä¾›äº†ä¸€ç§æœ‰ç”¨çš„åŒæ­¥æœºåˆ¶ã€‚å…³äºä½¿ç”¨ç»„çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW25">Waiting on Groups of Queued Tasks</a>ã€‚</td></tr><tr class="even"><td>è°ƒåº¦ä¿¡å·é‡</td><td>è°ƒåº¦ä¿¡å·ä¸ä¼ ç»Ÿçš„ä¿¡å·é‡ç±»ä¼¼ï¼Œä½†é€šå¸¸æ›´æœ‰æ•ˆç‡ã€‚åªæœ‰å½“è°ƒç”¨çº¿ç¨‹å› ä¸ºä¿¡å·é‡ä¸å¯ç”¨è€Œéœ€è¦è¢«é˜»å¡æ—¶ï¼Œè°ƒåº¦ä¿¡å·é‡æ‰ä¼šå‘ä¸‹è°ƒç”¨å†…æ ¸ã€‚å¦‚æœä¿¡å·é‡æ˜¯å¯ç”¨çš„ï¼Œåˆ™ä¸ä¼šè°ƒç”¨å†…æ ¸ã€‚å…³äºå¦‚ä½•ä½¿ç”¨è°ƒåº¦ä¿¡å·é‡çš„ä¾‹å­ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW24">Using Dispatch Semaphores to Regulate the Use of Finite Resources</a>ã€‚</td></tr><tr class="odd"><td>è°ƒåº¦æº</td><td>è°ƒåº¦æºåœ¨å“åº”ç‰¹å®šç±»å‹çš„ç³»ç»Ÿäº‹ä»¶æ—¶ç”Ÿæˆé€šçŸ¥ã€‚ä½ å¯ä»¥ä½¿ç”¨è°ƒåº¦æºæ¥ç›‘æ§äº‹ä»¶ï¼Œå¦‚è¿›ç¨‹é€šçŸ¥ã€ä¿¡å·å’Œæè¿°ç¬¦äº‹ä»¶ç­‰ç­‰ã€‚å½“ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè°ƒåº¦æºä¼šå°†ä½ çš„ä»»åŠ¡ä»£ç å¼‚æ­¥æäº¤ç»™æŒ‡å®šçš„è°ƒåº¦é˜Ÿåˆ—è¿›è¡Œå¤„ç†ã€‚å…³äºåˆ›å»ºå’Œä½¿ç”¨è°ƒåº¦æºçš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href=".%2F04%20Dispatch%20Sources.md">è°ƒåº¦æº</a>ã€‚</td></tr></tbody></table><h2 id="ä½¿ç”¨blockæ¥å®ç°ä»»åŠ¡">ä½¿ç”¨Blockæ¥å®ç°ä»»åŠ¡</h2><p>Blockå¯¹è±¡æ˜¯ä¸€ç§åŸºäºCè¯­è¨€çš„ç‰¹æ€§ï¼Œä½ å¯ä»¥åœ¨Cã€Objective-Cå’ŒC++ä»£ç ä¸­ä½¿ç”¨ã€‚Blockä½¿å¾—å®šä¹‰ä¸€ä¸ªç‹¬ç«‹çš„å·¥ä½œå•å…ƒå˜å¾—å®¹æ˜“ã€‚å°½ç®¡å®ƒä»¬çœ‹èµ·æ¥ç±»ä¼¼äºå‡½æ•°æŒ‡é’ˆï¼Œä½†blockå®é™…ä¸Šæ˜¯ç”±ä¸€ä¸ªç±»ä¼¼äºå¯¹è±¡çš„åº•å±‚æ•°æ®ç»“æ„è¡¨ç¤ºçš„ï¼Œå¹¶ç”±ç¼–è¯‘å™¨ä¸ºä½ åˆ›å»ºå’Œç®¡ç†ã€‚ç¼–è¯‘å™¨å°†ä½ æä¾›çš„ä»£ç ï¼ˆä»¥åŠä»»ä½•ç›¸å…³çš„æ•°æ®ï¼‰æ‰“åŒ…ï¼Œå¹¶å°†å…¶å°è£…æˆä¸€ç§å¯ä»¥å­˜åœ¨å †ä¸­å¹¶åœ¨ç¨‹åºä¸­ä¼ é€’çš„å½¢å¼ã€‚</p><p>Blockçš„å…³é”®ä¼˜åŠ¿ä¹‹ä¸€æ˜¯å®ƒä»¬èƒ½å¤Ÿä½¿ç”¨å…¶è‡ªèº«è¯æ³•èŒƒå›´ä¹‹å¤–çš„å˜é‡ã€‚å½“ä½ åœ¨ä¸€ä¸ªå‡½æ•°æˆ–æ–¹æ³•ä¸­å®šä¹‰ä¸€ä¸ªblockæ—¶ï¼Œè¯¥blockåœ¨æŸäº›æ–¹é¢å°±åƒä¸€ä¸ªä¼ ç»Ÿçš„ä»£ç å—ä¸€æ ·ã€‚ä¾‹å¦‚ï¼Œblockå¯ä»¥è¯»å–å®šä¹‰åœ¨çˆ¶ä½œç”¨åŸŸä¸­çš„å˜é‡çš„å€¼ã€‚è¢«blockè®¿é—®çš„å˜é‡è¢«å¤åˆ¶åˆ°å †ä¸Šçš„blockæ•°æ®ç»“æ„ä¸­ï¼Œè¿™æ ·blockå°±å¯ä»¥åœ¨ä»¥åè®¿é—®å®ƒä»¬ã€‚å½“blockè¢«æ·»åŠ åˆ°è°ƒåº¦é˜Ÿåˆ—æ—¶ï¼Œè¿™äº›å€¼é€šå¸¸å¿…é¡»ä»¥åªè¯»çš„æ ¼å¼ç•™ä¸‹ã€‚ç„¶è€Œï¼ŒåŒæ­¥æ‰§è¡Œçš„blockä¹Ÿå¯ä»¥ä½¿ç”¨é¢„åŠ äº†<code>__block</code>å…³é”®å­—çš„å˜é‡ï¼Œå°†æ•°æ®è¿”å›åˆ°çˆ¶ç±»çš„è°ƒç”¨èŒƒå›´ã€‚</p><p>ä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼äºå‡½æ•°æŒ‡é’ˆçš„è¯­æ³•ï¼Œåœ¨ä½ çš„ä»£ç ä¸­å†…è”åœ°å£°æ˜blockã€‚Blockå’Œå‡½æ•°æŒ‡é’ˆçš„ä¸»è¦åŒºåˆ«æ˜¯ï¼Œblockåç§°å‰é¢æœ‰ä¸€ä¸ª<code>^</code>è€Œä¸æ˜¯<code>*</code>ã€‚åƒå‡½æ•°æŒ‡é’ˆä¸€æ ·ï¼Œä½ å¯ä»¥å‘blockä¼ é€’å‚æ•°ï¼Œå¹¶ä»å®ƒé‚£é‡Œæ¥æ”¶ä¸€ä¸ªè¿”å›å€¼ã€‚æ¸…å•3-1æ˜¾ç¤ºäº†å¦‚ä½•åœ¨ä»£ç ä¸­åŒæ­¥å£°æ˜å’Œæ‰§è¡Œblockã€‚å˜é‡<code>aBlock</code>è¢«å£°æ˜ä¸ºä¸€ä¸ªblockï¼Œå®ƒæ¥å—ä¸€ä¸ªæ•´æ•°å‚æ•°ï¼Œä¸è¿”å›ä»»ä½•å€¼ã€‚ç„¶åï¼Œä¸€ä¸ªç¬¦åˆè¯¥åŸå‹çš„å®é™…blockè¢«åˆ†é…ç»™<code>aBlock</code>ï¼Œå¹¶è¢«å£°æ˜ä¸ºå†…è”ã€‚æœ€åä¸€è¡Œç«‹å³æ‰§è¡Œè¯¥blockï¼Œå°†æŒ‡å®šçš„æ•´æ•°æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºï¼š</p><p><strong>æ¸…å•3-1</strong> blockç®€å•ç¤ºä¾‹</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> x = <span class="number">123</span>;</span><br><span class="line"><span class="keyword">int</span> y = <span class="number">456</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Block declaration and assignment</span></span><br><span class="line"><span class="keyword">void</span> (^aBlock)(<span class="keyword">int</span>) = ^(<span class="keyword">int</span> z) &#123;</span><br><span class="line">    printf(<span class="string">&quot;%d %d %d\n&quot;</span>, x, y, z);</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Execute the block</span></span><br><span class="line">aBlock(<span class="number">789</span>);   <span class="comment">// prints: 123 456 789</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä½ åœ¨è®¾è®¡blockæ—¶åº”è¯¥è€ƒè™‘çš„ä¸€äº›å…³é”®å‡†åˆ™ï¼š</p><ul><li>å¯¹äºä½ è®¡åˆ’ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œçš„blockï¼Œä»çˆ¶å‡½æ•°æˆ–æ–¹æ³•ä¸­æ•è·æ ‡é‡å˜é‡å¹¶åœ¨blockä¸­ä½¿ç”¨æ˜¯å®‰å…¨çš„ã€‚ç„¶è€Œï¼Œä½ ä¸åº”è¯¥è¯•å›¾æ•è·å¤§å‹ç»“æ„ä½“æˆ–å…¶ä»–åŸºäºæŒ‡é’ˆçš„å˜é‡ï¼Œè¿™äº›å˜é‡æ˜¯ç”±è°ƒç”¨ä¸Šä¸‹æ–‡åˆ†é…å’Œåˆ é™¤çš„ã€‚å½“ä½ çš„blockè¢«æ‰§è¡Œæ—¶ï¼Œè¯¥æŒ‡é’ˆæ‰€å¼•ç”¨çš„å†…å­˜å¯èƒ½å·²ç»è¢«å›æ”¶ã€‚å½“ç„¶ï¼Œè‡ªå·±åˆ†é…å†…å­˜ï¼ˆæˆ–å¯¹è±¡ï¼‰å¹¶æ˜ç¡®åœ°å°†è¯¥å†…å­˜çš„æ‰€æœ‰æƒç§»äº¤ç»™blockæ˜¯å®‰å…¨çš„ã€‚</li><li>è°ƒåº¦é˜Ÿåˆ—ä¼šå¤åˆ¶è¢«æ·»åŠ åˆ°å…¶ä¸­çš„blockï¼Œå¹¶åœ¨æ‰§è¡Œå®Œæ¯•åé‡Šæ”¾blockã€‚æ¢å¥è¯è¯´ï¼Œä½ ä¸éœ€è¦åœ¨å°†blockæ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹å‰æ˜¾å¼åœ°å¤åˆ¶å®ƒä»¬ã€‚</li><li>å°½ç®¡é˜Ÿåˆ—åœ¨æ‰§è¡Œå°ä»»åŠ¡æ—¶æ¯”åŸå§‹çº¿ç¨‹æ›´æœ‰æ•ˆï¼Œä½†åœ¨é˜Ÿåˆ—ä¸­åˆ›å»ºblockå¹¶æ‰§è¡Œå®ƒä»¬ä»ç„¶å­˜åœ¨å¼€é”€ã€‚å¦‚æœä¸€ä¸ªblockåšçš„å·¥ä½œå¤ªå°‘ï¼Œç›´æ¥æ‰§è¡Œå®ƒå¯èƒ½æ¯”æŠŠå®ƒè°ƒåº¦åˆ°é˜Ÿåˆ—ä¸­æ›´èŠ‚çœå¼€é”€ã€‚åˆ¤æ–­ä¸€ä¸ªblockæ˜¯å¦åšå¾—å¤ªå°‘çš„æ–¹æ³•æ˜¯ä½¿ç”¨æ€§èƒ½å·¥å…·æ”¶é›†æ¯ä¸ªè·¯å¾„çš„æŒ‡æ ‡å¹¶è¿›è¡Œæ¯”è¾ƒã€‚</li><li>ä¸è¦ç¼“å­˜ç›¸å¯¹äºåº•å±‚çº¿ç¨‹çš„æ•°æ®ï¼Œå¹¶æœŸæœ›è¯¥æ•°æ®èƒ½ä»ä¸åŒçš„blockä¸­è®¿é—®ã€‚å¦‚æœåŒä¸€é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡éœ€è¦å…±äº«æ•°æ®ï¼Œè¯·ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—çš„ä¸Šä¸‹æ–‡æŒ‡é’ˆæ¥ä»£æ›¿å­˜å‚¨æ•°æ®ã€‚å…³äºå¦‚ä½•è®¿é—®è°ƒåº¦é˜Ÿåˆ—çš„ä¸Šä¸‹æ–‡æ•°æ®çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW13">Storing Custom Context Information with a Queue</a>ã€‚</li><li>å¦‚æœblockåˆ›å»ºäº†å‡ ä¸ªä»¥ä¸Šçš„Objective-Cå¯¹è±¡ï¼Œä½ å¯ä»¥æŠŠblockçš„éƒ¨åˆ†ä»£ç åŒ…è£¹åœ¨@autoreleaseä¸­ï¼Œä»¥å¤„ç†è¿™äº›å¯¹è±¡çš„å†…å­˜ç®¡ç†ã€‚å°½ç®¡GCDè°ƒåº¦é˜Ÿåˆ—æœ‰ä»–ä»¬è‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä½†ä»–ä»¬ä¸ä¿è¯è¿™äº›æ± ä½•æ—¶è¢«è€—å°½ã€‚å¦‚æœç¨‹åºæœ‰å†…å­˜é™åˆ¶ï¼Œåˆ›å»ºè‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± å¯ä»¥è®©ä½ åœ¨æ›´æœ‰è§„å¾‹çš„æ—¶é—´é—´éš”å†…é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡çš„å†…å­˜ã€‚</li></ul><p>å…³äºblockçš„æ›´å¤šä¿¡æ¯ï¼ŒåŒ…æ‹¬å¦‚ä½•å£°æ˜å’Œä½¿ç”¨å®ƒä»¬ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Blocks/Articles/00_Introduction.html#//apple_ref/doc/uid/TP40007502">Blocks Programming Topics</a>ã€‚å…³äºå¦‚ä½•å°†blockæ·»åŠ åˆ°è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW20">Adding Tasks to a Queue</a>ã€‚</p><h2 id="åˆ›å»ºå’Œç®¡ç†è°ƒåº¦é˜Ÿåˆ—">åˆ›å»ºå’Œç®¡ç†è°ƒåº¦é˜Ÿåˆ—</h2><p>åœ¨ä½ æŠŠä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ä¹‹å‰ï¼Œä½ å¿…é¡»ç¡®å®šä½¿ç”¨çš„é˜Ÿåˆ—ç±»å‹ä»¥åŠåç»­æ‰“ç®—å¦‚ä½•ä½¿ç”¨å®ƒã€‚è°ƒåº¦é˜Ÿåˆ—å¯ä»¥ä¸²è¡Œæˆ–å¹¶å‘åœ°æ‰§è¡Œä»»åŠ¡ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ å¯¹é˜Ÿåˆ—æœ‰ä¸€ä¸ªç‰¹å®šçš„ç”¨é€”ï¼Œä½ å¯ä»¥ç›¸åº”åœ°é…ç½®é˜Ÿåˆ—å±æ€§ã€‚ä¸‹é¢å‡ èŠ‚å‘Šè¯‰ä½ å¦‚ä½•åˆ›å»ºè°ƒåº¦é˜Ÿåˆ—å¹¶é…ç½®å®ƒä»¬çš„ç”¨é€”ã€‚</p><h3 id="è·å¾—å…¨å±€å¹¶å‘è°ƒåº¦é˜Ÿåˆ—">è·å¾—å…¨å±€å¹¶å‘è°ƒåº¦é˜Ÿåˆ—</h3><p>å½“ä½ æœ‰å¤šä¸ªå¯ä»¥å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡æ—¶ï¼Œå¹¶å‘è°ƒåº¦é˜Ÿåˆ—å¾ˆæœ‰ç”¨ã€‚å¹¶å‘é˜Ÿåˆ—ä»ç„¶æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå› ä¸ºå®ƒä»¥å…ˆè¿›å…ˆå‡ºçš„é¡ºåºå¯¹ä»»åŠ¡è¿›è¡Œæ’é˜Ÿï¼›ä½†æ˜¯ï¼Œå¹¶å‘é˜Ÿåˆ—å¯èƒ½åœ¨ä»»ä½•å…ˆå‰çš„ä»»åŠ¡å®Œæˆä¹‹å‰å°±æ’é˜Ÿç­‰å€™å…¶ä»–ä»»åŠ¡ã€‚å¹¶å‘é˜Ÿåˆ—åœ¨ä»»ä½•ç»™å®šæ—¶åˆ»æ‰§è¡Œçš„å®é™…ä»»åŠ¡æ•°æ˜¯å¯å˜çš„ï¼Œå¯ä»¥éšç€ç¨‹åºçš„æ¡ä»¶å˜åŒ–è€ŒåŠ¨æ€å˜åŒ–ã€‚è®¸å¤šå› ç´ ä¼šå½±å“å¹¶å‘é˜Ÿåˆ—æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ï¼ŒåŒ…æ‹¬å¯ç”¨çš„å†…æ ¸æ•°é‡ã€å…¶ä»–è¿›ç¨‹æ­£åœ¨å®Œæˆçš„å·¥ä½œé‡ï¼Œä»¥åŠå…¶ä»–ä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡å’Œä¼˜å…ˆçº§ã€‚</p><p>ç³»ç»Ÿä¸ºæ¯ä¸ªç¨‹åºæä¾›äº†4ä¸ªå¹¶å‘çš„è°ƒåº¦é˜Ÿåˆ—ã€‚è¿™äº›é˜Ÿåˆ—å¯¹ç¨‹åºæ¥è¯´æ˜¯å…¨å±€æ€§çš„ï¼Œä»…ç”±å…¶ä¼˜å…ˆçº§æ¥åŒºåˆ†ã€‚å› ä¸ºå®ƒä»¬æ˜¯å…¨å±€çš„ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦æ˜ç¡®åœ°åˆ›å»ºå®ƒä»¬ã€‚ç›¸åï¼Œä½ å¯ä»¥ä½¿ç”¨<code>dispatch_get_global_queue</code>å‡½æ•°æ¥è¯·æ±‚è·å–å…¶ä¸­çš„é˜Ÿåˆ—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> aQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>é™¤äº†è·å¾—é»˜è®¤çš„å¹¶å‘é˜Ÿåˆ—ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡å‘å‡½æ•°ä¼ é€’<code>DISPATCH_QUEUE_PRIORITY_HIGH</code>å’Œ<code>DISPATCH_QUEUE_PRIORITY_LOW</code>å¸¸é‡æ¥è·å¾—é«˜ä¼˜å…ˆçº§å’Œä½ä¼˜å…ˆçº§çš„é˜Ÿåˆ—ï¼Œæˆ–è€…é€šè¿‡ä¼ é€’<code>DISPATCH_QUEUE_PRIORITY_BACKGROUND</code>å¸¸é‡æ¥è·å¾—ä¸€ä¸ªåå°é˜Ÿåˆ—ã€‚æ­£å¦‚ä½ æ‰€æœŸæœ›çš„ï¼Œé«˜ä¼˜å…ˆçº§å¹¶å‘é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åœ¨é»˜è®¤é˜Ÿåˆ—å’Œä½ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¹‹å‰æ‰§è¡Œã€‚åŒæ ·åœ°ï¼Œé»˜è®¤é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åœ¨ä½ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¹‹å‰æ‰§è¡Œã€‚</p><p><strong>æ³¨æ„ï¼š</strong> <code>dispatch_get_global_queue</code>å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸ºå°†æ¥çš„æ‰©å±•ä¿ç•™çš„ã€‚ç°åœ¨ï¼Œä½ åº”è¯¥æ€»æ˜¯ä¸ºè¿™ä¸ªå‚æ•°ä¼ é€’<code>0</code>ã€‚</p><p>å°½ç®¡è°ƒåº¦é˜Ÿåˆ—æ˜¯å¼•ç”¨è®¡æ•°çš„å¯¹è±¡ï¼Œä½ ä¸éœ€è¦ä¿ç•™å’Œé‡Šæ”¾å…¨å±€å¹¶å‘é˜Ÿåˆ—ã€‚å› ä¸ºå®ƒä»¬å¯¹ç¨‹åºæ˜¯å…¨å±€çš„ï¼Œå¯¹è¿™äº›é˜Ÿåˆ—çš„ä¿ç•™å’Œé‡Šæ”¾è°ƒç”¨åº”è¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œä½ ä¸éœ€è¦å­˜å‚¨å¯¹è¿™äº›é˜Ÿåˆ—çš„å¼•ç”¨ã€‚ä½ åªéœ€åœ¨éœ€è¦å…¶ä¸­ä¸€ä¸ªé˜Ÿåˆ—çš„å¼•ç”¨æ—¶è°ƒç”¨<code>dispatch_get_global_queue</code>å‡½æ•°ã€‚</p><h3 id="åˆ›å»ºä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—">åˆ›å»ºä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—</h3><p>å½“ä½ æƒ³è®©ä½ çš„ä»»åŠ¡ä»¥ç‰¹å®šçš„é¡ºåºæ‰§è¡Œæ—¶ï¼Œä¸²è¡Œé˜Ÿåˆ—å¾ˆæœ‰ç”¨ã€‚ä¸²è¡Œé˜Ÿåˆ—ä¸€æ¬¡åªæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸”æ€»æ˜¯ä»é˜Ÿåˆ—çš„å¤´éƒ¨å–å‡ºä»»åŠ¡ã€‚ä½ å¯ä»¥ç”¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ä»£æ›¿é”æ¥ä¿æŠ¤ä¸€ä¸ªå…±äº«èµ„æºæˆ–å¯å˜æ•°æ®ç»“æ„ã€‚ä¸é”ä¸åŒï¼Œä¸²è¡Œé˜Ÿåˆ—ç¡®ä¿ä»»åŠ¡ä»¥å¯é¢„æµ‹çš„é¡ºåºæ‰§è¡Œã€‚<strong>åªè¦ä½ ä»¥å¼‚æ­¥æ–¹å¼å‘ä¸²è¡Œé˜Ÿåˆ—æäº¤ä»»åŠ¡ï¼Œè¯¥é˜Ÿåˆ—å°±ä¸ä¼šå‡ºç°æ­»é”ã€‚</strong></p><p>ä¸å¹¶å‘é˜Ÿåˆ—ä¸åŒï¼Œä½ å¿…é¡»æ˜ç¡®åœ°åˆ›å»ºå’Œç®¡ç†ä½ æƒ³ä½¿ç”¨çš„ä»»ä½•ä¸²è¡Œé˜Ÿåˆ—ã€‚ä½ å¯ä»¥ä¸ºç¨‹åºåˆ›å»ºä»»ä½•æ•°é‡çš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œä½†åº”é¿å…ä»…ä»…ä½œä¸ºä¸€ç§åŒæ—¶æ‰§è¡Œå°½å¯èƒ½å¤šçš„ä»»åŠ¡çš„æ‰‹æ®µæ¥åˆ›å»ºå¤§é‡çš„ä¸²è¡Œé˜Ÿåˆ—ã€‚å¦‚æœä½ æƒ³åŒæ—¶æ‰§è¡Œå¤§é‡çš„ä»»åŠ¡ï¼Œè¯·å°†å®ƒä»¬æäº¤ç»™å…¨å±€å¹¶å‘é˜Ÿåˆ—ã€‚åœ¨åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—æ—¶ï¼Œå°½é‡ä¸ºæ¯ä¸ªé˜Ÿåˆ—ç¡®å®šä¸€ä¸ªç›®çš„ï¼Œå¦‚ä¿æŠ¤èµ„æºæˆ–åŒæ­¥ç¨‹åºçš„ä¸€äº›å…³é”®è¡Œä¸ºã€‚</p><p>æ¸…å•3-2æ˜¾ç¤ºäº†åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—æ‰€éœ€çš„æ­¥éª¤ã€‚<code>dispatch_queue_create</code>å‡½æ•°éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—åç§°å’Œä¸€ç»„é˜Ÿåˆ—å±æ€§ã€‚è°ƒè¯•å™¨å’Œæ€§èƒ½å·¥å…·ä¼šæ˜¾ç¤ºè®¾ç½®çš„é˜Ÿåˆ—åç§°ï¼Œä»¥å¸®åŠ©ä½ è·Ÿè¸ªä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚é˜Ÿåˆ—å±æ€§æ˜¯ä¸ºå°†æ¥ä½¿ç”¨è€Œä¿ç•™çš„ï¼Œåº”è¯¥æ˜¯<code>NULL</code>ã€‚</p><p><strong>æ¸…å•3-2</strong> åˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue;</span><br><span class="line">queue = dispatch_queue_create(<span class="string">&quot;com.example.MyQueue&quot;</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>é™¤äº†åˆ›å»ºçš„ä»»ä½•è‡ªå®šä¹‰é˜Ÿåˆ—å¤–ï¼Œç³»ç»Ÿè¿˜è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°ç¨‹åºçš„ä¸»çº¿ç¨‹ã€‚å…³äºè·å–ä¸»çº¿ç¨‹çš„é˜Ÿåˆ—çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW3">Getting Common Queues at Runtime</a>ã€‚</p><h3 id="åœ¨è¿è¡Œæ—¶è·å–é€šç”¨é˜Ÿåˆ—">åœ¨è¿è¡Œæ—¶è·å–é€šç”¨é˜Ÿåˆ—</h3><p>Grand Central Dispatchæä¾›äº†ä¸€äº›å‡½æ•°ï¼Œå¯ä»¥è®©ä½ ä»ç¨‹åºä¸­è®¿é—®å‡ ä¸ªå¸¸è§çš„è°ƒåº¦é˜Ÿåˆ—ï¼š</p><ul><li>ä½¿ç”¨<code>dispatch_get_current_queue</code>å‡½æ•°ç”¨äºè°ƒè¯•ç›®çš„æˆ–æµ‹è¯•å½“å‰é˜Ÿåˆ—çš„èº«ä»½ã€‚ä»ä¸€ä¸ªblockå¯¹è±¡å†…éƒ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä¼šè¿”å›è¯¥blockè¢«æäº¤åˆ°çš„é˜Ÿåˆ—ï¼ˆä»¥åŠå®ƒç°åœ¨å¯èƒ½æ­£åœ¨è¿è¡Œçš„é˜Ÿåˆ—ï¼‰ã€‚åœ¨blockå¤–è°ƒç”¨æ­¤å‡½æ•°ä¼šè¿”å›ç¨‹åºçš„é»˜è®¤å¹¶å‘é˜Ÿåˆ—ã€‚</li><li>ä½¿ç”¨<code>dispatch_get_main_queue</code>å‡½æ•°æ¥è·å–ä¸ç¨‹åºä¸»çº¿ç¨‹ç›¸å…³çš„ä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—ã€‚è¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¸ºCocoaç¨‹åºå’Œé‚£äº›è°ƒç”¨<code>dispatch_main</code>å‡½æ•°æˆ–åœ¨ä¸»çº¿ç¨‹ä¸Šé…ç½®run loopï¼ˆä½¿ç”¨<code>CFRunLoopRef</code>ç±»å‹æˆ–<code>NSRunLoop</code>å¯¹è±¡ï¼‰çš„ç¨‹åºè‡ªåŠ¨åˆ›å»ºçš„ã€‚</li><li>ä½¿ç”¨<code>dispatch_get_global_queue</code>å‡½æ•°æ¥è·å–ä»»ä½•å…±äº«çš„å¹¶å‘é˜Ÿåˆ—ã€‚æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW5">Getting the Global Concurrent Dispatch Queues</a>ã€‚</li></ul><h3 id="è°ƒåº¦é˜Ÿåˆ—çš„å†…å­˜ç®¡ç†">è°ƒåº¦é˜Ÿåˆ—çš„å†…å­˜ç®¡ç†</h3><p>è°ƒåº¦é˜Ÿåˆ—å’Œå…¶ä»–è°ƒåº¦å¯¹è±¡æ˜¯å¼•ç”¨è®¡æ•°çš„æ•°æ®ç±»å‹ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>dispatch_retain</code>å’Œ<code>dispatch_release</code>å‡½æ•°æ ¹æ®éœ€è¦å¢åŠ å’Œå‡å°‘è¯¥å¼•ç”¨è®¡æ•°ã€‚å½“ä¸€ä¸ªé˜Ÿåˆ—çš„å¼•ç”¨è®¡æ•°è¾¾åˆ°0æ—¶ï¼Œç³»ç»Ÿä¼šå¼‚æ­¥åœ°é‡Šæ”¾é˜Ÿåˆ—ã€‚</p><p>ä¿ç•™å’Œé‡Šæ”¾è°ƒåº¦å¯¹è±¡ï¼Œå¦‚é˜Ÿåˆ—ï¼Œä»¥ç¡®ä¿å®ƒä»¬åœ¨è¢«ä½¿ç”¨æ—¶ä»åœ¨å†…å­˜ä¸­ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚ä¸å†…å­˜ç®¡ç†çš„Cocoaå¯¹è±¡ä¸€æ ·ï¼Œä¸€èˆ¬çš„è§„åˆ™æ˜¯ï¼Œå¦‚æœä½ æ‰“ç®—ä½¿ç”¨ä¼ é€’ç»™ä½ çš„ä»£ç çš„é˜Ÿåˆ—ï¼Œä½ åº”è¯¥åœ¨ä½¿ç”¨å®ƒä¹‹å‰ä¿ç•™è¯¥é˜Ÿåˆ—ï¼Œå½“ä½ ä¸å†éœ€è¦å®ƒæ—¶é‡Šæ”¾å®ƒã€‚è¿™ç§åŸºæœ¬æ¨¡å¼å¯ä»¥ç¡®ä¿åªè¦ä½ åœ¨ä½¿ç”¨é˜Ÿåˆ—ï¼Œå®ƒå°±ä¼šä¸€ç›´ç•™åœ¨å†…å­˜ä¸­ã€‚</p><p><strong>æ³¨æ„ï¼š</strong>ä½ ä¸éœ€è¦ä¿ç•™æˆ–é‡Šæ”¾ä»»ä½•å…¨å±€è°ƒåº¦é˜Ÿåˆ—ï¼ŒåŒ…æ‹¬å¹¶å‘çš„è°ƒåº¦é˜Ÿåˆ—æˆ–ä¸»è°ƒåº¦é˜Ÿåˆ—ã€‚ä»»ä½•è¯•å›¾ä¿ç•™æˆ–é‡Šæ”¾é˜Ÿåˆ—çš„è¡Œä¸ºéƒ½ä¼šè¢«å¿½ç•¥ã€‚</p><p>å³ä½¿ä½ å®ç°äº†ä¸€ä¸ªåƒåœ¾æ”¶é›†çš„ç¨‹åºï¼Œä½ ä»ç„¶å¿…é¡»ä¿ç•™å’Œé‡Šæ”¾ä½ çš„è°ƒåº¦é˜Ÿåˆ—å’Œå…¶ä»–è°ƒåº¦å¯¹è±¡ã€‚Grand Central Dispatchä¸æ”¯æŒç”¨äºå›æ”¶å†…å­˜çš„åƒåœ¾æ”¶é›†æ¨¡å‹ã€‚</p><h3 id="ç”¨é˜Ÿåˆ—å­˜å‚¨è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ä¿¡æ¯">ç”¨é˜Ÿåˆ—å­˜å‚¨è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ä¿¡æ¯</h3><p>æ‰€æœ‰çš„è°ƒåº¦å¯¹è±¡ï¼ˆåŒ…æ‹¬è°ƒåº¦é˜Ÿåˆ—ï¼‰éƒ½å…è®¸å°†è‡ªå®šä¹‰ä¸Šä¸‹æ–‡æ•°æ®ä¸è¯¥å¯¹è±¡ç›¸å…³è”ã€‚ä¸ºäº†åœ¨ä¸€ä¸ªç»™å®šçš„å¯¹è±¡ä¸Šè®¾ç½®å’Œè·å–è¿™äº›æ•°æ®ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>dispatch_set_context</code>å’Œ<code>dispatch_get_context</code>å‡½æ•°ã€‚ç³»ç»Ÿä¸ä¼šä»¥ä»»ä½•æ–¹å¼ä½¿ç”¨ä½ çš„è‡ªå®šä¹‰æ•°æ®ï¼Œè€Œæ˜¯ç”±ä½ åœ¨é€‚å½“çš„æ—¶å€™åˆ†é…å’Œé‡Šæ”¾è¯¥æ•°æ®ã€‚</p><p>å¯¹äºé˜Ÿåˆ—ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡æ•°æ®æ¥å­˜å‚¨ä¸€ä¸ªæŒ‡å‘Objective-Cå¯¹è±¡æˆ–å…¶ä»–æ•°æ®ç»“æ„çš„æŒ‡é’ˆï¼Œä»¥å¸®åŠ©è¯†åˆ«é˜Ÿåˆ—æˆ–å…¶ä»–é¢„æœŸç”¨é€”ã€‚ä½ å¯ä»¥ä½¿ç”¨é˜Ÿåˆ—çš„ææ„å‡½æ•°ï¼Œåœ¨é˜Ÿåˆ—è¢«é‡Šæ”¾ä¹‹å‰ï¼Œå°†ä¸Šä¸‹æ–‡æ•°æ®ä»é˜Ÿåˆ—ä¸­é‡Šæ”¾ï¼ˆæˆ–å–æ¶ˆå…³è”ï¼‰ã€‚å¦‚ä½•ç¼–å†™ä¸€ä¸ªæ¸…é™¤é˜Ÿåˆ—ä¸Šä¸‹æ–‡æ•°æ®çš„ææ„å‡½æ•°çš„ä¾‹å­ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW8">æ¸…å•3-3</a>ã€‚</p><h3 id="ä¸ºé˜Ÿåˆ—æä¾›ä¸€ä¸ªæ¸…ç†å‡½æ•°">ä¸ºé˜Ÿåˆ—æä¾›ä¸€ä¸ªæ¸…ç†å‡½æ•°</h3><p>åœ¨åˆ›å»ºäº†ä¸€ä¸ªä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—åï¼Œå¯ä»¥é™„åŠ ä¸€ä¸ªææ„å‡½æ•°ï¼Œä»¥ä¾¿åœ¨é˜Ÿåˆ—è¢«é‡Šæ”¾æ—¶æ‰§è¡Œä»»ä½•è‡ªå®šä¹‰çš„æ¸…ç†å·¥ä½œã€‚è°ƒåº¦é˜Ÿåˆ—æ˜¯å¼•ç”¨è®¡æ•°çš„å¯¹è±¡ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>dispatch_set_finalizer_f</code> å‡½æ•°æ¥æŒ‡å®šä¸€ä¸ªå½“é˜Ÿåˆ—çš„å¼•ç”¨è®¡æ•°è¾¾åˆ°é›¶æ—¶è¦æ‰§è¡Œçš„å‡½æ•°ã€‚ä½ ç”¨è¿™ä¸ªå‡½æ•°æ¥æ¸…ç†ä¸é˜Ÿåˆ—ç›¸å…³çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œåªæœ‰å½“ä¸Šä¸‹æ–‡æŒ‡é’ˆä¸æ˜¯<code>NULL</code>æ—¶æ‰ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><p>æ¸…å•3-3æ˜¾ç¤ºäº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ææ„å‡½æ•°å’Œä¸€ä¸ªåˆ›å»ºé˜Ÿåˆ—å¹¶é…ç½®ææ„å‡½æ•°çš„å‡½æ•°ã€‚é˜Ÿåˆ—ä½¿ç”¨ææ„å‡½æ•°æ¥é‡Šæ”¾å­˜å‚¨åœ¨é˜Ÿåˆ—ä¸Šä¸‹æ–‡æŒ‡é’ˆä¸­çš„æ•°æ®ã€‚ä»£ç ä¸­å¼•ç”¨çš„<code>myInitializeDataContextFunction</code>å’Œ<code>myCleanUpDataContextFunction</code>å‡½æ•°æ˜¯ä½ æä¾›çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ–å’Œæ¸…ç†æ•°æ®ç»“æ„æœ¬èº«çš„å†…å®¹ã€‚ä¼ é€’ç»™ææ„å‡½æ•°çš„ä¸Šä¸‹æ–‡æŒ‡é’ˆåŒ…å«ä¸é˜Ÿåˆ—ç›¸å…³çš„æ•°æ®å¯¹è±¡ã€‚</p><p><strong>æ¸…å•3-3</strong> ç»™é˜Ÿåˆ—é…ç½®æ¸…ç†å‡½æ•°</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> myFinalizerFunction(<span class="keyword">void</span> *context)</span><br><span class="line">&#123;</span><br><span class="line">    MyDataContext* theData = (MyDataContext*)context;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Clean up the contents of the structure</span></span><br><span class="line">    myCleanUpDataContextFunction(theData);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Now release the structure itself.</span></span><br><span class="line">    free(theData);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="built_in">dispatch_queue_t</span> createMyQueue()</span><br><span class="line">&#123;</span><br><span class="line">    MyDataContext*  data = (MyDataContext*) malloc(<span class="keyword">sizeof</span>(MyDataContext));</span><br><span class="line">    myInitializeDataContextFunction(data);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Create the queue and set the context data.</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">&quot;com.example.CriticalTaskQueue&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    dispatch_set_context(serialQueue, data);</span><br><span class="line">    dispatch_set_finalizer_f(serialQueue, &amp;myFinalizerFunction);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> serialQueue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—">æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—</h2><p>è¦æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä½ å¿…é¡»æŠŠå®ƒè°ƒåº¦åˆ°ä¸€ä¸ªé€‚å½“çš„è°ƒåº¦é˜Ÿåˆ—ä¸­ã€‚ä½ å¯ä»¥åŒæ­¥æˆ–å¼‚æ­¥åœ°è°ƒåº¦ä»»åŠ¡ï¼Œä½ å¯ä»¥å•ç‹¬æˆ–åˆ†ç»„åœ°è°ƒåº¦ä»»åŠ¡ã€‚ä¸€æ—¦è¿›å…¥é˜Ÿåˆ—ï¼Œè€ƒè™‘åˆ°é˜Ÿåˆ—çš„é™åˆ¶å’Œé˜Ÿåˆ—ä¸­å·²æœ‰çš„ä»»åŠ¡ï¼Œé˜Ÿåˆ—å°†è´Ÿè´£å°½å¿«æ‰§è¡Œä½ çš„ä»»åŠ¡ã€‚æœ¬èŠ‚å‘ä½ å±•ç¤ºäº†ä¸€äº›å‘é˜Ÿåˆ—è°ƒåº¦ä»»åŠ¡çš„æŠ€æœ¯ï¼Œå¹¶ä»‹ç»äº†æ¯ä¸€ç§æŠ€æœ¯çš„ä¼˜ç‚¹ã€‚</p><h3 id="æ·»åŠ å•ä¸ªä»»åŠ¡åˆ°é˜Ÿåˆ—">æ·»åŠ å•ä¸ªä»»åŠ¡åˆ°é˜Ÿåˆ—</h3><p>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼šå¼‚æ­¥æˆ–åŒæ­¥ã€‚åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨<code>dispatch_async</code>å’Œ<code>dispatch_async_f</code>å‡½æ•°çš„å¼‚æ­¥æ‰§è¡Œæ¯”åŒæ­¥æ‰§è¡Œè¦å¥½ã€‚å½“ä½ åœ¨é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªblockå¯¹è±¡æˆ–å‡½æ•°æ—¶ï¼Œæ²¡æœ‰åŠæ³•çŸ¥é“è¯¥ä»£ç ä½•æ—¶æ‰§è¡Œã€‚å› æ­¤ï¼Œå¼‚æ­¥æ·»åŠ blockæˆ–å‡½æ•°å¯ä»¥è®©ä½ å®‰æ’ä»£ç çš„æ‰§è¡Œï¼Œå¹¶ç»§ç»­ä»è°ƒç”¨çº¿ç¨‹åšå…¶ä»–å·¥ä½œã€‚å¦‚æœä»ç¨‹åºçš„ä¸»çº¿ç¨‹è°ƒåº¦ä»»åŠ¡ï¼ˆä¹Ÿè®¸æ˜¯ä¸ºäº†å“åº”ä¸€äº›ç”¨æˆ·äº‹ä»¶ï¼‰è¿™ä¸€ç‚¹å°±ç‰¹åˆ«é‡è¦ã€‚</p><p>å°½ç®¡ä½ åº”è¯¥å°½å¯èƒ½åœ°å¼‚æ­¥æ·»åŠ ä»»åŠ¡ï¼Œä½†æœ‰æ—¶ä½ ä»ç„¶éœ€è¦åŒæ­¥æ·»åŠ ä»»åŠ¡ï¼Œä»¥é˜²æ­¢ç«æ€æ¡ä»¶æˆ–å…¶ä»–åŒæ­¥é”™è¯¯ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>dispatch_sync</code>å’Œ<code>dispatch_sync_f</code>å‡½æ•°æ¥å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚è¿™äº›å‡½æ•°ä¼šé˜»å¡å½“å‰çš„æ‰§è¡Œçº¿ç¨‹ï¼Œç›´åˆ°æŒ‡å®šçš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</p><p><strong>é‡è¦æé†’ï¼š</strong>ä½ ä¸åº”è¯¥ä»ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¸­è°ƒç”¨<code>dispatch_sync</code>æˆ–<code>dispatch_sync_f</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªä»»åŠ¡æ˜¯ä½ è®¡åˆ’ä¼ é€’ç»™è¯¥å‡½æ•°çš„åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚è¿™å¯¹ä¸²è¡Œé˜Ÿåˆ—ç‰¹åˆ«é‡è¦ï¼Œå› ä¸ºè¿™æ ·åšå¿…ç„¶å¯¼è‡´æ­»é”ã€‚åŒæ ·å¯¹å¹¶å‘é˜Ÿåˆ—ä¹Ÿåº”é¿å…è¿™æ ·åšã€‚</p><p>ä¸‹é¢çš„ä¾‹å­æ˜¾ç¤ºäº†å¦‚ä½•ä½¿ç”¨åŸºäºblockçš„å˜ä½“æ¥è¿›è¡Œå¼‚æ­¥å’ŒåŒæ­¥çš„ä»»åŠ¡è°ƒåº¦ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> myCustomQueue;</span><br><span class="line">myCustomQueue = dispatch_queue_create(<span class="string">&quot;com.example.MyCustomQueue&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">dispatch_async</span>(myCustomQueue, ^&#123;</span><br><span class="line">    printf(<span class="string">&quot;Do some work here.\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">printf(<span class="string">&quot;The first block may or may not have run.\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">dispatch_sync</span>(myCustomQueue, ^&#123;</span><br><span class="line">    printf(<span class="string">&quot;Do some more work here.\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">printf(<span class="string">&quot;Both blocks have completed.\n&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="åœ¨ä»»åŠ¡å®Œæˆæ—¶æ‰§è¡Œå®Œæˆblock">åœ¨ä»»åŠ¡å®Œæˆæ—¶æ‰§è¡Œå®ŒæˆBlock</h3><p>å°±å…¶æ€§è´¨è€Œè¨€, è°ƒåº¦åˆ°é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ˜¯ç‹¬ç«‹äºåˆ›å»ºå®ƒä»¬çš„ä»£ç è¿è¡Œçš„ã€‚ç„¶è€Œï¼Œå½“ä»»åŠ¡å®Œæˆåï¼Œç¨‹åºå¯èƒ½ä»ç„¶å¸Œæœ›è¢«é€šçŸ¥è¿™ä¸€äº‹å®ï¼Œä»¥ä¾¿å®ƒèƒ½å¤Ÿçº³å…¥ç»“æœã€‚åœ¨ä¼ ç»Ÿçš„å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨å›è°ƒæœºåˆ¶æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½†å¯¹äºè°ƒåº¦é˜Ÿåˆ—ï¼Œä½ å¯ä»¥ä½¿ç”¨å®Œæˆblockå®ç°ã€‚</p><p>å®Œæˆblockåªæ˜¯å¦ä¸€æ®µæ™®é€šä»£ç è€Œå·²ï¼Œåœ¨åŸå§‹ä»»åŠ¡ç»“æŸåå°†å…¶è°ƒåº¦åˆ°é˜Ÿåˆ—ä¸­ã€‚è°ƒç”¨ä»£ç é€šå¸¸åœ¨å¯åŠ¨ä»»åŠ¡æ—¶æä¾›å®Œæˆblockä½œä¸ºå‚æ•°ã€‚ä»»åŠ¡ä»£ç æ‰€è¦åšçš„å°±æ˜¯åœ¨å®Œæˆå·¥ä½œæ—¶å°†æŒ‡å®šçš„blockæˆ–å‡½æ•°æäº¤åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ã€‚</p><p>æ¸…å•3-4æ˜¾ç¤ºäº†ä¸€ä¸ªç”¨blockå®ç°çš„æ±‚å¹³å‡å€¼å‡½æ•°ã€‚æ±‚å¹³å‡å€¼å‡½æ•°çš„æœ€åä¸¤ä¸ªå‚æ•°å…è®¸è°ƒç”¨è€…åœ¨æŠ¥å‘Šç»“æœæ—¶æŒ‡å®šä¸€ä¸ªé˜Ÿåˆ—å’Œblockã€‚åœ¨æ±‚å¹³å‡å€¼å‡½æ•°è®¡ç®—å‡ºå®ƒçš„å€¼åï¼Œå®ƒå°†ç»“æœä¼ é€’ç»™æŒ‡å®šçš„blockï¼Œå¹¶å°†å…¶è°ƒåº¦ç»™é˜Ÿåˆ—ã€‚ä¸ºäº†é˜²æ­¢é˜Ÿåˆ—è¿‡æ—©åœ°è¢«é‡Šæ”¾ï¼Œåœ¨å¼€å§‹çš„æ—¶å€™ä¿ç•™è¯¥é˜Ÿåˆ—å¹¶åœ¨å®Œæˆblockè¢«è°ƒåº¦æ—¶è¿›è¡Œé‡Šæ”¾ã€‚</p><p><strong>æ¸…å•3-4</strong> åœ¨ä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰§è¡Œå›è°ƒ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> average_async(<span class="keyword">int</span> *data, size_t len,</span><br><span class="line">   <span class="built_in">dispatch_queue_t</span> queue, <span class="keyword">void</span> (^block)(<span class="keyword">int</span>))</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// Retain the queue provided by the user to make</span></span><br><span class="line">   <span class="comment">// sure it does not disappear before the completion</span></span><br><span class="line">   <span class="comment">// block can be called.</span></span><br><span class="line">   dispatch_retain(queue);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Do the work on the default concurrent queue and then</span></span><br><span class="line">   <span class="comment">// call the user-provided block with the results.</span></span><br><span class="line">   <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">      <span class="keyword">int</span> avg = average(data, len);</span><br><span class="line">      <span class="built_in">dispatch_async</span>(queue, ^&#123; block(avg);&#125;);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Release the user-provided queue when done</span></span><br><span class="line">      dispatch_release(queue);</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¹¶å‘æ‰§è¡Œå¾ªç¯è¿­ä»£">å¹¶å‘æ‰§è¡Œå¾ªç¯è¿­ä»£</h3><p>å¹¶å‘è°ƒåº¦é˜Ÿåˆ—å¯ä»¥æé«˜æ€§èƒ½çš„ä¸€ä¸ªåœ°æ–¹æ˜¯ï¼Œä¸€ä¸ªæ‰§è¡Œå›ºå®šæ¬¡æ•°è¿­ä»£çš„å¾ªç¯ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ªforå¾ªç¯ï¼Œåœ¨æ¯æ¬¡å¾ªç¯è¿­ä»£ä¸­éƒ½åšä¸€äº›å·¥ä½œï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">   printf(<span class="string">&quot;%u\n&quot;</span>,i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœåœ¨æ¯ä¸ªè¿­ä»£è¿‡ç¨‹ä¸­æ‰§è¡Œçš„å·¥ä½œä¸æ‰€æœ‰å…¶ä»–è¿­ä»£è¿‡ç¨‹ä¸­æ‰§è¡Œçš„å·¥ä½œä¸åŒï¼Œå¹¶ä¸”æ¯ä¸ªè¿ç»­çš„å¾ªç¯å®Œæˆçš„é¡ºåºä¸é‡è¦ï¼Œä½ å¯ä»¥ç”¨è°ƒç”¨<code>dispatch_apply</code>æˆ–<code>dispatch_apply_f</code>å‡½æ•°æ¥ä»£æ›¿å¾ªç¯ã€‚è¿™äº›å‡½æ•°åœ¨æ¯æ¬¡å¾ªç¯è¿­ä»£æ—¶å°†æŒ‡å®šçš„blockæˆ–å‡½æ•°æäº¤ç»™ä¸€ä¸ªé˜Ÿåˆ—ã€‚å½“è°ƒåº¦åˆ°ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—æ—¶ï¼Œå› æ­¤æœ‰å¯èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªå¾ªç¯è¿­ä»£ã€‚</p><p>åœ¨è°ƒç”¨<code>dispatch_apply</code>æˆ–<code>dispatch_apply_f</code>æ—¶ï¼Œä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—æˆ–å¹¶å‘é˜Ÿåˆ—ã€‚ä¼ é€’ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—å…è®¸ä½ åŒæ—¶æ‰§è¡Œå¤šä¸ªå¾ªç¯è¿­ä»£ï¼Œè¿™æ˜¯ä½¿ç”¨è¿™äº›å‡½æ•°çš„æœ€å¸¸è§æ–¹å¼ã€‚å°½ç®¡ä½¿ç”¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—æ˜¯å…è®¸çš„ï¼Œå¹¶ä¸”å¯¹ä½ çš„ä»£ç æ¥è¯´æ˜¯æ­£ç¡®çš„ï¼Œä½†ä½¿ç”¨è¿™æ ·çš„é˜Ÿåˆ—ä¸åŸæœ‰çš„å¾ªç¯ç›¸æ¯”æ²¡æœ‰çœŸæ­£çš„æ€§èƒ½ä¼˜åŠ¿ã€‚</p><p><strong>é‡è¦æé†’ï¼š</strong>å’Œæ™®é€šçš„forå¾ªç¯ä¸€æ ·ï¼Œ<code>dispatch_apply</code>å’Œ<code>dispatch_apply_f</code>å‡½æ•°åœ¨æ‰€æœ‰å¾ªç¯è¿­ä»£å®Œæˆä¹‹å‰ä¸ä¼šè¿”å›ã€‚å› æ­¤ï¼Œå½“å·²ç»ä»é˜Ÿåˆ—çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„ä»£ç ä¸­è°ƒç”¨å®ƒä»¬æ—¶ï¼Œåº”è¯¥å°å¿ƒã€‚å¦‚æœä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°çš„é˜Ÿåˆ—æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œå¹¶ä¸”æ˜¯æ‰§è¡Œå½“å‰ä»£ç çš„åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œè°ƒç”¨è¿™äº›å‡½æ•°å°†ä½¿é˜Ÿåˆ—é™·å…¥æ­»é”ã€‚</p><p>å› ä¸ºå®ƒä»¬å®é™…ä¸Šé˜»å¡äº†å½“å‰çº¿ç¨‹ï¼Œæ‰€ä»¥å½“ä½ ä»ä¸»çº¿ç¨‹ä¸­è°ƒç”¨è¿™äº›å‡½æ•°æ—¶ä¹Ÿè¦å°å¿ƒï¼Œå®ƒä»¬å¯èƒ½ä¼šé˜»æ­¢ä½ çš„äº‹ä»¶å¤„ç†å¾ªç¯åŠæ—¶åœ°å“åº”äº‹ä»¶ã€‚å¦‚æœå¾ªç¯ä»£ç éœ€è¦æ˜æ˜¾çš„å¤„ç†æ—¶é—´ï¼Œä½ å¯èƒ½æƒ³ä»ä¸åŒçš„çº¿ç¨‹è°ƒç”¨è¿™äº›å‡½æ•°ã€‚</p><p>æ¸…å•3-5æ˜¾ç¤ºäº†å¦‚ä½•ç”¨<code>dispatch_apply</code>è¯­æ³•æ›¿æ¢å‰é¢çš„forå¾ªç¯ã€‚ä¼ é€’ç»™<code>dispatch_apply</code>å‡½æ•°çš„blockå¿…é¡»åŒ…å«ä¸€ä¸ªè¯†åˆ«å½“å‰å¾ªç¯è¿­ä»£çš„å‚æ•°ã€‚å½“blockè¢«æ‰§è¡Œæ—¶ï¼Œè¿™ä¸ªå‚æ•°çš„å€¼å¯¹äºç¬¬ä¸€æ¬¡è¿­ä»£æ˜¯<code>0</code>ï¼Œå¯¹äºç¬¬äºŒæ¬¡è¿­ä»£æ˜¯<code>1</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚æœ€åä¸€æ¬¡è¿­ä»£çš„å‚æ•°å€¼æ˜¯<code>count - 1</code>ï¼Œå…¶ä¸­<code>count</code>æ˜¯è¿­ä»£çš„æ€»æ¬¡æ•°ã€‚</p><p><strong>æ¸…å•3-5</strong> å¹¶å‘æ‰§è¡Œforå¾ªç¯è¿­ä»£</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">dispatch_apply(count, queue, ^(size_t i) &#123;</span><br><span class="line">   printf(<span class="string">&quot;%u\n&quot;</span>,i);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ä½ åº”è¯¥ç¡®ä¿ä»»åŠ¡ä»£ç åœ¨æ¯æ¬¡è¿­ä»£ä¸­éƒ½èƒ½å®Œæˆåˆç†çš„å·¥ä½œé‡ã€‚å°±åƒä½ è°ƒåº¦åˆ°é˜Ÿåˆ—çš„ä»»ä½•blockæˆ–å‡½æ•°ä¸€æ ·ï¼Œè°ƒåº¦è¯¥ä»£ç çš„æ‰§è¡Œæ˜¯æœ‰å¼€é”€çš„ã€‚å¦‚æœä½ çš„å¾ªç¯çš„æ¯ä¸ªè¿­ä»£åªæ‰§è¡Œå°‘é‡çš„å·¥ä½œï¼Œè°ƒåº¦ä»£ç çš„å¼€é”€å¯èƒ½ä¼šè¶…è¿‡ä½ ä»è°ƒåº¦å®ƒåˆ°é˜Ÿåˆ—ä¸­å¯èƒ½è·å¾—çš„æ€§èƒ½ä¼˜åŠ¿ã€‚å¦‚æœä½ åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°è¿™ç§æƒ…å†µï¼Œä½ å¯ä»¥ä½¿ç”¨stridingæ¥å¢åŠ æ¯ä¸ªå¾ªç¯è¿­ä»£ä¸­æ‰§è¡Œçš„å·¥ä½œé‡ã€‚é€šè¿‡stridingï¼Œå°†åŸå§‹å¾ªç¯çš„å¤šæ¬¡è¿­ä»£åˆå¹¶æˆä¸€ä¸ªblockï¼Œå¹¶æŒ‰æ¯”ä¾‹å‡å°‘è¿­ä»£æ¬¡æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ€åˆæ‰§è¡Œäº†100æ¬¡è¿­ä»£ï¼Œä½†å†³å®šä½¿ç”¨4çš„è·¨åº¦ï¼Œä½ ç°åœ¨ä»æ¯ä¸ªblockä¸­æ‰§è¡Œ4æ¬¡å¾ªç¯è¿­ä»£ï¼Œè¿­ä»£æ¬¡æ•°æ˜¯25ã€‚å…³äºå¦‚ä½•å®ç°stridingçš„ä¾‹å­ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/ThreadMigration/ThreadMigration.html#//apple_ref/doc/uid/TP40008091-CH105-SW2">Improving on Loop Code</a>ã€‚</p><h3 id="åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡">åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡</h3><p>Grand Central Dispatchæä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„è°ƒåº¦é˜Ÿåˆ—ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥åœ¨ç¨‹åºçš„ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ã€‚è¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¸ºæ‰€æœ‰ç¨‹åºè‡ªåŠ¨æä¾›çš„ï¼Œä»»ä½•åœ¨å…¶ä¸»çº¿ç¨‹ä¸Šè®¾ç½®run loopï¼ˆç”±<code>CFRunLoopRef</code>ç±»å‹æˆ–<code>NSRunLoop</code>å¯¹è±¡ç®¡ç†ï¼‰çš„ç¨‹åºéƒ½ä¼šè‡ªåŠ¨drainedã€‚å¦‚æœä½ æ²¡æœ‰åˆ›å»ºä¸€ä¸ªCocoaåº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”ä¸æƒ³æ˜ç¡®è®¾ç½®ä¸€ä¸ªrun loopï¼Œä½ å¿…é¡»è°ƒç”¨<code>dispatch_main</code>å‡½æ•°æ¥æ˜ç¡®æ¶ˆè´¹ä¸»è°ƒåº¦é˜Ÿåˆ—ã€‚ä½ ä»ç„¶å¯ä»¥å‘é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡ï¼Œä½†å¦‚æœä½ ä¸è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œè¿™äº›ä»»åŠ¡å°±æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚</p><p>ä½ å¯ä»¥é€šè¿‡è°ƒç”¨<code>dispatch_get_main_queue</code>å‡½æ•°è·å¾—ç¨‹åºä¸»çº¿ç¨‹çš„è°ƒåº¦é˜Ÿåˆ—ã€‚æ·»åŠ åˆ°è¿™ä¸ªé˜Ÿåˆ—çš„ä»»åŠ¡æ˜¯åœ¨ä¸»çº¿ç¨‹æœ¬èº«ä¸Šä¸²è¡Œè¿›è¡Œçš„ã€‚å› æ­¤ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªé˜Ÿåˆ—ä½œä¸ºä¸€ä¸ªç”¨äºåŒæ­¥å…¶ä»–éƒ¨åˆ†è¿›è¡Œçš„å·¥ä½œçš„åŒæ­¥ç‚¹ã€‚</p><h3 id="åœ¨ä»»åŠ¡ä¸­ä½¿ç”¨objective-cå¯¹è±¡">åœ¨ä»»åŠ¡ä¸­ä½¿ç”¨Objective-Cå¯¹è±¡</h3><p>GCDæä¾›äº†å¯¹Cocoaå†…å­˜ç®¡ç†æŠ€æœ¯çš„å†…ç½®æ”¯æŒï¼Œå› æ­¤ä½ å¯ä»¥åœ¨æäº¤ç»™è°ƒåº¦é˜Ÿåˆ—çš„blockä¸­è‡ªç”±ä½¿ç”¨Objective-Cå¯¹è±¡ã€‚æ¯ä¸ªè°ƒåº¦é˜Ÿåˆ—éƒ½ç»´æŠ¤å®ƒè‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä»¥ç¡®ä¿è‡ªåŠ¨é‡Šæ”¾çš„å¯¹è±¡åœ¨æŸä¸€æ—¶åˆ»è¢«é‡Šæ”¾ï¼›é˜Ÿåˆ—ä¸ä¿è¯å®ƒä»¬ä½•æ—¶çœŸæ­£é‡Šæ”¾è¿™äº›å¯¹è±¡ã€‚</p><p>å¦‚æœç¨‹åºæœ‰å†…å­˜é™åˆ¶ï¼Œå¹¶ä¸”blockåˆ›å»ºäº†è¶…è¿‡å‡ ä¸ªè‡ªåŠ¨é‡Šæ”¾çš„å¯¹è±¡ï¼Œåˆ›å»ºè‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯ç¡®ä¿å¯¹è±¡è¢«åŠæ—¶é‡Šæ”¾çš„å”¯ä¸€æ–¹æ³•ã€‚å¦‚æœä½ çš„blockåˆ›å»ºäº†æ•°ä»¥ç™¾è®¡çš„å¯¹è±¡ï¼Œä½ å¯èƒ½éœ€è¦åˆ›å»ºå¤šä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œæˆ–è€…å®šæœŸæ¸…ç©ºæ± ã€‚</p><h2 id="æš‚åœå’Œæ¢å¤é˜Ÿåˆ—">æš‚åœå’Œæ¢å¤é˜Ÿåˆ—</h2><p>å¯ä»¥é€šè¿‡æš‚åœä¸€ä¸ªé˜Ÿåˆ—æ¥é˜»æ­¢æš‚æ—¶æ‰§è¡Œblockå¯¹è±¡ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>dispatch_suspend</code>å‡½æ•°æš‚åœä¸€ä¸ªè°ƒåº¦é˜Ÿåˆ—ï¼Œå¹¶ä½¿ç”¨<code>dispatch_resume</code>å‡½æ•°æ¢å¤å®ƒã€‚è°ƒç”¨<code>dispatch_suspend</code>ä¼šå¢åŠ é˜Ÿåˆ—çš„æš‚åœå¼•ç”¨è®¡æ•°ï¼Œè€Œè°ƒç”¨<code>dispatch_resume</code>ä¼šå‡å°‘å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨è®¡æ•°å¤§äº0æ—¶ï¼Œé˜Ÿåˆ—ä»ç„¶æš‚åœã€‚å› æ­¤ï¼Œä½ å¿…é¡»ç”¨ä¸€ä¸ªåŒ¹é…çš„æ¢å¤è°ƒç”¨æ¥å¹³è¡¡æ‰€æœ‰çš„æš‚åœè°ƒç”¨ï¼Œä»¥ä¾¿æ¢å¤å¤„ç†blockã€‚</p><p><strong>é‡è¦æé†’ï¼š</strong>æš‚åœå’Œæ¢å¤è°ƒç”¨æ˜¯å¼‚æ­¥çš„ï¼Œåªåœ¨blockçš„æ‰§è¡Œä¹‹é—´ç”Ÿæ•ˆã€‚æš‚åœé˜Ÿåˆ—ä¸ä¼šåœæ­¢å·²ç»æ‰§è¡Œçš„blockã€‚</p><h2 id="ä½¿ç”¨è°ƒåº¦ä¿¡å·é‡æ¥è§„èŒƒæœ‰é™èµ„æºçš„ä½¿ç”¨">ä½¿ç”¨è°ƒåº¦ä¿¡å·é‡æ¥è§„èŒƒæœ‰é™èµ„æºçš„ä½¿ç”¨</h2><p>å¦‚æœä½ æäº¤ç»™è°ƒåº¦é˜Ÿåˆ—çš„ä»»åŠ¡è¦è®¿é—®ä¸€äº›æœ‰é™çš„èµ„æºï¼Œä½ å¯ä»¥ä½¿ç”¨è°ƒåº¦ä¿¡å·é‡æ¥è°ƒèŠ‚åŒæ—¶è®¿é—®è¯¥èµ„æºçš„ä»»åŠ¡æ•°é‡ã€‚è°ƒåº¦ä¿¡å·é‡çš„å·¥ä½œæ–¹å¼ä¸æ™®é€šä¿¡å·é‡ä¸€æ ·ï¼Œä½†æœ‰ä¸€ä¸ªä¾‹å¤–ã€‚å½“èµ„æºå¯ç”¨æ—¶ï¼Œè·å–ä¸€ä¸ªè°ƒåº¦ä¿¡å·é‡çš„æ—¶é—´æ¯”è·å–ä¸€ä¸ªä¼ ç»Ÿç³»ç»Ÿä¿¡å·é‡çš„æ—¶é—´è¦çŸ­ã€‚è¿™æ˜¯å› ä¸ºGrand Central Dispatchåœ¨è¿™ç§ç‰¹æ®Šæƒ…å†µä¸ä¼šå‘ä¸‹è°ƒç”¨å†…æ ¸ã€‚å”¯ä¸€ä¸€æ¬¡è°ƒç”¨å†…æ ¸æ˜¯å½“èµ„æºä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿéœ€è¦æš‚åœï¼ˆparkï¼‰çº¿ç¨‹ç›´åˆ°å‘å‡ºä¿¡å·ã€‚</p><p>ä½¿ç”¨è°ƒåº¦ä¿¡å·é‡çš„è¯­ä¹‰å¦‚ä¸‹ï¼š</p><ol type="1"><li>åˆ›å»ºä¿¡å·é‡æ—¶ï¼ˆä½¿ç”¨<code>dispatch_semaphore_create</code>å‡½æ•°ï¼‰ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªæ­£æ•´æ•°ï¼Œè¡¨ç¤ºå¯ç”¨èµ„æºçš„æ•°é‡ã€‚</li><li>åœ¨æ¯ä¸ªä»»åŠ¡ä¸­ï¼Œè°ƒç”¨<code>dispatch_semaphore_wait</code>ç­‰å¾…ä¿¡å·é‡ã€‚</li><li>å½“ç­‰å¾…è°ƒç”¨è¿”å›æ—¶ï¼Œè·å–èµ„æºå¹¶å®Œæˆå·¥ä½œã€‚</li><li>ä½¿ç”¨å®Œèµ„æºåï¼Œé‡Šæ”¾å®ƒå¹¶é€šè¿‡è°ƒç”¨<code>dispatch_semaphore_signal</code>å‡½æ•°å‘å‡ºä¿¡å·é‡ã€‚</li></ol><p>å…³äºè¿™äº›æ­¥éª¤å¦‚ä½•å·¥ä½œçš„ä¾‹å­ï¼Œå¯ä»¥è€ƒè™‘ç³»ç»Ÿä¸­æ–‡ä»¶æè¿°ç¬¦çš„ä½¿ç”¨ã€‚æ¯ä¸ªç¨‹åºéƒ½æœ‰æœ‰é™çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœæœ‰ä¸€ä¸ªå¤„ç†å¤§é‡æ–‡ä»¶çš„ä»»åŠ¡ï¼Œä½ ä¸å¸Œæœ›ä¸€æ¬¡æ‰“å¼€è¿™ä¹ˆå¤šæ–‡ä»¶ï¼Œä»¥è‡³äºä½ çš„æ–‡ä»¶æè¿°ç¬¦ç”¨å®Œã€‚ç›¸åï¼Œä½ å¯ä»¥ä½¿ç”¨ä¿¡å·é‡æ¥é™åˆ¶æ–‡ä»¶å¤„ç†ä»£ç ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚ä½ å¯ä»¥åœ¨ä»»åŠ¡ä¸­åŠ å…¥ä»¥ä¸‹çš„åŸºæœ¬ä»£ç ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create the semaphore, specifying the initial pool size</span></span><br><span class="line">dispatch_semaphore_t fd_sema = dispatch_semaphore_create(getdtablesize() / <span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Wait for a free file descriptor</span></span><br><span class="line">dispatch_semaphore_wait(fd_sema, DISPATCH_TIME_FOREVER);</span><br><span class="line">fd = open(<span class="string">&quot;/etc/services&quot;</span>, O_RDONLY);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Release the file descriptor when done</span></span><br><span class="line">close(fd);</span><br><span class="line">dispatch_semaphore_signal(fd_sema);</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¿¡å·é‡æ—¶ï¼ŒæŒ‡å®šå¯ç”¨èµ„æºçš„æ•°é‡ã€‚è¯¥å€¼æˆä¸ºä¿¡å·é‡çš„åˆå§‹è®¡æ•°å˜é‡ã€‚æ¯æ¬¡ç­‰å¾…ä¿¡å·é‡æ—¶ï¼Œ<code>dispatch_semaphore_wait</code>å‡½æ•°éƒ½ä¼šå°†è®¡æ•°å˜é‡é€’å‡ 1ã€‚å¦‚æœç»“æœå€¼ä¸ºè´Ÿï¼Œè¯¥å‡½æ•°ä¼šå‘Šè¯‰å†…æ ¸é˜»å¡çº¿ç¨‹ã€‚å¦ä¸€æ–¹é¢ï¼Œ<code>dispatch_semaphore_signal</code>å‡½æ•°å°† count å˜é‡åŠ  1 ä»¥æŒ‡ç¤ºèµ„æºå·²è¢«é‡Šæ”¾ã€‚å¦‚æœæœ‰ä»»åŠ¡è¢«é˜»å¡å¹¶ç­‰å¾…èµ„æºï¼Œå…¶ä¸­ä¸€ä¸ªä»»åŠ¡éšåä¼šè¢«è§£é™¤é˜»å¡å¹¶è¢«å…è®¸è¿›è¡Œå·¥ä½œã€‚</p><h2 id="ç­‰å¾…æ’é˜Ÿçš„ä»»åŠ¡ç»„">ç­‰å¾…æ’é˜Ÿçš„ä»»åŠ¡ç»„</h2><p>è°ƒåº¦ç»„æ˜¯ä¸€ç§é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•çš„æ–¹å¼ã€‚ä½ å¯ä»¥åœ¨éœ€è¦ç­‰å¾…æ‰€æœ‰æŒ‡å®šçš„ä»»åŠ¡éƒ½å®Œæˆæ‰èƒ½è¿›è¡ŒæŸäº›ä»»åŠ¡çš„åœ°æ–¹ä½¿ç”¨è¿™ç§è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œåœ¨è°ƒåº¦äº†å‡ ä¸ªä»»åŠ¡æ¥è®¡ç®—ä¸€äº›æ•°æ®åï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç»„æ¥ç­‰å¾…è¿™äº›ä»»åŠ¡ï¼Œç„¶ååœ¨å®ƒä»¬å®Œæˆåå¤„ç†ç»“æœã€‚ä½¿ç”¨è°ƒåº¦ç»„çš„å¦ä¸€ç§æ–¹å¼æ˜¯ä½œä¸ºçº¿ç¨‹è¿æ¥çš„æ›¿ä»£ã€‚ä½ å¯ä»¥å°†ç›¸åº”çš„ä»»åŠ¡æ·»åŠ åˆ°ä¸€ä¸ªè°ƒåº¦ç»„ä¸­ï¼Œå¹¶ç­‰å¾…æ•´ä¸ªç»„ï¼Œè€Œä¸æ˜¯å¯åŠ¨å‡ ä¸ªå­çº¿ç¨‹ï¼Œç„¶åä¸æ¯ä¸ªå­çº¿ç¨‹è”åˆèµ·æ¥ã€‚</p><p>æ¸…å•3-6æ˜¾ç¤ºäº†å»ºç«‹ä¸€ä¸ªç»„ï¼Œå‘å…¶è°ƒåº¦ä»»åŠ¡å¹¶ç­‰å¾…ç»“æœçš„åŸºæœ¬è¿‡ç¨‹ã€‚æ²¡æœ‰ä½¿ç”¨<code>dispatch_async</code>å‡½æ•°å°†ä»»åŠ¡è°ƒåº¦åˆ°é˜Ÿåˆ—ï¼Œè€Œæ˜¯ä½¿ç”¨<code>dispatch_group_async</code>å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å°†ä»»åŠ¡ä¸ç»„ç›¸å…³è”ï¼Œå¹¶æ’é˜Ÿç­‰å¾…æ‰§è¡Œã€‚è¦ç­‰å¾…ä¸€ç»„ä»»åŠ¡çš„å®Œæˆï¼Œä½ å°±ä½¿ç”¨<code>dispatch_group_wait</code>å‡½æ•°ï¼Œä¼ å…¥é€‚å½“çš„ç»„ã€‚</p><p><strong>æ¸…å•3-6</strong> ç­‰å¾…å¼‚æ­¥ä»»åŠ¡</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">dispatch_group_t group = dispatch_group_create();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Add a task to the group</span></span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">   <span class="comment">// Some asynchronous work</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Do some other work while the tasks execute.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// When you cannot make any more forward progress,</span></span><br><span class="line"><span class="comment">// wait on the group to block the current thread.</span></span><br><span class="line">dispatch_group_wait(group, DISPATCH_TIME_FOREVER);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Release the group when it is no longer needed.</span></span><br><span class="line">dispatch_release(group);</span><br></pre></td></tr></table></figure><h2 id="è°ƒåº¦é˜Ÿåˆ—å’Œçº¿ç¨‹å®‰å…¨">è°ƒåº¦é˜Ÿåˆ—å’Œçº¿ç¨‹å®‰å…¨</h2><p>åœ¨è°ƒåº¦é˜Ÿåˆ—çš„èƒŒæ™¯ä¸‹è°ˆè®ºçº¿ç¨‹å®‰å…¨å¯èƒ½çœ‹èµ·æ¥å¾ˆå¥‡æ€ªï¼Œä½†çº¿ç¨‹å®‰å…¨ä»ç„¶æ˜¯ä¸€ä¸ªç›¸å…³çš„è¯é¢˜ã€‚ä»»ä½•æ—¶å€™ï¼Œå½“ä½ åœ¨ç¨‹åºä¸­å®ç°å¹¶å‘æ—¶ï¼Œæœ‰å‡ ä»¶äº‹ä½ åº”è¯¥çŸ¥é“ï¼š</p><ul><li>è°ƒåº¦é˜Ÿåˆ—æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ¢å¥è¯è¯´ï¼Œä½ å¯ä»¥ä»ç³»ç»Ÿä¸­çš„ä»»ä½•çº¿ç¨‹å‘è°ƒåº¦é˜Ÿåˆ—æäº¤ä»»åŠ¡ï¼Œè€Œä¸å¿…é¦–å…ˆå–å¾—é”æˆ–åŒæ­¥è®¿é—®é˜Ÿåˆ—ã€‚</li><li>ä¸è¦ä»ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¸­è°ƒç”¨<code>dispatch_sync</code>å‡½æ•°ï¼Œå¹¶ä¼ é€’å½“å‰å‡½æ•°è°ƒç”¨çš„é˜Ÿåˆ—ã€‚è¿™æ ·åšä¼šä½¿é˜Ÿåˆ—é™·å…¥æ­»é”ã€‚å¦‚æœä½ éœ€è¦å¯¹å½“å‰é˜Ÿåˆ—è¿›è¡Œè°ƒåº¦ï¼Œè¯·ä½¿ç”¨<code>dispatch_async</code>å‡½æ•°è¿›è¡Œå¼‚æ­¥è°ƒåº¦ã€‚</li><li>é¿å…ä»ä½ æäº¤ç»™è°ƒåº¦é˜Ÿåˆ—çš„ä»»åŠ¡ä¸­è·å–é”ã€‚å°½ç®¡ä»ä»»åŠ¡ä¸­ä½¿ç”¨é”æ˜¯å®‰å…¨çš„ï¼Œä½†å½“ä½ è·å¾—é”æ—¶ï¼Œå¦‚æœè¯¥é”ä¸å¯ç”¨ï¼Œä½ æœ‰å¯èƒ½å®Œå…¨é˜»å¡ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚åŒæ ·ï¼Œå¯¹äºå¹¶å‘é˜Ÿåˆ—æ¥è¯´ï¼Œç­‰å¾…ä¸€ä¸ªé”å¯èƒ½åè€Œä¼šé˜»æ­¢å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œã€‚å¦‚æœä½ éœ€è¦åŒæ­¥ä½ çš„éƒ¨åˆ†ä»£ç ï¼Œåˆ™ä½¿ç”¨ä¸€ä¸ªä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—è€Œä¸æ˜¯é”ã€‚</li><li>å°½ç®¡ä½ å¯ä»¥è·å¾—å…³äºè¿è¡Œä»»åŠ¡çš„åº•å±‚çº¿ç¨‹çš„ä¿¡æ¯ï¼Œä½†æœ€å¥½è¿˜æ˜¯ä¸è¦è¿™æ ·åšã€‚å…³äºè°ƒåº¦é˜Ÿåˆ—ä¸çº¿ç¨‹çš„å…¼å®¹æ€§çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/ThreadMigration/ThreadMigration.html#//apple_ref/doc/uid/TP40008091-CH105-SW18">Compatibility with POSIX Threads</a>ã€‚</li></ul><p>å…³äºå¦‚ä½•å°†ç°æœ‰çš„çº¿ç¨‹ä»£ç æ”¹ä¸ºä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—çš„å…¶ä»–æŠ€å·§ï¼Œå¯å‚é˜…<a href=".%2F05%20Migrating%20Away%20from%20Threads.md">è¿ç§»çº¿ç¨‹ä»£ç </a>ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>é˜Ÿåˆ—ï¼š</p><ul><li>åœ¨ä½¿ç”¨ä¸Šï¼Œä¸æ“ä½œé˜Ÿåˆ—è¾ƒå¤§çš„ä¸åŒçš„æ˜¯ï¼Œè°ƒåº¦é˜Ÿåˆ—æ˜¯åŸºäºblockæ·»åŠ ä»»åŠ¡çš„ï¼Œè€Œæ“ä½œé˜Ÿåˆ—æ˜¯åŸºäºæ“ä½œå¯¹è±¡æ·»åŠ ä»»åŠ¡çš„ï¼Œæ‰€ä»¥è°ƒåº¦é˜Ÿåˆ—ä¼šå°‘äº†ä¸€äº›å¯¹æ¯ä¸ªä»»åŠ¡çš„æ§åˆ¶ï¼Œä¾‹å¦‚ä»»åŠ¡æ·»åŠ åˆ°è°ƒåº¦é˜Ÿåˆ—æ—¶ï¼Œå¿…é¡»æ˜¯å°±ç»ªæ‰§è¡Œçš„ã€‚</li><li>å¯¹äºæ“ä½œå¯¹è±¡ä¹‹é—´çš„ä¾èµ–ï¼Œåœ¨è°ƒåº¦é˜Ÿåˆ—ä¸­çš„æ›¿ä»£æ–¹æ¡ˆæ˜¯ä¸²è¡Œé˜Ÿåˆ—å’Œè°ƒåº¦ç»„ã€‚</li><li>å¯¹äºæ“ä½œé˜Ÿåˆ—çš„å®Œæˆblockï¼Œåœ¨è°ƒåº¦é˜Ÿåˆ—ä¸­å¯ä»¥ç®€å•åœ¨æ·»åŠ çš„å·¥ä½œå•å…ƒblockä¸­æ’å…¥æ‰§è¡Œå®Œæˆå›è°ƒblockçš„ä»£ç ã€‚</li><li>å¦‚æœblockåˆ›å»ºäº†å‡ ä¸ªä»¥ä¸Šçš„Objective-Cå¯¹è±¡ï¼Œä½ å¯ä»¥æŠŠblockçš„éƒ¨åˆ†ä»£ç åŒ…è£¹åœ¨@autoreleaseä¸­ï¼Œä»¥å¤„ç†è¿™äº›å¯¹è±¡çš„å†…å­˜ç®¡ç†ã€‚å°½ç®¡GCDè°ƒåº¦é˜Ÿåˆ—æœ‰ä»–ä»¬è‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä½†ä»–ä»¬ä¸ä¿è¯è¿™äº›æ± ä½•æ—¶è¢«è€—å°½ã€‚å¦‚æœç¨‹åºæœ‰å†…å­˜é™åˆ¶ï¼Œåˆ›å»ºè‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± å¯ä»¥è®©ä½ åœ¨æ›´æœ‰è§„å¾‹çš„æ—¶é—´é—´éš”å†…é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡çš„å†…å­˜ã€‚</li><li>å…¨å±€é˜Ÿåˆ—é™¤äº†ä¸»é˜Ÿåˆ—ï¼Œå…¶ä»–4ä¸ªéƒ½æ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œå¹¶æŒ‰ç…§ä¼˜å…ˆçº§åŒºåˆ†ã€‚</li><li>åªè¦ä»¥å¼‚æ­¥æ–¹å¼å‘é˜Ÿåˆ—æäº¤ä»»åŠ¡ï¼Œè¯¥é˜Ÿåˆ—å°±ä¸ä¼šå‡ºç°æ­»é”ã€‚åŒæ­¥è¿›å…¥æ­£åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œå¿…ç„¶é€ æˆæ­»é”ã€‚</li><li>å¦‚æœä½ æƒ³åŒæ—¶æ‰§è¡Œå¤§é‡çš„ä»»åŠ¡ï¼Œè¯·å°†å®ƒä»¬æäº¤ç»™å…¨å±€å¹¶å‘é˜Ÿåˆ—ã€‚</li><li>å½“ç»™è°ƒåº¦é˜Ÿåˆ—è®¾ç½®äº†è‡ªå·±çš„ä¸Šä¸‹æ–‡æ•°æ®æ˜¯ï¼ˆ<code>dispatch_set_context</code>ï¼‰ï¼Œè¦ç›¸åº”åœ°è®¾ç½®æ¸…ç†å‡½æ•°ï¼ˆ<code>dispatch_set_finalizer_f</code>ï¼‰ä»¥é‡Šæ”¾è‡ªå·±çš„ä¸Šä¸‹æ–‡æ•°æ®ã€‚</li><li>åœ¨ä½¿ç”¨è°ƒåº¦å‡½æ•°<code>dispatch_apply</code>æˆ–<code>dispatch_apply_f</code>ä¼˜åŒ–å¾ªç¯æ—¶ï¼Œä¼ å…¥å¹¶å‘é˜Ÿåˆ—æ‰æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä¸ç„¶æ ¹ç›´æ¥æ‰§è¡Œæ²¡æœ‰åŒºåˆ«ã€‚</li><li>é¿å…ä»æäº¤ç»™è°ƒåº¦é˜Ÿåˆ—çš„ä»»åŠ¡é‡è·å–é”ã€‚è¿™ä¸ä»…ä¼šé˜»å¡ä¸²è¡Œé˜Ÿåˆ—ï¼Œä¹Ÿä¼šè®©å¹¶å‘é˜Ÿåˆ—é˜»æ­¢å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œã€‚å³ä¼šè®©é˜Ÿåˆ—ä¸å¯é¢„æµ‹ï¼Œè¦åŒæ­¥ä»£ç ï¼Œåº”ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—è€Œä¸æ˜¯é”ã€‚</li></ul><p>ä½¿ç”¨æŠ€å·§ï¼š</p><ul><li>åŸºäºé˜Ÿåˆ—çš„åŒæ­¥æ¯”é”æ›´æœ‰æ•ˆï¼Œå› ä¸ºé”åœ¨æœ‰äº‰è®®å’Œæ— äº‰è®®çš„æƒ…å†µä¸‹æ€»æ˜¯éœ€è¦ä¸€ä¸ªæ˜‚è´µçš„å†…æ ¸é™·é˜±ï¼ˆkernel trapï¼‰ï¼Œè€Œè°ƒåº¦é˜Ÿåˆ—ä¸»è¦åœ¨ç¨‹åºçš„è¿›ç¨‹ç©ºé—´å·¥ä½œï¼Œåªæœ‰åœ¨ç»å¯¹å¿…è¦æ—¶æ‰ä¼šå‘ä¸‹è°ƒç”¨å†…æ ¸ã€‚</li><li>å¯¹äºå¹¶å‘é˜Ÿåˆ—ï¼Œè‹¥ä¸æ˜¯éœ€è¦æ“ä½œé˜Ÿåˆ—ï¼Œå¦‚æŒ‚èµ·ï¼Œå¦åˆ™ä½¿ç”¨å…¨å±€å¹¶å‘é˜Ÿåˆ—å³å¯ã€‚</li><li>åœ¨åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—æ—¶ï¼Œå°½é‡ä¸ºæ¯ä¸ªé˜Ÿåˆ—ç¡®å®šä¸€ä¸ªç›®çš„ï¼Œå¦‚ä¿æŠ¤èµ„æºæˆ–åŒæ­¥ç¨‹åºçš„ä¸€äº›å…³é”®è¡Œä¸ºã€‚</li><li>é™¤éé‡åˆ°ç«æ€æ¡ä»¶æˆ–å…¶ä»–åŒæ­¥é”™è¯¯ï¼Œå¦åˆ™éƒ½å°½å¯èƒ½åœ°å¼‚æ­¥æ·»åŠ ä»»åŠ¡ã€‚å¼‚æ­¥æ·»åŠ ä»»åŠ¡åˆ°ä¸²è¡Œé˜Ÿåˆ—å®ç°äº†å¼‚æ­¥é”ã€‚</li></ul><h3 id="objective-c-api---swift-api">Objective-C API -&gt; Swift API</h3><p><code>dispatch_barrier_async</code> -&gt; <code>async</code>è®¾ç½®flagså€¼ä¸º<code>.barrier</code></p><p><code>dispatch_after</code> -&gt; <code>asyncAfter</code></p><p><code>dispatch_once</code> -&gt; æ— </p><p><code>dispatch_apply</code> -&gt; <code>concurrentPerform</code></p><h3 id="ä¸€æ¬¡æ‰§è¡Œ">ä¸€æ¬¡æ‰§è¡Œ</h3><p>Swiftä¸­æ²¡æœ‰æä¾›ï¼Œå¯è‡ªå·±å®ç°ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">DispatchQueue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">var</span> _onceTracker <span class="operator">=</span> [<span class="type">String</span>]()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">once</span>(<span class="title">file</span>: <span class="title">String</span> = #<span class="title">file</span>, <span class="title">function</span>: <span class="title">String</span> = #<span class="title">function</span>, <span class="title">line</span>: <span class="title">Int</span> = #<span class="title">line</span>, <span class="title">block</span>: () -&gt; <span class="title">Void</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> token <span class="operator">=</span> <span class="string">&quot;<span class="subst">\(file)</span>:<span class="subst">\(function)</span>:<span class="subst">\(line)</span>&quot;</span></span><br><span class="line">        once(token: token, block: block)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">once</span>(<span class="title">token</span>: <span class="title">String</span>, <span class="title">block</span>: () -&gt; <span class="title">Void</span>) </span>&#123;</span><br><span class="line">        objc_sync_enter(<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">defer</span> &#123;</span><br><span class="line">            objc_sync_exit(<span class="keyword">self</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="operator">!</span>_onceTracker.contains(token) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        _onceTracker.append(token)</span><br><span class="line">        block()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>objc_sync_enter</code>å’Œ<code>objc_sync_exit</code>å…±åŒå®ç°<code>@sychronized</code>é€’å½’é”ã€‚</p><h3 id="å±éšœbarrier">å±éšœï¼ˆbarrierï¼‰</h3><p>æ³¨æ„ï¼šåœ¨å…¨å±€å¹¶å‘é˜Ÿåˆ—ä¸­æ’å…¥å±éšœæ— æ•ˆï¼Œè·Ÿæ™®é€šçš„<code>async</code>æ•ˆæœä¸€è‡´ï¼Œèµ·ä¸åˆ°é˜»å¡çš„ä½œç”¨ã€‚</p><p>æ’å…¥å±éšœä»»åŠ¡å¯¹å¹¶å‘é˜Ÿåˆ—çš„ä½œç”¨ï¼š</p><ol type="1"><li>ç­‰å¾…åœ¨å±éšœä»»åŠ¡ä¹‹å‰çš„ä»»åŠ¡å®Œæˆï¼›</li><li>æ‰§è¡Œå±éšœä»»åŠ¡ï¼Œå¹¶ç­‰å¾…å®Œæˆï¼›</li><li>ç»§ç»­æ‰§è¡Œåç»­å…¶ä»–ä»»åŠ¡ã€‚</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">concurrentQueue.async &#123;</span><br><span class="line">    <span class="type">DispatchQueueExp</span>.testTask(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">concurrentQueue.async &#123;</span><br><span class="line">    <span class="type">DispatchQueueExp</span>.testTask(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">concurrentQueue.async(flags: .barrier) &#123;</span><br><span class="line">    <span class="type">DispatchQueueExp</span>.testTask(<span class="string">&quot;Barrier-C&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">concurrentQueue.async &#123;</span><br><span class="line">    <span class="type">DispatchQueueExp</span>.testTask(<span class="string">&quot;D&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">concurrentQueue.async &#123;</span><br><span class="line">    <span class="type">DispatchQueueExp</span>.testTask(<span class="string">&quot;F&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Aå¼€å§‹-testTask(_:):&lt;NSThread: 0x6000025adec0&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">Bå¼€å§‹-testTask(_:):&lt;NSThread: 0x6000025e8340&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">Bç»“æŸ-testTask(_:):&lt;NSThread: 0x6000025e8340&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">Aç»“æŸ-testTask(_:):&lt;NSThread: 0x6000025adec0&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">Barrier-Cå¼€å§‹-testTask(_:):&lt;NSThread: 0x6000025adec0&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">Barrier-Cç»“æŸ-testTask(_:):&lt;NSThread: 0x6000025adec0&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">Då¼€å§‹-testTask(_:):&lt;NSThread: 0x6000025adec0&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">Få¼€å§‹-testTask(_:):&lt;NSThread: 0x6000025962c0&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">Dç»“æŸ-testTask(_:):&lt;NSThread: 0x6000025adec0&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">Fç»“æŸ-testTask(_:):&lt;NSThread: 0x6000025962c0&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è°ƒåº¦ä¿¡å·é‡">è°ƒåº¦ä¿¡å·é‡</h3><ul><li>è°ƒåº¦ä¿¡å·é‡ç”¨äºåœ¨è®¿é—®ä¸€äº›æœ‰é™èµ„æºæ—¶ï¼Œç”¨å®ƒæ¥æ§åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„ä»»åŠ¡æ•°é‡ã€‚</li><li>è°ƒåº¦ä¿¡å·é‡æ¯”ä¼ ç»Ÿä¿¡å·é‡æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚ä¼ ç»Ÿä¿¡å·é‡æ€»æ˜¯éœ€è¦è°ƒç”¨å†…æ ¸æ¥æµ‹è¯•ä¿¡å·é‡ã€‚å› ä¸ºå½“èµ„æºå¯ç”¨çš„æ—¶å€™ï¼Œè·å–ä¸€ä¸ªä¿¡å·é‡æ¯”è·å–ä¼ ç»Ÿä¿¡å·é‡æ›´å¿«ï¼Œå› ä¸ºå½“èµ„æºå¯ç”¨æ—¶è°ƒåº¦ä¿¡å·é‡ä¸ä¼šå‘ä¸‹è°ƒç”¨å†…æ ¸ã€‚å”¯ä¸€è°ƒç”¨å†…æ ¸çš„å®é™…æ—¶æœºæ—¶èµ„æºä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿæš‚åœçº¿ç¨‹ç›´åˆ°å‘å‡ºä¿¡å·ã€‚</li><li>å¦‚æœæ˜¯ä¸ºäº†å¯¹èµ„æºåŠ é”ï¼Œé‚£ä¹ˆä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—å¯èƒ½æ€§èƒ½æ›´ä¼˜ã€‚</li><li>ä¿¡å·é‡å€¼ â‰¤ 0ï¼Œåˆ™é˜»å¡å½“å‰çº¿ç¨‹è¿›å…¥ä¼‘çœ ç­‰å¾…ï¼Œç›´åˆ°ä¿¡å·é‡å€¼ &gt; 0ã€‚</li><li>ä½¿ç”¨è°ƒåº¦ä¿¡å·é‡çš„æ­¥éª¤ï¼š<ol type="1"><li>åˆ›å»ºä¿¡å·é‡ï¼Œä¼ å…¥å¯ç”¨èµ„æºæ•°é‡ã€‚</li><li><code>wait</code>è®©ä¿¡å·é‡-1ï¼Œè¡¨ç¤ºå·²å ç”¨ä¸€ä¸ªèµ„æºã€‚</li><li>æ‰§è¡Œä»»åŠ¡ã€‚å®Œæˆæ—¶ï¼Œè°ƒç”¨<code>signal</code>è®©ä¿¡å·é‡+1ï¼Œè¡¨é‡Šæ”¾èµ„æºã€‚</li></ol></li><li>æ³¨æ„ï¼Œè‹¥åœ¨é”€æ¯æ—¶ä¿¡å·é‡çš„å€¼å°äºåˆå§‹å€¼ï¼Œåˆ™ä¼šå´©æºƒï¼ˆBUG IN CLIENT OF LIBDISPATCH: Semaphore object deallocated while in useï¼‰ã€‚</li><li>å½“åˆå§‹å€¼ä¸º0çš„ä¿¡å·é‡ï¼Œå¯ä»¥ç”¨ä½œé”ï¼Œå³è°ƒç”¨<code>wait</code>é©¬ä¸Šé˜»å¡çº¿ç¨‹ï¼Œ<code>signal</code>æ‰è§£å¼€çº¿ç¨‹ã€‚ä¾‹å¦‚å¯ä»¥è®©å¼‚æ­¥æ“ä½œå˜æˆåŒæ­¥æ“ä½œã€‚</li></ul><p>åº”ç”¨ï¼š</p><ul><li>å¼‚æ­¥å˜åŒæ­¥</li><li>æ§åˆ¶å¹¶å‘é‡ï¼ŒMetalç»˜åˆ¶ç»å¸¸ä½¿ç”¨ã€‚</li></ul><p>æ§åˆ¶å¹¶å‘é‡</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span>(<span class="params">label</span>: <span class="type">String</span>, <span class="params">cost</span>: <span class="type">UInt32</span>, <span class="params">complete</span>:<span class="keyword">@escaping</span> ()-&gt;())</span>&#123;</span><br><span class="line">    <span class="type">NSLog</span>(<span class="string">&quot;Start task%@&quot;</span>,label)</span><br><span class="line">    sleep(cost)</span><br><span class="line">    <span class="type">NSLog</span>(<span class="string">&quot;End task%@&quot;</span>,label)</span><br><span class="line">    complete()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> semaphore <span class="operator">=</span> <span class="type">DispatchSemaphore</span>(value: <span class="number">3</span>)</span><br><span class="line"><span class="keyword">let</span> queue <span class="operator">=</span> <span class="type">DispatchQueue</span>(label: <span class="string">&quot;&quot;</span>, qos: .default, attributes: .concurrent)</span><br><span class="line"></span><br><span class="line">queue.async &#123;</span><br><span class="line">    semaphore.wait()</span><br><span class="line">    <span class="keyword">self</span>.doSomething(label: <span class="string">&quot;1&quot;</span>, cost: <span class="number">2</span>, complete: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">Thread</span>.current)</span><br><span class="line">        semaphore.signal()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">queue.async &#123;</span><br><span class="line">    semaphore.wait()</span><br><span class="line">    <span class="keyword">self</span>.doSomething(label: <span class="string">&quot;2&quot;</span>, cost: <span class="number">2</span>, complete: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">Thread</span>.current)</span><br><span class="line">        semaphore.signal()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">queue.async &#123;</span><br><span class="line">    semaphore.wait()</span><br><span class="line">    <span class="keyword">self</span>.doSomething(label: <span class="string">&quot;3&quot;</span>, cost: <span class="number">4</span>, complete: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">Thread</span>.current)</span><br><span class="line">        semaphore.signal()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">queue.async &#123;</span><br><span class="line">    semaphore.wait()</span><br><span class="line">    <span class="keyword">self</span>.doSomething(label: <span class="string">&quot;4&quot;</span>, cost: <span class="number">2</span>, complete: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">Thread</span>.current)</span><br><span class="line">        semaphore.signal()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">queue.async &#123;</span><br><span class="line">    semaphore.wait()</span><br><span class="line">    <span class="keyword">self</span>.doSomething(label: <span class="string">&quot;5&quot;</span>, cost: <span class="number">3</span>, complete: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">Thread</span>.current)</span><br><span class="line">        semaphore.signal()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è°ƒåº¦ç»„">è°ƒåº¦ç»„</h3><ul><li>è°ƒåº¦ç»„æ˜¯ä¸€ç§åœ¨ä¸€æˆ–å¤šä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹å‰é˜»å¡çº¿ç¨‹çš„æ–¹å¼ã€‚</li></ul><p>DispatchGroupä¸¤ç§ç”¨æ³•:</p><p>ä¸€ã€è°ƒåº¦é˜Ÿåˆ—è°ƒåº¦æ—¶ä¼ å…¥è°ƒåº¦ç»„</p><p>æœ€ç®€å•çš„ç”¨æ³•ã€‚</p><p>notifyï¼šå¯¹ç»„åšå®Œæˆç›‘å¬ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> group <span class="operator">=</span> <span class="type">DispatchGroup</span>()</span><br><span class="line">myQueue<span class="operator">?</span>.async(group: group, qos: .default, flags: [], execute: &#123; </span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">_</span> <span class="keyword">in</span> <span class="number">0</span><span class="operator">...</span><span class="number">10</span> &#123;</span><br><span class="line">       <span class="built_in">print</span>(<span class="string">&quot;è€—æ—¶ä»»åŠ¡ä¸€&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">myQueue<span class="operator">?</span>.async(group: group, qos: .default, flags: [], execute: &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">_</span> <span class="keyword">in</span> <span class="number">0</span><span class="operator">...</span><span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è€—æ—¶ä»»åŠ¡äºŒ&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//æ‰§è¡Œå®Œä¸Šé¢çš„ä¸¤ä¸ªè€—æ—¶æ“ä½œ, å›åˆ°myQueueé˜Ÿåˆ—ä¸­æ‰§è¡Œä¸‹ä¸€æ­¥çš„ä»»åŠ¡</span></span><br><span class="line">group.notify(queue: myQueue<span class="operator">!</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å›åˆ°è¯¥é˜Ÿåˆ—ä¸­æ‰§è¡Œ&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>waitï¼šé˜»å¡çº¿ç¨‹ï¼ŒåŒæ­¥è®¿é—®ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç­‰å¾…ä¸Šé¢ä»»åŠ¡æ‰§è¡Œï¼Œä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè¶…æ—¶å°±æ‰§è¡Œä¸‹é¢çš„ï¼Œä¸Šé¢çš„ç»§ç»­æ‰§è¡Œã€‚å¯ä»¥æ— é™ç­‰å¾… .distantFuture</span></span><br><span class="line"><span class="keyword">let</span> result <span class="operator">=</span> group.wait(timeout: .now() <span class="operator">+</span> <span class="number">2.0</span>)</span><br><span class="line"><span class="keyword">switch</span> result &#123;</span><br><span class="line">    <span class="keyword">case</span> .success:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ä¸è¶…æ—¶, ä¸Šé¢çš„ä¸¤ä¸ªä»»åŠ¡éƒ½æ‰§è¡Œå®Œ&quot;</span>)</span><br><span class="line">    <span class="keyword">case</span> .timedOut:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¶…æ—¶äº†, ä¸Šé¢çš„ä»»åŠ¡è¿˜æ²¡æ‰§è¡Œå®Œæ‰§è¡Œè¿™äº†&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ¥ä¸‹æ¥çš„æ“ä½œ&quot;</span>)</span><br></pre></td></tr></table></figure><p>äºŒã€enter-leave</p><p>æ‰‹åŠ¨ç®¡ç†è°ƒåº¦ç»„è®¡æ•°ï¼Œ<code>enter</code>å’Œ<code>leave</code>å¿…é¡»é…å¯¹ã€‚</p><p>åº”ç”¨æ›´ä¸ºè‡ªç”±ï¼Œä¸ç”¨ç»™é˜Ÿåˆ—è°ƒç”¨ä¼ å…¥è°ƒåº¦ç»„ï¼Œå¯åœ¨ä»»æ„çš„é˜Ÿåˆ—æ“ä½œè°ƒåº¦ç»„è®¡æ•°ã€‚åŒæ ·æœ€åé€šè¿‡notifyç›‘å¬å®Œæˆå›è°ƒã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> group <span class="operator">=</span> <span class="type">DispatchGroup</span>()</span><br><span class="line">group.enter()<span class="comment">//æŠŠè¯¥ä»»åŠ¡æ·»åŠ åˆ°ç»„é˜Ÿåˆ—ä¸­æ‰§è¡Œ</span></span><br><span class="line">myQueue<span class="operator">?</span>.async &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">_</span> <span class="keyword">in</span> <span class="number">0</span><span class="operator">...</span><span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è€—æ—¶ä»»åŠ¡ä¸€&quot;</span>)</span><br><span class="line">        group.leave()<span class="comment">//æ‰§è¡Œå®Œä¹‹åä»ç»„é˜Ÿåˆ—ä¸­ç§»é™¤</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">group.enter()<span class="comment">//æŠŠè¯¥ä»»åŠ¡æ·»åŠ åˆ°ç»„é˜Ÿåˆ—ä¸­æ‰§è¡Œ</span></span><br><span class="line">myQueue<span class="operator">?</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">_</span> <span class="keyword">in</span> <span class="number">0</span><span class="operator">...</span><span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è€—æ—¶ä»»åŠ¡äºŒ&quot;</span>)</span><br><span class="line">        group.leave()<span class="comment">//æ‰§è¡Œå®Œä¹‹åä»ç»„é˜Ÿåˆ—ä¸­ç§»é™¤</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å½“ä¸Šé¢æ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå®Œä¹‹åé€šçŸ¥</span></span><br><span class="line">group.notify(queue: .main) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;æ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå®Œäº†&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒåº¦ç»„å’Œè°ƒåº¦ä¿¡å·é‡éƒ½å¯ä»¥å®ç°åœ¨å¼‚æ­¥è°ƒç”¨ä¸­è¿›è¡Œè®¡æ•°ï¼Œé™¤äº†ç”¨æ³•ä¸ä¸€æ ·å¤–ï¼Œè°ƒåº¦ä¿¡å·é‡åªèƒ½ç”¨äºé˜»å¡ï¼Œè€Œè°ƒåº¦ç»„é™¤äº†é˜»å¡å¤–ä¹Ÿæä¾›äº†å¼‚æ­¥ç›‘å¬å®Œæˆçš„å›è°ƒã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Grand Central Dispatchï¼ˆGCDï¼‰è°ƒåº¦é˜Ÿåˆ—æ˜¯æ‰§è¡Œä»»åŠ¡çš„å¼ºå¤§å·¥å…·ã€‚è°ƒåº¦é˜Ÿåˆ—è®©ä½ å¯ä»¥ç›¸å¯¹äºè°ƒç”¨è€…å¼‚æ­¥æˆ–åŒæ­¥åœ°æ‰§è¡Œä»»æ„çš„ä»£ç å—ã€‚ä½ å¯ä»¥ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—æ¥æ‰§è¡Œå‡ ä¹æ‰€æœ‰ä½ è¿‡å»åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ä»»åŠ¡ã€‚è°ƒåº¦é˜Ÿåˆ—çš„ä¼˜ç‚¹æ˜¯ä½¿ç”¨èµ·æ¥æ›´ç®€å•ï¼Œæ‰§è¡Œä»»åŠ¡çš„æ•ˆç‡ç›¸æ¯”çº¿ç¨‹ä»£ç é«˜å¾—å¤šã€‚&lt;/p&gt;
&lt;p&gt;æœ¬ç« ä»‹ç»äº†è°ƒåº¦é˜Ÿåˆ—ï¼Œä»¥åŠå¦‚ä½•æ‰§è¡Œç¨‹åºä¸­çš„ä¸€èˆ¬ä»»åŠ¡ã€‚å¦‚æœä½ æƒ³ç”¨è°ƒåº¦é˜Ÿåˆ—æ›¿æ¢ç°æœ‰çš„çº¿ç¨‹ä»£ç ï¼Œå¯å‚é˜…&lt;a href=&quot;.%2F05%20Migrating%20Away%20from%20Threads.md&quot;&gt;è¿ç§»çº¿ç¨‹ä»£ç &lt;/a&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Concurrency Programming Guide" scheme="https://bqlin.github.io/tags/Concurrency-Programming-Guide/"/>
    
    <category term="å¤šçº¿ç¨‹" scheme="https://bqlin.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Concurrency Programming Guideï¼šæ“ä½œé˜Ÿåˆ—</title>
    <link href="https://bqlin.github.io/posts/concurrency_pg_operation_queues/"/>
    <id>https://bqlin.github.io/posts/concurrency_pg_operation_queues/</id>
    <published>2021-09-08T09:41:58.000Z</published>
    <updated>2021-10-24T04:12:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>Cocoaæ“ä½œå¯¹è±¡æ˜¯ä¸€ç§ä»¥é¢å‘å¯¹è±¡çš„æ–¹å¼æ¥å°ä½ éœ€è¦å¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡ã€‚æ“ä½œå¯¹è±¡è¢«è®¾è®¡æˆè·Ÿæ“ä½œé˜Ÿåˆ—é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨ï¼Œæˆ–è€…å•ç‹¬ä½¿ç”¨ã€‚å› ä¸ºæ˜¯åŸºäºObjective-Cå®ç°çš„ï¼Œæ“ä½œå¯¹è±¡å¯åŒæ—¶åœ¨ OS X å’Œ iOS ä¸­ä½¿ç”¨ã€‚</p><span id="more"></span><h2 id="å…³äºæ“ä½œå¯¹è±¡">å…³äºæ“ä½œå¯¹è±¡</h2><p>ä¸€ä¸ª<em>æ“ä½œå¯¹è±¡</em>æ˜¯ä¸€ä¸ª <code>NSOperation</code> ç±»çš„å®ä¾‹ï¼Œç”¨å…¶å°è£…éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚<code>NSOperation</code> æ˜¯æŠ½è±¡åŸºç±»ï¼Œå¦‚æœä½ è¦åšå•¥å…·ä½“çš„ä»»åŠ¡ï¼Œå¿…é¡»è¦é€šè¿‡å…¶å­ç±»æ¥å®Œæˆã€‚å°½ç®¡æ˜¯æŠ½è±¡åŸºç±»ï¼Œ<code>NSOperation</code> ä»ç„¶æä¾›äº†é‡è¦çš„åŸºç¡€è®¾æ–½ï¼Œä»¥å‡å°‘å­ç±»çš„å·¥ä½œé‡ã€‚å¦å¤–ï¼ŒFoundationæ¡†æ¶æä¾›äº†ä¸¤ä¸ªå…·ä½“çš„å­ç±»ä¾›å¼€å‘è€…ç›´æ¥ä½¿ç”¨ã€‚</p><table><colgroup><col style="width: 27%" /><col style="width: 72%" /></colgroup><thead><tr class="header"><th>ç±»</th><th>æè¿°</th></tr></thead><tbody><tr class="odd"><td><code>NSInvocationOperation</code></td><td>è¯¥ç±»å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œé€šè¿‡ç¨‹åºå¯¹è±¡å’Œselectorç›´æ¥åˆ›å»ºä¸€ä¸ªæ“ä½œå¯¹è±¡ã€‚ä½ å¯ä»¥å¯¹å·²æœ‰çš„ä»»åŠ¡æ–¹æ³•ä½¿ç”¨è¯¥ç±»ã€‚å› ä¸ºå…¶ä¸éœ€è¦å­ç±»åŒ–ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨è¯¥ç±»ä»¥æ›´åŠ¨æ€çš„æ–¹å¼åˆ›å»ºæ“ä½œå¯¹è±¡ã€‚å…³äºå¦‚ä½•ä½¿ç”¨è¯¥ç±»çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW6">Creating an NSInvocationOperation Object</a>ã€‚</td></tr><tr class="even"><td><code>NSBlockOperation</code></td><td>è¯¥ç±»å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå¯ä»¥æ‰§è¡Œä¸€åˆ°å¤šä¸ªblockã€‚å› ä¸ºå…¶å¯ä»¥æ‰§è¡Œä¸€åˆ°å¤šä¸ªblockï¼Œæ‰€ä»¥è¯¥æ“ä½œå¯¹è±¡ä½¿ç”¨ç»„çš„è¯­ä¹‰è¿›è¡Œæ“ä½œï¼Œåªæœ‰å½“ç›¸å…³çš„blockéƒ½æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæ“ä½œå¯¹è±¡æœ¬èº«æ‰ç®—å®Œæˆã€‚å…³äºä½¿ç”¨è¯¥ç±»çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW2">Creating an NSBlockOperation Object</a>ã€‚</td></tr><tr class="odd"><td><code>NSOperation</code></td><td>è¯¥ç±»æ˜¯ç”¨äºè‡ªå®šä¹‰æ“ä½œå¯¹è±¡çš„åŸºç±»ã€‚é€šè¿‡å­ç±»åŒ–<code>NSOperation</code>ï¼Œä½ å¯ä»¥å®Œå…¨æ§åˆ¶è‡ªå·±çš„æ“ä½œå®ç°ï¼ŒåŒ…æ‹¬æ”¹å˜æ“ä½œæ‰§è¡Œå’Œæ±‡æŠ¥çŠ¶æ€çš„é»˜è®¤æ–¹å¼ã€‚å…³äºå¦‚ä½•è‡ªå®šä¹‰æ“ä½œå¯¹è±¡çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="#è‡ªå®šä¹‰æ“ä½œå¯¹è±¡">è‡ªå®šä¹‰æ“ä½œå¯¹è±¡</a>ã€‚</td></tr></tbody></table><p>æ‰€æœ‰æ“ä½œå¯¹è±¡éƒ½æ”¯æŒä»¥ä¸‹ç‰¹æ€§ï¼š</p><ul><li>æ”¯æŒåœ¨æ“ä½œå¯¹è±¡é—´å»ºç«‹åŸºäºå›¾çš„ä¾èµ–å…³ç³»ã€‚å…³äºå¦‚ä½•é…ç½®ä¾èµ–ï¼Œå¯å‚é˜…<a href="#é…ç½®äº¤äº’ä¾èµ–">é…ç½®äº¤äº’ä¾èµ–</a>ã€‚</li><li>æ”¯æŒä¸€ä¸ªå¯é€‰çš„å®Œæˆå›è°ƒblockï¼Œè¯¥blockåœ¨ä»»åŠ¡ç»“æŸåæ‰§è¡Œã€‚(ä»…é™OS X v10.6åŠä»¥åç‰ˆæœ¬ã€‚ï¼‰å…³äºå¦‚ä½•è®¾ç½®å®Œæˆå›è°ƒblockï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW33">Setting Up a Completion Block</a>ã€‚</li><li>æ”¯æŒé€šè¿‡ KVO è§‚å¯Ÿä»»åŠ¡æ‰§è¡Œçš„çŠ¶æ€ã€‚å…³äºå¦‚ä½•è§‚å¯ŸKVOé€šçŸ¥ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html#//apple_ref/doc/uid/10000177i">Key-Value Observing Programming Guide</a>ã€‚</li><li>æ”¯æŒå¯¹æ“ä½œå¯¹è±¡ä¼˜å…ˆçº§æ’åºï¼Œä»è€Œæ”¹å˜æ“ä½œå¯¹è±¡é—´ç›¸å¯¹æ‰§è¡Œçš„é¡ºåºã€‚äº†è§£æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW31">Changing an Operationâ€™s Execution Priority</a>ã€‚</li><li>æ”¯æŒå–æ¶ˆçš„è¯­ä¹‰ï¼Œå½“ä»»åŠ¡åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¯ä»¥å–æ¶ˆä»»åŠ¡ã€‚æœ‰å…³å¦‚ä½•å–æ¶ˆæ“ä½œå¯¹è±¡ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW39">Canceling Operations</a>ã€‚æœ‰å…³å¦‚ä½•åœ¨è‡ªå·±çš„æ“ä½œå¯¹è±¡ä¸­æ”¯æŒå–æ¶ˆï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW24">Responding to Cancellation Events</a>ã€‚</li></ul><p>æ“ä½œå¯¹è±¡è¢«è®¾è®¡æ¥æé«˜åº”ç”¨çš„å¹¶å‘æ°´å¹³ã€‚æ“ä½œå¯¹è±¡ä¹Ÿæ˜¯ç»„ç»‡å’Œå°è£…ç¨‹åºè¡Œä¸ºåˆ°ç®€å•ç¦»æ•£å—çš„æ–¹å¼ã€‚ä½ å¯ä»¥æŠŠä¸€åˆ°å¤šä¸ªæ“ä½œæäº¤åˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè®©ç›¸åº”çš„å·¥ä½œåœ¨ä¸€åˆ°å¤šä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸Šå¼‚æ­¥æ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¨éƒ½é›†ä¸­åœ¨ç¨‹åºä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚</p><h2 id="å¹¶å‘ä¸éå¹¶å‘æ“ä½œå¯¹è±¡">å¹¶å‘ä¸éå¹¶å‘æ“ä½œå¯¹è±¡</h2><p>å°½ç®¡é€šå¸¸æŠŠæ“ä½œæ·»åŠ æ“ä½œé˜Ÿåˆ—æ¥æ‰§è¡Œï¼Œä½†è¿™æ ·åšä¸æ˜¯å¿…é¡»çš„ã€‚ä¹Ÿå¯ä»¥ç›´æ¥æ‰‹åŠ¨è°ƒç”¨<code>start</code>æ¥æ‰§è¡Œä¸€ä¸ªæ“ä½œå¯¹è±¡ï¼Œä½†è¿™æ ·åšå¹¶ä¸èƒ½ä¿è¯ä¸å…¶ä»–ä»£ç å¹¶è¡Œæ‰§è¡Œã€‚<code>NSOperation</code>ç±»çš„<code>isConcurrent</code>å‘Šè¯‰ä½ è¯¥æ“ä½œå¯¹è±¡ç›¸å¯¹äºè°ƒç”¨ <code>start</code> æ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æ˜¯å¼‚æ­¥çš„ã€‚é»˜è®¤è¿”å› <code>NO</code>ï¼Œè¡¨ç¤ºæ“ä½œå¯¹è±¡åŒæ­¥åœ°è·‘åœ¨è°ƒç”¨çš„çº¿ç¨‹ä¸Šã€‚</p><p>å¦‚æœä½ éœ€è¦å®ç°ä¸€ä¸ª<em>å¹¶å‘çš„æ“ä½œå¯¹è±¡</em>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç›¸å¯¹äºè°ƒç”¨çº¿ç¨‹è€Œè¨€æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä½ å¿…é¡»å†™é¢å¤–çš„ä»£ç å¼‚æ­¥çš„å¯åŠ¨æ“ä½œå¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè°ƒç”¨å¼‚æ­¥ç³»ç»Ÿå‡½æ•°ï¼Œæˆ–è€…ä»»ä½•ä¿è¯ <code>start</code> æ–¹æ³•å¯åŠ¨ä»»åŠ¡ï¼Œå¹¶ç«‹å³è¿”å›ï¼Œè€Œä¸”å¾ˆæœ‰å¯èƒ½åœ¨ä»»åŠ¡å®Œæˆä¹‹å‰è¿”å›ã€‚</p><p>å¤§éƒ¨åˆ†å¼€å‘è€…åº”è¯¥ç»ä¸éœ€è¦å®ç°å¹¶å‘æ“ä½œå¯¹è±¡ã€‚å¦‚æœä½ æ€»æ˜¯å°†æ“ä½œå¯¹è±¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œä½ ä¸éœ€è¦å®ç°å¹¶å‘æ“ä½œå¯¹è±¡ã€‚å½“ä½ æäº¤ä¸€ä¸ªéå¹¶å‘æ“ä½œå¯¹è±¡åˆ°æ“ä½œé˜Ÿåˆ—çš„æ—¶å€™ï¼Œé˜Ÿåˆ—è‡ªèº«ä¼šåˆ›å»ºä¸€ä¸ªæ‰§è¡Œæ“ä½œå¯¹è±¡çš„çº¿ç¨‹ã€‚å› æ­¤ï¼Œæ·»åŠ ä¸€ä¸ªéå¹¶å‘æ“ä½œå¯¹è±¡åˆ°æ“ä½œé˜Ÿåˆ—ä»ç„¶å¯¼è‡´äº†æ“ä½œå¯¹è±¡çš„å¼‚æ­¥æ‰§è¡Œã€‚ä½ åº”åªåœ¨éœ€è¦å¼‚æ­¥æ‰§è¡Œæ“ä½œå¯¹è±¡ä½†åˆä¸æ·»åŠ åˆ°æ“ä½œé˜Ÿåˆ—çš„æƒ…å†µä¸‹æ‰å®šä¹‰å¹¶å‘æ“ä½œå¯¹è±¡ã€‚</p><p>å…³äºå¦‚ä½•åˆ›å»ºä¸€ä¸ªå¹¶å‘æ“ä½œå¯¹è±¡ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW8">Configuring Operations for Concurrent Execution</a>å’Œ<a href="https://developer.apple.com/documentation/foundation/nsoperation">NSOperation Class Reference</a>ã€‚</p><h2 id="åˆ›å»ºnsinvocationoperationå¯¹è±¡">åˆ›å»ºNSInvocationOperationå¯¹è±¡</h2><p><code>NSInvocationOperation</code> ç±»æ˜¯ <code>NSOperation</code> çš„å…·ä½“å­ç±»ï¼Œè¿è¡Œæ—¶è°ƒç”¨ä½ æŒ‡å®šå¯¹è±¡çš„selectorã€‚ä½¿ç”¨è¿™ä¸ªç±»å¯ä»¥å‡å°‘å¤§é‡çš„è‡ªå®šä¹‰æ“ä½œå¯¹è±¡çš„éœ€æ±‚ï¼Œå°¤å…¶æ˜¯ä¿®æ”¹ç¨‹åºå·²å®ç°çš„å¯¹è±¡å’Œä»»åŠ¡æ–¹æ³•æ—¶ã€‚å½“ä½ å¸Œæœ›è°ƒç”¨çš„æ–¹æ³•å¯ä»¥ä¿®æ”¹æ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨è¯¥ç±»ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè°ƒç”¨æ“ä½œæ¥æ‰§è¡Œä¸€ä¸ªåŸºäºç”¨æˆ·è¾“å…¥åŠ¨æ€é€‰æ‹©çš„selectorã€‚</p><p>åˆ›å»ºinvocationæ“ä½œå¯¹è±¡å¾ˆç®€å•ã€‚åˆ›å»ºå¹¶åˆå§‹åŒ–è¯¥ç±»çš„å®ä¾‹ï¼ŒæŠŠéœ€è¦æ‰§è¡Œçš„å¯¹è±¡å’Œselectorä¼ é€’ç»™åˆå§‹åŒ–æ–¹æ³•ã€‚æ¸…å•2-1å±•ç¤ºäº†ä¸€ä¸ªè‡ªå®šä¹‰ç±»çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œæ¼”ç¤ºäº†åˆ›å»ºè¿‡ç¨‹ï¼š</p><p><strong>æ¸…å•2-1</strong> åˆ›å»ºä¸€ä¸ª<code>NSInvocationOperation</code>å¯¹è±¡</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyCustomClass</span></span></span><br><span class="line">- (<span class="built_in">NSOperation</span>*)taskWithData:(<span class="keyword">id</span>)data &#123;</span><br><span class="line">    <span class="built_in">NSInvocationOperation</span>* theOp = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span></span><br><span class="line">                    selector:<span class="keyword">@selector</span>(myTaskMethod:) object:data];</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">return</span> theOp;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// This is the method that does the actual work of the task.</span></span><br><span class="line">- (<span class="keyword">void</span>)myTaskMethod:(<span class="keyword">id</span>)data &#123;</span><br><span class="line">    <span class="comment">// Perform the task.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h2 id="åˆ›å»ºnsblockoperationå¯¹è±¡">åˆ›å»ºNSBlockOperationå¯¹è±¡</h2><p><code>NSBlockOperation</code> åŒæ ·æ˜¯ <code>NSOperation</code> çš„å…·ä½“å­ç±»ï¼Œç”¨æ¥å°è£…ä¸€ä¸ªæˆ–å¤šä¸ªblockã€‚è¿™ä¸ªç±»ç»™é‚£äº›å·²ç»ä½¿ç”¨äº†æ“ä½œé˜Ÿåˆ—å¹¶ä¸æƒ³åˆ›è°ƒåº¦å‘é˜Ÿåˆ—çš„åº”ç”¨æä¾›äº†é¢å‘å¯¹è±¡çš„å°è£…ã€‚é€šè¿‡æ“ä½œé˜Ÿåˆ—å¯ä»¥ä½¿ç”¨é‚£äº›è°ƒåº¦é˜Ÿåˆ—æ²¡æœ‰çš„ä¸€äº›ç‰¹æ€§ï¼Œå¦‚æ“ä½œå¯¹è±¡ä¾èµ–ã€KVOé€šçŸ¥ç­‰ã€‚</p><p>å½“ä½ åˆ›å»ºä¸€ä¸ªblockæ“ä½œå¯¹è±¡çš„æ—¶ï¼Œé€šå¸¸åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä½ æ·»åŠ ä¸€ä¸ª blockï¼›åç»­ä½ è¿˜å¯ä»¥æ·»åŠ å¤šä¸ªblockã€‚å½“æ‰§è¡Œä¸€ä¸ª <code>NSBlockOperation</code> å¯¹è±¡çš„æ—¶å€™ï¼Œè¯¥å¯¹è±¡ä¼šæŠŠæ‰€æœ‰çš„ blockæäº¤ç»™é»˜è®¤ä¼˜å…ˆçº§çš„å¹¶å‘è°ƒåº¦é˜Ÿåˆ—ä¸Šã€‚å¯¹è±¡ä¼šç­‰å¾…æ‰€æœ‰çš„ block æ‰§è¡Œå®Œæ¯•ã€‚å½“æœ€åçš„ä¸€ä¸ª block æ‰§è¡Œå®Œåï¼Œå¯¹è±¡ä¼šç½®è‡ªå·±çš„çŠ¶æ€ä¸ºå®Œæˆã€‚å› æ­¤ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª blockæ“ä½œå¯¹è±¡æ¥è¿½è¸ªä¸€ç»„æ‰§è¡Œçš„ blockï¼Œå°±åƒä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹ join merge å¤šä¸ªçº¿ç¨‹æ‰§è¡Œçš„ç»“æœã€‚å› ä¸º blockæ“ä½œå¯¹è±¡è·‘åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸Šï¼Œç¨‹åºçš„å…¶ä»–çº¿ç¨‹ä¸­çš„ä»»åŠ¡ä¸å—å½±å“ï¼ŒåŒæ—¶å¯ä»¥ç­‰å¾… blockæ“ä½œå¯¹è±¡çš„å®Œæˆã€‚</p><p>æ¸…å•2-2æ˜¾ç¤ºäº†ä¸€ä¸ªå¦‚ä½•åˆ›å»º<code>NSBlockOperation</code>å¯¹è±¡çš„ç®€å•ç¤ºä¾‹ã€‚è¯¥blockæœ¬èº«æ²¡æœ‰å‚æ•°ï¼Œä¹Ÿæ²¡æœ‰é‡è¦çš„è¿”å›ç»“æœã€‚</p><p><strong>æ¸…å•2-2</strong> åˆ›å»ºä¸€ä¸ª<code>NSBlockOperation</code>å¯¹è±¡</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSBlockOperation</span>* theOp = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock: ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Beginning operation.\n&quot;</span>);</span><br><span class="line">    <span class="comment">// Do some work.</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><p>åˆ›å»ºäº† block æ“ä½œå¯¹è±¡ä¹‹åï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>addExecutionBlock:</code> æ–¹æ³•æ·»åŠ æ›´å¤šçš„ blockã€‚å¦‚æœä½ éœ€è¦ä¸²è¡Œæ‰§è¡Œ blockï¼Œä½ å¿…é¡»ç›´æ¥æŠŠ block æäº¤ç»™æŒ‡å®šçš„è°ƒåº¦é˜Ÿåˆ—ã€‚</p><h2 id="è‡ªå®šä¹‰æ“ä½œå¯¹è±¡">è‡ªå®šä¹‰æ“ä½œå¯¹è±¡</h2><p>å¦‚æœ block æ“ä½œå¯¹è±¡å’Œ invocation æ“ä½œå¯¹è±¡éƒ½ä¸èƒ½æ»¡è¶³ç¨‹åºçš„éœ€æ±‚ï¼Œä½ å¯ä»¥ç›´æ¥å®ç° <code>NSOperation</code> çš„å­ç±»ï¼Œæ·»åŠ éœ€è¦çš„è¡Œä¸ºã€‚<code>NSOperation</code> ç±»å¯¹æ‰€æœ‰æ“ä½œå¯¹è±¡æä¾›äº†é€šç”¨çš„å­ç±»ï¼Œä¹Ÿæä¾›äº†å¤§é‡çš„åŸºç¡€è®¾æ–½æ¥å¤„ç†ä¾èµ–ç®¡ç†å’Œ KVO é€šçŸ¥ã€‚ç„¶è€Œï¼Œä»ç„¶æœ‰äº›æ—¶å€™ä½ éœ€è¦è¡¥å……å…ˆæœ‰çš„åŸºç¡€è®¾æ–½ä»¥ç¡®ä¿æ“ä½œè¡Œä¸ºçš„æ­£ç¡®ã€‚è¦åšçš„é¢å¤–å·¥ä½œé‡å–å†³äºä½ åœ¨å®ç°ä¸€ä¸ªéå¹¶å‘è¿˜æ˜¯å¹¶å‘æ“ä½œå¯¹è±¡ã€‚</p><p>å®šä¹‰ä¸€ä¸ªéå¹¶å‘æ“ä½œæ¯”å¹¶å‘æ“ä½œç®€å•å¾—å¤šã€‚å¯¹äºéå¹¶å‘æ“ä½œå¯¹è±¡è€Œè¨€ï¼Œæ‰€æœ‰ä½ éœ€è¦åšçš„æ˜¯ main task å’Œåˆç†çš„å“åº”å–æ¶ˆäº‹ä»¶ï¼›å·²ç»å­˜åœ¨çš„åŸºç¡€è®¾æ–½å·²ç»ä¸ºä½ å®Œæˆäº†å…¶ä»–å·¥ä½œã€‚å¯¹äºä¸€ä¸ªå¹¶å‘æ“ä½œå¯¹è±¡è€Œè¨€ï¼Œä½ å¿…é¡»ä½¿ç”¨è‡ªå®šä¹‰çš„ä»£ç æ›¿æ¢æ‰ç°æœ‰çš„åŸºç¡€è®¾æ–½ã€‚ä¸‹æ¥çš„éƒ¨åˆ†å°†è¦è¯´æ˜æ€ä¹ˆå®ç°è¿™ä¸¤ç§ç±»å‹ã€‚</p><h3 id="æ‰§è¡Œmain-task">æ‰§è¡ŒMain Task</h3><p>æ¯ä¸ªæ“ä½œå¯¹è±¡è‡³å°‘å®ç°ä»¥ä¸‹æ–¹æ³•ï¼š</p><ul><li>ä¸€ä¸ªè‡ªå®šä¹‰çš„åˆå§‹åŒ–æ–¹æ³•</li><li><code>main</code>æ–¹æ³•</li></ul><p>ä½ éœ€è¦ä¸€ä¸ªè‡ªå®šä¹‰çš„åˆå§‹åŒ–æ–¹æ³•å°†ä½ çš„æ“ä½œå¯¹è±¡æ”¾å…¥å·²çŸ¥çš„çŠ¶æ€ï¼Œä¸€ä¸ª <code>main</code> æ–¹æ³•æ¥æ‰§è¡Œçš„ä½ çš„ä»»åŠ¡ã€‚å½“ç„¶å¯ä»¥æ ¹æ®éœ€è¦å®ç°é¢å¤–çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><ul><li>æ‰“ç®—ä» <code>main</code> æ–¹æ³•è°ƒç”¨çš„è‡ªå®šä¹‰æ–¹æ³•</li><li>è®¾ç½®æ•°æ®å’Œè·å–ç»“æœçš„å±æ€§è®¿é—®å™¨</li><li><code>NSCoding</code>ä¸­çš„å½’æ¡£å’Œè§£æ¡£æ–¹æ³•</li></ul><p>ä¸‹ä¾‹å±•ç¤ºäº†ä¸€ä¸ªè‡ªå®šä¹‰ <code>NSOperation</code> çš„å¯åŠ¨æ¨¡æ¿ï¼ˆä»£ç ä¸­æ²¡æœ‰å±•ç¤ºåœ¨æ€ä¹ˆå¤„ç† cancellationï¼Œä½†å±•ç¤ºäº†ä½ é€šå¸¸éœ€è¦çš„æ–¹æ³•ï¼‰ã€‚</p><p>æ¸…å•2-3å±•ç¤ºäº†ä¸€ä¸ªè‡ªå®šä¹‰<code>NSOperation</code>å­ç±»çš„åˆå§‹æ¨¡æ¿ã€‚(è¿™ä¸ªæ¸…å•æ²¡æœ‰æ˜¾ç¤ºå¦‚ä½•å¤„ç†å–æ¶ˆï¼Œä½†æ˜¾ç¤ºäº†ä½ é€šå¸¸å®ç°çš„æ–¹æ³•ã€‚å…³äºå¤„ç†å–æ¶ˆï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW24">Responding to Cancellation Events</a>ï¼‰ã€‚) è¯¥ç±»çš„åˆå§‹åŒ–æ–¹æ³•éœ€è¦ä¸€ä¸ªå•ä¸€çš„å¯¹è±¡ä½œä¸ºæ•°æ®å‚æ•°ï¼Œå¹¶åœ¨æ“ä½œå¯¹è±¡ä¸­å­˜å‚¨å¯¹å®ƒçš„å¼•ç”¨ã€‚<code>main</code>æ–¹æ³•è¡¨é¢ä¸Šæ˜¯å¯¹è¯¥æ•°æ®å¯¹è±¡è¿›è¡Œå¤„ç†ï¼Œç„¶åå°†ç»“æœè¿”å›ç»™ç¨‹åºã€‚</p><p><strong>æ¸…å•2-3</strong> å®šä¹‰ä¸€ä¸ªç®€å•çš„æ“ä½œå¯¹è±¡</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyNonConcurrentOperation</span> : <span class="title">NSOperation</span></span></span><br><span class="line"><span class="keyword">@property</span> <span class="keyword">id</span> (<span class="keyword">strong</span>) myData;</span><br><span class="line">-(<span class="keyword">id</span>)initWithData:(<span class="keyword">id</span>)data;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyNonConcurrentOperation</span></span></span><br><span class="line">- (<span class="keyword">id</span>)initWithData:(<span class="keyword">id</span>)data &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init])</span><br><span class="line">      myData = data;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">-(<span class="keyword">void</span>)main &#123;</span><br><span class="line">   <span class="keyword">@try</span> &#123;</span><br><span class="line">      <span class="comment">// Do some work on myData and report the results.</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">@catch</span>(...) &#123;</span><br><span class="line">      <span class="comment">// Do not rethrow exceptions.</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="å“åº”å–æ¶ˆäº‹ä»¶">å“åº”å–æ¶ˆäº‹ä»¶</h3><p>åœ¨æ“ä½œå¯¹è±¡å¼€å§‹æ‰§è¡Œåï¼Œå®ƒè¦ä¹ˆæŒç»­æ‰§è¡Œåˆ°ä»»åŠ¡å®Œæˆï¼Œè¦ä¹ˆè¢«æ˜¾å¼å–æ¶ˆã€‚å–æ¶ˆå¯ä»¥å‘ç”Ÿåœ¨ä»»ä½•æ—¶å€™ï¼Œç”šè‡³åœ¨æ“ä½œå¯¹è±¡å¼€å§‹æ‰§è¡Œä¹‹å‰ã€‚å°½ç®¡ <code>NSOperation</code> ç±»ç»™ç”¨æˆ·æä¾›äº†ä¸€ç§æ–¹å¼æ¥å–æ¶ˆä¸€ä¸ªæ“ä½œå¯¹è±¡ï¼Œä½†æ˜¯å¦è¯†åˆ«å–æ¶ˆäº‹ä»¶æ˜¯è¿˜æ˜¯å¼€å‘è€…å†³å®šçš„ã€‚å¦‚æœä¸€ä¸ªæ“ä½œå¯¹è±¡è¢«é”™è¯¯åœ°åœæ­¢äº†ï¼Œå¯èƒ½å°±æ²¡æœ‰åŠæ³•å›æ”¶å·²ç»åˆ†é…çš„èµ„æºã€‚æ‰€ä»¥ï¼Œæ“ä½œå¯¹è±¡åº”è¯¥åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ£€æŸ¥å–æ¶ˆäº‹ä»¶ï¼Œå¹¶åœ¨æ“ä½œè¿‡ç¨‹ä¸­å‘ç”Ÿå–æ¶ˆäº‹ä»¶æ—¶ä¼˜é›…åœ°é€€å‡ºã€‚</p><p>ä¸ºäº†æ”¯æŒæ“ä½œå¯¹è±¡çš„å–æ¶ˆï¼Œä½ æ‰€è¦åšçš„å°±æ˜¯å®šæœŸä»ä½ çš„è‡ªå®šä¹‰ä»£ç ä¸­è°ƒç”¨å¯¹è±¡çš„<code>isCancelled</code>æ–¹æ³•ï¼Œå¦‚æœå®ƒè¿”å›<code>YES</code>å°±ç«‹å³è¿”å›ã€‚æ— è®ºä½ çš„æ“ä½œæŒç»­æ—¶é—´é•¿çŸ­ï¼Œä¹Ÿæ— è®ºä½ æ˜¯ç›´æ¥å¯¹<code>NSOperation</code>è¿›è¡Œå­ç±»åŒ–è¿˜æ˜¯ä½¿ç”¨å…¶å…·ä½“çš„å­ç±»ï¼Œæ”¯æŒå–æ¶ˆéƒ½å¾ˆé‡è¦ã€‚<code>isCancelled</code>æ–¹æ³•æœ¬èº«æ˜¯éå¸¸è½»é‡çš„ï¼Œå¯ä»¥åœ¨ä¸å½±å“æ€§èƒ½çš„æƒ…å†µä¸‹é¢‘ç¹è°ƒç”¨ã€‚å½“è®¾è®¡ä½ çš„æ“ä½œå¯¹è±¡æ—¶ï¼Œä½ åº”è€ƒè™‘åœ¨ä»£ç ä¸­çš„ä»¥ä¸‹åœ°æ–¹è°ƒç”¨<code>isCancelled</code>æ–¹æ³•ï¼š</p><ul><li>åœ¨æ‰§è¡Œä»»ä½•å®é™…å·¥ä½œå‰ç«‹å³è°ƒç”¨ï¼›</li><li>æ¯æ¬¡å¾ªç¯è¿­ä»£è‡³å°‘è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœå•æ¬¡å¾ªç¯ç¡®å®å¾ˆé•¿çš„è¯ï¼Œå¯ä»¥å¤šæ¬¡æ£€æŸ¥ï¼›</li><li>åœ¨ä»£ç ä¸­ä»»ä½•ä¸€ä¸ªç›¸å¯¹å®¹æ˜“ä¸­æ­¢æ“ä½œçš„åœ°æ–¹ï¼›</li></ul><p>æ¸…å•2-4å±•ç¤ºäº†ä¸€ä¸ªéå¸¸ç®€å•çš„ç¤ºä¾‹ï¼Œè¯´æ˜å¦‚ä½•åœ¨ä¸€ä¸ªæ“ä½œå¯¹è±¡çš„<code>main</code>æ–¹æ³•ä¸­å“åº”å–æ¶ˆäº‹ä»¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯æ¬¡é€šè¿‡<code>while</code>å¾ªç¯è°ƒç”¨<code>isCancelled</code>æ–¹æ³•ï¼Œå…è®¸åœ¨å·¥ä½œå¼€å§‹å‰å¿«é€Ÿé€€å‡ºï¼Œå¹¶ä»¥ä¸€å®šçš„é—´éš”å†æ¬¡é€€å‡ºã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)main &#123;</span><br><span class="line">   <span class="keyword">@try</span> &#123;</span><br><span class="line">      <span class="built_in">BOOL</span> isDone = <span class="literal">NO</span>;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">while</span> (![<span class="keyword">self</span> isCancelled] &amp;&amp; !isDone) &#123;</span><br><span class="line">          <span class="comment">// Do some work and set isDone to YES when finished</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">@catch</span>(...) &#123;</span><br><span class="line">      <span class="comment">// Do not rethrow exceptions.</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°½ç®¡ä¸Šè¿°ä»£ç ä¸­æ²¡æœ‰åŒ…å«æ¸…ç†èµ„æºçš„ä»£ç ï¼Œä½†æ˜¯ä½ è‡ªå·±çš„ä»£ç ä¸­åº”è¯¥æ¸…ç†ä»»ä½•ä½ åˆ†é…çš„èµ„æºã€‚</p><h3 id="ä¸ºå¹¶å‘æ‰§è¡Œé…ç½®æ“ä½œå¯¹è±¡">ä¸ºå¹¶å‘æ‰§è¡Œé…ç½®æ“ä½œå¯¹è±¡</h3><p>æ“ä½œå¯¹è±¡é»˜è®¤ä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬åœ¨è°ƒç”¨å…¶<code>start</code>æ–¹æ³•çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ã€‚å› ä¸ºæ“ä½œé˜Ÿåˆ—ä¸ºéå¹¶å‘æ“ä½œæä¾›äº†çº¿ç¨‹ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œå¤§å¤šæ•°æ“ä½œä»ç„¶ä»¥å¼‚æ­¥æ–¹å¼è¿è¡Œã€‚ç„¶è€Œï¼Œå¦‚æœä½ æ‰“ç®—æ‰‹åŠ¨æ‰§è¡Œæ“ä½œï¼Œå¹¶ä¸”ä»ç„¶å¸Œæœ›å®ƒä»¬å¼‚æ­¥è¿è¡Œï¼Œä½ å°±å¯ä»¥é€šè¿‡æŠŠæ“ä½œå¯¹è±¡å®šä¹‰ä¸ºä¸€ä¸ªå¹¶å‘æ“ä½œæ¥è¾¾åˆ°ç›®çš„ã€‚</p><p>ä¸‹è¡¨åˆ—å‡ºäº†åœ¨å®ç°å¹¶å‘æ“ä½œå¯¹è±¡æ—¶éœ€è¦ override çš„æ–¹æ³•ï¼š</p><table><colgroup><col style="width: 34%" /><col style="width: 65%" /></colgroup><thead><tr class="header"><th>æ–¹æ³•</th><th>æè¿°</th></tr></thead><tbody><tr class="odd"><td><code>start</code></td><td><strong>å¿…é¡»</strong> æ‰€æœ‰çš„å¹¶å‘æ“ä½œéƒ½å¿…é¡»è¦†ç›–è¿™ä¸ªæ–¹æ³•ï¼Œç”¨è‡ªå®šä¹‰å®ç°æ›¿æ¢é»˜è®¤è¡Œä¸ºã€‚è¦æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸ªæ“ä½œï¼Œè¦è°ƒç”¨å…¶<code>start</code>æ–¹æ³•ã€‚å› æ­¤ï¼Œä½ å¯¹è¿™ä¸ªæ–¹æ³•çš„å®ç°æ˜¯ä½ çš„æ“ä½œçš„èµ·ç‚¹ï¼Œæ˜¯ä½ è®¾ç½®çº¿ç¨‹æˆ–å…¶ä»–æ‰§è¡Œç¯å¢ƒæ¥æ‰§è¡Œä½ çš„ä»»åŠ¡çš„åœ°æ–¹ã€‚è‡ªå®šä¹‰å®ç°åœ¨ä»»ä½•æ—¶å€™éƒ½ä¸èƒ½è°ƒç”¨<code>super</code>æ–¹æ³•ã€‚</td></tr><tr class="even"><td><code>main</code></td><td><strong>å¯é€‰</strong> è¿™ä¸ªæ–¹æ³•é€šå¸¸ç”¨äºå®ç°ä¸æ“ä½œå¯¹è±¡ç›¸å…³çš„ä»»åŠ¡ã€‚å°½ç®¡ä½ å¯ä»¥åœ¨<code>start</code>æ–¹æ³•ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä½†ä½¿ç”¨è¿™ä¸ªæ–¹æ³•å®ç°ä»»åŠ¡å¯ä»¥ä½¿ä½ çš„è®¾ç½®å’Œä»»åŠ¡ä»£ç æ›´æ¸…æ™°åœ°åˆ†å¼€ã€‚</td></tr><tr class="odd"><td><code>isExecuting</code> <br> <code>isFinished</code></td><td><strong>å¿…é¡»</strong> å¹¶å‘æ“ä½œè´Ÿè´£è®¾ç½®å…¶æ‰§è¡Œç¯å¢ƒå¹¶å‘å¤–éƒ¨å®¢æˆ·æŠ¥å‘Šè¯¥ç¯å¢ƒçš„çŠ¶æ€ã€‚å› æ­¤ï¼Œä¸€ä¸ªå¹¶å‘æ“ä½œå¿…é¡»ç»´æŠ¤ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œä»¥çŸ¥é“å®ƒä½•æ—¶åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œä½•æ—¶å®Œæˆäº†è¯¥ä»»åŠ¡ã€‚ç„¶åï¼Œå®ƒå¿…é¡»ä½¿ç”¨è¿™äº›æ–¹æ³•æ±‡æŠ¥è¯¥çŠ¶æ€ã€‚<br />å¯¹è¿™äº›æ–¹æ³•çš„å®ç°å¿…é¡»æ˜¯å®‰å…¨çš„ï¼Œå¯ä»¥ä»å…¶ä»–çº¿ç¨‹åŒæ—¶è°ƒç”¨ã€‚å½“æ”¹å˜è¿™äº›æ–¹æ³•æ‰€æ±‡æŠ¥çš„å€¼æ—¶ï¼Œä½ è¿˜å¿…é¡»ä¸ºé¢„æœŸçš„key pathç”Ÿæˆé€‚å½“çš„KVOé€šçŸ¥ã€‚</td></tr><tr class="even"><td><code>isConcurrent</code></td><td><strong>å¿…é¡»</strong> è¦ç¡®å®šæ“ä½œå¯¹è±¡æ˜¯ä¸€ä¸ªå¹¶å‘æ“ä½œï¼Œè¦†ç›–è¿™ä¸ªæ–¹æ³•å¹¶è¿”å›<code>YES</code>ã€‚</td></tr></tbody></table><p>è¿™èŠ‚å‰©ä½™çš„éƒ¨åˆ†å±•ç¤º <code>MyOperation</code> ç±»çš„å®ç°ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å®ç°ä¸€ä¸ªå¹¶å‘æ“ä½œæ‰€éœ€çš„åŸºæœ¬ä»£ç ã€‚ <code>MyOperation</code> åªæ˜¯ç®€å•åœ¨å®ƒåˆ›å»ºçš„çº¿ç¨‹ä¸Šæ‰§è¡Œ <code>main</code> æ–¹æ³•ã€‚<code>main</code> æ–¹æ³•çš„å…·ä½“å†…å®¹åœ¨è¿™é‡Œæ˜¯ä¸ç›¸å…³çš„ã€‚ç¤ºä¾‹çš„æ„ä¹‰åœ¨äºå±•ç¤ºåœ¨å®šä¹‰ä¸€ä¸ªå¹¶å‘æ“ä½œæ—¶éœ€è¦æä¾›çš„åŸºç¡€è®¾æ–½ã€‚</p><p>æ¸…å•2-5æ˜¾ç¤ºäº†<code>MyOperation</code>ç±»çš„æ¥å£å’Œéƒ¨åˆ†å®ç°ã€‚<code>MyOperation</code>ç±»çš„<code>isConcurrent</code>ã€<code>isExecuting</code>å’Œ<code>isFinished</code>æ–¹æ³•çš„å®ç°ç›¸å¯¹ç®€å•ã€‚<code>isConcurrent</code>æ–¹æ³•åº”è¯¥ç®€å•åœ°è¿”å›<code>YES</code>ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¹¶å‘æ“ä½œã€‚<code>isExecuting</code>å’Œ<code>isFinished</code>æ–¹æ³•åªæ˜¯è¿”å›å­˜å‚¨åœ¨ç±»æœ¬èº«çš„å®ä¾‹å˜é‡ä¸­çš„å€¼ã€‚</p><p><strong>æ¸…å•2-5</strong> å®šä¹‰ä¸€ä¸ªå¹¶å‘æ“ä½œé˜Ÿåˆ—</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyOperation</span> : <span class="title">NSOperation</span> </span>&#123;</span><br><span class="line">    <span class="built_in">BOOL</span>        executing;</span><br><span class="line">    <span class="built_in">BOOL</span>        finished;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)completeOperation;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyOperation</span></span></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        executing = <span class="literal">NO</span>;</span><br><span class="line">        finished = <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="built_in">BOOL</span>)isConcurrent &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="built_in">BOOL</span>)isExecuting &#123;</span><br><span class="line">    <span class="keyword">return</span> executing;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="built_in">BOOL</span>)isFinished &#123;</span><br><span class="line">    <span class="keyword">return</span> finished;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>æ¸…å•2-6æ˜¾ç¤ºäº†<code>MyOperation</code>çš„<code>start</code>æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•çš„å®ç°æ˜¯æœ€å°çš„ï¼Œä»¥ä¾¿å±•ç¤ºä½ ç»å¯¹å¿…é¡»æ‰§è¡Œçš„ä»»åŠ¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥æ–¹æ³•åªæ˜¯å¯åŠ¨äº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå¹¶é…ç½®å®ƒæ¥è°ƒç”¨<code>main</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•è¿˜æ›´æ–°äº†<code>executing</code>æˆå‘˜å˜é‡ï¼Œå¹¶ä¸º<code>isExecuting</code> key pathç”ŸæˆKVOé€šçŸ¥ï¼Œä»¥åæ˜ è¯¥å€¼çš„å˜åŒ–ã€‚å®Œæˆå·¥ä½œåï¼Œè¿™ä¸ªæ–¹æ³•å°±ç®€å•åœ°è¿”å›ï¼Œè®©æ–°åˆ†ç¦»çš„çº¿ç¨‹æ¥æ‰§è¡Œå®é™…çš„ä»»åŠ¡ã€‚</p><p><strong>æ¸…å•2-6</strong> <code>start</code>æ–¹æ³•</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)start &#123;</span><br><span class="line">   <span class="comment">// Always check for cancellation before launching the task.</span></span><br><span class="line">   <span class="keyword">if</span> ([<span class="keyword">self</span> isCancelled])</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">// Must move the operation to the finished state if it is canceled.</span></span><br><span class="line">      [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@&quot;isFinished&quot;</span>];</span><br><span class="line">      finished = <span class="literal">YES</span>;</span><br><span class="line">      [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@&quot;isFinished&quot;</span>];</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// If the operation is not canceled, begin executing the task.</span></span><br><span class="line">   [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@&quot;isExecuting&quot;</span>];</span><br><span class="line">   [<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(main) toTarget:<span class="keyword">self</span> withObject:<span class="literal">nil</span>];</span><br><span class="line">   executing = <span class="literal">YES</span>;</span><br><span class="line">   [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@&quot;isExecuting&quot;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¸…å•2-7æ˜¾ç¤ºäº†<code>MyOperation</code>ç±»çš„å…¶ä½™å®ç°ã€‚æ­£å¦‚åœ¨æ¸…å•2-6ä¸­çœ‹åˆ°çš„ï¼Œ<code>main</code>æ–¹æ³•æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹çš„å…¥å£ã€‚å®ƒæ‰§è¡Œä¸æ“ä½œå¯¹è±¡ç›¸å…³çš„å·¥ä½œï¼Œå¹¶åœ¨å·¥ä½œæœ€ç»ˆå®Œæˆæ—¶è°ƒç”¨è‡ªå®šä¹‰çš„<code>completeOperation</code>æ–¹æ³•ã€‚ç„¶å<code>completeOperation</code>æ–¹æ³•ä¸º<code>isExecuting</code>å’Œ<code>isFinished</code> key pathç”Ÿæˆæ‰€éœ€çš„KVOé€šçŸ¥ï¼Œä»¥åæ˜ æ“ä½œçŠ¶æ€çš„å˜åŒ–ã€‚</p><p><strong>æ¸…å•2-7</strong> åœ¨å®Œæˆæ—¶æ›´æ–°æ“ä½œå¯¹è±¡çŠ¶æ€</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)main &#123;</span><br><span class="line">   <span class="keyword">@try</span> &#123;</span><br><span class="line"> </span><br><span class="line">       <span class="comment">// Do the main work of the operation here.</span></span><br><span class="line"> </span><br><span class="line">       [<span class="keyword">self</span> completeOperation];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">@catch</span>(...) &#123;</span><br><span class="line">      <span class="comment">// Do not rethrow exceptions.</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">void</span>)completeOperation &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@&quot;isFinished&quot;</span>];</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@&quot;isExecuting&quot;</span>];</span><br><span class="line"> </span><br><span class="line">    executing = <span class="literal">NO</span>;</span><br><span class="line">    finished = <span class="literal">YES</span>;</span><br><span class="line"> </span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@&quot;isExecuting&quot;</span>];</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@&quot;isFinished&quot;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å³ä½¿ä¸€ä¸ªæ“ä½œè¢«å–æ¶ˆäº†ï¼Œä½ ä¹Ÿåº”å§‹ç»ˆé€šçŸ¥KVOè§‚å¯Ÿè€…ä½ çš„æ“ä½œç°åœ¨å·²ç»å®Œæˆäº†å®ƒçš„å·¥ä½œã€‚å½“ä¸€ä¸ªæ“ä½œå¯¹è±¡ä¾èµ–äºå…¶ä»–æ“ä½œå¯¹è±¡çš„å®Œæˆæ—¶ï¼Œå®ƒå°†ç›‘å¬è¿™äº›å¯¹è±¡çš„<code>isFinished</code> key pathã€‚åªæœ‰å½“æ‰€æœ‰å¯¹è±¡éƒ½æ±‡æŠ¥å·²ç»å®Œæˆæ—¶ï¼Œä¾èµ–çš„æ“ä½œæ‰ä¼šå‘å‡ºä¿¡å·è¯´å®ƒå·²ç»å‡†å¤‡å¥½è¿è¡Œã€‚å› æ­¤ï¼Œæœªèƒ½ç”Ÿæˆä¸€ä¸ªå®Œæˆé€šçŸ¥å¯èƒ½ä¼šé˜»æ­¢ç¨‹åºä¸­å…¶ä»–æ“ä½œå¯¹è±¡çš„æ‰§è¡Œã€‚</p><h3 id="ç»´æŠ¤kvo">ç»´æŠ¤KVO</h3><p><code>NSOperation</code> ç±»å¯¹ä»¥ä¸‹ key path æ˜¯ KVO çš„ï¼š</p><ul><li><code>isCancelled</code></li><li><code>isConcurrent</code></li><li><code>isExecuting</code></li><li><code>isFinished</code></li><li><code>isReady</code></li><li><code>dependencies</code></li><li><code>queuePriority</code></li><li><code>completionBlock</code></li></ul><p>å¦‚æœä½ è¦†ç›–äº† <code>start</code> æ–¹æ³•æˆ–å¤§å¹…åº¦çš„è‡ªå®šä¹‰ä¸€ä¸ª <code>NSOperation</code> å¯¹è±¡ï¼Œè€Œä¸æ˜¯è¦†ç›– <code>main</code> æ–¹æ³•ï¼Œä½ éœ€ç¡®ä¿è‡ªå®šä¹‰å¯¹è±¡ä»ç„¶ä¿æŒç€è¿™äº› key path çš„ KVO å…¼å®¹æ€§ã€‚å½“ä½ è¦†ç›– <code>start</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä½ åº”è¯¥å…³å¿ƒçš„ key path æ˜¯ <code>isExecuting</code> å’Œ <code>isFinished</code>ã€‚è¿™äº› key paths æ˜¯é‡å†™ <code>start</code> æ–¹æ³•æœ€å¸¸å½±å“åˆ°çš„ã€‚</p><p>å¦‚æœä½ æƒ³å®ç°å¯¹å…¶ä»–æ“ä½œå¯¹è±¡ä»¥å¤–çš„ä¾èµ–å…³ç³»çš„æ”¯æŒï¼Œä½ ä¹Ÿå¯ä»¥è¦†ç›–<code>isReady</code>æ–¹æ³•å¹¶å¼ºåˆ¶å®ƒè¿”å›<code>NO</code>ç›´åˆ°ä½ çš„è‡ªå®šä¹‰ä¾èµ–å…³ç³»å¾—åˆ°æ»¡è¶³ã€‚ï¼ˆå¦‚æœä½ å®ç°äº†è‡ªå®šä¹‰çš„ä¾èµ–å…³ç³»ï¼Œå¦‚æœä½ ä»ç„¶æ”¯æŒç”±<code>NSOperation</code>ç±»æä¾›çš„é»˜è®¤ä¾èµ–å…³ç³»ç®¡ç†ç³»ç»Ÿï¼Œç¡®ä¿ä»<code>isReady</code>æ–¹æ³•ä¸­è°ƒç”¨<code>super</code>ï¼‰ã€‚å½“æ“ä½œå¯¹è±¡çš„å‡†å¤‡çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸º<code>isReady</code> key pathç”ŸæˆKVOé€šçŸ¥ä»¥æŠ¥å‘Šè¿™äº›å˜åŒ–ã€‚é™¤éä½ è¦†ç›–äº†<code>addDependency:</code>æˆ–<code>removeDependency:</code>æ–¹æ³•ï¼Œå¦åˆ™ä½ ä¸éœ€è¦æ‹…å¿ƒä¸º<code>dependencies</code>å…³é”®è·¯å¾„äº§ç”ŸKVOé€šçŸ¥ã€‚</p><p>å°½ç®¡ä½ å¯ä»¥ä¸º<code>NSOperation</code>çš„å…¶ä»–key pathç”ŸæˆKVOé€šçŸ¥ï¼Œä½†ä½ ä¸å¤ªå¯èƒ½éœ€è¦è¿™æ ·åšã€‚å¦‚æœä½ éœ€è¦å–æ¶ˆä¸€ä¸ªæ“ä½œï¼Œä½ å¯ä»¥ç®€å•åœ°è°ƒç”¨ç°æœ‰çš„<code>cancel</code>æ–¹æ³•æ¥å®Œæˆã€‚åŒæ ·åœ°ï¼Œä½ åº”è¯¥å¾ˆå°‘éœ€è¦ä¿®æ”¹æ“ä½œå¯¹è±¡ä¸­çš„é˜Ÿåˆ—ä¼˜å…ˆçº§ä¿¡æ¯ã€‚æœ€åï¼Œé™¤éä½ çš„æ“ä½œèƒ½å¤ŸåŠ¨æ€åœ°æ”¹å˜å…¶å¹¶å‘çŠ¶æ€ï¼Œå¦åˆ™ä½ ä¸éœ€è¦ä¸º<code>isConcurrent</code> key pathæä¾›KVOé€šçŸ¥ã€‚</p><h2 id="è‡ªå®šä¹‰æ“ä½œå¯¹è±¡æ‰§è¡Œè¡Œä¸º">è‡ªå®šä¹‰æ“ä½œå¯¹è±¡æ‰§è¡Œè¡Œä¸º</h2><p>æ“ä½œå¯¹è±¡çš„é…ç½®å‘ç”Ÿåœ¨åˆ›å»ºä¹‹åï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹å‰ã€‚æœ¬èŠ‚æè¿°çš„é…ç½®ç±»å‹å¯ç”¨äºæ‰€æœ‰çš„æ“ä½œå¯¹è±¡ï¼Œæ— è®ºæ˜¯å¯¹<code>NSOperation</code>è¿›è¡Œå­ç±»åŒ–è¿˜æ˜¯ä½¿ç”¨ç°æœ‰çš„<code>NSOperation</code>å­ç±»ã€‚</p><h3 id="é…ç½®äº¤äº’ä¾èµ–">é…ç½®äº¤äº’ä¾èµ–</h3><p>ä¾èµ–å¯ä»¥ä¸²è¡Œä¸åŒæ“ä½œå¯¹è±¡ã€‚ä¾èµ–å…¶ä»–æ“ä½œå¯¹è±¡çš„æ“ä½œå¯¹è±¡åœ¨å…¶ä»–æ“ä½œå¯¹è±¡å®Œæˆä¹‹å‰ä¸èƒ½å¼€å§‹æ‰§è¡Œã€‚å› æ­¤ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¾èµ–åœ¨ä¸¤ä¸ªæ“ä½œå¯¹è±¡ä¹‹é—´å»ºç«‹ç®€å•çš„ä¸€å¯¹ä¸€çš„ä¾èµ–å…³ç³»ï¼Œæˆ–è€…å»ºç«‹å¤æ‚çš„å¯¹è±¡ä¾èµ–å…³ç³»å›¾ã€‚</p><p>ä½¿ç”¨<code>NSOperation</code>çš„<code>addDependency:</code>æ–¹æ³•å¯ä»¥åˆ›å»ºä¾èµ–å…³ç³»ã€‚è¿™ä¸ªæ–¹æ³•åˆ›å»ºå•å‘çš„ä¾èµ–å…³ç³»ï¼Œå½“å‰æ“ä½œå¯¹è±¡ä¾èµ–äºå‚æ•°ç»™å®šçš„æ“ä½œå¯¹è±¡ã€‚ä¾èµ–ä¸é™äºåŒä¸€ä¸ªé˜Ÿåˆ—çš„æ“ä½œå¯¹è±¡ã€‚æ“ä½œå¯¹è±¡ç®¡ç†ç€å®ƒä»¬è‡ªå·±çš„ä¾èµ–ï¼Œæ‰€ä»¥å®ƒä¸å—é˜Ÿåˆ—å±€é™ï¼Œä½†ä¸èƒ½åˆ›å»ºåœ¨æ“ä½œä¹‹é—´åˆ›å»ºå¾ªç¯ä¾èµ–å…³ç³»ã€‚è¿™æ˜¯ä¸€ä¸ªå¼€å‘è€…çš„é”™è¯¯ï¼Œä¼šå¯¼è‡´å—å½±å“çš„æ“ä½œæ°¸è¿œæ— æ³•æ‰§è¡Œã€‚</p><p>å½“ä¸€ä¸ªæ“ä½œå¯¹è±¡çš„æ‰€æœ‰ä¾èµ–éƒ½ç»“æŸæ‰§è¡Œæ—¶ï¼Œé€šå¸¸è¯¥æ“ä½œå˜æˆå‡†å¤‡æ‰§è¡Œä¸­çŠ¶æ€ã€‚ï¼ˆå¦‚æœä½ è‡ªå®šä¹‰äº† <code>isReady</code> æ–¹æ³•çš„è¯ï¼Œæ“ä½œå¯¹è±¡çš„å°±ç»ªçŠ¶æ€å°±ç”±ä½ è‡ªå®šä¹‰è¡Œä¸ºå†³å®šäº†ï¼‰ã€‚å¦‚æœæ“ä½œå¯¹è±¡åœ¨é˜Ÿåˆ—ä¸­ï¼Œé˜Ÿåˆ—å¯èƒ½éšæ—¶å¯åŠ¨æ‰§è¡Œå…¶ä¸­çš„æ“ä½œå¯¹è±¡ã€‚å¦åˆ™å¦‚æœä½ æƒ³æ‰‹åŠ¨æ‰§è¡Œè¯¥æ“ä½œï¼Œåˆ™ç”±ä½ æ¥è°ƒç”¨è¯¥æ“ä½œçš„<code>start</code>æ–¹æ³•ã€‚</p><p><strong>é‡è¦æé†’ï¼š</strong>ä½ åº”æ€»æ˜¯åœ¨è¿è¡Œæ“ä½œå¯¹è±¡æˆ–å°†å…¶æ·»åŠ åˆ°æ“ä½œé˜Ÿåˆ—ä¹‹å‰é…ç½®ä¾èµ–å…³ç³»ã€‚åœ¨è¿™ä¹‹åæ·»åŠ çš„ä¾èµ–å…³ç³»å¯èƒ½ä¸ä¼šé˜»æ­¢æŸä¸ªæ“ä½œå¯¹è±¡çš„è¿è¡Œã€‚</p><p>ä¾èµ–æœºåˆ¶ä¾èµ–äºæ¯ä¸ªæ“ä½œå¯¹è±¡åœ¨å¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å‘é€é€‚å½“çš„KVOé€šçŸ¥ã€‚å¦‚æœä½ è‡ªå®šä¹‰äº†æ“ä½œå¯¹è±¡çš„è¡Œä¸ºï¼Œä½ å¯èƒ½éœ€è¦ä»ä½ è‡ªå®šä¹‰ä»£ç ä¸­ç”Ÿæˆé€‚å½“çš„KVOé€šçŸ¥ï¼Œä»¥é¿å…å¼•èµ·ä¾èµ–å…³ç³»çš„é—®é¢˜ã€‚å…³äºKVOé€šçŸ¥å’Œæ“ä½œå¯¹è±¡çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="#ç»´æŠ¤KVO">ç»´æŠ¤KVO</a>ã€‚å…³äºé…ç½®ä¾èµ–å…³ç³»çš„å…¶ä»–ä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/documentation/foundation/nsoperation">NSOperation Class Reference</a>ã€‚</p><h3 id="ä¿®æ”¹æ“ä½œå¯¹è±¡æ‰§è¡Œçš„ä¼˜å…ˆçº§">ä¿®æ”¹æ“ä½œå¯¹è±¡æ‰§è¡Œçš„ä¼˜å…ˆçº§</h3><p>å¯¹äºæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„æ“ä½œå¯¹è±¡ï¼Œæ‰§è¡Œé¡ºåºé¦–å…ˆç”±é˜Ÿåˆ—ä¸­çš„æ“ä½œçš„å‡†å¤‡çŠ¶æ€å†³å®šï¼Œç„¶åç”±å…¶ç›¸å¯¹ä¼˜å…ˆçº§å†³å®šã€‚å‡†å¤‡çŠ¶æ€ç”±ä¸€ä¸ªæ“ä½œå¯¹è±¡å¯¹å…¶ä»–æ“ä½œå¯¹è±¡çš„ä¾èµ–å†³å®šï¼Œä½†ä¼˜å…ˆçº§æ˜¯æ“ä½œå¯¹è±¡æœ¬èº«çš„ä¸€ä¸ªå±æ€§ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ–°çš„æ“ä½œå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªnormalçš„ä¼˜å…ˆçº§ï¼Œä½ å¯ä»¥è°ƒç”¨æ“ä½œå¯¹è±¡çš„<code>setQueuePriority:</code>æ–¹æ³•æ¥å¢åŠ æˆ–å‡å°‘ä¼˜å…ˆçº§ã€‚</p><p>ä¼˜å…ˆçº§åªé€‚ç”¨äºåŒä¸€æ“ä½œé˜Ÿåˆ—ä¸­çš„æ“ä½œæ“ä½œå¯¹è±¡ã€‚å¦‚æœç¨‹åºæœ‰å¤šä¸ªæ“ä½œé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—éƒ½ä¼šç‹¬ç«‹äºå…¶ä»–é˜Ÿåˆ—æ¥ç¡®å®šè‡ªå·±æ“ä½œçš„ä¼˜å…ˆçº§ã€‚å› æ­¤ï¼Œä½ä¼˜å…ˆçº§çš„æ“ä½œä»æœ‰å¯èƒ½åœ¨ä¸åŒé˜Ÿåˆ—çš„é«˜ä¼˜å…ˆçº§æ“ä½œä¹‹å‰æ‰§è¡Œã€‚</p><p>ä¼˜å…ˆçº§ä¸èƒ½æ›¿ä»£ä¾èµ–å…³ç³»ã€‚ä¼˜å…ˆçº§åªæ˜¯å†³å®šäº†æ“ä½œé˜Ÿåˆ—ä¸­çš„é‚£äº›å¤„äºå°±ç»ªçŠ¶æ€çš„æ“ä½œå¯¹è±¡çš„æ‰§è¡Œé¡ºåºã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªé˜Ÿåˆ—åŒæ—¶åŒ…å«é«˜ä¼˜å…ˆçº§å’Œä½ä¼˜å…ˆçº§çš„æ“ä½œï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªæ“ä½œéƒ½å°±ç»ªäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªé˜Ÿåˆ—ä¼šå…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§çš„æ“ä½œã€‚ä½†æ˜¯ï¼Œå¦‚æœé«˜ä¼˜å…ˆçº§çš„æ“ä½œå¯¹è±¡è¿˜æ²¡å°±ç»ªï¼Œè€Œä½ä¼˜å…ˆçº§çš„æ“ä½œå¯¹è±¡å·²ç»å°±ç»ªäº†ï¼Œé‚£ä¹ˆé˜Ÿåˆ—å°±ä¼šå…ˆæ‰§è¡Œä½ä¼˜å…ˆçº§çš„æ“ä½œå¯¹è±¡ã€‚å¦‚æœä½ æƒ³é˜»æ­¢ä¸€ä¸ªæ“ä½œåœ¨å¦ä¸€ä¸ªæ“ä½œå®Œæˆä¹‹å‰å¼€å§‹ï¼Œä½ å¿…é¡»ä½¿ç”¨ä¾èµ–å®ç°ã€‚</p><h3 id="ä¿®æ”¹åº•å±‚çº¿ç¨‹çš„ä¼˜å…ˆçº§">ä¿®æ”¹åº•å±‚çº¿ç¨‹çš„ä¼˜å…ˆçº§</h3><p>åœ¨OS X v10.6åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥é…ç½®æ“ä½œå¯¹è±¡çš„åº•å±‚çº¿ç¨‹çš„æ‰§è¡Œä¼˜å…ˆçº§ã€‚ç³»ç»Ÿä¸­çš„çº¿ç¨‹ç­–ç•¥æœ¬èº«ç”±å†…æ ¸ç®¡ç†ï¼Œä½†ä¸€èˆ¬æ¥è¯´ï¼Œé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æ¯”ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹æœ‰æ›´å¤šæœºä¼šè¿è¡Œã€‚åœ¨ä¸€ä¸ªæ“ä½œå¯¹è±¡ä¸­ï¼Œå¯ä»¥æŠŠçº¿ç¨‹ä¼˜å…ˆçº§è®¾ç½®ä¸º0.0åˆ°1.0èŒƒå›´å†…çš„æµ®ç‚¹å€¼ï¼Œ0.0ä¸ºæœ€ä½ä¼˜å…ˆçº§ï¼Œ1.0ä¸ºæœ€é«˜ä¼˜å…ˆçº§ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ä¸€ä¸ªæ˜ç¡®çš„çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œæ“ä½œå¯¹è±¡å°†ä»¥é»˜è®¤çš„çº¿ç¨‹ä¼˜å…ˆçº§0.5è¿è¡Œã€‚</p><p>è¦è®¾ç½®æ“ä½œå¯¹è±¡çš„çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œå¿…é¡»åœ¨æ“ä½œå¯¹è±¡æ·»åŠ åˆ°é˜Ÿåˆ—ï¼ˆæˆ–æ‰‹åŠ¨æ‰§è¡Œï¼‰ä¹‹å‰è°ƒç”¨æ“ä½œå¯¹è±¡çš„<code>setThreadPriority:</code>æ–¹æ³•ã€‚å½“æ‰§è¡Œæ“ä½œçš„æ—¶å€™ï¼Œé»˜è®¤çš„<code>start</code>æ–¹æ³•ä½¿ç”¨ä½ æŒ‡å®šçš„å€¼æ¥ä¿®æ”¹å½“å‰çº¿ç¨‹çš„ä¼˜å…ˆçº§ã€‚è¿™ä¸ªæ–°çš„ä¼˜å…ˆçº§åªåœ¨æ“ä½œå¯¹è±¡çš„<code>main</code>æ–¹æ³•æœŸé—´ä¿æŒæœ‰æ•ˆã€‚æ‰€æœ‰å…¶ä»–ä»£ç ï¼ˆåŒ…æ‹¬æ“ä½œå¯¹è±¡çš„å®Œæˆblockï¼‰éƒ½ä»¥é»˜è®¤çš„çº¿ç¨‹ä¼˜å…ˆçº§è¿è¡Œã€‚å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªå¹¶å‘çš„æ“ä½œå¯¹è±¡ï¼Œå¹¶å› æ­¤è¦†ç›–äº†<code>start</code>æ–¹æ³•ï¼Œä½ å¿…é¡»è‡ªå·±é…ç½®çº¿ç¨‹ä¼˜å…ˆçº§ã€‚</p><h3 id="è®¾ç½®å®Œæˆblock">è®¾ç½®å®ŒæˆBlock</h3><p>åœ¨OS X v10.6å’Œæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œå½“ä¸€ä¸ªæ“ä½œå¯¹è±¡çš„ä¸»ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œå¯ä»¥æ‰§è¡Œä¸€ä¸ªå®Œæˆblockã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå®Œæˆblockæ¥æ‰§è¡Œä»»ä½•ä½ è®¤ä¸ºä¸å±äºä¸»ä»»åŠ¡çš„å·¥ä½œã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªblockæ¥é€šçŸ¥æ„Ÿå…´è¶£çš„å¯¹è±¡ï¼Œæ“ä½œå¯¹è±¡æœ¬èº«å·²ç»å®Œæˆã€‚ä¸€ä¸ªå¹¶å‘çš„æ“ä½œå¯¹è±¡å¯èƒ½ä¼šä½¿ç”¨è¿™ä¸ªblockæ¥ç”Ÿæˆå…¶æœ€ç»ˆçš„KVOé€šçŸ¥ã€‚</p><p>è¦è®¾ç½®å®Œæˆblockï¼Œä½¿ç”¨<code>NSOperation</code>çš„<code>setCompletionBlock:</code>æ–¹æ³•ã€‚è¯¥blockæ²¡æœ‰å‚æ•°ä¹Ÿæ²¡æœ‰è¿”å›å€¼ã€‚</p><h2 id="å®ç°æ“ä½œå¯¹è±¡çš„æŠ€å·§">å®ç°æ“ä½œå¯¹è±¡çš„æŠ€å·§</h2><p>å°½ç®¡æ“ä½œå¯¹è±¡çš„å®ç°ç›¸å½“å®¹æ˜“ï¼Œä½†åœ¨ç¼–å†™ä»£ç æ—¶ï¼Œæœ‰å‡ ä»¶äº‹ä½ åº”è¯¥æ³¨æ„ã€‚ä¸‹é¢å‡ èŠ‚æè¿°äº†åœ¨ç¼–å†™æ“ä½œå¯¹è±¡çš„ä»£ç æ—¶åº”è¯¥è€ƒè™‘çš„ä¸€äº›å› ç´ ã€‚</p><h3 id="åœ¨æ“ä½œå¯¹è±¡ä¸­ç®¡ç†å†…å­˜">åœ¨æ“ä½œå¯¹è±¡ä¸­ç®¡ç†å†…å­˜</h3><p>ä¸‹é¢çš„ç« èŠ‚æè¿°äº†æ“ä½œå¯¹è±¡ä¸­å†…å­˜ç®¡ç†çš„å…³é”®ã€‚å…³äºObjective-Cç¨‹åºä¸­å†…å­˜ç®¡ç†çš„ä¸€èˆ¬ä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/MemoryMgmt.html#//apple_ref/doc/uid/10000011i">Advanced Memory Management Programming Guide</a>ã€‚</p><h4 id="é¿å…æŒ‰çº¿ç¨‹å­˜å‚¨">é¿å…æŒ‰çº¿ç¨‹å­˜å‚¨</h4><p>å°½ç®¡å¤§å¤šæ•°æ“å¯¹è±¡ä½œæ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œçš„ï¼Œä½†åœ¨éå¹¶å‘æ“ä½œå¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªçº¿ç¨‹é€šå¸¸æ˜¯ç”±ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—æä¾›çš„ã€‚å¦‚æœä¸€ä¸ªæ“ä½œé˜Ÿåˆ—ä¸ºä½ æä¾›äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œä½ åº”è¯¥è®¤ä¸ºè¿™ä¸ªçº¿ç¨‹æ˜¯ç”±é˜Ÿåˆ—æ‰€æŒæœ‰çš„ï¼Œè€Œä¸ä¼šè¢«ä½ çš„æ“ä½œå¯¹è±¡æ‰€è®¿é—®ã€‚å…·ä½“æ¥è¯´ï¼Œä½ ä¸åº”è¯¥å°†ä»»ä½•æ•°æ®ä¸éè‡ªå·±åˆ›å»ºæˆ–ç®¡ç†çš„çº¿ç¨‹è”ç³»èµ·æ¥ã€‚ç”±æ“ä½œé˜Ÿåˆ—ç®¡ç†çš„çº¿ç¨‹ä¼šæ ¹æ®ç³»ç»Ÿå’Œç¨‹åºçš„éœ€è¦è€Œåˆ›å»ºå’Œé”€æ¯ã€‚å› æ­¤ï¼Œä½¿ç”¨æŒ‰çº¿ç¨‹å­˜å‚¨åœ¨æ“ä½œä¹‹é—´ä¼ é€’æ•°æ®æ˜¯ä¸å¯é çš„ï¼Œå¾ˆå¯èƒ½ä¼šå¤±è´¥ã€‚</p><p>å°±æ“ä½œå¯¹è±¡è€Œè¨€ï¼Œæ— è®ºåœ¨ä»€ä¹ˆæƒ…å†µä¸‹éƒ½ä¸åº”ä½¿ç”¨æŒ‰çº¿ç¨‹å­˜å‚¨ã€‚å½“åˆå§‹åŒ–ä¸€ä¸ªæ“ä½œå¯¹è±¡æ—¶ï¼Œä½ åº”è¯¥ä¸ºè¯¥å¯¹è±¡æä¾›å®ƒæ‰€éœ€è¦çš„ä¸€åˆ‡æ¥å®Œæˆå…¶å·¥ä½œã€‚å› æ­¤ï¼Œæ“ä½œå¯¹è±¡æœ¬èº«æä¾›äº†ä½ éœ€è¦çš„ä¸Šä¸‹æ–‡å­˜å‚¨ã€‚æ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºçš„æ•°æ®éƒ½åº”è¯¥å­˜å‚¨åœ¨æ“ä½œå¯¹è±¡ä¸­ï¼Œç›´åˆ°å®ƒå¯ä»¥è¢«æ•´åˆå›ç¨‹åºæˆ–ä¸å†éœ€è¦çš„æ—¶å€™ã€‚</p><h4 id="æ ¹æ®éœ€è¦æŒæœ‰æ“ä½œå¯¹è±¡">æ ¹æ®éœ€è¦æŒæœ‰æ“ä½œå¯¹è±¡</h4><p>ä»…ä»…å› ä¸ºæ“ä½œå¯¹è±¡æ˜¯å¼‚æ­¥è¿è¡Œçš„ï¼Œä½ ä¸è¯¥åªæ˜¯ç®€å•åœ°å®Œæˆå®ƒçš„åˆ›å»ºã€‚å®ƒä»¬ä»åªæ˜¯ä¸ªå¯¹è±¡ï¼Œä½ åº”ç®¡ç†å¥½å®ƒçš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä½ éœ€è¦åœ¨ä¸€ä¸ªæ“ä½œå®Œæˆåæ£€ç´¢ç»“æœæ•°æ®ï¼Œä¿æŒå¯¹æ“ä½œå¯¹è±¡çš„å¼•ç”¨å°¤å…¶é‡è¦ã€‚</p><p>ä½ åº”è¯¥å§‹ç»ˆä¿æŒå¯¹æ“ä½œçš„å¼•ç”¨ï¼ŒåŸå› æ˜¯ä½ ä»¥åå¯èƒ½æ²¡æœ‰æœºä¼šä»é˜Ÿåˆ—è·å–åˆ°è¯¥å¯¹è±¡ã€‚é˜Ÿåˆ—ä¼šå°½ä¸€åˆ‡åŠªåŠ›å°½å¯èƒ½å¿«åœ°è°ƒåº¦å’Œæ‰§è¡Œæ“ä½œã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œé˜Ÿåˆ—åœ¨æ·»åŠ æ“ä½œå¯¹è±¡åå‡ ä¹ç«‹å³å¼€å§‹æ‰§è¡Œæ“ä½œã€‚å½“ä½ è‡ªå·±çš„ä»£ç å›åˆ°é˜Ÿåˆ—ä¸­è·å–å¯¹æ“ä½œå¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œè¯¥æ“ä½œå¯èƒ½å·²ç»å®Œæˆå¹¶ä»é˜Ÿåˆ—ä¸­ç§»é™¤äº†ã€‚</p><h3 id="å¤„ç†é”™è¯¯å’Œå¼‚å¸¸">å¤„ç†é”™è¯¯å’Œå¼‚å¸¸</h3><p>å› ä¸ºæ“ä½œå¯¹è±¡æœ¬è´¨ä¸Šæ˜¯ç¨‹åºä¸­çš„ç¦»æ•£å®ä½“ï¼Œå®ƒä»¬è´Ÿè´£å¤„ç†ä»»ä½•å‡ºç°çš„é”™è¯¯æˆ–å¼‚å¸¸ã€‚åœ¨OS X v10.6åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œ<code>NSOperation</code>ç±»æä¾›çš„é»˜è®¤<code>start</code>æ–¹æ³•å¹¶ä¸æ•æ‰å¼‚å¸¸ã€‚ï¼ˆåœ¨OS X v10.5ä¸­ï¼Œstartæ–¹æ³•å¯ä»¥æ•æ‰å’ŒæŠ‘åˆ¶å¼‚å¸¸ã€‚ï¼‰ä»£ç åº”è¯¥ç›´æ¥æ•æ‰å’ŒæŠ‘åˆ¶å¼‚å¸¸ã€‚å®ƒè¿˜åº”è¯¥æ£€æŸ¥é”™è¯¯ä»£ç ï¼Œå¹¶æ ¹æ®éœ€è¦é€šçŸ¥åˆ°ç¨‹åºä¸­åˆé€‚çš„åœ°æ–¹ã€‚å¦‚æœæ›¿æ¢äº†<code>start</code>æ–¹æ³•ï¼Œä½ å¿…é¡»åœ¨è‡ªå®šä¹‰å®ç°ä¸­æ•æ‰ä»»ä½•å¼‚å¸¸ï¼Œä»¥é˜²æ­¢å®ƒä»¬ç¦»å¼€åº•å±‚çº¿ç¨‹çš„ä½œç”¨åŸŸã€‚</p><p>ä½ åº”è¯¥å¤„ç†ä»¥ä¸‹ç±»å‹çš„é”™è¯¯ï¼š</p><ul><li>æ£€æŸ¥å’Œå¤„ç†UNIX <code>errno</code>å½¢å¼çš„error codeã€‚</li><li>æ£€æŸ¥ç”±æ–¹æ³•å’Œå‡½æ•°è¿”å›çš„æ˜¾å¼error codeã€‚</li><li>æ•è·ç”±è‡ªå·±çš„ä»£ç æˆ–å…¶ä»–ç³»ç»Ÿæ¡†æ¶æŠ›å‡ºçš„å¼‚å¸¸ã€‚</li><li>æ•æ‰ç”±<code>NSOperation</code>ç±»æœ¬èº«æŠ›å‡ºçš„å¼‚å¸¸ï¼Œåœ¨ä»¥ä¸‹æƒ…å†µä¸‹å®ƒä¼šæŠ›å‡ºå¼‚å¸¸ï¼š<ul><li>å½“æ“ä½œå¯¹è±¡è¿˜æ²¡æœ‰å°±ç»ªæ‰§è¡Œï¼Œä½†å®ƒçš„<code>start</code>æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼›</li><li>å½“æ“ä½œå¯¹è±¡æ­£åœ¨æ‰§è¡Œæˆ–å®Œæˆæ—¶ï¼ˆå¯èƒ½æ˜¯å› ä¸ºå®ƒè¢«å–æ¶ˆäº†ï¼‰ï¼Œè€Œå®ƒçš„<code>start</code>æ–¹æ³•è¢«å†æ¬¡è°ƒç”¨æ—¶ï¼›</li><li>å½“ä½ è¯•å›¾ç»™ä¸€ä¸ªå·²ç»æ‰§è¡Œæˆ–å®Œæˆçš„æ“ä½œå¯¹è±¡æ·»åŠ ä¸€ä¸ªå®Œæˆblockæ—¶ï¼›</li><li>å½“ä½ è¯•å›¾æ£€ç´¢ä¸€ä¸ªè¢«å–æ¶ˆçš„<code>NSInvocationOperation</code>å¯¹è±¡çš„ç»“æœæ—¶ï¼›</li></ul></li></ul><p>å¦‚æœè‡ªå®šä¹‰ä»£ç ç¡®å®é‡åˆ°äº†å¼‚å¸¸æˆ–é”™è¯¯ï¼Œä½ åº”è¯¥é‡‡å–ä»»ä½•å¿…è¦çš„æ­¥éª¤å°†è¯¥é”™è¯¯ä¼ æ’­åˆ°ç¨‹åºçš„å…¶ä»–ä½ç½®ã€‚<code>NSOperation</code>ç±»æ²¡æœ‰æä¾›æ˜ç¡®çš„æ–¹æ³•æ¥å®ç°è¿™éƒ¨åˆ†å·¥ä½œã€‚å› æ­¤ï¼Œå¦‚æœè¿™äº›ä¿¡æ¯å¯¹ç¨‹åºå¾ˆé‡è¦ï¼Œä½ å¿…é¡»æä¾›å¿…è¦çš„ä»£ç ã€‚</p><h2 id="ä¸ºæ“ä½œå¯¹è±¡ç¡®å®šåˆé€‚çš„èŒƒå›´">ä¸ºæ“ä½œå¯¹è±¡ç¡®å®šåˆé€‚çš„èŒƒå›´</h2><p>å°½ç®¡å­˜åœ¨åœ¨ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—ä¸­æ·»åŠ ä»»æ„å¤šæ“ä½œçš„å¯èƒ½ï¼Œä½†è¿™æ ·åšå¾€å¾€æ˜¯ä¸åˆ‡å®é™…çš„ã€‚åƒä»»ä½•å¯¹è±¡ä¸€æ ·ï¼Œ<code>NSOperation</code>ç±»çš„å®ä¾‹ä¼šæ¶ˆè€—å†…å­˜ï¼Œæ‰§è¡Œä¹Ÿæœ‰ç›¸åº”çš„å¼€é”€ã€‚å¦‚æœæ¯ä¸ªæ“ä½œå¯¹è±¡åªåšå°‘é‡çš„å·¥ä½œï¼Œè€Œä½ åˆ›å»ºäº†æ•°ä»¥ä¸‡è®¡çš„æ“ä½œå¯¹è±¡ï¼Œä½ å¯èƒ½ä¼šå‘ç°èŠ±åœ¨è°ƒåº¦æ“ä½œå¯¹è±¡ä¸Šçš„æ—¶é—´æ¯”åšçœŸæ­£çš„æ“ä½œä»»åŠ¡è¦å¤šã€‚å¦‚æœç¨‹åºå·²ç»å—åˆ°äº†å†…å­˜çš„é™åˆ¶ï¼Œä½ å¯èƒ½ä¼šå‘ç°ï¼Œä»…ä»…åœ¨å†…å­˜ä¸­æ‹¥æœ‰æˆåƒä¸Šä¸‡çš„æ“ä½œå¯¹è±¡å¯èƒ½ä¼šè¿›ä¸€æ­¥é™ä½æ€§èƒ½ã€‚</p><p>æœ‰æ•ˆä½¿ç”¨æ“ä½œå¯¹è±¡çš„å…³é”®æ˜¯åœ¨ä½ éœ€è¦åœ¨å…·ä½“æ“ä½œä»»åŠ¡å’Œä¿æŒè®¡ç®—æœºæŒç»­å·¥ä½œä¹‹é—´æ‰¾åˆ°ä¸€ä¸ªé€‚å½“çš„å¹³è¡¡ç‚¹ã€‚å°½é‡ç¡®ä¿æ“ä½œå¯¹è±¡å®Œæˆåˆç†çš„å·¥ä½œé‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç¨‹åºåˆ›å»ºäº†100ä¸ªæ“ä½œå¯¹è±¡æ¥å¯¹100ä¸ªä¸åŒçš„å€¼æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ï¼Œå¯ä»¥è€ƒè™‘æ”¹æˆåˆ›å»º10ä¸ªæ“ä½œå¯¹è±¡ï¼Œæ¯ä¸ªæ“ä½œå¯¹è±¡å¤„ç†10ä¸ªå€¼ã€‚</p><p>ä½ è¿˜åº”é¿å…ä¸€æ¬¡å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¤§é‡çš„æ“ä½œå¯¹è±¡ï¼Œæˆ–è€…é¿å…å‘é˜Ÿåˆ—ä¸­æ·»åŠ æ“ä½œå¯¹è±¡çš„é€Ÿåº¦è¶…è¿‡å®ƒä»¬çš„å¤„ç†é€Ÿåº¦ã€‚ä¸å…¶ä¸€æ¬¡æ€§æ·»åŠ å¤§é‡çš„æ“ä½œå¯¹è±¡ï¼Œä¸å¦‚åˆ†æ‰¹åˆ›å»ºè¿™äº›å¯¹è±¡ã€‚å½“ä¸€ä¸ªæ‰¹æ¬¡æ‰§è¡Œå®Œæ¯•åï¼Œä½¿ç”¨ä¸€ä¸ªå®Œæˆblockæ¥å‘Šè¯‰ç¨‹åºåˆ›å»ºä¸€ä¸ªæ–°çš„æ‰¹æ¬¡ã€‚è¿™ç§æ–¹æ¡ˆé€‚ç”¨äºç”±å¤§é‡çš„ä»»åŠ¡è¦è¿›è¡Œï¼Œæƒ³è®©é˜Ÿåˆ—å¡«å……è¶³å¤Ÿå¤šçš„æ“ä½œå¯¹è±¡ï¼Œæ¥è®©è®¡ç®—æœºæŒç»­æ‰§è¡Œçš„æƒ…å†µã€‚ä¸€æ¬¡æ€§åˆ›å»ºå¤§é‡çš„æ“ä½œå¯¹è±¡ï¼Œè®©ç›´æ¥è®©ç¨‹åºè€—å°½å†…å­˜ã€‚</p><p>å½“ç„¶ï¼Œåˆ›å»ºæ“ä½œå¯¹è±¡çš„æ•°é‡ï¼Œä»¥åŠä½ åœ¨æ¯ä¸ªæ“ä½œä¸­æ‰§è¡Œçš„å·¥ä½œé‡æ˜¯å¯å˜çš„ï¼Œå®Œå…¨å–å†³äºä½ çš„ç¨‹åºã€‚ä½ åº”è¯¥æ€»æ˜¯ä½¿ç”¨è¯¸å¦‚Instrumentsè¿™æ ·çš„å·¥å…·æ¥å¸®åŠ©ä½ åœ¨æ•ˆç‡å’Œé€Ÿåº¦ä¹‹é—´æ‰¾åˆ°ä¸€ä¸ªé€‚å½“çš„å¹³è¡¡ç‚¹ã€‚å…³äºInstrumentså’Œå…¶ä»–æ€§èƒ½å·¥å…·çš„æ¦‚è¿°ï¼Œå¯ä»¥ç”¨æ¥ä¸ºä½ çš„ä»£ç æ”¶é›†æŒ‡æ ‡ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/PerformanceOverview/Introduction/Introduction.html#//apple_ref/doc/uid/TP40001410">Performance Overview</a>ã€‚</p><h2 id="æ‰§è¡Œæ“ä½œå¯¹è±¡">æ‰§è¡Œæ“ä½œå¯¹è±¡</h2><p>æœ€ç»ˆï¼Œä½ çš„åº”ç”¨ç¨‹åºéœ€è¦æ‰§è¡Œæ“ä½œå¯¹è±¡ï¼Œä»¥å®Œæˆç›¸å…³çš„å·¥ä½œã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œå°†å­¦ä¹ å‡ ç§æ‰§è¡Œæ“ä½œå¯¹è±¡çš„æ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•åœ¨è¿è¡Œæ—¶æ§åˆ¶æ“ä½œå¯¹è±¡çš„æ‰§è¡Œè¡Œä¸ºã€‚</p><h3 id="æ·»åŠ æ“ä½œå¯¹è±¡åˆ°æ“ä½œé˜Ÿåˆ—ä¸­">æ·»åŠ æ“ä½œå¯¹è±¡åˆ°æ“ä½œé˜Ÿåˆ—ä¸­</h3><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰§è¡Œæ“ä½œå¯¹è±¡çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—ï¼Œå®ƒæ˜¯<code>NSOperationQueue</code>ç±»çš„å®ä¾‹ã€‚ç¨‹åºè´Ÿè´£åˆ›å»ºå’Œç»´æŠ¤ä½¿ç”¨çš„ä»»ä½•æ“ä½œé˜Ÿåˆ—ã€‚ç¨‹åºå¯ä»¥æœ‰ä»»ä½•æ•°é‡çš„é˜Ÿåˆ—ï¼Œä½†åœ¨ä¸€ä¸ªç»™å®šçš„æ—¶é—´ç‚¹ä¸Šæ“ä½œå¯¹è±¡å¯ä»¥æ‰§è¡Œçš„æ•°é‡æ˜¯æœ‰å®é™…é™åˆ¶çš„ã€‚æ“ä½œé˜Ÿåˆ—ä¸ç³»ç»Ÿé…åˆå·¥ä½œï¼Œå°†å¹¶å‘æ“ä½œçš„æ•°é‡é™åˆ¶åœ¨ä¸€ä¸ªé€‚åˆå¯ç”¨å†…æ ¸å’Œç³»ç»Ÿè´Ÿè½½çš„æ•°å€¼ä¸Šã€‚å› æ­¤ï¼Œåˆ›å»ºæ›´å¤šçš„é˜Ÿåˆ—å¹¶ä¸æ„å‘³ç€ä½ å¯ä»¥æ‰§è¡Œæ›´å¤šçš„æ“ä½œå¯¹è±¡ã€‚</p><p>åˆ›å»ºé˜Ÿåˆ—è·Ÿåˆ›å»ºå…¶ä»–çš„å¯¹è±¡æ˜¯ä¸€æ ·çš„ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSOperationQueue</span>* aQueue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br></pre></td></tr></table></figure><p>è¦å‘é˜Ÿåˆ—æ·»åŠ æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨<code>addOperation:</code>æ–¹æ³•ã€‚åœ¨OS X v10.6åŠæ›´é«˜çš„ç‰ˆæœ¬ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>addOperations:waitUntilFinished:</code>æ–¹æ³•æ·»åŠ æ“ä½œç»„ï¼Œæˆ–è€…ä½¿ç”¨<code>addOperationWithBlock:</code>æ–¹æ³•ç›´æ¥å‘é˜Ÿåˆ—æ·»åŠ blockå¯¹è±¡ï¼ˆä¸ä¼šæœ‰ç›¸åº”çš„æ“ä½œå¯¹è±¡ï¼‰ã€‚è¿™äº›æ–¹æ³•éƒ½æ˜¯æ’é˜Ÿä¸€ä¸ªæˆ–å¤šä¸ªæ“ä½œå¯¹è±¡ï¼Œå¹¶é€šçŸ¥é˜Ÿåˆ—åº”è¯¥å¼€å§‹å¤„ç†è¿™äº›æ“ä½œå¯¹è±¡ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ“ä½œå¯¹è±¡åœ¨è¢«æ·»åŠ åˆ°é˜Ÿåˆ—åä¸ä¹…å°±ä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯æ“ä½œé˜Ÿåˆ—å¯èƒ½ä¼šå› ä¸ºä¸€äº›åŸå› è€Œå»¶è¿Ÿæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œå¦‚æœæ’é˜Ÿçš„æ“ä½œå¯¹è±¡ä¾èµ–äºå…¶ä»–å°šæœªå®Œæˆçš„æ“ä½œï¼Œæ‰§è¡Œå¯èƒ½ä¼šè¢«å»¶è¿Ÿã€‚å¦‚æœæ“ä½œé˜Ÿåˆ—æœ¬èº«è¢«æš‚åœæˆ–å·²ç»åœ¨æ‰§è¡Œå…¶æœ€å¤§æ•°é‡çš„å¹¶å‘æ“ä½œï¼Œæ‰§è¡Œä¹Ÿå¯èƒ½è¢«å»¶è¿Ÿã€‚ä¸‹é¢çš„ä¾‹å­æ˜¾ç¤ºäº†å‘é˜Ÿåˆ—æ·»åŠ æ“ä½œå¯¹è±¡çš„åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[aQueue addOperation:anOp]; <span class="comment">// Add a single operation</span></span><br><span class="line">[aQueue addOperations:anArrayOfOps waitUntilFinished:<span class="literal">NO</span>]; <span class="comment">// Add multiple operations</span></span><br><span class="line">[aQueue addOperationWithBlock:^&#123;</span><br><span class="line">   <span class="comment">/* Do something. */</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><p><strong>é‡è¦æé†’ï¼š</strong>åœ¨å°†æ“ä½œå¯¹è±¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹å‰ï¼Œä½ åº”è¯¥å¯¹å…¶å®Œæˆæ‰€æœ‰å¿…è¦çš„é…ç½®å’Œä¿®æ”¹ï¼Œå› ä¸ºä¸€æ—¦æ·»åŠ ï¼Œæ“ä½œå¯¹è±¡å¯èƒ½ä¼šåœ¨ä»»ä½•æ—¶å€™è¢«è¿è¡Œï¼Œè¿™å¯èƒ½ä¼šè®©ä¿®æ”¹çš„æ—¶é—´å¤ªæ™šï¼Œæ— æ³•äº§ç”Ÿé¢„æœŸçš„æ•ˆæœã€‚</p><p>è™½ç„¶<code>NSOperationQueue</code>ç±»æ˜¯ä¸ºæ“ä½œå¯¹è±¡çš„å¹¶å‘æ‰§è¡Œè€Œè®¾è®¡çš„ï¼Œä½†ä¹Ÿå¯ä»¥å¼ºåˆ¶é˜Ÿåˆ—ä¸€æ¬¡åªè¿è¡Œä¸€ä¸ªæ“ä½œã€‚<code>setMaxConcurrentOperationCount:</code>æ–¹æ³•å¯ä»¥è®©ä½ é…ç½®æ“ä½œé˜Ÿåˆ—å¯¹è±¡çš„æœ€å¤§å¹¶å‘æ“ä½œå¯¹è±¡æ•°ã€‚ç»™è¿™ä¸ªæ–¹æ³•ä¼ é€’1ï¼Œä¼šä½¿é˜Ÿåˆ—ä¸€æ¬¡åªæ‰§è¡Œä¸€ä¸ªæ“ä½œã€‚è™½ç„¶ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªæ“ä½œå¯¹è±¡ï¼Œä½†æ‰§è¡Œçš„é¡ºåºä»ç„¶æ˜¯åŸºäºå…¶ä»–å› ç´ ï¼Œæ¯”å¦‚æ¯ä¸ªæ“ä½œå¯¹è±¡çš„å°±ç»ªçŠ¶æ€å’Œåˆ†é…çš„ä¼˜å…ˆçº§ã€‚å› æ­¤ï¼Œä¸€ä¸ªä¸²è¡Œçš„æ“ä½œé˜Ÿåˆ—æ‰€æä¾›çš„è¡Œä¸ºä¸Grand Central Dispatchä¸­çš„ä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—ä¸å®Œå…¨ç›¸åŒã€‚å¦‚æœæ“ä½œå¯¹è±¡çš„æ‰§è¡Œé¡ºåºå¯¹ä½ å¾ˆé‡è¦ï¼Œä½ åº”è¯¥åœ¨æŠŠæ“ä½œå¯¹è±¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹å‰ï¼Œä½¿ç”¨ä¾èµ–æ¥å»ºç«‹è¿™ä¸ªé¡ºåºã€‚å…³äºé…ç½®ä¾èµ–å…³ç³»çš„ä¿¡æ¯ï¼Œå¯å‚é˜…<a href="#é…ç½®äº¤äº’ä¾èµ–">é…ç½®äº¤äº’ä¾èµ–</a>ã€‚</p><p>å…³äºä½¿ç”¨æ“ä½œé˜Ÿåˆ—çš„ä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/documentation/foundation/nsoperationqueue">NSOperationQueue Class Reference</a>ã€‚å…³äºä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW6">Creating Serial Dispatch Queues</a>ã€‚</p><h3 id="æ‰‹åŠ¨æ‰§è¡Œæ“ä½œå¯¹è±¡">æ‰‹åŠ¨æ‰§è¡Œæ“ä½œå¯¹è±¡</h3><p>è™½ç„¶æ“ä½œé˜Ÿåˆ—æ˜¯è¿è¡Œæ“ä½œå¯¹è±¡çš„æœ€æ–¹ä¾¿çš„æ–¹å¼ï¼Œä½†ä¹Ÿå¯ä»¥ä¸é€šè¿‡é˜Ÿåˆ—æ¥æ‰§è¡Œæ“ä½œå¯¹è±¡ã€‚ç„¶è€Œï¼Œå¦‚æœä½ é€‰æ‹©æ‰‹åŠ¨æ‰§è¡Œæ“ä½œï¼Œä½ åº”è¯¥åœ¨ä½ çš„ä»£ç ä¸­é‡‡å–ä¸€äº›é¢„é˜²æªæ–½ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ“ä½œå¿…é¡»å‡†å¤‡å¥½è¿è¡Œï¼Œä½ å¿…é¡»å§‹ç»ˆä½¿ç”¨å®ƒçš„<code>start</code>æ–¹æ³•æ¥å¯åŠ¨å®ƒã€‚</p><p>ä¸€ä¸ªæ“ä½œåœ¨å®ƒçš„<code>isReady</code>æ–¹æ³•è¿”å›<code>YES</code>æ—¶æ‰è¢«è®¤ä¸ºèƒ½å¤Ÿè¿è¡Œã€‚<code>isReady</code>æ–¹æ³•è¢«é›†æˆåˆ°<code>NSOperation</code>ç±»çš„ä¾èµ–ç®¡ç†ç³»ç»Ÿä¸­ï¼Œä»¥æä¾›æ“ä½œçš„ä¾èµ–å…³ç³»çš„çŠ¶æ€ã€‚åªæœ‰å½“å®ƒçš„ä¾èµ–å…³ç³»è¢«æ¸…é™¤åï¼Œä¸€ä¸ªæ“ä½œæ‰å¯ä»¥è‡ªç”±åœ°å¼€å§‹æ‰§è¡Œã€‚</p><p>å½“æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸ªæ“ä½œæ—¶ï¼Œä½ åº”è¯¥æ€»æ˜¯ä½¿ç”¨<code>start</code>æ–¹æ³•æ¥å¼€å§‹æ‰§è¡Œã€‚è€Œä¸æ˜¯<code>main</code>æˆ–å…¶ä»–æ–¹æ³•ï¼Œå› ä¸º<code>start</code>æ–¹æ³•åœ¨å®é™…è¿è¡Œè‡ªå®šä¹‰ä»£ç ä¹‹å‰ä¼šæ‰§è¡Œä¸€äº›å®‰å…¨æ£€æŸ¥ã€‚ç‰¹åˆ«æ˜¯ï¼Œé»˜è®¤çš„<code>start</code>æ–¹æ³•ä¼šç”Ÿæˆæ“å¯¹è±¡ä½œæ‰€éœ€çš„KVOé€šçŸ¥ï¼Œä»¥æ­£ç¡®å¤„ç†å…¶ä¾èµ–å…³ç³»ã€‚å¦‚æœæ“ä½œå¯¹è±¡å·²ç»è¢«å–æ¶ˆäº†ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿä¼šæ­£ç¡®åœ°é¿å…æ‰§è¡Œä½ çš„æ“ä½œï¼Œå¦‚æœæ“ä½œå¯¹è±¡å®é™…ä¸Šæ²¡æœ‰å°±ç»ªè¿è¡Œï¼Œåˆ™ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚</p><p>å¦‚æœä½ çš„ç¨‹åºå®šä¹‰äº†å¹¶å‘çš„æ“ä½œå¯¹è±¡ï¼Œä½ ä¹Ÿåº”è¯¥è€ƒè™‘åœ¨å¯åŠ¨æ“ä½œå¯¹è±¡ä¹‹å‰è°ƒç”¨æ“ä½œçš„<code>isConcurrent</code>æ–¹æ³•ã€‚åœ¨è¯¥æ–¹æ³•è¿”å›<code>NO</code>çš„æƒ…å†µä¸‹ï¼Œæœ¬åœ°ä»£ç å¯ä»¥å†³å®šæ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œæ“ä½œè¿˜æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ã€‚ç„¶è€Œï¼Œå®ç°è¿™ç§æ£€æŸ¥å®Œå…¨ç”±ä½ å†³å®šã€‚</p><p>æ¸…å•2-8æ˜¾ç¤ºäº†ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œä»¥è¯´æ˜æ‰‹åŠ¨æ‰§è¡Œæ“ä½œä¹‹å‰åº”è¯¥è¿›è¡Œä»€ä¹ˆæ ·çš„æ£€æŸ¥ã€‚å¦‚æœè¯¥æ–¹æ³•è¿”å›<code>NO</code>ï¼Œä½ å¯ä»¥å®‰æ’ä¸€ä¸ªå®šæ—¶å™¨å¹¶åœ¨ç¨åå†æ¬¡è°ƒç”¨è¯¥æ–¹æ³•ã€‚ç„¶åä½ ä¼šä¸æ–­åœ°é‡æ–°å®‰æ’å®šæ—¶å™¨ï¼Œç›´åˆ°æ–¹æ³•è¿”å›<code>YES</code>ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºæ“ä½œè¢«å–æ¶ˆäº†ã€‚</p><p><strong>æ¸…å•2-8</strong> æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸ªæ“ä½œå¯¹è±¡</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)performOperation:(<span class="built_in">NSOperation</span>*)anOp</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">BOOL</span>        ranIt = <span class="literal">NO</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">if</span> ([anOp isReady] &amp;&amp; ![anOp isCancelled])</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">if</span> (![anOp isConcurrent])</span><br><span class="line">         [anOp start];</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">         [<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(start)</span><br><span class="line">                   toTarget:anOp withObject:<span class="literal">nil</span>];</span><br><span class="line">      ranIt = <span class="literal">YES</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> ([anOp isCancelled])</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">// If it was canceled before it was started,</span></span><br><span class="line">      <span class="comment">//  move the operation to the finished state.</span></span><br><span class="line">      [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@&quot;isFinished&quot;</span>];</span><br><span class="line">      [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@&quot;isExecuting&quot;</span>];</span><br><span class="line">      executing = <span class="literal">NO</span>;</span><br><span class="line">      finished = <span class="literal">YES</span>;</span><br><span class="line">      [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@&quot;isExecuting&quot;</span>];</span><br><span class="line">      [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@&quot;isFinished&quot;</span>];</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Set ranIt to YES to prevent the operation from</span></span><br><span class="line">      <span class="comment">// being passed to this method again in the future.</span></span><br><span class="line">      ranIt = <span class="literal">YES</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> ranIt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å–æ¶ˆæ“ä½œå¯¹è±¡">å–æ¶ˆæ“ä½œå¯¹è±¡</h3><p>ä¸€æ—¦è¢«æ·»åŠ åˆ°ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—ä¸­ï¼Œæ“ä½œå¯¹è±¡å°±æœ‰æ•ˆåœ°è¢«é˜Ÿåˆ—æ‰€æ‹¥æœ‰ï¼Œå¹¶ä¸”ä¸èƒ½è¢«ç§»é™¤ã€‚å–æ¶ˆä¸€ä¸ªæ“ä½œå¯¹è±¡çš„å”¯ä¸€æ–¹æ³•æ˜¯å–æ¶ˆå®ƒã€‚ä½ å¯ä»¥é€šè¿‡è°ƒç”¨ä¸€ä¸ªå•ç‹¬çš„æ“ä½œå¯¹è±¡çš„<code>cancel</code>æ–¹æ³•æ¥å–æ¶ˆå®ƒï¼Œæˆ–è€…é€šè¿‡è°ƒç”¨é˜Ÿåˆ—å¯¹è±¡çš„<code>cancelAllOperations</code>æ–¹æ³•æ¥å–æ¶ˆé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ“ä½œå¯¹è±¡ã€‚</p><p>åªæœ‰å½“ä½ ç¡®å®šä¸å†éœ€è¦è¿™äº›æ“ä½œå¯¹è±¡æ—¶ï¼Œæ‰å–æ¶ˆå®ƒä»¬ã€‚å‘å‡ºå–æ¶ˆå‘½ä»¤ä¼šä½¿æ“ä½œå¯¹è±¡è¿›å…¥canceledçŠ¶æ€ï¼Œè¿™å°†ä½¿å®ƒæ°¸è¿œæ— æ³•è¿è¡Œã€‚å› ä¸ºä¸€ä¸ªè¢«å–æ¶ˆçš„æ“ä½œä»ç„¶è¢«è®¤ä¸ºæ˜¯finishedçš„ï¼Œä¾èµ–äºå®ƒçš„å¯¹è±¡ä¼šæ”¶åˆ°é€‚å½“çš„KVOé€šçŸ¥æ¥æ¸…é™¤è¿™ç§ä¾èµ–å…³ç³»ã€‚å› æ­¤ï¼Œæ›´å¸¸è§çš„æƒ…å†µæ˜¯ï¼Œåœ¨æŸäº›é‡è¦äº‹ä»¶ä¸­å–æ¶ˆæ‰€æœ‰æ’é˜Ÿçš„æ“ä½œå¯¹è±¡ï¼Œæ¯”å¦‚ç¨‹åºé€€å‡ºæˆ–ç”¨æˆ·ç‰¹åˆ«è¦æ±‚å–æ¶ˆï¼Œè€Œä¸æ˜¯é€‰æ‹©æ€§åœ°å–æ¶ˆæŸä¸ªæ“ä½œå¯¹è±¡ã€‚</p><h3 id="ç­‰å¾…æ“ä½œå¯¹è±¡å®Œæˆ">ç­‰å¾…æ“ä½œå¯¹è±¡å®Œæˆ</h3><p>ä¸ºäº†è·å¾—æœ€ä½³æ€§èƒ½ï¼Œä½ åº”è¯¥æŠŠæ“ä½œå¯¹è±¡è®¾è®¡æˆå°½å¯èƒ½çš„å¼‚æ­¥ï¼Œè®©ç¨‹åºåœ¨æ“ä½œå¯¹è±¡æ‰§è¡Œæ—¶å¯ä»¥è‡ªç”±åœ°åšå…¶ä»–å·¥ä½œã€‚å¦‚æœåˆ›å»ºä¸€ä¸ªæ“ä½œå¯¹è±¡çš„ä»£ç ä¹Ÿå¤„ç†è¯¥å¯¹è±¡çš„ç»“æœï¼Œä½ å¯ä»¥ä½¿ç”¨<code>NSOperation</code>çš„<code>waitUntilFinished</code>æ–¹æ³•æ¥é˜»å¡ä»£ç ï¼Œç›´åˆ°æ“ä½œå®Œæˆã€‚ä¸è¿‡ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œæœ€å¥½é¿å…è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚é˜»å¡å½“å‰çº¿ç¨‹å¯èƒ½æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„è§£å†³æ–¹æ¡ˆï¼Œä½†å®ƒç»™ä½ çš„ä»£ç å¼•å…¥äº†æ›´å¤šçš„ä¸²è¡Œï¼Œå¹¶é™åˆ¶äº†æ•´ä½“çš„å¹¶å‘æ°´å¹³ã€‚</p><p><strong>é‡è¦æé†’ï¼š</strong>ä½ ä¸åº”è¯¥åœ¨ç¨‹åºçš„ä¸»çº¿ç¨‹ä¸­ç­‰å¾…ä¸€ä¸ªæ“ä½œã€‚ä½ åªåº”è¯¥ä»å­çº¿ç¨‹æˆ–å…¶ä»–æ“ä½œå¯¹è±¡ä¸­è¿›è¡Œç­‰å¾…ã€‚é˜»å¡ä½ çš„ä¸»çº¿ç¨‹ä¼šé˜»æ­¢ç¨‹åºå¯¹ç”¨æˆ·äº‹ä»¶åšå‡ºå“åº”ï¼Œå¹¶å¯èƒ½ä½¿ç¨‹åºçœ‹èµ·æ¥æ²¡æœ‰ååº”ã€‚</p><p>é™¤äº†ç­‰å¾…å•ä¸ªæ“ä½œå®Œæˆï¼Œä½ è¿˜å¯ä»¥é€šè¿‡è°ƒç”¨<code>NSOperationQueue</code>çš„<code>waitUntilAllOperationsAreFinished</code>æ–¹æ³•æ¥ç­‰å¾…ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ“ä½œå¯¹è±¡çš„å®Œæˆã€‚å½“ç­‰å¾…æ•´ä¸ªé˜Ÿåˆ—å®Œæˆæ—¶ï¼Œè¦æ³¨æ„ç¨‹åºçš„å…¶ä»–çº¿ç¨‹ä»ç„¶å¯ä»¥å‘é˜Ÿåˆ—æ·»åŠ æ“ä½œï¼Œä½†å› æ­¤ä¹Ÿä¼šå»¶é•¿ç­‰å¾…æ—¶é—´ã€‚</p><h3 id="æš‚åœå’Œæ¢å¤é˜Ÿåˆ—">æš‚åœå’Œæ¢å¤é˜Ÿåˆ—</h3><p>å¦‚æœè¦æš‚åœæ“ä½œå¯¹è±¡çš„æ‰§è¡Œï¼Œä½ å¯ä»¥ä½¿ç”¨<code>setSuspended:</code>æ–¹æ³•æš‚åœç›¸åº”çš„æ“ä½œé˜Ÿåˆ—ã€‚æš‚åœä¸€ä¸ªé˜Ÿåˆ—å¹¶ä¸ä¼šå¯¼è‡´å·²ç»æ‰§è¡Œçš„æ“ä½œå¯¹è±¡åœ¨å…¶ä»»åŠ¡ä¸­æš‚åœã€‚å®ƒåªæ˜¯é˜»æ­¢é˜Ÿåˆ—å®‰æ’æ–°çš„æ“ä½œå¯¹è±¡æ‰§è¡Œã€‚ä½ å¯ä»¥æš‚åœä¸€ä¸ªé˜Ÿåˆ—ï¼Œä»¥å“åº”ç”¨æˆ·çš„è¯·æ±‚ï¼Œæš‚åœä»»ä½•æ­£åœ¨è¿›è¡Œçš„å·¥ä½œï¼Œå› ä¸ºé¢„æœŸç”¨æˆ·æœ€ç»ˆå¯èƒ½æƒ³è¦æ¢å¤è¯¥å¯¹é˜Ÿåˆ—å·¥ä½œã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><ul><li>NSBlockOperationå¯ä»¥æ·»åŠ å¤šä¸ªblockï¼Œè¯¥æ“ä½œå¯¹è±¡ä½¿ç”¨ç»„çš„è¯­ä¹‰è¿›è¡Œæ“ä½œï¼Œåªæœ‰å½“ç›¸å…³çš„blockéƒ½æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæ“ä½œå¯¹è±¡æœ¬èº«æ‰ç®—å®Œæˆã€‚</li><li>å¯¹äºå•ä¸ªblockä¸­çš„ä»£ç æ¥è¯´ï¼Œå…¶æ‰§è¡Œéƒ½æ˜¯åŒæ­¥çš„ã€‚</li><li>æ“ä½œå¯¹è±¡çš„ä»»åŠ¡è¦è‡ªè¡Œå¤„ç†å¼‚å¸¸ã€‚</li><li>æ“ä½œå¯¹è±¡çš„é…ç½®å‘ç”Ÿåœ¨åˆ›å»ºä¹‹åï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹å‰ã€‚</li><li>è‹¥è¦ä¿æŒå¯¹æ“ä½œå¯¹è±¡çš„æ£€ç´¢ï¼Œæœ€å¥½è‡ªå·±æ·»åŠ å¯¹æ“ä½œå¯¹è±¡çš„å¼•ç”¨ã€‚</li><li>è¦æ‰‹åŠ¨æ‰§è¡Œæ“ä½œå¯¹è±¡ï¼Œåˆ™æ‰§è¡Œ<code>start</code>æ–¹æ³•ã€‚</li><li>å–æ¶ˆå¾€å¾€ç”¨äºå¯¹é˜Ÿåˆ—çš„è¡Œä¸ºï¼Œè€Œéä¸ªåˆ«æ“ä½œå¯¹è±¡ã€‚</li></ul><p>ä½¿ç”¨æŠ€å·§ï¼š</p><ul><li>åº”åªåœ¨éœ€è¦å•ç‹¬å¼‚æ­¥æ‰§è¡Œæ“ä½œå¯¹è±¡ä½†åˆä¸æ·»åŠ åˆ°æ“ä½œé˜Ÿåˆ—çš„æƒ…å†µä¸‹æ‰å®šä¹‰å¹¶å‘æ“ä½œå¯¹è±¡ã€‚</li><li>æ“ä½œå¯¹è±¡çš„æ‰§è¡Œé¡ºåºä¸»è¦æ˜¯åŸºäºä¾èµ–å»ºç«‹çš„ã€‚ä¸å»ºè®®é€šè¿‡ä¼˜å…ˆçº§æ”¹å˜æ“ä½œå¯¹è±¡æ‰§è¡Œé¡ºåºã€‚</li><li>æ“ä½œé˜Ÿåˆ—å¯ä»¥é€šè¿‡<code>setMaxConcurrentOperationCount:</code>æ–¹æ³•è®¾ç½®å¹¶å‘æ•°é‡ï¼Œå³ä½¿è®¾ç½®ä¸º1ï¼Œå…¶è¡Œä¸ºä¹Ÿä¸ä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—ä¸å®Œå…¨ä¸€è‡´ã€‚ä¾‹å¦‚ï¼Œç»æµ‹è¯•ï¼Œæ“ä½œé˜Ÿåˆ—å³ä½¿å¹¶å‘é™åˆ¶ä¸º1ï¼Œå•æ¯æ¬¡ä½¿ç”¨çš„çº¿ç¨‹å¯èƒ½ä¸åŒã€‚</li><li>æ“ä½œå¯¹è±¡çš„å®Œæˆblockæ‰§è¡Œçš„è¯­ä¹‰åº”æ˜¯ä¸å±äºä¸»ä»»åŠ¡çš„å·¥ä½œã€‚</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Cocoaæ“ä½œå¯¹è±¡æ˜¯ä¸€ç§ä»¥é¢å‘å¯¹è±¡çš„æ–¹å¼æ¥å°ä½ éœ€è¦å¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡ã€‚æ“ä½œå¯¹è±¡è¢«è®¾è®¡æˆè·Ÿæ“ä½œé˜Ÿåˆ—é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨ï¼Œæˆ–è€…å•ç‹¬ä½¿ç”¨ã€‚å› ä¸ºæ˜¯åŸºäºObjective-Cå®ç°çš„ï¼Œæ“ä½œå¯¹è±¡å¯åŒæ—¶åœ¨ OS X å’Œ iOS ä¸­ä½¿ç”¨ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Concurrency Programming Guide" scheme="https://bqlin.github.io/tags/Concurrency-Programming-Guide/"/>
    
    <category term="å¤šçº¿ç¨‹" scheme="https://bqlin.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Concurrency Programming Guideï¼šå¹¶å‘ä¸ç¨‹åºè®¾è®¡</title>
    <link href="https://bqlin.github.io/posts/concurrency_pg_concurrency_and_application_design/"/>
    <id>https://bqlin.github.io/posts/concurrency_pg_concurrency_and_application_design/</id>
    <published>2021-09-08T09:40:58.000Z</published>
    <updated>2021-10-24T04:12:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>è®¡ç®—æœºçš„æ—©æœŸï¼Œå•ä½æ—¶é—´å†…å®ƒå¯ä»¥åšçš„å·¥ä½œæ˜¯ç”± CPU çš„æ—¶é’Ÿé€Ÿåº¦å†³å®šçš„ã€‚ä½†éšç€æŠ€æœ¯çš„è¿›æ­¥ï¼Œå¤„ç†å™¨çš„è®¾è®¡å˜å¾—æ›´åŠ ç´§å‡‘ï¼Œçƒ­é‡å’Œå…¶ä»–ç‰©ç†é™åˆ¶å¼€å§‹é™åˆ¶å¤„ç†å™¨çš„æœ€å¤§æ—¶é’Ÿé€Ÿåº¦ã€‚äºæ˜¯ï¼ŒèŠ¯ç‰‡åˆ¶é€ å•†å¯»æ‰¾å…¶ä»–æ–¹æ³•æ¥æé«˜å…¶èŠ¯ç‰‡çš„æ€»æ€§èƒ½ã€‚ä»–ä»¬æœ€ç»ˆé€‰æ‹©çš„è§£å†³æ–¹æ¡ˆæ˜¯å¢åŠ æ¯ä¸ªèŠ¯ç‰‡ä¸Šçš„å¤„ç†å™¨å†…æ ¸æ•°é‡ã€‚é€šè¿‡å¢åŠ å†…æ ¸æ•°é‡ï¼Œå•ä¸ªèŠ¯ç‰‡å¯ä»¥åœ¨ä¸å¢åŠ CPUé€Ÿåº¦æˆ–æ”¹å˜èŠ¯ç‰‡å°ºå¯¸æˆ–çƒ­ç‰¹æ€§çš„æƒ…å†µä¸‹æ¯ç§’æ‰§è¡Œæ›´å¤šæŒ‡ä»¤ã€‚å”¯ä¸€çš„é—®é¢˜æ˜¯å¦‚ä½•åˆ©ç”¨è¿™äº›é¢å¤–çš„å†…æ ¸ã€‚</p><span id="more"></span><p>ä¸ºäº†åˆ©ç”¨å¤šæ ¸ï¼Œè®¡ç®—æœºéœ€è¦è½¯ä»¶èƒ½å¤ŸåŒæ—¶åšå¤šä»¶äº‹ã€‚å¯¹äºåƒ OS X æˆ– iOS è¿™æ ·çš„ç°ä»£æ“ä½œç³»ç»Ÿï¼ŒåŒæ—¶èƒ½æœ‰ä¸Šç™¾ä¸ªç¨‹åºåœ¨è·‘ï¼Œåœ¨ä¸åŒçš„æ ¸è°ƒåº¦æ˜¯å¯èƒ½çš„ã€‚ä½†æ˜¯äº†ï¼Œå¤§éƒ¨åˆ†ç¨‹åºæ˜¯ç³»ç»Ÿå®ˆæŠ¤ç¨‹åºï¼ˆsystem daemonsï¼‰æˆ–åå°ç¨‹åºï¼Œè¿™äº›ç¨‹åºæ¶ˆè€—å¾ˆå°‘çš„èµ„æºã€‚ç„¶è€Œå¯¹äºæ¯ä¸ªç¨‹åºæ¥è¯´ï¼ŒçœŸæ­£éœ€è¦çš„æ˜¯å¦‚ä½•æ›´æœ‰æ•ˆçš„ä½¿ç”¨å¤šä½™çš„æ ¸ã€‚</p><p>ä¼ ç»Ÿçš„ä½¿ç”¨å¤šæ ¸çš„æ–¹å¼æ˜¯åˆ›å»ºå¤šä¸ªçº¿ç¨‹ã€‚ç„¶è€Œéšç€æ ¸æ•°ç›®çš„æé«˜ï¼Œçº¿ç¨‹æ–¹æ¡ˆæœ‰å…¶è‡ªèº«çš„é—®é¢˜ã€‚æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œçº¿ç¨‹ä»£ç ä¸èƒ½å¾ˆå¥½åœ°æ‰©å±•åˆ°ä»»æ„æ•°é‡çš„å†…æ ¸ã€‚ä½ ä¸èƒ½åˆ›å»ºä¸æ ¸å¿ƒç­‰é‡çš„çº¿ç¨‹ï¼Œç„¶åæœŸæœ›ç¨‹åºè·‘å¾—å¾ˆå¥½ã€‚ç¨‹åºè‡ªèº«å»è®¡ç®—ä½¿ç”¨å¤šå°‘æ ¸å¿ƒæ˜¯å¾ˆé«˜æ•ˆçš„æœ¬èº«æ˜¯ä¸€ä»¶å¾ˆæœ‰æŒ‘æˆ˜çš„äº‹ã€‚å³ä½¿çŸ¥é“äº†æ•°ç›®ï¼Œç»™è¿™ä¹ˆå¤šçº¿ç¨‹ç¼–å†™ä»£ç ä¹Ÿæ˜¯å¾ˆæœ‰æŒ‘æˆ˜çš„ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œç¨‹åºéœ€è¦ä¸€ç§æ–¹å¼æ¥åˆ©ç”¨å¯å˜çš„æ ¸å¿ƒã€‚ä¸€ä¸ªç¨‹åºè¿›è¡Œçš„å·¥ä½œä¹Ÿéœ€è¦æ ¹æ®å˜åŒ–çš„ç³»ç»Ÿæƒ…å†µæ¥è‡ªåŠ¨ä¼¸ç¼©ã€‚æ–¹ä¾¿å¿…é¡»è¶³å¤Ÿç®€å•ï¼Œä¸å¢åŠ åˆ©ç”¨è¿™äº›æ ¸å¿ƒåšå·¥ä½œçš„æ€»é‡ã€‚Apple çš„æ“ä½œç³»ç»Ÿæä¾›äº†è¿™æ ·çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™ç« å°†ä¼šè®²è®²æ„æˆè¯¥æ–¹æ¡ˆçš„æŠ€æœ¯ï¼Œä»¥åŠä¸€äº›ä½ å¯ä»¥ä½¿ç”¨çš„è®¾è®¡è°ƒæ•´ã€‚</p><h2 id="è¿œç¦»çº¿ç¨‹">è¿œç¦»çº¿ç¨‹</h2><p>å°½ç®¡çº¿ç¨‹å·²ç»å­˜åœ¨å¤šå¹´ï¼Œä¹Ÿè¿˜æœ‰äººåœ¨ç”¨ï¼Œä½†æ˜¯å®ƒä»¬æ²¡æœ‰è§£å†³å¯ä¼¸ç¼©æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„æ™®éé—®é¢˜ã€‚ä½¿ç”¨çº¿ç¨‹çš„è¯ï¼Œå®ç°å¯ä¼¸ç¼©æ–¹æ¡ˆçš„è´Ÿæ‹…è½åœ¨äº†å¼€å‘è€…è‡ªèº«ä¸Šã€‚ä½ å¿…é¡»å†³å®šä½¿ç”¨å¤šå°‘ä¸ªçº¿ç¨‹ï¼Œå¹¶æ ¹æ®ç³»ç»Ÿæ¡ä»¶çš„å˜åŒ–åŠ¨æ€è°ƒèŠ‚ã€‚å¦ä¸€ä¸ªé—®é¢˜æ˜¯ä½ çš„ç¨‹åºæ‰¿æ‹…ç€åˆ›å»ºå’Œç»´æŠ¤çº¿ç¨‹çš„å¤§éƒ¨åˆ†æˆæœ¬ã€‚</p><p>OS X å’Œ iOS é‡‡ç”¨äº† <em>asynchronous design approach</em> æ¥è§£å†³å¹¶å‘çš„é—®é¢˜ï¼Œè€Œä¸æ˜¯ä¾èµ–äºçº¿ç¨‹ã€‚å¼‚æ­¥å‡½æ•°åœ¨æ“ä½œç³»ç»Ÿä¸­å·²ç»å­˜åœ¨å¤šå¹´ï¼Œå¹¶è¢«ä½¿ç”¨æ¥å¯åŠ¨éœ€è¦é•¿æ—¶é—´çš„ä»»åŠ¡ï¼Œå¦‚ä»ç¡¬ç›˜ä¸­è¯»å–æ•°æ®ã€‚å½“è¢«è°ƒç”¨æ—¶ï¼Œä¸€ä¸ªå¼‚æ­¥å‡½æ•°åœ¨å¹•åä¼šåšäº›å·¥ä½œæ¥å¯åŠ¨ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶åœ¨ä»»åŠ¡çœŸæ­£å¯åŠ¨å‰è¿”å›ã€‚å¾€å¾€ï¼Œè¿™äº›å·¥ä½œè®¾è®¡åˆ°è·å¾—ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œåœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œä¸Šè¿°ä»»åŠ¡ï¼Œå½“ä»»åŠ¡å®Œæˆçš„æ—¶å€™å‘é€ä¸€ä¸ªé€šçŸ¥ç»™è°ƒç”¨è€…ï¼ˆé€šå¸¸é€šè¿‡å›è°ƒå‡½æ•°ï¼‰ã€‚åœ¨è¿‡å»ï¼Œå¦‚æœæŸä¸ªä½ æƒ³ç”¨çš„å¼‚æ­¥å‡½æ•°ä¸å­˜åœ¨çš„è¯ï¼Œä½ å°±éœ€è¦ç¼–å†™ä½ è‡ªå·±çš„å¼‚æ­¥å‡½æ•°å’Œåˆ›å»ºä½ è‡ªå·±çš„çº¿ç¨‹ã€‚ä½†æ˜¯ç°åœ¨ï¼ŒOS X å’Œ iOS æä¾›äº†å…è®¸ä½ æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œä½†ä¸éœ€è¦ä½ ç®¡ç†ä»»ä½•çº¿ç¨‹çš„æŠ€æœ¯ã€‚</p><p>å…¶ä¸­çš„ä¸€ä¸ªå¯åŠ¨å¼‚æ­¥ä»»åŠ¡çš„æŠ€æœ¯å«åš <em>Grand Central Dispatch ï¼ˆGCDï¼‰</em>ã€‚è¿™é¡¹æŠ€æœ¯å°†ä½ ç»å¸¸åœ¨è‡ªå·±ç¨‹åºä¸­å†™çš„ç®¡ç†çº¿ç¨‹çš„ä»£ç æå‡ºæ¥ï¼Œç§»åˆ°ç³»ç»Ÿçš„å±‚çº§é‡Œã€‚ä½ æ‰€éœ€è¦åšçš„æ˜¯å®šä¹‰ä½ çš„ä»»åŠ¡ï¼Œå°†è¿™äº›ä»»åŠ¡æ·»åŠ åˆ°ç›¸åº”çš„è°ƒåº¦é˜Ÿåˆ—ä¸­ (dispatch queue)ã€‚GCD è´Ÿè´£åˆ›å»ºéœ€è¦çš„çº¿ç¨‹ï¼Œå¹¶åœ¨è¿™äº›çº¿ç¨‹ä¸Šè§„åˆ’è¿™äº›ä»»åŠ¡ã€‚ç”±äºçº¿ç¨‹ç®¡ç†ç°åœ¨æ˜¯ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼ŒGCDæä¾›äº†ä¸€ä¸ªæ•´ä½“çš„ä»»åŠ¡ç®¡ç†å’Œæ‰§è¡Œæ–¹æ¡ˆï¼Œæä¾›äº†æ¯”ä¼ ç»Ÿçº¿ç¨‹æ›´å¥½çš„æ•ˆç‡ã€‚</p><p><em>æ“ä½œé˜Ÿåˆ—</em>æ˜¯è¡Œä¸ºè·Ÿè°ƒåº¦é˜Ÿåˆ— (dispatch queues) éå¸¸åƒçš„ Objective-C å¯¹è±¡ã€‚ä½ å®šä¹‰è‡ªå·±æƒ³è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŠŠå®ƒä»¬æ·»åŠ åˆ°æ“ä½œé˜Ÿåˆ—ä¸­ï¼Œæ“ä½œé˜Ÿåˆ—ä¼šæ›¿ä½ è´Ÿè´£çº¿ç¨‹ç®¡ç†ï¼Œä¿è¯ä»»åŠ¡åœ¨ç³»ç»Ÿä¸Šçš„æ‰§è¡Œå°½å¯èƒ½åœ°è¿…é€Ÿå’Œé«˜æ•ˆã€‚</p><h3 id="è°ƒåº¦é˜Ÿåˆ—">è°ƒåº¦é˜Ÿåˆ—</h3><p>è°ƒåº¦é˜Ÿåˆ—æ˜¯åŸºäº C çš„ä¸€ä¸ªæ‰§è¡Œè‡ªå®šä¹‰ä»»åŠ¡çš„æœºåˆ¶ã€‚ä¸€ä¸ª<em>è°ƒåº¦é˜Ÿåˆ—</em>è¦ä¹ˆä¸²è¡Œ (serially) è¦ä¹ˆå¹¶è¡Œ (concurrently) åœ°æ‰§è¡Œä»»åŠ¡ï¼Œä½†å§‹ç»ˆæ˜¯å…ˆå…¥å…ˆå‡ºçš„é¡ºåºï¼ˆæ¢å¥è¯è¯´ï¼Œä¸€ä¸ªè°ƒåº¦é˜Ÿåˆ—æ€»æ˜¯æŒ‰ç…§è¿›å…¥é˜Ÿåˆ—çš„é¡ºåºä»é˜Ÿåˆ—ä¸­å–å‡ºæ‰§è¡Œä»»åŠ¡ï¼‰ã€‚ä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—ä¸€æ¬¡åªè¿è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œç­‰åˆ°è¯¥ä»»åŠ¡å®Œæˆåå†å»æ’é˜Ÿå¹¶å¯åŠ¨æ–°çš„ä»»åŠ¡ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¹¶å‘è°ƒåº¦é˜Ÿåˆ—ä¼šå°½å¯èƒ½å¤šåœ°å¯åŠ¨ä»»åŠ¡ï¼Œè€Œä¸ç­‰å¾…å·²ç»å¯åŠ¨çš„ä»»åŠ¡å®Œæˆã€‚</p><p>è°ƒåº¦é˜Ÿåˆ—æœ‰äº›å…¶ä»–å¥½å¤„ï¼š</p><ul><li>å®ƒä»¬æä¾›äº†ç›´æ¥å¹¶ç®€å•çš„ç¼–ç¨‹æ¥å£ã€‚</li><li>å®ƒä»¬æä¾›äº†è‡ªåŠ¨å…¨é¢çš„çº¿ç¨‹æ± ç®¡ç†ã€‚</li><li>å®ƒä»¬æä¾›äº†æ±‡ç¼–æ€§èƒ½ä¼˜åŒ–ã€‚</li><li>å†…å­˜ä½¿ç”¨æ›´é«˜æ•ˆï¼ˆå› ä¸ºçº¿ç¨‹æ ˆä¸ä¼šåœ¨ç¨‹åºå†…å­˜ä¸­åœç•™ï¼‰ã€‚</li><li>åœ¨è´Ÿè½½ä¸‹ä¸ä¼šæŸå®³å†…æ ¸ã€‚</li><li>å¼‚æ­¥åœ°è°ƒåº¦ä»»åŠ¡åˆ°è°ƒåº¦é˜Ÿåˆ—ä¸ä¼šå¯¼è‡´æ­»é”ã€‚</li><li>åœ¨èµ„æº contention çš„æ—¶å€™å¯ä»¥è‡ªç”±ä¼¸ç¼©ã€‚</li><li>æ¯”é”å’Œå…¶ä»–åŒæ­¥åŸè¯­æ›´é«˜æ•ˆã€‚</li></ul><p>æäº¤ç»™è°ƒåº¦é˜Ÿåˆ—çš„ä»»åŠ¡å¿…é¡»å°è£…åœ¨ä¸€ä¸ªå‡½æ•°æˆ– block å¯¹è±¡ä¸­ã€‚ blockå¯¹è±¡æ˜¯ OS X v10.6 å’Œ iOS 4.0 å¼•å…¥çš„ä¸€ä¸ªè·Ÿå‡½æ•°æŒ‡é’ˆæ¦‚å¿µç›¸ä¼¼çš„ C è¯­è¨€ç‰¹æ€§ï¼Œä½†ç›¸å¯¹äºå‡½æ•°æŒ‡é’ˆï¼Œå®ƒæœ‰å…¶ä»–ä¼˜ç‚¹ã€‚é™¤äº†åœ¨ block è‡ªèº«çš„è¯æ³•åŸŸå®šä¹‰ block å¤–ï¼Œä½ é€šå¸¸å¯ä»¥åœ¨å¦ä¸€ä¸ªå‡½æ•°æˆ–æ–¹æ³•ä¸­å®šä¹‰ blockï¼Œè¿™æ · block å°±å¯ä»¥è®¿é—®å‡½æ•°æˆ–æ–¹æ³•å†…çš„å˜é‡äº†ã€‚å½“æŠŠ block æäº¤åˆ°è°ƒåº¦é˜Ÿåˆ—æ—¶ï¼Œblock åŒæ ·å¯ä»¥ä»åŸæœ‰çš„ä½œç”¨åŸŸä¸­ç§»å‡ºï¼Œå¹¶æ‹·è´åˆ°å †ä¸­ã€‚æ‰€æœ‰è¿™äº›è¯­ä¹‰ä½¿å¾—ä½¿ç”¨è¾ƒå°‘ä»£ç å®ç°éå¸¸åŠ¨æ€çš„ä»»åŠ¡å˜å¾—å¯èƒ½ã€‚</p><p>è°ƒåº¦é˜Ÿåˆ—æ˜¯Grand Central DispatchæŠ€æœ¯çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯Cè¯­è¨€è¿è¡Œæ—¶çš„ä¸€éƒ¨åˆ†ã€‚å…³äºåœ¨ç¨‹åºä¸­ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href=".%2F03%20Dispatch%20Queues.md">è°ƒåº¦é˜Ÿåˆ—</a>ã€‚å…³äºblockçš„æ›´å¤šä¿¡æ¯å’Œå®ƒä»¬çš„ä¼˜åŠ¿ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Blocks/Articles/00_Introduction.html#//apple_ref/doc/uid/TP40007502">Blocks Programming Topics</a>ã€‚</p><h3 id="è°ƒåº¦æº">è°ƒåº¦æº</h3><p>è°ƒåº¦æºæ˜¯ä¸€ç§åŸºäº C çš„å¼‚æ­¥å¤„ç†ç‰¹å®šç³»ç»Ÿäº‹ä»¶çš„æœºåˆ¶ã€‚ä¸€ä¸ªè°ƒåº¦æºå°è£…äº†ä¸€ä¸ªç‰¹å®šç³»ç»Ÿäº‹ä»¶ç±»å‹çš„ä¿¡æ¯ï¼Œå¹¶åœ¨è¯¥äº‹ä»¶å‘ç”Ÿæ—¶å°†ç‰¹å®šçš„blockå¯¹è±¡æˆ–å‡½æ•°æäº¤ç»™è°ƒåº¦é˜Ÿåˆ—ã€‚ä½ å¯ä»¥ä½¿ç”¨è°ƒåº¦æºæ¥ç›‘å¬ä»¥ä¸‹ç³»ç»Ÿäº‹ä»¶ï¼š</p><ul><li>Timers</li><li>Signal handlers</li><li>Descriptor-related events</li><li>Process-related events</li><li>Mach port events</li><li>Custom events that you trigger</li></ul><p>è°ƒåº¦æºæ˜¯Grand Central DispatchæŠ€æœ¯çš„ä¸€éƒ¨åˆ†ã€‚å…³äºä½¿ç”¨è°ƒåº¦æºåœ¨ç¨‹åºä¸­æ¥æ”¶äº‹ä»¶çš„ä¿¡æ¯ï¼Œå¯å‚é˜…<a href=".%2F04%20Dispatch%20Sources.md">è°ƒåº¦æº</a>ã€‚</p><h3 id="æ“ä½œé˜Ÿåˆ—">æ“ä½œé˜Ÿåˆ—</h3><p>æ“ä½œé˜Ÿåˆ—ç›¸å½“äºä¸€ä¸ªå¹¶å‘çš„è°ƒåº¦é˜Ÿåˆ—ï¼Œç”±<code>NSOperationQueue</code>ç±»å®ç°ã€‚å°½ç®¡è°ƒåº¦é˜Ÿåˆ—æ€»æ˜¯ä»¥å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œä»»åŠ¡ï¼Œè€Œæ“ä½œé˜Ÿåˆ—åœ¨ç¡®å®šä»»åŠ¡çš„æ‰§è¡Œé¡ºåºæ—¶ä¼šè€ƒè™‘åˆ°å…¶ä»–å› ç´ ã€‚ä¸»è¦å› ç´ æ˜¯ä»»åŠ¡ä¹‹é—´é…ç½®çš„ä¾èµ–ã€‚é…ç½®ä¾èµ–å…³ç³»å¯ä»¥ç”¨å…¶æ„å»ºå¤æ‚çš„æ‰§è¡Œé¡ºåºã€‚</p><p>æäº¤ç»™æ“ä½œé˜Ÿåˆ—çš„ä»»åŠ¡å¿…é¡»æ˜¯ <code>NSOperation</code> ç±»çš„å®ä¾‹ã€‚ä¸€ä¸ª<em>æ“ä½œå¯¹è±¡</em>æ˜¯ä¸€ä¸ªä½ éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡å’Œä»»åŠ¡æ‰€éœ€æ•°æ® Objective-C å°è£…çš„å¯¹è±¡ã€‚å› ä¸º <code>NSOperation</code> ç±»æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼Œä½ é€šå¸¸éœ€è¦è‡ªå®šä¹‰å­ç±»æ¥æ‰§è¡Œä½ çš„ä»»åŠ¡ã€‚ä½†Foundationæ¡†æ¶ä¹Ÿæä¾›äº†ä¸€äº›å…·ä½“å­ç±»å¯ç›´æ¥ä½¿ç”¨ã€‚</p><p>æ“ä½œå¯¹è±¡ä¼šäº§ç”Ÿ KVO é€šçŸ¥ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥ç›‘å¬ä½ çš„ä»»åŠ¡çš„è¿›åº¦ã€‚å°½ç®¡æ“ä½œé˜Ÿåˆ—æ€»æ˜¯å¹¶å‘åœ°æ‰§è¡Œæ“ä½œå¯¹è±¡ï¼Œä½†ä½ å¯ä»¥ä½¿ç”¨ä¾èµ–å…³ç³»æ¥ç¡®ä¿å®ƒä»¬åœ¨éœ€è¦æ—¶è¢«ä¸²è¡Œæ‰§è¡Œã€‚</p><p>å…³äºå¦‚ä½•ä½¿ç”¨æ“ä½œé˜Ÿåˆ—ï¼Œä»¥åŠå¦‚ä½•å®šä¹‰è‡ªå®šä¹‰æ“ä½œå¯¹è±¡çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href=".%2F02%20Operation%20Queues.md">æ“ä½œé˜Ÿåˆ—</a>ã€‚</p><h2 id="å¼‚æ­¥è®¾è®¡æŠ€æœ¯">å¼‚æ­¥è®¾è®¡æŠ€æœ¯</h2><p>åœ¨ä½ è€ƒè™‘é‡æ–°è®¾è®¡ä½ çš„ä»£ç æ¥æ”¯æŒå¹¶å‘çš„æ—¶å€™ï¼Œä½ åº”è¯¥é—®ä¸‹ä½ è‡ªå·±è¿™æ ·åšæ˜¯å¦å€¼å¾—ã€‚å¹¶å‘å¯ä»¥é€šè¿‡è®©ä½ çš„ä¸»çº¿ç¨‹ä¸“é—¨å“åº”ç”¨æˆ·äº‹ä»¶æ¥ä¿è¯ç¨‹åºçš„å“åº”æ€§ï¼›é€šè¿‡ä½¿ç”¨å¤šä¸ªæ ¸å¿ƒå¯ä»¥è®©ä½ çš„ä»£ç ç»™å®šæ—¶é—´å†…åšæ›´å¤šçš„å·¥ä½œã€‚ç„¶è€Œï¼Œå¹¶å‘ä¹Ÿä¼šå¢åŠ å¼€é”€ï¼Œå¢åŠ ä»£ç çš„æ•´ä½“å¤æ‚æ€§ï¼Œä½¿å¾—ä»£ç éš¾ä»¥ç¼–å†™å’Œè°ƒè¯•ã€‚</p><p>é™¤äº†å¢åŠ å¤æ‚æ€§å¤–ï¼Œå¹¶å‘å¹¶ä¸æ˜¯ä¸€ä¸ªä½ åœ¨ç¨‹åºçš„äº§å“å‘¨æœŸæœ€åå¯ä»¥ç§»æ¥çš„ç‰¹æ€§ã€‚æ­£ç¡®çš„ä½¿ç”¨å®ƒéœ€è¦ä»”ç»†çš„è€ƒè™‘ä½ çš„ç¨‹åºæ‰€åšçš„ä»»åŠ¡å’Œè¿™äº›ä»»åŠ¡éœ€è¦çš„æ•°æ®ç»“æ„ã€‚åšçš„ä¸å¯¹çš„æ—¶å€™ï¼Œåè€Œä¼šé™ä½ä½ ä»£ç çš„æ•ˆç‡å’Œå“åº”æ€§ã€‚å› æ­¤ï¼Œåœ¨è®¾è®¡å¼€å§‹çš„æ—¶å€™å¾ˆæœ‰å¿…è¦èŠ±äº›æ—¶é—´æ¥è®¾å®šä½ çš„ç›®æ ‡ï¼Œè®¾è®¡æ‰§è¡Œçš„æ–¹æ¡ˆã€‚</p><p>æ¯ä¸€ä¸ªç¨‹åºæœ‰ä¸åŒçš„è¦æ±‚å’Œä¸åŒçš„ä»»åŠ¡éœ€è¦ã€‚å‡ ä¹ä¸å¯èƒ½æœ‰ä¸€ä¸ªæ–‡æ¡£æ¥å‘Šè¯‰ä½ æ€ä¹ˆè®¾è®¡ä½ çš„ç¨‹åºå’Œç›¸å…³çš„ä»»åŠ¡ã€‚ä¸è¿‡ï¼Œä¸‹é¢çš„ç« èŠ‚è¯•å›¾æä¾›ä¸€äº›æŒ‡å—ï¼Œå¸®åŠ©ä½ åœ¨è®¾è®¡è¿‡ç¨‹ä¸­åšå‡ºæ­£ç¡®çš„é€‰æ‹©ã€‚</p><h3 id="å®šä¹‰ç¨‹åºçš„é¢„æœŸè¡Œä¸º">å®šä¹‰ç¨‹åºçš„é¢„æœŸè¡Œä¸º</h3><p>åœ¨ä½ å¼€å§‹è€ƒè™‘ç»™ä½ çš„åº”ç”¨æ·»åŠ å¹¶å‘ä¹‹å‰ï¼Œä½ åº”é¦–å…ˆå®šä¹‰æ­£ç¡®çš„ç¨‹åºè¡Œä¸ºã€‚ç†è§£ä½ åº”ç”¨çš„æœŸæœ›è¡Œä¸ºç»™ä½ ç¨åéªŒè¯ä½ çš„è®¾è®¡å¯èƒ½ï¼ŒåŒæ ·ç»™ä½ å…³äºå¼•å…¥å¹¶å‘å¯èƒ½å¸¦æ¥çš„æ€§èƒ½æå‡çš„æƒ³æ³•ã€‚</p><p>ä½ åº”è¯¥åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯éå†ç¨‹åºè¦åšçš„ä»»åŠ¡å’Œæ¯ä¸ªä»»åŠ¡æ‰€éœ€è¦çš„å¯¹è±¡æˆ–æ•°æ®ç»“æ„ã€‚è¿™äº›ä»»åŠ¡å¯èƒ½åŒ…å«ç”¨æˆ·è¡Œä¸ºå¼•èµ·çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å®šæ—¶å™¨å¼•èµ·çš„ã€‚</p><p>ä¹‹ååˆ—å‡ºä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡ï¼Œç»†åˆ†è®¤ä¸ºåˆ°å°çš„æ­¥éª¤ã€‚åœ¨è¿™ä¸ªå±‚çº§ï¼Œä½ åº”è¯¥ä¸»è¦å…³æ³¨ä½ å¯¹æ•°æ®ç»“æ„çš„ä¿®æ”¹å’Œè¿™äº›å¯¹è±¡çš„ä¿®æ”¹æ€ä¹ˆå½±å“å…¨å±€çŠ¶æ€ã€‚ä½ åº”è¯¥æ³¨æ„åˆ°ä¸åŒçš„å¯¹è±¡ã€æ•°æ®ç»“æ„é—´çš„ä¾èµ–ã€‚ä¸€ä¸ªå¯¹è±¡çš„ä¿®æ”¹æ˜¯å¦ä¼šå½±å“å…¶ä»–å¯¹è±¡ã€‚å¦‚æœè¿™äº›å¯¹è±¡å¯ä»¥ç›¸äº’ç‹¬ç«‹åœ°è¿›è¡Œä¿®æ”¹ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå¯ä»¥åŒæ—¶è¿›è¡Œä¿®æ”¹çš„åœ°æ–¹ã€‚</p><h3 id="åˆ†è§£å‡ºå¯æ‰§è¡Œçš„å·¥ä½œå•å…ƒ">åˆ†è§£å‡ºå¯æ‰§è¡Œçš„å·¥ä½œå•å…ƒ</h3><p>ä»ä½ å¯¹ç¨‹åºä»»åŠ¡çš„ç†è§£ï¼Œä½ åº”è¯¥å·²ç»å¯ä»¥ç¡®å®šå“ªäº›åœ°æ–¹ä½ å¯ä»¥ä½¿ç”¨å¹¶å‘æ¥ä¼˜åŒ–ä½ çš„ä»£ç ã€‚å¦‚æœæ”¹å˜ä»»åŠ¡æ‰§è¡Œçš„æ­¥éª¤ä¼šå½±å“æœ€ç»ˆçš„ç»“æœçš„è¯ï¼Œå¯éœ€è¦ç»§ç»­ç»´æŒè¿™äº›æ­¥éª¤çš„é¡ºåºï¼›å¦åˆ™å¦‚æœæ”¹å˜æ­¥éª¤ä¸å½±å“æœ€ç»ˆçš„ç»“æœçš„è¯ï¼Œä½ å¯ä»¥è€ƒè™‘å¹¶å‘æ‰§è¡Œè¿™äº›æ­¥éª¤ã€‚è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œéƒ½è¦å®šä¹‰å¯æ‰§è¡Œçš„å·¥ä½œå•å…ƒæ¥ä»£æ›¿ä½ ä»»åŠ¡ä¸­éœ€è¦æ‰§è¡Œçš„æ­¥éª¤ã€‚ç„¶åä½¿ç”¨blockæˆ–æ“ä½œå¯¹è±¡å°è£…å·¥ä½œå•å…ƒå†…å®¹ï¼Œå¹¶åˆ†å‘åˆ°åˆé€‚çš„é˜Ÿåˆ—ä¸­ã€‚</p><p>å¯¹äºæ¯ä¸ªç¡®å®šçš„å¯æ‰§è¡Œå·¥ä½œå•å…ƒï¼Œä¸€å¼€å§‹ä¸å¿…å¤ªæ‹…å¿ƒå·¥ä½œé‡çš„å¤§å°ã€‚å°½ç®¡å¯åŠ¨çº¿ç¨‹æ€»æœ‰ä¸€å®šçš„å¼€é”€ï¼Œä½†ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—å’Œæ“ä½œé˜Ÿåˆ—åœ¨å¤§å¤šæƒ…å†µä¸‹ï¼Œå…¶å¼€é”€ä¼šæ¯”ä¼ ç»Ÿçš„çº¿ç¨‹è¦å°å¾ˆå¤šã€‚å› æ­¤ï¼Œä½¿ç”¨é˜Ÿåˆ—æ¯”ä½¿ç”¨çº¿ç¨‹å¯ä»¥æ›´é«˜æ•ˆçš„æ‰§è¡Œè¿™äº›æ¯”è¾ƒå°çš„å·¥ä½œå•å…ƒã€‚å½“ç„¶ä½ åº”å¸¸æµ‹é‡å®é™…æ€§èƒ½ï¼Œå¹¶æ ¹æ®éœ€è¦è°ƒæ•´ä»»åŠ¡çš„å¤§å°ã€‚ä½†æ˜¯è¿˜æ˜¯é‚£å¥è¯ï¼Œå¼€å§‹çš„æ—¶å€™ï¼Œæ²¡æœ‰ä»»åŠ¡åº”è¯¥è¢«è§†ä¸ºå¤ªå°ã€‚</p><h3 id="ç¡®å®šéœ€è¦çš„é˜Ÿåˆ—">ç¡®å®šéœ€è¦çš„é˜Ÿåˆ—</h3><p>ç°åœ¨ä½ çš„ä»»åŠ¡å·²ç»è¢«åˆ†è§£ä¸ºä¸åŒçš„å·¥ä½œå•å…ƒï¼Œä½¿ç”¨blockæˆ–æ“ä½œå¯¹è±¡è¿›è¡Œå°è£…ï¼Œä½ éœ€è¦å®šä¹‰æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—ã€‚å¯¹äºä¸€ä¸ªç»™å®šçš„ä»»åŠ¡ï¼Œä½ éœ€è¦æ£€æŸ¥åˆ›å»ºçš„blockæˆ–æ“ä½œå¯¹è±¡å’Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºï¼Œä»¥æ­£ç¡®å®Œæˆä»»åŠ¡ã€‚</p><p>å¦‚æœä½ ä½¿ç”¨blockæ¥å®Œæˆä»»åŠ¡ï¼Œä½ å¯ä»¥æ·»åŠ blockåˆ°ä¸²è¡Œæˆ–å¹¶è¡Œè°ƒåº¦é˜Ÿåˆ—ã€‚å¦‚æœéœ€è¦ç‰¹å®šçš„é¡ºåºï¼Œåˆ™å°†blockæ·»åŠ åˆ°ä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—ã€‚å¦‚æœé¡ºåºä¸é‡è¦ï¼Œåˆ™å¯ä»¥å°†blockæ·»åŠ åˆ°å¹¶è¡Œè°ƒåº¦é˜Ÿåˆ—ï¼Œæˆ–æ ¹æ®ä½ çš„éœ€è¦ï¼ŒæŠŠå®ƒä»¬æ·»åŠ åˆ°å¤šä¸ªä¸åŒçš„è°ƒåº¦é˜Ÿåˆ—ä¸­ã€‚</p><p>å¦‚æœä½ é€šè¿‡æ“ä½œå¯¹è±¡æ¥å®ç°ä½ çš„ä»»åŠ¡ï¼Œé˜Ÿåˆ—çš„é€‰æ‹©å¾€å¾€æ²¡é…ç½®è¿™äº›å¯¹è±¡æœ‰è¶£ã€‚è¦ä¸²è¡Œçš„æ‰§è¡Œè¿™äº›ä»»åŠ¡ï¼Œä½ å¿…é¡»é…ç½®è¿™äº›å¯¹è±¡é—´çš„ä¾èµ–ã€‚ä¾èµ–å¯ä»¥ç¡®ä¿åœ¨ä¾èµ–çš„æ“ä½œå¯¹è±¡å®Œæˆä»»åŠ¡æ—¶æ‰æ‰§è¡Œåç»­çš„æ“ä½œã€‚</p><h2 id="æé«˜æ•ˆç‡çš„æŠ€å·§">æé«˜æ•ˆç‡çš„æŠ€å·§</h2><p>é™¤äº†é‡æ„ä½ çš„ä»£ç æˆè¾ƒå°çš„ä»»åŠ¡ï¼Œå°†ä»»åŠ¡åŠ åˆ°é˜Ÿåˆ—ï¼Œè¿˜æœ‰å…¶ä»–çš„æ–¹å¼ä½¿ç”¨é˜Ÿåˆ—æ¥æé«˜ä»£ç çš„æ•´ä½“æ•ˆç‡ï¼š</p><ul><li><strong>å¦‚æœå†…å­˜ä½¿ç”¨æ˜¯å…³é”®å› ç´ ï¼Œè€ƒè™‘ç›´æ¥åœ¨ä»»åŠ¡ä¸­è®¡ç®—å€¼ã€‚</strong>ç›´æ¥è®¡ç®—æ•°å€¼ä¼šä½¿ç”¨ç»™å®šå¤„ç†å™¨å†…æ ¸çš„å¯„å­˜å™¨å’Œç¼“å­˜ï¼Œè¿™æ¯”ä¸»å†…å­˜å¿«å¾—å¤šã€‚å½“ç„¶è¦ç»è¿‡æµ‹è¯•ç¡®å®šè¿™ä¸€ä¼˜åŒ–æ˜¯å¦èƒ½æé«˜æ€§èƒ½ã€‚</li><li><strong>å°½æ—©æ‰¾å‡ºå‡ºä¸²è¡Œçš„ä»»åŠ¡ï¼Œå°½å¯èƒ½ä½¿å®ƒä»¬æ›´å¹¶å‘ã€‚</strong>å¦‚æœä»»åŠ¡å› ä¸ºèµ„æºå…±äº«è€Œå¿…é¡»ä¸²è¡Œï¼Œåˆ™å¯ä»¥è€ƒè™‘ç§»é™¤å…±äº«èµ„æºï¼Œæˆ–ä¸ºæ¯ä¸ªä»»åŠ¡åˆ†é…èµ„æºçš„å‰¯æœ¬ä»¥æ¶ˆé™¤å…±äº«ã€‚</li><li><strong>é¿å…ä½¿ç”¨é”ã€‚</strong>æœ‰äº†è°ƒåº¦é˜Ÿåˆ—å’Œæ“ä½œé˜Ÿåˆ—ï¼Œé”åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ä¸éœ€è¦çš„ã€‚ä¸å…¶ä½¿ç”¨é”æ¥ä¿æŠ¤ä¸€äº›å…±äº«èµ„æºï¼Œä¸å¦‚æŒ‡å®šä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼ˆæˆ–ä½¿ç”¨æ“ä½œå¯¹è±¡ä¾èµ–ï¼‰æ¥ä»¥æ­£ç¡®çš„é¡ºåºæ‰§è¡Œä»»åŠ¡ã€‚</li><li><strong>å°½å¯èƒ½çš„ä¾èµ–ç³»ç»Ÿæ¡†æ¶ã€‚</strong>ä½¿ç”¨ç³»ç»Ÿæä¾›çš„APIå¯ä»¥èŠ‚çœç²¾åŠ›ï¼Œå¹¶èƒ½æœ€å¤§é™åº¦åœ°æé«˜å¹¶å‘æ€§ã€‚</li></ul><h2 id="æ€§èƒ½å½±å“">æ€§èƒ½å½±å“</h2><p>æ“ä½œé˜Ÿåˆ—ã€è°ƒåº¦é˜Ÿåˆ—å’Œè°ƒåº¦æºæ˜¯ä¸ºäº†è®©å¼€å‘è€…æ›´å®¹æ˜“åœ°å¹¶å‘æ‰§è¡Œæ›´å¤šçš„ä»£ç ã€‚ç„¶è€Œï¼Œè¿™äº›æŠ€æœ¯å¹¶ä¸ä¿è¯èƒ½ç»™æé«˜ç¨‹åºçš„æ‰§è¡Œå’Œå“åº”æ•ˆç‡ã€‚ä»¥æŠ€èƒ½æœ‰æ•ˆæ»¡è¶³éœ€æ±‚ï¼Œåˆä¸ä¼šå¯¹ç¨‹åºçš„å…¶ä»–èµ„æºé€ æˆè¿‡åº¦è´Ÿæ‹…çš„æ–¹å¼æ¥ä½¿ç”¨é˜Ÿåˆ—ï¼Œä»æ˜¯å¼€å‘è€…çš„ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œå°½ç®¡ä½ å¯ä»¥åˆ›å»º 10,000 ä¸ªæ“ä½œå¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬æäº¤ç»™æ“ä½œé˜Ÿåˆ—ï¼Œä½†æ˜¯è¿™ä¹ˆåšä¼šè®©ç¨‹åºåˆ†é…å¤§é‡çš„å†…å­˜ï¼Œæœ€ç»ˆé™ä½ç¨‹åºçš„æ€§èƒ½å’Œä½“éªŒã€‚</p><p>åœ¨å¼•å…¥ä»»ä½•å¹¶å‘åˆ°ä½ çš„ä»£ç ä¹‹å‰ï¼Œä¸è®ºæ˜¯é€šè¿‡é˜Ÿåˆ—è¿˜æ˜¯çº¿ç¨‹ï¼Œä½ éƒ½åº”è¯¥æ”¶é›†è¡¡é‡å½±å“åº”ç”¨å½“å‰æ€§èƒ½çš„åŸºæœ¬æ ‡å‡†ã€‚åœ¨å¼•å…¥äº†è¿™äº›æœºåˆ¶åï¼Œä½ éœ€è¦é‡æ–°æ”¶é›†è¿™äº›ä¿¡æ¯ï¼Œç„¶åå¯¹æ¯”ä»¥ç¡®å®šç¨‹åºçš„æ•´ä½“æ•ˆç‡æ˜¯å¦å¾—åˆ°äº†æé«˜ã€‚å¦‚æœå¼•å…¥å¹¶å‘å¯¼è‡´äº†ç¨‹åºçš„æ‰§è¡Œå’Œå“åº”æ•ˆç‡é™ä½ï¼Œåˆ™åº”ä½¿ç”¨æ€§èƒ½å·¥å…·æ¥æ£€æŸ¥æ½œåœ¨çš„åŸå› ã€‚</p><p>å…³äºæ€§èƒ½å’Œå¯ç”¨çš„æ€§èƒ½å·¥å…·çš„ä»‹ç»ï¼Œä»¥åŠæ›´é«˜çº§çš„æ€§èƒ½ç›¸å…³ä¸»é¢˜çš„é“¾æ¥ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/PerformanceOverview/Introduction/Introduction.html#//apple_ref/doc/uid/TP40001410">Performance Overview</a>ã€‚</p><h2 id="å¹¶å‘å’Œå…¶ä»–æŠ€æœ¯">å¹¶å‘å’Œå…¶ä»–æŠ€æœ¯</h2><p>æŠŠä»£ç åˆ†è§£æˆæ¨¡å—åŒ–çš„ä»»åŠ¡ï¼Œæ˜¯è¯•å›¾è¯¥ç¼ ç¨‹åºå¹¶å‘æ€§çš„æœ€å¥½æ–¹æ³•ã€‚ç„¶è€Œè¿™ç§è®¾è®¡æ–¹æ³•å¹¶ä¸èƒ½æ»¡è¶³æ‰€æœ‰çš„åœºæ™¯ã€‚æ ¹æ®ä½ çš„ä»»åŠ¡ï¼Œå¯èƒ½è¿˜æœ‰å…¶ä»–é€‰æ‹©ä¸ºç¨‹åºçš„æ•´ä½“å¹¶å‘æ€§æä¾›é¢å¤–çš„æ”¹è¿›ã€‚</p><h3 id="openclå’Œå¹¶å‘æ€§">OpenCLå’Œå¹¶å‘æ€§</h3><p>OS X ä¸­ <code>Open Computing Language (OpenCL)</code> æ˜¯ä¸€ä¸ªåŸºäºæ ‡å‡†çš„æŠ€æœ¯ï¼Œç”¨æ¥åœ¨ GPU ä¸Šè¿›è¡Œé€šç”¨è®¡ç®—ã€‚å¦‚æœä½ æœ‰å®šä¹‰å¥½çš„è®¡ç®—éœ€è¦åº”ç”¨åœ¨å¤§å‹æ•°æ®ä¸Šï¼ŒOpenCL æ˜¯ä¸é”™çš„æŠ€æœ¯ã€‚ä¾‹å¦‚ï¼Œä½ ä¹Ÿè®¸ç”¨ OpenCL åœ¨å›¾åƒçš„åƒç´ ä¸Šè¿›è¡Œæ»¤é•œæ“ä½œï¼Œæˆ–è€…åœ¨å¤šä¸ªå€¼ä¸Šè¿›è¡Œå¤æ‚çš„æ•°å­¦è®¡ç®—ã€‚æ¢å¥è¯è¯´ï¼ŒOpenCL æ›´å¤šæ˜¯ç”¨äºå¤„ç†æ•°æ®å¯è¢«å¹¶è¡Œæ“ä½œçš„é—®é¢˜ã€‚</p><p>å°½ç®¡ OpenCL å¾ˆé€‚åˆæ‰§è¡Œå¤§è§„æ¨¡çš„å¹¶è¡Œæ•°æ®æ“ä½œï¼Œé™¤æ­¤ä¹‹å¤–å¯èƒ½å¹¶ä¸é€‚åˆå…¶ä»–åœºæ™¯çš„è®¡ç®—ã€‚éœ€è¦å¤§é‡çš„ç²¾åŠ›æ¥å‡†å¤‡å’Œè½¬ç§»æ•°æ®å’Œ the required work kernel (ä¸çŸ¥é“å’‹ç¿»è¯‘) åˆ°æ˜¾å¡ä¸Šï¼Œä»¥ä¾¿æ˜¾å¡å¯ä»¥è®¡ç®—ã€‚åŒæ ·éœ€è¦å¤§é‡çš„ç²¾åŠ›æ‰èƒ½ä» OpenCL è·å–æ“ä½œç»“æœã€‚å› æ­¤ï¼Œä»»ä½•ä¸ç³»ç»Ÿäº¤äº’çš„ä»»åŠ¡ä¸€èˆ¬éƒ½ä¸å»ºè®®ä½¿ç”¨OpenCLã€‚ä¾‹å¦‚ï¼Œä½ ä¸ä¼šä½¿ç”¨OpenCLæ¥å¤„ç†æ–‡ä»¶æˆ–ç½‘ç»œæµçš„æ•°æ®ã€‚ç›¸åï¼Œä½¿ç”¨OpenCLæ‰§è¡Œçš„å·¥ä½œå¿…é¡»è¶³å¤Ÿçš„ç‹¬ç«‹ï¼Œä»¥ä¾¿å®ƒå¯ä»¥è¢«ä¼ è¾“åˆ°GPUå¹¶ç‹¬ç«‹è®¡ç®—ã€‚</p><p>å…³äºOpenCLå’Œå¦‚ä½•ä½¿ç”¨å®ƒçš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/OpenCL_MacProgGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008312">OpenCL Programming Guide for Mac</a>ã€‚</p><h3 id="ä½•æ—¶ä½¿ç”¨çº¿ç¨‹">ä½•æ—¶ä½¿ç”¨çº¿ç¨‹</h3><p>å°½ç®¡æ“ä½œé˜Ÿåˆ—å’Œè°ƒåº¦é˜Ÿåˆ—æ˜¯å¹¶å‘æ‰§è¡Œä»»åŠ¡çš„é¦–é€‰æ–¹å¼ï¼Œä½†å®ƒä»¬å¹¶ä¸æ˜¯ä¸‡é‡‘æ²¹ã€‚æ ¹æ®ä½ çš„ç¨‹åºï¼Œæœ‰æ—¶ä»å¯èƒ½éœ€è¦åˆ›å»ºè‡ªå®šä¹‰çº¿ç¨‹ã€‚å½“ä½ ç¡®å®éœ€è¦åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œä½ åº”è¯¥å°½é‡åˆ›å»ºå°‘çš„çº¿ç¨‹ã€‚åŒæ—¶ä½ åªåº”ç”¨çº¿ç¨‹è§£å†³é‚£äº›ç”¨å…¶ä»–æ–¹å¼è§£å†³ä¸äº†çš„é—®é¢˜ã€‚</p><p>çº¿ç¨‹ä»æ˜¯å®ç°å®æ—¶è¿è¡Œä»£ç çš„æ–¹æ¡ˆã€‚è°ƒåº¦é˜Ÿåˆ—ä¼šå°½å¯èƒ½ä»¥æœ€å¿«é€Ÿåº¦æ‰§è¡Œå®ƒä»¬çš„ä»»åŠ¡ï¼Œä½†å®ƒä»æ²¡æœ‰è§£å†³å®æ—¶çš„é—®é¢˜ã€‚å¦‚æœä½ éœ€è¦åœ¨åå°æ‰§è¡Œçš„ä»£ç è¦æ±‚æ›´å¤šå¯é¢„æµ‹çš„è¡Œä¸ºï¼Œçº¿ç¨‹å¯èƒ½ä»æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</p><p>ä¸ä»»ä½•çº¿ç¨‹ç¼–ç¨‹ä¸€æ ·ï¼Œä½ åº”æ€»æ˜¯ç†æ™ºåœ°ä½¿ç”¨çº¿ç¨‹ï¼Œåªæœ‰åœ¨ç»å¯¹å¿…è¦æ—¶æ‰ä½¿ç”¨ã€‚å…³äºçº¿ç¨‹åŒ…ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/Introduction/Introduction.html#//apple_ref/doc/uid/10000057i">Threading Programming Guide</a>.ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><ul><li><p>å•ä½æ—¶é—´å†…çš„å·¥ä½œé‡æ˜¯ç”±CPUæ—¶é’Ÿé€Ÿåº¦å†³å®šçš„ã€‚</p></li><li><p>éšç€æŠ€æœ¯çš„è¿›æ­¥ï¼Œåˆ¶é€ å•†é€šè¿‡æé«˜CPUæ ¸æ•°æ¥æé«˜æ€§èƒ½ã€‚</p></li><li><p>ä½¿ç”¨çº¿ç¨‹æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œçº¿ç¨‹ä»£ç å¦‚ä½•å……åˆ†åˆ©ç”¨å†…æ ¸ã€‚</p></li><li><p>å¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œä½¿ç”¨çº¿ç¨‹çš„æŒ‘æˆ˜ï¼š</p><ul><li>å¯ä¼¸ç¼©æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„é—®é¢˜è¦å¼€å‘è€…è‡ªè¡Œè§£å†³ã€‚</li><li>ç¨‹åºæ‰¿æ‹…ç€åˆ›å»ºå’Œç»´æŠ¤çº¿ç¨‹çš„å¤§éƒ¨åˆ†æˆæœ¬ã€‚</li></ul></li><li><p>GCDæ˜¯é€šè¿‡ç”±ç³»ç»Ÿç®¡ç†çš„çº¿ç¨‹æ± ï¼Œå¯ä»¥æ›¿ä»£ç›´æ¥ä½¿ç”¨çº¿ç¨‹å®ç°çš„ç»å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œå¹¶æä¾›æ›´é«˜çš„æ•ˆç‡ã€‚å¼€å‘è€…çš„ä»»åŠ¡æ¬¡éœ€è¦å®šä¹‰ä»»åŠ¡ï¼Œå¹¶æ·»åŠ åˆ°ç›¸åº”çš„è°ƒåº¦é˜Ÿåˆ—ä¸­ã€‚</p></li><li><p>è°ƒåº¦é˜Ÿåˆ—çš„è°ƒåº¦å•å…ƒæ˜¯å‡½æ•°æˆ–blockï¼›æ“ä½œé˜Ÿåˆ—çš„è°ƒåº¦å•å…ƒæ˜¯æ“ä½œå¯¹è±¡ã€‚å·¥ä½œå•å…ƒçš„ä»£ç éƒ½æ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚</p></li><li><p>è°ƒåº¦é˜Ÿåˆ—æœ‰äº›å…¶ä»–å¥½å¤„ï¼š</p><ul><li>å®ƒä»¬æä¾›äº†ç›´æ¥å¹¶ç®€å•çš„ç¼–ç¨‹æ¥å£ã€‚</li><li>å®ƒä»¬æä¾›äº†è‡ªåŠ¨å…¨é¢çš„çº¿ç¨‹æ± ç®¡ç†ã€‚</li><li>å®ƒä»¬æä¾›äº†æ±‡ç¼–æ€§èƒ½ä¼˜åŒ–ã€‚</li><li>å†…å­˜ä½¿ç”¨æ›´é«˜æ•ˆï¼ˆå› ä¸ºçº¿ç¨‹æ ˆä¸ä¼šåœ¨ç¨‹åºå†…å­˜ä¸­åœç•™ï¼‰ã€‚</li><li>åœ¨è´Ÿè½½ä¸‹ä¸ä¼šæŸå®³å†…æ ¸ã€‚</li><li>å¼‚æ­¥åœ°è°ƒåº¦ä»»åŠ¡åˆ°è°ƒåº¦é˜Ÿåˆ—ä¸ä¼šå¯¼è‡´æ­»é”ã€‚</li><li>åœ¨èµ„æº contention çš„æ—¶å€™å¯ä»¥è‡ªç”±ä¼¸ç¼©ã€‚</li><li>æ¯”é”å’Œå…¶ä»–åŒæ­¥åŸè¯­æ›´é«˜æ•ˆã€‚</li></ul></li><li><p>æ“ä½œé˜Ÿåˆ—ç›¸å½“äºä¸€ä¸ªå¹¶å‘çš„è°ƒåº¦é˜Ÿåˆ—ã€‚å…¶æ‰§è¡Œé¡ºåºé™¤äº†é˜Ÿåˆ—çš„å…ˆè¿›å…ˆå‡ºå¤–ï¼Œä¸»è¦è¿˜è€ƒè™‘æ“ä½œå¯¹è±¡ä¹‹é—´çš„ä¾èµ–ã€‚</p></li><li><p>ç»æµ‹è¯•ï¼Œå¯¹äºå¼‚æ­¥é˜Ÿåˆ—ï¼Œæ— è®ºæ˜¯ä½¿ç”¨è°ƒåº¦é˜Ÿåˆ—è¿˜æ˜¯æ“ä½œé˜Ÿåˆ—ï¼Œæ‰§è¡Œä»»åŠ¡çš„é¡ºåºéƒ½ä¸èƒ½ä¾èµ–äºä»»åŠ¡å…¥é˜Ÿçš„é¡ºåºã€‚</p></li><li><p>OpenCLåªé€‚åˆå¹¶è¡Œå¤„ç†å¤§è§„æ¨¡æ•°æ®ï¼Œä¸é€‚åˆä¸€èˆ¬å¤šçº¿ç¨‹åœºæ™¯ã€‚</p></li><li><p>ä½¿ç”¨é˜Ÿåˆ—ç›¸æ¯”ç›´æ¥ä½¿ç”¨çº¿ç¨‹ï¼Œæœ€å¤§çš„ä¼˜åŠ¿æ˜¯å¯é¢„æµ‹æ€§ã€‚äºŒä½¿ç”¨çº¿ç¨‹åˆ™æ˜¯ä¸ºäº†è¿½æ±‚å®æ—¶æ‰§è¡Œã€‚</p></li></ul><p>ä½¿ç”¨æŠ€å·§ï¼š</p><ul><li>æé«˜æ•ˆç‡çš„æŠ€å·§ï¼ˆä»¥ä¸‹æŠ€å·§éƒ½è¦ç»è¿‡æ€§èƒ½æµ‹è¯•ï¼‰ï¼š<ul><li>æƒ³è¦æœ€å¿«ï¼Œå°±ç›´æ¥è®¡ç®—å€¼ï¼Œè¿™ä¼šç›´æ¥ä½¿ç”¨å¤„ç†å™¨å†…æ¶µé¢çš„å¯„å­˜å™¨å’Œç¼“å­˜ã€‚</li><li>å°½å¯èƒ½åœ°å¹¶å‘ã€‚</li><li>é¿å…ä½¿ç”¨é”ã€‚</li><li>å°½é‡ç”¨ç³»ç»ŸAPIã€‚</li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;è®¡ç®—æœºçš„æ—©æœŸï¼Œå•ä½æ—¶é—´å†…å®ƒå¯ä»¥åšçš„å·¥ä½œæ˜¯ç”± CPU çš„æ—¶é’Ÿé€Ÿåº¦å†³å®šçš„ã€‚ä½†éšç€æŠ€æœ¯çš„è¿›æ­¥ï¼Œå¤„ç†å™¨çš„è®¾è®¡å˜å¾—æ›´åŠ ç´§å‡‘ï¼Œçƒ­é‡å’Œå…¶ä»–ç‰©ç†é™åˆ¶å¼€å§‹é™åˆ¶å¤„ç†å™¨çš„æœ€å¤§æ—¶é’Ÿé€Ÿåº¦ã€‚äºæ˜¯ï¼ŒèŠ¯ç‰‡åˆ¶é€ å•†å¯»æ‰¾å…¶ä»–æ–¹æ³•æ¥æé«˜å…¶èŠ¯ç‰‡çš„æ€»æ€§èƒ½ã€‚ä»–ä»¬æœ€ç»ˆé€‰æ‹©çš„è§£å†³æ–¹æ¡ˆæ˜¯å¢åŠ æ¯ä¸ªèŠ¯ç‰‡ä¸Šçš„å¤„ç†å™¨å†…æ ¸æ•°é‡ã€‚é€šè¿‡å¢åŠ å†…æ ¸æ•°é‡ï¼Œå•ä¸ªèŠ¯ç‰‡å¯ä»¥åœ¨ä¸å¢åŠ CPUé€Ÿåº¦æˆ–æ”¹å˜èŠ¯ç‰‡å°ºå¯¸æˆ–çƒ­ç‰¹æ€§çš„æƒ…å†µä¸‹æ¯ç§’æ‰§è¡Œæ›´å¤šæŒ‡ä»¤ã€‚å”¯ä¸€çš„é—®é¢˜æ˜¯å¦‚ä½•åˆ©ç”¨è¿™äº›é¢å¤–çš„å†…æ ¸ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Concurrency Programming Guide" scheme="https://bqlin.github.io/tags/Concurrency-Programming-Guide/"/>
    
    <category term="å¤šçº¿ç¨‹" scheme="https://bqlin.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Concurrency Programming Guide</title>
    <link href="https://bqlin.github.io/posts/concurrency_pg_introduction/"/>
    <id>https://bqlin.github.io/posts/concurrency_pg_introduction/</id>
    <published>2021-09-08T09:39:58.000Z</published>
    <updated>2021-10-24T04:12:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä»‹ç»">ä»‹ç»</h1><p><a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008091-CH1-SW1">åŸæ–‡</a></p><p>å¹¶å‘æ˜¯å¤šä¸ªäº‹æƒ…åŒæ—¶å‘ç”Ÿçš„æ¦‚å¿µã€‚éšç€ CPU æ ¸æ•°çš„å¢åŠ ï¼Œå¼€å‘è€…éœ€è¦æ–°çš„æ–¹å¼å»åˆ©ç”¨å®ƒä»¬ã€‚å°½ç®¡åƒOS Xå’ŒiOSè¿™æ ·çš„æ“ä½œç³»ç»Ÿèƒ½å¤Ÿå¹¶è¡Œåœ°è¿è¡Œå¤šä¸ªç¨‹åºï¼Œä½†è¿™äº›ç¨‹åºå¤§å¤šåœ¨åå°è¿è¡Œï¼Œæ‰§è¡Œçš„ä»»åŠ¡å‡ ä¹ä¸éœ€è¦æŒç»­çš„å¤„ç†å™¨æ—¶é—´ã€‚å½“å‰çš„å‰å°ç¨‹åºæ‰æ˜¯æ—¢èƒ½å¸å¼•ç”¨æˆ·çš„æ³¨æ„åŠ›ï¼Œåˆèƒ½è®©è®¡ç®—æœºå¿™ç¢Œçš„ç¨‹åºã€‚å¦‚æœä¸€ä¸ªç¨‹åºæœ‰å¾ˆå¤šä»»åŠ¡è¦æ‰§è¡Œï¼Œä½†åªä¿æŒä¸€å°éƒ¨åˆ†å¯ç”¨çš„å†…æ ¸è¢«å ç”¨ï¼Œè¿™äº›é¢å¤–çš„å¤„ç†èµ„æºå°±è¢«æµªè´¹äº†ã€‚</p><span id="more"></span><p>ä»¥å‰ç¨‹åºå¼•å…¥å¤šçº¿ç¨‹éœ€è¦åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ã€‚ä¸å¹¸çš„æ˜¯å†™å¤šçº¿ç¨‹ä»£ç å¾ˆå…·æŒ‘æˆ˜ã€‚çº¿ç¨‹æ˜¯å¿…é¡»æ‰‹åŠ¨ç®¡ç†çš„åº•å±‚æŠ€æœ¯ã€‚è€ƒè™‘åˆ°ç³»ç»Ÿä¸åŒçš„è´Ÿè½½å’Œåº•å±‚ç¡¬ä»¶ï¼Œç¨‹åºçš„æœ€ä¼˜çº¿ç¨‹æ•°ä¼šåŠ¨æ€å˜åŒ–ï¼Œå®ç°ä¸€ä¸ªæ­£ç¡®çš„çº¿ç¨‹æ–¹æ¡ˆå˜å¾—å¼‚å¸¸å›°éš¾ã€‚å¦å¤–ï¼Œé€šå¸¸ä¸çº¿ç¨‹ä½¿ç”¨çš„åŒæ­¥æœºåˆ¶ä¼šå¢åŠ è½¯ä»¶è®¾è®¡çš„å¤æ‚æ€§å’Œé£é™©ï¼Œè€Œæ— æ³•ä¿è¯æ€§èƒ½çš„æé«˜ã€‚</p><p>ä¸ä¼ ç»Ÿçš„åŸºäºçº¿ç¨‹çš„ç³»ç»Ÿå’Œç¨‹åºç›¸æ¯”ï¼ŒOS Xå’ŒiOSéƒ½é‡‡ç”¨äº†ä¸€ç§æ›´åŠ å¼‚æ­¥çš„æ–¹æ³•æ¥æ‰§è¡Œå¹¶å‘ä»»åŠ¡ã€‚ç¨‹åºä¸éœ€è¦ç›´æ¥åˆ›å»ºçº¿ç¨‹ï¼Œè€Œåªéœ€è¦å®šä¹‰ç‰¹å®šçš„ä»»åŠ¡ï¼Œç„¶åè®©ç³»ç»Ÿæ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚é€šè¿‡è®©ç³»ç»Ÿç®¡ç†çº¿ç¨‹ï¼Œç¨‹åºè·å¾—äº†åŸå§‹çº¿ç¨‹ä¸å¯èƒ½è¾¾åˆ°çš„å¯æ‰©å±•æ€§æ°´å¹³ã€‚ç¨‹åºå¼€å‘äººå‘˜ä¹Ÿè·å¾—äº†ä¸€ä¸ªæ›´ç®€å•ã€æ›´æœ‰æ•ˆçš„ç¼–ç¨‹æ¨¡å‹ã€‚</p><p>æœ¬æ–‡æè¿°äº†åœ¨ç¨‹åºä¸­å®ç°å¹¶å‘åº”ä½¿ç”¨çš„æŠ€æœ¯å’Œå·¥è‰ºã€‚æœ¬æ–‡æè¿°çš„æŠ€æœ¯åœ¨OS Xå’ŒiOSä¸­éƒ½å¯ç”¨ã€‚</p><h2 id="å…³äºæœ¯è¯­çš„è¯´æ˜">å…³äºæœ¯è¯­çš„è¯´æ˜</h2><p>åœ¨è¿›å…¥å…³äºå¹¶å‘æ€§çš„è®¨è®ºä¹‹å‰ï¼Œæœ‰å¿…è¦å®šä¹‰ä¸€äº›ç›¸å…³çš„æœ¯è¯­ä»¥é˜²æ­¢æ··æ·†ã€‚å¯¹UNIXç³»ç»Ÿæˆ–è¾ƒæ—©çš„OS XæŠ€æœ¯æ¯”è¾ƒç†Ÿæ‚‰çš„å¼€å‘è€…å¯èƒ½ä¼šå‘ç°æœ¬æ–‡ä¸­çš„æœ¯è¯­â€œä»»åŠ¡â€ã€â€œè¿›ç¨‹â€å’Œâ€œçº¿ç¨‹â€çš„ç”¨æ³•æœ‰äº›ä¸åŒã€‚æœ¬æ–‡æ¡£ä»¥ä¸‹åˆ—æ–¹å¼ä½¿ç”¨è¿™äº›æœ¯è¯­ï¼š</p><ul><li>æœ¯è¯­<em>çº¿ç¨‹</em>æ˜¯ç”¨æ¥æŒ‡ä»£ç çš„ç‹¬ç«‹æ‰§è¡Œè·¯å¾„ã€‚OS Xä¸­çº¿ç¨‹çš„åº•å±‚å®ç°æ˜¯åŸºäºPOSIXçº¿ç¨‹APIçš„ã€‚</li><li>æœ¯è¯­<em>è¿›ç¨‹</em>æ˜¯æŒ‡ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒå¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ã€‚</li><li>æœ¯è¯­<em>ä»»åŠ¡</em>æ˜¯ç”¨æ¥æŒ‡éœ€è¦æ‰§è¡Œçš„å·¥ä½œçš„æŠ½è±¡æ¦‚å¿µã€‚</li></ul><p>å…³äºè¿™äº›æœ¯è¯­å’Œæœ¬æ–‡æ‰€ä½¿ç”¨çš„å…¶ä»–å…³é”®æœ¯è¯­çš„å®Œæ•´å®šä¹‰ï¼Œå¯å‚é˜…<a href=".%2F06%20Glossary.md">æœ¯è¯­è¡¨</a>ã€‚</p><h2 id="æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯»</h2><p>æœ¬æ–‡é‡ç‚¹ä»‹ç»äº†åœ¨ç¨‹åºä¸­å®ç°å¹¶å‘æ€§çš„é¦–é€‰æŠ€æœ¯ï¼Œå¹¶ä¸åŒ…æ‹¬çº¿ç¨‹çš„ä½¿ç”¨ã€‚å¦‚æœä½ éœ€è¦å…³äºä½¿ç”¨çº¿ç¨‹å’Œå…¶ä»–çº¿ç¨‹ç›¸å…³æŠ€æœ¯çš„ä¿¡æ¯ï¼Œå‚é˜…<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/Introduction/Introduction.html#//apple_ref/doc/uid/10000057i">Threading Programming Guide</a>ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ä»‹ç»&quot;&gt;ä»‹ç»&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008091-CH1-SW1&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å¹¶å‘æ˜¯å¤šä¸ªäº‹æƒ…åŒæ—¶å‘ç”Ÿçš„æ¦‚å¿µã€‚éšç€ CPU æ ¸æ•°çš„å¢åŠ ï¼Œå¼€å‘è€…éœ€è¦æ–°çš„æ–¹å¼å»åˆ©ç”¨å®ƒä»¬ã€‚å°½ç®¡åƒOS Xå’ŒiOSè¿™æ ·çš„æ“ä½œç³»ç»Ÿèƒ½å¤Ÿå¹¶è¡Œåœ°è¿è¡Œå¤šä¸ªç¨‹åºï¼Œä½†è¿™äº›ç¨‹åºå¤§å¤šåœ¨åå°è¿è¡Œï¼Œæ‰§è¡Œçš„ä»»åŠ¡å‡ ä¹ä¸éœ€è¦æŒç»­çš„å¤„ç†å™¨æ—¶é—´ã€‚å½“å‰çš„å‰å°ç¨‹åºæ‰æ˜¯æ—¢èƒ½å¸å¼•ç”¨æˆ·çš„æ³¨æ„åŠ›ï¼Œåˆèƒ½è®©è®¡ç®—æœºå¿™ç¢Œçš„ç¨‹åºã€‚å¦‚æœä¸€ä¸ªç¨‹åºæœ‰å¾ˆå¤šä»»åŠ¡è¦æ‰§è¡Œï¼Œä½†åªä¿æŒä¸€å°éƒ¨åˆ†å¯ç”¨çš„å†…æ ¸è¢«å ç”¨ï¼Œè¿™äº›é¢å¤–çš„å¤„ç†èµ„æºå°±è¢«æµªè´¹äº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="https://bqlin.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="Concurrency Programming Guide" scheme="https://bqlin.github.io/tags/Concurrency-Programming-Guide/"/>
    
    <category term="å¤šçº¿ç¨‹" scheme="https://bqlin.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegåŸºæœ¬APIï¼šæºç åˆ†æ</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_api_source_code_analysis/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_api_source_code_analysis/</id>
    <published>2021-09-08T08:02:57.000Z</published>
    <updated>2021-09-08T08:02:57.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æŸ¥æ‰¾ç¼–è§£ç å™¨">æŸ¥æ‰¾ç¼–è§£ç å™¨</h2><p><code>avcodec_find_decoder</code>å’Œ<code>avcodec_find_encoder</code> ä¸»è¦æ˜¯æŸ¥æ‰¾ FFmpeg çš„è§£ç å™¨å’Œç¼–ç å™¨ã€‚</p><p>avcodec_find_decoder å’Œ avcodec_find_encoder ä¸»è¦æ˜¯åˆ©ç”¨ AVCodecID æ¥æŸ¥æ‰¾ç¼–è§£ç å™¨ã€‚ å…¶å®è´¨æ˜¯éå†AVCodec é“¾è¡¨å¹¶ä¸”è·å¾—ç¬¦åˆAVCodecIDçš„å…ƒç´ ã€‚</p><h2 id="åˆå§‹åŒ–ioä¸Šä¸‹æ–‡">åˆå§‹åŒ–IOä¸Šä¸‹æ–‡</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avio_open2</span><span class="params">(AVIOContext **s, <span class="keyword">const</span> <span class="keyword">char</span> *url, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">const</span>  AVIOInterruptCB *int_cb, AVDictionary **options)</span></span>;</span><br></pre></td></tr></table></figure><p>avio_open2 ä¸»è¦å®ç°åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª AVIOContextï¼Œç”¨äºè®¿é—®ç”± url æŒ‡å®šæ–‡ä»¶ã€‚</p><p>å„ä¸ªå‚æ•°çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><code>AVIOContext **s</code>ï¼šå‡½æ•°è°ƒç”¨æˆåŠŸåï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ–è¯¥<code>AVIOContext</code>ç»“æ„ä½“ã€‚</li><li><code>const char *url</code>ï¼šè¾“å…¥è¾“å‡ºåè®®çš„åœ°å€ã€‚</li><li><code>int flags</code>ï¼šæ‰“å¼€åœ°å€çš„æ–¹å¼(åªè¯»ã€åªå†™ã€è¯»å†™)ã€‚AVIO_FLAG_READ/AVIO_FLAG_WRITE/AVIO_FLAG_READ_WRITE.</li><li><code>const AVIOInterruptCB *int_cb</code>ï¼šè°ƒç”¨å‡½æ•°ã€‚</li><li><code>AVDictionary **options</code>ï¼šä¸€èˆ¬ä¸ºNULLã€‚</li></ul><p>ä¸<code>avio_open2</code>ç›¸ä¼¼çš„è¿˜æœ‰<code>avio_open</code>å‡½æ•°ï¼Œ<code>avio_open</code>ä¼šè°ƒç”¨<code>avio_open2</code>ï¼Œå¹¶å°† int_cb å’Œ options è®¾ç½®ä¸º NULLã€‚</p><p><code>avio_open2</code>çš„è°ƒç”¨å‡½æ•°å…³ç³»å¦‚ä¸‹ï¼š</p><figure><img src="http://lazybing.github.io/images/avio_open2/avio_open2.png" alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><h2 id="åˆå§‹åŒ–ç¼–è§£ç ä¸Šä¸‹æ–‡">åˆå§‹åŒ–ç¼–è§£ç ä¸Šä¸‹æ–‡</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avcodec_open2</span><span class="params">(AVCodecContext *avctx, <span class="keyword">const</span> AVCodec *codec, AVDictionary **options)</span></span>;</span><br></pre></td></tr></table></figure><p><code>avcodec_open2</code>å‡½æ•°å®ç°çš„åŠŸèƒ½ä¸ºåˆ©ç”¨ç»™å®šçš„<code>AVCodec</code>ç»“æ„åˆå§‹åŒ–<code>AVCodecContext</code>ç»“æ„ã€‚</p><p>å‡½æ•°å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>avctx</code>ï¼šéœ€è¦åˆå§‹åŒ–çš„context.</li><li><code>codec</code></li><li><code>options</code></li><li>è¿”å›å€¼ï¼šå¦‚æœè¿”å›0ï¼Œæ­£ç¡®ã€‚å¤±è´¥åˆ™è¿”å›è´Ÿæ•°ã€‚</li></ul><p>è¯¥å‡½æ•°åˆ©ç”¨ç»™å®šçš„<code>AVCodec</code>ç»“æ„åˆå§‹åŒ–<code>AVCodecContext</code>ç»“æ„ï¼Œåœ¨ä½¿ç”¨è¯¥å‡½æ•°ä¹‹å‰ï¼Œ<code>AVCodecContext</code> å¿…é¡»å·²ç»ç”¨<code>avcodec_alloc_context3()</code>å‡½æ•°åˆ†é…å‡ºæ¥ã€‚</p><p><code>AVCodec</code>ç»“æ„åœ¨ä½¿ç”¨è¯¥å‡½æ•°ä¹‹å‰ï¼Œç”±<code>avcodec_find_decoder_by_name``avcodec_find_encoder_by_name</code> <code>avcodec_find_decoder</code>æˆ–<code>avcodec_find_encoder</code>æå‰å¾—åˆ°ã€‚</p><p>æ³¨æ„ï¼Œåœ¨æ­£å¼è§£ç ä¹‹å‰(æ¯”å¦‚ä½¿ç”¨<code>avcodec_decode_video2()</code>ä¹‹å‰)ï¼Œå¿…é¡»è°ƒç”¨<code>avcodec_open2</code>å‡½æ•°ã€‚</p><p><code>avcodec_open2</code>çš„é€»è¾‘éå¸¸ç®€å•ï¼Œé¦–å…ˆæ˜¯è¿›è¡Œä¸€äº›å‚æ•°æ£€æµ‹ã€ä¹‹åè°ƒåŠ¨<code>AVCodec</code>çš„initå‡½æ•°ã€‚å¤§æ¦‚æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>å„ç§å‡½æ•°å‚æ•°æ£€æµ‹ã€‚</li><li>å„ç§ç»“æ„ä½“åˆ†é…å†…å­˜ã€‚</li><li>å°†è¾“å…¥çš„<code>AVDictionary</code>å½¢å¼çš„é€‰é¡¹è®¾ç½®åˆ°<code>AVCodecContext</code>ã€‚</li><li>å…¶ä»–ä¸€äº›é›¶æ•£çš„æ£€æŸ¥ï¼Œæ£€æŸ¥è¾“å…¥å‚æ•°æ˜¯å¦ç¬¦åˆç¼–ç å™¨çš„è¦æ±‚ã€‚</li><li>è°ƒç”¨<code>AVCodec</code>çš„initå‡½æ•°åˆå§‹åŒ–å…·ä½“çš„è§£ç å™¨ã€‚</li></ul><p>æ­¤å¤„é‡ç‚¹åˆ†æè°ƒç”¨<code>AVCodec</code>çš„initå‡½æ•°å¤„ã€‚ ä»¥ HEVC è§£ç å™¨ä¸ºä¾‹ã€‚</p><h2 id="è¯»å–å‹ç¼©æ•°æ®åŒ…">è¯»å–å‹ç¼©æ•°æ®åŒ…</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">av_read_frame</span><span class="params">(AVFormatContext *s, AVPacket *pkt)</span></span>;</span><br></pre></td></tr></table></figure><p><code>av_read_frame</code>å‡½æ•°çš„ä½œç”¨æ˜¯è¿”å›æ–‡ä»¶ä¸­ä¿å­˜çš„æ•°æ®ã€‚å®ƒä¼šæ–‡ä»¶ä¸­ä¿å­˜çš„æ•°æ®åˆ†æˆä¸åŒçš„å¸§ï¼Œ æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿”å›ä¸€å¸§ã€‚æ³¨æ„ï¼Œè¯¥å‡½æ•°ä¸ä¼šå¿½ç•¥å¸§ä¸å¸§ä¹‹é—´æ— æ•ˆæ•°æ®(éå¸§æ•°æ®)ï¼Œç›®çš„æ˜¯ç»™è§£ç å™¨ æœ€å¤šçš„ä¿¡æ¯ç”¨äºè§£ç ã€‚</p><p>å¦‚æœ<code>pkt-&gt;buf</code>æ˜¯ NULLï¼ŒåŒ…ç›´åˆ°ä¸‹ä¸€æ¬¡è°ƒç”¨<code>av_read_frame</code>æˆ–<code>avformat_close_input</code>æ—¶éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚ ä¸éœ€è¦æ—¶ï¼ŒåŒ…å¿…é¡»é€šè¿‡<code>av_free_packet</code>é‡Šæ”¾ã€‚å¯¹äºè§†é¢‘ï¼Œ<code>packet</code>åªåŒ…å«ä¸€å¸§ï¼›å¯¹äºéŸ³é¢‘ï¼Œå¦‚æœæ¯å¸§æœ‰å›ºå®šå¤§å°(å¦‚ PCM æˆ– ADPCM æ•°æ®)ï¼Œ <code>packet</code>å¯ä»¥åŒ…å«å¤šä¸ªéŸ³é¢‘å¸§ï¼ˆå¿…é¡»æ˜¯æ•´æ•°å¸§ï¼‰ï¼Œå¦‚æœéŸ³é¢‘å¸§å¤§å°å¯å˜(å¦‚MPEG éŸ³é¢‘)ï¼Œå®ƒåªèƒ½åŒ…å«ä¸€å¸§æ•°æ®ã€‚</p><p><code>pkt-&gt;pts</code>ã€<code>pkt-&gt;dts</code>ã€<code>pkt-&gt;duration</code>éƒ½æ˜¯ä»¥<code>AVStream.time_base_units</code>ä¸ºå•ä½çš„ã€‚ å¦‚æœè§†é¢‘æ ¼å¼é‡ŒåŒ…å« B å¸§ï¼Œ<code>pkt-&gt;pts</code>å¯ä»¥æ˜¯<code>AV_NOPTS_VALUE</code>ï¼Œå› æ­¤å¦‚æœä¸è§£å‹ç¼©æ•°æ®ï¼Œæœ€å¥½æŸ¥çœ‹<code>pkt-&gt;dts</code>ã€‚</p><p>å¦‚æœå‡½æ•°è¿”å›0ï¼Œæ­£ç¡®ï¼›å°äº0ï¼Œåˆ™ä¸ºåˆ°æ–‡ä»¶å°¾æˆ–å‡ºé”™ã€‚</p><p>å‡½æ•°è°ƒç”¨å…³ç³»ï¼š</p><figure><img src="http://lazybing.github.io/images/av_read_frame/av_read_frame.png" alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><p><code>av_read_frame</code>å‡½æ•°ä¼šåˆ¤æ–­åœ¨æœªè§£ç ç¼“å­˜ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰æ•°æ®åˆ™è°ƒç”¨<code>read_from_packet_buffer</code>ã€‚</p><h2 id="æå–æµä¿¡æ¯">æå–æµä¿¡æ¯</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avformat_find_stream_info</span><span class="params">(AVFormatContext *ic, AVDictionary **options)</span></span>;</span><br></pre></td></tr></table></figure><p><code>avformat_find_stream_info</code>ä¸»è¦æ˜¯è¯»åª’ä½“æ–‡ä»¶çš„åŒ…(packets)ï¼Œç„¶åä»ä¸­æå–å‡ºæµçš„ä¿¡æ¯ã€‚ å¯¹äºæ²¡æœ‰å¤´éƒ¨ä¿¡æ¯çš„æ–‡ä»¶æ ¼å¼å°¤å…¶æœ‰ç”¨ï¼Œæ¯”å¦‚<code>MPEG</code>ã€‚æ–‡ä»¶çš„é€»è¾‘ä½ç½®ä¸ä¼šè¢«æ”¹å˜ï¼Œè¯»å–å‡ºæ¥ çš„åŒ…ä¼šè¢«ç¼“å­˜èµ·æ¥ä¾›ä»¥åå¤„ç†ã€‚</p><p>è¿”å›å€¼ï¼š&gt;=0â€“&gt;OK,æˆ–å‡ºé”™è¿”å›AVERROR_xxx</p><p>æ³¨æ„ï¼Œè¯¥å‡½æ•°å¹¶ä¸ä¿è¯èƒ½å¤Ÿæ‰“å¼€æ‰€æœ‰çš„ codecï¼Œå› æ­¤å°†options è®¾ç½®ä¸ºéNULLç”¨äºè¿”å›ä¸€äº›ä¿¡æ¯æ˜¯éå¸¸å¥½çš„è¡Œä¸ºã€‚</p><p>è°ƒç”¨å…³ç³»ï¼š</p><figure><img src="http://lazybing.github.io/images/avformat_find_stream_info/avformat_find_stream_info.png" alt="img" /><figcaption aria-hidden="true">img</figcaption></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æŸ¥æ‰¾ç¼–è§£ç å™¨&quot;&gt;æŸ¥æ‰¾ç¼–è§£ç å™¨&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;avcodec_find_decoder&lt;/code&gt;å’Œ&lt;code&gt;avcodec_find_encoder&lt;/code&gt; ä¸»è¦æ˜¯æŸ¥æ‰¾ FFmpeg çš„è§£ç å™¨å’Œç¼–ç å™¨ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegåŸºæœ¬APIï¼šå¸¸ç”¨æ“ä½œ</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_api/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_api/</id>
    <published>2021-09-08T00:26:29.000Z</published>
    <updated>2021-09-08T00:26:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>APIå¤„ç†å¥—è·¯ï¼š</p><ul><li>æ–¹æ³•ä¸€èˆ¬è¿”å›å€¼å°äº0è¡¨ç¤ºå¤±è´¥ã€‚</li><li>ä½¿ç”¨ä¸Šä¸‹æ–‡è¿æ¥å¤šä¸ªAPIã€‚<ul><li>ä¸Šä¸‹æ–‡åŒ…å«å¤§é‡ç›¸å…³ä¿¡æ¯ã€‚</li><li>ä¸Šä¸‹æ–‡ä¸€èˆ¬å¯¹åº”çš„åˆ›å»ºä¸é‡Šæ”¾æ–¹æ³•ï¼Œä¸”æ³¨é‡Šé‡Œæœ‰è¯´æ˜ï¼Œä¾‹å¦‚ï¼šopen-closeã€alloc-freeã€‚</li></ul></li><li>è¦å¤ç”¨ç»“æ„ä½“æ—¶ï¼Œè°ƒç”¨å¯¹åº”çš„unrefæ–¹æ³•ï¼Œä»¥é‡ç½®ä¿¡æ¯ã€‚</li><li>æ‰€æœ‰å‹ç¼©åŒ…ã€æœªå‹ç¼©å¸§æ“ä½œéƒ½è¦å¾ªç¯æ“ä½œã€‚</li></ul><h2 id="æ—¥å¿—ç³»ç»Ÿ">æ—¥å¿—ç³»ç»Ÿ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavuitl/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®è¾“å‡ºçš„æ—¥å¿—ç­‰çº§</span></span><br><span class="line">av_log_set_level(<span class="keyword">int</span> level);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“æ—¥å¿—ï¼Œå‚1ä¸€èˆ¬ä¸ºNULLï¼Œå‚2ï¼šAV_LOG_DEBUGç­‰å¸¸é‡</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">av_log</span><span class="params">(<span class="keyword">void</span>* avcl, <span class="keyword">int</span> level, <span class="keyword">const</span> <span class="keyword">char</span>* fmt, ...)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”™è¯¯ç è½¬è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> av_err2str(errnum) \</span></span><br><span class="line"><span class="meta">     av_make_error_string((char[AV_ERROR_MAX_STRING_SIZE])&#123;0&#125;, AV_ERROR_MAX_STRING_SIZE, errnum)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">char</span> *<span class="title">av_make_error_string</span><span class="params">(<span class="keyword">char</span> *errbuf, <span class="keyword">size_t</span> errbuf_size, <span class="keyword">int</span> errnum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    av_strerror(errnum, errbuf, errbuf_size);</span><br><span class="line">    <span class="keyword">return</span> errbuf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æµ">æµ</h2><h3 id="è·å–æµä¿¡æ¯">è·å–æµä¿¡æ¯</h3><p>è·å–æµä¿¡æ¯åŸºæœ¬æ˜¯åŸºäº<code>AVFormatContext</code>è¿›è¡Œè·å–çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æŸ¥æ˜¯å¦æ”¯æŒæ ¼å¼</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avformat_find_stream_info</span><span class="params">(AVFormatContext* ic, AVDictionary** options)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æŒ‡å®šç±»å‹çš„æµç´¢å¼•ï¼Œåªå…³å¿ƒå‰ä¸¤ä¸¤ä¸ªå‚æ•°å³å¯</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">av_find_best_stream</span><span class="params">(AVFormatContext* ic, <span class="keyword">enum</span> AVMediaType type, <span class="keyword">int</span> wanted_stream_nb, <span class="keyword">int</span> related_stream, AVCodec** decoder_ret, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°æ ¼å¼ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">av_dump_format</span><span class="params">(AVFormatContext* ic, <span class="keyword">int</span> index, <span class="keyword">const</span> <span class="keyword">char</span>* url, <span class="keyword">int</span> is_output)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="åŸºæœ¬æµæ“ä½œæ¡†æ¶">åŸºæœ¬æµæ“ä½œæ¡†æ¶</h3><ol type="1"><li>åˆ›å»ºå¹¶æ‰“å¼€è¾“å…¥ä¸Šä¸‹æ–‡ã€‚<code>avformat_open_input</code></li><li>æ£€æŸ¥è¾“å…¥æ ¼å¼ã€‚<code>avformat_find_stream_info</code>ã€<code>av_dump_format</code></li><li>æ ¹æ®è·¯å¾„åˆ›å»ºè¾“å‡ºä¸Šä¸‹æ–‡ã€‚<code>avformat_alloc_output_context2</code></li><li>åˆ›å»ºæµï¼Œå› ä¸ºä¸å‚ä¸ç¼–è§£ç è¿‡ç¨‹ï¼Œæ‰€ä»¥æ‹·è´ç¼–è§£ç å‚æ•°ã€‚`<code>avformat_new_stream</code>ã€<code>avcodec_parameters_copy</code>ã€<code>out_stream-&gt;codecpar-&gt;codec_tag = 0</code></li><li>æ£€æŸ¥è¾“å‡ºæ ¼å¼ã€‚<code>av_dump_format</code></li><li>æ‰“å¼€è¾“å‡ºIOã€‚<code>avio_open</code></li><li>å†™å…¥å¤´éƒ¨ã€‚<code>avformat_write_header</code></li><li>==ä»è¾“å…¥æµä¸­è¯»å–å¹¶å†™å…¥è¾“å‡ºæ•°æ®åŒ…ã€‚==</li><li>å†™å…¥å°¾éƒ¨ã€‚<code>av_write_trailer</code></li><li>é‡Šæ”¾ä¸Šé¢åˆ›å»ºçš„ä¸Šä¸‹æ–‡ã€‚<code>avformat_close_input</code>ã€<code>avio_close</code>ã€<code>avformat_free_context</code></li></ol><p>æµçš„æ“ä½œæŒ‰ç…§FFmpegçš„APIæµç¨‹å¤§å¤šåªéœ€è¦æ›´æ”¹é«˜äº®çš„æ­¥éª¤ï¼Œå…¶ä½™çš„åŸºæœ¬æ˜¯å›ºå®šæµç¨‹ã€‚æ•°æ®åŒ…è¯»å–ä¸å†™å…¥çš„è¿‡ç¨‹ä¸€èˆ¬æ˜¯è¿™æ ·çš„ï¼š</p><ol type="1"><li>åˆ›å»ºæ•°æ®åŒ…ç»“æ„ä½“ã€‚<code>av_packet_alloc</code></li><li>å¾ªç¯è¯»å–å¸§ï¼Œè¿›å…¥å¸§å¤„ç†ã€‚<code>av_read_frame</code><ol type="1"><li>å¤„ç†æ•°æ®åŒ…ç»†èŠ‚ï¼š<code>pkt.pts</code>ã€<code>pkt.dts</code>ã€<code>pkt.duration</code>ã€<code>pkt.pos</code></li><li>å†™å…¥ã€‚<code>av_interleaved_write_frame</code></li><li>å‡å°‘æ•°æ®åŒ…å¼•ç”¨ã€‚<code>av_packet_unref</code></li></ol></li><li>é‡Šæ”¾æ•°æ®åŒ…ç»“æ„ä½“ã€‚<code>av_packet_unref</code></li></ol><p>è¦ç‚¹ï¼š</p><h4 id="avformatcontext">AVFormatContext</h4><p>ä»è¾“å…¥URLå¾—å‡ºæ ¼å¼ä¿¡æ¯ï¼š</p><ol type="1"><li>å»ºç«‹è¾“å…¥æ ¼å¼ä¸Šä¸‹æ–‡ã€‚<code>avformat_open_input</code></li><li>æ£€æŸ¥æ ¼å¼æ˜¯å¦æ”¯æŒã€‚<code>avformat_find_stream_info</code>ã€<code>av_dump_format</code></li></ol><p>ä»è¾“å‡ºURLå¾—å‡ºæ ¼å¼ä¿¡æ¯ï¼š</p><ol type="1"><li>ä»è¾“å‡ºURLçŒœæµ‹å¾—å‡ºã€‚<code>avformat_alloc_output_context2</code></li></ol><h4 id="avstream">AVStream</h4><p>è¾“å…¥æµä¿¡æ¯æ˜¯è¾“å…¥æ ¼å¼ä¸Šä¸‹æ–‡çš„ä¿¡æ¯ï¼Œä¸”æ˜¯å®Œæ•´çš„ï¼š</p><ol type="1"><li>æ‰¾åˆ°æŒ‡å®šæ ¼å¼çš„æµç´¢å¼•ï¼š<code>av_find_best_stream</code></li><li>ç›´æ¥å–å‡ºï¼š<code>fmt_ctx-&gt;streams[audio_idx]</code></li><li>å¤–åŠ å¼‚æ­¥æ ¼å¼æ£€æŸ¥ï¼š<code>assert_condition(in_stream-&gt;codecpar-&gt;codec_type == AVMEDIA_TYPE_AUDIO, "åª’ä½“ç±»å‹ä¸åŒ¹é…");</code></li></ol><p>è¾“å‡ºæµä¿¡æ¯åˆ™æ˜¯è¦è‡ªå·±åˆ›å»ºçš„ï¼š</p><ol type="1"><li>æ ¹æ®è¾“å‡ºæ ¼å¼ä¸Šä¸‹æ–‡åˆ›å»ºè¾“å‡ºæµï¼š<code>avformat_new_stream</code></li><li>ä»è¾“å…¥æµæ‹·è´ç¼–è§£ç å‚æ•°åˆ°è¾“å‡ºæµï¼š<code>avcodec_parameters_copy</code></li></ol><h4 id="aviocontext">AVIOContext</h4><p>å­˜åœ¨è¾“å‡ºæ ¼å¼ä¸Šä¸‹æ–‡ä¸­ï¼Œåªéœ€è¦åœ¨å†™å…¥å‰åå¼€å¯å’Œå…³é—­å³å¯ã€‚<code>avio_open</code>ã€<code>avio_close</code>ã€‚</p><h4 id="avpacket">AVPacket</h4><ol type="1"><li>ä»è¾“å…¥æ ¼å¼ä¸Šä¸‹æ–‡è¯»å–æ•°æ®åŒ…ï¼š<code>av_read_frame</code></li><li>äº¤é”™å†™å…¥æ•°æ®åŒ…åˆ°è¾“å‡ºæ ¼å¼ä¸Šä¸‹æ–‡ï¼š<code>av_interleaved_write_frame</code></li></ol><h3 id="åº”ç”¨å¯¼å‡ºéŸ³é¢‘æµè§†é¢‘æµ">åº”ç”¨ï¼šå¯¼å‡ºéŸ³é¢‘æµ/è§†é¢‘æµ</h3><p>å¯ä»¥ç”¨ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>è¯»å–æ•°æ®åŒ…ï¼Œå†™å…¥æ•°æ®åŒ…åˆ°æ–‡ä»¶ï¼Œè¡¥å……æ–‡ä»¶å¤´ï¼ˆè¿™é‡Œå­˜åœ¨è¦è‡ªå·±å®ç°æ–‡ä»¶å¤´çš„é€»è¾‘ï¼‰ã€‚</li><li>èµ°FFmpegæ•´ä¸ªæµç¨‹ã€‚</li></ul><p>åœ¨ä»¥ä¸Šçš„åŸºæœ¬æµç¨‹ä¸Šåšä¿®æ”¹ï¼š</p><ul><li>è·å–æŒ‡å®šåª’ä½“ç±»å‹ï¼Œå¹¶è·å–è¾“å…¥æµã€‚<ol type="1"><li><code>av_find_best_stream</code> -&gt; stream_id</li><li>in_stream = <code>fmt_ctx-&gt;streams[stream_idx]</code></li></ol></li><li>å¾ªç¯è¯»å–å¸§ï¼Œåªå¤„ç†stream_idxåŒ¹é…çš„æ•°æ®åŒ…ã€‚</li></ul><h3 id="åº”ç”¨æ—¶é—´è£å‰ª">åº”ç”¨ï¼šæ—¶é—´è£å‰ª</h3><ul><li>è¯»å–æ•°æ®åŒ…ä¹‹å‰è¿›è¡Œè·³è½¬ï¼Œå¹¶è·å–è·³è½¬åptsã€dtsã€‚<code>av_seek_frame</code></li><li>è¯»å–æ•°æ®åŒ…æ—¶ï¼š<ul><li>å‡å»èµ·å§‹çš„ptsã€dtsã€‚</li><li>ä¸å¤„ç†ç»“æŸæ—¶é—´ä¹‹åçš„æ•°æ®åŒ…ã€‚<code>av_q2d(in_stream-&gt;time_base) * pts &lt;= end_time</code></li></ul></li></ul><h2 id="ç¼–è§£ç ">ç¼–è§£ç </h2><h3 id="ç¼–ç ">ç¼–ç </h3><p>åŸºæœ¬æ­¥éª¤ï¼š</p><ol type="1"><li>æ‰“å¼€ç¼–ç å™¨ã€‚<code>avcodec_find_encoder_by_name</code></li><li>è®¾ç½®ç¼–ç å‚æ•°ã€‚é¡»æ‰‹åŠ¨è®¾ç½®ï¼Œå› ä¸ºæ²¡æœ‰å‚ç…§çš„æ¥æºã€‚</li><li>æ‰“å¼€ç¼–ç å™¨ã€‚<code>avcodec_open2</code></li><li>ç¼–ç ã€‚<code>avcodec_encode_video2</code></li></ol><p>å…·ä½“æ­¥éª¤ï¼š</p><ol type="1"><li>æŸ¥è¯¢ç¼–ç å™¨ï¼Œå¹¶åˆ›å»ºç¼–ç ä¸Šä¸‹æ–‡ã€‚<code>avcodec_find_encoder_by_name</code>ã€<code>avcodec_alloc_context3</code></li><li>è®¾ç½®ç¼–ç å‚æ•°ã€‚</li><li>æ‰“å¼€ç¼–ç å™¨ã€‚<code>avcodec_open2</code></li><li>åˆ›å»ºæ–‡ä»¶ã€AVFrameå¹¶æŠŠç¼–ç ä¸Šä¸‹æ–‡çš„å‚æ•°è®¾ç½®åˆ°AVFrameä¸­ã€‚</li><li>AVFrameåˆ†é…ç¼“å†²åŒºç©ºé—´ã€‚<code>av_frame_get_buffer</code></li><li>ç¼–ç å¹¶å†™å…¥æ•°æ®ã€‚<ol type="1"><li>å‘é€å¸§ã€‚<code>avcodec_send_frame</code></li><li>å¾ªç¯æ¥æ”¶æ•°æ®åŒ…ï¼Œå¹¶å†™å…¥æ–‡ä»¶ã€‚<code>avcodec_send_frame</code>ã€<code>fwrite</code></li></ol></li><li>ç¼–ç ç©ºçš„AVFrameä»¥åˆ·æ–°ç¼–ç å™¨ã€‚</li><li>æŒ‰éœ€å†™å…¥ç»“æŸç ã€‚</li><li>å…³é—­æ–‡ä»¶ã€é‡Šæ”¾ç›¸å…³èµ„æºã€‚</li></ol><p>ç¼–ç ç»†èŠ‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encode_to_file</span><span class="params">(AVCodecContext* enc_ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                           AVFrame* frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                           AVPacket* pkt,</span></span></span><br><span class="line"><span class="params"><span class="function">                           FILE* outfile)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">if</span> (!!frame) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">&quot;Send frame %3&quot;</span> PRId64 <span class="string">&quot;\n&quot;</span>, frame-&gt;pts);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = avcodec_send_frame(enc_ctx, frame);</span><br><span class="line">    assert_errnum(ret, <span class="string">&quot;å‘é€ç¼–ç å¸§å¤±è´¥&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ret &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        ret = avcodec_receive_packet(enc_ctx, pkt);</span><br><span class="line">        <span class="keyword">if</span> (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        assert_errnum(ret, <span class="string">&quot;ç¼–ç å¤±è´¥&quot;</span>);</span><br><span class="line"></span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">&quot;Write frame %3&quot;</span> PRId64 <span class="string">&quot; (size=%5d)\n&quot;</span>,</span><br><span class="line">               pkt-&gt;pts, pkt-&gt;size);</span><br><span class="line">        fwrite(pkt-&gt;data, <span class="number">1</span>, pkt-&gt;size, outfile);</span><br><span class="line">        av_packet_unref(pkt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šè¿™é‡Œæ˜¯ç›´æ¥æŠŠç¼–ç åçš„æ•°æ®åŒ…æ•°æ®ç›´æ¥å†™åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶æ²¡æœ‰å†™å¤´å°¾ã€‚å³æ²¡æœ‰ä½¿ç”¨æ ¼å¼ä¸Šä¸‹æ–‡çš„AVIOContextã€‚</p><p>è¦ç‚¹ï¼š</p><h4 id="avcodec">AVCodec</h4><p>é€šè¿‡idå’Œåç§°æŸ¥æ‰¾ï¼Œåç»­é€šè¿‡AVCodecContextè¿›è¡Œç®¡ç†ã€‚<code>avcodec_find_encoder_by_name</code></p><h4 id="avcodeccontext">AVCodecContext</h4><ol type="1"><li>é€šè¿‡AVCodecåˆ›å»ºï¼š<code>avcodec_alloc_context3</code></li><li>é‡ç‚¹åœ¨äºæ ¼å¼é…ç½®ï¼Œéƒ½è®¾ç½®åˆ°è¯¥ä¸Šä¸‹æ–‡ä¸­ã€‚</li><li>æ‰“å¼€åæ‰èƒ½ä½¿ç”¨ç¼–è§£ç å™¨ï¼š<code>avcodec_open2</code></li><li>ä½¿ç”¨å®Œæ¯•åé‡Šæ”¾ï¼š<code>avcodec_free_context</code></li></ol><p>ç¼–ç ï¼Œä¸¤å±‚å¾ªç¯ï¼š</p><ol type="1"><li>ç»™ç¼–ç å™¨ä¸Šä¸‹æ–‡å¡å¸§ï¼š<code>avcodec_send_frame</code>ï¼›</li><li>å¾ªç¯ä»ç¼–ç å™¨ä¸Šä¸‹æ–‡è·å–æ•°æ®åŒ…ï¼š<code>avcodec_receive_packet</code></li></ol><h4 id="avframe">AVFrame</h4><ul><li>åˆ›å»ºä¸é‡Šæ”¾ï¼š<code>av_frame_alloc</code>ã€<code>av_frame_free</code></li><li>è‹¥æ˜¯è‡ªå·±å¡«å……æ•°æ®ï¼Œåˆ™è¦å…ˆä»codecä¸Šä¸‹æ–‡è·å–æ ¼å¼è®¾ç½®ï¼š<code>pix_fmt</code>ã€<code>width</code>ã€<code>height</code></li><li>å¡«å……æ•°æ®å‰è¦åˆ†é…ç©ºé—´ï¼š<code>av_frame_get_buffer</code></li><li>å¡«å……æ•°æ®å‰è¦ç¡®è®¤å¸§æ˜¯å¦å¯å†™å…¥ï¼š<code>av_frame_make_writable</code></li></ul><p>è®¾ç½®äº†æ ¼å¼å†³å®šäº†åˆ†é…ç©ºé—´çš„å¤§å°ä»¥åŠåç»­å¡«å……æ•°æ®çš„æ–¹å¼ã€‚</p><h3 id="è§£ç ">è§£ç </h3><p>åŸºæœ¬æ­¥éª¤ï¼š</p><ol type="1"><li>æŸ¥æ‰¾è§£ç å™¨ã€‚<code>avcodec_find_decoder</code></li><li>ä»è¾“å…¥æ‹·è´ç›¸å…³è§£ç å‚æ•°ã€‚<code>avcodec_parameters_to_context</code></li><li>æ‰“å¼€è§£ç å™¨ã€‚<code>avcodec_open2</code></li><li>è§£ç ã€‚<code>avcodec_decode_video2</code></li></ol><p>å…·ä½“æ­¥éª¤ï¼š</p><ol type="1"><li>æ‰“å¼€æ–‡ä»¶ã€‚<code>avformat_open_input</code></li><li>æ£€æŸ¥æ ¼å¼ï¼Œè·å–è§†é¢‘æµã€‚<code>avformat_find_stream_info</code>ã€<code>av_dump_format</code>ã€<code>av_find_best_stream</code></li><li>æ ¹æ®è¯»å–çš„æµä¿¡æ¯æŸ¥è¯¢ç¼–è§£ç å™¨å¹¶åˆ›å»ºå¯¹åº”ä¸Šä¸‹æ–‡ã€‚<code>avcodec_find_decoder</code>ã€<code>avcodec_alloc_context3</code></li><li>ä»è¯»å–çš„æµä¿¡æ¯ä¸­æ‹·è´ç›¸å…³çš„ç¼–è§£ç å™¨å‚æ•°ã€‚<code>avcodec_parameters_to_context</code></li><li>æ‰“å¼€ç¼–è§£ç å™¨ã€‚<code>avcodec_open2</code></li><li>è‹¥è¦è½¬æ¢å›¾åƒæ ¼å¼ï¼Œåˆ™åˆ›å»º<code>SwsContext</code>ã€‚</li><li>å¾ªç¯è¯»å–å¸§ã€‚<code>av_read_frame</code></li><li>å¾ªç¯è§£ç ã€‚<ol type="1"><li>å‘é€æ•°æ®åŒ…ã€‚<code>avcodec_send_packet</code></li><li>å¾ªç¯è·å¾—è§£ç å¸§ã€‚<code>avcodec_receive_frame</code></li></ol></li></ol><p>è§£ç ç»†èŠ‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(AVCodecContext *dec_ctx, AVFrame *frame, AVPacket *pkt,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="keyword">const</span> <span class="keyword">char</span> *filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€æ•°æ®åŒ…</span></span><br><span class="line">    ret = avcodec_send_packet(dec_ctx, pkt);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error sending a packet for decoding\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ret &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å¾—è§£ç å¸§</span></span><br><span class="line">        ret = avcodec_receive_frame(dec_ctx, frame);</span><br><span class="line">        <span class="keyword">if</span> (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error during decoding\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;saving frame %3d\n&quot;</span>, dec_ctx-&gt;frame_number);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¸§å¤„ç†ä¸šåŠ¡</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ç¼–ç ä¸åŒï¼Œè§£ç çš„å‚æ•°æ˜¯ç”±ä¹‹å‰ç¼–ç çš„å†³å®šçš„ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥æŠŠè¯»å–çš„æµä¸­æ‹·è´ç¼–ç å™¨å‚æ•°ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;APIå¤„ç†å¥—è·¯ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ–¹æ³•ä¸€èˆ¬è¿”å›å€¼å°äº0è¡¨ç¤ºå¤±è´¥ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ä¸Šä¸‹æ–‡è¿æ¥å¤šä¸ªAPIã€‚
&lt;ul&gt;
&lt;li&gt;ä¸Šä¸‹æ–‡åŒ…å«å¤§é‡ç›¸å…³ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;li&gt;ä¸Šä¸‹æ–‡ä¸€èˆ¬å¯¹åº”çš„åˆ›å»ºä¸é‡Šæ”¾æ–¹æ³•ï¼Œä¸”æ³¨é‡Šé‡Œæœ‰è¯´æ˜ï¼Œä¾‹å¦‚ï¼šopen-closeã€alloc-freeã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;è¦å¤ç”¨ç»“æ„ä½“æ—¶ï¼Œè°ƒç”¨å¯¹åº”çš„unrefæ–¹æ³•ï¼Œä»¥é‡ç½®ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;li&gt;æ‰€æœ‰å‹ç¼©åŒ…ã€æœªå‹ç¼©å¸§æ“ä½œéƒ½è¦å¾ªç¯æ“ä½œã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>KVO</title>
    <link href="https://bqlin.github.io/posts/kvo/"/>
    <id>https://bqlin.github.io/posts/kvo/</id>
    <published>2021-07-27T04:21:29.000Z</published>
    <updated>2021-07-27T04:21:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>KVOç”¨äºé€»è¾‘éš”ç¦»å¯¹è±¡ä¹‹é—´çš„ç›‘å¬ï¼Œæ”¯æŒä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šçš„å±æ€§ç›‘å¬ã€‚è¿™é‡Œçš„ä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šæ˜¯é’ˆå¯¹ç›‘å¬çš„å±æ€§çš„ï¼Œå³æ—¢å¯ä»¥ç›‘å¬å•ä¸ªå±æ€§ï¼Œä¹Ÿå¯ä»¥ç›‘å¬é›†åˆå±æ€§ã€‚</p><p>åœ¨OCä¸­ï¼Œæ‰€æœ‰NSObjectå­ç±»çš„æ‰€æœ‰å±æ€§ï¼ˆåŒ…æ‹¬è®¡ç®—å±æ€§ï¼‰éƒ½æ”¯æŒKVOï¼›è€Œåœ¨Swiftä¸­ï¼Œåªæœ‰åœ¨<code>@objc dynamic</code>ä¿®é¥°çš„å±æ€§ï¼ˆåŒ…æ‹¬è®¡ç®—å±æ€§ï¼‰æ‰æ”¯æŒKVOï¼Œå³ä½¿ç”¨<code>@objc dynamic</code>ä¿®é¥°çš„å±æ€§ä¸OCè¡Œä¸ºä¸€è‡´ã€‚</p><p>KVCå’ŒKVOéƒ½å±äºé”®å€¼ç¼–ç¨‹ï¼Œè€Œä¸”åº•å±‚å®ç°æœºåˆ¶éƒ½æ˜¯<strong>isa-swizzing</strong>ã€‚</p><p>KVOå’ŒNSNotificationCenteréƒ½æ˜¯iOSè§‚å¯Ÿç€æ¨¡å¼çš„ä¸€ç§å®ç°ã€‚KVOå¯¹è¢«ç›‘å¬å¯¹è±¡æ— ä¾µå…¥æ€§ï¼Œå³æ— éœ€ä¿®æ”¹ä»£ç å³å¯æ”¯æŒç›‘å¬ã€‚</p><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2><p>æ³¨å†Œç›‘å¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[bankInstance addObserver:personInstance forKeyPath:@&quot;accountBalance&quot; options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:NULL];</span><br></pre></td></tr></table></figure><p><code>bankInstance</code>æ˜¯å˜æ›´å‘å‡ºçš„å¯¹è±¡ã€‚<code>personInstance</code>æ˜¯å“åº”å˜æ›´çš„å¯¹è±¡ã€‚<code>@"accountBalance"</code>æ˜¯<code>bankInstance</code>çš„key pathã€‚</p><p>é€‰é¡¹æ˜¯å¤šé€‰çš„ï¼Œå½±å“changeå­—å…¸å†…å®¹å’Œç”Ÿæˆé€šçŸ¥çš„æ–¹å¼ã€‚</p><ul><li>newï¼šchangeå­—å…¸åŒ…å«æ–°å€¼</li><li>oldï¼šchangeå­—å…¸åŒ…å«æ—§å€¼</li><li>initialï¼šæ³¨å†Œç›‘å¬æ—¶å³å‘é€å˜æ›´é€šçŸ¥</li><li>priorï¼šåœ¨å˜æ›´é€šçŸ¥å‰å‘é€ä¸€æ¬¡å˜æ›´å‰çš„é€šçŸ¥ï¼Œå³æ¯ä¸ªå˜æ›´ä¸¤æ¬¡é€šçŸ¥ï¼Œä¸€ä¸ªwillChangeï¼Œä¸€ä¸ªdidChange</li></ul><p>changeå­—å…¸çš„é”®ï¼š</p><ul><li>kindï¼šæ”¹å˜ç±»å‹<ul><li>settingï¼šå¯¹è±¡æˆ–é›†åˆèµ‹å€¼æ›¿æ¢</li><li>insertionï¼šå¯¹è±¡æ’å…¥åˆ°é›†åˆå±æ€§ä¸­</li><li>removalï¼šå¯¹è±¡ä»é›†åˆä¸­ç§»é™¤</li><li>replacementï¼šå¯¹è±¡ä»é›†åˆä¸­æ›¿æ¢</li></ul></li><li>newï¼šæ–°å€¼</li><li>oldï¼šæ—§å€¼</li><li>indexesï¼šæ’å…¥/ç§»é™¤/æ›¿æ¢å¯¹è±¡çš„ç´¢å¼•</li><li>priorï¼šæ ‡è¯†è¯¥é€šçŸ¥æ˜¯willChangeçš„ï¼Œå¦åˆ™æ˜¯didChangeçš„</li></ul><p>newã€oldå¯ä»¥æ—¶å•ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ—¶å¯¹è±¡é›†åˆï¼Œè¡¨ç¤ºé›†åˆæ—¶è¡¨ç¤ºç§»é™¤/æ›¿æ¢çš„å¯¹è±¡ã€‚</p><p>ç§»é™¤ç›‘å¬å¯åœ¨è¿™ä¸¤ä¸ªæ—¶æœºå®Œæˆï¼š</p><ul><li>ä¸éœ€è¦ç›‘å¬æ—¶ã€‚</li><li>è¢«è§‚å¯Ÿå¯¹è±¡ã€è§‚å¯Ÿè€…å¯¹è±¡é”€æ¯æ—¶ã€‚è¢«è§‚å¯Ÿå¯¹è±¡ä¸è§‚å¯Ÿè€…å¯¹è±¡å¸¸å¸¸å…·æœ‰ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚</li></ul><p>ä½¿ç”¨æ³¨æ„ï¼š</p><ul><li><p>ç§»é™¤ç›‘å¬çš„è°ƒç”¨è§’è‰²ä¸æ³¨å†Œç›‘å¬ä¿æŒä¸€è‡´ã€‚</p></li><li><p>å¤šæ¬¡æ³¨å†Œç›‘å¬å¯¼è‡´å¤šæ¬¡å“åº”ã€‚didChnageå˜æ›´é€šçŸ¥çš„é¡ºåºä¸æ³¨å†Œé¡ºåºç›¸åï¼Œå³ä»¥å…ˆè¿›åå‡ºçš„é¡ºåºè°ƒç”¨ã€‚</p></li><li><p>æ³¨å†Œç›‘å¬ä¸ç§»é™¤ç›‘å¬å¿…é¡»ä¿æŒé…å¯¹ï¼Œå¤šäº†å°‘äº†éƒ½ä¼šå¯¼è‡´å¼‚å¸¸å´©æºƒã€‚ä½†iOS 11ä»¥ä¸Šä¸ä¼šå´©æºƒã€‚</p></li></ul><h3 id="æ‰‹åŠ¨å¤„ç†å˜æ›´é€šçŸ¥">æ‰‹åŠ¨å¤„ç†å˜æ›´é€šçŸ¥</h3><ol type="1"><li>åœ¨è¢«è§‚å¯Ÿå¯¹è±¡ï¼ˆå¦‚ä¸Šé¢çš„BankObjectï¼‰é‡å†™<code>+automaticallyNotifiesObserversForKey:</code>æ–¹æ³•ï¼ˆé»˜è®¤è¿”å›YESï¼Œå³é»˜è®¤æ‰€æœ‰é”®å€¼éƒ½ä¼šé€šçŸ¥å˜æ›´ï¼‰ï¼Œå®šä¹‰éœ€è¦æ‰‹åŠ¨æ§åˆ¶çš„å±æ€§ã€‚è®°å¾—åœ¨ä¸éœ€è¦ä¿®æ”¹çš„keyä¸Šè¿”å›superæ–¹æ³•ã€‚</li><li>åœ¨éœ€è¦å‘é€é€šçŸ¥çš„åœ°æ–¹è°ƒç”¨ï¼š<ul><li>ä¸€å¯¹ä¸€ï¼š<code>willChangeValueForKey:</code>ã€<code>didChangeValueForKey:</code></li><li>æœ‰åºä¸€å¯¹å¤šï¼š<code>willChange:valuesAtIndexes:forKey:</code>ã€<code>didChange:valuesAtIndexes:forKey:</code></li><li>æ— åºä¸€å¯¹å¤šï¼š<code>willChangeValueForKey:withSetMutation:usingObjects:</code>ã€<code>didChangeValueForKey:withSetMutation:usingObjects:</code></li></ul></li></ol><p>å¦‚æœæ²¡æœ‰é‡å†™ç›¸å…³é€šçŸ¥æ–¹æ³•ï¼Œåˆ™åªä¼šåœ¨initialé€‰é¡¹ç”Ÿæ•ˆã€‚</p><p>æ‰‹åŠ¨å¤„ç†å˜æ›´é€šçŸ¥çš„åº”ç”¨åœºæ™¯ï¼š</p><ul><li>ç­›é€‰é€šçŸ¥ï¼Œå¦‚å»é‡ã€æ§åˆ¶é€šçŸ¥å‘é€æ—¶æœºã€‚</li><li>å¤šä¸ªé”®çš„é€šçŸ¥ä¸€èµ·å‘é€ã€‚</li></ul><h3 id="æ³¨å†Œä¾èµ–é”®">æ³¨å†Œä¾èµ–é”®</h3><p>éœ€è¦åœ¨è¢«è§‚å¯Ÿå¯¹è±¡ï¼ˆå¦‚ä¸Šé¢çš„BankObjectï¼‰é‡å†™<code>+keyPathsForValuesAffectingValueForKey:</code>æ–¹æ³•æˆ–<code>+keyPathsForValuesAffecting&lt;Key&gt;</code>æ–¹æ³•ï¼Œè¿”å›ç»™å®škeyä¾èµ–çš„key pathé›†åˆã€‚è®°å¾—åœ¨ä¸éœ€è¦ä¿®æ”¹çš„keyä¸Šè¿”å›superæ–¹æ³•ã€‚</p><p>æ³¨æ„ï¼š<code>+keyPathsForValuesAffecting&lt;Key&gt;</code>æ–¹æ³•åœ¨Swiftä¸­è¦å£°æ˜ä¸º<code>@objc</code>ã€‚å¦åˆ™ä¸ä¼šè¯†åˆ«ã€‚è¿™ç§æ–¹æ³•è¿˜å¯ä»¥ç”¨äºåœ¨åˆ†ç±»æ·»åŠ ä¾èµ–é”®ã€‚</p><h3 id="æ³¨å†Œé›†åˆç›‘å¬">æ³¨å†Œé›†åˆç›‘å¬</h3><p>å¯¹ä¸å¯å˜é›†åˆé‡‡ç”¨ä¸€å¯¹ä¸€çš„å¯¹è±¡èµ‹å€¼æ–¹å¼æ›´æ–°ï¼Œå¯¹äºå¯å˜é›†åˆï¼Œè®¿é—®é›†åˆæ—¶ï¼Œä¸èƒ½ç›´æ¥è®¿é—®å¯¹åº”å±æ€§ï¼Œéœ€è¦ä½¿ç”¨<code>mutableArrayValueForKey:</code>ç±»ä¼¼çš„æ–¹æ³•å–å‡ºé›†åˆï¼Œå¯¹å–å‡ºçš„é›†åˆè¿›è¡Œå¢åˆ æ”¹éƒ½ä¼šå‡ºå‘å˜æ›´é€šçŸ¥ã€‚</p><p>é›†åˆæ³¨å†Œä¾èµ–é”®æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦ä½¿ç”¨KVCçš„æ–¹å¼ã€‚</p><h3 id="æ–°ç‰¹æ€§ä¸å‘">æ–°ç‰¹æ€§ä¸å‘</h3><p>Swifté‡æ–°å°è£…äº†æ³¨å†Œå’Œç§»é™¤ç›‘å¬çš„æ–¹å¼ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨å†Œä¸å–æ¶ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">observe</span>&lt;<span class="type">Value</span>&gt;(<span class="keyword">_</span> <span class="params">keyPath</span>: <span class="type">KeyPath</span>&lt;_KeyValueCodingAndObserving, <span class="type">Value</span>&gt;, <span class="params">options</span>: <span class="type">NSKeyValueObservingOptions</span> <span class="operator">=</span> [], <span class="params">changeHandler</span>: <span class="keyword">@escaping</span> (_KeyValueCodingAndObserving, <span class="type">NSKeyValueObservedChange</span>&lt;<span class="type">Value</span>&gt;) -&gt; <span class="type">Void</span>)</span> -&gt; <span class="type">NSKeyValueObservation</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">invalidate</span>()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨</span></span><br><span class="line">weather.observe(\.text, options: [.initial, .new, .old, .prior], changeHandler: printSwiftKVOReponse)</span><br></pre></td></tr></table></figure><p>iOS 11ä»¥ä¸‹ä½¿ç”¨æ—¶ï¼Œéœ€è¦ä¸»åŠ¨ç½®ç©ºNSKeyValueObservationæˆ–è°ƒç”¨<code>invalidate</code>æ–¹æ³•ã€‚</p><p>Swiftçš„KVOæ–¹å¼å¼±åŒ–äº†observerçš„å­˜åœ¨ï¼Œè€Œæ˜¯ä½¿ç”¨blockæ¥æ”¶å˜æ›´é€šçŸ¥ã€‚å¹¶è¿”å›ä¸€ä¸ªtokenï¼Œç”¨tokenè¿›è¡Œå–æ¶ˆæ³¨å†Œã€‚è¿›è€Œæ›¿ä»£åŸæœ‰çš„æ³¨å†Œä¸å–æ¶ˆç›‘å¬çš„æ–¹å¼ã€‚è€Œå…¶ä»–æ–¹æ³•observingå¯¹è±¡çš„æ–¹æ³•åŸºæœ¬ä¸å˜ã€‚</p><p>å¦å¤–<code>@objc dynamic</code>åªæ”¯æŒä¸OCå…±ç”¨çš„ç±»å‹ï¼ŒåƒSwiftçš„æšä¸¾ã€ç»“æ„ä½“ã€å…ƒç»„éƒ½ä¸æ”¯æŒã€‚</p><p>ç›‘å¬OCçš„æšä¸¾ç±»å‹è¿˜ä¼šå‡ºé—®é¢˜ï¼Œå¯¼è‡´changeçš„æ‰€æœ‰å€¼éƒ½ä¸ºç©ºï¼Œè€Œä½¿ç”¨ä¼ ç»Ÿçš„æ³¨å†Œç›‘å¬æ–¹å¼æ˜¯æ­£å¸¸çš„ã€‚</p><p>å³ä½¿æµ‹è¯•ä¸­ç›‘å¬å¯é€‰ç±»å‹çš„å±æ€§ä¹Ÿä¼šå¯¼è‡´ä¸Šè¿°é—®é¢˜ã€‚</p><h2 id="kvoå®ç°åŸç†">KVOå®ç°åŸç†</h2><p>ä½¿ç”¨runtimeåˆ›å»ºè¢«è§‚å¯Ÿå¯¹è±¡çš„å­ç±»ï¼Œé‡å†™sttterï¼Œé™„åŠ KVOé€šçŸ¥é€»è¾‘ï¼Œç„¶åæŠŠ<code>isa</code>æŒ‡é’ˆæŒ‡å‘åˆ›å»ºçš„å­ç±»å¹¶é‡å†™ç›¸å…³æ–¹æ³•ï¼Œå®ç°å¯¹åŸæœ¬å¯¹è±¡çš„æ›¿æ¢ã€‚</p><p>åœ¨è¿è¡Œæ—¶æ ¹æ®åŸç±»åˆ›å»ºä¸€ä¸ªä¸­é—´ç±»ï¼Œè¿™ä¸ªä¸­é—´ç±»æ˜¯åŸç±»çš„å­ç±»ï¼Œå¹¶åŠ¨æ€ä¿®æ”¹å½“å‰å¯¹è±¡çš„isaæŒ‡å‘ä¸­é—´ç±»ï¼Œå¹¶å°†classæ–¹æ³•é‡å†™ï¼Œè¿”å›åŸç±»çš„Classã€‚å½“ä¿®æ”¹å®ä¾‹å¯¹è±¡å±æ€§æ—¶ï¼Œä¼šè°ƒç”¨Foundationçš„<code>_NSSetXXXValueAndNotify</code>å‡½æ•°ï¼Œå‡½æ•°å…ˆè°ƒç”¨<code>willChangeValueForKey:</code>ï¼Œç„¶åè°ƒç”¨çˆ¶ç±»åŸæ¥çš„setteræ–¹æ³•ä¿®æ”¹å€¼ï¼Œæœ€åæ˜¯<code>didChangeValueForKey:</code>ï¼Œè¿™äº›æ–¹æ³•è§¦å‘Observerçš„ç›‘å¬æ–¹æ³•ã€‚</p><h3 id="è§¦å‘æœºåˆ¶">è§¦å‘æœºåˆ¶</h3><p>æ‰€ä»¥ï¼ŒåŸºäºåŸç†å¾—çŸ¥ï¼Œæ‰€æœ‰è°ƒç”¨å±æ€§setterçš„éƒ½ä¼šè§¦å‘KVOé€šçŸ¥ï¼Œæ‰€ä»¥KVCä¹Ÿä¼šè§¦å‘KVOï¼Œä½†ç›´æ¥ä¿®æ”¹æˆå‘˜å˜é‡åˆ™ä¸ä¼šã€‚</p><p>æ³¨æ„ï¼šä½¿ç”¨KVCèƒ½å¯¹æ²¡æœ‰setterçš„å±æ€§ï¼Œç”šè‡³æˆå‘˜å˜é‡ä¿®æ”¹å€¼ï¼Œè¿™éƒ½ä¼šè§¦å‘ç›¸åŒkeyPathçš„KVOé€šçŸ¥ã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li>åœ¨Swiftä¸­ä½¿ç”¨KVOï¼š<a href="../Swift/Language%20Interoperability/Cocoa%20Design%20Patterns/Using%20Key-Value%20Observing%20in%20Swift.md">Using Key-Value Observing in Swift</a></li><li><a href="https://ityongzhen.github.io/%E5%85%B3%E4%BA%8EKVO%E7%9C%8B%E8%BF%99%E7%AF%87%E5%B0%B1%E5%A4%9F%E4%BA%86.html/">å…³äºKVOçœ‹è¿™ç¯‡å°±å¤Ÿäº† | æ®·æ°¸æŒ¯</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;KVOç”¨äºé€»è¾‘éš”ç¦»å¯¹è±¡ä¹‹é—´çš„ç›‘å¬ï¼Œæ”¯æŒä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šçš„å±æ€§ç›‘å¬ã€‚è¿™é‡Œçš„ä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šæ˜¯é’ˆå¯¹ç›‘å¬çš„å±æ€§çš„ï¼Œå³æ—¢å¯ä»¥ç›‘å¬å•ä¸ªå±æ€§ï¼Œä¹Ÿå¯ä»¥ç›‘å¬é›†åˆå±æ€§ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨OCä¸­ï¼Œæ‰€æœ‰NSObjectå­ç±»çš„æ‰€æœ‰å±æ€§ï¼ˆåŒ…æ‹¬è®¡ç®—å±æ€§ï¼‰éƒ½æ”¯æŒKVOï¼›è€Œåœ¨Swiftä¸­ï¼Œåªæœ‰åœ¨&lt;code&gt;@objc dynamic&lt;/code&gt;ä¿®é¥°çš„å±æ€§ï¼ˆåŒ…æ‹¬è®¡ç®—å±æ€§ï¼‰æ‰æ”¯æŒKVOï¼Œå³ä½¿ç”¨&lt;code&gt;@objc dynamic&lt;/code&gt;ä¿®é¥°çš„å±æ€§ä¸OCè¡Œä¸ºä¸€è‡´ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
  </entry>
  
  <entry>
    <title>ç¼–è¯‘åŸºç¡€æ¦‚å¿µ</title>
    <link href="https://bqlin.github.io/posts/compilation_basic_concepts/"/>
    <id>https://bqlin.github.io/posts/compilation_basic_concepts/</id>
    <published>2021-07-10T03:03:33.000Z</published>
    <updated>2021-07-10T03:03:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬åœ°ç¼–è¯‘ï¼šå½“å‰å¹³å°ä¸Šç¼–è¯‘ç”¨äºå½“å‰å¹³å°çš„ç¨‹åºæˆ–åº“ã€‚</p><p>äº¤å‰ç¼–è¯‘ï¼šç”¨ç‰¹å®šçš„äº¤å‰ç¼–è¯‘å™¨ç¼–è¯‘ç”¨äºå…¶ä»–å¹³å°çš„ç¨‹åºæˆ–åº“ã€‚</p><p>ä¸€èˆ¬çš„äº¤å‰ç¼–è¯‘å·¥å…·é“¾æœ‰ï¼š</p><ul><li>CCï¼šCè¯­è¨€ç¼–è¯‘å™¨</li><li>CXXï¼šC++ç¼–è¯‘å™¨</li><li>ASï¼šæ±‡ç¼–è¯­è¨€ç¼–è¯‘å™¨</li><li>ARï¼šæ‰“åŒ…å™¨ï¼Œå°†.oæ–‡ä»¶æ‰“åŒ…ï¼ˆCC/CXX/ASç¼–è¯‘å™¨ç”Ÿæˆçš„ä¸º.oæ–‡ä»¶ï¼‰</li><li>LDï¼šè¿æ¥å™¨ï¼Œå°†åº“æ–‡ä»¶å’Œ.oæ–‡ä»¶è¿æ¥æˆå¯æ‰§è¡Œç¨‹åºï¼ˆå¦‚.outæ–‡ä»¶ï¼‰</li><li>NMï¼šæŸ¥çœ‹é™æ€åº“æ–‡ä»¶ä¸­çš„ç¬¦å·è¡¨</li><li>GDBï¼šè°ƒè¯•å·¥å…·</li><li>STRIPï¼šé€šè¿‡ä¼˜åŒ–å‡å°å¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…åº“æ–‡ä»¶ä½“ç§¯</li><li>Objdumpï¼šæŸ¥çœ‹é™æ€åº“æˆ–è€…åŠ¨æ€åº“çš„æ–¹æ³•ç­¾å</li></ul><h2 id="make">make</h2><p>makeå·¥å…·ç”¨äºç®€åŒ–ç¼–è¯‘å‘½ä»¤ï¼Œç”Ÿæˆæƒ³è¦çš„åº“æˆ–ç¨‹åºã€‚</p><p>makeç”±<code>configure</code>æ–‡ä»¶ï¼ˆå¯æ‰§è¡Œï¼‰æ¥é…ç½®ï¼Œå¸¸ç”¨å‚æ•°ï¼š</p><ul><li><code>prefix</code>ï¼šæŒ‡å®šç¼–è¯‘ç”Ÿæˆçš„åº“ã€å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„</li><li><code>host</code>ï¼šæŒ‡å®šè¿è¡Œå¹³å°</li><li><code>cc</code>ï¼šæŒ‡å®šç¼–è¯‘å™¨</li><li><code>cflags</code>ï¼šæŒ‡å®šç¼–è¯‘æ—¶æ‰€å¸¦çš„å‚æ•°</li><li><code>ldflags</code>ï¼šæŒ‡å®šé“¾æ¥æ—¶æ‰€å¸¦çš„å‚æ•°</li></ul><p>ä¸€èˆ¬ä½¿ç”¨æ­¥éª¤ï¼š</p><ol type="1"><li>è°ƒç”¨<code>./configure ...</code>å‘½ä»¤é…ç½®makeç›¸å…³å‚æ•°ã€‚</li><li>è°ƒç”¨<code>make...</code>æˆ–è€…<code>make install</code>å‘½ä»¤è¿›è¡Œç¼–è¯‘ã€é“¾æ¥ï¼Œå¹¶ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºæˆ–åº“æ–‡ä»¶ã€‚</li></ol><h2 id="clangé€‰é¡¹">clangé€‰é¡¹</h2><h3 id="æ§åˆ¶é”™è¯¯å’Œè­¦å‘Šä¿¡æ¯é€‰é¡¹">æ§åˆ¶é”™è¯¯å’Œè­¦å‘Šä¿¡æ¯é€‰é¡¹</h3><ul><li><code>-Werror</code>ï¼šå°†è­¦å‘Šè½¬æ¢æˆé”™è¯¯ã€‚</li><li><code>-Wno-error=foo</code>ï¼šä¿æŒè­¦å‘Šâ€œfooâ€ä¸è¢«è½¬æ¢æˆé”™è¯¯ï¼Œå³ä½¿-Werrorè¢«æŒ‡å®šã€‚</li><li><code>-Wfoo</code>ï¼šä½¿èƒ½è­¦å‘Šâ€œfooâ€ã€‚</li><li><code>-w</code>ï¼šç¦ç”¨æ‰€æœ‰è­¦å‘Šã€‚</li><li><code>-Weverything</code>ï¼šä½¿èƒ½æ‰€æœ‰è­¦å‘Šã€‚</li><li><code>-pedantic</code>ï¼šè­¦å‘Šè¯­è¨€æ‰©å±•ã€‚</li><li><code>-pedantic-errors</code>ï¼šæŠŠè¯­è¨€æ‰©å±•è§†ä½œé”™è¯¯ã€‚</li><li><code>-Wsystem-headers</code>ï¼šä½¿èƒ½æ¥è‡ªç³»ç»Ÿå¤´æ–‡ä»¶çš„è­¦å‘Šã€‚</li><li><code>-ferror-limit=123</code>ï¼šåœ¨è¯Šæ–­å‡º123ä¸ªé”™è¯¯ä¹‹ååœæ­¢è¯Šæ–­ã€‚é»˜è®¤æ˜¯20ï¼Œé”™è¯¯é™åˆ¶å¯ä»¥é€šè¿‡<code>-ferror-limit=0</code>æ¥ç¦ç”¨ã€‚</li><li><code>-ftemplate-backtrace-limit=123</code>ï¼šæœ€å¤šå®ä¾‹åŒ–123ä¸ªæ¨¡æ¿åœ¨æ¨¡æ¿å®ä¾‹åŒ–å›æº¯å¯¹äºå•ä¸ªè­¦å‘Šæˆ–é”™è¯¯ã€‚é™åˆ¶çš„é»˜è®¤æ˜¯10ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>-ftemplate-backtrace-limit=0</code>æ¥ç¦ç”¨ã€‚</li></ul><h3 id="æ§åˆ¶è°ƒè¯•ä¿¡æ¯">æ§åˆ¶è°ƒè¯•ä¿¡æ¯</h3><p>clangçš„è°ƒè¯•ä¿¡æ¯ç”Ÿæˆå¯è®¾ç½®ä»¥ä¸‹é€‰é¡¹ï¼Œå¦‚æœæœ‰å¤šä¸ªæ ‡å¿—ï¼Œåˆ™åªä½¿ç”¨æœ€åä¸€ä¸ªï¼š</p><ul><li><code>-g0</code>ï¼šä¸ç”Ÿæˆä»»ä½•è°ƒè¯•ä¿¡æ¯ï¼ˆé»˜è®¤ï¼‰ã€‚</li><li><code>-gline-tables-only</code>ï¼šåªç”Ÿæˆè¡Œå·è¡¨ã€‚</li><li><code>-g</code>ï¼šç”Ÿæˆå®Œæ•´çš„è°ƒè¯•ä¿¡æ¯ã€‚</li></ul><h3 id="ç¼–è¯‘ç›¸å…³">ç¼–è¯‘ç›¸å…³</h3><ul><li><code>-D&lt;macro&gt;=&lt;value&gt;</code>ã€<code>--define-macro &lt;arg&gt;</code>ã€<code>--define-macro=&lt;arg&gt;</code>ï¼šæ·»åŠ å®å®šä¹‰ã€‚å°† <code>&lt;macro&gt;</code> å®šä¹‰ä¸º <code>&lt;value&gt;</code>ï¼ˆå¦‚æœ <code>&lt;value&gt;</code> çœç•¥åˆ™ä¸º 1ï¼‰ã€‚</li><li><code>-U&lt;macro&gt;</code>ã€<code>--undefine-macro &lt;arg&gt;</code>ã€<code>--undefine-macro=&lt;arg&gt;</code>ï¼šå–æ¶ˆå®šä¹‰å® <code>&lt;macro&gt;</code>ï¼Œç›¸å½“äº<code>#undef macro</code>ã€‚</li><li><code>-llib</code>ï¼šæŒ‡å®šç¼–è¯‘çš„æºæ–‡ä»¶ä¸­æ‰€å¼•ç”¨çš„å¤–éƒ¨åº“åç§°ï¼Œ-lå’Œlibä¹‹é—´å¯åŠ ç©ºæ ¼ä¹Ÿå¯ä¸åŠ ,è¯¥é€‰é¡¹åœ¨ç¼–è¯‘é˜¶æ®µå¯åŠ å¯ä¸åŠ ï¼Œè¿æ¥é˜¶æ®µæ‰æœ‰æ•ˆã€‚</li><li><code>-Ldir</code>ï¼šæŒ‡å®šç¼–è¯‘çš„æºæ–‡ä»¶ä¸­æ‰€å¼•ç”¨çš„å¤–éƒ¨åº“çš„æœç´¢è·¯å¾„ï¼Œ-Lå’Œlibä¹‹é—´å¯åŠ ç©ºæ ¼ä¹Ÿå¯ä¸åŠ ,è¯¥é€‰é¡¹åœ¨ç¼–è¯‘é˜¶æ®µå¯åŠ å¯ä¸åŠ ï¼Œè¿æ¥é˜¶æ®µæ‰æœ‰æ•ˆã€‚è¿æ¥å™¨é»˜è®¤ä¼šåœ¨å½“å‰ç›®å½•ï¼Œç³»ç»Ÿç›®å½•æœç´¢åº“ï¼Œä¼˜å…ˆä½¿ç”¨åŠ¨æ€åº“ï¼Œå¦‚æœæŒ‡å®šäº†æ­¤é€‰é¡¹ï¼Œé‚£ä¹ˆå°†ä¼˜å…ˆåœ¨dirç›®å½•ä¸‹æœç´¢åº“ï¼Œæœªæ‰¾åˆ°åˆ™æŒ‰é»˜è®¤è§„åˆ™æœç´¢ã€‚</li></ul><p>å¤‡æ³¨ï¼šå¦‚æœæœ€ç»ˆå¯æ‰§è¡Œç¨‹åºæ˜¯åŠ¨æ€é“¾æ¥ç”Ÿæˆçš„ï¼Œé‚£ä¹ˆç¨‹åºåŠ è½½æ—¶é»˜è®¤åˆ°ç³»ç»Ÿç›®å½•(ä¸€èˆ¬æ˜¯/usr/local/libä¸‹)ä¸‹æœç´¢æ‰€å¼•ç”¨çš„åŠ¨æ€åº“(å¹¶éä¼šåˆ°ä¸Šé¢çš„dirä¸­æœç´¢)ï¼Œå¦‚æœè®¾ç½®äº†LD_LIBRAY_PATHç¯å¢ƒå˜é‡çš„å€¼ï¼Œé‚£ä¹ˆç¨‹åºåŠ è½½æ—¶åŠ¨æ€åº“å°†ä¼˜å…ˆå»è¯¥è·¯å¾„æœç´¢ï¼Œç„¶åæŒ‰é»˜è®¤è§„åˆ™æœç´¢ã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pkg-config --cflags --libs x264</span><br><span class="line">-DX264_API_IMPORTS -I/usr/<span class="built_in">local</span>/Cellar/x264/r3049/include -L/usr/<span class="built_in">local</span>/Cellar/x264/r3049/lib -lx264</span><br></pre></td></tr></table></figure><ul><li><code>-O0</code>ã€<code>-O1</code>ã€<code>-O2</code>ã€<code>-O3</code>ï¼šç¼–è¯‘å™¨çš„ä¼˜åŒ–çº§åˆ«ï¼Œ<code>-O0</code> è¡¨ç¤ºæ²¡æœ‰ä¼˜åŒ–, <code>-O1</code> ä¸ºé»˜è®¤å€¼ï¼Œ<code>-O3</code> ä¼˜åŒ–çº§åˆ«æœ€é«˜ã€‚</li><li><code>-static</code>ï¼šç¼–è¯‘å™¨å°†é‡‡ç”¨é™æ€é“¾æ¥ã€‚</li><li><code>-shared</code>ï¼šåŠ¨æ€é“¾æ¥ï¼Œç¼–è¯‘å™¨é»˜è®¤ã€‚</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬åœ°ç¼–è¯‘ï¼šå½“å‰å¹³å°ä¸Šç¼–è¯‘ç”¨äºå½“å‰å¹³å°çš„ç¨‹åºæˆ–åº“ã€‚&lt;/p&gt;
&lt;p&gt;äº¤å‰ç¼–è¯‘ï¼šç”¨ç‰¹å®šçš„äº¤å‰ç¼–è¯‘å™¨ç¼–è¯‘ç”¨äºå…¶ä»–å¹³å°çš„ç¨‹åºæˆ–åº“ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegéŸ³è§†é¢‘åŒæ­¥</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_audio_and_video_synchronization/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_audio_and_video_synchronization/</id>
    <published>2021-07-08T13:05:20.000Z</published>
    <updated>2021-07-08T13:05:20.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="dtspts">DTSã€PTS</h3><p>FFmpegä¸­è·å–PTSï¼š</p><ul><li>AVPacketä¸­</li><li>AVFrameä¸­ï¼ˆå…¶è·å–PTSçš„av_frame_get_best_effort_timestampå·²ç»å¼ƒç”¨ä¸”ä¸éœ€è¦ä½¿ç”¨ï¼‰</li></ul><h3 id="æ—¶é—´åŸº">æ—¶é—´åŸº</h3><p>ç›¸å…³è®¡ç®—å…¬å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ—¶é—´æˆ³è½¬ç§’</span></span><br><span class="line">time_in_seconds = pts * av_q2d(time_base)</span><br><span class="line"><span class="comment">// ç§’è½¬æ—¶é—´æˆ³</span></span><br><span class="line">timestamp = timebase * time_in_seconds</span><br></pre></td></tr></table></figure><p>FFmpegå†…éƒ¨çš„æ—¶é—´åŸºï¼š<code>AV_TIME_BASE</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>         AV_TIME_BASE   1000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†æ•°å½¢å¼</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>         AV_TIME_BASE_Q   (AVRational)&#123;1, AV_TIME_BASE&#125;</span></span><br></pre></td></tr></table></figure><p>ç›¸å…³å®šä¹‰ä¸è½¬æ¢å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºæ—¶é—´åŸºçš„ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">AVRational</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> num; <span class="comment">//numerator</span></span><br><span class="line">    <span class="keyword">int</span> den; <span class="comment">//denominator</span></span><br><span class="line">&#125; AVRational;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¬æ¢æˆåˆ†æ•°å½¢å¼</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <span class="title">av_q2d</span><span class="params">(AVRational a)</span>ï½›</span></span><br><span class="line"><span class="function">    <span class="keyword">return</span> a.num / <span class="params">(<span class="keyword">double</span>)</span> a.den</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¬æ¢æ—¶é—´åŸºã€‚æŠŠaçš„æ—¶é—´æˆ³ä»bqæ—¶é—´åŸºè½¬æ¢åˆ°cqæ—¶é—´åŸºã€‚å°±æ˜¯ç®€å•åœ°a * bq / cq</span></span><br><span class="line"><span class="function"><span class="keyword">int64_t</span> <span class="title">av_rescale_q</span><span class="params">(<span class="keyword">int64_t</span> a, AVRational bq, AVRational cq)</span></span>;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;dtspts&quot;&gt;DTSã€PTS&lt;/h3&gt;
&lt;p&gt;FFmpegä¸­è·å–PTSï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegæ–°è€API</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_api_new_deprecated/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_api_new_deprecated/</id>
    <published>2021-07-06T08:00:03.000Z</published>
    <updated>2021-11-28T14:04:04.000Z</updated>
    
    <content type="html"><![CDATA[<p>å˜åŒ–ï¼š</p><ul><li>ä¸éœ€è¦è¦è°ƒç”¨æ³¨å†Œæ–¹æ³•ã€‚</li><li>ç®€åŒ–äº†æµç¨‹ã€‚</li><li>è¯­ä¹‰æ›´å‡†ç¡®ã€‚</li></ul><h3 id="avcodec_decode_video2">avcodec_decode_video2</h3><p>åŸæœ¬çš„è§£ç å‡½æ•°è¢«æ‹†è§£ä¸ºä¸¤ä¸ªå‡½æ•°<code>avcodec_send_packet()</code>å’Œ<code>avcodec_receive_frame()</code>å…·ä½“ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// old:</span></span><br><span class="line">avcodec_decode_video2(pCodecCtx, pFrame, &amp;got_picture, pPacket);</span><br><span class="line"></span><br><span class="line"><span class="comment">// new:</span></span><br><span class="line">avcodec_send_packet(pCodecCtx, pPacket);</span><br><span class="line">avcodec_receive_frame(pCodecCtx, pFrame);</span><br></pre></td></tr></table></figure><h3 id="codec_encode_video2">codec_encode_video2</h3><p>å¯¹åº”çš„ç¼–ç å‡½æ•°ä¹Ÿè¢«æ‹†åˆ†ä¸ºä¸¤ä¸ªå‡½æ•°<code>avcodec_send_frame()</code>å’Œ<code>avcodec_receive_packet()</code>å…·ä½“ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// old:</span></span><br><span class="line">avcodec_encode_video2(pCodecCtx, pPacket, pFrame, &amp;got_picture);</span><br><span class="line"></span><br><span class="line"><span class="comment">// new:</span></span><br><span class="line">avcodec_send_frame(pCodecCtx, pFrame);</span><br><span class="line">avcodec_receive_packet(pCodecCtx, pPacket);</span><br></pre></td></tr></table></figure><h3 id="avpicture_get_size">avpicture_get_size</h3><p>ç°åœ¨æ”¹ä¸ºä½¿ç”¨av_image_get_size() å…·ä½“ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// old:</span></span><br><span class="line">avpicture_get_size(AV_PIX_FMT_YUV420P, pCodecCtx-&gt;width, pCodecCtx-&gt;height);</span><br><span class="line"></span><br><span class="line"><span class="comment">// new:</span></span><br><span class="line"><span class="comment">// æœ€åä¸€ä¸ªå‚æ•°alignè¿™é‡Œæ˜¯ç½®1çš„ï¼Œå…·ä½“çœ‹æƒ…å†µæ˜¯å¦éœ€è¦ç½®1</span></span><br><span class="line">av_image_get_buffer_size(AV_PIX_FMT_YUV420P, pCodecCtx-&gt;width, pCodecCtx-&gt;height, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><h3 id="avpicture_fill">avpicture_fill</h3><p>ç°åœ¨æ”¹ä¸ºä½¿ç”¨av_image_fill_arrays å…·ä½“ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// old:</span></span><br><span class="line">avpicture_fill((AVPicture *)pFrame, buffer, AV_PIX_FMT_YUV420P, pCodecCtx-&gt;width, pCodecCtx-&gt;height);</span><br><span class="line"></span><br><span class="line"><span class="comment">// new:</span></span><br><span class="line"><span class="comment">// æœ€åä¸€ä¸ªå‚æ•°alignè¿™é‡Œæ˜¯ç½®1çš„ï¼Œå…·ä½“çœ‹æƒ…å†µæ˜¯å¦éœ€è¦ç½®1</span></span><br><span class="line">av_image_fill_arrays(pFrame-&gt;data, pFrame-&gt;linesize, buffer, AV_PIX_FMT_YUV420P,  pCodecCtx-&gt;width, pCodecCtx-&gt;height,<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h3 id="codec">codec</h3><p>å…³äºcodecé—®é¢˜æœ‰çš„å¯ä»¥ç›´æ¥æ”¹ä¸ºcodecparï¼Œä½†æœ‰çš„æ—¶å€™è¿™æ ·è¿™æ ·æ˜¯ä¸å¯¹çš„ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿè¿˜åœ¨æ¢ç´¢ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸ªå¯¹pCodecCtxå’ŒpCodecèµ‹å€¼æ–¹å¼çš„æ”¹å˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// old:</span></span><br><span class="line">pCodecCtx = pFormatCtx-&gt;streams[video_index]-&gt;codec;</span><br><span class="line">pCodec = avcodec_find_decoder(pFormatCtx-&gt;streams[video_index]-&gt;codec-&gt;codec_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">// new:</span></span><br><span class="line"><span class="comment">// æŠŠå‚æ•°ä»AVCodecParametersæ‹·è´åˆ°AVCodecContext</span></span><br><span class="line">pCodecCtx = avcodec_alloc_context3(<span class="literal">NULL</span>);</span><br><span class="line">avcodec_parameters_to_context(pCodecCtx,pFormatCtx-&gt;streams[video_index]-&gt;codecpar);</span><br><span class="line">pCodec    = avcodec_find_decoder(pCodecCtx-&gt;codec_id);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;å˜åŒ–ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸éœ€è¦è¦è°ƒç”¨æ³¨å†Œæ–¹æ³•ã€‚&lt;/li&gt;
&lt;li&gt;ç®€åŒ–äº†æµç¨‹ã€‚&lt;/li&gt;
&lt;li&gt;è¯­ä¹‰æ›´å‡†ç¡®ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegåŸºæœ¬APIï¼šé‡è¦ç»“æ„ä½“</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_api_struct/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_api_struct/</id>
    <published>2021-06-28T11:27:54.000Z</published>
    <updated>2021-06-28T11:27:54.000Z</updated>
    
    <content type="html"><![CDATA[<p>å…³é”®çš„ç»“æ„ä½“å¯åˆ†æˆä»¥ä¸‹å‡ ç±»ï¼š</p><p><strong>è§£åè®®ï¼ˆhttpã€rtspã€rtmpã€mmsï¼‰</strong></p><p><code>AVIOContext</code>ã€<code>URLProtocol</code>ã€<code>URLContext</code>ä¸»è¦å­˜å‚¨éŸ³è§†é¢‘ä½¿ç”¨çš„åè®®ç±»å‹ä»¥åŠçŠ¶æ€ã€‚</p><p><code>URLProtocol</code>å­˜å‚¨è¾“å…¥éŸ³è§†é¢‘ä½¿ç”¨çš„å°è£…æ ¼å¼ã€‚æ¯ç§åè®®éƒ½ä¼šæœ‰å¯¹åº”çš„<code>URLProtocol</code>ç»“æ„ä½“ï¼Œæ–‡ä»¶ä¹Ÿä¸ä¾‹å¤–ã€‚</p><p><strong>è§£å°è£…ï¼ˆflvã€aviã€rmvbã€mp4ï¼‰</strong></p><p><code>AVFormatContext</code>ä¸»è¦å­˜å‚¨éŸ³è§†é¢‘å°è£…æ ¼å¼ä¸­çš„åŒ…å«çš„ä¿¡æ¯ã€‚</p><p><code>AVInputFormat</code>å­˜å‚¨è¾“å…¥éŸ³è§†é¢‘ä½¿ç”¨çš„å°è£…æ ¼å¼ï¼Œæ¯ç§éŸ³è§†é¢‘å°è£…æ ¼å¼éƒ½å¯¹åº”ä¸€ä¸ª<code>AVInputFormat</code>ç»“æ„ä½“ã€‚</p><p><strong>è§£ç ï¼ˆh264ã€mpeg2ã€aacã€mp3ï¼‰</strong></p><p>æ¯ä¸ª<code>AVStream</code>å­˜å‚¨ä¸€ä¸ªéŸ³é¢‘æµ/è§†é¢‘æµçš„ç›¸å…³æ•°æ®ã€‚</p><p>æ¯ä¸ª<code>AVStream</code>å¯¹åº”ä¸€ä¸ª<code>AVCodecContext</code>ï¼Œå­˜å‚¨è¯¥æµä½¿ç”¨çš„è§£ç æ–¹å¼çš„ç›¸å…³æ•°æ®ã€‚</p><p>æ¯ä¸ª<code>AVCodecContext</code>å¯¹åº”ä¸€ä¸ª<code>AVCodec</code>ï¼ŒåŒ…å«æµå¯¹åº”çš„è§£ç å™¨å™¨ã€‚æ¯ç§è§£ç å™¨å¯¹åº”ä¸€ä¸ª<code>AVCodec</code>ç»“æ„ä½“ã€‚</p><p><strong>å­˜æ•°æ®</strong></p><p>è§£ç å‰çš„æ•°æ®ç»“æ„ï¼š<code>AVPacket</code>ï¼›è§£ç åçš„æ•°æ®ç»“æ„ï¼š<code>AVFrame</code>ã€‚æ¯ä¸ªç»“æ„ä½“æœ‰ä¸€å¸§æˆ–å¤šå¸§ã€‚</p><p>å…³ç³»ï¼š</p><figure><img src="https://img-blog.csdn.net/20130914204051125?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGVpeGlhb2h1YTEwMjA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><h2 id="æ–‡ä»¶æ“ä½œ">æ–‡ä»¶æ“ä½œ</h2><p><code>&lt;libavformat/avio.h&gt;</code></p><h3 id="aviodircontext">AVIODirContext</h3><p>æ“ä½œç›®å½•ä¸Šä¸‹æ–‡ï¼Œæ‰¿è½½ç›®å½•ä¿¡æ¯ã€‚</p><h3 id="aviodirentry">AVIODirEntry</h3><p>ç›®å½•å†…å®¹é¡¹ï¼Œæ‰¿è½½æ–‡ä»¶/ç›®å½•è¯¦ç»†ä¿¡æ¯ã€‚ç”¨äºå­˜æ”¾æ–‡ä»¶åã€æ–‡ä»¶å¤§å°ç­‰ä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤æ–‡ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avpriv_io_delete</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* url)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç§»åŠ¨æˆ–é‡å‘½å</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avpriv_io_move</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* url_src, <span class="keyword">const</span> <span class="keyword">char</span>* url_dst)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å¼€ç›®å½•ï¼Œä¼šåˆ†é…AVIODirContext</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avio_open_dir</span><span class="params">(AVIODirContext** s, <span class="keyword">const</span> <span class="keyword">char</span>* url, AVDictionary** options)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–ç›®å½•ï¼Œç»“æœè¾“å‡ºåˆ°AVIODirEntry</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avio_read_dir</span><span class="params">(AVIODirContext* s, AVIODirEntry** next)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­ç›®å½•ï¼ˆé‡Šæ”¾èµ„æºï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avio_close_dir</span><span class="params">(AVIODirContext** s)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®åŒ…æ“ä½œ">æ•°æ®åŒ…æ“ä½œ</h2><p><code>&lt;libavformat/avformat.h&gt;</code></p><h3 id="avformatcontext">AVFormatContext</h3><p>ç»Ÿé¢†å…¨å±€çš„åŸºæœ¬ç»“æ„ä½“ã€‚ä¸»è¦ç”¨äºå¤„ç†å°è£…æ ¼å¼ã€‚</p><ul><li><code>struct AVInputFormat *iformat</code>ï¼šè¾“å…¥æ•°æ®çš„å°è£…æ ¼å¼ï¼Œç”±<code>avformat_open_input</code>è®¾ç½®ï¼Œä»…ä»…åœ¨è§£å°è£…æ—¶ä½¿ç”¨ã€‚</li><li><code>struct AVOutputFormat *oformat</code>ï¼šè¾“å‡ºæ•°æ®çš„å°è£…æ ¼å¼ï¼Œå¿…é¡»ç”±ä½¿ç”¨è€…åœ¨<code>avformat_write_header</code>å‰è®¾ç½®ï¼Œç”±å°è£…æ—¶ä½¿ç”¨ã€‚</li><li><code>priv_data</code>ï¼šæ ¼å¼ç§æœ‰æ•°æ®ã€‚åœ¨å°è£…ä¸­ï¼Œç”±<code>avformat_write_header</code>è®¾ç½®ï¼›åœ¨è§£å°è£…ä¸­ï¼Œç”±<code>avformat_open_input</code>è®¾ç½®ã€‚</li><li><code>AVIOContext *pb</code>ï¼šè¾“å…¥è¾“å‡ºä¸Šä¸‹æ–‡ã€‚å¦‚æœ<code>iformat/oformat.flags</code>è®¾ç½®ä¸º<code>AVFMT_NOFILE</code>çš„è¯ï¼Œè¯¥å­—æ®µä¸éœ€è¦è®¾ç½®ã€‚å¯¹äºè§£å°è£…ï¼Œéœ€è¦åœ¨<code>avformat_open_input</code>å‰è®¾ç½®ï¼Œæˆ–ç”±<code>avformat_open_input</code>è®¾ç½®ï¼›å¯¹äºå°è£…ï¼Œåœ¨<code>avformat_write_header</code>å‰è®¾ç½®ã€‚</li><li><code>ctx_flags</code>ï¼šç æµçš„ä¿¡æ¯ï¼Œè¡¨æ˜ç æµå±æ€§çš„çš„ä¿¡å·ã€‚ç”±<code>libavformat</code>è®¾ç½®ï¼Œä¾‹å¦‚<code>AVFMTCTX_NOHEADER</code>ã€‚</li><li><code>nb_streams</code>ï¼šæŒ‡<code>AVFormatContext.streams</code>çš„æ•°é‡ï¼Œå¿…é¡»ç”±<code>avformat_new_stream</code>è®¾ç½®ï¼Œä¸èƒ½ç”±å…¶ä»–ä»£ç æ”¹åŠ¨ã€‚</li><li><code>AVStream **streams</code>ï¼šæ–‡ä»¶ä¸­æ‰€æœ‰ç æµçš„åˆ—è¡¨ï¼Œæ–°çš„ç æµåˆ›å»ºä½¿ç”¨<code>avformat_new_stream</code>å‡½æ•°ã€‚è§£å°è£…ä¸­ï¼Œç æµç”±<code>avformat_open_input</code>åˆ›å»ºã€‚ å¦‚æœ<code>AVFMTCTX_NOHEADER</code>è¢«è®¾ç½®ï¼Œæ–°çš„ç æµå¯ä»¥å‡ºç°åœ¨<code>av_read_frame</code>ä¸­ã€‚å°è£…ä¸­ï¼Œç æµåœ¨<code>avformat_write_header</code>ä¹‹å‰ç”±ç”¨æˆ·åˆ›å»ºã€‚å®ƒçš„é‡Šæ”¾æ˜¯ç”±<code>avformat_free_context</code>å®Œæˆçš„ã€‚</li><li><code>filename</code>ï¼šè¾“å…¥æˆ–è¾“å‡ºçš„æ–‡ä»¶åï¼Œè§£å°è£…ä¸­ç”±<code>avformat_open_input</code>è®¾ç½®ï¼Œå°è£…ä¸­åœ¨ä½¿ç”¨<code>avformat_write_header</code>å‰ç”±è°ƒç”¨è€…è®¾ç½®ã€‚</li><li><code>int64_t duration</code>ï¼šç æµçš„æ—¶é•¿ã€‚</li><li><code>bit_rate</code>ï¼šæ¯”ç‰¹ç‡ã€‚</li><li><code>enum AVCodecID video_codec_id</code></li><li><code>AVDictionary *metadata</code>ï¼šå…ƒæ•°æ®ï¼Œé€‚ç”¨äºæ•´ä¸ªæ–‡ä»¶ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸é”€æ¯</span></span><br><span class="line"><span class="function">AVFormatContext* <span class="title">avformat_alloc_context</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">avformat_free_context</span><span class="params">(AVFormatContext* s)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// å…¶ä»–åˆ›å»ºæ–¹å¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å¼€ç°æœ‰çš„åª’ä½“æ–‡ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avformat_open_input</span><span class="params">(AVFormatContext **ps, <span class="keyword">const</span> <span class="keyword">char</span> *url, AVInputFormat *fmt, AVDictionary **options)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">avformat_close_input</span><span class="params">(AVFormatContext* s)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®è·¯å¾„çŒœæµ‹å¹¶åˆ›å»ºã€‚å…¶å†…éƒ¨ä¸ºavformat_alloc_context+av_guess_format+èµ‹å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avformat_alloc_output_context2</span><span class="params">(AVFormatContext **ctx, AVOutputFormat *oformat, <span class="keyword">const</span> <span class="keyword">char</span> *format_name, <span class="keyword">const</span> <span class="keyword">char</span> *filename)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">avformat_free_context</span><span class="params">(AVFormatContext *s)</span>ï¼›</span></span><br></pre></td></tr></table></figure><h3 id="avstream">AVStream</h3><p>æµ/è½¨ä¿¡æ¯ï¼ˆä¸åŒ…å«æ•°æ®ï¼‰ã€‚</p><ul><li><code>index</code>ï¼šåœ¨AVFormatContextçš„æµç´¢å¼•ã€‚</li><li><del><code>AVCodecContext *codec</code></del>ï¼šå·²è¢«å¼ƒç”¨ï¼Œæ”¹æˆ<code>AVCodecParameters *codecpar</code>ï¼šç¼–è§£ç ä¿¡æ¯ã€‚</li><li><code>AVRational time_base</code>ï¼šæ—¶é—´å•ä½ã€‚</li><li><code>duration</code>ï¼šæµé•¿åº¦ã€‚</li><li><code>AVDictionary *metadata</code>ï¼šå…ƒæ•°æ®ä¿¡æ¯ã€‚</li><li><code>AVRational avg_frame_rate</code>ï¼šå¹³å‡å¸§ç‡ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸é”€æ¯</span></span><br><span class="line"><span class="function">AVStream* <span class="title">avformat_new_stream</span><span class="params">(AVFormatContext* s, <span class="keyword">const</span> AVCodec* c)</span></span>;</span><br><span class="line"><span class="comment">// éšavformat_free_contextä¸€èµ·é”€æ¯</span></span><br></pre></td></tr></table></figure><h3 id="aviocontext">AVIOContext</h3><p>è¾“å…¥è¾“å‡ºå¯¹åº”çš„ç»“æ„ä½“ã€‚</p><ul><li><code>unsigned char *buffer</code>ï¼šç¼“å­˜å¼€å§‹ä½ç½®ã€‚</li><li><code>buffer_size</code>ï¼šç¼“å­˜å¤§å°ã€‚</li><li><code>unsigned char *buf_ptr</code>ï¼šå½“å‰æŒ‡é’ˆè¯»å–åˆ°çš„ä½ç½®ã€‚</li><li><code>unsigned char *buf_end</code>ï¼šç¼“å­˜ç»“æŸçš„ä½ç½®ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸é”€æ¯</span></span><br><span class="line"><span class="function">AVIOContext* <span class="title">avio_alloc_context</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* buffer, <span class="keyword">int</span> buffer_size,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> write_flag, <span class="keyword">void</span>* opaque,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span>(*)(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> *buf, <span class="keyword">int</span> buf_size) read_packet,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span>(*)(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> *buf, <span class="keyword">int</span> buf_size) write_packet,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int64_t</span>(*)(<span class="keyword">void</span> *opaque, <span class="keyword">int64_t</span> offset, <span class="keyword">int</span> whence) seek</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">avio_context_free</span><span class="params">(AVIOContext** s)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="avpacket">AVPacket</h3><p>å‹ç¼©æ•°æ®åŒ…ï¼Œå‹ç¼©åŸŸç»“æ„ä½“ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªå‹ç¼©æ•°æ®å¸§ã€‚è¿™æ˜¯æµæ“ä½œä¸­çš„æ ¸å¿ƒæ•°æ®ã€‚</p><p>å¯¹äºè§†é¢‘æ•°æ®ï¼ŒåªåŒ…å«ä¸€å¸§å‹ç¼©æ•°æ®ï¼›å¯¹äºéŸ³é¢‘æ•°æ®ï¼Œå¯èƒ½åŒ…å«å¤šå¸§å‹ç¼©æ•°æ®ã€‚</p><p>å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">AVPacket</span>&#123;</span></span><br><span class="line">AVBufferRef *buf;</span><br><span class="line"><span class="keyword">int64_t</span>      pts;</span><br><span class="line"><span class="keyword">int64_t</span>      dts;</span><br><span class="line"><span class="keyword">uint8_t</span>    *data;</span><br><span class="line"><span class="keyword">int</span>         size;</span><br><span class="line"><span class="keyword">int</span> stream_index;</span><br><span class="line"><span class="keyword">int</span>        flags;</span><br><span class="line">AVPacketSideData *side_data;</span><br><span class="line"><span class="keyword">int</span> side_data_elems;</span><br><span class="line"><span class="keyword">int</span>   duration;</span><br><span class="line"><span class="keyword">int64_t</span> pos;</span><br><span class="line"><span class="keyword">int64_t</span> convergence_duration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>pts</code>ï¼šæ˜¾ç¤ºæ—¶é—´æˆ³ï¼Œå®ƒçš„å•ä½æ˜¯ <code>AVStream-&gt;time_base</code>ï¼›å¦‚æœåœ¨æ–‡ä»¶ä¸­æ²¡æœ‰ä¿å­˜è¿™ä¸ªå€¼ï¼Œå®ƒè¢«è®¾ç½®ä¸º <code>AV_NOPTS_VALUE</code>ã€‚ç”±äºå›¾åƒæ˜¾ç¤ºä¸å¯èƒ½æ—©äºå›¾åƒè§£å‹ï¼Œå› æ­¤ PTS å¿…é¡»æ¯” DTSï¼ˆè§£ç æ—¶é—´æˆ³ï¼‰å¤§æˆ–è€…ç›¸ç­‰ã€‚æŸäº›æ–‡ä»¶æ ¼å¼ä¸­å¯èƒ½ä¼šä½¿ç”¨ PTS/DTS è¡¨ç¤ºå…¶ä»–å«ä¹‰ï¼Œæ­¤æ—¶æ—¶é—´æˆ³å¿…é¡»è½¬ä¸ºçœŸæ­£çš„æ—¶é—´æˆ³æ‰èƒ½ä¿å­˜åˆ° AVPacket ç»“æ„ä¸­ã€‚</li><li><code>dts</code>ï¼šè§£ç æ—¶é—´æˆ³ï¼Œå®ƒçš„å•ä½æ˜¯ <code>AVStream-&gt;time_base</code>ï¼Œè¡¨ç¤ºå‹ç¼©è§†é¢‘è§£ç çš„æ—¶é—´ï¼Œå¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰ä¿å­˜è¯¥å€¼ï¼Œå®ƒè¢«è®¾ç½®ä¸º <code>AV_NOPTS_VALUE</code>ã€‚</li><li><code>data</code>ï¼šæŒ‡å‘çœŸæ­£çš„å‹ç¼©ç¼–ç çš„æ•°æ®ã€‚</li><li><code>size</code>ï¼šè¡¨ç¤ºè¯¥ AVPacket ç»“æ„ä¸­ data å­—æ®µæ‰€æŒ‡å‘çš„å‹ç¼©æ•°æ®çš„å¤§å°ã€‚</li><li><code>stream_index</code>ï¼šæ ‡è¯†è¯¥ AVPacket ç»“æ„æ‰€å±çš„è§†é¢‘æµæˆ–éŸ³é¢‘æµã€‚</li><li><code>duration</code>ï¼šè¯¥ AVPacket åŒ…ä»¥ <code>AVStream-&gt;time_base</code> ä¸ºå•ä½ï¼Œæ‰€æŒç»­çš„æ—¶é—´ï¼Œ0 è¡¨ç¤ºæœªçŸ¥ï¼Œæˆ–è€…ä¸ºæ˜¾ç¤ºæ—¶é—´æˆ³çš„å·®å€¼(next_pts - this pts)ã€‚</li><li><code>pos</code>ï¼šè¡¨ç¤ºè¯¥ AVPacket æ•°æ®åœ¨åª’ä½“ä¸­çš„ä½ç½®ï¼Œå³å­—èŠ‚åç§»é‡ã€‚</li></ul><p>ç›´æ¥åˆ›å»ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯åœ¨æ ˆæˆ–å †ä¸­åˆ›å»º</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»ä¼¼çš„ï¼Œå¦‚æœAVPacketæ˜¯åœ¨å †åˆ›å»ºçš„ï¼Œåˆ™è¦é…åˆä½¿ç”¨è¿™ä¸¤ä¸ªAPI</span></span><br><span class="line"><span class="function">AVPacket *<span class="title">av_packet_alloc</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">av_packet_free</span><span class="params">(AVPacket** pkt)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="å¡«å……æ–¹å¼ä¸€av_read_frame">å¡«å……æ–¹å¼ä¸€ï¼šav_read_frame</h4><p>é€šè¿‡AVFormatContextå¯è¯»å–ä¸€èˆ¬çš„åª’ä½“å®¹å™¨æ–‡ä»¶ã€‚</p><p>è¿™é‡Œçš„è¯»å–æ•°æ®åŒ…çš„æ–¹æ³•å‘½åä¸º<code>av_read_frame</code>åªæ˜¯å†å²é—ç•™é—®é¢˜ï¼Œä»¥å‰çš„æ•°æ®åŒ…ä¹Ÿæ˜¯ç”¨frameå‘½åçš„ï¼Œåé¢æ‰æ”¹äº†è¿‡æ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯æ¬¡è¯»å–å¸§åï¼Œè¦å¯¹åº”å‡å¼•ç”¨è®¡æ•°ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">av_read_frame</span><span class="params">(AVFormatContext* s, AVPacket *pkt)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">av_packet_unref</span><span class="params">(AVPacket* pkt)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="å¡«å……æ–¹å¼äºŒav_parser_parse2">å¡«å……æ–¹å¼äºŒï¼šav_parser_parse2</h4><p>é€šè¿‡AVCodecParserContextã€AVCodecContextè§£æbufferï¼Œå¾—å‡ºæ•°æ®åŒ…çš„ä¸»è¦ä¿¡æ¯ã€‚åªèƒ½é’ˆå¯¹éŸ³è§†é¢‘è£¸æµè¿›è¡Œè§£æã€‚è¯¥æ–¹æ³•åªæ˜¯è§£æï¼Œå³è¿˜è¦å€ŸåŠ©å…¶ä»–APIè¯»å–è·å¾—bufferã€‚</p><p>AVCodecParserç”¨äºè§£æè¾“å…¥çš„æ•°æ®æµå¹¶æŠŠå®ƒä»¬åˆ†æˆä¸€å¸§ä¸€å¸§çš„å‹ç¼©ç¼–ç æ•°æ®ã€‚æ¯”è¾ƒå½¢è±¡çš„è¯´æ³•å°±æ˜¯æŠŠé•¿é•¿çš„ä¸€æ®µè¿ç»­çš„æ•°æ®â€œåˆ‡å‰²â€æˆä¸€æ®µæ®µçš„æ•°æ®ã€‚ <code>av_parser_parse2()</code>ï¼šè§£ææ•°æ®è·å¾—ä¸€ä¸ªPacketï¼Œ ä»è¾“å…¥çš„æ•°æ®æµä¸­åˆ†ç¦»å‡ºä¸€å¸§ä¸€å¸§çš„å‹ç¼©ç¼–ç æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">av_parser_parse2</span><span class="params">(AVCodecParserContext *s, AVCodecContext *avctx, <span class="keyword">uint8_t</span> **poutbuf, <span class="keyword">int</span> *poutbuf_size, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *buf, <span class="keyword">int</span> buf_size, <span class="keyword">int64_t</span> pts, <span class="keyword">int64_t</span> dts, <span class="keyword">int64_t</span> pos)</span></span></span><br></pre></td></tr></table></figure><p>ç”±äºä¼ å…¥çš„bufferå¯ä»¥æœ‰å¤šä¸ªæ•°æ®åŒ…ï¼Œæ‰€ä»¥éœ€è¦å¾ªç¯è¯»å–ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (data_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›ä»¥è§£æçš„å¤§å°ï¼Œè‹¥å°äºbufferçš„å¤§å°ï¼Œåˆ™ä¼šå†æ¬¡è¿›è¡Œå¾ªç¯è§£æ</span></span><br><span class="line">    ret = av_parser_parse2(parser, c, &amp;pkt-&gt;data, &amp;pkt-&gt;size,</span><br><span class="line">                           data, data_size, AV_NOPTS_VALUE, AV_NOPTS_VALUE, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error while parsing\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    data      += ret;</span><br><span class="line">    data_size -= ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pkt-&gt;size) &#123;</span><br><span class="line">        <span class="comment">// è¿™æ—¶è·å¾—ä¸€ä¸ªåˆæ³•çš„æ•°æ®åŒ…</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç¼–è§£ç ">ç¼–è§£ç </h2><p><code>&lt;libavcodec/avcodec.h&gt;</code></p><h3 id="avcodec">AVCodec</h3><p>ç¼–ç å™¨ç»“æ„ä½“ï¼Œé€šè¿‡å®ƒè½¬æ¢AVFrame/AVPacketã€‚</p><p>å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">AVCodec</span>&#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *long_name;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">AVMediaType</span> <span class="title">type</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">AVCodecID</span> <span class="title">id</span>;</span></span><br><span class="line">    <span class="keyword">int</span> capabilities;</span><br><span class="line">    <span class="keyword">const</span> AVRational *supported_framerates; <span class="comment">///&lt; array of supported framerates, or NULL if any, array is terminated by &#123;0,0&#125;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">enum</span> <span class="title">AVPixelFormat</span> *<span class="title">pix_fmts</span>;</span>     <span class="comment">///&lt; array of supported pixel formats, or NULL if unknown, array is terminated by -1</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> *supported_samplerates;       <span class="comment">///&lt; array of supported audio samplerates, or NULL if unknown, array is terminated by 0</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">enum</span> <span class="title">AVSampleFormat</span> *<span class="title">sample_fmts</span>;</span> <span class="comment">///&lt; array of supported sample formats, or NULL if unknown, array is terminated by -1</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> *channel_layouts;         <span class="comment">///&lt; array of support channel layouts, or NULL if unknown. array is terminated by 0</span></span><br><span class="line">    <span class="keyword">uint8_t</span> max_lowres;                     <span class="comment">///&lt; maximum value for lowres supported by the decoder, no direct access, use av_codec_get_max_lowres()</span></span><br><span class="line">    <span class="keyword">const</span> AVClass *priv_class;              <span class="comment">///&lt; AVClass for the private context</span></span><br><span class="line">    <span class="keyword">const</span> AVProfile *profiles;              <span class="comment">///&lt; array of recognized profiles, or NULL if unknown, array is terminated by &#123;FF_PROFILE_UNKNOWN&#125;</span></span><br><span class="line">    <span class="keyword">int</span> priv_data_size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AVCodec</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">int</span> (*init_thread_copy)(AVCodecContext *);</span><br><span class="line">    <span class="keyword">int</span> (*update_thread_context)(AVCodecContext *dst, <span class="keyword">const</span> AVCodecContext *src);</span><br><span class="line">    <span class="keyword">const</span> AVCodecDefault *defaults;</span><br><span class="line">    <span class="keyword">void</span> (*init_static_data)(struct AVCodec *codec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*init)(AVCodecContext *);</span><br><span class="line">    <span class="keyword">int</span> (*encode_sub)(AVCodecContext *, <span class="keyword">uint8_t</span> *buf, <span class="keyword">int</span> buf_size,</span><br><span class="line">    <span class="keyword">int</span> (*encode2)(AVCodecContext *avctx, AVPacket *avpkt, <span class="keyword">const</span> AVFrame *frame,</span><br><span class="line">                   <span class="keyword">int</span> *got_packet_ptr);</span><br><span class="line">    <span class="keyword">int</span> (*decode)(AVCodecContext *, <span class="keyword">void</span> *outdata, <span class="keyword">int</span> *outdata_size, AVPacket *avpkt);</span><br><span class="line">    <span class="keyword">int</span> (*close)(AVCodecContext *);</span><br><span class="line">    <span class="keyword">void</span> (*flush)(AVCodecContext *);</span><br><span class="line">    <span class="keyword">int</span> caps_internal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>name</code>ï¼šå…·ä½“çš„ CODEC çš„åç§°çš„ç®€çŸ­æè¿°ï¼Œæ¯”å¦‚â€œHEVCâ€ã€â€œH264â€ç­‰ã€‚</li><li><code>long_nameï¼šCODEC</code> åç§°çš„è¯¦ç»†æè¿°ï¼Œæ¯”å¦‚â€œHEVC (High Efficiency Video Coding)â€ã€‚</li><li><code>id</code>ï¼šå”¯ä¸€æ ‡è¯†çš„ CODEC ç±»å‹ï¼Œæ¯”å¦‚ AV_CODEC_ID_HEVCã€‚</li><li><code>type</code>ï¼šåª’ä½“ç±»å‹çš„å­—æ®µï¼Œå®ƒæ˜¯ enum å‹çš„ï¼Œè¡¨ç¤ºè§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•ç­‰ï¼Œæ¯”å¦‚<code>AVMEDIA_TYPE_VIDEO</code>ã€<code>AVMEIDA_TYPE_AUDIO</code>ã€‚</li><li><code>supported_framerates</code>ï¼šæ”¯æŒçš„è§†é¢‘å¸§ç‡çš„æ•°ç»„ï¼Œä»¥{0ï¼Œ0}ä½œä¸ºç»“æŸã€‚</li><li><code>pix_fmts</code>ï¼šç¼–è§£ç å™¨æ”¯æŒçš„å›¾åƒæ ¼å¼çš„æ•°ç»„ï¼Œä»¥ -1 ä½œä¸ºç»“æŸã€‚</li><li><code>profiles</code>ï¼šç¼–è§£ç å™¨æ”¯æŒçš„ Profileï¼Œä»¥ HEVC ä¸ºä¾‹ï¼ŒåŒ…å«â€œMainâ€ã€â€œMain10â€ã€â€œMain Still Pictureâ€ã€‚</li></ul><p>æ¯ä¸€ä¸ªç¼–è§£ç å™¨å¯¹åº”ä¸€ä¸ª AVCodec ç»“æ„ä½“ï¼Œå¯¹åº”ä¸€ç§ç¼–è§£ç æ–¹å¼ï¼Œæ¯”å¦‚ HEVCã€AVCã€MPEG2ã€MPEG4ã€VP6ã€VP8ã€VP9ç­‰ã€‚ä»¥ HEVC ä¸ºä¾‹ï¼ŒFFMpegä¸­å…³äº AVCodec çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">AVCodec ff_hevc_decoder = &#123;</span><br><span class="line">    .name                  = <span class="string">&quot;hevc&quot;</span>,</span><br><span class="line">    .long_name             = NULL_IF_CONFIG_SMALL(<span class="string">&quot;HEVC (High Efficiency Video Coding)&quot;</span>),</span><br><span class="line">    .type                  = AVMEDIA_TYPE_VIDEO,</span><br><span class="line">    .id                    = AV_CODEC_ID_HEVC,</span><br><span class="line">    .priv_data_size        = <span class="keyword">sizeof</span>(HEVCContext),</span><br><span class="line">    .priv_class            = &amp;hevc_decoder_class,</span><br><span class="line">    .init                  = hevc_decode_init,</span><br><span class="line">    .close                 = hevc_decode_free,</span><br><span class="line">    .decode                = hevc_decode_frame,</span><br><span class="line">    .flush                 = hevc_decode_flush,</span><br><span class="line">    .update_thread_context = hevc_update_thread_context,</span><br><span class="line">    .init_thread_copy      = hevc_init_thread_copy,</span><br><span class="line">    .capabilities          = AV_CODEC_CAP_DR1 | AV_CODEC_CAP_DELAY |</span><br><span class="line">                             AV_CODEC_CAP_SLICE_THREADS | AV_CODEC_CAP_FRAME_THREADS,</span><br><span class="line">    .profiles              = NULL_IF_CONFIG_SMALL(profiles),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>AVCodecé€šå¸¸ç”¨æ³•ï¼š</p><ol type="1"><li>æ ¹æ®ç‰¹å®šIDæ‰¾åˆ°ç‰¹å®šçš„ç¼–è§£ç å™¨ï¼›</li><li>æ ¹æ®ç‰¹å®šç¼–è§£ç å™¨åˆ†é…å‡ºç‰¹å®šçš„æè¿°ç¼–è§£ç ä¸Šä¸‹æ–‡çš„ AVCodecContext ç»“æ„ä½“ï¼›</li><li>æ‰“å¼€ç¼–è§£ç å™¨ï¼›</li><li>è°ƒç”¨ç¼–è§£ç å™¨è¿›è¡Œç¼–è§£ç ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AVCodec *codec = <span class="literal">NULL</span>;</span><br><span class="line">AVCodecContext *ctx = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">codec = avcodec_find_decoder(origin_ctx-&gt;codec_id);</span><br><span class="line">ctx = avcodec_alloc_context3(codec);</span><br><span class="line">avcodec_open2(ctx, codec, <span class="literal">NULL</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="avcodeccontext">AVCodecContext</h3><p>ç¼–è§£ç ä¸Šä¸‹æ–‡ã€‚è¿æ¥ç¼–è§£ç å„ä¸ªè¿‡ç¨‹ã€‚æœ€å¤æ‚çš„ç»“æ„ä½“ï¼Œé‡Œé¢å®šä¹‰çš„å˜é‡æœ‰äº›æ˜¯ç¼–ç æ—¶å€™ç”¨åˆ°ï¼Œæœ‰äº›æ˜¯è§£ç æ—¶å€™ç”¨åˆ°ã€‚</p><ul><li><code>codec_type</code>ï¼šç¼–è§£ç å™¨çš„ç±»å‹ï¼Œå¦‚éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ã€‚</li><li><code>AVCdec *codec</code>ï¼šç¼–è§£ç å™¨å¯¹è±¡ã€‚</li><li><code>bit_rate</code>ï¼šå¹³å‡æ¯”ç‰¹ç‡ã€‚</li><li><code>width</code>ã€<code>height</code>ï¼šè§†é¢‘çš„å®½é«˜ã€‚</li><li><code>refs</code>ï¼šè¿åŠ¨ä¼°è®¡å‚è€ƒå¸§çš„ä¸ªæ•°ã€‚</li><li><code>sample_rate</code>ï¼šé‡‡æ ·ç‡ã€‚</li><li><code>channels</code>ï¼šå£°é“æ•°ã€‚</li></ul><p>AVCodecContext ä½¿ç”¨ <code>avcodec_alloc_context3</code> åˆ†é…ï¼Œè¯¥å‡½æ•°é™¤äº†åˆ†é… AVCodecContext å¤–ï¼Œè¿˜ä¼šåˆå§‹åŒ–é»˜è®¤çš„å­—æ®µã€‚åˆ†é…çš„å†…å­˜å¿…é¡»é€šè¿‡ <code>avcodec_free_context</code> é‡Šæ”¾ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸é”€æ¯</span></span><br><span class="line"><span class="function">AVCodecContext** <span class="title">avcodec_alloc_context3</span><span class="params">(<span class="keyword">const</span> AVCodec* codec)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">avcodec_free_context</span><span class="params">(AVCodecContext** avctx)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="avframe">AVFrame</h3><p>æœªå‹ç¼©æ•°æ®å¸§ï¼Œåƒç´ åŸŸç»“æ„ä½“ï¼Œï¼ˆè§†é¢‘å¯¹åº”RGB/YUVåƒç´ æ•°æ®ï¼ŒéŸ³é¢‘å¯¹åº”PCMé‡‡æ ·æ•°æ®ï¼‰ã€‚</p><p>å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">AVFrame</span>&#123;</span></span><br><span class="line"><span class="keyword">uint8_t</span> *data[AV_NUM_DATA_POINTERS];</span><br><span class="line"><span class="keyword">int</span> linesize[AV_NUM_DATA_POINTERS];</span><br><span class="line"><span class="keyword">uint8_t</span> **extended_data;</span><br><span class="line"><span class="keyword">int</span> width, height;</span><br><span class="line"><span class="keyword">int</span> nb_samples; <span class="comment">/* number of audio samples(per channel) described by this frame */</span></span><br><span class="line"><span class="keyword">int</span> format;</span><br><span class="line"><span class="keyword">int</span> key_frame; <span class="comment">/* 1-&gt;keyframe, 0-&gt;not*/</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">AVPictureType</span> <span class="title">pict_type</span>;</span></span><br><span class="line">AVRational sample_aspect_ratio;</span><br><span class="line"><span class="keyword">int64_t</span> pts;</span><br><span class="line"><span class="keyword">int64_t</span> pkt_pts;</span><br><span class="line"><span class="keyword">int64_t</span> pkt_dts;</span><br><span class="line"><span class="keyword">int</span> coded_picture_number;</span><br><span class="line"><span class="keyword">int</span> display_picture_number;</span><br><span class="line"><span class="keyword">int</span> quality;</span><br><span class="line"><span class="keyword">void</span> *opaque; <span class="comment">/* for some private data of the user */</span></span><br><span class="line"><span class="keyword">uint64_t</span> error[AV_NUM_DATA_POINTERS];</span><br><span class="line"><span class="keyword">int</span> repeat_pict;</span><br><span class="line"><span class="keyword">int</span> interlaced_frame;</span><br><span class="line"><span class="keyword">int</span> top_field_first;<span class="comment">/* If the content is interlaced, is top field displayed first */</span></span><br><span class="line"><span class="keyword">int</span> palette_has_changed;</span><br><span class="line">    <span class="keyword">int64_t</span> reordered_opaque;</span><br><span class="line">    <span class="keyword">int</span> sample_rate;    <span class="comment">/*Sample rate of the audio data*/</span></span><br><span class="line">    <span class="keyword">uint64_t</span> channel_layout; <span class="comment">/*channel layout of the audio data*/</span></span><br><span class="line">    AVBufferRef *buf[AV_NUM_DATA_POINTERS];</span><br><span class="line">    AVBufferRef **extended_buf;</span><br><span class="line">    <span class="keyword">int</span> nb_exteneded_buf;</span><br><span class="line">    AVFrameSideData **side_data;</span><br><span class="line">    <span class="keyword">int</span> nb_side_data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">AVColorRange</span> <span class="title">color_range</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">AVColorPrimaries</span> <span class="title">color_primaries</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">AVColorTransferCharacteristic</span> <span class="title">color_trc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">AVColorSpace</span> <span class="title">colorspace</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">AVChromaLocation</span> <span class="title">chroma_location</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> best_effort_timestamp;</span><br><span class="line">    <span class="keyword">int64_t</span> pkt_pos;</span><br><span class="line">    <span class="keyword">int64_t</span> pkt_duration;</span><br><span class="line">    AVDictionary *metadata;</span><br><span class="line">    <span class="keyword">int</span> decode _error_flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> channels;</span><br><span class="line">    <span class="keyword">int</span> pkt_size;</span><br><span class="line">    AVBufferRef *qp_table_buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>data</code>ï¼šæŒ‡å‘å›¾ç‰‡æˆ–ä¿¡é“çš„æŒ‡é’ˆï¼Œä¸åˆå§‹åŒ–æ—¶åˆ†é…çš„å¤§å°å¯èƒ½ä¸åŒï¼Œä¸€äº›è§£ç å™¨å–æ•°æ®èŒƒå›´è¶…å‡º(0,0)-(width, height)ï¼Œå…·ä½“è¯·æŸ¥çœ‹<code>avcodec_align_dimensions2()</code>æ–¹æ³•ã€‚ä¸€äº›è¿‡æ»¤å™¨æˆ–æ‰«æå™¨è¯»æ•°æ®æ—¶å¯èƒ½ä¼šè¶…è¿‡ 16 å­—èŠ‚ï¼Œæ‰€ä»¥å½“å®ƒä»¬ä½¿ç”¨æ—¶ï¼Œå¿…é¡»é¢å¤–åˆ†é… 16 å­—èŠ‚ã€‚å¯¹äº packed æ ¼å¼çš„æ•°æ®(ä¾‹å¦‚ RGB24)ï¼Œä¼šå­˜æ”¾åˆ° data[0] é‡Œé¢ï¼›å¯¹äº planar æ ¼å¼çš„æ•°æ®(ä¾‹å¦‚ YUV420P)ï¼Œåˆ™ä¼šåˆ†å¼€ data[0]/data[1]/data[2]ï¼ˆYUV420P ä¸­ data[0] å­˜æ”¾ Yï¼Œdata[1] å­˜æ”¾ Uï¼Œdata[2] å­˜æ”¾ Vï¼‰ã€‚</li><li><code>linesize</code>ï¼šå¯¹äºè§†é¢‘æ•°æ®ï¼Œè¡¨ç¤ºæ¯ä¸ªå›¾åƒè¡Œçš„å­—èŠ‚å¤§å°ï¼›å¯¹äºéŸ³é¢‘æ•°æ®ï¼Œè¡¨ç¤ºæ¯ä¸ª Plane çš„å­—èŠ‚å¤§å°ï¼Œåªæœ‰linesize[0]å¯ä»¥è®¾ç½®ï¼Œå¯¹äºplane éŸ³é¢‘ï¼Œæ¯ä¸ªä¿¡é“ channel å¿…é¡»æ˜¯ç›¸åŒçš„ã€‚å¯¹äºè§†é¢‘çš„ linesize åº”ä¸º CPU çš„å¯¹å‡†è¦æ±‚çš„å€æ•°ï¼Œä¸€èˆ¬ä¸º 32 çš„å€æ•°ã€‚æ³¨æ„ linesize å¯å¤§äºå¯ç”¨çš„æ•°æ®çš„å°ºå¯¸ï¼Œæœ‰å¯èƒ½å­˜åœ¨ç”±äºæ€§èƒ½åŸå› é¢å¤–å¡«å……ã€‚</li><li><code>width</code>/<code>height</code>ï¼šè§†é¢‘çš„å®½é«˜ã€‚</li><li><code>format</code>ï¼šå¸§æ ¼å¼ï¼Œ-1è¡¨ç¤ºæœªè®¾ç½®çš„å¸§æ ¼å¼ã€‚å¯¹äºè§†é¢‘å¸§ï¼Œè¯¥å€¼ä¸º enum ç±»å‹çš„ AVPixelFormatï¼Œä¾‹å¦‚ <code>AV_PIX_FMT_YUV420P</code>ï¼›å¯¹äºéŸ³é¢‘å¸§ï¼Œè¯¥å€¼ä¸º enum å‹çš„ AVSampleFormatï¼Œä¾‹å¦‚ <code>AV_SAMPLE_FMT_S16</code>ã€‚</li><li><code>key_frame</code>ï¼šå…³é”®å¸§ï¼Œ1 è¡¨ç¤ºå…³é”®å¸§ï¼Œ0 è¡¨ç¤ºéå…³é”®å¸§ã€‚</li><li><code>pict_type</code>ï¼šå¸§å›¾ç‰‡ç±»å‹ï¼Œä¾‹å¦‚ I/P/Bã€‚</li><li><code>sample_aspect_ration</code>ï¼šå¸§åƒç´ çš„å®½é«˜æ¯”ï¼Œä½¿ç”¨ AVRational è¡¨ç¤ºã€‚</li><li><code>pts</code>ï¼šæ˜¾ç¤ºæ—¶é—´æˆ³ï¼Œå•ä½ä¸º <code>time_base</code>ã€‚</li><li><code>pkt_pts</code>ï¼šè¯¥ PTS æ˜¯ä» AVPacket ç»“æ„ä¸­æ‹·è´è¿‡æ¥çš„ï¼›ä¸ä¹‹å¯¹åº”çš„æ˜¯<code>pkt_dts</code>ã€‚</li><li><code>coded_picture_number</code>/<code>display_picture_number</code>ï¼šè§£ç åºåˆ—å·å’Œæ˜¾ç¤ºåºåˆ—å·ï¼ˆDisplay Order/Decoded Orderï¼‰ã€‚</li><li><code>interlaced_frame</code>ï¼šè¡¨ç¤ºè¯¥å¸§ä¸ºéš”è¡Œï¼ˆinterlaceï¼‰ç æµæˆ–è€…ä¸ºé€è¡Œï¼ˆprogressiveï¼‰ç æµã€‚</li><li><code>top_field_first</code>ï¼šå¯¹äºéš”è¡Œç æµï¼Œè¡¨ç¤ºè¯¥å®ƒæ˜¯ top first or bottom firstã€‚</li></ul><p>AVFrame ç»“æ„ä½“é€šå¸¸åªéœ€åˆ†é…ä¸€æ¬¡ï¼Œä¹‹åå³å¯é€šè¿‡ä¿å­˜ä¸åŒçš„æ•°æ®æ¥é‡å¤å¤šæ¬¡ä½¿ç”¨ï¼Œæ¯”å¦‚ä¸€ä¸ª AVFrame ç»“æ„å¯ä»¥ä¿å­˜ä»è§£ç å™¨ä¸­è§£ç å‡ºçš„å¤šå¸§æ•°æ®ã€‚æ­¤æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>av_frame_unref()</code>é‡Šæ”¾ä»»ä½•ç”± Frame ä¿å­˜çš„å‚è€ƒå¸§å¹¶è¿˜åŸå›æœ€åŸå§‹çš„çŠ¶æ€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸é”€æ¯</span></span><br><span class="line"><span class="function">AVFrame* <span class="title">av_frame_alloc</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">av_frame_free</span><span class="params">(AVFrame** frame)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¡«å……ç©ºé—´</span></span><br><span class="line">av_image_fill_arrays(</span><br><span class="line">    <span class="keyword">uint8_t</span>* dst_data[<span class="number">4</span>], <span class="keyword">int</span> dst_linesize[<span class="number">4</span>], <span class="keyword">const</span> <span class="keyword">uint8_t</span>* src,</span><br><span class="line">    <span class="keyword">enum</span> AVPixelFormat pix_fmt, <span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> align</span><br><span class="line">);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;å…³é”®çš„ç»“æ„ä½“å¯åˆ†æˆä»¥ä¸‹å‡ ç±»ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;è§£åè®®ï¼ˆhttpã€rtspã€rtmpã€mmsï¼‰&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegå¸¸ç”¨å‘½ä»¤</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_command/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_command/</id>
    <published>2021-06-10T01:36:18.000Z</published>
    <updated>2021-10-02T04:20:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸‹è½½å·²ç¼–è¯‘çš„é™æ€åº“ï¼šhttps://evermeet.cx/ffmpeg/</p><h2 id="å‘½ä»¤åˆ†ç±»">å‘½ä»¤åˆ†ç±»</h2><ul><li>åŸºæœ¬ä¿¡æ¯æŸ¥è¯¢</li><li>å½•åˆ¶</li><li>åˆ†è§£ã€å¤ç”¨</li><li>å¤„ç†åŸå§‹æ•°æ®</li><li>è£å‰ªä¸åˆå¹¶</li><li>å›¾ç‰‡/è§†é¢‘äº’è½¬</li><li>ç›´æ’­</li><li>æ»¤é•œ</li></ul><h2 id="åŸºæœ¬ä¿¡æ¯æŸ¥è¯¢">åŸºæœ¬ä¿¡æ¯æŸ¥è¯¢</h2><p>ç‰ˆæœ¬ä¿¡æ¯ï¼š</p><ul><li><code>-version</code></li></ul><p>æ”¯æŒçš„åˆ†è§£ã€å¤ç”¨ï¼š</p><ul><li><code>-demuxers</code></li><li><code>-muxers</code></li></ul><p>æ”¯æŒçš„è®¾å¤‡ï¼š</p><ul><li><code>-devices</code></li></ul><p>æ”¯æŒçš„ï¼ˆlibavcodecå·²çŸ¥çš„ï¼‰ç¼–è§£ç å™¨ï¼š</p><ul><li><code>-codecs</code></li><li><code>-decoders</code></li><li><code>-encoders</code></li></ul><p>libavfilteræ”¯æŒçš„ç æµæ»¤é•œï¼š</p><ul><li><code>-bsfs</code></li></ul><p>æ”¯æŒçš„æ ¼å¼ï¼š</p><ul><li><code>-formats</code>ï¼Œæ”¯æŒçš„æ–‡ä»¶æ ¼å¼</li><li><code>-protocols</code>ï¼Œç½‘ç»œåè®®</li><li><code>-pix_fmts</code>ï¼Œåƒç´ æ ¼å¼</li><li><code>-sample_fmts</code>ï¼Œé‡‡æ ·æ ¼å¼</li><li><code>-layouts</code>ï¼Œå£°é“å¸ƒå±€</li></ul><p>æ”¯æŒçš„æ»¤é•œï¼š</p><ul><li><code>-filters</code></li></ul><p>æ”¯æŒçš„é¢œè‰²åç§°ï¼š</p><ul><li><code>-colors</code></li></ul><h2 id="å‘½ä»¤åŸºæœ¬æ ¼å¼ä¸å‚æ•°">å‘½ä»¤åŸºæœ¬æ ¼å¼ä¸å‚æ•°</h2><p>ffmpegå‘½ä»¤åŸºæœ¬æ ¼å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg [å…¨å±€å‚æ•°] &#123;[è¾“å…¥æ–‡ä»¶å‚æ•°] -i è¾“å…¥æ–‡ä»¶URL&#125; ...\</span><br><span class="line">       &#123;[è¾“å‡ºæ–‡ä»¶å‚æ•°] è¾“å‡ºæ–‡ä»¶URL&#125; ...</span><br></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒFFmpegåªåŒ…å«è¾“å…¥æ–‡ä»¶ä¸­æ¯ç§åª’ä½“ç±»å‹ï¼ˆéŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ï¼‰çš„ä¸€ä¸ªæµï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æ¯ä¸ªè¾“å‡ºæ–‡ä»¶ä¸­ã€‚å®ƒæ ¹æ®ä¸€ä¸‹è§„åˆ™é€‰æ‹©æ¯ç§åª’ä½“ç±»å‹ä¸­çš„æµï¼š</p><ul><li>è§†é¢‘ï¼Œé€‰æ‹©æœ€é«˜åˆ†è¾¨ç‡çš„æµã€‚</li><li>éŸ³é¢‘ï¼Œé€‰æ‹©å£°é“æœ€å¤šçš„æµã€‚</li><li>å­—å¹•ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªæµã€‚</li></ul><p>å½“ç„¶ä¸Šè¿°è§„åˆ™ç›¸ç­‰ï¼Œåˆ™ä¼˜å…ˆé€‰å–æœ€ä½ç´¢å¼•å€¼çš„æµã€‚</p><p>å¯ä»¥é€šè¿‡<code>-vn</code>ã€<code>-an</code>ã€<code>-sn</code>ã€<code>-dn</code>æ¥ç¦ç”¨æŸäº›åª’ä½“ç±»å‹ã€‚è¦è¿›è¡Œå…¨é¢çš„æ‰‹åŠ¨æ§åˆ¶ï¼Œåˆ™ä½¿ç”¨<code>-map</code>é€‰é¡¹ã€‚</p><p>ffmpegé€šè¿‡<code>-i</code>é€‰é¡¹è¯»å–ä»»æ„æ•°é‡çš„è¾“å…¥ï¼ˆå¯ä»¥æ˜¯æ–‡ä»¶ã€ç®¡é“ã€ç½‘ç»œæµã€æŠ“å–è®¾å¤‡ç­‰ï¼‰ï¼Œå¹¶å†™å…¥ä»»æ„æ•°é‡çš„è¾“å‡ºã€‚åŸåˆ™ä¸Šï¼Œæ¯ä¸ªè¾“å…¥/è¾“å‡ºéƒ½å¯ä»¥åŒ…å«ä»»æ„æ•°é‡çš„ä¸åŒç±»å‹çš„åª’ä½“æµï¼ˆè§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•ã€é™„ä»¶/æ•°æ®ï¼‰ã€‚æµçš„æ•°é‡å’Œ/æˆ–ç±»å‹æ˜¯ç”±å®¹å™¨æ ¼å¼æ¥é™åˆ¶ï¼Œé€‰æ‹©ä»å“ªä¸ªè¾“å…¥è¿›æ¥åˆ°å“ªä¸ªè¾“å‡ºå°†è‡ªåŠ¨å®Œæˆï¼Œå¦‚éœ€æ§åˆ¶åˆ™ä½¿ç”¨<code>-map</code>é€‰é¡¹ã€‚</p><p>è¦å¼•ç”¨é€‰é¡¹ä¸­çš„è¾“å…¥ï¼Œå¿…é¡»ä½¿ç”¨ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€ä¸ªè¾“å…¥æ˜¯0ã€‚æ–‡ä»¶ä¸­çš„åª’ä½“æµä¹Ÿå¯ä»¥é€šè¿‡ç´¢å¼•å¼•ç”¨ï¼Œå¦‚<code>2:3</code>æ˜¯æŒ‡ç¬¬ä¸‰ä¸ªè¾“å…¥ä¸­çš„ç¬¬å››ä¸ªæµã€‚</p><h3 id="ä¸»è¦å‚æ•°">ä¸»è¦å‚æ•°</h3><ul><li><code>-f fmt</code>ï¼Œè¾“å…¥/è¾“å‡ºå¼ºåˆ¶çš„æ–‡ä»¶æ ¼å¼ã€‚æ ¼å¼é€šå¸¸å¯ä»¥é€šè¿‡æ‰©å±•åä¸­çŒœæµ‹å‡ºæ¥ï¼Œå› æ­¤ä¸å¸¸ä½¿ç”¨ã€‚</li><li><code>-i url</code>ï¼Œè¾“å…¥URLã€‚</li><li><code>-y</code>ï¼Œå…¨å±€å‚æ•°ï¼Œè¦†ç›–è¾“å‡ºæ–‡ä»¶è€Œä¸è¯¢é—®ã€‚</li><li><code>-n</code>ï¼Œå…¨å±€å‚æ•°ï¼Œä¸è¦†ç›–è¾“å‡ºæ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨æŒ‡å®šæ–‡ä»¶åˆ™é€€å‡ºã€‚</li><li><code>-c [:stream_specifier] codec</code>ã€<code>-codec [:stream_specifier] codec</code>ï¼Œè¾“å…¥ã€è¾“å‡ºã€å•ä¸ªæµï¼Œé€‰æ‹©ä¸€ä¸ªè§£ç å™¨ï¼ˆåœ¨è¾“å…¥æ–‡ä»¶ä¹‹å‰ä½¿ç”¨ï¼‰æˆ–ç¼–ç å™¨ï¼ˆåœ¨è¾“å‡ºæ–‡ä»¶å‰ä½¿ç”¨ï¼‰ï¼Œå¯ç”¨äºä¸€ä¸ªæˆ–å¤šä¸ªæµã€‚ä¼ é€’ç¼–ç å™¨åç§°æˆ–<code>copy</code>ï¼ˆä»…è¾“å‡ºï¼‰è¡¨ç¤ºä¸é‡æ–°ç¼–ç ã€‚</li><li><code>-t duration</code>ï¼Œè¾“å…¥ã€è¾“å‡ºï¼Œå½“ç”¨ä½œè¾“å…¥é€‰é¡¹ï¼ˆåœ¨<code>-i</code>ä¹‹å‰ï¼‰ï¼Œè¡¨ç¤ºé™åˆ¶ä»è¾“å…¥æ–‡ä»¶è¯»å–çš„æ•°æ®çš„æ—¶é•¿ï¼›å½“ç”¨ä½œè¾“å‡ºé€‰é¡¹æ—¶ï¼ˆåœ¨è¾“å‡ºurlä¹‹å‰ï¼‰ï¼Œè¡¨ç¤ºåœ¨åˆ°è¾¾æ—¶é•¿ä¹‹ååœæ­¢è¾“å‡ºã€‚</li><li><code>-ss position</code>ï¼Œè¾“å…¥ã€è¾“å‡ºï¼Œå½“ç”¨ä½œè¾“å…¥é€‰é¡¹ï¼ˆåœ¨<code>-i</code>ä¹‹å‰ï¼‰ï¼Œè¡¨ç¤ºåœ¨è¾“å…¥æ–‡ä»¶ä¸­å¯»æ‰¾ä½ç½®ã€‚æ³¨æ„ï¼Œåœ¨å¤§å¤šæ•°æ ¼å¼ä¸­ï¼Œä¸å¯èƒ½ç²¾ç¡®æœç´¢ï¼Œå› æ­¤ffmpegå°†åœ¨ä½ç½®ä¹‹å‰å¯»æ‰¾æœ€è¿‘çš„ç‚¹ã€‚å½“è½¬ç å’Œ<code>-accureate_seek</code>è¢«å¯ç”¨æ—¶ï¼ˆé»˜è®¤ï¼‰ï¼Œæœç´¢ç‚¹å’ŒæŒ‡å®šçš„ä½ç½®ä¹‹é—´çš„é¢å¤–åˆ†æ®µå°†è¢«è§£ç å’Œä¸¢å¼ƒã€‚å½“è¿›è¡Œæµå¼å¤åˆ¶æˆ–ä½¿ç”¨<code>-noaccureate_seek</code>æ—¶ï¼Œå®ƒå°†è¢«ä¿ç•™ã€‚å½“ç”¨ä½œè¾“å‡ºé€‰é¡¹ï¼ˆåœ¨è¾“å‡ºurlä¹‹å‰ï¼‰ï¼Œè§£ç ä½†ä¸¢å¼ƒè¾“å…¥ï¼ŒçŸ¥é“æ—¶é—´æˆ³åˆ°è¾¾æŒ‡å®šçš„ä½ç½®ã€‚</li><li><code>frames [:stream_specifier] framecount</code>ï¼Œè¾“å‡ºã€å•ä¸ªæµï¼Œåœæ­¢åœ¨ç»™å®šå¸§æ•°é‡åå†™å…¥æµã€‚</li><li><code>filter [:stream_specifier] filtergraph</code>ï¼Œè¾“å‡ºã€å•ä¸ªæµï¼Œåˆ›å»ºç”±filtergraphæŒ‡å®šçš„æ»¤é•œé“¾å›¾ï¼Œå¹¶å°†å…¶è¿›è¡Œå¤„ç†æµã€‚filtergraphçš„æµå¿…é¡»å…·æœ‰ç›¸åŒç±»å‹çš„å•ä¸ªè¾“å…¥å’Œå•ä¸ªè¾“å‡ºã€‚åœ¨filtergraphä¸­ï¼Œè¾“å…¥ä¸æ ‡ç­¾ç›¸å…³è”ï¼Œæ ‡ç­¾ä¸è¾“å‡ºç›¸å…³è”ã€‚</li></ul><h3 id="è§†é¢‘å‚æ•°">è§†é¢‘å‚æ•°</h3><ul><li><code>-vframes num</code>ï¼Œè¾“å‡ºï¼Œè®¾ç½®è¦è¾“å‡ºçš„è§†é¢‘å¸§æ•°é‡ã€‚</li><li><code>-r [:stream_specifier] fps</code>ï¼Œè¾“å…¥ã€è¾“å‡ºã€å•ä¸ªæµï¼Œè®¾ç½®å¸§ç‡ï¼ˆå•ä½Hzï¼‰ã€‚<ul><li>ä½œä¸ºè¾“å…¥é€‰é¡¹ï¼Œå¿½ç•¥å­˜å‚¨æ–‡ä»¶ä¸­çš„è®©å’Œæ—¶é—´æˆ³ï¼Œæ ¹æ®é€Ÿç‡ç”Ÿæˆæ–°çš„æ—¶é—´æˆ³ã€‚è¿™ä¸ç”¨äº<code>-framerate</code>é€‰é¡¹ä¸åŒï¼ˆæ—§ç‰ˆæ˜¯ç›¸åŒçš„ï¼‰ã€‚</li><li>ä½œä¸ºè¾“å‡ºé€‰é¡¹ï¼Œå¤åˆ¶æˆ–ä¸¢å¼ƒè¾“å…¥å¸§ä»¥å®ç°å¾ˆå®šè¾“å‡ºå¸§ç‡ã€‚</li></ul></li><li><code>-s [:stream_specifier] size</code>ï¼Œè¾“å…¥ã€è¾“å‡ºã€å•ä¸ªæµï¼Œè®¾ç½®çª—å£å¤§å°ã€‚<ul><li>ä½œä¸ºè¾“å…¥é€‰é¡¹ï¼Œä¸<code>video_size</code>ç›¸åŒï¼Œç”±æŸäº›åˆ†å¸§å™¨è¯†åˆ«ï¼Œå…¶å¸§å°ºå¯¸æœªå­˜å‚¨åœ¨æ–‡ä»¶ä¸­ã€‚</li><li>ä½œä¸ºè¾“å‡ºé€‰é¡¹ï¼Œè¿™å°†ä¼šæŠŠç¼©æ”¾è§†é¢‘æ»¤é•œä¼ è¾“åˆ°ç›¸åº”çš„æ»¤é•œé“¾å›¾æœ«å°¾ã€‚è¯·ç›´æ¥ä½¿ç”¨æ¯”ä¾‹æ»¤é•œæ’å…¥æ»¤é•œé“¾å›¾å¼€å¤´æˆ–å…¶ä»–åœ°æ–¹ã€‚æ ¼å¼æ˜¯<code>å®½xé«˜</code>ã€‚</li></ul></li><li><code>-aspect [:stream_specifier] ratio</code>ï¼Œè¾“å‡ºã€å•ä¸ªæµï¼ŒæŒ‡å®šè§†é¢‘çš„å®½é«˜æ¯”ã€‚å€¼å¯ä»¥æ˜¯æµ®ç‚¹æ•°å­—ä¹Ÿå¯ä»¥æ˜¯<code>w:h</code>å­—ç¬¦ä¸²ï¼Œå¦‚<code>4:3</code>ã€<code>16:9</code>ã€‚å¦‚æœä¸<code>-vcodec</code>å‰¯æœ¬ä¸€èµ·ä½¿ç”¨ï¼Œä¼šå½±å“å­˜å‚¨åœ¨å®¹å™¨çº§åˆ«çš„å®½é«˜æ¯”ï¼Œä½†ä¸ä¼šå½±å“å­˜å‚¨åœ¨ç¼–ç å¸§ä¸­çš„å®½é«˜æ¯”ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ã€‚</li><li><code>-vn</code>ï¼Œè¾“å‡ºï¼Œç¦ç”¨è§†é¢‘è½¨é“ã€‚</li><li><code>-vf filtergraph</code>ï¼Œè¾“å‡ºï¼Œåˆ›å»ºç”±filtergraphæŒ‡å®šçš„æ»¤é•œé“¾å›¾ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥å¤„ç†æµã€‚</li></ul><h3 id="éŸ³é¢‘å‚æ•°">éŸ³é¢‘å‚æ•°</h3><ul><li><code>-aframes num</code>ï¼Œè¾“å‡ºï¼Œè®¾ç½®è¾“å‡ºéŸ³é¢‘çš„å¸§æ•°ã€‚</li><li><code>-ar [:stream_specifier] freq</code>ï¼Œè¾“å…¥ã€è¾“å‡ºã€å•ä¸ªæµï¼Œè®¾ç½®éŸ³é¢‘é‡‡æ ·ç‡ã€‚å¯¹äºè¾“å…¥æµï¼Œé»˜è®¤è®¾ç½®ä¸ºè¾“å…¥æµçš„é‡‡æ ·ç‡ã€‚å¯¹äºè¾“å‡ºæµï¼Œè¯¥é€‰é¡¹ä»…é€‚ç”¨äºéŸ³é¢‘è®¾å¤‡é‡‡é›†å’ŒåŸå§‹åˆ†è·¯å™¨ï¼Œå¹¶æ˜ å°„åˆ°ç›¸åº”çš„åˆ†è·¯å™¨é€‰ä»¶ã€‚</li><li><code>-an</code>ï¼Œè¾“å‡ºï¼Œç¦ç”¨éŸ³é¢‘è½¨é“ã€‚</li><li>-acodec nameï¼Œè¾“å…¥ã€è¾“å‡ºï¼Œè®¾ç½®éŸ³é¢‘ç¼–è§£ç å™¨ã€‚</li><li><code>-sample_fmt [:stream_specifier] fmt</code>ï¼Œè¾“å‡ºã€å•ä¸ªæµï¼Œè®¾ç½®éŸ³é¢‘é‡‡æ ·æ ¼å¼ã€‚ä½¿ç”¨<code>-sample_fmts</code>å¯ä»¥è·å¾—æ”¯æŒçš„é‡‡æ ·æ ¼å¼åˆ—è¡¨ã€‚</li><li><code>-af filtergraph</code>ï¼Œè¾“å‡ºï¼Œåˆ›å»ºç”±filtergraphæŒ‡å®šçš„æ»¤é•œé“¾å›¾ï¼Œå¹¶ç”¨å®ƒæ¥å¤„ç†éŸ³é¢‘ã€‚</li></ul><h2 id="å½•åˆ¶">å½•åˆ¶</h2><p>å½•åˆ¶å±å¹•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å½•åˆ¶çº¯è§†é¢‘</span></span><br><span class="line">ffmpeg -f avfoundation -i 1 -r 30 out.yuv</span><br><span class="line"><span class="comment"># æ’­æ”¾çº¯è§†é¢‘</span></span><br><span class="line">ffplay -s 3360x2100 -pix_fmt uyvy422 out.yuv</span><br><span class="line"></span><br><span class="line"><span class="comment"># å½•åˆ¶éŸ³è§†é¢‘</span></span><br><span class="line">ffmpeg -f avfoundation -i 1:0 -r 29.97 </span><br><span class="line">       -c:v libx264 -crf 0</span><br><span class="line">       -c:a libfdk_aac -profile:a aac_he_v2 -b:a 32k</span><br><span class="line">       out.flv</span><br></pre></td></tr></table></figure><ul><li><code>-f</code>ï¼ŒæŒ‡å®šä½¿ç”¨avfoundationè¿›è¡Œé‡‡é›†ã€‚</li><li><code>-i</code>ï¼ŒæŒ‡å®šè¾“å…¥ç´¢å¼•ã€‚</li><li><code>-r</code>ï¼ŒæŒ‡å®šå¸§ç‡ã€‚</li><li><code>-crf</code>ï¼Œx264å‚æ•°ï¼Œ0è¡¨ç¤ºæ— æŸå‹ç¼©ã€‚</li><li><code>-b:a</code>ï¼ŒæŒ‡å®šéŸ³é¢‘ç ç‡ã€‚</li></ul><p>å½•åˆ¶åï¼Œä¼šè¾“å‡ºå½•åˆ¶çš„æ ¼å¼ï¼Œåé¢è¿›è¡Œæ’­æ”¾è¦ä¼ å…¥è¿™äº›ä¿¡æ¯æ‰èƒ½æ­£ç¡®æ’­æ”¾ã€‚</p><p>åˆ—å‡ºæ”¯æŒçš„è®¾å¤‡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -f avfoundation -list_devices <span class="literal">true</span> -i <span class="string">&quot;&quot;</span></span><br><span class="line">[AVFoundation indev @ 0x7fa856d0c600] AVFoundation video devices:</span><br><span class="line">[AVFoundation indev @ 0x7fa856d0c600] [0] FaceTimeé«˜æ¸…æ‘„åƒå¤´ï¼ˆå†…å»ºï¼‰</span><br><span class="line">[AVFoundation indev @ 0x7fa856d0c600] [1] Capture screen 0</span><br><span class="line">[AVFoundation indev @ 0x7fa856d0c600] [2] Capture screen 1</span><br><span class="line">[AVFoundation indev @ 0x7fa856d0c600] AVFoundation audio devices:</span><br><span class="line">[AVFoundation indev @ 0x7fa856d0c600] [0] Built-in Microphone</span><br></pre></td></tr></table></figure><p>æ‘„åƒå¤´å½•åˆ¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -framerate 30 -f avfoundation -i 0:0 out.mp4</span><br></pre></td></tr></table></figure><p>å½•åˆ¶éŸ³é¢‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å½•åˆ¶</span></span><br><span class="line">ffmpeg -f avfoundation -i :0 output.wav</span><br><span class="line"><span class="comment"># æ’­æ”¾ï¼Œç”±äºå­˜æˆwavï¼Œæ‰€ä»¥å·²ç»å¸¦ä¸Šäº†éŸ³é¢‘çš„æ ¼å¼ï¼Œç›´æ¥æ’­æ”¾å³å¯ã€‚</span></span><br><span class="line">ffplay output.wav</span><br></pre></td></tr></table></figure><h2 id="åˆ†è§£ä¸å¤ç”¨">åˆ†è§£ä¸å¤ç”¨</h2><p>å¯¹å®¹å™¨å†…çš„æ•°æ®é‡æ–°ç»„è£…ï¼Œå½“ç„¶è¿™æ ·åšçš„å‰ææ˜¯å¯¹å®¹å™¨åª’ä½“æ–‡ä»¶è¿›è¡Œåˆ†è§£å½¢æˆç¼–ç æ•°æ®åŒ…ï¼Œå®Œæˆé‡æ–°ç»„è£…åè¿˜éœ€è¦è¿›è¡Œé‡æ–°å°è£…ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸å¯¹ç¼–ç æ•°æ®åŒ…åšä¿®æ”¹ï¼Œåªæ˜¯æ¢äº†ä¸ªé©¬ç”²ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¢åª’ä½“å®¹å™¨</span></span><br><span class="line">ffmpeg -i local.mp4 -vcodec copy -acodec copy local_output.mov</span><br><span class="line">ffmpeg -i local.mp4 -vcodec copy -acodec copy local_output.mkv</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ½å–è§†é¢‘ï¼Œå½“ç„¶h264åŒ…å«äº†SPSã€PPSï¼Œå¯ä»¥ç›´æ¥æ’­æ”¾</span></span><br><span class="line">ffmpeg -i local.mp4 -vcodec copy -an local_output.h264</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ½å–éŸ³é¢‘</span></span><br><span class="line">ffmpeg -i input.mp4 -acodec copy -vn out.aac</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢çš„å…³é”®æ˜¯<code>codec copy</code>ï¼Œå³å¿½ç•¥æŒ‡å®šæµçš„ç¼–è§£ç æ­¥éª¤ï¼Œä½†åŒæ—¶åŠŸèƒ½ä¹Ÿä¼šå—é™ï¼ˆä¾‹å¦‚ä¸èƒ½ä½¿ç”¨æ»¤é•œï¼Œå› ä¸ºæ»¤é•œæ˜¯ä½œç”¨äºæœªå‹ç¼©çš„æ•°æ®ï¼‰ï¼Œåªèƒ½è¿›è¡Œå¤šè·¯åˆ†è§£å’Œå¤šè·¯å¤ç”¨ã€‚å¯¹æ›´æ”¹å®¹å™¨æ ¼å¼æˆ–ä¿®æ”¹å®¹å™¨çº§å…ƒæ•°æ®å¾ˆæœ‰ç”¨ã€‚</p><p>æ•´ä¸ªè¿‡ç¨‹éå¸¸å¿«ï¼Œä¸”æ²¡æœ‰è´¨é‡æŸå¤±ã€‚</p><h2 id="å¤„ç†åŸå§‹æ•°æ®">å¤„ç†åŸå§‹æ•°æ®</h2><p>è¿™é‡Œçš„åŸå§‹æ•°æ®æ˜¯æŒ‡è§£ç åçš„æ•°æ®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æå–YUVæ•°æ®ï¼Œå…³é”®æ˜¯ä½¿ç”¨ -c:v rawvideo</span></span><br><span class="line">ffmpeg -i input.mp4 -an -c:v rawvideo -pix_fmt yuv420p out.yuv</span><br><span class="line"><span class="comment"># æ’­æ”¾YUV</span></span><br><span class="line">ffplay -s 1280x720 -pix_fmt yuv420p out.yuv</span><br><span class="line"></span><br><span class="line"><span class="comment"># æå–PCMæ•°æ®</span></span><br><span class="line">ffmpeg -i local.mp4 -vn -ar 44100 -ac 2 -f s16le out.pcm</span><br><span class="line"><span class="comment"># æ’­æ”¾ï¼ŒPCMæ˜¯ä¸å¸¦å…ƒæ•°æ®çš„ï¼Œæ‰€ä»¥æ’­æ”¾æ—¶éœ€è¦æ‰§è¡ŒéŸ³é¢‘æ ¼å¼</span></span><br><span class="line">ffplay -ar 44100 -ac 2 -f s16le out.pcm</span><br></pre></td></tr></table></figure><ul><li><code>-c:v</code>ï¼ŒæŒ‡å®šçš„æ˜¯ä½¿ç”¨è§†é¢‘ç¼–ç å™¨ï¼ŒæŠŠå®ƒæ¢æˆ<code>-vcodec</code>ä¹Ÿæ˜¯åŒæ ·çš„æ•ˆæœã€‚</li><li><code>-pix_fmt</code>ï¼ŒæŒ‡å®šåƒç´ æ ¼å¼ã€‚</li><li><code>-ar</code>ï¼ŒéŸ³é¢‘é‡‡æ ·ç‡ã€‚</li><li><code>-ac</code>ï¼Œå£°é“æ•°ã€‚</li><li><code>-f</code>ï¼Œæ•°æ®å­˜å‚¨æ ¼å¼ã€‚<ul><li><code>s16le</code>è¡¨ç¤ºsignçš„16ä½å°ç«¯æ¨¡å¼æ•´æ•°ã€‚</li></ul></li></ul><p>æ³¨æ„è¿™é‡Œçš„<code>-vcodec</code>ä¸€å®šè¦é€‰æ‹©<code>rawvideo</code>ï¼Œè€Œä¸æ˜¯<code>copy</code>ï¼›ç±»ä¼¼çš„ï¼ŒéŸ³é¢‘åˆ™ç›´æ¥ä¸è®¾ç½®<code>-acodec</code>ï¼Œè€Œæ˜¯ç›´æ¥æ¥éŸ³é¢‘çš„å‚æ•°ã€‚å¦åˆ™å®ƒä»¬è¾“å‡ºçš„ç»“æœéƒ½ä¸æ˜¯åŸå§‹æ•°æ®ã€‚</p><h2 id="æ»¤é•œ">æ»¤é•œ</h2><p>ä½¿ç”¨ç®€å•çš„è§†é¢‘ç”»å¹…è£å‰ªæ»¤é•œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mov</span><br><span class="line">       -vf crop=in_w-200:in_h-200</span><br><span class="line">       -c:v libx264 -c:a copy out.mp4</span><br></pre></td></tr></table></figure><ul><li><code>-vf</code>ï¼Œè§†é¢‘ç®€å•æ»¤é•œã€‚<ul><li><code>crop</code>æ»¤é•œåç§°ï¼Œåé¢ç­‰å·æ¥æ»¤é•œå‚æ•°ï¼Œ<code>in_w</code>ã€<code>in_h</code>å¼•ç”¨äº†åŸè§†é¢‘çš„å®½é«˜ï¼Œå¹¶ä½¿ç”¨å†’å·æ‹¼æ¥å‚æ•°ã€‚</li></ul></li></ul><h2 id="è£å‰ªä¸åˆå¹¶">è£å‰ªä¸åˆå¹¶</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è£å‰ª</span></span><br><span class="line">ffmpeg -i input.mp4</span><br><span class="line">       -ss 00:00:00 -t 10</span><br><span class="line">       out.ts</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå¹¶ï¼Œæ–‡æœ¬å†…å®¹æ¯ä¸€è¡Œå¿…é¡»ä¸º `file &#x27;æ–‡ä»¶è·¯å¾„&#x27;`</span></span><br><span class="line">ffmpeg -f concat -i inputs.txt out.flv</span><br></pre></td></tr></table></figure><h2 id="å›¾ç‰‡è§†é¢‘äº’è½¬">å›¾ç‰‡/è§†é¢‘äº’è½¬</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è§†é¢‘ -&gt; å›¾ç‰‡</span></span><br><span class="line">ffmpeg -i input.flv -r 1 -f image2 output-%3d.jpeg</span><br><span class="line"></span><br><span class="line"><span class="comment"># å›¾ç‰‡ -&gt; è§†é¢‘</span></span><br><span class="line">ffmpeg -i input-%3d.jpg out.mp4</span><br></pre></td></tr></table></figure><ul><li><code>-r</code>ï¼Œfpsï¼Œæ¯ç§’è½¬ä¸€å¼ å›¾ç‰‡ã€‚</li><li><code>-f</code>ï¼Œè½¬æ¢çš„æ ¼å¼ã€‚</li></ul><h2 id="ç›´æ’­æ¨æµæ‹‰æµ">ç›´æ’­æ¨æµ/æ‹‰æµ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç›´æ’­æ¨æµ</span></span><br><span class="line">ffmpeg -re -i input.mp4 -c copy -f flv rtmp://server/live/stream_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰æµ</span></span><br><span class="line">ffmpeg -i rtmp://server/live/stream_name -c copy dump.flv</span><br></pre></td></tr></table></figure><ul><li><code>-re</code>ï¼Œå‡æ…¢å¸§ç‡ä½¿å…¶ä¸æ’­æ”¾æ—¶çš„å¸§ç‡ä¿æŒåŒæ­¥ã€‚</li><li><code>-c copy</code>ï¼ŒéŸ³è§†é¢‘ä¸è½¬ç ã€‚</li><li><code>-f</code>ï¼ŒæŒ‡å®šæ¨æµçš„æ–‡ä»¶æ ¼å¼ã€‚</li></ul><p>æ¨æµçš„æ ¼å¼ä¸€å®šéœ€è¦ä¸æ‹‰å–çš„æ ¼å¼å¯¹åº”ä¸Šã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸‹è½½å·²ç¼–è¯‘çš„é™æ€åº“ï¼šhttps://evermeet.cx/ffmpeg/&lt;/p&gt;
&lt;h2 id=&quot;å‘½ä»¤åˆ†ç±»&quot;&gt;å‘½ä»¤åˆ†ç±»&lt;/h2&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegåŸºæœ¬æ¦‚å¿µ</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_basic/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_basic/</id>
    <published>2021-06-10T01:21:24.000Z</published>
    <updated>2021-10-25T16:02:45.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¨¡å—ç»“æ„">æ¨¡å—ç»“æ„</h2><ul><li>libavformatï¼šå®ç°åœ¨æµåè®®ï¼Œå®¹å™¨æ ¼å¼åŠå…¶æœ¬åœ°IOè®¿é—®ã€‚å¤šåª’ä½“æ ¼å¼è§£æã€è§£å°è£…ã€å°è£…ã€‚</li><li>libavutilï¼šç®€åŒ–ç¼–ç¨‹çš„å·¥å…·å‡½æ•°åº“ã€‚åŒ…æ‹¬éšæœºæ•°ç”Ÿæˆå™¨ï¼Œæ•°æ®ç»“æ„ï¼Œæ•°å­¦å‡½æ•°ï¼Œå¤šåª’ä½“æ ¸å¿ƒå·¥å…·å‡½æ•°ç­‰ç­‰ã€‚</li><li>libavcodecï¼šå„ç§ç¼–è§£ç å™¨çš„å°è£…ã€‚è‡ªèº«ä¸åšç¼–è§£ç ï¼Œç¼–è§£ç å™¨æ˜¯é€šè¿‡æ’ä»¶æ’å…¥çš„ã€‚</li><li>libavdeviceï¼šè¾“å…¥/è¾“å‡ºè®¾å¤‡æ¥å£å°è£…ã€‚</li><li>libavfilterï¼šéŸ³è§†é¢‘çš„åæœŸå¤„ç†ã€‚</li><li>libswresampleï¼šå®ç°æ··éŸ³å’Œé‡é‡‡æ ·ã€‚</li><li>libswscaleï¼šç”¨äºæ‰§è¡Œé«˜æ€§èƒ½çš„å›¾åƒç¼©æ”¾ï¼Œé¢œè‰²ç©ºé—´æˆ–åƒç´ æ ¼å¼è½¬æ¢çš„åº“ã€‚</li></ul><h2 id="ffmpegå¤„ç†éŸ³è§†é¢‘æµç¨‹">FFmpegå¤„ç†éŸ³è§†é¢‘æµç¨‹</h2><pre class="mermaid">flowchart LRè¾“å…¥æ–‡ä»¶--demuxer-->ç¼–ç æ•°æ®åŒ…0--decoder-->è§£ç åæ•°æ®å¸§--encoder-->ç¼–ç æ•°æ®åŒ…1--muxer-->è¾“å‡ºæ–‡ä»¶</pre><p>åˆ†è§£å™¨æŠŠè¾“å…¥çš„æ–‡ä»¶ï¼ˆä¸€èˆ¬ä¸ºå®¹å™¨åª’ä½“ï¼‰ï¼Œåˆ†è§£ä¸ºå¤šè·¯æµï¼Œè¿™äº›æµéƒ½æ˜¯ç¼–ç æ•°æ®åŒ…ã€‚æŠŠç¼–ç æ•°æ®åŒ…ä¼ ç»™è§£ç å™¨ï¼ˆå¦‚æœé€‰æ‹©æµæ‹·è´åˆ™è·³è¿‡ï¼‰ï¼Œè§£ç å™¨äº§ç”Ÿæœªå‹ç¼©çš„å¸§ï¼ˆåŸå§‹è§†é¢‘ã€PCMéŸ³é¢‘ç­‰ï¼‰ã€‚é€šè¿‡æ»¤é•œè¿›ä¸€æ­¥å¤„ç†ã€‚ç„¶åå¸§è¢«ä¼ é€’åˆ°ç¼–ç å™¨ï¼Œç¼–ç ç„¶åè¾“å‡ºç¼–ç æ•°æ®åŒ…ã€‚æœ€åï¼Œè¿™äº›æ•°æ®ä¼ ç»™å¤ç”¨å™¨ï¼ŒæŠŠç¼–ç çš„æ•°æ®å†™å…¥è¾“å‡ºæ–‡ä»¶ã€‚</p><p>å¤„ç†æµæ•°æ®çš„åŸºæœ¬æ­¥éª¤ï¼š</p><pre class="mermaid">flowchart LRè§£å¤ç”¨ --> è·å–æµ --> è¯»æ•°æ®åŒ… --> é‡Šæ”¾èµ„æº</pre>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ¨¡å—ç»“æ„&quot;&gt;æ¨¡å—ç»“æ„&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;libavformatï¼šå®ç°åœ¨æµåè®®ï¼Œå®¹å™¨æ ¼å¼åŠå…¶æœ¬åœ°IOè®¿é—®ã€‚å¤šåª’ä½“æ ¼å¼è§£æã€è§£å°è£…ã€å°è£…ã€‚&lt;/li&gt;
&lt;li&gt;libavutilï¼šç®€åŒ–ç¼–ç¨‹çš„å·¥å…·å‡½æ•°åº“ã€‚åŒ…æ‹¬éšæœºæ•°ç”Ÿæˆå™¨ï¼Œæ•°æ®ç»“æ„ï¼Œæ•°å­¦å‡½æ•°ï¼Œå¤šåª’ä½“æ ¸å¿ƒå·¥å…·å‡½æ•°ç­‰ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;libavcodecï¼šå„ç§ç¼–è§£ç å™¨çš„å°è£…ã€‚è‡ªèº«ä¸åšç¼–è§£ç ï¼Œç¼–è§£ç å™¨æ˜¯é€šè¿‡æ’ä»¶æ’å…¥çš„ã€‚&lt;/li&gt;
&lt;li&gt;libavdeviceï¼šè¾“å…¥/è¾“å‡ºè®¾å¤‡æ¥å£å°è£…ã€‚&lt;/li&gt;
&lt;li&gt;libavfilterï¼šéŸ³è§†é¢‘çš„åæœŸå¤„ç†ã€‚&lt;/li&gt;
&lt;li&gt;libswresampleï¼šå®ç°æ··éŸ³å’Œé‡é‡‡æ ·ã€‚&lt;/li&gt;
&lt;li&gt;libswscaleï¼šç”¨äºæ‰§è¡Œé«˜æ€§èƒ½çš„å›¾åƒç¼©æ”¾ï¼Œé¢œè‰²ç©ºé—´æˆ–åƒç´ æ ¼å¼è½¬æ¢çš„åº“ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegå®æˆ˜ H264</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_coding_h264/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_coding_h264/</id>
    <published>2021-06-02T02:46:17.000Z</published>
    <updated>2021-06-02T02:46:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>åŸºæœ¬æ­¥éª¤ï¼š</p><ol type="1"><li>æ‰“å¼€ç¼–ç å™¨ï¼Œè®¾ç½®ç¼–ç å™¨å‚æ•°ï¼›</li><li>è½¬æ¢å›¾åƒæ ¼å¼ï¼ŒNV12-&gt;YUV420Pï¼›</li><li>å‡†å¤‡ç¼–ç æ•°æ®AVFrameï¼›</li><li>è¿›è¡Œç¼–ç ï¼›</li></ol><p>é‡ç‚¹æ˜¯å‰ä¸‰æ­¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">alloc_data_for_encode</span><span class="params">(AVFrame **in_frame, AVPacket **out_pkt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å®šä¹‰ç¼–ç å™¨è¾“å…¥</span></span><br><span class="line">    AVFrame *frame = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// åˆ›å»º</span></span><br><span class="line">    frame = av_frame_alloc();</span><br><span class="line">    <span class="keyword">if</span> (!frame) &#123;</span><br><span class="line">        log_error(ret);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error, No Memory!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> __ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é…ç½®è¾“å…¥å‚æ•°</span></span><br><span class="line">    frame-&gt;width = kWidth;</span><br><span class="line">    frame-&gt;height = kHeight;</span><br><span class="line">    frame-&gt;format = in_fmt;</span><br><span class="line">    ret = av_frame_get_buffer(frame, <span class="number">32</span>); <span class="comment">// æŒ‰32ä½å¯¹é½</span></span><br><span class="line">    <span class="keyword">if</span> (!frame-&gt;buf[<span class="number">0</span>]) &#123;</span><br><span class="line">        log_error(ret);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;æ— æ³•è¯»å–è¾“å…¥æ•°æ®\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> __ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    *in_frame = frame;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºç¼–ç å™¨è¾“å‡º</span></span><br><span class="line">    AVPacket *newpkt = av_packet_alloc();</span><br><span class="line">    <span class="keyword">if</span> (!newpkt) &#123;</span><br><span class="line">        log_error(ret);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;æ— æ³•åˆ›å»ºè¾“å‡ºæ•°æ®\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> __ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    *out_pkt = newpkt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// !!!: ä¸€å®šè¦åœ¨æ ‡ç­¾å‰è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    __ERROR:</span><br><span class="line">    <span class="keyword">if</span> (frame) av_frame_free(&amp;frame);</span><br><span class="line">    <span class="keyword">if</span> (newpkt) av_packet_free(&amp;newpkt);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">encode_frame</span><span class="params">(AVFrame *frame, AVPacket *newpkt, FILE *output_file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (frame) <span class="built_in">printf</span>(<span class="string">&quot;send frame to encoder. pts=%lld\n&quot;</span>, frame-&gt;pts);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// è¾“å…¥frameåˆ°ç¼–ç å™¨</span></span><br><span class="line">    ret = avcodec_send_frame(c_ctx, frame);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (ret &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–ç¼–ç åçš„æ•°æ®ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™é‡å¤è·å–</span></span><br><span class="line">        ret = avcodec_receive_packet(c_ctx, newpkt);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;error in encoding audio frame\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> __ERROR;</span><br><span class="line">                <span class="comment">//exit(-1);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å†™å…¥æ–‡ä»¶</span></span><br><span class="line">        fwrite(newpkt-&gt;data, <span class="number">1</span>, (<span class="keyword">size_t</span>)newpkt-&gt;size, output_file);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">    </span><br><span class="line">    __ERROR:</span><br><span class="line">    <span class="comment">// é‡Šæ”¾ç¼–ç è¾“å…¥è¾“å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (frame) av_frame_free(&amp;frame);</span><br><span class="line">    <span class="keyword">if</span> (newpkt) av_packet_free(&amp;newpkt);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_video</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!fmt_ctx) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ä¸èƒ½ä½¿ç”¨è®¾å¤‡\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> __ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// å‡†å¤‡æ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–‡ä»¶ï¼Œæƒé™ï¼šwï¼ˆå†™å…¥ï¼‰bï¼ˆå†™å…¥äºŒè¿›åˆ¶ï¼‰+ï¼ˆè‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰</span></span><br><span class="line">    FILE *output_yuv = fopen(<span class="string">&quot;/Users/bq/Movies/test/video.yuv&quot;</span>, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!output_yuv) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;æ–‡ä»¶åˆ›å»ºå¤±è´¥\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    FILE *output_h264 = fopen(<span class="string">&quot;/Users/bq/Movies/test/video.h264&quot;</span>, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!output_h264) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;æ–‡ä»¶åˆ›å»ºå¤±è´¥\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨æ ˆç©ºé—´åˆ†é…AVPacket</span></span><br><span class="line">    AVPacket pkt;</span><br><span class="line">    av_init_packet(&amp;pkt);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// ç¼–ç è¾“å…¥ã€è¾“å‡ºæ•°æ®</span></span><br><span class="line">    AVFrame *frame = <span class="literal">NULL</span>;</span><br><span class="line">    AVPacket *newpkt = <span class="literal">NULL</span>;</span><br><span class="line">    alloc_data_for_encode(&amp;frame, &amp;newpkt);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> base_pts = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((ret == <span class="number">0</span> || ret == AVERROR(EAGAIN)) &amp;&amp; count &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        <span class="comment">// è¯»å–è§†é¢‘æ•°æ®</span></span><br><span class="line">        ret = av_read_frame(fmt_ctx, &amp;pkt);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (ret == AVERROR(EAGAIN)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] pkt size is %d\n&quot;</span>, count, pkt.size);</span><br><span class="line">        count++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * NV12 -&gt; YUV420</span></span><br><span class="line"><span class="comment">         * NV12:   YYYYYYYYUVUV</span></span><br><span class="line"><span class="comment">         * YUV420: YYYYYYYYUUVV</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‹·è´æ•°æ®åˆ°è¾“å…¥</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> y_length = kWidth * kHeight;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> u_v_length = y_length / <span class="number">4</span>;</span><br><span class="line">        <span class="comment">// æ‹·è´Yæ•°æ®</span></span><br><span class="line">        <span class="built_in">memcpy</span>(frame-&gt;data[<span class="number">0</span>], pkt.data, y_length);</span><br><span class="line">        <span class="comment">// å¤„ç†UVï¼ŒYæ•°æ®åé¢æ˜¯UVï¼Œå¯¹YUVæ•°æ®åˆ†å±‚</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> stride = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; u_v_length; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> base = y_length + i * stride;</span><br><span class="line">            frame-&gt;data[<span class="number">1</span>][i] = pkt.data[base];</span><br><span class="line">            frame-&gt;data[<span class="number">2</span>][i] = pkt.data[base + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¾“å‡ºYUV</span></span><br><span class="line">        fwrite(frame-&gt;data[<span class="number">0</span>], <span class="number">1</span>, y_length, output_yuv);</span><br><span class="line">        fwrite(frame-&gt;data[<span class="number">1</span>], <span class="number">1</span>, u_v_length, output_yuv);</span><br><span class="line">        fwrite(frame-&gt;data[<span class="number">2</span>], <span class="number">1</span>, u_v_length, output_yuv);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç¼–ç ï¼Œéœ€å°†ptsé‡ç½®ä¸ºé¡ºåºçš„å€¼</span></span><br><span class="line">        frame-&gt;pts = base_pts++;</span><br><span class="line">        ret = encode_frame(frame, newpkt, output_h264);</span><br><span class="line">        </span><br><span class="line">        av_packet_unref(&amp;pkt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†æ¬¡è°ƒç”¨ä¸€æ¬¡ç¼–ç ï¼Œé˜²æ­¢ä¸¢å¸§</span></span><br><span class="line">    encode_frame(<span class="literal">NULL</span>, newpkt, output_h264);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;å®Œæˆå†™å…¥\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿™é‡Œä¸å†™returnï¼Œä¼šä¸€ç›´æ‰§è¡Œä¸‹å»</span></span><br><span class="line">    __ERROR:</span><br><span class="line">    <span class="comment">// å…³é—­æ–‡ä»¶</span></span><br><span class="line">    fclose(output_yuv);</span><br><span class="line">    fclose(output_h264);</span><br><span class="line">    <span class="comment">// é‡Šæ”¾ç¼–ç è¾“å…¥è¾“å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (frame)av_frame_free(&amp;frame);</span><br><span class="line">    <span class="keyword">if</span> (newpkt) av_packet_free(&amp;newpkt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;åŸºæœ¬æ­¥éª¤ï¼š&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;æ‰“å¼€ç¼–ç å™¨ï¼Œè®¾ç½®ç¼–ç å™¨å‚æ•°ï¼›&lt;/li&gt;
&lt;li&gt;è½¬æ¢å›¾åƒæ ¼å¼ï¼ŒNV12-&amp;gt;YUV420Pï¼›&lt;/li&gt;
&lt;li&gt;å‡†å¤‡ç¼–ç æ•°æ®AVFrameï¼›&lt;/li&gt;
&lt;li&gt;è¿›è¡Œç¼–ç ï¼›&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegå®æˆ˜ YUV</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_coding_yuv/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_coding_yuv/</id>
    <published>2021-06-02T02:46:17.000Z</published>
    <updated>2021-06-02T02:46:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>å‘½ä»¤ç”ŸæˆYUVï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 \</span><br><span class="line">       -an \</span><br><span class="line">       -c:v rawvideo \</span><br><span class="line">       -pix_fmt yuv420p out.yuv</span><br><span class="line"></span><br><span class="line"><span class="comment"># æå–å„åˆ†é‡</span></span><br><span class="line">ffmpeg -i input.mp4 \</span><br><span class="line">       -filter_complex <span class="string">&#x27;extractplanes=y+u+v[y][u][v]&#x27;</span> \</span><br><span class="line">       -map <span class="string">&#x27;[y]&#x27;</span> y.yuv \</span><br><span class="line">       -map <span class="string">&#x27;[u]&#x27;</span> u.yuv \</span><br><span class="line">       -map <span class="string">&#x27;[v]&#x27;</span> v.yuv</span><br></pre></td></tr></table></figure><p>æ’­æ”¾YUVï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ffplay -pix_fmt yuv420p -s å®½xé«˜ out.yuv</span><br><span class="line"></span><br><span class="line"><span class="comment"># åªæ’­æ”¾Yåˆ†é‡</span></span><br><span class="line">ffplay -pix_fmt yuv420p -s å®½xé«˜ -vf extractplanes=<span class="string">&#x27;y&#x27;</span> out.yuv</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’­æ”¾å„åˆ†é‡æ–‡ä»¶ï¼Œyæ˜¯å…¨å°ºå¯¸ï¼Œuã€våˆ†é‡è¦ä½¿ç”¨ä¸€èˆ¬çš„åˆ†è¾¨ç‡</span></span><br><span class="line">ffplay -pix_fmt gray -s å®½xé«˜ out.yuv</span><br></pre></td></tr></table></figure><p>æ’­æ”¾é€Ÿåº¦ä¼šä¸ä¸€æ ·ã€‚</p><ul><li>c:vï¼Œè§†é¢‘ç¼–è§£ç å™¨</li><li>vfï¼Œç®€å•æ»¤é•œ/æ»¤æ³¢</li><li>filter_complexï¼Œå¤æ‚æ»¤æ³¢å™¨</li></ul><h2 id="ä»£ç å®ç°">ä»£ç å®ç°</h2><p>å¯ä»¥åœ¨éŸ³é¢‘é‡‡é›†çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ï¼š</p><ul><li>ä¿®æ”¹è®¾å¤‡åç§°</li><li>å¢åŠ å‚æ•°</li><li>ä¿®æ”¹æ–‡ä»¶ååŠæ–‡ä»¶æ•°æ®çš„å¤§å°</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰“å¼€è®¾å¤‡</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">open_device</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    av_log_set_level(AV_LOG_DEBUG);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°äºé›¶åˆ™å‡ºé”™</span></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// &lt;video device&gt;:&lt;audio device&gt;</span></span><br><span class="line">    <span class="comment">// 0ï¼Œæœ¬æœºæ‘„åƒå¤´ï¼›1ï¼Œæ¡Œé¢</span></span><br><span class="line">    <span class="keyword">char</span> *device_name = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®æ‘„åƒå¤´é€‰é¡¹</span></span><br><span class="line">    AVDictionary *options = <span class="literal">NULL</span>;</span><br><span class="line">    av_dict_set(&amp;options, <span class="string">&quot;video_size&quot;</span>, <span class="string">&quot;640x480&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    av_dict_set(&amp;options, <span class="string">&quot;framerate&quot;</span>, <span class="string">&quot;30&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    av_dict_set(&amp;options, <span class="string">&quot;pixel_format&quot;</span>, <span class="string">&quot;nv12&quot;</span>, <span class="number">0</span>); <span class="comment">// FFmpegä¼šé»˜è®¤æŒ‡å®šYUV420Pï¼Œä½†ä¼šä¸æ”¯æŒä¼šåˆ‡æ¢åˆ°æ‘„åƒå¤´æ”¯æŒçš„ç¬¬ä¸€ç§æ ¼å¼ï¼Œmacçš„æ‘„åƒå¤´åªæ”¯æŒuyvy422ã€yuyv422ã€nv12ã€0rgbã€bgr0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1 æ³¨å†Œè®¾å¤‡</span></span><br><span class="line">    avdevice_register_all();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2 è·å–æ ¼å¼</span></span><br><span class="line">    AVInputFormat *inputFormat = av_find_input_format(<span class="string">&quot;avfoundation&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3 æ‰“å¼€è®¾å¤‡ã€‚è¿™ä¼šåŒæ—¶åˆ›å»ºä¸Šä¸‹æ–‡ã€‚</span></span><br><span class="line">    ret = avformat_open_input(&amp;fmt_ctx, device_name, inputFormat, &amp;options);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span> || !fmt_ctx) &#123;</span><br><span class="line">        <span class="keyword">goto</span> __ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æˆåŠŸæ‰“å¼€è§†é¢‘è®¾å¤‡\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    __ERROR:</span><br><span class="line">    log_error(ret);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// é‡‡é›†è§†é¢‘å¹¶å†™å…¥æ–‡ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_video</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!fmt_ctx) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ä¸èƒ½ä½¿ç”¨è®¾å¤‡\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> __ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// å‡†å¤‡æ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–‡ä»¶ï¼Œæƒé™ï¼šwï¼ˆå†™å…¥ï¼‰bï¼ˆå†™å…¥äºŒè¿›åˆ¶ï¼‰+ï¼ˆè‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰</span></span><br><span class="line">    FILE *output_yuv = fopen(<span class="string">&quot;/Users/bq/Movies/test/video.yuv&quot;</span>, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!output_yuv) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;æ–‡ä»¶åˆ›å»ºå¤±è´¥\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨æ ˆç©ºé—´åˆ†é…AVPacket</span></span><br><span class="line">    AVPacket pkt;</span><br><span class="line">    av_init_packet(&amp;pkt);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> ((ret == <span class="number">0</span> || ret == AVERROR(EAGAIN)) &amp;&amp; count &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        <span class="comment">// è¯»å–è§†é¢‘æ•°æ®</span></span><br><span class="line">        ret = av_read_frame(fmt_ctx, &amp;pkt);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (ret == AVERROR(EAGAIN)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] pkt size is %d\n&quot;</span>, count, pkt.size);</span><br><span class="line">        count++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * NV12 -&gt; YUV420</span></span><br><span class="line"><span class="comment">         * NV12:   YYYYYYYYUVUV</span></span><br><span class="line"><span class="comment">         * YUV420: YYYYYYYYUUVV</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‹·è´æ•°æ®åˆ°è¾“å…¥</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> y_length = kWidth * kHeight;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> u_v_length = y_length / <span class="number">4</span>;</span><br><span class="line">        <span class="comment">// æ‹·è´Yæ•°æ®</span></span><br><span class="line">        <span class="built_in">memcpy</span>(frame-&gt;data[<span class="number">0</span>], pkt.data, y_length);</span><br><span class="line">        <span class="comment">// å¤„ç†UVï¼ŒYæ•°æ®åé¢æ˜¯UVï¼Œå¯¹YUVæ•°æ®åˆ†å±‚</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> stride = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; u_v_length; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> base = y_length + i * stride;</span><br><span class="line">            frame-&gt;data[<span class="number">1</span>][i] = pkt.data[base];</span><br><span class="line">            frame-&gt;data[<span class="number">2</span>][i] = pkt.data[base + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¾“å‡ºYUV</span></span><br><span class="line">        fwrite(frame-&gt;data[<span class="number">0</span>], <span class="number">1</span>, y_length, output_yuv);</span><br><span class="line">        fwrite(frame-&gt;data[<span class="number">1</span>], <span class="number">1</span>, u_v_length, output_yuv);</span><br><span class="line">        fwrite(frame-&gt;data[<span class="number">2</span>], <span class="number">1</span>, u_v_length, output_yuv);</span><br><span class="line">        </span><br><span class="line">        av_packet_unref(&amp;pkt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;å®Œæˆå†™å…¥\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿™é‡Œä¸å†™returnï¼Œä¼šä¸€ç›´æ‰§è¡Œä¸‹å»</span></span><br><span class="line">    __ERROR:</span><br><span class="line">    <span class="comment">// å…³é—­æ–‡ä»¶</span></span><br><span class="line">    fclose(output_yuv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‘½ä»¤ç”ŸæˆYUVï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ffmpeg -i input.mp4 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       -an \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       -c:v rawvideo \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       -pix_fmt yuv420p out.yuv&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æå–å„åˆ†é‡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ffmpeg -i input.mp4 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       -filter_complex &lt;span class=&quot;string&quot;&gt;&amp;#x27;extractplanes=y+u+v[y][u][v]&amp;#x27;&lt;/span&gt; \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       -map &lt;span class=&quot;string&quot;&gt;&amp;#x27;[y]&amp;#x27;&lt;/span&gt; y.yuv \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       -map &lt;span class=&quot;string&quot;&gt;&amp;#x27;[u]&amp;#x27;&lt;/span&gt; u.yuv \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       -map &lt;span class=&quot;string&quot;&gt;&amp;#x27;[v]&amp;#x27;&lt;/span&gt; v.yuv&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegå®æˆ˜ éŸ³é¢‘å½•åˆ¶ã€ç¼–ç ã€é‡é‡‡æ ·</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_coding_audio_recording_encoding_resampling/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_coding_audio_recording_encoding_resampling/</id>
    <published>2021-05-26T17:56:00.000Z</published>
    <updated>2021-05-26T17:56:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>å‘½ä»¤è¡Œæ–¹å¼é‡‡é›†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -f avfoundation -i :0 output/out.wav</span><br></pre></td></tr></table></figure><h2 id="å‡†å¤‡">å‡†å¤‡</h2><p>è¿™é‡Œåˆ›å»ºçš„æ˜¯Mac Appï¼Œä»¥åŠå¼•å…¥çš„æ˜¯åŠ¨æ€åº“ã€‚ç”±äºåŠ¨æ€åº“å­˜æ”¾åœ¨ä¸€ä¸ªå…±äº«ä½ç½®ï¼Œç¼–è¯‘æ—¶å°±å›ºå®šäº†å®ƒæ‰€åœ¨çš„ä½ç½®ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‹·è´åˆ°ç›®å½•ä¸­ã€‚</p><ol type="1"><li>å¼•å…¥å¹¶é“¾æ¥åŠ¨æ€åº“æ–‡ä»¶ï¼ˆGeneral/Frameworks, Libraries, and Embedded Contentï¼‰ï¼‰ã€‚</li><li>æ·»åŠ å¤´æ–‡ä»¶æœç´¢ç›®å½•ï¼ˆBuild Settings/User Header Search Pathsï¼‰ã€‚</li><li>åˆ›å»ºCè¯­è¨€å¤´æ–‡ä»¶ä»¥åŠå®ç°æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºBridging-Headerã€‚</li></ol><h2 id="é‡‡é›†éŸ³é¢‘">é‡‡é›†éŸ³é¢‘</h2><h3 id="æ‰“å¼€è®¾å¤‡">æ‰“å¼€è®¾å¤‡</h3><p>æ­¥éª¤ï¼š</p><ol type="1"><li>æ³¨å†Œè®¾å¤‡ã€‚</li><li>è®¾ç½®é‡‡é›†æ–¹å¼ï¼ˆavfouncdationâœ”ï¸/dshow/alsaï¼‰ã€‚</li><li>æ‰“å¼€éŸ³é¢‘è®¾å¤‡ã€‚</li></ol><p>æ‰“å¼€ä¹‹åå°±å¯ä»¥å½•åˆ¶éŸ³é¢‘æµã€‚</p><p>å¿…è¦å¤´æ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;libavutil/avutil.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;libavdevice/avdevice.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;libavformat/avformat.h&quot;</span></span></span><br></pre></td></tr></table></figure><p>è®°å¾—è¦å¼•å…¥çš„æ˜¯åŠ¨æ€åº“å•Šï¼Œé™æ€åº“ä¼šæœ‰ä¸€å †ç¬¦å·æ‰¾ä¸åˆ°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°äºé›¶åˆ™å‡ºé”™</span></span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">AVFormatContext *context = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">// &lt;video device&gt;:&lt;audio device&gt;</span></span><br><span class="line"><span class="keyword">char</span> *deviceName = <span class="string">&quot;:0&quot;</span>;</span><br><span class="line">AVDictionary *options = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">size_t</span> errorBufferLength = <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">char</span> errorBuffer[errorBufferLength];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1 æ³¨å†Œè®¾å¤‡</span></span><br><span class="line">avdevice_register_all();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 è·å–æ ¼å¼</span></span><br><span class="line">AVInputFormat *inputFormat = av_find_input_format(<span class="string">&quot;avfoundation&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3 æ‰“å¼€è®¾å¤‡ã€‚è¿™ä¼šåŒæ—¶åˆ›å»ºä¸Šä¸‹æ–‡ã€‚</span></span><br><span class="line">ret = avformat_open_input(&amp;context, deviceName, inputFormat, &amp;options);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// è¾“å‡ºåˆ°é”™è¯¯</span></span><br><span class="line">    av_strerror(ret, errorBuffer, errorBufferLength);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to open audio device, [%d]%s\n&quot;</span>, ret, errorBuffer);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¦å…ˆè·å–éº¦å…‹é£æƒé™ã€‚</p><p>ä¸Šä¸‹æ–‡åˆ›å»ºåï¼Œè®°å¾—è¦å¯¹åº”è¿›è¡Œé‡Šæ”¾ã€‚</p><h3 id="è¯»å–éŸ³é¢‘æ•°æ®">è¯»å–éŸ³é¢‘æ•°æ®</h3><p><code>av_read_frame</code>ï¼šè¯¥æ–¹æ³•æ—¢å¯ä»¥è¯»å–éŸ³é¢‘æ•°æ®ï¼Œä¹Ÿå¯ä»¥è¯»å–è§†é¢‘æ•°æ®ã€‚</p><p><code>AVFormatContext</code>ï¼šæ ¼å¼ä¸Šä¸‹æ–‡ï¼Œä¸Šé¢æ‰“å¼€è®¾å¤‡ä¹Ÿç”¨åˆ°ã€‚ä¸Šä¸‹æ–‡æ˜¯åç»­å¤„ç†çš„åŸºç¡€ï¼Œåœ¨æ‰“å¼€è®¾å¤‡çš„æ—¶å€™å°±å¯ä»¥è·å–ä¸Šä¸‹æ–‡ã€‚</p><p>AVPacketï¼ŒéŸ³è§†é¢‘æ•°æ®åŒ…ç»“æ„ä½“ã€‚</p><p>è¿”å›0åˆ™è¡¨ç¤ºæˆåŠŸã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨æ ˆç©ºé—´åˆ†é…AVPacket</span></span><br><span class="line">AVPacket pkt;</span><br><span class="line">av_init_packet(&amp;pkt);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ((ret == <span class="number">0</span> || ret == <span class="number">-35</span>) &amp;&amp; count &lt; <span class="number">5</span>) &#123;</span><br><span class="line">    ret = av_read_frame(context, &amp;pkt);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        av_strerror(ret, error_buffer, kErrorLength);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to reading, [%d]%s\n&quot;</span>, ret, error_buffer);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pkt size is %d\n&quot;</span>, pkt.size);</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">av_packet_unref(&amp;pkt);</span><br></pre></td></tr></table></figure><p>è¦æ³¨æ„ï¼Œé‡‡é›†æ—¶æœ‰æ—¶ä¼šå‡ºç°-35è¿”å›ï¼Œæ˜¯è®¾å¤‡ä¸´æ—¶ä¸å¯ç”¨ï¼Œéœ€è¦å¿½ç•¥ï¼Œå¹¶é‡è¯•ã€‚</p><p>è®°å¾—<code>av_read_frame</code>åè¦é‡Šæ”¾å¯¹åº”èµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚</p><h4 id="avpacket">AVPacket</h4><p>å¤´æ–‡ä»¶ï¼šlibavcodec/avcodec.h</p><p>é‡è¦æˆå‘˜</p><ul><li><code>data</code>ï¼šéŸ³è§†é¢‘å…·ä½“æ•°æ®ã€‚</li><li><code>size</code>ï¼šç¼“å†²åŒºæ•°æ®å¤§å°ã€‚</li></ul><p>ç›¸å…³APIï¼ˆæˆå¯¹ä½¿ç”¨ï¼‰ï¼š</p><p>å¦‚æœåªåœ¨æ ˆç©ºé—´ä½¿ç”¨AVPacketï¼Œåˆ™å¯ä»¥åªç”¨ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ã€‚</p><ul><li><code>av_init_packet</code>ï¼šAVPacketåˆå§‹åŒ–æ–¹æ³•ï¼Œä½†ä¸ä¼šå¡«å……<code>data</code>ã€<code>size</code>ã€‚</li><li><code>av_packet_unref</code>ï¼šé‡Šæ”¾AVPacketèµ„æºã€‚å†…éƒ¨ä¼šé‡Šæ”¾<code>buffer</code>çš„å†…å­˜å ç”¨ã€‚</li></ul><p>å †ç©ºé—´åˆ†é…ï¼š</p><ul><li><code>av_packet_alloc</code>ï¼šåˆ†é…ç©ºé—´å¹¶åˆå§‹åŒ–AVPacketï¼ŒåŒæ ·ä¸ä¼šå¡«å……dataã€sizeã€‚å³åŒ…å«äº†av_init_packetçš„è°ƒç”¨ã€‚</li><li><code>av_packet_free</code>ï¼šé‡Šæ”¾AVPacketå¯¹åº”çš„èµ„æºï¼ŒåŒæ ·ä¹ŸåŒ…å«äº†av_packet_unrefè°ƒç”¨ã€‚</li></ul><h3 id="å†™å…¥åˆ°æ–‡ä»¶">å†™å…¥åˆ°æ–‡ä»¶</h3><p>åŸºæœ¬æ­¥éª¤ï¼š</p><ol type="1"><li>åˆ›å»ºæ–‡ä»¶ï¼›</li><li>æŠŠéŸ³é¢‘å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼›</li><li>å…³é—­æ–‡ä»¶ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºæ–‡ä»¶ï¼Œæƒé™ï¼šwï¼ˆå†™å…¥ï¼‰bï¼ˆå†™å…¥äºŒè¿›åˆ¶ï¼‰+ï¼ˆè‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰</span></span><br><span class="line"><span class="keyword">char</span> *output_path = <span class="string">&quot;/Users/bq/Workspace/test/audio.pcm&quot;</span>;</span><br><span class="line">FILE *output_file = fopen(output_path, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((ret == <span class="number">0</span> || ret == <span class="number">-35</span>) &amp;&amp; count &lt; <span class="number">500</span>) &#123;</span><br><span class="line">    ret = av_read_frame(context, &amp;pkt);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[%d] pkt size is %d\n&quot;</span>, count, pkt.size);</span><br><span class="line">    count++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ–‡ä»¶</span></span><br><span class="line">    fwrite(pkt.data, pkt.size, <span class="number">1</span>, output_file);</span><br><span class="line">    fflush(output_file);</span><br><span class="line"></span><br><span class="line">    av_packet_unref(&amp;pkt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­æ–‡ä»¶</span></span><br><span class="line">fclose(output_file);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;å®Œæˆå†™å…¥&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ’­æ”¾æµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffplay -ar 44100 -ac 2 -f f32le audio.pcm</span><br></pre></td></tr></table></figure><h2 id="ç¼–ç éŸ³é¢‘">ç¼–ç éŸ³é¢‘</h2><p>FFmpegç¼–ç åŸºæœ¬è¿‡ç¨‹ï¼š</p><ol type="1"><li>åˆ›å»ºç¼–ç å™¨ï¼›</li><li>åˆ›å»ºä¸Šä¸‹æ–‡ï¼›</li><li>æ‰“å¼€ç¼–ç å™¨ï¼›</li><li>é€æ•°æ®ç»™ç¼–ç å™¨ï¼›ç¼–ç å™¨ä¸€èˆ¬æ˜¯è¦ç¼“å†²ä¸€éƒ¨åˆ†å¸§ï¼Œæ‰èƒ½ç¼–ç è¾“å‡ºå¸§ã€‚</li><li>ç¼–ç ï¼›</li><li>é‡Šæ”¾èµ„æºã€‚</li></ol><p>æ‰“å¼€ç¼–ç å™¨APIï¼š</p><ol type="1"><li><code>avcodec_find_encoder</code>ï¼šæŸ¥æ‰¾ç¼–ç å™¨ã€‚é€šè¿‡idæˆ–åå­—æŸ¥æ‰¾ã€‚</li><li><code>avcodec_alloc_context3</code>ï¼šåˆ›å»ºä¸Šä¸‹æ–‡ã€‚</li><li><code>avcodec_open2</code>ï¼šæ‰“å¼€ç¼–ç å™¨ã€‚</li></ol><p>fdk_aacï¼Œæ”¯æŒçš„é‡‡æ ·å¤§å°æ˜¯16ä½çš„ï¼Œä¸èƒ½è®¾ç½®ä¸ºFLTã€‚è®¾ç½®äº†profileåï¼Œéœ€è¦bit_rateç½®0ï¼Œå¦åˆ™profileè®¾ç½®ä¸ç”Ÿæ•ˆã€‚</p><p>ä¼ è¾“æ•°æ®APIï¼š</p><p><code>avcodec_send_frame</code>ï¼ŒæŠŠå¸§è¾“å…¥åˆ°ç¼–ç å™¨ã€‚é¡¾åæ€ä¹‰ï¼Œå…¶ä¼ å…¥çš„æ˜¯AVFrameã€‚ä¼šå…ˆç¼“å†²ä¸€éƒ¨åˆ†æ•°æ®ã€‚</p><p><code>avcodec_receive_packet</code>ï¼Œè·å–ç¼–ç åçš„æ•°æ®ã€‚é¡¾åæ€ä¹‰ï¼Œå…¶è¾“å‡ºçš„æ˜¯AVPacketã€‚</p><p>AVFrameä¸AVPacketï¼Œä»å‘½åä¸Šçœ‹ï¼Œä¼¼ä¹frameæ˜¯è§£å‹åçš„å¸§ã€packetæ˜¯å‹ç¼©åçš„æ•°æ®åŒ…ã€‚ä¹‹å‰æ‰“å¼€è®¾å¤‡å¹¶ä»ä¸­<code>av_read_frame</code>å‡ºæ¥çš„å´æ˜¯ä¸ªpacketï¼Œè¿™æ˜¯å› ä¸ºFFmpegæŠŠè®¾å¤‡è§†ä¸ºåª’ä½“æ–‡ä»¶å¤„ç†ã€‚è€Œä»åª’ä½“æ–‡ä»¶è¯»å–çš„å°±æ˜¯packetæ•°æ®ã€‚å³æŒ‰ç…§æ­£è§„æµç¨‹ï¼Œä»è®¾å¤‡è¯»å–å¸§è·å¾—packetåï¼Œè¿˜éœ€è¦èµ°è§£ç çš„æ­¥éª¤ï¼Œæœ€åå¾—å‡ºAVFrameã€‚æˆ‘ä»¬æ˜¯çŸ¥é“ä»è®¾å¤‡è¯»å–çš„å¸§å°±æ˜¯æœªå‹ç¼©çš„å¸§ï¼Œæ‰€ä»¥å°±ç›´æ¥ä»packeté‡Œé¢æ‹¿æ•°æ®äº†ã€‚è¿™å…¶å®ä¹Ÿæ˜¯ç§æŠ•æœºå–å·§çš„æ–¹å¼ã€‚</p><h2 id="é‡é‡‡æ ·éŸ³é¢‘">é‡é‡‡æ ·éŸ³é¢‘</h2><p>åŸºæœ¬æ­¥éª¤ï¼š</p><ol type="1"><li>åˆ›å»ºé‡é‡‡æ ·ä¸Šä¸‹æ–‡ï¼›</li><li>è®¾ç½®å‚æ•°ï¼›</li><li>åˆå§‹åŒ–é‡é‡‡æ ·ï¼›</li></ol><p>å¯¹åº”APIï¼š</p><ol type="1"><li><code>swr_alloc_set_opts</code>ï¼šåˆ›å»ºäº†é‡é‡‡æ ·çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶è¿›è¡Œäº†åˆå§‹åŒ–ã€‚</li><li><code>swr_init</code></li><li><code>swr_convert</code></li><li><code>swr_free</code></li></ol><p>éœ€è¦å¤´æ–‡ä»¶ï¼š</p><p>libswresample/swresample.h</p><p>channel layoutï¼šæŒ‡æ‰¬å£°å™¨çš„å¸ƒå±€ï¼Œç”¨å®ƒæ¥è¡¨ç¤ºå£°é“ä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºæ–‡ä»¶ï¼Œæƒé™ï¼šwï¼ˆå†™å…¥ï¼‰bï¼ˆå†™å…¥äºŒè¿›åˆ¶ï¼‰+ï¼ˆè‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰</span></span><br><span class="line"><span class="keyword">char</span> *output_path = <span class="string">&quot;/Users/bq/Workspace/test/audio.pcm&quot;</span>;</span><br><span class="line">FILE *output_file = fopen(output_path, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºé‡é‡‡æ ·ä¸Šä¸‹æ–‡</span></span><br><span class="line">SwrContext *swr_ctx = swr_alloc_set_opts(<span class="literal">NULL</span>, <span class="comment">// ctx</span></span><br><span class="line">    AV_CH_LAYOUT_MONO, AV_SAMPLE_FMT_S16, <span class="number">44100</span>, <span class="comment">// è¾“å‡ºæ ¼å¼</span></span><br><span class="line">    AV_CH_LAYOUT_STEREO, AV_SAMPLE_FMT_FLT, <span class="number">44100</span>, <span class="comment">// è¾“å…¥æ ¼å¼</span></span><br><span class="line">    <span class="number">0</span>, <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">if</span> (!swr_ctx || swr_init(swr_ctx) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é‡é‡‡æ ·ä¸Šä¸‹æ–‡åˆ›å»ºå¤±è´¥&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡é‡‡æ ·è¾“å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> ch_length = <span class="number">4096</span> / <span class="number">4</span> / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">uint8_t</span> **src_data = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> src_data_length = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// æ ¹æ®æ ¼å¼ç”Ÿæˆç¼“å†²åŒº</span></span><br><span class="line">av_samples_alloc_array_and_samples(&amp;src_data, &amp;src_data_length, <span class="number">2</span>, ch_length, AV_SAMPLE_FMT_FLT, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡é‡‡æ ·è¾“å‡ºæ•°æ®</span></span><br><span class="line"><span class="keyword">uint8_t</span> **dst_data = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> dst_data_length = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// æ ¹æ®æ ¼å¼ç”Ÿæˆç¼“å†²åŒº</span></span><br><span class="line">av_samples_alloc_array_and_samples(&amp;dst_data, &amp;dst_data_length, <span class="number">1</span>, ch_length, AV_SAMPLE_FMT_S16, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((ret == <span class="number">0</span> || ret == <span class="number">-35</span>) &amp;&amp; count &lt; <span class="number">500</span>) &#123;</span><br><span class="line">    <span class="comment">// è¯»å–éŸ³é¢‘æ•°æ®</span></span><br><span class="line">    ret = av_read_frame(context, &amp;pkt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-35</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[%d] pkt size is %d\n&quot;</span>, count, pkt.size);</span><br><span class="line">    count++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹·è´æ•°æ®åˆ°è¾“å…¥</span></span><br><span class="line">    <span class="built_in">memcpy</span>(src_data[<span class="number">0</span>], pkt.data, pkt.size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡é‡‡æ ·ï¼Œè½¬æ¢çš„æ•°æ®é‡æ˜¯æ¯ä¸ªé€šé“çš„é‡‡æ ·æ•°</span></span><br><span class="line">    swr_convert(swr_ctx,</span><br><span class="line">        dst_data, <span class="number">512</span>, <span class="comment">// è¾“å‡º</span></span><br><span class="line">        (<span class="keyword">const</span> <span class="keyword">uint8_t</span> **)src_data, <span class="number">512</span> <span class="comment">// è¾“å…¥</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ–‡ä»¶</span></span><br><span class="line">    <span class="comment">//fwrite(pkt.data, (size_t)pkt.size, 1, output_file);</span></span><br><span class="line">    fwrite(dst_data[<span class="number">0</span>], <span class="number">1</span>, dst_data_length, output_file);</span><br><span class="line">    fflush(output_file);</span><br><span class="line"></span><br><span class="line">    av_packet_unref(&amp;pkt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (src_data) &#123;</span><br><span class="line">    av_freep(&amp;src_data[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line">av_freep(&amp;src_data);</span><br><span class="line"><span class="keyword">if</span> (dst_data) &#123;</span><br><span class="line">    av_freep(&amp;dst_data[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line">av_freep(&amp;dst_data);</span><br><span class="line">swr_free(&amp;swr_ctx);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­æ–‡ä»¶</span></span><br><span class="line">fclose(output_file);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;å®Œæˆå†™å…¥&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ’­æ”¾æµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffplay -ar 44100 -ac 1 -f s16le audio.pcm</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‘½ä»¤è¡Œæ–¹å¼é‡‡é›†ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ffmpeg -f avfoundation -i :0 output/out.wav&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FFmpegç¼–è¯‘</title>
    <link href="https://bqlin.github.io/posts/ffmpeg_compilation/"/>
    <id>https://bqlin.github.io/posts/ffmpeg_compilation/</id>
    <published>2021-05-26T01:55:03.000Z</published>
    <updated>2021-05-26T01:55:03.000Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œè®¨è®ºçš„æ˜¯ä½¿ç”¨æºç æ–¹å¼ç¼–è¯‘æŒ‰ç…§ï¼Œè€Œä¸æ˜¯ä½¿ç”¨brewå®‰è£…ï¼ˆåæœŸä¸å¯è£å‰ªï¼‰ã€‚</p><h2 id="ç¼–è¯‘ä¾èµ–å‡†å¤‡">ç¼–è¯‘ä¾èµ–å‡†å¤‡</h2><ul><li>gas-preprocessorã€‚Perl è„šæœ¬ï¼Œå°† GNU çš„ä¸€ä¸ªå­é›†å®ç°ä¸º Apple æ²¡æœ‰çš„é¢„å¤„ç†</li><li>yams<ul><li><code>brew install yasm</code>å®‰è£…</li></ul></li><li>pkg-config</li></ul><h2 id="åŸºæœ¬ç¼–è¯‘å‘½ä»¤">åŸºæœ¬ç¼–è¯‘å‘½ä»¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆé…ç½®ï¼Œæ‰§è¡Œåç”Ÿæˆä¸€äº›é…ç½®æ–‡ä»¶ã€‚</span></span><br><span class="line">./configure --prefix=/opt/ffmpeg --enable-debug=3 --disable-static --enable-shared --enable-libfdk_aac --enable-nonfree --enable-libopus --enable-libvpx --enable-libx264 --enable-gpl --enable-libx265 </span><br><span class="line"><span class="comment"># è®¾å®šä½¿ç”¨CPUæ•°é‡</span></span><br><span class="line">make -j 4</span><br><span class="line"><span class="comment"># ç¼–è¯‘</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šç¼–è¯‘ç»“æœæ ¹ç›®å½•ï¼Œå› ä¸ºè¦è£…åˆ°/ç›®å½•ï¼Œæ‰€ä»¥æ‰éœ€è¦sudo</span></span><br><span class="line">--prefix=/opt/ffmpeg</span><br><span class="line"><span class="comment"># è°ƒè¯•æ—¶å¯ä»¥æ›´è¯¦ç»†åœ°è¾“å‡ºç¬¦å·ä¿¡æ¯</span></span><br><span class="line">--enable-debug=3</span><br><span class="line"><span class="comment"># å…³é—­é™æ€åº“è€Œä½¿ç”¨åŠ¨æ€åº“ï¼Œé»˜è®¤ç”Ÿæˆé™æ€åº“</span></span><br><span class="line">--disable-static --enable-shared</span><br></pre></td></tr></table></figure><p>prefixå‚æ•°ç›®å‰è®¾åœ¨ä¸€ä¸ªå…±äº«ç›®å½•ï¼Œç”Ÿæˆçš„åŠ¨æ€åº“æ˜¯å…±äº«ç”¨çš„ï¼Œå³ä¸æ˜¯éšappçš„ã€‚å¦ä¸€æ–¹é¢ï¼Œè¿™ä¸ªå‚æ•°ä¹Ÿæ˜¯ç›´æ¥è®¾ç½®äº†dyldçš„install nameï¼Œç›´æ¥æ‹·è´åŒ…ä¼šå¯¼è‡´è¿è¡Œæ—¶æ‰¾ä¸åˆ°åŒ…ã€‚</p><p>ä¼¼ä¹ç¼–è§£ç éƒ½æ²¡æœ‰å¯ç”¨ï¼Œæ‰€ä»¥éƒ½è¦ä¸€ä¸€å¯ç”¨ã€‚</p><p>è¦å¯ç”¨çš„ç¼–è§£ç å™¨ä¸åœ¨FFmpegä»£ç ä¸­ï¼Œå› æ­¤å¯ç”¨ç¼–ç å™¨æ—¶ï¼Œä¹Ÿä¸ä¼šä¸‹è½½ï¼Œéœ€è¦é¢å¤–ç”¨brewå®‰è£…ã€‚</p><p>ä½¿ç”¨è¿™ç§æ–¹å¼å®‰è£…æ„å‘³ç€appè¦æƒ³åˆ°å…¶ä»–æœºå™¨è¿è¡Œï¼Œä¹Ÿéœ€è¦é…ç½®ä¸€æ ·çš„ç¯å¢ƒã€‚</p><h3 id="ioså¹³å°ç¼–è¯‘">iOSå¹³å°ç¼–è¯‘</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">./ffmpeg-4.3.2/configure \</span><br><span class="line">--target-os=darwin \</span><br><span class="line">--arch=arm64 \</span><br><span class="line">--cc=<span class="string">&quot;xcrun -sdk iphoneos clang&quot;</span> \</span><br><span class="line">--as=<span class="string">&quot;gas-preprocessor.pl -arch aarch64 -- xcrun -sdk iphoneos clang&quot;</span> \</span><br><span class="line">--enable-cross-compile --disable-debug --disable-programs \</span><br><span class="line">--disable-doc --enable-pic \</span><br><span class="line">--extra-cflags=<span class="string">&quot;-arch arm64 -mios-version-min=8.0 -fembed-bitcode&quot;</span> \</span><br><span class="line">--extra-ldflags=<span class="string">&quot;-arch arm64 -mios-version-min=8.0 -fembed-bitcode&quot;</span> \</span><br><span class="line">--prefix=/Users/bq/Workspace/Git/FFmpeg/BuildScript/kewlbear/FFmpeg-iOS-build-script/thin/arm64</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘åçš„ç›®å½•">ç¼–è¯‘åçš„ç›®å½•</h2><ul><li>binï½œæ‰€æœ‰å‘½ä»¤å·¥å…·</li><li>includeï½œå¤´æ–‡ä»¶</li><li>libï½œç”Ÿæˆçš„åŠ¨æ€åº“ã€é™æ€åº“</li><li>shareï½œæ–‡æ¡£ã€ä¾‹å­</li></ul><h2 id="pkg-config">pkg-config</h2><p>æŸ¥æ‰¾ç³»ç»Ÿåº“è·¯å¾„ï¼špkg-config --libs libavformat</p><p>å¦‚æœæ²¡æ‰¾åˆ°ï¼Œé¦–å…ˆç¡®è®¤ç¼–è¯‘åçš„libç›®å½•ä¸‹æ˜¯å¦æœ‰pkgconfigç›®å½•ï¼Œç„¶åæ·»åŠ å…¨å±€å˜é‡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PKG_CONFIG_PATH=/opt/ffmpeg/lib/pkgconfig/:<span class="variable">$PKG_CONFIG_PATH</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¿™é‡Œè®¨è®ºçš„æ˜¯ä½¿ç”¨æºç æ–¹å¼ç¼–è¯‘æŒ‰ç…§ï¼Œè€Œä¸æ˜¯ä½¿ç”¨brewå®‰è£…ï¼ˆåæœŸä¸å¯è£å‰ªï¼‰ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ç¼–è¯‘ä¾èµ–å‡†å¤‡&quot;&gt;ç¼–è¯‘ä¾èµ–å‡†å¤‡&lt;/h2&gt;</summary>
    
    
    
    <category term="FFmpeg" scheme="https://bqlin.github.io/categories/FFmpeg/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>CMSampleBufferä¸“é¢˜</title>
    <link href="https://bqlin.github.io/posts/cmsamplebuffer/"/>
    <id>https://bqlin.github.io/posts/cmsamplebuffer/</id>
    <published>2021-03-29T10:08:47.000Z</published>
    <updated>2021-03-29T10:08:47.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="cmsamplebufferä¸“é¢˜">CMSampleBufferä¸“é¢˜</h1><h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><p>CMSampleBufferæ˜¯ä¸€ä¸ªåŒ…å«é›¶ä¸ªæˆ–å¤šä¸ªå‹ç¼©æˆ–æœªå‹ç¼©ï¼ˆcompressed or uncompressedï¼‰ï¼Œç‰¹å®šåª’ä½“ç±»å‹çš„æ ·æœ¬ï¼ˆéŸ³é¢‘ã€è§†é¢‘ã€å¤šè·¯å¤ç”¨ç­‰ï¼‰ã€‚</p><p>ä¸€ä¸ªCMSampleBufferå¯ä»¥åŒ…å«ä»¥ä¸‹ä¹‹ä¸€çš„æ ¸å¿ƒæ•°æ®ï¼š</p><ul><li>CMBlockBufferï¼ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªåª’ä½“æ ·æœ¬ã€‚</li><li>CVImageBufferï¼Œæ˜¯å¯¹CMSampleBufferæµæ ¼å¼æè¿°çš„å¼•ç”¨ï¼ŒåŒ…å«æ¯ä¸ªåª’ä½“æ ·æœ¬çš„å¤§å°ã€æ—¶åºä¿¡æ¯ï¼Œä»¥åŠç¼“å†²åŒºçº§åˆ«å’Œæ ·æœ¬åŸºæœ¬çš„é™„ä»¶ã€‚</li></ul><p>sample bufferå¯ä»¥åŒ…å«æ ·æœ¬çº§åˆ«å’Œç¼“å†²åŒºçº§åˆ«çš„é™„ä»¶ã€‚æ ·æœ¬çº§åˆ«é™„ä»¶ä¸ç¼“å†²åŒºçš„æ¯ä¸ªæ ·æœ¬ï¼ˆå¸§ï¼‰ç›¸å…³è”ï¼Œå¹¶åŒ…å«è¯¸å¦‚æ—¶é—´æˆ³å’Œè§†é¢‘å¸§ç›¸å…³ä¿¡æ¯ã€‚ç¼“å†²åŒºçº§åˆ«é™„ä»¶æä¾›æœ‰å…³ç¼“å†²åŒºæ•´ä½“çš„ä¿¡æ¯ï¼Œå¦‚æ’­æ”¾é€Ÿåº¦å’Œæ¶ˆè´¹ç¼“å†²åŒºæ—¶æ‰§è¡Œçš„æ“ä½œã€‚</p><h2 id="æ•°æ®æ¥æº">æ•°æ®æ¥æº</h2><ul><li>é€šè¿‡é‡‡é›†è®¾å¤‡ï¼ˆæ‘„åƒå¤´ã€éº¦å…‹é£ï¼‰é‡‡é›†çš„éŸ³é¢‘æˆ–è§†é¢‘æ•°æ®ã€‚</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AVCaptureVideoDataOutputSampleBufferDelegateã€AVCaptureAudioDataOutputSampleBufferDelegate</span></span><br><span class="line"><span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">captureOutput</span></span></span><br><span class="line"><span class="function">(<span class="keyword">_</span> <span class="params">output</span>: <span class="type">AVCaptureOutput</span>, </span></span><br><span class="line"><span class="function"> <span class="params">didOutput</span> <span class="params">sampleBuffer</span>: <span class="type">CMSampleBuffer</span>, </span></span><br><span class="line"><span class="function"> <span class="params">from</span> <span class="params">connection</span>: <span class="type">AVCaptureConnection</span>)</span></span><br></pre></td></tr></table></figure><ul><li>è¯»å–è§†é¢‘æ–‡ä»¶çš„è¾“å‡ºæµAVAssetReaderOutputã€‚</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">copyNextSampleBuffer</span>()</span> -&gt; <span class="type">CMSampleBuffer</span>?</span><br></pre></td></tr></table></figure><ul><li>ARKit ARSessionObserverè¾“å‡ºæ•è·çš„audio sample bufferã€‚</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">session</span></span></span><br><span class="line"><span class="function">(<span class="keyword">_</span> <span class="params">session</span>: <span class="type">ARSession</span>, </span></span><br><span class="line"><span class="function"> <span class="params">didOutputAudioSampleBuffer</span> <span class="params">audioSampleBuffer</span>: <span class="type">CMSampleBuffer</span>)</span></span><br></pre></td></tr></table></figure><ul><li>VTCompressionSessionç¡¬ç¼–ç ä½œä¸ºVTCompressionOutputCallbackè¾“å‡ºã€‚</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typealias</span> <span class="type">VTCompressionOutputCallback</span> <span class="operator">=</span> </span><br><span class="line">(<span class="type">UnsafeMutableRawPointer</span>?, </span><br><span class="line"> <span class="type">UnsafeMutableRawPointer</span>?, </span><br><span class="line"> <span class="type">OSStatus</span>, </span><br><span class="line"> <span class="type">VTEncodeInfoFlags</span>, </span><br><span class="line"> <span class="type">CMSampleBuffer</span>?) -&gt; <span class="type">Void</span></span><br></pre></td></tr></table></figure><p><em>æ³¨æ„ï¼š</em></p><p>Clients of CMSampleBuffer must explicitly manage the retain count by calling CFRetain and CFRelease, even in processes using garbage collection.</p><h2 id="æ•°æ®è¾“å‡º">æ•°æ®è¾“å‡º</h2><ul><li>AVAssetWriterä¿å­˜è§†é¢‘AVAssetWriterInputã€‚</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">append</span>(<span class="keyword">_</span> <span class="params">sampleBuffer</span>: <span class="type">CMSampleBuffer</span>)</span> -&gt; <span class="type">Bool</span></span><br></pre></td></tr></table></figure><ul><li>AVSampleBufferDisplayLayerå±•ç¤ºè§£ç åçš„sample bufferã€‚</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">enqueue</span>(<span class="keyword">_</span> <span class="params">sampleBuffer</span>: <span class="type">CMSampleBuffer</span>)</span></span><br></pre></td></tr></table></figure><h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2><p>æ— è®ºæ˜¯è¯»å–è¿˜æ˜¯é‡‡é›†ï¼Œoutputçš„<code>videoSetting</code>çš„<code>kCVPixelBufferPixelFormatTypeKey</code>å­—æ®µæ§åˆ¶sample bufferçš„mediaSubTypeè¾“å‡ºçš„è‰²å½©æ ¼å¼ï¼Œè½¬æ¢è‰²å½©æ ¼å¼æœ‰GPUå‚ä¸ï¼Œæ€§èƒ½è¾ƒé«˜ï¼Œå¯æŒ‰éœ€è®¾ç½®ã€‚</p><h2 id="åˆ›å»º">åˆ›å»º</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (void)appendVideoPixelBuffer:(CVPixelBufferRef)pixelBuffer withPresentationTime:(CMTime)presentationTime</span><br><span class="line">&#123;</span><br><span class="line">    CMSampleBufferRef sampleBuffer = NULL;</span><br><span class="line">    CMFormatDescriptionRef outputFormatDescription = NULL;</span><br><span class="line">    CMVideoFormatDescriptionCreateForImageBuffer( kCFAllocatorDefault, pixelBuffer, &amp;outputFormatDescription );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    CMSampleTimingInfo timingInfo = &#123;0,&#125;;</span><br><span class="line">    timingInfo.duration = kCMTimeInvalid;</span><br><span class="line">    timingInfo.decodeTimeStamp = kCMTimeInvalid;</span><br><span class="line">    timingInfo.presentationTimeStamp = presentationTime;</span><br><span class="line"></span><br><span class="line">    OSStatus err = CMSampleBufferCreateForImageBuffer( kCFAllocatorDefault, pixelBuffer, true, NULL, NULL, outputFormatDescription, &amp;timingInfo, &amp;sampleBuffer );</span><br><span class="line">    if ( sampleBuffer ) &#123;</span><br><span class="line">        // do some thing</span><br><span class="line">        CFRelease( sampleBuffer );</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        NSString *exceptionReason = [NSString stringWithFormat:@&quot;sample buffer create failed (%i)&quot;, (int)err];</span><br><span class="line">        @throw [NSException exceptionWithName:NSInvalidArgumentException reason:exceptionReason userInfo:nil];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// CMSampleBufferCreateReadyä¸CMSampleBufferCreateç›¸åŒï¼Œåªæ˜¯dataReadyå§‹ç»ˆä¸ºtrueï¼Œå› æ­¤ä¸éœ€è¦ä¼ é€’makeDataReadyCallbackæˆ–refconã€‚</span><br></pre></td></tr></table></figure><h2 id="ä¿¡æ¯å­˜å–">ä¿¡æ¯å­˜å–</h2><p>getï¼š</p><p>æŒ‰è§£ç é¡ºåºæ’åˆ—å¸§ã€‚</p><ul><li><code>dataBuffer: CMBlockBuffer?</code></li><li><code>imageBuffer: CVImageBuffer?</code></li><li><code>decodeTimeStamp: CMTime</code>ï¼šé¦–ä¸ªsampleçš„DTSã€‚</li><li><code>outputDecodeTimeStamp: CMTime</code>ï¼šoutputPTS + (DTS - PTS) / SpeedMultiplier</li><li><code>presentationTimeStamp: CMTime</code></li><li><code>outputPresentationTimeStamp: CMTime</code></li><li><code>duration: CMTime</code></li><li><code>outputDuration: CMTime</code>ï¼š(D - trimDAtStart - trimDAtEnd) / SpeedMultiplier</li><li><code>numSamples: Int</code></li><li><code>formatDescription: CMFormatDescription?</code></li><li><code>sampleTimingInfos() throws -&gt; [CMSampleTimingInfo]</code>ï¼šåŒ…å«DTSã€PTSå’ŒDuration</li><li><code>sampleAttachments: CMSampleBuffer.SampleAttachmentsArray</code></li></ul><p>setï¼š</p><ul><li><code>setDataBuffer</code>ï¼šè§†é¢‘ã€éŸ³é¢‘å‹ç¼©æ•°æ®</li><li><code>setOutputPresentationTimeStamp</code></li></ul><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://www.jianshu.com/p/49fa6ac26095">CMSampleBuffer åˆ†æ - ç®€ä¹¦</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;cmsamplebufferä¸“é¢˜&quot;&gt;CMSampleBufferä¸“é¢˜&lt;/h1&gt;
&lt;h2 id=&quot;æ¦‚è¿°&quot;&gt;æ¦‚è¿°&lt;/h2&gt;</summary>
    
    
    
    <category term="AVFoundation" scheme="https://bqlin.github.io/categories/AVFoundation/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>ç›´æ’­ä¼˜åŒ–</title>
    <link href="https://bqlin.github.io/posts/live_optimization/"/>
    <id>https://bqlin.github.io/posts/live_optimization/</id>
    <published>2021-03-15T12:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç§’å¼€ä¼˜åŒ–">1. ç§’å¼€ä¼˜åŒ–</h3><p>æ”¹å†™æ’­æ”¾å™¨é€»è¾‘è®©æ’­æ”¾å™¨æ‹¿åˆ°ç¬¬ä¸€ä¸ªå…³é”®å¸§åå°±ç»™äºˆæ˜¾ç¤ºã€‚GOPçš„ç¬¬ä¸€å¸§é€šå¸¸éƒ½æ˜¯å…³é”®å¸§ï¼Œç”±äºåŠ è½½çš„æ•°æ®è¾ƒå°‘ï¼Œå¯ä»¥è¾¾åˆ°â€œé¦–å¸§ç§’å¼€â€ã€‚å¦‚æœç›´æ’­æœåŠ¡å™¨æ”¯æŒGOPç¼“å­˜ï¼Œæ„å‘³ç€æ’­æ”¾å™¨åœ¨å’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥åå¯ç«‹å³æ‹¿åˆ°æ•°æ®ï¼Œä»è€Œçœå´è·¨åœ°åŸŸå’Œè·¨è¿è¥å•†çš„å›æºä¼ è¾“æ—¶é—´ã€‚</p><p>GOPä½“ç°äº†å…³é”®å¸§çš„å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªå…³é”®å¸§ä¹‹é—´çš„è·ç¦»ï¼Œå³ä¸€ä¸ªå¸§ç»„çš„æœ€å¤§å¸§æ•°ã€‚å‡è®¾ä¸€ä¸ªè§†é¢‘çš„æ’å®šå¸§ç‡æ˜¯24fpsï¼ˆå³1ç§’24å¸§å›¾åƒï¼‰ï¼Œå…³é”®å¸§å‘¨æœŸä¸º2sï¼Œé‚£ä¹ˆä¸€ä¸ªGOPå°±æ˜¯48å¼ å›¾åƒã€‚ä¸€èˆ¬è€Œè¨€ï¼Œæ¯ä¸€ç§’è§†é¢‘è‡³å°‘éœ€è¦ä½¿ç”¨ä¸€ä¸ªå…³é”®å¸§ã€‚</p><p>å¢åŠ å…³é”®å¸§ä¸ªæ•°å¯æ”¹å–„ç”»è´¨ï¼ˆGOPé€šå¸¸ä¸ºFPSçš„å€æ•°ï¼‰ï¼Œä½†æ˜¯åŒæ—¶å¢åŠ äº†å¸¦å®½å’Œç½‘ç»œè´Ÿè½½ã€‚è¿™æ„å‘³ç€ï¼Œå®¢æˆ·ç«¯æ’­æ”¾å™¨ä¸‹è½½ä¸€ä¸ªGOPï¼Œæ¯•ç«Ÿè¯¥GOPå­˜åœ¨ä¸€å®šçš„æ•°æ®ä½“ç§¯ï¼Œå¦‚æœæ’­æ”¾ç«¯ç½‘ç»œä¸ä½³ï¼Œæœ‰å¯èƒ½ä¸æ˜¯èƒ½å¤Ÿå¿«é€Ÿåœ¨ç§’çº§ä»¥å†…ä¸‹è½½å®Œè¯¥GOPï¼Œè¿›è€Œå½±å“è§‚æ„Ÿä½“éªŒã€‚</p><h3 id="é©¬èµ›å…‹å¡é¡¿">2. é©¬èµ›å…‹ã€å¡é¡¿</h3><p>å¦‚æœGOPåˆ†ç»„ä¸­çš„På¸§ä¸¢å¤±ä¼šé€ æˆè§£ç ç«¯çš„å›¾åƒå‘ç”Ÿé”™è¯¯,å…¶å®è¿™ä¸ªé”™è¯¯è¡¨ç°å‡ºæ¥çš„å°±æ˜¯é©¬èµ›å…‹ã€‚å› ä¸ºä¸­é—´è¿ç»­çš„è¿åŠ¨ä¿¡æ¯ä¸¢å¤±äº†ï¼ŒH.264åœ¨è§£ç çš„æ—¶å€™ä¼šæ ¹æ®å‰é¢çš„å‚è€ƒå¸§æ¥è¡¥é½ï¼Œä½†æ˜¯è¡¥é½çš„å¹¶ä¸æ˜¯çœŸæ­£çš„è¿åŠ¨å˜åŒ–åçš„æ•°æ®ï¼Œè¿™æ ·å°±ä¼šå‡ºç°é¢œè‰²è‰²å·®çš„é—®é¢˜ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„é©¬èµ›å…‹ç°è±¡ï¼Œå¦‚å›¾ï¼š</p><figure><img src="https://upload-images.jianshu.io/upload_images/2971276-e1ffc3bb3132aa73.png" alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><p>è¿™ç§ç°è±¡ä¸æ˜¯æˆ‘ä»¬æƒ³çœ‹åˆ°çš„ã€‚ä¸ºäº†é¿å…è¿™ç±»é—®é¢˜çš„å‘ç”Ÿï¼Œä¸€èˆ¬å¦‚æœå‘ç°På¸§æˆ–è€…Iå¸§ä¸¢å¤±ï¼Œå°±ä¸æ˜¾ç¤ºæœ¬GOPå†…çš„æ‰€æœ‰å¸§ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªIå¸§æ¥åé‡æ–°åˆ·æ–°å›¾åƒã€‚ä½†æ˜¯Iå¸§æ˜¯æŒ‰ç…§å¸§å‘¨æœŸæ¥çš„ï¼Œéœ€è¦ä¸€ä¸ªæ¯”è¾ƒé•¿çš„æ—¶é—´å‘¨æœŸï¼Œå¦‚æœåœ¨ä¸‹ä¸€ä¸ªIå¸§æ¥ä¹‹å‰ä¸æ˜¾ç¤ºåæ¥çš„å›¾åƒï¼Œé‚£ä¹ˆè§†é¢‘å°±é™æ­¢ä¸åŠ¨äº†ï¼Œè¿™å°±æ˜¯å‡ºç°äº†æ‰€è°“çš„å¡é¡¿ç°è±¡ã€‚å¦‚æœè¿ç»­ä¸¢å¤±çš„è§†é¢‘å¸§å¤ªå¤šé€ æˆè§£ç å™¨æ— å¸§å¯è§£ï¼Œä¹Ÿä¼šé€ æˆä¸¥é‡çš„å¡é¡¿ç°è±¡ã€‚è§†é¢‘è§£ç ç«¯çš„å¡é¡¿ç°è±¡å’Œé©¬èµ›å…‹ç°è±¡éƒ½æ˜¯å› ä¸ºä¸¢å¸§å¼•èµ·çš„ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯è®©å¸§å°½é‡ä¸ä¸¢ã€‚</p><h3 id="ä¼ è¾“åè®®ä¼˜åŒ–">3. ä¼ è¾“åè®®ä¼˜åŒ–</h3><ul><li>åœ¨æœåŠ¡ç«¯èŠ‚ç‚¹å’ŒèŠ‚ç‚¹ä¹‹é—´å°½é‡ä½¿ç”¨ RTMP è€ŒéåŸºäº HTTP çš„ HLS åè®®è¿›è¡Œä¼ è¾“ï¼Œè¿™æ ·å¯ä»¥é™ä½æ•´ä½“çš„ä¼ è¾“å»¶è¿Ÿã€‚è¿™ä¸ªä¸»è¦é’ˆå¯¹ç»ˆç«¯ç”¨æˆ·ä½¿ç”¨ HLS è¿›è¡Œæ’­æ”¾çš„æƒ…å†µã€‚</li><li>å¦‚æœç»ˆç«¯ç”¨æˆ·ä½¿ç”¨ RTMP æ¥æ’­æ”¾ï¼Œå°½é‡åœ¨é è¿‘æ¨æµç«¯çš„æ”¶æµèŠ‚ç‚¹è¿›è¡Œè½¬ç ï¼Œè¿™æ ·ä¼ è¾“çš„è§†é¢‘æµæ¯”åŸå§‹è§†é¢‘æµæ›´å°ã€‚</li><li>å¦‚æœæœ‰å¿…è¦ï¼Œå¯ä»¥ä½¿ç”¨å®šåˆ¶çš„ UDP åè®®æ¥æ›¿æ¢ TCP åè®®ï¼Œçœå»å¼±ç½‘ç¯èŠ‚ä¸‹çš„ä¸¢åŒ…é‡ä¼ å¯ä»¥é™ä½å»¶è¿Ÿã€‚å®ƒçš„ä¸»è¦ç¼ºç‚¹åœ¨äºï¼ŒåŸºäº UDP åè®®è¿›è¡Œå®šåˆ¶çš„åè®®çš„è§†é¢‘æµçš„ä¼ è¾“å’Œåˆ†å‘ä¸å¤Ÿé€šç”¨ï¼ŒCDN å‚å•†æ”¯æŒçš„æ˜¯æ ‡å‡†çš„ä¼ è¾“åè®®ã€‚å¦ä¸€ä¸ªç¼ºç‚¹åœ¨äºå¯èƒ½å‡ºç°ä¸¢åŒ…å¯¼è‡´çš„èŠ±å±æˆ–è€…æ¨¡ç³Šï¼ˆç¼ºå°‘å…³é”®å¸§çš„è§£ç å‚è€ƒï¼‰ï¼Œè¿™å°±è¦æ±‚åè®®å®šåˆ¶æ–¹åœ¨ UDP åŸºç¡€ä¹‹ä¸Šåšå¥½ä¸¢åŒ…æ§åˆ¶ã€‚</li></ul><h3 id="ä¼ è¾“ç½‘ç»œä¼˜åŒ–">4. ä¼ è¾“ç½‘ç»œä¼˜åŒ–</h3><ul><li>åœ¨æœåŠ¡ç«¯èŠ‚ç‚¹ä¸­ç¼“å­˜å½“å‰ GOPï¼Œé…åˆæ’­æ”¾å™¨ç«¯ä¼˜åŒ–è§†é¢‘é¦–å¼€æ—¶é—´ã€‚</li><li>æœåŠ¡ç«¯å®æ—¶è®°å½•æ¯ä¸ªè§†é¢‘æµæµå‘æ¯ä¸ªç¯èŠ‚æ—¶çš„ç§’çº§å¸§ç‡å’Œç ç‡ï¼Œå®æ—¶ç›‘æ§ç ç‡å’Œå¸§ç‡çš„æ³¢åŠ¨ã€‚</li><li>å®¢æˆ·ç«¯ï¼ˆæ¨æµå’Œæ’­æ”¾ï¼‰é€šè¿‡æŸ¥è¯¢æœåŠ¡ç«¯å‡†å®æ—¶è·å–å½“å‰æœ€ä¼˜èŠ‚ç‚¹ï¼ˆ5 ç§’ä¸€æ¬¡ï¼‰ï¼Œå‡†å®æ—¶ä¸‹çº¿å½“å‰æ•…éšœèŠ‚ç‚¹å’Œçº¿è·¯ã€‚</li></ul><h3 id="æ¨æµæ’­æ”¾ä¼˜åŒ–">5. æ¨æµã€æ’­æ”¾ä¼˜åŒ–</h3><ul><li>è€ƒå¯Ÿå‘é€ç«¯ç³»ç»Ÿè‡ªå¸¦çš„ç½‘ç»œ buffer å¤§å°ï¼Œç³»ç»Ÿå¯èƒ½åœ¨å‘é€æ•°æ®ä¹‹å‰ç¼“å­˜æ•°æ®ï¼Œè¿™ä¸ªå‚æ•°çš„è°ƒä¼˜ä¹Ÿéœ€è¦æ‰¾åˆ°ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚</li><li>æ’­æ”¾ç«¯ç¼“å­˜æ§åˆ¶å¯¹äºè§†é¢‘çš„é¦–å¼€å»¶è¿Ÿä¹Ÿæœ‰è¾ƒå¤§å½±å“ï¼Œå¦‚æœä»…ä¼˜åŒ–é¦–å¼€å»¶è¿Ÿï¼Œå¯ä»¥åœ¨ 0 ç¼“å­˜æƒ…å†µä¸‹åœ¨æ•°æ®åˆ°è¾¾çš„æ—¶å€™ç«‹å³è§£ç ã€‚ä½†å¦‚æœåœ¨å¼±ç½‘ç¯å¢ƒä¸‹ä¸ºäº†æ¶ˆé™¤ç½‘ç»œæŠ–åŠ¨é€ æˆçš„å½±å“ï¼Œè®¾ç½®ä¸€å®šçš„ç¼“å­˜ä¹Ÿæœ‰å¿…è¦ï¼Œå› æ­¤éœ€è¦åœ¨ç›´æ’­çš„ç¨³å®šæ€§å’Œé¦–å¼€å»¶è¿Ÿä¼˜åŒ–ä¸Šæ‰¾åˆ°å¹³è¡¡ï¼Œè°ƒæ•´ä¼˜åŒ–ç¼“å†²åŒºå¤§å°è¿™ä¸ªå€¼ã€‚</li><li>æ’­æ”¾ç«¯åŠ¨æ€ buffer ç­–ç•¥ï¼Œè¿™æ˜¯ä¸Šé¢æ’­æ”¾ç«¯ç¼“å­˜æ§åˆ¶çš„æ”¹è¿›ç‰ˆæœ¬ã€‚å¦‚æœåªæ˜¯åš 0 ç¼“å­˜å’Œå›ºå®šå¤§å°çš„ç¼“å­˜ä¹‹é—´è¿›è¡Œé€‰æ‹©æ‰¾åˆ°å¹³è¡¡ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šé€‰æ‹©ä¸€ä¸ªå›ºå®šå¤§å°çš„ç¼“å­˜ï¼Œè¿™å¯¹äº¿çº§çš„ç§»åŠ¨äº’è”ç½‘ç»ˆç«¯ç”¨æˆ·æ¥è¯´å¹¶ä¸å…¬å¹³ï¼Œä»–ä»¬ä¸åŒçš„ç½‘ç»œçŠ¶å†µå†³å®šäº†è¿™ä¸ªå›ºå®šå¤§å°çš„ç¼“å­˜å¹¶ä¸å®Œå…¨åˆé€‚ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸€ç§ã€ŒåŠ¨æ€ buffer ç­–ç•¥ã€ï¼Œåœ¨æ’­æ”¾å™¨å¼€å¯çš„æ—¶å€™é‡‡ç”¨éå¸¸å°ç”šè‡³ 0 ç¼“å­˜çš„ç­–ç•¥ï¼Œé€šè¿‡å¯¹ä¸‹è½½é¦–ç‰‡è§†é¢‘çš„è€—æ—¶æ¥å†³å®šä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡çš„ç¼“å­˜å¤§å°ï¼ŒåŒæ—¶åœ¨æ’­æ”¾è¿‡ç¨‹ä¸­å®æ—¶ç›‘æµ‹å½“å‰ç½‘ç»œï¼Œå®æ—¶è°ƒæ•´æ’­æ”¾è¿‡ç¨‹ä¸­ç¼“å­˜çš„å¤§å°ã€‚è¿™æ ·å³å¯åšåˆ°æä½çš„é¦–å¼€æ—¶é—´ï¼Œåˆå¯èƒ½å¤Ÿå°½é‡æ¶ˆé™¤ç½‘ç»œæŠ–åŠ¨é€ æˆçš„å½±å“ã€‚</li><li>åŠ¨æ€ç ç‡æ’­æ”¾ç­–ç•¥ã€‚é™¤äº†åŠ¨æ€è°ƒæ•´ buffer å¤§å°çš„ç­–ç•¥ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨å®æ—¶ç›‘æµ‹çš„ç½‘ç»œä¿¡æ¯æ¥åŠ¨æ€è°ƒæ•´æ’­æ”¾è¿‡ç¨‹ä¸­çš„ç ç‡ï¼Œåœ¨ç½‘ç»œå¸¦å®½ä¸è¶³çš„æƒ…å†µä¸‹é™ä½ç ç‡è¿›è¡Œæ’­æ”¾ï¼Œå‡å°‘å»¶è¿Ÿã€‚</li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;ç§’å¼€ä¼˜åŒ–&quot;&gt;1. ç§’å¼€ä¼˜åŒ–&lt;/h3&gt;
&lt;p&gt;æ”¹å†™æ’­æ”¾å™¨é€»è¾‘è®©æ’­æ”¾å™¨æ‹¿åˆ°ç¬¬ä¸€ä¸ªå…³é”®å¸§åå°±ç»™äºˆæ˜¾ç¤ºã€‚GOPçš„ç¬¬ä¸€å¸§é€šå¸¸éƒ½æ˜¯å…³é”®å¸§ï¼Œç”±äºåŠ è½½çš„æ•°æ®è¾ƒå°‘ï¼Œå¯ä»¥è¾¾åˆ°â€œé¦–å¸§ç§’å¼€â€ã€‚å¦‚æœç›´æ’­æœåŠ¡å™¨æ”¯æŒGOPç¼“å­˜ï¼Œæ„å‘³ç€æ’­æ”¾å™¨åœ¨å’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥åå¯ç«‹å³æ‹¿åˆ°æ•°æ®ï¼Œä»è€Œçœå´è·¨åœ°åŸŸå’Œè·¨è¿è¥å•†çš„å›æºä¼ è¾“æ—¶é—´ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>å‹ç¼©ç‡å’Œå‹ç¼©æ¯”</title>
    <link href="https://bqlin.github.io/posts/compression_rate_and_compression_ratio/"/>
    <id>https://bqlin.github.io/posts/compression_rate_and_compression_ratio/</id>
    <published>2021-03-15T11:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨çœ‹èµ„æ–™çš„æ—¶å€™ï¼Œç»å¸¸çœ‹åˆ°å‹ç¼©ç‡å’Œå‹ç¼©æ¯”è¿™ä¸¤ä¸ªæœ¯è¯­ï¼Œä»”ç»†ä¸€çœ‹ï¼Œå‘ç°ä¸¤è€…ç«Ÿç„¶æ˜¯å®Œå…¨ç›¸åçš„æ¦‚å¿µï¼Œè™½ç„¶å¸¸å¸¸çœ‹åˆ°èµ„æ–™ä¸­å¹¶æ²¡æœ‰æ˜ç¡®åŒºåˆ†ã€‚</p><p>æ•°æ®å‹ç¼©æ¯”ï¼Œdata compression ratioã€‚ä¾‹å¦‚ï¼šé¢„æµ‹å¸§æ¯”å…³é”®å¸§å…·æœ‰æ›´é«˜çš„å‹ç¼©æ¯”ã€‚ <span class="math display">\[{\rm {Compression\;Ratio}}={\frac {\rm {Uncompressed\;Size}}{\rm {Compressed\;Size}}}\]</span> æ³¨æ„ï¼Œç»´åŸºç™¾ç§‘ä¸­åªæåˆ°äº†æ•°æ®å‹ç¼©æ¯”ã€‚</p><p>è€Œå‹ç¼©ç‡æ˜¯åœ¨ç™¾åº¦ç™¾ç§‘ä¸­æ‰¾åˆ°çš„ï¼ˆè™½ç„¶ä»ç¿»è¯‘è§’åº¦ä¸¤è€…æ„æ€ä¼¼ä¹ä¸€è‡´ï¼Ÿï¼‰ã€‚</p><p>å‹ç¼©ç‡ï¼ˆCompression rateï¼‰ï¼Œæè¿°å‹ç¼©æ–‡ä»¶çš„æ•ˆæœåï¼Œæ˜¯æ–‡ä»¶å‹ç¼©åçš„å¤§å°ä¸å‹ç¼©å‰çš„å¤§å°ä¹‹æ¯”ã€‚å³ï¼š</p><p><span class="math display">\[{\rm {å‹ç¼©ç‡}}={\frac {\rm {å‹ç¼©åå¤§å°}}{\rm {åŸå§‹å¤§å°}}}\]</span></p><p>åˆšå¥½ç›¸åï¼Ÿï¼è¿™ï¼Œæ€ä¹ˆä½¿ç”¨è¿˜å¾—è§ä»è§æ™ºå§ã€‚ã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://en.wikipedia.org/wiki/Data_compression_ratio">Data compression ratio - Wikipedia</a></li><li><a href="https://baike.baidu.com/item/%E5%8E%8B%E7%BC%A9%E7%8E%87/6435712">å‹ç¼©ç‡_ç™¾åº¦ç™¾ç§‘</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨çœ‹èµ„æ–™çš„æ—¶å€™ï¼Œç»å¸¸çœ‹åˆ°å‹ç¼©ç‡å’Œå‹ç¼©æ¯”è¿™ä¸¤ä¸ªæœ¯è¯­ï¼Œä»”ç»†ä¸€çœ‹ï¼Œå‘ç°ä¸¤è€…ç«Ÿç„¶æ˜¯å®Œå…¨ç›¸åçš„æ¦‚å¿µï¼Œè™½ç„¶å¸¸å¸¸çœ‹åˆ°èµ„æ–™ä¸­å¹¶æ²¡æœ‰æ˜ç¡®åŒºåˆ†ã€‚&lt;/p&gt;
&lt;p&gt;æ•°æ®å‹ç¼©æ¯”ï¼Œdata compression ratioã€‚ä¾‹å¦‚ï¼šé¢„æµ‹å¸§æ¯”å…³é”®å¸§å…·æœ‰æ›´é«˜çš„å‹ç¼©æ¯”ã€‚ &lt;span class=&quot;math display&quot;&gt;\[
{\rm {Compression\;Ratio}}={\frac {\rm {Uncompressed\;Size}}{\rm {Compressed\;Size}}}
\]&lt;/span&gt; æ³¨æ„ï¼Œç»´åŸºç™¾ç§‘ä¸­åªæåˆ°äº†æ•°æ®å‹ç¼©æ¯”ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>CDNç½‘ç»œ</title>
    <link href="https://bqlin.github.io/posts/cnd/"/>
    <id>https://bqlin.github.io/posts/cnd/</id>
    <published>2021-03-15T10:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>CDNï¼ˆContent Delivery Networkï¼‰ï¼Œå†…å®¹åˆ†å‘ç½‘ç»œã€‚æœ€åˆçš„ç›®çš„æ˜¯è§£å†³é™æ€é¡µé¢çš„åŠ é€Ÿé—®é¢˜ã€‚é€šè¿‡å°±è¿‘æ¥å…¥çš„æ–¹å¼è§£å†³è®¿é—®ç½‘ç»œèµ„æºçš„é—®é¢˜ã€‚</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/REaPnH.png" /></p><p>ç”µä¿¡å’Œè”é€šäº’ç›¸é€šä¿¡çš„æ—¶å€™ä¼šå‘ç”Ÿä¸»åŠ¨çš„ä¸¢åŒ…ã€‚</p><ul><li>æºèŠ‚ç‚¹ã€‚æºèŠ‚ç‚¹ç›´æ¥ä¹Ÿæœ‰è¿æ¥ï¼Œäº’é€šèµ„æºã€‚</li><li>ä¸»å¹²èŠ‚ç‚¹ã€‚è¿æ¥ä¸åŒè¿è¥å•†çš„èŠ‚ç‚¹ã€‚</li><li>è¾¹ç¼˜èŠ‚ç‚¹ã€‚ç¦»ç”¨æˆ·æœ€è¿‘çš„èŠ‚ç‚¹ã€‚è¾¹ç¼˜èŠ‚ç‚¹æ²¡æœ‰èµ„æºçš„æ—¶å€™ï¼Œä¼šå‘æºèŠ‚ç‚¹è·å–ã€‚</li></ul><p>ç”¨æˆ·é€šè¿‡åŸŸåè§£æï¼Œè¿æ¥åˆ°åˆé€‚çš„è¾¹ç¼˜èŠ‚ç‚¹ã€‚æ‰€ä»¥ç”¨æˆ·æ˜¯é€šè¿‡è¾¹ç¼˜èŠ‚ç‚¹é€æ­¥å‘æœåŠ¡å™¨ä¼ é€’æ•°æ®ã€‚è€ŒæœåŠ¡å™¨æŠŠæ•°æ®æ¨é€åˆ°æºèŠ‚ç‚¹ï¼Œç„¶åé€šè¿‡CDNé€æ­¥æ‰©æ•£åˆ°å„ä¸ªè¾¹ç¼˜èŠ‚ç‚¹ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;CDNï¼ˆContent Delivery Networkï¼‰ï¼Œå†…å®¹åˆ†å‘ç½‘ç»œã€‚æœ€åˆçš„ç›®çš„æ˜¯è§£å†³é™æ€é¡µé¢çš„åŠ é€Ÿé—®é¢˜ã€‚é€šè¿‡å°±è¿‘æ¥å…¥çš„æ–¹å¼è§£å†³è®¿é—®ç½‘ç»œèµ„æºçš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/bqlin/image-land/raw/master/REaPnH.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>CVPixelBufferä¸“é¢˜</title>
    <link href="https://bqlin.github.io/posts/cvpixelbuffer/"/>
    <id>https://bqlin.github.io/posts/cvpixelbuffer/</id>
    <published>2021-03-15T10:08:47.000Z</published>
    <updated>2021-03-15T10:08:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>CVPixelBuffer ç±»ä¼¼ Android çš„ bitmapï¼Œæ ¸å¿ƒæ˜¯å°è£…äº†å·²ç»è§£å‹åçš„å›¾åƒæ•°æ®ã€‚ä¿å­˜äº†åƒç´ çš„ formatï¼Œå›¾åƒå®½é«˜å’Œ buffer æŒ‡é’ˆç­‰ä¿¡æ¯ã€‚</p><h2 id="cvpixelbuffer-åˆ›å»ºä¸è½¬æ¢">CVPixelBuffer åˆ›å»ºä¸è½¬æ¢</h2><h3 id="è¯»å–åŸå§‹çš„åƒç´ æ•°ç»„">è¯»å–åŸå§‹çš„åƒç´ æ•°ç»„</h3><p>é€šè¿‡ CVPixelBufferGetBaseAddress å¯ä»¥è·å¾—åƒç´ æ•°ç»„çš„æŒ‡é’ˆï¼Œè¯¥æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åº”è¯¥è¢«è§£é‡Šä¸º unsigned charã€‚å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CVPixelBufferRef pixelBuffer;</span><br><span class="line">// å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ª pixelBuffer</span><br><span class="line">// é€šè¿‡å¦‚ä¸‹ API æ‹¿åˆ°è¯¥å›¾åƒçš„å®½ã€é«˜ã€æ¯è¡Œçš„å­—èŠ‚æ•°ã€æ¯ä¸ªåƒç´ çš„å­—èŠ‚æ•°</span><br><span class="line">size_t w = CVPixelBufferGetWidth(pixelBuffer);</span><br><span class="line">size_t h = CVPixelBufferGetHeight(pixelBuffer);</span><br><span class="line">size_t r = CVPixelBufferGetBytesPerRow(pixelBuffer);</span><br><span class="line">size_t bytesPerPixel = r/w;</span><br><span class="line">OSType bufferPixelFormat = CVPixelBufferGetPixelFormatType(pixelBuffer);</span><br><span class="line">NSLog(@&quot;GEMFIELD whrb: %zu - %zu - %zu - %zu - %u&quot;,w,h,r,bytesPerPixel,bufferPixelFormat);</span><br><span class="line">// é€šè¿‡å¦‚ä¸‹ API æ‹¿åˆ° CVPixelBufferRef çš„å›¾åƒæ ¼å¼ï¼š</span><br><span class="line">// æ¯”å¦‚ï¼škCVPixelFormatType_24RGBã€kCVPixelFormatType_32BGRA</span><br><span class="line">OSType bufferPixelFormat = CVPixelBufferGetPixelFormatType(pixelBuffer);</span><br><span class="line">// å‡†å¤‡å¼€å§‹è¯»å–è£¸çš„åƒç´ æ•°ç»„äº†</span><br><span class="line">CVPixelBufferLockBaseAddress( pixelBuffer, 0 );</span><br><span class="line">// gemfield_buffer å°±æ˜¯è£¸çš„æ•°ç»„</span><br><span class="line">const unsigned char* gemfield_buffer = (const unsigned char*)CVPixelBufferGetBaseAddress(pixelBuffer);</span><br><span class="line">// è¿™é‡Œä½ å¯ä»¥å¯¹è¯¥æ•°ç»„è¿›è¡Œè¯»å–å’Œå¤„ç†</span><br><span class="line">......</span><br><span class="line">// ç»“æŸ</span><br><span class="line">CVPixelBufferUnlockBaseAddress( pixelBuffer, 0 );</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨åŸå§‹çš„åƒç´ æ•°ç»„åˆ›å»º">ä½¿ç”¨åŸå§‹çš„åƒç´ æ•°ç»„åˆ›å»º</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CVPixelBufferRef pixelBuffer = NULL;</span><br><span class="line">int width=319;</span><br><span class="line">int height=64;</span><br><span class="line">CVPixelBufferCreateWithBytes(kCFAllocatorDefault,width,height,kCVPixelFormatType_24RGB,x.get(),3 * width, NULL, NULL, NULL, &amp;pixelBuffer);</span><br></pre></td></tr></table></figure><h3 id="è½¬æ¢ä¸º-uiimage">è½¬æ¢ä¸º UIImage</h3><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä¾‹å­æ¥æŠŠ CVPixelBufferRef è½¬æ¢ä¸º UIImageï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ª pixelBuffer</span><br><span class="line">CVPixelBufferRef pixelBuffer;</span><br><span class="line">CIImage *ciImage = [CIImage imageWithCVPixelBuffer:pixelBuffer];</span><br><span class="line">CIContext *temporaryContext = [CIContext contextWithOptions:nil];</span><br><span class="line">CGImageRef syszux_cgiimg = [temporaryContext createCGImage:ciImage fromRect:CGRectMake(0, 0,CVPixelBufferGetWidth(pixelBuffer),CVPixelBufferGetHeight(pixelBuffer))];</span><br><span class="line">UIImage *syszux_uiimg = [UIImage imageWithCGImage:syszux_cgiimg];</span><br><span class="line">CGImageRelease(syszux_cgiimg);</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-uiimage-åˆ›å»º">ä½¿ç”¨ UIImage åˆ›å»º</h3><p>UIImage æ˜¯ CGImage çš„ wrapperï¼Œé€šè¿‡ CGImage æ‹¿åˆ°å›¾åƒçš„å®½ã€é«˜ä¿¡æ¯ã€‚ç„¶ååœ¨ä¸€ä¸ª context ä¸­ï¼Œé€šè¿‡ CGContextDrawImage å‡½æ•°æ¥å°† CGImageâ€œæ¸²æŸ“â€å‡ºæ¥ï¼Œè¿™ä¸ªæ—¶å€™åŸå§‹çš„åƒç´ æ•°å°±ä¿å­˜åœ¨äº† context ä¸­ CVPixelBufferRef æŒ‡å‘çš„ baseAddress ä¸Šäº†ã€‚</p><p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">- (CVPixelBufferRef)syszuxPixelBufferFromUIImage:(UIImage *)originImage &#123;</span><br><span class="line">    CGImageRef image = originImage.CGImage;</span><br><span class="line">    NSDictionary *options = [NSDictionary dictionaryWithObjectsAndKeys:</span><br><span class="line">                             [NSNumber numberWithBool:YES], kCVPixelBufferCGImageCompatibilityKey,</span><br><span class="line">                             [NSNumber numberWithBool:YES], kCVPixelBufferCGBitmapContextCompatibilityKey,</span><br><span class="line">                             nil];</span><br><span class="line">    CVPixelBufferRef pxbuffer = NULL;</span><br><span class="line">    CGFloat frameWidth = CGImageGetWidth(image);</span><br><span class="line">    CGFloat frameHeight = CGImageGetHeight(image);</span><br><span class="line">    CVReturn status = CVPixelBufferCreate(kCFAllocatorDefault,</span><br><span class="line">                                          frameWidth,</span><br><span class="line">                                          frameHeight,</span><br><span class="line">                                          kCVPixelFormatType_32ARGB,</span><br><span class="line">                                          (__bridge CFDictionaryRef) options,</span><br><span class="line">                                          &amp;pxbuffer);</span><br><span class="line">    NSParameterAssert(status == kCVReturnSuccess &amp;&amp; pxbuffer != NULL);</span><br><span class="line">    CVPixelBufferLockBaseAddress(pxbuffer, 0);</span><br><span class="line">    void *pxdata = CVPixelBufferGetBaseAddress(pxbuffer);</span><br><span class="line">    NSParameterAssert(pxdata != NULL);</span><br><span class="line">    CGColorSpaceRef rgbColorSpace = CGColorSpaceCreateDeviceRGB();</span><br><span class="line">    CGContextRef context = CGBitmapContextCreate(pxdata,</span><br><span class="line">                                                 frameWidth,</span><br><span class="line">                                                 frameHeight,</span><br><span class="line">                                                 8,</span><br><span class="line">                                                 CVPixelBufferGetBytesPerRow(pxbuffer),</span><br><span class="line">                                                 rgbColorSpace,</span><br><span class="line">                                                 (CGBitmapInfo)kCGImageAlphaNoneSkipFirst);</span><br><span class="line">    NSParameterAssert(context);</span><br><span class="line">    CGContextConcatCTM(context, CGAffineTransformIdentity);</span><br><span class="line">    CGContextDrawImage(context, CGRectMake(0,</span><br><span class="line">                                           0,</span><br><span class="line">                                           frameWidth,</span><br><span class="line">                                           frameHeight),</span><br><span class="line">                       image);</span><br><span class="line">    CGColorSpaceRelease(rgbColorSpace);</span><br><span class="line">    CGContextRelease(context);</span><br><span class="line">    CVPixelBufferUnlockBaseAddress(pxbuffer, 0);</span><br><span class="line">    return pxbuffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ·±æ‹·è´">æ·±æ‹·è´</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (void)captureOutput:(AVCaptureOutput *)captureOutput didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer fromConnection:(AVCaptureConnection *)connection &#123;</span><br><span class="line">       CVPixelBufferRef pixelBuffer = CMSampleBufferGetImageBuffer(sampleBuffer);</span><br><span class="line">       // Get pixel buffer info</span><br><span class="line">       const int kBytesPerPixel = 4;</span><br><span class="line">       CVPixelBufferLockBaseAddress(pixelBuffer, 0);</span><br><span class="line">       int bufferWidth = (int)CVPixelBufferGetWidth(pixelBuffer);</span><br><span class="line">       int bufferHeight = (int)CVPixelBufferGetHeight(pixelBuffer);</span><br><span class="line">       size_t bytesPerRow = CVPixelBufferGetBytesPerRow(pixelBuffer); </span><br><span class="line">       uint8_t *baseAddress = CVPixelBufferGetBaseAddress(pixelBuffer);</span><br><span class="line">       // Copy the pixel buffer</span><br><span class="line">       CVPixelBufferRef pixelBufferCopy = NULL;</span><br><span class="line">       CVReturn status = CVPixelBufferCreate(kCFAllocatorDefault, bufferWidth, bufferHeight, kCVPixelFormatType_32BGRA, NULL, &amp;pixelBufferCopy);</span><br><span class="line">       CVPixelBufferLockBaseAddress(pixelBufferCopy, 0);</span><br><span class="line">       uint8_t *copyBaseAddress = CVPixelBufferGetBaseAddress(pixelBufferCopy);</span><br><span class="line">       memcpy(copyBaseAddress, baseAddress, bufferHeight * bytesPerRow);</span><br><span class="line">       // Do what needs to be done with the 2 pixel buffers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‹¥éœ€è¦å¯¹å¸§åšåŸºæœ¬å¤„ç†ï¼Œå¯ä»¥åªæ˜¯ vImage å¯¹å…¶è§£ç åæ•°æ®å¤„ç†ã€‚</p><h2 id="cvpixelbufferpool">CVPixelBufferPool</h2><p>CVPixelBufferPoolï¼Œä¸»è¦æ˜¯å®ç°äº† CVPixelBuffer ä¸­çš„ IOSurface çš„å¤ç”¨ä¸å›æ”¶ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;CVPixelBuffer ç±»ä¼¼ Android çš„ bitmapï¼Œæ ¸å¿ƒæ˜¯å°è£…äº†å·²ç»è§£å‹åçš„å›¾åƒæ•°æ®ã€‚ä¿å­˜äº†åƒç´ çš„ formatï¼Œå›¾åƒå®½é«˜å’Œ buffer æŒ‡é’ˆç­‰ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;h2 id=&quot;cvpixelbuffer-åˆ›å»ºä¸è½¬æ¢&quot;&gt;CVPixelBuffer åˆ›å»ºä¸è½¬æ¢&lt;/h2&gt;</summary>
    
    
    
    <category term="AVFoundation" scheme="https://bqlin.github.io/categories/AVFoundation/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>éŸ³è§†é¢‘åŒæ­¥</title>
    <link href="https://bqlin.github.io/posts/audio_and_video_synchronization/"/>
    <id>https://bqlin.github.io/posts/audio_and_video_synchronization/</id>
    <published>2021-03-15T09:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨çŸ­è§†é¢‘ä¸ç›´æ’­APPä¸­ï¼Œé‡‡é›†ç«¯ä½œä¸ºéŸ³è§†é¢‘çš„ç”Ÿäº§è€…ï¼Œå¦‚æœé‡‡é›†ç«¯äº§ç”Ÿçš„éŸ³è§†é¢‘æºæœ¬èº«å°±æ— æ³•ä¿è¯åŒæ­¥ï¼Œé‚£ä¹ˆåé¢ä¸ç®¡ç»è¿‡ä»€ä¹ˆå¤„ç†ï¼Œéƒ½å¾ˆéš¾å†è®©ç”¨æˆ·çœ‹åˆ°éŸ³è§†é¢‘åŒæ­¥çš„ç”»é¢äº†ï¼Œå› æ­¤ï¼Œåœ¨é‡‡é›†ç«¯ä¿è¯éŸ³è§†é¢‘åŒæ­¥ä¸Šå°¤å…¶é‡è¦ã€‚</p><h2 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h2><h3 id="æ—¶é—´åŸº">æ—¶é—´åŸº</h3><p>æ—¶é—´åŸºæ˜¯æŒ‡æ—¶é—´åˆ»åº¦ã€‚å› ä¸ºæ—¶é—´ä¿¡æ¯æ˜¯ä»¥æ•´æ•°å­˜å‚¨çš„ï¼Œè€Œæˆ‘ä»¬å¸¸ä½¿ç”¨çš„ç§’æ˜¯æµ®ç‚¹æ•°ï¼Œä¸ºäº†å­˜å‚¨æµ®ç‚¹æ•°åˆ™æŠŠæµ®ç‚¹æ•°ä½¿ç”¨åˆ†æ•°è¡¨è¾¾ã€‚æ—¶é—´åŸºå°±æ˜¯å…¶ä¸­çš„åˆ†æ¯ï¼Œæ—¶é—´å€¼æ˜¯åˆ†å­ï¼Œå¾—å‡ºæµ®ç‚¹å‹çš„æ—¶é—´ã€‚</p><p>åˆ†ç±»ï¼š</p><ul><li>tbrï¼Œtime base of rate: é€šå¸¸æ‰€è¯´çš„å¸§ç‡ã€‚</li><li>tbnï¼Œtime base of stream: è§†é¢‘æµçš„æ—¶é—´åŸºã€‚</li><li>tbcï¼Œtime base of codec: è§†é¢‘è§£ç çš„æ—¶é—´åŸºã€‚</li></ul><p>ä¸åŒåœºæ™¯çš„æ—¶é—´æˆ³å¯¹åº”ä¸åŒçš„æ—¶é—´åŸºï¼Œå¯¹äºè§†é¢‘æ¸²æŸ“åˆ™ä½¿ç”¨è§†é¢‘æµçš„æ—¶é—´åŸºã€‚</p><h2 id="éŸ³è§†é¢‘åŒæ­¥æ–¹å¼">éŸ³è§†é¢‘åŒæ­¥æ–¹å¼</h2><ul><li>è§†é¢‘åŒæ­¥åˆ°éŸ³é¢‘ã€‚é€‚ç”¨äºéŸ³é¢‘å„ç§å‚æ•°å›ºå®šï¼Œå³å…¶PTSæ˜¯å¯ä»¥ç®€å•è®¡ç®—çš„ï¼Œæ‰€ä»¥å¾ˆæ–¹ä¾¿åœ°ä¸è§†é¢‘å¸§çš„PTSå¯¹æ¯”è¿›è¡ŒåŒæ­¥ã€‚</li><li>éŸ³é¢‘åŒæ­¥åˆ°è§†é¢‘ã€‚åœ¨éŸ³è§†é¢‘æµé•¿åº¦ä¸ä¸€è‡´æ—¶ï¼Œè¦è€ƒè™‘å¯¹éŸ³é¢‘è¿›è¡Œä¸¢å¸§å’Œè¡¥å¸§ã€‚</li><li>éŸ³é¢‘å’Œè§†é¢‘éƒ½åŒæ­¥åˆ°ç³»ç»Ÿæ—¶é’Ÿã€‚</li></ul><p>åŸºæœ¬æ€è·¯ï¼š</p><ol type="1"><li>å±•ç¤ºç¬¬ä¸€å¸§è§†é¢‘å¸§åï¼Œè·å¾—è¦æ˜¾ç¤ºçš„ä¸‹ä¸€ä¸ªè§†é¢‘å¸§çš„PTSï¼›</li><li>è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼›</li><li>å½“å®šæ—¶å™¨è¶…æ—¶ååˆ·æ–°æ–°çš„è§†é¢‘å¸§ã€‚</li><li>å¾ªç¯åå¤ã€‚</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨çŸ­è§†é¢‘ä¸ç›´æ’­APPä¸­ï¼Œé‡‡é›†ç«¯ä½œä¸ºéŸ³è§†é¢‘çš„ç”Ÿäº§è€…ï¼Œå¦‚æœé‡‡é›†ç«¯äº§ç”Ÿçš„éŸ³è§†é¢‘æºæœ¬èº«å°±æ— æ³•ä¿è¯åŒæ­¥ï¼Œé‚£ä¹ˆåé¢ä¸ç®¡ç»è¿‡ä»€ä¹ˆå¤„ç†ï¼Œéƒ½å¾ˆéš¾å†è®©ç”¨æˆ·çœ‹åˆ°éŸ³è§†é¢‘åŒæ­¥çš„ç”»é¢äº†ï¼Œå› æ­¤ï¼Œåœ¨é‡‡é›†ç«¯ä¿è¯éŸ³è§†é¢‘åŒæ­¥ä¸Šå°¤å…¶é‡è¦ã€‚&lt;/p&gt;
&lt;h2 id=&quot;åŸºæœ¬æ¦‚å¿µ&quot;&gt;åŸºæœ¬æ¦‚å¿µ&lt;/h2&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>è§†é¢‘ç ç‡æ§åˆ¶</title>
    <link href="https://bqlin.github.io/posts/video_bit_rate_control/"/>
    <id>https://bqlin.github.io/posts/video_bit_rate_control/</id>
    <published>2021-03-15T08:34:44.000Z</published>
    <updated>2021-11-22T02:42:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>è§†é¢‘ç¼–ç è¿‡ç¨‹ä¸­ï¼Œé‡åŒ–ï¼ˆæœ‰æŸå‹ç¼©ï¼‰å†³å®šäº†è§†é¢‘çš„ç ç‡ï¼Œè§†é¢‘ç ç‡åˆä¸€å®šç¨‹åº¦å†³å®šäº†è§†é¢‘çš„è´¨é‡ã€‚</p><p>é‡åŒ–å€¼QPè¶Šå¤§åˆ™é‡åŒ–çš„ç²’åº¦è¶Šé«˜ï¼Œå‹ç¼©æ¯”è¶Šå¤§ï¼Œç ç‡è¶Šå°ï¼Œè§†é¢‘è´¨é‡è¶Šä½ï¼Œå‘ˆç°çš„ç”»é¢é©¬èµ›å…‹è¾ƒå¤§ã€æ¨¡ç³Šä¸ç»†è…»ã€‚åä¹‹äº¦ç„¶ã€‚</p><p>é€‰æ‹©ä¸€ä¸ªé€‚åˆåœºæ™¯çš„è§†é¢‘ç æ§æ–¹æ¡ˆå¾ˆé‡è¦ï¼Œè°ƒæ•´è§†é¢‘è¾“å‡ºç ç‡å°±æ˜¯åœ¨è§†é¢‘ç¼–ç é€Ÿåº¦ã€ç½‘ç»œå¸¦å®½ä»¥åŠè§†é¢‘è´¨é‡ä¹‹é—´åšå¹³è¡¡ã€‚æ€»ä½“æ¥è¯´ï¼Œé€‰æ‹©è§†é¢‘ç ç‡æ§åˆ¶æ–¹æ¡ˆï¼Œå¯é€šè¿‡ä¸€ä¸‹å› ç´ æƒè¡¡å¾—å‡ºï¼š</p><ul><li>ç”»è´¨ï¼Œè§†è§‰è´¨é‡ç¨³å®šæ€§ã€‚å¦‚æ¸…æ™°åº¦ã€æµç•…åº¦ã€ç»†èŠ‚ç­‰ï¼Œè¿™ä¸äººçœ¼çš„è§†è§‰åŸç†æœ‰å…³ï¼Œé€‰æ‹©äººçœ¼ä¸»åŠ¨è´¨é‡æ„Ÿå—æœ€é«˜çš„æ¨¡å‹ã€‚</li><li>è¾“å‡ºç ç‡ã€‚è¦è€ƒè™‘ç½‘ç»œå¸¦å®½å› ç´ ã€‚</li><li>è§†é¢‘æ–‡ä»¶å¤§å°ã€‚åˆ©äºä¼ è¾“ã€å­˜å‚¨ï¼Œè¿˜è¦çœ‹ç³»ç»Ÿçš„ç©ºé—´å¤§å°ã€‚</li><li>ç¼–ç é€Ÿåº¦ã€‚ä¸åŒçš„ç æ§æ¨¡å‹å½±å“äº†ç¼–ç é€Ÿåº¦ã€‚</li></ul><h2 id="ç æ§å› ç´ ">ç æ§å› ç´ </h2><p>GOPé•¿åº¦</p><p>Maximun B-frameï¼Œæœ€å¤§Bå¸§æ•°é‡</p><p>Reference frameï¼Œè®¾å®šä¸€ä¸ªPå¸§æ‰€èƒ½å‚è€ƒçš„å¸§æ•°é‡ï¼Œä¼šå½±å“æ’­æ”¾ç›¸å®¹æ€§ã€‚</p><p>QPï¼ŒConstant Quantizerï¼Œæ’å®šé‡åŒ–å€¼ï¼šæ§åˆ¶å›¾åƒç”»è´¨ï¼Œæ•°å€¼è¶Šä½ç”»è´¨è¶Šé«˜ã€‚</p><h2 id="ç æ§æ¨¡å‹">ç æ§æ¨¡å‹</h2><p>ç ç‡æ§åˆ¶å®é™…ä¸Šæ˜¯ä¸€ç§ç¼–ç çš„ä¼˜åŒ–ç®—æ³•ï¼Œå®ƒç”¨äºå®ç°å¯¹è§†é¢‘æµç æµå¤§å°çš„æ§åˆ¶ã€‚ç›®çš„åœ¨äºåŒæ ·çš„è§†é¢‘ç¼–ç æ ¼å¼ï¼Œç æµå¤§ï¼Œå®ƒåŒ…å«çš„ä¿¡æ¯ä¹Ÿå°±è¶Šå¤šï¼Œé‚£ä¹ˆå¯¹åº”çš„å›¾åƒä¹Ÿå°±è¶Šæ¸…æ™°ï¼Œåä¹‹äº¦ç„¶ã€‚</p><h3 id="cqp">CQP</h3><p>å›ºå®šQPã€‚æœ€ç®€å•çš„ç æ§æ–¹å¼ï¼Œæ¯å¸§å›¾åƒéƒ½æŒ‰ç…§ä¸€ä¸ªç‰¹å®šçš„QPæ¥ç¼–ç ï¼Œæ¯å¸§ç¼–ç åçš„æ•°æ®é‡æœ‰å¤šå¤§ä»æ˜¯æœªçŸ¥çš„ï¼Œæ—¢ä¸æ˜¯ç ç‡ä¼˜å…ˆæ¨¡å‹ï¼Œä¹Ÿä¸æ˜¯è´¨é‡ä¼˜å…ˆæ¨¡å‹ã€‚</p><h4 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h4><ul><li>ç¬æ—¶ç ç‡ä¼šéšåœºæ™¯å¤æ‚åº¦æ³¢åŠ¨ã€‚</li><li>ç¼–ç é€Ÿåº¦å¿«ï¼Œè°ƒæ§æœ€ç®€å•ã€‚</li><li>x264å’Œx265ä¸­æ”¯æŒCQPæ¨¡å¼ï¼Œlibvpxä¸æ”¯æŒã€‚<ul><li>H.264ä¸­QPèŒƒå›´æ˜¯[0, 51]ã€‚QPå€¼è¶Šå¤§è¡¨ç¤ºè¶Šå¤§çš„é‡åŒ–æ­¥é•¿ï¼Œç¼–ç è§†é¢‘çš„è´¨é‡è¶Šä½ã€‚QPä¸º0è¡¨ç¤ºè¿›è¡Œæ— æŸç¼–ç ã€‚</li></ul></li></ul><h4 id="é€‚ç”¨åœºæ™¯">é€‚ç”¨åœºæ™¯</h4><p>ä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå› ä¸ºè¿™æ²¡æœ‰è€ƒè™‘ç¼–ç å†…å®¹çš„å¤æ‚æ€§ï¼Œç”¨ç›¸åŒçš„å‹ç¼©æ¯”å¤„ç†æ¯ä¸€å¸§ã€‚å‡ºæ¥çš„è§†é¢‘è´¨é‡å’Œç ç‡éƒ½ä¸å›ºå®šã€‚é€‚åˆäºéå¸¸ç®€å•çš„è¿åŠ¨é‡å¾ˆå°çš„ç”»é¢ï¼Œå› ä¸ºä¸€é‡åˆ°å¤æ‚åœºæ™¯ï¼Œå…¶ç ç‡æ³¢åŠ¨å°±éå¸¸å¤§ã€‚</p><h3 id="crf">CRF</h3><p>Constant Rate Factorï¼Œæ’å®šç ç‡ç³»æ•°ã€‚æŠŠæŸä¸€ä¸ªâ€œè§†è§‰è´¨é‡â€ä½œä¸ºè¾“å‡ºç›®æ ‡ã€‚é€šè¿‡é™ä½é‚£äº›è€—è´¹ç ç‡ä½†æ˜¯åˆå•ä¸€ç”¨è‚‰çœ¼å¯Ÿè§‰çš„å¸§ï¼ˆé«˜é€Ÿè¿åŠ¨æˆ–çº¹ç†ä¸°å¯Œï¼‰çš„è´¨é‡ï¼Œæå‡é‚£äº›é™æ€å¸§ç ç‡æ¥è¾¾åˆ°ç›®çš„ã€‚</p><p>å¸§é—´QPå˜åŒ–ï¼Œå¸§å†…å®å—QPå˜åŒ–ï¼Œè¾“å‡ºç ç‡æœªçŸ¥ï¼Œå„å¸§è¾“å‡ºçš„è§†è§‰è´¨é‡åŸºæœ¬æ’å®šï¼Œç›¸å½“äºå›ºå®šè´¨é‡æ¨¡å¼+é™åˆ¶ç ç‡å³°å€¼çš„æ–¹å¼ã€‚</p><h4 id="ç‰¹ç‚¹-1">ç‰¹ç‚¹</h4><ul><li>ä¸æ’å®šQPç±»ä¼¼ï¼Œå•è¿½æ±‚ä¸»è§‚æ„ŸçŸ¥çš„è´¨é‡æ’å®šï¼Œç¬æ—¶ç ç‡ä¹Ÿä¼šéšåœºæ™¯å¤æ‚åº¦æ³¢åŠ¨ï¼Œè§†é¢‘å¸§ä¹‹é—´æˆ–è€…å†…éƒ¨å®å—ä¹‹é—´çš„QPå€¼éƒ½ä¸ä¸€æ ·ã€‚</li><li>å¯¹äºå¿«é€Ÿè¿åŠ¨æˆ–ç»†èŠ‚ä¸°å¯Œçš„åœºæ™¯ä¼šé€‚å½“å¢å¤§é‡åŒ–å¤±çœŸï¼ˆå› ä¸ºäººçœ¼ä¸æ•æ„Ÿï¼‰ï¼›åä¹‹å¯¹äºé™æ­¢æˆ–å¹³å¦åŒºåŸŸåˆ™å‡å°‘é‡åŒ–å¤±çœŸã€‚</li><li>CRFæ˜¯x264å’Œx265çš„é»˜è®¤ç ç‡æ§åˆ¶æ–¹å¼ï¼Œä¹Ÿå¯ç”¨äºlibvpxã€‚<ul><li>RFå€¼è¶Šå¤§è§†é¢‘å‹ç¼©æ¯”è¶Šé«˜ï¼Œä½†è§†é¢‘è´¨é‡è¶Šä½ï¼Œå„codecçš„CRFå–å€¼èŒƒå›´ä¸€èˆ¬[0-51]ï¼Œä½†æ˜¯ä¸€èˆ¬é»˜è®¤å€¼x264ç”¨23ï¼Œx265é»˜è®¤ä¸º28ã€‚</li><li>å¦‚æœä½ ä¸ç¡®å®šè¦ä½¿ç”¨ä»€ä¹ˆRFï¼Œä»é»˜è®¤å€¼å¼€å§‹ï¼Œå¹¶æ ¹æ®å¯¹è¾“å‡ºçš„ä¸»è§‚å°è±¡è¿›è¡Œæ›´æ”¹ã€‚å¦‚æœè´¨é‡æ²¡æœ‰è¶³å¤Ÿå¥½åˆ™è¾ƒä½çš„RFã€‚å¦‚æœæ–‡ä»¶å¤ªå¤§äº†åˆ™é€‰æ‹©æ›´é«˜çš„RFã€‚æ›´æ”¹Â±6ä¼šå¯¼è‡´ç ç‡å¤§å°çš„ä¸€åŠ/ä¸¤å€å·¦å³çš„å˜åŒ–ï¼ŒÂ±1ä¼šå¯¼è‡´ç ç‡10%å·¦å³çš„å˜åŒ–ã€‚</li></ul></li></ul><h4 id="é€‚ç”¨åœºæ™¯-1">é€‚ç”¨åœºæ™¯</h4><p>å¯¹è§†é¢‘è´¨é‡åˆä¸€å®šè¦æ±‚çš„åœºæ™¯ã€‚CRFå€¼å¯ä»¥ç®€å•ç†è§£ä¸ºå¯¹è§†é¢‘è´¨é‡æœ€æœŸæœ›çš„ä¸€ä¸ªè¾“å‡ºå›ºå®šå€¼ï¼Œæ— è®ºæ˜¯åœ¨è¿åŠ¨å¤æ‚åœºæ™¯è¿˜æ˜¯åœ¨é™æ­¢ç®€å•çš„åœºæ™¯ä¸‹ï¼Œéƒ½å¸Œæœ›ä¸€ä¸ªç¨³å®šçš„ä¸»è§‚è§†é¢‘è´¨é‡æ—¶ï¼Œé€‰æ‹©è¯¥æ¨¡å¼ã€‚è¯¥æ¨¡å¼æ—¶è§†é¢‘è´¨é‡ä¼˜å…ˆæ¨¡å‹ã€‚è§†é¢‘è´¨é‡å¯ç®€å•ç†è§£ä¸ºè§†é¢‘æ¸…æ™°åº¦ã€åƒç´ çš„ç»†è…»ç¨‹åº¦å’Œè§†é¢‘çš„æµç•…åº¦ã€‚</p><h3 id="cbr">CBR</h3><p>Constant Bit Rateï¼Œæ’å®šç ç‡ã€‚ä¸€å®šæ—¶é—´èŒƒå›´å†…ç ç‡åŸºæœ¬ä¿æŒæ’å®šï¼Œå±äºç ç‡ä¼˜å…ˆæ¨¡å‹ã€‚</p><h4 id="ç‰¹å®š">ç‰¹å®š</h4><ul><li>ç ç‡ç¨³å®šï¼Œä½†è´¨é‡ä¸ç¨³å®šã€‚å¸¦å®½æœ‰æ•ˆåˆ©ç”¨ç‡ä¸é«˜ï¼Œç‰¹åˆ«å½“è¯¥å€¼è®¾ç½®ä¸åˆç†ï¼Œåœ¨å¤æ‚è¿åŠ¨åœºæ™¯ä¸‹ï¼Œç”»é¢ä¼šéå¸¸æ¨¡ç³Šï¼Œéå¸¸å½±å“è§‚çœ‹ä½“éªŒã€‚</li><li>è¾“å‡ºè§†é¢‘ç ç‡ç¨³å®šï¼Œä¾¿äºè®¡ç®—è§†é¢‘ä½“ç§¯å¤§å°ã€‚</li></ul><h4 id="é€‚ç”¨åœºæ™¯-2">é€‚ç”¨åœºæ™¯</h4><p>ä¸€èˆ¬ä¹Ÿä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå› ä¸ºè¿™ç§æ¨¡å‹ä¸è€ƒè™‘è§†é¢‘å†…å®¹çš„å¤æ‚æ€§ï¼Œå§æ‰€æœ‰è§†é¢‘å¸§éƒ½ç»Ÿä¸€å¯¹å¾…ã€‚ä½†æœ‰äº›ç¼–ç è½¯ä»¶åªæ”¯æŒå›ºå®šè´¨é‡æˆ–å›ºå®šç ç‡ï¼Œæœ‰æ—¶ä¸å¾—ä¸ç”¨ã€‚ä½¿ç”¨çš„æ—¶å€™ï¼Œåœ¨å…è®¸çš„å¸¦å®½èŒƒå›´å†…å°½å¯èƒ½å§å¸¦å®½è®¾ç½®å¤§äº›ï¼Œä»¥é˜²æ­¢å¤æ‚åœºæ™¯ä¸‹è§†é¢‘è´¨é‡çš„é™ä½ï¼Œå¦‚æœè®¾ç½®ä¸åˆç†ï¼Œåœ¨è¿åŠ¨åœºæ™¯ä¸‹å°±ç³Šå¾—çœ‹ä¸æˆäº†ã€‚</p><h3 id="vbr">VBR</h3><p>Variable Bit Rateï¼Œå¯å˜ç ç‡ã€‚</p><p>ç®€å•åœºæ™¯åˆ†é…è¾ƒå¤§QPï¼Œå¤æ‚åœºæ™¯åˆ†é…è¾ƒå¤§QPï¼Œå¾—åˆ°åŸºæœ¬ç¨³å®šçš„è§†é¢‘è´¨é‡ã€‚ç¡®å®šæ—¶è¾“å‡ºç ç‡ä¸å¯æ§ã€‚</p><p>æœ‰ä¸¤ç§è°ƒæ§æ¨¡å¼ï¼š</p><ul><li>è´¨é‡ä¼˜å…ˆæ¨¡å¼ï¼šä¸è€ƒè™‘è§†é¢‘æ–‡ä»¶å¤§å°ï¼Œå®Œå…¨æŒ‰ç…§è§†é¢‘å†…å®¹å¤æ‚åº¦æ¥åˆ†é…ç ç‡ï¼Œè¿™æ ·è§†é¢‘çš„æ’­æ”¾æ•ˆæœæœ€ä½³ã€‚</li><li>äºŒæ¬¡ç¼–ç æ–¹å¼ï¼Œ2PASSï¼šç¬¬ä¸€æ¬¡ç¼–ç æ£€æµ‹è§†é¢‘å†…å®¹ç®€å•å’Œå¤æ‚çš„éƒ¨åˆ†ï¼ŒåŒæ—¶ç¡®å®šç®€å•å’Œå¤æ‚çš„æ¯”ä¾‹ã€‚ç¬¬äºŒéç¼–ç è®©è§†é¢‘çš„å¹³å‡ç ç‡ä¸å˜ï¼Œå¤æ‚çš„åœ°æ–¹åˆ†é…æ›´å¤šæ¯”ç‰¹ï¼Œç®€å•åœ°æ–¹åˆ†é…æ›´å°‘æ¯”ç‰¹ã€‚ç¼ºç‚¹æ—¶é€Ÿåº¦è¾ƒæ…¢ã€‚</li></ul><h4 id="ç‰¹ç‚¹-2">ç‰¹ç‚¹</h4><ul><li>ç ç‡ä¸ç¨³å®šï¼Œä½†è´¨é‡ç¨³å®šä¸”éå¸¸é«˜ã€‚</li><li>ç¼–ç é€Ÿåº¦è¾ƒæ…¢ã€‚ç‚¹æ’­ã€ä¸‹è½½å’Œå­˜å‚¨ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨ï¼Œä¸é€‚åˆä½å»¶è¿Ÿç›´æ’­ç³»ç»Ÿã€‚</li><li>è¯¥æ¨¡å‹å®Œå…¨ä¸è€ƒè™‘è¾“å‡ºè§†é¢‘å¸¦å®½ï¼Œä¸ºäº†è´¨é‡ï¼Œéœ€è¦å¤šå°‘ç ç‡å°±å ç”¨å¤šå°‘ï¼Œä¹Ÿä¸è€ƒè™‘ç¼–ç é€Ÿåº¦ã€‚</li></ul><h4 id="é€‚ç”¨åœºæ™¯-3">é€‚ç”¨åœºæ™¯</h4><p>é€‚ç”¨äºé‚£äº›å¯¹å¸¦å®½å’Œç¼–ç é€Ÿåº¦ä¸å¤ªé™åˆ¶ï¼Œä½†å¯¹è§†é¢‘è´¨é‡å¾ˆé«˜è¦æ±‚çš„åœºæ™¯ã€‚ç‰¹åˆ«æ˜¯åœ¨è¿åŠ¨å¤æ‚åœºæ™¯ä¸‹ä¹Ÿèƒ½ä¿æŒè¾ƒé«˜çš„æ¸…æ™°åº¦ï¼Œä¸”è¾“å‡ºè´¨é‡è¾ƒç¨³å®šã€‚é€‚åˆå»¶æ—¶ä¸æ•æ„Ÿçš„ç‚¹æ’­ã€å½•æ’­æˆ–å­˜å‚¨ç³»ç»Ÿã€‚</p><h3 id="abr">ABR</h3><p>Average Bit Rateï¼Œæ’å®šå¹³å‡ç›®æ ‡ç ç‡ã€‚</p><p>ç®€å•åœºæ™¯åˆ†é…è¾ƒä½ç ç‡ï¼Œå¤æ‚åœºæ™¯åˆ†é…è¶³å¤Ÿç ç‡ï¼Œä½¿å¾—æœ‰é™çš„ç ç‡åœ¨ä¸åŒåœºæ™¯ä¸‹éƒ½èƒ½åˆç†åˆ†é…ï¼Œç±»ä¼¼äºVBRã€‚åŒæ„æ—¶é—´å†…ï¼Œå¹³å‡ç ç‡åˆæ¥è¿‘è®¾ç½®çš„ç›®æ ‡ç ç‡ï¼Œè¿™æ ·å¯ä»¥æ§åˆ¶è¾“å‡ºæ–‡ä»¶çš„å¤§å°ï¼Œè¿™åˆç±»ä¼¼äºCBRã€‚å¯ä»¥è®¤ä¸ºæ˜¯CBRå’ŒVBRçš„æŠ˜ä¸­æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯å¤§å¤šäººçš„é€‰æ‹©ã€‚ç‰¹åˆ«æ˜¯åœ¨å¯¹è´¨é‡å’Œè§†é¢‘å¸¦å®½éƒ½æœ‰è¦æ±‚çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¼˜å…ˆé€‰æ‹©è¯¥æ¨¡å¼ã€‚ä¸€èˆ¬é€Ÿåº¦æ˜¯VBRçš„2ï½3å€ï¼Œç›¸åŒä½“ç§¯çš„è§†é¢‘æ–‡ä»¶è´¨é‡å´æ¯”CBRå¥½å¾—å¤šã€‚</p><h4 id="ç‰¹ç‚¹-3">ç‰¹ç‚¹</h4><ul><li>è§†é¢‘è´¨é‡æ•´ä½“å¯æ§ï¼ŒåŒæ—¶å…¼é¡¾ç‡è§†é¢‘ç ç‡å’Œç¼–ç é€Ÿåº¦ã€‚</li><li>ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸€èˆ¬è¦è®¾ç½®æœ€ä½ç ç‡ã€æœ€é«˜ç ç‡å’Œå¹³å‡ç ç‡ï¼Œè¿™äº›å€¼çš„è®¾ç½®å°½å¯èƒ½åˆç†ã€‚</li></ul><h4 id="é€‚ç”¨åœºæ™¯-4">é€‚ç”¨åœºæ™¯</h4><p>ABRåœ¨ç›´æ’­å’Œä½å»¶æ—¶ç³»ç»Ÿä½¿ç”¨è¾ƒå¤šï¼Œå› ä¸ºåªç¼–ç äº†ä¸€æ¬¡ï¼Œæ‰€ä»¥é€Ÿåº¦å¿«ã€‚åŒæ—¶å…¼é¡¾äº†è§†é¢‘è´¨é‡å’Œå¸¦å®½ï¼Œå¯¹äºè½¬ç é€Ÿåº¦æœ‰è¦æ±‚çš„æƒ…å†µä¸‹ä¹Ÿå¯èƒ½é€‰æ‹©è¯¥æ¨¡å¼ã€‚Bç«™å¤§éƒ¨åˆ†è§†é¢‘é€‰æ‹©äº†è¯¥æ¨¡å¼ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;è§†é¢‘ç¼–ç è¿‡ç¨‹ä¸­ï¼Œé‡åŒ–ï¼ˆæœ‰æŸå‹ç¼©ï¼‰å†³å®šäº†è§†é¢‘çš„ç ç‡ï¼Œè§†é¢‘ç ç‡åˆä¸€å®šç¨‹åº¦å†³å®šäº†è§†é¢‘çš„è´¨é‡ã€‚&lt;/p&gt;
&lt;p&gt;é‡åŒ–å€¼QPè¶Šå¤§åˆ™é‡åŒ–çš„ç²’åº¦è¶Šé«˜ï¼Œå‹ç¼©æ¯”è¶Šå¤§ï¼Œç ç‡è¶Šå°ï¼Œè§†é¢‘è´¨é‡è¶Šä½ï¼Œå‘ˆç°çš„ç”»é¢é©¬èµ›å…‹è¾ƒå¤§ã€æ¨¡ç³Šä¸ç»†è…»ã€‚åä¹‹äº¦ç„¶ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>å¸¸ç”¨è§†é¢‘å‚æ•°è®¾ç½®ï¼ˆç»éªŒå€¼ï¼‰</title>
    <link href="https://bqlin.github.io/posts/common_video_parameter_settings/"/>
    <id>https://bqlin.github.io/posts/common_video_parameter_settings/</id>
    <published>2021-03-15T07:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://docs.agora.io/cn/Interactive%20Broadcast/video_profile_apple?platform=iOS">è®¾ç½®è§†é¢‘ç¼–ç å±æ€§</a></p><h4 id="è§†é¢‘å±æ€§å‚è€ƒè¡¨">è§†é¢‘å±æ€§å‚è€ƒè¡¨</h4><p>è§†é¢‘èƒ½å¦è¾¾åˆ° 960 Ã— 720 åŠä»¥ä¸Šçš„åˆ†è¾¨ç‡è¿˜å–å†³äºç”¨æˆ·çš„è®¾å¤‡ã€‚åˆ†è¾¨ç‡ 1290 Ã— 1080 åŠä»¥ä¸Šçš„è§†é¢‘å±æ€§ä»…é€‚ç”¨äº macOS å¹³å°ã€‚</p><table><thead><tr class="header"><th>åˆ†è¾¨ç‡ (å®½ Ã— é«˜)</th><th>å¸§ç‡ (fps)</th><th>åŸºå‡†ç ç‡ (Kbpsï¼Œé€‚ç”¨äºé€šä¿¡)</th><th>ç›´æ’­ç ç‡ (Kbpsï¼Œé€‚ç”¨äºç›´æ’­)</th></tr></thead><tbody><tr class="odd"><td>160 Ã— 120</td><td>15</td><td>65</td><td>130</td></tr><tr class="even"><td>120 Ã— 120</td><td>15</td><td>50</td><td>100</td></tr><tr class="odd"><td>320 Ã— 180</td><td>15</td><td>140</td><td>280</td></tr><tr class="even"><td>180 Ã— 180</td><td>15</td><td>100</td><td>200</td></tr><tr class="odd"><td>240 Ã— 180</td><td>15</td><td>120</td><td>240</td></tr><tr class="even"><td>320 Ã— 240</td><td>15</td><td>200</td><td>400</td></tr><tr class="odd"><td>240 Ã— 240</td><td>15</td><td>140</td><td>280</td></tr><tr class="even"><td>424 Ã— 240</td><td>15</td><td>220</td><td>440</td></tr><tr class="odd"><td>640 Ã— 360</td><td>15</td><td>400</td><td>800</td></tr><tr class="even"><td>360 Ã— 360</td><td>15</td><td>260</td><td>520</td></tr><tr class="odd"><td>640 Ã— 360</td><td>30</td><td>600</td><td>1200</td></tr><tr class="even"><td>360 Ã— 360</td><td>30</td><td>400</td><td>800</td></tr><tr class="odd"><td>480 Ã— 360</td><td>15</td><td>320</td><td>640</td></tr><tr class="even"><td>480 Ã— 360</td><td>30</td><td>490</td><td>980</td></tr><tr class="odd"><td>640 Ã— 480</td><td>15</td><td>500</td><td>1000</td></tr><tr class="even"><td>480 Ã— 480</td><td>15</td><td>400</td><td>800</td></tr><tr class="odd"><td>640 Ã— 480</td><td>30</td><td>750</td><td>1500</td></tr><tr class="even"><td>480 Ã— 480</td><td>30</td><td>600</td><td>1200</td></tr><tr class="odd"><td>848 Ã— 480</td><td>15</td><td>610</td><td>1220</td></tr><tr class="even"><td>848 Ã— 480</td><td>30</td><td>930</td><td>1860</td></tr><tr class="odd"><td>640 Ã— 480</td><td>10</td><td>400</td><td>800</td></tr><tr class="even"><td>1280 Ã— 720</td><td>15</td><td>1130</td><td>2260</td></tr><tr class="odd"><td>1280 Ã— 720</td><td>30</td><td>1710</td><td>3420</td></tr><tr class="even"><td>960 Ã— 720</td><td>15</td><td>910</td><td>1820</td></tr><tr class="odd"><td>960 Ã— 720</td><td>30</td><td>1380</td><td>2760</td></tr><tr class="even"><td>1920 Ã— 1080</td><td>15</td><td>2080</td><td>4160</td></tr><tr class="odd"><td>1920 Ã— 1080</td><td>30</td><td>3150</td><td>6300</td></tr><tr class="even"><td>1920 Ã— 1080</td><td>60</td><td>4780</td><td>6500</td></tr><tr class="odd"><td>2560 Ã— 1440</td><td>30</td><td>4850</td><td>6500</td></tr><tr class="even"><td>2560 Ã— 1440</td><td>60</td><td>6500</td><td>6500</td></tr><tr class="odd"><td>3840 Ã— 2160</td><td>30</td><td>6500</td><td>6500</td></tr><tr class="even"><td>3840 Ã— 2160</td><td>60</td><td>6500</td><td>6500</td></tr></tbody></table><h4 id="å¸¸ç”¨åˆ†è¾¨ç‡å¸§ç‡å’Œç ç‡">å¸¸ç”¨åˆ†è¾¨ç‡ã€å¸§ç‡å’Œç ç‡</h4><p>é€šå¸¸æ¥è®²ï¼Œè§†é¢‘å‚æ•°çš„é€‰æ‹©è¦æ ¹æ®äº§å“å®é™…æƒ…å†µæ¥ç¡®å®šï¼Œæ¯”å¦‚ï¼Œå¦‚æœä¸€å¯¹ä¸€ï¼Œè€å¸ˆå’Œå­¦ç”Ÿçš„çª—å£æ¯”è¾ƒå¤§ï¼Œè¦æ±‚åˆ†è¾¨ç‡ä¼šé«˜ä¸€ç‚¹ï¼Œéšä¹‹å¸§ç‡å’Œç ç‡ä¹Ÿè¦é«˜ä¸€ç‚¹ï¼›å¦‚æœæ˜¯ä¸€å¯¹å››ï¼Œ è€å¸ˆå’Œå­¦ç”Ÿçš„çª—å£éƒ½æ¯”è¾ƒå°ï¼Œåˆ†è¾¨ç‡å¯ä»¥ä½ä¸€ç‚¹ï¼Œå¯¹åº”çš„ç ç‡å¸§ç‡ä¹Ÿä¼šä½ä¸€ç‚¹ï¼Œä»¥å‡å°‘ç¼–è§£ç çš„èµ„æºæ¶ˆè€—å’Œç¼“è§£ä¸‹è¡Œå¸¦å®½å‹åŠ›ã€‚ä¸€èˆ¬å¯æŒ‰ä¸‹åˆ—åœºæ™¯ä¸­çš„æ¨èå€¼è¿›è¡Œè®¾ç½®ã€‚</p><ul><li>äºŒäººè§†é¢‘é€šè¯åœºæ™¯ï¼š<ul><li>åˆ†è¾¨ç‡ 320 x 240ã€å¸§ç‡ 15 fpsã€ç ç‡ 200 Kbps</li><li>åˆ†è¾¨ç‡ 640 x 360ã€å¸§ç‡ 15 fpsã€ç ç‡ 400 Kbps</li></ul></li><li>å¤šäººè§†é¢‘é€šè¯åœºæ™¯ï¼š<ul><li>åˆ†è¾¨ç‡ 160 x 120ã€å¸§ç‡ 15 fpsã€ç ç‡ 65 Kbps</li><li>åˆ†è¾¨ç‡ 320 x 180ã€å¸§ç‡ 15 fpsã€ç ç‡ 140 Kbps</li><li>åˆ†è¾¨ç‡ 320 x 240ã€å¸§ç‡ 15 fpsã€ç ç‡ 200 Kbps</li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://docs.agora.io/cn/Interactive%20Broadcast/video_profile_apple?platform=iOS&quot;&gt;è®¾ç½®è§†é¢‘ç¼–ç å±æ€§&lt;/a&gt;&lt;/p&gt;
&lt;h4 id=&quot;è§†é¢‘å±æ€§å‚è€ƒè¡¨&quot;&gt;è§†é¢‘å±æ€§å‚è€ƒè¡¨&lt;/h4&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>AVC Profile &amp; Level</title>
    <link href="https://bqlin.github.io/posts/avc_profile_and_level/"/>
    <id>https://bqlin.github.io/posts/avc_profile_and_level/</id>
    <published>2021-03-15T06:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="avc-profile">AVC Profile</h1><p>The standard defines several sets of capabilities, which are referred to as <em>profiles</em>, targeting specific classes of applications. These are declared using a profile code (profile_idc) and sometimes a set of additional constraints applied in the encoder. The profile code and indicated constraints allow a decoder to recognize the requirements for decoding that specific bitstream. (And in many system environments, only one or two profiles are allowed to be used, so decoders in those environments do not need to be concerned with recognizing the less commonly used profiles.) By far the most commonly used profile is the High Profile.</p><p>é’ˆå¯¹ç‰¹å®šç±»åˆ«çš„åº”ç”¨ç¨‹åºï¼Œæ ‡å‡†å®šä¹‰äº†å‡ ç»„åŠŸèƒ½ï¼Œç§°ä¸ºé…ç½®æ–‡ä»¶ï¼ˆprofileï¼‰ã€‚è¿™äº›åŠŸèƒ½æ˜¯ç”¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä»£ç ï¼ˆprofile_idcï¼‰æ¥å£°æ˜çš„ï¼Œæœ‰æ—¶è¿˜åœ¨ç¼–ç å™¨ä¸­åº”ç”¨ä¸€ç»„é¢å¤–çš„çº¦æŸã€‚é…ç½®æ–‡ä»¶ä»£ç å’ŒæŒ‡å®šçš„çº¦æŸæ¡ä»¶å…è®¸è§£ç å™¨è¯†åˆ«è§£ç è¯¥ç‰¹å®šæ¯”ç‰¹æµçš„è¦æ±‚ã€‚åœ¨è®¸å¤šç³»ç»Ÿç¯å¢ƒä¸­ï¼Œåªå…è®¸ä½¿ç”¨ä¸€ä¸ªæˆ–ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥è¿™äº›ç¯å¢ƒä¸­çš„è§£ç å™¨ä¸éœ€è¦å…³æ³¨è¯†åˆ«ä¸å¤ªå¸¸ç”¨çš„é…ç½®æ–‡ä»¶ï¼‰ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæœ€å¸¸ç”¨çš„é…ç½®æ–‡ä»¶æ˜¯High Profileã€‚</p><p>Profiles for non-scalable 2D video applications include the following:</p><p>ç”¨äºéå¯æ‰©å±•çš„äºŒç»´è§†é¢‘åº”ç”¨çš„é…ç½®æ–‡ä»¶åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ã€‚</p><h2 id="constrained-baseline-profile-cbp-66-with-constraint-set-1">Constrained Baseline Profile (CBP, 66 with constraint set 1)</h2><p>Primarily for low-cost applications, this profile is most typically used in videoconferencing and mobile applications. It corresponds to the subset of features that are in common between the Baseline, Main, and High Profiles.</p><p>ä¸»è¦ç”¨äºä½èƒ½è€—çš„åº”ç”¨ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶æœ€å…¸å‹çš„åº”ç”¨åœºæ™¯æ˜¯è§†é¢‘ä¼šè®®å’Œç§»åŠ¨åº”ç”¨ã€‚å®ƒå¯¹åº”äºBaselineã€Mainå’ŒHighé…ç½®æ–‡ä»¶ä¹‹é—´çš„å…±åŒç‰¹å¾å­é›†ã€‚</p><h2 id="baseline-profile-bp-66">Baseline Profile (BP, 66)</h2><p>Primarily for low-cost applications that require additional data loss robustness, this profile is used in some videoconferencing and mobile applications. This profile includes all features that are supported in the Constrained Baseline Profile, plus three additional features that can be used for loss robustness (or for other purposes such as low-delay multi-point video stream compositing). The importance of this profile has faded somewhat since the definition of the Constrained Baseline Profile in 2009. All Constrained Baseline Profile bitstreams are also considered to be Baseline Profile bitstreams, as these two profiles share the same profile identifier code value.</p><p>ä¸»è¦ç”¨äºéœ€è¦é¢å¤–æ•°æ®æŸå¤±ç¨³å¥æ€§çš„ä½èƒ½è€—åº”ç”¨ï¼Œè¯¥é…ç½®æ–‡ä»¶ç”¨äºä¸€äº›è§†é¢‘ä¼šè®®å’Œç§»åŠ¨åº”ç”¨ã€‚è¯¥é…ç½®æ–‡ä»¶åŒ…æ‹¬Constrained Baseline Profileä¸­æ”¯æŒçš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŠ ä¸Šä¸‰ä¸ªé¢å¤–çš„åŠŸèƒ½ï¼Œå¯ç”¨äºæŸå¤±ç¨³å¥æ€§ï¼ˆæˆ–ç”¨äºå…¶ä»–ç›®çš„ï¼Œå¦‚ä½å»¶è¿Ÿå¤šç‚¹è§†é¢‘æµåˆæˆï¼‰ã€‚è‡ª2009å¹´å®šä¹‰çº¦æŸåŸºçº¿é…ç½®æ–‡ä»¶ä»¥æ¥ï¼Œè¯¥é…ç½®æ–‡ä»¶çš„é‡è¦æ€§å·²æœ‰æ‰€æ·¡åŒ–ã€‚æ‰€æœ‰å—é™åŸºçº¿é…ç½®æ–‡ä»¶çš„æ¯”ç‰¹æµä¹Ÿè¢«è®¤ä¸ºæ˜¯åŸºçº¿é…ç½®æ–‡ä»¶çš„æ¯”ç‰¹æµï¼Œå› ä¸ºè¿™ä¸¤ä¸ªé…ç½®æ–‡ä»¶å…±äº«ç›¸åŒçš„é…ç½®æ–‡ä»¶æ ‡è¯†ç å€¼ã€‚</p><h2 id="extended-profile-xp-88">Extended Profile (XP, 88)</h2><p>Intended as the streaming video profile, this profile has relatively high compression capability and some extra tricks for robustness to data losses and server stream switching.</p><p>ä½œä¸ºæµåª’ä½“è§†é¢‘é…ç½®æ–‡ä»¶ï¼Œè¯¥é…ç½®æ–‡ä»¶å…·æœ‰ç›¸å¯¹è¾ƒé«˜çš„å‹ç¼©èƒ½åŠ›å’Œä¸€äº›é¢å¤–çš„æŠ€å·§ï¼Œä»¥å¢å¼ºå¯¹æ•°æ®æŸå¤±å’ŒæœåŠ¡å™¨æµåˆ‡æ¢çš„ç¨³å®šæ€§ã€‚</p><h2 id="main-profile-mp-77">Main Profile (MP, 77)</h2><p>This profile is used for standard-definition digital TV broadcasts that use the MPEG-4 format as defined in the DVB standard.[<a href="https://en.wikipedia.org/wiki/Advanced_Video_Coding#cite_note-49">49]</a> It is not, however, used for high-definition television broadcasts, as the importance of this profile faded when the High Profile was developed in 2004 for that application.</p><p>è¿™ä¸ªé…ç½®æ–‡ä»¶ç”¨äºä½¿ç”¨DVBæ ‡å‡†ä¸­å®šä¹‰çš„MPEG-4æ ¼å¼çš„æ ‡æ¸…æ•°å­—ç”µè§†å¹¿æ’­ã€‚ç„¶è€Œï¼Œå®ƒä¸ç”¨äºé«˜æ¸…ç”µè§†å¹¿æ’­ï¼Œå› ä¸ºå½“2004å¹´ä¸ºè¯¥åº”ç”¨å¼€å‘å‡ºHigh Profileæ—¶ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶çš„é‡è¦æ€§å°±æ¶ˆå¤±äº†ã€‚</p><h2 id="high-profile-hip-100">High Profile (HiP, 100)</h2><p>The primary profile for broadcast and disc storage applications, particularly for high-definition television applications (for example, this is the profile adopted by the <a href="https://en.wikipedia.org/wiki/Blu-ray_Disc">Blu-ray Disc</a> storage format and the <a href="https://en.wikipedia.org/wiki/Digital_Video_Broadcasting">DVB</a> HDTV broadcast service).</p><p>å¹¿æ’­å’Œå…‰ç›˜å­˜å‚¨åº”ç”¨çš„ä¸»è¦é…ç½®æ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯é«˜æ¸…ç”µè§†åº”ç”¨ï¼ˆä¾‹å¦‚ï¼Œè¿™æ˜¯è“å…‰å…‰ç›˜å­˜å‚¨æ ¼å¼å’ŒDVBé«˜æ¸…å¹¿æ’­æœåŠ¡é‡‡ç”¨çš„é…ç½®æ–‡ä»¶ï¼‰ã€‚</p><h2 id="progressive-high-profile-phip-100-with-constraint-set-4">Progressive High Profile (PHiP, 100 with constraint set 4)</h2><p>Similar to the High profile, but without support of field coding features.</p><p>ç±»ä¼¼äºHigh profileï¼Œä½†ä¸æ”¯æŒç°åœºç¼–ç åŠŸèƒ½ã€‚</p><h2 id="constrained-high-profile-100-with-constraint-set-4-and-5">Constrained High Profile (100 with constraint set 4 and 5)</h2><p>Similar to the Progressive High profile, but without support of B (bi-predictive) slices.</p><p>ç±»ä¼¼äºProgressive High profileï¼Œä½†ä¸æ”¯æŒBï¼ˆåŒé¢„æµ‹ï¼‰åˆ‡ç‰‡ã€‚</p><h2 id="high-10-profile-hi10p-110">High 10 Profile (Hi10P, 110)</h2><p>Going beyond typical mainstream consumer product capabilities, this profile builds on top of the High Profile, adding support for up to 10 bits per sample of decoded picture precision.</p><p>è¶…è¶Šäº†å…¸å‹çš„ä¸»æµæ¶ˆè´¹äº§å“çš„èƒ½åŠ›ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶å»ºç«‹åœ¨é«˜é…ç½®æ–‡ä»¶çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å¯¹æ¯ä¸ªæ ·æœ¬é«˜è¾¾10æ¯”ç‰¹çš„è§£ç å›¾åƒç²¾åº¦çš„æ”¯æŒã€‚</p><h2 id="high-422-profile-hi422p-122">High 4:2:2 Profile (Hi422P, 122)</h2><p>Primarily targeting professional applications that use interlaced video, this profile builds on top of the High 10 Profile, adding support for the 4:2:2 <a href="https://en.wikipedia.org/wiki/Chroma_sampling">chroma sampling</a> format while using up to 10 bits per sample of decoded picture precision.</p><p>ä¸»è¦é’ˆå¯¹ä½¿ç”¨éš”è¡Œæ‰«æè§†é¢‘çš„ä¸“ä¸šåº”ç”¨ï¼Œè¯¥é…ç½®æ–‡ä»¶å»ºç«‹åœ¨High 10 Profileçš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å¯¹4:2:2è‰²åº¦é‡‡æ ·æ ¼å¼çš„æ”¯æŒï¼ŒåŒæ—¶ä½¿ç”¨é«˜è¾¾10æ¯”ç‰¹/é‡‡æ ·çš„è§£ç å›¾åƒç²¾åº¦ã€‚</p><h2 id="high-444-predictive-profile-hi444pp-244">High 4:4:4 Predictive Profile (Hi444PP, 244)</h2><p>This profile builds on top of the High 4:2:2 Profile, supporting up to 4:4:4 chroma sampling, up to 14 bits per sample, and additionally supporting efficient lossless region coding and the coding of each picture as three separate color planes.</p><p>è¿™ä¸ªé…ç½®æ–‡ä»¶å»ºç«‹åœ¨High 4:2:2 Profileçš„åŸºç¡€ä¸Šï¼Œæ”¯æŒé«˜è¾¾4:4:4çš„è‰²åº¦é‡‡æ ·ï¼Œæ¯ä¸ªé‡‡æ ·é«˜è¾¾14æ¯”ç‰¹ï¼Œå¦å¤–è¿˜æ”¯æŒé«˜æ•ˆçš„æ— æŸåŒºåŸŸç¼–ç å’Œæ¯ä¸ªå›¾ç‰‡ä½œä¸ºä¸‰ä¸ªç‹¬ç«‹çš„é¢œè‰²å¹³é¢çš„ç¼–ç ã€‚</p><p>For camcorders, editing, and professional applications, the standard contains four additional <a href="https://en.wikipedia.org/wiki/Intra-frame">Intra-frame</a>-only profiles, which are defined as simple subsets of other corresponding profiles. These are mostly for professional (e.g., camera and editing system) applications:</p><p>å¯¹äºæ‘„åƒæœºã€ç¼–è¾‘å’Œä¸“ä¸šåº”ç”¨ï¼Œè¯¥æ ‡å‡†åŒ…å«å››ä¸ªé¢å¤–çš„å…¨Iå¸§çš„é…ç½®æ–‡ä»¶ï¼Œå®ƒä»¬è¢«å®šä¹‰ä¸ºå…¶ä»–ç›¸åº”é…ç½®æ–‡ä»¶çš„ç®€å•å­é›†ã€‚è¿™äº›ä¸»è¦æ˜¯é’ˆå¯¹ä¸“ä¸šï¼ˆå¦‚æ‘„åƒæœºå’Œç¼–è¾‘ç³»ç»Ÿï¼‰åº”ç”¨ï¼š</p><h3 id="high-10-intra-profile-110-with-constraint-set-3">High 10 Intra Profile (110 with constraint set 3)</h3><p>The High 10 Profile constrained to all-Intra use.</p><p>è¢«çº¦æŸä¸ºå…¨Iå¸§çš„High 10 Profileã€‚</p><h3 id="high-422-intra-profile-122-with-constraint-set-3">High 4:2:2 Intra Profile (122 with constraint set 3)</h3><p>The High 4:2:2 Profile constrained to all-Intra use.</p><p>è¢«çº¦æŸä¸ºå…¨Iå¸§çš„High 4:2:2 Profileã€‚</p><h3 id="high-444-intra-profile-244-with-constraint-set-3">High 4:4:4 Intra Profile (244 with constraint set 3)</h3><p>The High 4:4:4 Profile constrained to all-Intra use.</p><p>è¢«çº¦æŸä¸ºå…¨Iå¸§çš„High 4:4:4 Profileã€‚</p><h2 id="cavlc-444-intra-profile-44">CAVLC 4:4:4 Intra Profile (44)</h2><p>The High 4:4:4 Profile constrained to all-Intra use and to CAVLC entropy coding (i.e., not supporting CABAC).</p><p>High 4:4:4 Profileé™åˆ¶åœ¨æ‰€æœ‰å†…éƒ¨ä½¿ç”¨å’ŒCAVLCç†µç¼–ç ï¼ˆå³ï¼Œä¸æ”¯æŒCABACï¼‰ã€‚</p><p>As a result of the <a href="https://en.wikipedia.org/wiki/Scalable_Video_Coding">Scalable Video Coding</a> (SVC) extension, the standard contains five additional <em>scalable profiles</em>, which are defined as a combination of a H.264/AVC profile for the base layer (identified by the second word in the scalable profile name) and tools that achieve the scalable extension:</p><p>ç”±äºå¯æ‰©å±•è§†é¢‘ç¼–ç ï¼ˆSVCï¼‰çš„æ‰©å±•ï¼Œè¯¥æ ‡å‡†åŒ…å«äº”ä¸ªé¢å¤–çš„å¯æ‰©å±•é…ç½®æ–‡ä»¶ï¼Œå®ƒä»¬è¢«å®šä¹‰ä¸ºåŸºç¡€å±‚çš„H.264/AVCé…ç½®æ–‡ä»¶ï¼ˆç”±å¯æ‰©å±•é…ç½®æ–‡ä»¶åç§°ä¸­çš„ç¬¬äºŒä¸ªå­—æ ‡è¯†ï¼‰å’Œå®ç°å¯æ‰©å±•çš„å·¥å…·çš„ç»„åˆï¼š</p><h3 id="scalable-baseline-profile-83">Scalable Baseline Profile (83)</h3><p>Primarily targeting video conferencing, mobile, and surveillance applications, this profile builds on top of the Constrained Baseline profile to which the base layer (a subset of the bitstream) must conform. For the scalability tools, a subset of the available tools is enabled.</p><p>ä¸»è¦é’ˆå¯¹è§†é¢‘ä¼šè®®ã€ç§»åŠ¨å’Œç›‘æ§åº”ç”¨ï¼Œè¯¥é…ç½®æ–‡ä»¶å»ºç«‹åœ¨Constrained Baseline profileä¹‹ä¸Šï¼ŒåŸºç¡€å±‚ï¼ˆæ¯”ç‰¹æµçš„ä¸€ä¸ªå­é›†ï¼‰å¿…é¡»ç¬¦åˆè¯¥é…ç½®æ–‡ä»¶ã€‚å¯¹äºå¯æ‰©å±•æ€§å·¥å…·ï¼Œå¯ç”¨äº†å¯ç”¨å·¥å…·çš„ä¸€ä¸ªå­é›†ã€‚</p><h3 id="scalable-constrained-baseline-profile-83-with-constraint-set-5">Scalable Constrained Baseline Profile (83 with constraint set 5)</h3><p>A subset of the Scalable Baseline Profile intended primarily for real-time communication applications.</p><p>Scalable Baseline Profileçš„ä¸€ä¸ªå­é›†ï¼Œä¸»è¦ç”¨äºå®æ—¶é€šä¿¡åº”ç”¨ã€‚</p><h3 id="scalable-high-profile-86">Scalable High Profile (86)</h3><p>Primarily targeting broadcast and streaming applications, this profile builds on top of the H.264/AVC High Profile to which the base layer must conform.</p><p>ä¸»è¦é’ˆå¯¹å¹¿æ’­å’Œæµåª’ä½“åº”ç”¨ï¼Œè¯¥é…ç½®æ–‡ä»¶å»ºç«‹åœ¨H.264/AVC High Profileä¹‹ä¸Šï¼ŒåŸºç¡€å±‚å¿…é¡»ç¬¦åˆè¯¥é…ç½®æ–‡ä»¶ã€‚</p><h3 id="scalable-constrained-high-profile-86-with-constraint-set-5">Scalable Constrained High Profile (86 with constraint set 5)</h3><p>A subset of the Scalable High Profile intended primarily for real-time communication applications.</p><p>Scalable High Profileçš„ä¸€ä¸ªå­é›†ï¼Œä¸»è¦ç”¨äºå®æ—¶é€šä¿¡åº”ç”¨ã€‚</p><h3 id="scalable-high-intra-profile-86-with-constraint-set-3">Scalable High Intra Profile (86 with constraint set 3)</h3><p>Primarily targeting production applications, this profile is the Scalable High Profile constrained to all-Intra use.</p><p>ä¸»è¦é’ˆå¯¹ç”Ÿäº§åº”ç”¨ï¼Œè¯¥é…ç½®æ–‡ä»¶æ˜¯Scalable High Profileï¼Œé™åˆ¶ä¸ºå…¨Iå¸§ã€‚</p><p>As a result of the <a href="https://en.wikipedia.org/wiki/Multiview_Video_Coding">Multiview Video Coding</a> (MVC) extension, the standard contains two <em>multiview profiles</em>:</p><p>ç”±äºå¤šè§†è§’è§†é¢‘ç¼–ç ï¼ˆMVCï¼‰çš„æ‰©å±•ï¼Œè¯¥æ ‡å‡†åŒ…å«ä¸¤ä¸ªå¤šè§†è§’é…ç½®æ–‡ä»¶ï¼š</p><h4 id="stereo-high-profile-128">Stereo High Profile (128)</h4><p>This profile targets two-view <a href="https://en.wikipedia.org/wiki/Stereoscopic">stereoscopic</a> 3D video and combines the tools of the High profile with the inter-view prediction capabilities of the MVC extension.</p><p>è¯¥é…ç½®æ–‡ä»¶é’ˆå¯¹åŒè§†è§’ç«‹ä½“3Dè§†é¢‘ï¼Œå¹¶ç»“åˆäº†High profileçš„å·¥å…·å’ŒMVCæ‰©å±•çš„è§†è§’é—´é¢„æµ‹èƒ½åŠ›ã€‚</p><h4 id="multiview-high-profile-118">Multiview High Profile (118)</h4><p>This profile supports two or more views using both inter-picture (temporal) and MVC inter-view prediction, but does not support field pictures and macroblock-adaptive frame-field coding.</p><p>è¯¥é…ç½®æ–‡ä»¶æ”¯æŒä¸¤ä¸ªæˆ–å¤šä¸ªè§†å›¾ï¼Œä½¿ç”¨å¸§é—´ï¼ˆæ—¶é—´ï¼‰å’ŒMVCå¸§é—´é¢„æµ‹ï¼Œä½†ä¸æ”¯æŒåœºå›¾å’Œå®å—è‡ªé€‚åº”å¸§åœºç¼–ç ã€‚</p><p>The Multi-resolution Frame-Compatible (MFC) extension added two more profiles:</p><p>å¤šåˆ†è¾¨ç‡å¸§å…¼å®¹ï¼ˆMFCï¼‰æ‰©å±•åˆå¢åŠ äº†ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼š</p><h5 id="mfc-high-profile-134">MFC High Profile (134)</h5><p>A profile for stereoscopic coding with two-layer resolution enhancement.</p><p>ç”¨äºå…·æœ‰ä¸¤å±‚åˆ†è¾¨ç‡å¢å¼ºçš„ç«‹ä½“ç¼–ç çš„é…ç½®æ–‡ä»¶ã€‚</p><h5 id="mfc-depth-high-profile-135">MFC Depth High Profile (135)</h5><p>The 3D-AVC extension added two more profiles:</p><p>3D-AVCæ‰©å±•åˆå¢åŠ äº†ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼š</p><h6 id="multiview-depth-high-profile-138">Multiview Depth High Profile (138)</h6><p>This profile supports joint coding of depth map and video texture information for improved compression of 3D video content.</p><p>è¯¥é…ç½®æ–‡ä»¶æ”¯æŒæ·±åº¦å›¾å’Œè§†é¢‘çº¹ç†ä¿¡æ¯çš„è”åˆç¼–ç ï¼Œä»¥æ”¹å–„3Dè§†é¢‘å†…å®¹çš„å‹ç¼©ã€‚</p><h6 id="enhanced-multiview-depth-high-profile-139">Enhanced Multiview Depth High Profile (139)</h6><p>An enhanced profile for combined multiview coding with depth information.</p><p>ä¸€ä¸ªå¢å¼ºçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºç»“åˆæ·±åº¦ä¿¡æ¯çš„å¤šè§†å›¾ç¼–ç ã€‚</p><h2 id="ç‰¹å®šé…ç½®æ”¯æŒçš„é…ç½®">ç‰¹å®šé…ç½®æ”¯æŒçš„é…ç½®</h2><p><img src="https://gitee.com/bqlin/image-land/raw/master/1622517263932-03d8907d-7464-4816-9a42-812e6af46ad1.png" /></p><h2 id="è½¯ä»¶ç¼–ç å™¨å®ç°">è½¯ä»¶ç¼–ç å™¨å®ç°</h2><p><img src="https://gitee.com/bqlin/image-land/raw/master/1622518153891-f9be5173-e900-41dd-aba5-d258922ade51.png" /></p><h1 id="avc-level">AVC Level</h1><p>As the term is used in the standard, a "<em>level</em>" is a specified set of constraints that indicate a degree of required decoder performance for a profile. For example, a level of support within a profile specifies the maximum picture resolution, frame rate, and bit rate that a decoder may use. A decoder that conforms to a given level must be able to decode all bitstreams encoded for that level and all lower levels.</p><p>æ­£å¦‚æ ‡å‡†ä¸­æ‰€ä½¿ç”¨çš„æœ¯è¯­ï¼Œlevelæ˜¯ä¸€ç»„ç‰¹å®šçš„çº¦æŸæ¡ä»¶ï¼Œè¡¨æ˜ä¸€ä¸ªé…ç½®æ–‡ä»¶æ‰€è¦æ±‚çš„è§£ç å™¨æ€§èƒ½çš„ç¨‹åº¦ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­çš„æ”¯æŒçº§åˆ«è§„å®šäº†è§£ç å™¨å¯ä»¥ä½¿ç”¨çš„æœ€å¤§å›¾ç‰‡åˆ†è¾¨ç‡ã€å¸§ç‡å’Œæ¯”ç‰¹ç‡ã€‚ç¬¦åˆæŸä¸€ç­‰çº§çš„è§£ç å™¨å¿…é¡»èƒ½å¤Ÿè§£ç ä¸ºè¯¥ç­‰çº§å’Œæ‰€æœ‰æ›´ä½ç­‰çº§ç¼–ç çš„æ‰€æœ‰æ¯”ç‰¹æµã€‚</p><h2 id="å„levelçš„æœ€å¤§å±æ€§å€¼">å„Levelçš„æœ€å¤§å±æ€§å€¼</h2><p><img src="https://gitee.com/bqlin/image-land/raw/master/1622542621052-d4760bc4-0db9-4fef-b049-1bf9c11b1265.png" /></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;avc-profile&quot;&gt;AVC Profile&lt;/h1&gt;
&lt;p&gt;The standard defines several sets of capabilities, which are referred to as &lt;em&gt;profiles&lt;/em&gt;, targeting specific classes of applications. These are declared using a profile code (profile_idc) and sometimes a set of additional constraints applied in the encoder. The profile code and indicated constraints allow a decoder to recognize the requirements for decoding that specific bitstream. (And in many system environments, only one or two profiles are allowed to be used, so decoders in those environments do not need to be concerned with recognizing the less commonly used profiles.) By far the most commonly used profile is the High Profile.&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>H.264/MPEG-4 AVC</title>
    <link href="https://bqlin.github.io/posts/h264/"/>
    <id>https://bqlin.github.io/posts/h264/</id>
    <published>2021-03-15T05:34:44.000Z</published>
    <updated>2021-11-21T08:47:03.000Z</updated>
    
    <content type="html"><![CDATA[<p>H.264ï¼ˆMPEG-4 Part 10ï¼Œ Advanced Video Codingï¼‰ï¼Œç¼©å†™ä¸º MPEG-4 AVCã€‚æ˜¯ä¸€ç§<strong>é¢å‘å—</strong>ï¼Œ<strong>åŸºäºè¿åŠ¨è¡¥å¿</strong>çš„è§†é¢‘ç¼–ç æ ‡å‡†ã€‚</p><p>å‹ç¼©æ¯”ï¼šå¯¹äºYUV420çš„è£¸æµï¼Œå‹ç¼©æ¯”çº¦ä¸º1/100ã€‚</p><p>æ–°ç‰¹æ€§ï¼š</p><ul><li>å¤šå‚è€ƒå¸§çš„è¿åŠ¨è¡¥å¿ã€‚å¯ä»¥å¸¦æ¥ä¸€å®šçš„ç ç‡é™ä½æˆ–è€…è´¨é‡æé«˜ã€‚</li><li>å˜å—å°ºå¯¸è¿åŠ¨è¡¥å¿ã€‚å¯ä½¿ç”¨æœ€å¤§ 16x16 åˆ°æœ€å° 4x4 çš„å—æ¥è¿›è¡Œè¿åŠ¨ä¼°è®¡ä¸è¿åŠ¨è¡¥å¿ï¼Œèƒ½å¤Ÿå¯¹è¿åŠ¨åŒºåŸŸè¿›è¡Œæ›´ç²¾ç¡®çš„åˆ†å‰²ã€‚</li><li>ä½¿ç”¨å…­é˜¶æ•°å­—æ»¤æ³¢å™¨æ¥äº§ç”ŸäºŒåˆ†ä¹‹ä¸€åƒç´ çš„äº®åº¦åˆ†é‡é¢„æµ‹å€¼ï¼Œå¯ä»¥è¾ƒå°‘æ··å ï¼ˆAliasingï¼‰å¹¶å¾—åˆ°æ›´é”åŒ–çš„å›¾åƒã€‚</li><li>çµæ´»çš„éš”è¡Œæ‰«æè§†é¢‘ç¼–ç ã€‚</li><li>1/4 åƒç´ ç²¾åº¦çš„è¿åŠ¨è¡¥å¿ï¼Œèƒ½å¤Ÿæä¾›æ›´é«˜ç²¾åº¦çš„è¿åŠ¨å—é¢„æµ‹ã€‚</li><li>åŠ æƒçš„è¿åŠ¨é¢„æµ‹ã€‚åœ¨ä¸€äº›ç‰¹æ®Šåœºåˆï¼Œå¦‚æ·¡å‡ºã€æ·¡å…¥ç­‰æƒ…å†µæä¾›ç›¸å½“å¤§çš„ç¼–ç å¢ç›Šã€‚</li><li>ç­‰ç­‰ã€‚ã€‚ã€‚https://zh.wikipedia.org/wiki/H.264/MPEG-4_AVC</li></ul><h2 id="ç¼–ç åŸç†">ç¼–ç åŸç†</h2><p>å¯¹ä¸€æ®µå˜åŒ–ä¸å¤§çš„å›¾åƒç”»é¢ï¼Œå…ˆç¼–ç å‡ºä¸€ä¸ªå®Œæ•´çš„å›¾åƒå¸§Aï¼Œéšåçš„Bå¸§å°±ä¸ç¼–ç å…¨éƒ¨å›¾åƒï¼Œåªå†™å…¥ä¸Aå¸§çš„å·®åˆ«ï¼Œç„¶åç»§ç»­ä»¥Bçš„æ–¹å¼ç¼–ç Cå¸§ï¼Œè¿™æ ·å¾ªç¯ä¸‹å»å¾—åˆ°ä¸€æ®µåºåˆ—ã€‚å½“æŸå¹…å›¾åƒä¸ä¹‹å‰çš„å›¾åƒå˜åŒ–å¾ˆå¤§æ—¶ï¼Œæ— æ³•å‚è€ƒå‰é¢çš„å¸§æ¥ç”Ÿæˆï¼Œå°±ç»“æŸä¸Šä¸€ä¸ªåºåˆ—ï¼Œå¼€å§‹ä¸‹ä¸€æ®µåºåˆ—çš„ç”Ÿæˆã€‚</p><p>H.264 åè®®é‡Œå®šä¹‰äº†ä¸‰ç§å¸§ï¼š</p><ul><li><p>å®Œæ•´ç¼–ç çš„ I å¸§ï¼›</p></li><li><p>å‚è€ƒä¹‹å‰çš„ I å¸§åªç”Ÿæˆçš„åŒ…å«å·®å¼‚éƒ¨åˆ†ç¼–ç çš„ P å¸§ï¼›</p></li><li><p>å‚è€ƒå‰åçš„å¸§ç¼–ç çš„ B å¸§ï¼›</p></li></ul><p>H.264 é‡‡ç”¨çš„æ ¸å¿ƒç®—æ³•æ˜¯å¸§å†…å‹ç¼©å’Œå¸§é—´å‹ç¼©ï¼Œå¸§å†…å‹ç¼©æ˜¯ç”Ÿæˆ I å¸§çš„ç®—æ³•ï¼Œå¸§é—´å‹ç¼©æ˜¯ç”Ÿæˆ B å¸§å’Œ P å¸§çš„ç®—æ³•ã€‚</p><h2 id="gopåºåˆ—">GOPåºåˆ—</h2><p>æå‡ºçš„æ„ä¹‰ï¼šæŒ‰ç…§ç›¸å…³æ€§è¿›è¡Œåˆ†ç»„ä¾¿äºè¿›è¡Œå¸§é—´å‹ç¼©ã€‚è¿™æ ·åˆ†ç»„çš„ä¸€ç»„å›¾åƒå·®åˆ«è¾ƒå°‘ï¼Œå»é™¤çš„å†—ä½™/é‡å¤æ•°æ®å°±å¤šï¼Œå‹ç¼©æ¯”å°±é«˜ã€‚</p><p>H.264 ä¸­ä»¥å›¾åƒåºåˆ—ä¸ºå•ä½è¿›è¡Œç»„ç»‡ï¼Œä¸€ä¸ªåºåˆ—æ˜¯ä¸€æ®µå›¾åƒç¼–ç åçš„æ•°æ®æµï¼Œä» I å¸§å¼€å§‹ï¼Œåˆ°ä¸‹ä¸€ä¸ª I å¸§ç»“æŸã€‚</p><p>åºåˆ—çš„ç¬¬ä¸€ä¸ªå›¾åƒå« IDR å›¾åƒï¼ˆç«‹å³åˆ·æ–°å›¾åƒï¼‰ï¼ŒIDR å›¾åƒéƒ½æ˜¯ I å¸§å›¾åƒã€‚å½“é‡åˆ° IDR å›¾åƒæ—¶ï¼Œç«‹å³å°†å‚è€ƒå¸§é˜Ÿåˆ—æ¸…ç©ºï¼Œå°†å·²è§£ç çš„æ•°æ®å…¨éƒ¨è¾“å‡ºæˆ–æŠ›å¼ƒï¼Œé‡æ–°æŸ¥æ‰¾å‚æ•°é›†ï¼Œå¼€å§‹ä¸€ä¸ªæ–°çš„åºåˆ—ã€‚è¿™æ ·åœ¨å‰ä¸€ä¸ªåºåˆ—å‡ºç°é‡å¤§é”™è¯¯æ—¶ï¼Œå¯ä»¥è·å¾—é‡æ–°åŒæ­¥çš„æœºä¼šã€‚</p><p>ä¸€ä¸ªåºåˆ—å°±æ˜¯ä¸€æ®µå†…å®¹å·®å¼‚ä¸å¤ªå¤§çš„å›¾åƒç¼–ç åç”Ÿæˆçš„ä¸€ä¸²æ•°æ®æµã€‚å½“è¿åŠ¨å˜åŒ–è¾ƒå°‘æ—¶ï¼Œä¸€ä¸ªåºåˆ—å¯ä»¥å¾ˆé•¿ï¼Œæ‰€ä»¥å°±å¯ä»¥ç¼–ä¸€ä¸ª I å¸§ï¼Œè®©åä¸€ç›´ P å¸§ã€B å¸§äº†ã€‚å½“è¿åŠ¨å˜åŒ–è¾ƒå¤šæ—¶ï¼Œä¸€ä¸ªåºåˆ—å°±å¯èƒ½æ¯”è¾ƒçŸ­äº†ã€‚</p><p>GOPï¼ˆGroup Of Picturesï¼Œå›¾åƒç»„ï¼‰æ˜¯ä¸€ç»„è¿ç»­çš„å›¾åƒï¼Œç”±ä¸€ä¸ªIå¸§å’Œå¤šä¸ªB/På¸§ç»„æˆï¼Œæ˜¯ç¼–è§£ç å™¨å­˜å–çš„åŸºæœ¬å•ä½ã€‚GOP ä¸­å¸§ä¸å¸§ä¹‹é—´çš„å·®åˆ«è¾ƒå°ã€‚</p><p>GOPç»“æ„å¸¸ç”¨çš„ä¸¤ä¸ªå‚æ•°Må’ŒNï¼ŒMæŒ‡å®šGOPä¸­é¦–ä¸ªPå¸§å’ŒIå¸§ä¹‹é—´çš„è·ç¦»ï¼ŒNæŒ‡å®šä¸€ä¸ªGOPçš„å¤§å°ã€‚ä¾‹å¦‚M=1ï¼ŒN=15ï¼ŒGOPç»“æ„ä¸ºï¼š</p><p><span class="math display">\[IPBBPBBPBBPBBPB\]</span></p><p>GOPåˆ†ä¸¤ç§ï¼šé—­åˆå¼GOPå’Œå¼€æ”¾å¼GOPï¼š</p><ul><li>é—­åˆå¼ GOPï¼šé—­åˆå¼GOPåªéœ€è¦å‚è€ƒæœ¬GOPå†…çš„å›¾åƒå³å¯ï¼Œä¸éœ€å‚è€ƒå‰åGOPçš„æ•°æ®ã€‚è¿™ç§æ¨¡å¼å†³å®šäº†ï¼Œé—­åˆå¼GOPçš„æ˜¾ç¤ºé¡ºåºæ€»æ˜¯ä»¥Iå¸§å¼€å§‹ä»¥På¸§ç»“æŸã€‚</li><li>å¼€å‘å¼ GOPï¼šå¼€æ”¾å¼GOPä¸­çš„Bå¸§è§£ç æ—¶å¯èƒ½è¦ç”¨åˆ°å…¶å‰ä¸€ä¸ªGOPæˆ–åä¸€ä¸ªGOPçš„æŸäº›å¸§ã€‚ç æµé‡Œé¢åŒ…å«Bå¸§çš„æ—¶å€™æ‰ä¼šå‡ºç°å¼€æ”¾å¼GOPã€‚</li></ul><p>å¦‚å›¾ç‰¹å¾ï¼Œå¼€å‘å¼GOPæœ«å°¾æ˜¯Bå¸§ï¼Œé—­åˆå¼GOPæœ«å°¾æ˜¯På¸§ã€‚ä½†ä¸ç®¡å¦‚æœè¦ç§°ä¸ºGOPï¼Œé¦–å¸§å¿…é¡»æ˜¯Iå¸§ã€‚</p><p>å¼€æ”¾å¼GOPå’Œé—­åˆå¼GOPä¸­Iå¸§ã€På¸§ã€Bå¸§çš„ä¾èµ–å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772065108-8aeea8d4-e483-4f35-90c9-27b9fc8816eb.jpeg" /></p><p>GOP æŒ‡ä¸¤ä¸ª I å¸§ä¹‹é—´çš„è·ç¦»ã€‚å‚è€ƒå‘¨æœŸï¼ˆReferenceï¼‰æŒ‡ä¸¤ä¸ª P å¸§ä¹‹é—´ä¸­è·ç¦»ã€‚Iã€Bã€P å¸§æ‰€å å­—èŠ‚æ•°å¤§å°ï¼šI &gt; P &gt; Bã€‚</p><p>æ‰€ä»¥åœ¨ç ç‡ä¸å˜çš„å‰æä¸‹ï¼ŒGOP å€¼è¶Šå¤§ï¼ŒPã€B å¸§çš„æ•°é‡ä¼šè¶Šå¤šï¼Œå¹³å‡æ¯ä¸ª Iã€Pã€B å¸§æ‰€å çš„å­—èŠ‚æ•°å°±è¶Šå¤šï¼Œä¹Ÿå°±å®¹æ˜“è·å¾—è¾ƒå¥½çš„å›¾åƒè´¨é‡ã€‚é€šè¿‡æé«˜ GOP å€¼æ¥æé«˜å›¾åƒè´¨é‡æ˜¯æœ‰é™åº¦çš„ï¼Œåœ¨é‡åˆ°åœºæ™¯åˆ‡æ¢çš„æƒ…å†µä¸‹ï¼Œç¼–ç å™¨ä¼šè‡ªåŠ¨å¼ºåˆ¶æ’å…¥ä¸€ä¸ª I å¸§ï¼Œæ­¤æ—¶å®é™…çš„ GOP å€¼è¢«ç¼©çŸ­ã€‚å¦ä¸€æ–¹é¢ï¼Œåœ¨ä¸€ä¸ª GOP ä¸­ï¼ŒP å¸§ç”± I å¸§é¢„æµ‹å¾—åˆ°çš„ï¼Œå½“ I å¸§çš„å›¾åƒè´¨é‡æ¯”è¾ƒå·®æ—¶ï¼Œä¼šå½±å“ä¸€ä¸ª GOP ä¸­åç»­ Pã€B å¸§çš„å›¾åƒè´¨é‡ã€‚ç›´åˆ°ä¸‹ä¸€ä¸ª GOP å¼€å§‹æ‰æœ‰å¯èƒ½å¾—åˆ°æ¢å¤ï¼Œæ‰€ä»¥ GOP å€¼ä¹Ÿä¸å®œè®¾ç½®è¿‡å¤§ã€‚</p><p>åŒæ—¶ï¼Œç”±äº Pã€B å¸§çš„å¤æ‚åº¦å¤§äº I å¸§ï¼Œæ‰€ä»¥è¿‡å¤šçš„ Pã€B å¸§ä¼šå½±å“ç¼–ç æ•ˆç‡ï¼Œä½¿å¾—ç¼–ç æ•ˆç‡é™ä½ã€‚å¦å¤–ï¼Œè¿‡é•¿çš„ GOP è¿˜ä¼šå½±å“ seek æ“ä½œçš„å“åº”é€Ÿåº¦ï¼Œå› ä¸º Pã€B å¸§æ˜¯ç”±å‰é¢çš„ I æˆ– P å¸§é¢„æµ‹å¾—åˆ°çš„ï¼Œæ‰€ä»¥ seek æ“ä½œéœ€è¦ç›´æ¥å®šä½ã€è§£ç æŸä¸€ä¸ª P æˆ– B å¸§æ—¶ï¼Œéœ€è¦å…ˆè§£ç å¾—åˆ°æœ¬ GOP å†…çš„ I å¸§åŠä¹‹å‰çš„ N ä¸ªé¢„æµ‹å¸§æ‰å¯ä»¥ï¼ŒGOP å€¼è¶Šé•¿ï¼Œéœ€è¦è§£ç çš„é¢„æµ‹å¸§å°±è¶Šå¤šï¼Œseek å“åº”çš„æ—¶é—´ä¹Ÿå°±è¶Šé•¿ã€‚</p><h2 id="å¸§">å¸§</h2><h3 id="i-å¸§">I å¸§</h3><p>Intra-coded pictureï¼Œå¸§å†…ç¼–ç å›¾åƒå¸§ï¼Œå¸¸ç§°ä¸ºå…³é”®å¸§ã€‚</p><p>ä¸å‚è€ƒå…¶ä»–å›¾åƒå¸§ï¼Œåªåˆ©ç”¨æœ¬å¸§ä¿¡æ¯è¿›è¡Œç¼–ç ã€‚åŒ…å«ä¸€å¹…å®Œæ•´çš„å›¾åƒä¿¡æ¯ï¼Œå±äºå¸§å†…ç¼–ç å›¾åƒï¼Œä¸å«è¿åŠ¨çŸ¢é‡ï¼Œåœ¨è§£ç æ—¶ä¸éœ€è¦å‚è€ƒå…¶ä»–å¸§å›¾åƒã€‚å› æ­¤åœ¨Iå¸§å›¾åƒå¤„å¯ä»¥åˆ‡æ¢é¢‘é“ï¼Œè€Œä¸ä¼šå¯¼è‡´å›¾åƒä¸¢å¤±æˆ–æ— æ³•è§£ç ã€‚Iå¸§å›¾åƒç”¨äºé˜»æ­¢è¯¯å·®çš„ç´¯ç§¯å’Œæ‰©æ•£ã€‚åœ¨é—­åˆå¼GOPä¸­ï¼Œæ¯ä¸ªGOPçš„ç¬¬ä¸€ä¸ªå¸§ä¸€å®šæ˜¯Iå¸§ï¼ˆIDRå¸§ï¼‰ï¼Œä¸”å½“å‰GOPçš„æ•°æ®ä¸ä¼šå‚è€ƒå‰åGOPçš„æ•°æ®ã€‚</p><h4 id="idr-å¸§">IDR å¸§</h4><p>Instantaneous Decoding Refresh pictureï¼Œå³æ—¶è§£ç åˆ·æ–°å¸§ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„Iå¸§ã€‚å½“è§£ç å™¨è§£ç åˆ°IDRå¸§æ—¶ï¼Œä¼šå°†DPBï¼ˆDecoded Picture Bufferï¼ŒæŒ‡å‰åå‘å‚è€ƒå¸§åˆ—è¡¨ï¼‰æ¸…ç©ºï¼Œå°†å·²è§£ç çš„æ•°æ®å…¨éƒ¨è¾“å‡ºæˆ–æŠ›å¼ƒï¼Œç„¶åå¼€å§‹ä¸€æ¬¡å…¨æ–°çš„è§£ç åºåˆ—ã€‚IDRå¸§ä¹‹åçš„å›¾åƒä¸ä¼šå‚è€ƒIDRå¸§<strong>ä¹‹å‰</strong>çš„å›¾åƒã€‚</p><p>åœ¨ç¼–ç è§£ç ä¸­ä¸ºäº†æ–¹ä¾¿ï¼Œå°†GOPä¸­é¦–ä¸ªIå¸§è¦å’Œå…¶ä»–Iå¸§åŒºåˆ«å¼€ï¼ŒæŠŠç¬¬ä¸€ä¸ªIå¸§å«IDRï¼Œè¿™æ ·æ–¹ä¾¿æ§åˆ¶ç¼–ç å’Œè§£ç æµç¨‹ï¼Œæ‰€ä»¥IDRå¸§ä¸€å®šæ˜¯Iå¸§ï¼Œä½†Iå¸§ä¸ä¸€å®šæ˜¯IDRå¸§ï¼›IDRå¸§çš„ä½œç”¨æ˜¯ç«‹åˆ»åˆ·æ–°ï¼Œ<strong>ä½¿é”™è¯¯ä¸è‡´ä¼ æ’­</strong>ï¼Œä»IDRå¸§å¼€å§‹ç®—æ–°çš„åºåˆ—å¼€å§‹ç¼–ç ã€‚Iå¸§æœ‰è¢«è·¨å¸§å‚è€ƒçš„å¯èƒ½ï¼ŒIDRä¸ä¼šã€‚</p><p>Iå¸§ä¸ç”¨å‚è€ƒä»»ä½•å¸§ï¼Œä½†æ˜¯ä¹‹åçš„På¸§å’ŒBå¸§æ˜¯æœ‰å¯èƒ½å‚è€ƒè¿™ä¸ªIå¸§ä¹‹å‰çš„å¸§çš„ã€‚IDRå°±ä¸å…è®¸è¿™æ ·ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IDR1 P4 B2 B3 P7 B5 B6 I10 B8 B9 P13 B11 B12 P16 B14 B15</span><br><span class="line">è¿™é‡Œçš„B8å¯ä»¥è·¨è¿‡I10å»å‚è€ƒP7</span><br><span class="line">IDR1 P4 B2 B3 P7 B5 B6 IDR8 P11 B9 B10 P14 B11 B12</span><br><span class="line">è¿™é‡Œçš„B9å°±åªèƒ½å‚ç…§IDR8å’ŒP11ï¼Œä¸å¯ä»¥å‚è€ƒIDR8å‰é¢çš„å¸§</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><ul><li>è§£ç å™¨ç«‹å³åˆ·æ–°ï¼Œæ¸…ç©ºå‚è€ƒå¸§ç¼“å†²åŒºï¼ˆDPBï¼‰ï¼Œé˜²æ­¢é”™è¯¯ä¼ æ’­ã€‚</li><li>GOPç¬¬ä¸€å¸§æ˜¯IDRå¸§ï¼Œæ˜¯ç‰¹æ®Šçš„Iå¸§ã€‚</li><li>GOPåªæœ‰ä¸€ä¸ªIDRå¸§ï¼Œä½†å¯èƒ½è¿˜æœ‰å¤šä¸ªIå¸§ã€‚</li><li>IDRå¸§ä¹‹åçš„å›¾åƒä¸ä¼šå‚è€ƒå…¶ä¹‹å‰çš„å¸§ï¼Œä½†æ™®é€šIå¸§å°±æ²¡æœ‰è¿™ä¸ªé™åˆ¶ã€‚</li></ul><h3 id="p-å¸§">P å¸§</h3><p>Predictive-coded pictureï¼Œé¢„æµ‹ç¼–ç å›¾åƒå¸§ï¼Œå¸§é—´ç¼–ç å¸§ã€‚</p><p>åˆ©ç”¨ä¹‹å‰çš„ I å¸§æˆ– P å¸§ï¼Œé‡‡ç”¨è¿åŠ¨é¢„æµ‹çš„æ–¹å¼è¿›è¡Œé¢„æµ‹ç¼–ç ã€‚<strong>ä¸ä¼šå‚è€ƒBå¸§ã€‚</strong></p><ul><li>P å¸§å±äºå‰å‘é¢„æµ‹çš„å¸§é—´ç¼–ç ï¼Œåªå‚è€ƒæœ€é è¿‘å®ƒçš„ I å¸§æˆ– P å¸§ã€‚å®ƒåªå  I å¸§å¤§å°çš„ä¸€åŠã€‚</li><li>P å¸§å¯ä»¥ä½œä¸ºåé¢ P å¸§çš„å‚è€ƒå¸§ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå…¶å‰åçš„ B å¸§çš„å‚è€ƒå¸§ã€‚</li></ul><h3 id="b-å¸§">B å¸§</h3><p>Bidirectionally predicted pictureï¼ŒåŒå‘é¢„æµ‹ç¼–ç å›¾åƒå¸§ï¼Œå¸§é—´ç¼–ç å¸§ã€‚</p><p>æä¾›æœ€é«˜çš„å‹ç¼©æ¯”ï¼Œå¥¹æ—¢éœ€è¦ä¹‹å‰çš„å›¾åƒå¸§ï¼ˆI å¸§æˆ– P å¸§ï¼‰ï¼Œä¹Ÿéœ€è¦åæ¥çš„å›¾åƒå¸§ï¼ˆP å¸§ï¼‰ï¼Œé‡‡ç”¨è¿åŠ¨é¢„æµ‹çš„æ–¹å¼è¿›è¡Œå¸§é—´åŒå‘é¢„æµ‹ç¼–ç ã€‚<strong>ä¸ä¼šå‚è€ƒé™„è¿‘çš„ B å¸§ã€‚</strong></p><p>å  I å¸§çš„ 1/4 å¤§å°ï¼Œå‹ç¼©æ¯”æœ€å¤§ï¼Œä½†è§£ç çš„æ—¶å€™å ç”¨èµ„æºå’Œè€—æ—¶ä¹Ÿæ˜¯æœ€å¤§çš„ã€‚åœ¨å®æ—¶é€šä¿¡ä¸­è¾ƒå°‘ä½¿ç”¨ B å¸§ï¼Œç‚¹æ’­ã€å­˜å‚¨çš„è§†é¢‘åˆ™å¯ä»¥è¾ƒå¤šåœ°ä½¿ç”¨ B å¸§ã€‚</p><ul><li>B å¸§å€¼åæ˜ ä¸¤å‚è€ƒå¸§é—´è¿åŠ¨ä¸»ä½“çš„å˜åŒ–æƒ…å†µï¼Œé¢„æµ‹æ¯”è¾ƒå‡†ç¡®ã€‚</li><li>B å¸§ä¼šæ¯”é™„è¿‘çš„ P å¸§åè§£ç ï¼Œå³å…ˆè§£ç é™„è¿‘çš„å¸§æ‰èƒ½è§£ç å½“å‰Bå¸§ã€‚</li></ul><h3 id="å¸§ä¸åˆ†ç»„çš„å…³ç³»">å¸§ä¸åˆ†ç»„çš„å…³ç³»</h3><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772065852-0b6f6459-35d3-4cd8-9b81-597632f1a3d8.png" /></p><p>ç®­å¤´æŒ‡å‘çš„å¸§å‚è€ƒç®­å¤´èµ·ç‚¹çš„å¸§ã€‚è§£ç  B å¸§éœ€è¦è§£ç å‚è€ƒçš„å‰åå¸§ã€‚è§£ç çš„é¡ºåºä¸æ’­æ”¾çš„é¡ºåºæ˜¯ä¸ä¸€è‡´çš„ï¼Œå› æ­¤å°±æœ‰äº†ä¸‹é¢çš„è¯é¢˜ã€‚</p><h3 id="spspps">SPSã€PPS</h3><p>SPSã€PPS ä¸ç§°ä¸ºå¸§ï¼Œåªæ˜¯åœ¨ IDR å¸§å‰çš„å‚æ•°æ•°æ®ï¼Œè¿™ä¸¤ä¸ªä¿¡æ¯ä¸€èˆ¬åŒæ—¶å‡ºç°ã€‚</p><ul><li>SPSï¼ŒSequence Parameter Setï¼Œåºåˆ—å‚æ•°é›†<ul><li>ä½œç”¨äºä¸€ä¸²è¿ç»­çš„è§†é¢‘å›¾åƒï¼Œå¯¹å¸§ç»„ GOP çš„å‚æ•°è®¾ç½®ã€‚</li><li>å¦‚ï¼šseq_parameter_set_idã€å¸§æ•°ã€POCï¼ˆpicture order countï¼‰çš„çº¦æŸã€å‚è€ƒå¸§æ•°é‡ã€è§£ç å›¾åƒå°ºå¯¸ã€åœºç¼–ç æ¨¡å¼é€‰æ‹©æ ‡å¿—ç­‰ã€‚</li></ul></li><li>PPSï¼ŒPicture Parameter Setï¼Œå›¾åƒå‚æ•°é›†<ul><li>ä½œç”¨äºè§†é¢‘åºåˆ—ä¸­çš„å›¾åƒï¼ŒGOP ä¸­æ¯ä¸€å¹…å›¾åƒç­‰å‚æ•°è®¾ç½®ã€‚</li><li>å¦‚ï¼špic_parameter_set_idã€ç†µç¼–ç æ¨¡å¼é€‰æ‹©æ ‡å¿—ã€ç‰‡ç»„æ•°ç›®ã€åˆå§‹é‡åŒ–å‚æ•°ã€å»æ–¹å—æ»¤æ³¢ç³»æ•°è°ƒæ•´æ ‡å¿—ç­‰ã€‚</li></ul></li></ul><h4 id="sps">SPS</h4><ul><li>H264 Profileï¼šå¯¹è§†é¢‘å‹ç¼©ç‰¹æ€§çš„æè¿°ï¼Œprofile è¶Šé«˜ï¼Œè¯´æ˜é‡‡ç”¨äº†è¶Šé«˜çº§çš„å‹ç¼©ç‰¹æ€§ï¼Œå¯¹åº”çš„å‹ç¼©æ¯”ä¹Ÿè¶Šé«˜ã€‚</li><li>H264 Levelï¼šå¯¹è§†é¢‘è§„æ ¼çš„æè¿°ï¼Œlevel è¶Šé«˜ï¼Œè§†é¢‘çš„ç ç‡ã€åˆ†è¾¨ç‡ã€å¸§ç‡è¶Šé«˜ã€‚</li></ul><p>H264 Profileï¼š</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772065292-fa686316-81fa-4e5d-bd6b-4f6ade8241e3.png" /></p><p>å¦‚ä¸Šå›¾ï¼Œä»Constrained Baseline Profileä¸ºæ ¸å¿ƒå‘å±•å‡ºä¸¤ä¸ªæ–¹å‘çš„åˆ†æ”¯ï¼Œä¸€ä¸ªæ˜¯Main Profileï¼›å¦ä¸€ä¸ªæ˜¯Baseline Profileå’ŒExtended Profileã€‚Mainæ¯”Constrained Baselineå‹ç¼©æ¯”é«˜ï¼ˆæœ‰Bå¸§å’Œæ›´é«˜å‹ç¼©æ¯”çš„CABACæ— æŸå‹ç¼©ç®—æ³•ï¼‰ã€‚æˆ‘ä»¬ç”¨å¾—æ›´å¤šçš„æ˜¯Main Profileæ–¹å‘çš„åˆ†æ”¯ï¼Œä¸‹é¢æ˜¯è¯¥åˆ†æ”¯çš„å‘å±•çš„å…·ä½“Profileã€‚</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772065501-b33be986-f0aa-4e30-9b01-dce4e0faf2a9.png" /></p><p>Highåº”è¯¥æ˜¯å‹ç¼©æ¯”æœ€é«˜çš„profileï¼Œåé¢ä¸æ–­å¢åŠ çš„æ˜¯è´¨é‡æ–¹é¢çš„ç‰¹æ€§ã€‚</p><p>H264 Levelï¼š</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772065708-481862b1-d535-4e12-b98c-6897a4e51d5f.png" /></p><p>å…¶ä»–é‡è¦å‚æ•°ï¼š</p><p><strong>åˆ†è¾¨ç‡</strong>ç›¸å…³å‚æ•°ï¼š</p><ul><li>pic_width_in_mbs_minus1ï¼šå›¾åƒå®½åº¦åŒ…å«çš„å®å—ä¸ªæ•°-1ï¼ˆè¿™é‡Œå¥½è·å–å…·ä½“å®½åº¦è¿˜è¦è·å–å®å—å®½åº¦ï¼Œé»˜è®¤æ˜¯16ï¼‰</li><li>pic_height_in_mbs_minus1ï¼šå›¾åƒé«˜åº¦åŒ…å«çš„å®å—ä¸ªæ•°-1</li><li>frame_mbs_only_flagï¼šå¸§ç¼–ç è¿˜æ˜¯åœºç¼–ç ï¼ˆåœºæ˜¯éš”è¡Œæ‰«æï¼Œäº§ç”Ÿä¸¤å¼ å›¾ï¼Œè¯¥å‚æ•°ä¼šå½±å“åˆ†è¾¨ç‡çš„è®¡ç®—ï¼‰</li><li>frame_cropping_flagï¼šå›¾åƒæ˜¯å¦éœ€è¦è£å‰ªï¼ˆæœ‰è£å‰ªçš„ï¼Œè¿˜è¦å‡å»è£å‰ªçš„å°ºå¯¸ï¼‰<ul><li>frame_crop_left_offsetï¼šå‡å»å·¦ä¾§çš„åç§»é‡</li><li>frame_crop_right_offsetï¼šå‡å»å³ä¾§çš„åç§»é‡</li><li>frame_crop_top_offsetï¼šå‡å»é¡¶éƒ¨çš„åç§»é‡</li><li>frame_crop_bottom_offsetï¼šå‡å»åº•éƒ¨çš„åç§»é‡</li></ul></li></ul><p>é€šè¿‡ pic_width_in_mbs_minus1ã€pic_height_in_mbs_minus1ã€å®å—å®½é«˜ï¼ˆé»˜è®¤ 16x16ï¼‰ä»¥åŠè€ƒè™‘ frame_mbs_only_flagã€frame_cropping_flagï¼Œå¯ä»¥å¾—å‡ºåˆ†è¾¨ç‡ã€‚</p><p><strong>GOPå¸§ä¿¡æ¯</strong>å‚æ•°ï¼š</p><ul><li>log2_max_frame_num_minus4ï¼šå¯å¾—å‡ºGOPçš„æœ€å¤§å¸§æ•°ï¼š2çš„è¯¥å€¼æ¬¡æ–¹+4ã€‚<ul><li>å¯é€šè¿‡è¯¥å€¼ä¸ slice header çš„ frame_numï¼Œå¾—å‡ºè¢«è§£ç çš„å¸§çš„åºå·ã€‚</li></ul></li><li>max_num_ref_framesï¼šå‚è€ƒå¸§çš„æ•°é‡ã€‚<ul><li>ç”¨äºè®¾ç½®è§£ç æ—¶å€™çš„ç¼“å†²é˜Ÿåˆ—å¤§å°ã€‚</li></ul></li><li>pic_order_cnt_typeï¼šæ˜¾ç¤ºå¸§çš„åºå·ç±»å‹ã€‚<ul><li>é€šè¿‡è®¡ç®—å¯å¾—å‡ºæ˜¾ç¤ºçš„é¡ºåºã€‚</li></ul></li></ul><p>å¸§ç‡è®¡ç®—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">framerate = (float)(sps-&gt;vui.vui_time_scale) /</span><br><span class="line">            (float)(sps-&gt;vui.vui_num_units_in_tick) /</span><br><span class="line">            2.0</span><br></pre></td></tr></table></figure><h4 id="pps">PPS</h4><ul><li>entropy_coding_mode_flagï¼šç†µç¼–ç ç±»å‹ï¼Œ1è¡¨ç¤ºä½¿ç”¨ CABACï¼Œ0åˆ™ä¸ºCAVLCã€‚</li><li>num_slice_groups_minus1ï¼šåˆ†ç‰‡æ•°é‡ã€‚</li><li>weighted_pred_flagï¼šåœ¨ P/SP Slice ä¸­æ˜¯å¦å¼€å¯æƒé‡é¢„æµ‹ã€‚</li><li>weighted_bipred_idcï¼šåœ¨ B Slice ä¸­åŠ æƒé¢„æµ‹çš„æ–¹æ³•ç±»å‹ã€‚</li><li>pic_init_qp_minus26/pic_init_qs_minus26ï¼šåˆå§‹åŒ–é‡åŒ–å‚æ•°ï¼Œå®é™…å‚æ•°åœ¨ Slice Header ä¸­ã€‚</li><li>chroma_qp_index_offsetï¼šç”¨äºè®¡ç®—è‰²åº¦çš„é‡åŒ–å‚æ•°ã€‚</li><li>deblocking_filter_control_present_flagï¼šè¡¨ç¤º Slice Header ä¸­æ˜¯å¦å­˜åœ¨å»å—æ»¤æ³¢å™¨æ§åˆ¶çš„ä¿¡æ¯ã€‚</li><li>constrained_intra_pred_flagï¼šè‹¥ä¸º1ï¼Œè¡¨ç¤º I å®å—åœ¨è¿›è¡Œå¸§å†…é¢„æµ‹æ—¶åªèƒ½ä½¿ç”¨æ¥è‡ª I å’Œ SI ç±»å‹çš„å®å—çš„ä¿¡æ¯ã€‚</li><li>redundant_pic_cnt_present_flagï¼šç”¨äºè¡¨ç¤º Slice Header ä¸­æ˜¯å¦å­˜åœ¨ redundant_pic_cnt è¯­æ³•å…ƒç´ ã€‚</li></ul><h3 id="slice-header">Slice Header</h3><ul><li>å¸§ç±»å‹</li><li>GOPä¸­è§£ç å¸§åºå·ï¼ˆå½“æœ‰ B å¸§çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯é¡ºåºè§£ç çš„ï¼‰</li><li>é¢„æµ‹æƒé‡</li><li>æ»¤æ³¢</li></ul><h2 id="dtspts">DTSã€PTS</h2><ul><li>DTSï¼ˆDecode Time Stampï¼Œè§£ç æ—¶é—´æˆ³ï¼‰ï¼šè¡¨ç¤ºpacketçš„è§£ç æ—¶é—´ï¼Œä¸»è¦ç”¨äºè§†é¢‘çš„ç¼–ç ï¼Œåœ¨ç¼–ç é˜¶æ®µä½¿ç”¨ã€‚ä¸»è¦æ ‡è¯†å†…å­˜çš„åŒ…ä»€ä¹ˆæ—¶å€™é€å…¥è§£ç å™¨ä¸­è§£ç ã€‚è§£ç é˜¶æ®µä½¿ç”¨ã€‚</li><li>PTSï¼ˆPresentation Time Stampï¼Œæ˜¾ç¤ºæ—¶é—´æˆ³ï¼‰ï¼šè¡¨ç¤ºpacketè§£ç åæ•°æ®çš„æ˜¾ç¤ºæ—¶é—´ï¼Œä¸»è¦ç”¨äºè§†é¢‘çš„åŒæ­¥å’Œè¾“å‡ºã€‚æ˜¾ç¤ºé˜¶æ®µä½¿ç”¨ã€‚</li></ul><p>éŸ³é¢‘ä¸­DTSå’ŒPTSæ˜¯ç›¸åŒçš„ã€‚è§†é¢‘ä¸­ç”±äºBå¸§éœ€è¦åŒå‘é¢„æµ‹ï¼ŒBå¸§ä¾èµ–äºå…¶å‰å’Œå…¶åçš„å¸§ï¼Œå› æ­¤å«Bå¸§çš„è§†é¢‘è§£ç é¡ºåºä¸æ˜¾ç¤ºé¡ºåºä¸åŒï¼Œå³DTSä¸PTSä¸åŒã€‚å½“ç„¶ï¼Œä¸å«Bå¸§çš„è§†é¢‘ï¼Œå…¶DTSå’ŒPTSæ˜¯ç›¸åŒçš„ã€‚ä¸‹å›¾ä»¥ä¸€ä¸ªå¼€æ”¾å¼GOPç¤ºæ„å›¾ä¸ºä¾‹ï¼Œè¯´æ˜è§†é¢‘æµçš„è§£ç é¡ºåºå’Œæ˜¾ç¤ºé¡ºåºã€‚</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772065948-58a4d622-11bb-4fa8-8421-258c29beb872.jpeg" /></p><ul><li><code>é‡‡é›†é¡ºåº</code>ï¼šæŒ‡å›¾åƒä¼ æ„Ÿå™¨é‡‡é›†åŸå§‹ä¿¡å·å¾—åˆ°å›¾åƒå¸§çš„é¡ºåºã€‚</li><li><code>ç¼–ç é¡ºåº</code>ï¼šæŒ‡ç¼–ç å™¨ç¼–ç åå›¾åƒå¸§çš„é¡ºåºã€‚å­˜å‚¨åˆ°ç£ç›˜çš„æœ¬åœ°è§†é¢‘æ–‡ä»¶ä¸­å›¾åƒå¸§çš„é¡ºåºä¸ç¼–ç é¡ºåºç›¸åŒã€‚</li><li><code>ä¼ è¾“é¡ºåº</code>ï¼šæŒ‡ç¼–ç åçš„æµåœ¨ç½‘ç»œä¸­ä¼ è¾“è¿‡ç¨‹ä¸­å›¾åƒå¸§çš„é¡ºåºã€‚</li><li><code>è§£ç é¡ºåº</code>ï¼šæŒ‡è§£ç å™¨è§£ç å›¾åƒå¸§çš„é¡ºåºã€‚</li><li><code>æ˜¾ç¤ºé¡ºåº</code>ï¼šæŒ‡å›¾åƒå¸§åœ¨æ˜¾ç¤ºå™¨ä¸Šæ˜¾ç¤ºçš„é¡ºåºã€‚</li></ul><p><strong><em>é‡‡é›†é¡ºåºä¸æ˜¾ç¤ºé¡ºåºç›¸åŒã€‚ç¼–ç é¡ºåºã€ä¼ è¾“é¡ºåºå’Œè§£ç é¡ºåºç›¸åŒã€‚</em></strong></p><p>å›¾ä¸­â€œB[1]â€å¸§ä¾èµ–äºâ€œI[0]â€å¸§å’Œâ€œP[3]â€å¸§ï¼Œå› æ­¤â€œP[3]â€å¸§å¿…é¡»æ¯”â€œB[1]â€å¸§å…ˆè§£ç ã€‚è¿™å°±å¯¼è‡´äº†è§£ç é¡ºåºå’Œæ˜¾ç¤ºé¡ºåºçš„ä¸ä¸€è‡´ï¼Œåæ˜¾ç¤ºçš„å¸§éœ€è¦å…ˆè§£ç ã€‚</p><p>å¯è§ï¼Œåœ¨æ²¡æœ‰Bå¸§çš„æ—¶å€™ï¼ŒDTSå’ŒPTSæ˜¯æ˜¯ä¸€è‡´çš„ã€‚</p><h2 id="ç æµ">ç æµ</h2><p>H.264åŸå§‹ç æµï¼ˆè£¸æµï¼‰æ˜¯ç”±ä¸€ä¸ªæ¥ä¸€ä¸ªNALUç»„æˆã€‚</p><p>æŒ‰å…¶åŠŸèƒ½å¯èƒ½å°†å…¶åˆ†å±‚ï¼š</p><ul><li>VCLå±‚ï¼ŒVideo Coding Layerï¼Œè§†é¢‘æ•°æ®ç¼–ç å±‚ã€‚<ul><li>ä¿å­˜è§†é¢‘å‹ç¼©åçš„æ•°æ®ã€‚</li></ul></li><li>NALå±‚ï¼ŒNetwork Abstraction Layerï¼Œè§†é¢‘æ•°æ®ç½‘ç»œæŠ½è±¡å±‚ï¼Œæœ€å¤–å±‚ã€‚<ul><li>å¯¹VCLè§†é¢‘ç¼–ç å±‚æ•°æ®æ‹†æˆå¤šä¸ªåŒ…ä¼ è¾“ï¼Œå¹¶æä¾›headerç­‰ä¿¡æ¯ã€‚</li><li>ä¸ºè§£å†³ç½‘ç»œä¼ è¾“ä¸­ä¸¢åŒ…ã€ä¹±åºã€é‡ä¼ é—®é¢˜æä¾›æ ‡è®°ã€‚</li></ul></li></ul><p><img src="https://gitee.com/bqlin/image-land/raw/master/wmxrDf.jpg" /></p><p><img src="https://gitee.com/bqlin/image-land/raw/master/471463-20171214170746310-1770557571.png" /></p><p>ç›¸å…³æœ¯è¯­ï¼š</p><ul><li>SODBï¼ŒString Of Data Bitsï¼šä½ä¸²ã€‚<ul><li>åŸå§‹æ•°æ®æ¯”ç‰¹æµ/äºŒè¿›åˆ¶æ•°æ®ä¸²ï¼Œä»¥ä½ç¼–ç åœ¨ä¸€èµ·ï¼Œé•¿åº¦ä¸ä¸€å®šæ˜¯8çš„å€æ•°ï¼Œæ•…éœ€è¦è¡¥é½ã€‚</li><li>ç”± VCL å±‚äº§ç”Ÿã€‚</li></ul></li><li>RBSPï¼ŒRaw Byte Sequence Payloadï¼šå­—èŠ‚åºåˆ—è´Ÿè½½æ•°æ®ã€‚<ul><li>SODB + trailing bitsï¼Œå¦‚æœSODBæœ€åä¸€ä¸ªå­—èŠ‚ä¸å¯¹é½ï¼Œåˆ™è¡¥1å’Œå¤šä¸ª0ã€‚</li></ul></li><li>EBSPï¼ŒEncapsulated Byte Sequence Payloadï¼šæ‰©å±•å­—èŠ‚åºåˆ—è´Ÿè½½æ•°æ®ã€‚<ul><li>åœ¨æ¯ä¸€å¸§å¼€å¤´æ·»åŠ èµ·å§‹ä½ã€‚</li></ul></li><li>NALUï¼ŒNAL å•å…ƒï¼šå¤šä¸ªNALå•å…ƒç»„æˆH264ç æµã€‚</li></ul><p>å…³ç³»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RBSP = SODB + RBSP Stop bit + 0 bits</span><br><span class="line">EBSP = RBSP part1 + 0x03 + RBSP part2 + 0x03 + ... + RBSP partN</span><br><span class="line">NALU = NALU Header(1 byte) + EBSP</span><br></pre></td></tr></table></figure><h3 id="nal-unit">NAL Unit</h3><p>ç æµçš„æ€»ä½“ç»“æ„ï¼š</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772066961-b44bfe42-118c-4865-8053-7ad490bde618.png" /></p><ul><li>Annexb æ ¼å¼ç”¨äºæ–‡ä»¶å­˜å‚¨ã€æœ¬åœ°æ’­æ”¾ï¼Œæ˜¯åœ¨NALUå‰é¢å¢åŠ äº†StartCodeã€‚</li><li>RTP æ ¼å¼ç”¨äºç½‘ç»œä¼ æ’­ï¼Œç›´æ¥å°±æ˜¯ä¼ è¾“NALUã€‚</li></ul><p>NALUæœ‰ä¸¤ç§æ ¼å¼ï¼š</p><ul><li>Annex B/Elementary Streamï¼šä»¥<code>0x00_00_01</code>æˆ–<code>0x00_00_00_01</code>å¼€å¤´ã€‚</li><li>AVCC/MPEG-4ï¼šä»¥æ‰€åœ¨NALUé•¿åº¦å¼€å¤´ã€‚</li></ul><p>å®å—å­˜å‚¨æ•°æ®ï¼š</p><ul><li>mb_typeï¼šå®å—ç±»å‹</li><li>mb_predï¼šé¢„æµ‹ç±»å‹å€¼</li><li>coded residualï¼Œæ®‹å·®å€¼</li></ul><p>å®å—ä¸å¸§çš„å…³ç³»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1ç‰‡ = Nå®å—</span><br><span class="line">1å¸§ = Nç‰‡</span><br><span class="line">å¸¸å¸¸ä¸€ä¸ªNALUåªåŒ…å«1ä¸ªç‰‡</span><br></pre></td></tr></table></figure><p>ç‰‡çš„å‡ºç°ï¼šè®¾ç½®ç‰‡çš„ç›®çš„æ˜¯ä¸ºäº†é™åˆ¶è¯¯ç çš„æ‰©æ•£å’Œä¼ è¾“ï¼Œè®©ç¼–ç ç‰‡ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œå¦‚æŸç‰‡çš„é¢„æµ‹ä¸èƒ½ä»¥å…¶ä»–ç‰‡ä¸­çš„å®å—ä¸ºå‚è€ƒå›¾åƒï¼Œä»¥é˜²æ­¢æŸç‰‡ä¸­çš„é¢„æµ‹é”™è¯¯ä¼ æ’­åˆ°å…¶ä»–ç‰‡ä¸­ã€‚</p><p>å±‚çº§åˆ’åˆ†ï¼š</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772066806-5f003f52-a8ae-452d-bc4a-ecce266ff637.png" /></p><p>VCLç»“æ„å…³ç³»ï¼š</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772066728-9a1d776d-e9b2-4d8e-a190-e883685645bf.png" /></p><p>å…¶ä¸­ï¼ŒSPSã€PPSä¸æ˜¯VCLäº§ç”Ÿçš„ï¼Œä½†ä»¥NALUä¼ è¾“ï¼Œå¯¹äºæ­£ç¡®è§£ç éå¸¸é‡è¦ã€‚å¯ä»¥é€šè¿‡ç‹¬ç«‹çš„æœåŠ¡æ¥å‘é€å‚æ•°é›†ã€‚</p><h2 id="åˆ†æå·¥å…·">åˆ†æå·¥å…·</h2><ul><li>Elecard Stream Eye<ul><li>https://www.elecard.com/products/video-analysis</li></ul></li><li>CodecVisa</li><li>é›·ç¥å¼€å‘çš„å·¥å…·<ul><li>https://jaist.dl.sourceforge/project/h254streamanalysis/binary/SpecialVH264.exe</li><li>https://sourceforge.net/projects/videoeye/files/</li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;H.264ï¼ˆMPEG-4 Part 10ï¼Œ Advanced Video Codingï¼‰ï¼Œç¼©å†™ä¸º MPEG-4 AVCã€‚æ˜¯ä¸€ç§&lt;strong&gt;é¢å‘å—&lt;/strong&gt;ï¼Œ&lt;strong&gt;åŸºäºè¿åŠ¨è¡¥å¿&lt;/strong&gt;çš„è§†é¢‘ç¼–ç æ ‡å‡†ã€‚&lt;/p&gt;
&lt;p&gt;å‹ç¼©æ¯”ï¼šå¯¹äºYUV420çš„è£¸æµï¼Œå‹ç¼©æ¯”çº¦ä¸º1/100ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>è§†é¢‘å‹ç¼©æŠ€æœ¯</title>
    <link href="https://bqlin.github.io/posts/video_compression_technology/"/>
    <id>https://bqlin.github.io/posts/video_compression_technology/</id>
    <published>2021-03-15T04:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸éŸ³é¢‘å‹ç¼©ç¼–ç ä¸åŒï¼Œè§†é¢‘çš„å‹ç¼©ç¼–ç åŸºæœ¬éƒ½æ˜¯æœ‰æŸå‹ç¼©ã€‚H.264æ˜¯å¤šç§è§†é¢‘å‹ç¼©æŠ€æœ¯çš„é›†å¤§æˆè€…ï¼Œå…¶ä½¿ç”¨æŠ€æœ¯çš„è¿˜è¦è¿½æº¯åˆ°H.261ã€‚</p><h3 id="å®å—">å®å—</h3><p>å®å—æ˜¯è§†é¢‘å‹ç¼©æ“ä½œçš„åŸºæœ¬å•å…ƒã€‚æ— è®ºæ˜¯å¸§å†…å‹ç¼©è¿˜æ˜¯å¸§é—´å‹ç¼©ï¼Œå®ƒä»¬éƒ½æ˜¯ä»¥å®å—ä¸ºå•ä½ã€‚</p><p>å®å—æ˜¯æŒ‰åƒç´ è¿›è¡Œåˆ’åˆ†çš„ã€‚å®å—åˆ’åˆ†å¾—å°ï¼Œå‹ç¼©çš„æ§åˆ¶åŠ›å°±å¤§ä¸€äº›ï¼Œå¤„ç†é€Ÿåº¦ä¹Ÿä¼šé™ä¸‹æ¥ã€‚</p><p>å®å—è¿˜å¯ä»¥åˆ’åˆ†ä¸ºå­å—ã€‚</p><p>å®å—åˆ’åˆ†å°ºå¯¸ï¼š</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772066040-cda01df7-9404-4968-a184-51c3b57d18a4.png" /></p><h3 id="å¸§å†…é¢„æµ‹">å¸§å†…é¢„æµ‹</h3><p>ç†è®ºåŸºç¡€ï¼š</p><ul><li>ç›¸é‚»åƒç´ å·®åˆ«ä¸å¤§ï¼Œå¯ä»¥è¿›è¡Œ<strong>å®å—</strong>é¢„æµ‹ã€‚å®å—ä¸å®å—ä¹‹é—´è¿›è¡Œæ¯”è¾ƒï¼Œè€Œä¸æ˜¯åƒç´ å¯¹æ¯”ã€‚</li><li>äººå¯¹äº®åº¦çš„æ•æ„Ÿåº¦è¶…è¿‡è‰²åº¦ã€‚YUV å¾ˆå®¹æ˜“å°†äº®åº¦ä¸è‰²åº¦åˆ†ç¦»ã€‚ç»„åˆä¸Šé¢çš„ç‚¹ï¼Œå¯ä»¥å°†äº®åº¦ä¸è‰²åº¦åŒºåˆ†å¤„ç†ã€‚ä»¥ä¸‹çš„å¸§å†…é¢„æµ‹ï¼Œäº®åº¦ä¸è‰²åº¦æ˜¯åŒºåˆ†å¤„ç†çš„ã€‚</li></ul><p>H.264å°†å•ä¸ªå®å—å†…çš„åƒç´ é¢œè‰²å˜åŒ–è§„å¾‹è§„èŒƒæˆäº†å…¬å¼ï¼Œç¼–ç æ—¶åªè¦å†™æ­¤å¤„åº”ç”¨å“ªä¸ªå…¬å¼å°±è¡Œäº†ã€‚</p><h5 id="é€‰æ‹©å¸§å†…é¢„æµ‹æ¨¡å¼">1. é€‰æ‹©å¸§å†…é¢„æµ‹æ¨¡å¼</h5><p>å¸§å†…é¢„æµ‹æ¨¡å¼æœ‰9ç§ï¼Œé€šè¿‡ä¸ç›®æ ‡å®å—å¯¹æ¯”é€‰æ‹©æœ€é€‚åˆçš„æ¨¡å¼ï¼Œå°†é¢„æµ‹çš„å®å—å˜æˆé¢„æµ‹æ¨¡å¼ç¼–å·ã€‚</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772066130-90d3dc38-05c1-4288-affd-bc149ce06f3b.png" /></p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772066253-12d77bff-0f01-4394-b508-18ef64f42acc.png" /></p><h5 id="å åŠ æ®‹å·®">2. å åŠ æ®‹å·®</h5><p>å¸§å†…é¢„æµ‹æ®‹å·®å€¼ï¼Œé€šè¿‡é¢„æµ‹å‡ºæ¥çš„ä¸åŸå§‹å›¾åƒè¿›è¡Œå¯¹æ¯”å¾—å‡ºã€‚</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772066362-562246ee-ae43-4ba4-bfde-8e1093499588.png" /></p><p>é¢„æµ‹æ¨¡å¼ä¿¡æ¯+æ®‹å·®å€¼ã€‚é¢„æµ‹å¾—å‡ºçš„å›¾åƒé¢œè‰²æ˜¯åŸºäºå®å—çš„ï¼Œå¹³æ»‘åº¦æœ‰é™ï¼Œå åŠ æ®‹å·®å€¼æ¥ç£¨å¹³è¿™äº›è‰²å·®ã€‚</p><h3 id="å¸§é—´é¢„æµ‹">å¸§é—´é¢„æµ‹</h3><p>å¯¹æ¯å¸§å›¾åƒå‹ç¼©ï¼Œå‹ç¼©æ¯”å§‹ç»ˆæœ‰é™ï¼Œå› æ­¤æå‡ºäº†å¯¹ä¸€ç»„å›¾ç‰‡åšæ¶ˆé™¤å†—ä½™ã€‚</p><figure><img src="https://blog.xinoassassin.me/images/mc-vector.jpg" alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><ol type="1"><li>æŠŠå¼ºç›¸å…³çš„å¸§è¿›è¡Œåˆ†ç»„ï¼Œå½¢æˆGOPï¼ˆ<strong>G</strong>roup <strong>o</strong>f <strong>P</strong>icturesï¼‰ã€‚</li><li>è¿›è¡Œè¿åŠ¨ä¼°è®¡ï¼ˆå®å—æŸ¥æ‰¾/åŒ¹é… -&gt; è¿åŠ¨çŸ¢é‡ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªè¿‡ç¨‹ï¼Œé€šè¿‡å®å—åŒ¹é…ï¼Œå¾—å‡ºè¿åŠ¨çŸ¢é‡ï¼Œæœ€ç»ˆå­˜å‚¨çš„æ˜¯åˆå§‹çŠ¶æ€å’Œè¿åŠ¨çŸ¢é‡ã€‚</li><li>è¿›è¡Œè¿åŠ¨è¡¥å¿ï¼ˆè§£ç ï¼‰ï¼Œè¡¥å¿çš„æ˜¯æ®‹å·®å€¼ã€‚</li></ol><p>å¼•å…¥åŸºäºè¿åŠ¨è¡¥å¿å¸§é—´é¢„æµ‹ç®—æ³•åï¼Œè§†é¢‘ä¸­çš„å¸§å°±åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>å…³é”®å¸§ï¼šå®Œæ•´çš„é™æ€å›¾åƒï¼Œå¯ä»¥è¢«ç›´æ¥è§£ç ã€‚</li><li>é¢„æµ‹å¸§/å‚è€ƒå¸§ï¼šé€šè¿‡è¿åŠ¨è¡¥å¿ç®—æ³•åœ¨å…³é”®å¸§ä¹‹ä¸Šè®¡ç®—å¾—åˆ°ã€‚æ ¹æ®å¸§çš„ä¾èµ–æ–¹å‘è¿˜å¯ä»¥åˆ†ä¸ºï¼š<ul><li>é¢„æµ‹ç¼–ç å›¾åƒå¸§ï¼ŒPå¸§ï¼ˆPredictive-coded pictureï¼‰ï¼šåªèƒ½å‚è€ƒå‰é¢çš„å…³é”®å¸§å’ŒPå¸§ã€‚</li><li>åŒå‘é¢„æµ‹ç¼–ç å›¾åƒå¸§ï¼ŒBå¸§ï¼ˆBidirectionally predicted pictureï¼‰ï¼šèƒ½å‚è€ƒå‰åçš„å…³é”®å¸§å’ŒPå¸§ï¼Œä½†ä¸èƒ½å‚è€ƒå‰åçš„Bå¸§ã€‚</li></ul></li></ul><p>è¿›å…¥å¸§é—´é¢„æµ‹ç¼–ç çš„å¸¸è§é—®é¢˜ï¼š</p><ul><li>èŠ±å±ã€‚GOPåˆ†ç»„æœ‰å¸§ï¼ˆPã€Bï¼‰ä¸¢å¤±ï¼Œä¼šé€ æˆè§£ç ç«¯ç«¯å›¾åƒå‘ç”Ÿé”™è¯¯ï¼Œå‡ºç°é©¬èµ›å…‹ã€‚</li><li>å¡é¡¿ã€‚å…¶å®æ˜¯ä¸ºäº†é¿å…èŠ±å±é—®é¢˜çš„å‘ç”Ÿè€Œå¯¼è‡´çš„æ–°çš„é—®é¢˜ï¼Œå½“å‘ç°æœ‰å¸§ä¸¢å¤±çš„æ—¶å€™ï¼Œå°±ä¸¢å¼ƒGOPå†…æ‰€æœ‰çš„å¸§ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªIDRå¸§é‡æ–°åˆ·æ–°å›¾åƒã€‚Iå¸§æ˜¯æŒ‰ç…§å‘¨æœŸæ¥çš„ï¼Œéœ€è¦ä¸€ä¸ªè¾ƒé•¿çš„æ—¶é—´å‘¨æœŸæ‰åˆ°è¾¾ä¸‹ä¸€ä¸ªIå¸§ã€‚å¦‚æœåœ¨ä¸‹ä¸€ä¸ªIå¸§ä¹‹å‰ä¸æ˜¾ç¤ºåé¢çš„å›¾åƒï¼Œè§†é¢‘ä¹…é™æ­¢ä¸åŠ¨äº†ï¼Œå‡ºç°å¡é¡¿ã€‚</li></ul><h3 id="dct">DCT</h3><p>DCTï¼ŒDiscrete Cosine Transformï¼Œç¦»æ•£ä½™å¼¦å˜æ¢ã€‚å¸§å†…ç¼–ç ç®—æ³•ã€‚åœ¨å›¾åƒå‹ç¼©ç®—æ³•ä¸Šï¼ŒH.261ä½¿ç”¨äº†DCTç®—æ³•ï¼ŒæŠŠå›¾åƒä»ç©ºé—´åŸŸè½¬æ¢åˆ°é¢‘ç‡åŸŸï¼Œç„¶ååšé‡åŒ–ï¼Œå‡å°‘äººçœ¼ä¸æ•æ„Ÿçš„é«˜é¢‘ä¿¡æ¯ï¼Œä¿ç•™ç»å¤§éƒ¨åˆ†ä½é¢‘ä¿¡æ¯ï¼Œä»è€Œå‡å°‘å›¾åƒä½“ç§¯ã€‚ç„¶åå†ç”¨é«˜æ•ˆçš„æ•°æ®ç¼–ç æ–¹å¼æŠŠå¤„ç†åçš„æ•°æ®è¿›ä¸€æ­¥å‹ç¼©ã€‚</p><p>DCTå°†å›¾åƒåˆ†æˆç”±ä¸åŒé¢‘ç‡ç»„æˆçš„å°å—ï¼Œç„¶åè¿›è¡Œé‡åŒ–ã€‚åœ¨é‡åŒ–è¿‡ç¨‹ä¸­ï¼Œèˆå¼ƒé«˜é¢‘åˆ†é‡ï¼Œå‰©ä¸‹çš„ä½é¢‘åˆ†é‡è¢«ä¿å­˜ä¸‹æ¥ç”¨äºåé¢çš„å›¾åƒé‡å»ºã€‚</p><p>DCTå…·å¤‡<strong>å»ç›¸å…³æ€§</strong>å’Œ<strong>èƒ½é‡é›†ä¸­</strong>çš„ç‰¹æ€§ã€‚DCTæœ¬èº«å¹¶ä¸ä¼šå‹ç¼©æ•°æ®ï¼Œå®ƒä¸ºéšåçš„é‡åŒ–ä¹‹ç±»çš„æ“ä½œï¼Œæä¾›äº†ä¸€ä¸ªè‰¯å¥½çš„åŸºç¡€ã€‚</p><p>DCTåœ¨åæ¥çš„JPEGç¼–ç ä¸­èµ·ä¸»è¦ä½œç”¨ã€‚</p><h3 id="cabac">CABAC</h3><p>åœ¨ç¼–ç çš„æœ€åé˜¶æ®µï¼Œå³å¯ä»¥å»é™¤çš„å†—ä½™ä¿¡æ¯éƒ½å»é™¤åï¼Œå¯¹æ•°æ®è¿›è¡Œæ— æŸå‹ç¼©ã€‚H.264é™¤äº†æ”¯æŒåœ¨H.261ä¸­å°±å­˜åœ¨çš„VLCç¼–ç å¤–ï¼Œæ–°å¢åŠ äº†ä¸¤ç§æ— æŸæ•°æ®å‹ç¼©ç¼–ç ï¼Œä¸€ç§æ˜¯VLCçš„å‡çº§ç‰ˆâ€”â€”CAVLCï¼Œå¦ä¸€ç§æ˜¯å¤æ‚ç¨‹åº¦æ›´é«˜çš„CABACï¼ˆå‰æ–‡å‚è€ƒä¹‹é€‚åº”æ€§äºŒå…ƒç®—æœ¯ç¼–ç ï¼Œ<strong>C</strong>ontext-based <strong>A</strong>daptive <strong>B</strong>inary <strong>A</strong>rithmetic <strong>C</strong>odingï¼‰ã€‚</p><figure><img src="https://blog.xinoassassin.me/images/CABAC.jpg" alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><p>CABACä¹Ÿæ˜¯ä¸€ç§ç†µç¼–ç ï¼Œä¸»è¦åŸç†ä¹Ÿæ˜¯ç”¨é•¿ç¼–ç æ›¿æ¢æ‰å‡ºç°é¢‘ç‡å°‘çš„æ•°æ®ï¼Œè€Œç”¨çŸ­ç¼–ç æ›¿æ¢å‡ºç°é¢‘ç‡é«˜çš„æ•°æ®ï¼Œä½†å®ƒå¼•å…¥äº†æ›´å¤šç»Ÿè®¡å­¦ä¼˜åŒ–ï¼Œå¹¶ä¸”å…·æœ‰åŠ¨æ€é€‚åº”èƒ½åŠ›ã€‚è™½ç„¶åœ¨è§£ç æ—¶éœ€è¦æ›´å¤šè®¡ç®—ï¼Œä½†å®ƒèƒ½å¤Ÿæ¯”CAVLCèŠ‚çœæ›´å¤šçš„æ•°æ®é‡ï¼Œé€šå¸¸èƒ½æœ‰10%ã€‚</p><h3 id="ç¼–ç æ ‘å•å…ƒ">ç¼–ç æ ‘å•å…ƒ</h3><p>HEVCå¼•å…¥äº†æ–°çš„ç¼–ç æ ‘å•å…ƒï¼ˆ<strong>C</strong>oding <strong>T</strong>ree <strong>U</strong>nitsï¼‰æ¦‚å¿µï¼Œå–ä»£æ‰äº†å­˜åœ¨äºè§†é¢‘ç¼–ç ä¸­å¤šå¹´çš„å®å—æ¦‚å¿µï¼Œå®ƒçš„å•å—é¢ç§¯å¤§äº†è®¸å¤šï¼Œè¾¾åˆ°äº†64x64ï¼Œä½†ä»ç„¶ä¿ç•™äº†å¯å˜å¤§å°å’Œå¯åˆ†å‰²ç‰¹æ€§ï¼Œæœ€å°å•å…ƒä¸º16x16ã€‚å•ä¸ªç¼–ç æ ‘ä¸­åŒ…å«äº†å°çš„ç¼–ç å•å…ƒï¼Œå®ƒä»¬å¯ä»¥ç”±å››åˆ†æ ‘å½¢å¼å‘ˆç°ï¼Œå¹¶å¾ˆå¿«åœ°å¯ä»¥ç¡®å®šä¸‹å…¶ä¸­çš„å•å…ƒæ˜¯å¦å¯è¢«å†åˆ†å‰²ï¼Œå†…éƒ¨ç¼–ç å•å…ƒæœ€å°å¯ä»¥è¢«åˆ†å‰²ä¸º8x8å¤§å°ï¼Œç²¾ç»†ç¨‹åº¦ä»ç„¶æ˜¯éå¸¸é«˜çš„ã€‚</p><p>å•ä¸ªç¼–ç å•å…ƒä¹Ÿå¯ä»¥ç»§ç»­è¢«åˆ‡å‰²ã€åˆ†ç±»ï¼Œå¯ä»¥æˆä¸ºé¢„æµ‹å•å…ƒï¼ˆPrediction Unitsï¼‰ï¼Œåè€…å¯ä»¥æŒ‡ç¤ºè¯¥å•å…ƒçš„é¢„æµ‹å½¢å¼ï¼Œæ˜¯ç”»é¢å†…é¢„æµ‹è¿˜æ˜¯ç”»é¢é—´é¢„æµ‹æˆ–è€…ç”šè‡³æ˜¯æ ¹æœ¬æ²¡æœ‰å˜åŒ–ã€å¯ä»¥è¢«è·³è¿‡çš„å•å…ƒï¼›ä¹Ÿå¯ä»¥æˆä¸ºè½¬æ¢å•å…ƒï¼ˆTransform Unitsï¼‰ï¼Œå®ƒå¯ä»¥åšDCTè½¬æ¢æˆ–æ˜¯é‡åŒ–ã€‚</p><p>ç¼–ç æ ‘å•å…ƒçš„å¼•å…¥è®©HEVCæ—¢å¯ä»¥ç”¨å¤§é¢ç§¯å•å…ƒæ¥æé«˜ç¼–ç æ•ˆç‡ï¼Œä¹Ÿå¯åœ¨éœ€è¦çš„æ—¶å€™ç»†åŒ–ï¼Œä¿ç•™æ›´ç²¾ç»†çš„ç»†èŠ‚ã€‚æ‰€è°“è¯¥ç²—ç•¥çš„åœ°æ–¹å°±ç²—ç•¥ï¼Œè¯¥ç²¾ç»†çš„åœ°æ–¹å°±ç²¾ç»†ï¼ŒHEVCåœ¨å®ƒçš„å¸®åŠ©ä¸‹è®©ç æµçš„æ•ˆç‡æ›´é«˜ã€‚</p><h2 id="è¶‹åŠ¿">è¶‹åŠ¿</h2><p>H.261å¥ å®šå®å—å’Œå¸§é—´é¢„æµ‹çš„åŸºç¡€ï¼ŒH.264/AVCæ˜¯å¤šç§å‹ç¼©æŠ€æœ¯çš„é›†å¤§æˆè€…ã€‚HEVCä¸»è¦æ˜¯é’ˆå¯¹é«˜æ¸…åŠè¶…æ¸…åˆ†è¾¨ç‡è§†é¢‘è€Œå¼€å‘çš„ï¼Œç›¸æ¯”èµ·å‰ä»£AVCï¼Œå®ƒåœ¨ä½ç ç‡æ—¶æ‹¥æœ‰æ›´å¥½çš„ç”»è´¨è¡¨ç°ï¼ŒåŒæ—¶åœ¨é¢å¯¹é«˜åˆ†è¾¨ç‡è§†é¢‘æ—¶ï¼Œä¹Ÿèƒ½æä¾›è¶…é«˜çš„å‹ç¼©æ¯”ï¼Œå¸®åŠ©4Kè§†é¢‘å¡å…¥è“å…‰å…‰ç›˜ã€‚</p><h2 id="h.264ç¼–ç æµç¨‹">H.264ç¼–ç æµç¨‹</h2><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772066655-5b9dfeca-bd92-4022-9ef7-fef968120e26.png" /></p><figure><img src="https://pic3.zhimg.com/80/v2-6ab263372cec8b4a544d858d3a7fdc32_1440w.jpg" alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><figure><img src="https://pic3.zhimg.com/80/v2-048c202f6368d7f2cc5d3d2a59f7fd2a_1440w.jpg" alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><ol type="1"><li>å¸§ç±»å‹åˆ†æ -&gt; Iå¸§ã€På¸§ã€Bå¸§ã€GOP</li><li>åˆ’åˆ†å®å—åŠå…¶å­å—</li><li>Iå¸§è¿›è¡Œå¸§å†…é¢„æµ‹ï¼Œæœ€ç»ˆå­˜å‚¨é¢„æµ‹æ¨¡å¼ã€æ®‹å·®ï¼ˆå»é™¤ç©ºé—´å†—ä½™ï¼‰<ol type="1"><li>é€‰æ‹©å¸§å†…é¢„æµ‹æ¨¡å¼</li><li>å åŠ æ®‹å·®</li></ol></li><li>P/Bå¸§è¿›è¡Œå¸§é—´é¢„æµ‹ï¼Œæœ€ç»ˆå­˜å‚¨å¸§é—´é¢„æµ‹æ¨¡å¼æ ‡å¿—ä½ã€è¿åŠ¨çŸ¢é‡ã€æ®‹å·®ï¼ˆå»é™¤æ—¶é—´å†—ä½™ï¼‰<ol type="1"><li>è¿åŠ¨ä¼°è®¡ï¼šå®å—æŸ¥æ‰¾ã€åŒ¹é… -&gt; è¿åŠ¨çŸ¢é‡</li><li>è¿åŠ¨è¡¥å¿ï¼šå åŠ æ®‹å·®</li></ol></li><li>DCTå˜æ¢ã€é‡åŒ–ï¼Œä¸¢å¼ƒé«˜é¢‘ä¿¡æ¯ï¼ˆå»é™¤ç©ºé—´å†—ä½™ï¼‰</li><li>æ»¤æ³¢ï¼Œé€šè¿‡æ»¤æ³¢ä¿®æ­£å¹¶æå‡ä¸»è§‚è´¨é‡</li><li>ç†µç¼–ç ï¼ˆå¦‚ï¼šCAVLCã€CABACï¼‰å‹ç¼©æœ€ç»ˆæ•°æ®ï¼ˆå»é™¤ç¼–ç å†—ä½™ï¼‰</li></ol><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="b8de6d0c93705a606b91010096b22446">è§†é¢‘ç¼–è§£ç åŸºç¡€æ¦‚å¿µ - å¶ä½™ - åšå®¢å›­</a></li><li><a href="https://blog.xinoassassin.me/2020/03/Video-Codecs/">æ•°å­—è§†é¢‘ç¼–ç çš„å‘å±•å†ç¨‹</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzU1NTEzOTM5Mw==&amp;mid=2247512538&amp;idx=1&amp;sn=57f46386002cf5554681f8ef9f61a3e0&amp;chksm=fbda19f4ccad90e219bf224db522e9999086dff886bae09562e1aeba4450d4ba0247a73c3138&amp;scene=21#wechat_redirect">è§†é¢‘å‹ç¼©æ ‡å‡†ç®€å²ï¼šä»1929åˆ°2020</a></li><li><a href="http://zhaoxuhui.top/blog/2018/05/26/DCTforImageDenoising.html">DCTå˜æ¢ä¸å›¾åƒå‹ç¼©ã€å»ç‡¥</a></li><li><a href="https://en.wikipedia.org/wiki/Advanced_Video_Coding">Advanced Video Coding - Wikipedia</a></li><li><a href="https://zhuanlan.zhihu.com/p/158392753">H.264ç¼–è§£ç åŸç†æµ…æ - çŸ¥ä¹</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸éŸ³é¢‘å‹ç¼©ç¼–ç ä¸åŒï¼Œè§†é¢‘çš„å‹ç¼©ç¼–ç åŸºæœ¬éƒ½æ˜¯æœ‰æŸå‹ç¼©ã€‚H.264æ˜¯å¤šç§è§†é¢‘å‹ç¼©æŠ€æœ¯çš„é›†å¤§æˆè€…ï¼Œå…¶ä½¿ç”¨æŠ€æœ¯çš„è¿˜è¦è¿½æº¯åˆ°H.261ã€‚&lt;/p&gt;
&lt;h3 id=&quot;å®å—&quot;&gt;å®å—&lt;/h3&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>YUV</title>
    <link href="https://bqlin.github.io/posts/yuv/"/>
    <id>https://bqlin.github.io/posts/yuv/</id>
    <published>2021-03-15T03:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="è‰²å½©ç©ºé—´">è‰²å½©ç©ºé—´</h2><p>åƒç´ æ ¼å¼æè¿°äº†åƒç´ æ•°æ®å­˜å‚¨æ‰€ç”¨çš„æ ¼å¼ï¼Œå®šä¹‰äº†åƒç´ åœ¨å†…å­˜ä¸­çš„ç¼–ç æ–¹å¼ã€‚RGBå’ŒYUVä¸ºä¸¤ç§ç»å¸¸ä½¿ç”¨çš„åƒç´ æ ¼å¼ã€‚</p><h3 id="rgbæ ¼å¼">RGBæ ¼å¼</h3><p>RGBå›¾åƒå…·æœ‰ä¸‰ä¸ªé€šé“Rã€Gã€Bï¼Œåˆ†åˆ«å¯¹åº”çº¢ã€ç»¿ã€è“ä¸‰ä¸ªåˆ†é‡ï¼Œç”±ä¸‰ä¸ªåˆ†é‡çš„å€¼å†³å®šé¢œè‰²ï¼›é€šå¸¸ï¼Œä¼šç»™RGBå›¾åƒåŠ ä¸€ä¸ªé€šé“alphaï¼Œå³é€æ˜åº¦ï¼Œäºæ˜¯å…±æœ‰å››ä¸ªåˆ†é‡å…±åŒæ§åˆ¶é¢œè‰²ã€‚</p><p><strong>RGBç”¨äºå±å¹•å›¾åƒçš„å±•ç¤ºã€‚</strong></p><h3 id="yuvæ ¼å¼">YUVæ ¼å¼</h3><p>YUVé¢œè‰²ç©ºé—´æ˜¯PALã€NTSCã€SCEAMä¸‰å¤§è§†é¢‘æ ‡å‡†ä½¿ç”¨çš„é¢œè‰²ç©ºé—´ï¼Œä¸»è¦åº”ç”¨äºè§†é¢‘ç³»ç»Ÿã€‚ä½¿ç”¨YUVè‰²å½©ç©ºé—´ï¼ŒåæœŸå‡ºç°çš„å½©è‰²ç”µè§†ç³»ç»Ÿå’Œæ—©æœŸçš„é»‘ç™½ç”µè§†ç³»ç»Ÿå…¼å®¹ï¼Œé»‘ç™½ç”µè§†æœºå¯ä»¥åªå¤„ç†å½©è‰²ç”µä¿¡ä¿¡å·ä¸­çš„Yåˆ†é‡ï¼Œè€Œå½©è‰²ç”µè§†æœºæ¥æ”¶é»‘ç™½ç”µè§†ä¿¡å·å¹¶æ˜¾ç¤ºä¹Ÿæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚</p><p><span class="math inline">\(Y&#39;UV\)</span>ã€<span class="math inline">\(YUV\)</span>ã€<span class="math inline">\(YC_bC_r\)</span>ã€<span class="math inline">\(YP_bP_r\)</span>ç­‰éƒ½å¯ä»¥ç§°ä¸ºYUVï¼Œå®ƒä»¬æ‰€æŒ‡æ¶‰çš„èŒƒå›´ï¼Œå¸¸æœ‰æ··æ·†æˆ–é‡å çš„æƒ…å†µã€‚ä»å†å²çš„æ¼”å˜æ¥è¯´ï¼Œå…¶ä¸­<span class="math inline">\(YUV\)</span>å’Œ<span class="math inline">\(Y&#39;UV\)</span>é€šå¸¸ç”¨æ¥ç¼–ç ç”µè§†çš„æ¨¡æ‹Ÿä¿¡å·ï¼Œè€Œ<span class="math inline">\(YC_bC_r\)</span>åˆ™æ˜¯ç”¨æ¥æè¿°æ•°å­—çš„è§†é¢‘ä¿¡å·ï¼Œé€‚åˆå½±ç‰‡ä¸å›¾ç‰‡å‹ç¼©ä»¥åŠä¼ è¾“ï¼Œä¾‹å¦‚MPEGã€JPEGã€‚ ä½†åœ¨ç°ä»Šï¼ŒYUVé€šå¸¸å·²ç»åœ¨è®¡ç®—æœºç³»ç»Ÿä¸Šå¹¿æ³›ä½¿ç”¨ã€‚</p><p><strong>YUVç”¨äºé‡‡é›†ä¸ç¼–ç ã€‚</strong></p><ul><li>YUV<ul><li>Yï¼šäº®åº¦/ç°é˜¶</li><li>Uï¼šè‰²è°ƒ/è‰²åº¦</li><li>Vï¼šé¥±å’Œåº¦/æµ“åº¦</li></ul></li><li><span class="math inline">\(YP_bP_r\)</span>ï¼Œæ¨¡æ‹Ÿä»½é‡ä¿¡å·/æ¥å£<ul><li>Pï¼šParalleï¼Œå¹¶è¡Œ</li><li>bä¸‹æ ‡ï¼šè“</li><li>rä¸‹æ ‡ï¼šçº¢</li></ul></li><li><span class="math inline">\(YC_bC_r\)</span>ï¼Œæ•°å­—åˆ†é‡ä¿¡å·/æ¥å£<ul><li>Cï¼ŒChromaï¼šè‰²åº¦</li><li><span class="math inline">\(YC_bC_r\)</span>è¿˜å¯æŒ‡è‰²å½©ç©ºé—´ï¼Œ<span class="math inline">\(YC_bC_r\)</span>è‰²å½©ç©ºé—´æ˜¯YUVè‰²å½©ç©ºé—´çš„ç¼©æ”¾å’Œåç§»ç‰ˆæœ¬ã€‚</li></ul></li></ul><p>YUV åœ¨å¯¹ç…§ç‰‡æˆ–å½±ç‰‡ç¼–ç æ—¶ï¼Œè€ƒè™‘åˆ°äººç±»çš„æ„ŸçŸ¥èƒ½åŠ›ï¼Œå…è®¸é™ä½è‰²åº¦çš„å¸¦å®½ã€‚YUVå¯ä»¥é€šè¿‡æŠ›å¼ƒè‰²å·®æ¥è¿›è¡Œå¸¦å®½ä¼˜åŒ–ã€‚æ¯”å¦‚yuv420æ ¼å¼å›¾åƒç›¸æ¯”RGBæ¥è¯´ï¼Œè¦èŠ‚çœä¸€åŠçš„å­—èŠ‚å¤§å°ï¼ŒæŠ›å¼ƒç›¸é‚»çš„è‰²å·®å¯¹äºäººçœ¼æ¥è¯´ï¼Œå·®åˆ«ä¸å¤§ã€‚</p><p>YUVé¢œè‰²ç©ºé—´å’ŒRGBé¢œè‰²ç©ºé—´å¯ä»¥æ ¹æ®å…¬å¼ç›¸äº’è½¬æ¢ã€‚å‡¡æ˜¯æ¸²æŸ“åˆ°å±å¹•ä¸Šçš„ä¸œè¥¿ï¼Œéƒ½è¦è½¬æ¢ä¸ºRGBå½¢å¼ã€‚</p><p>æ ‡æ¸…ç”µè§†ä½¿ç”¨æ ‡å‡†BT.601ï¼š <span class="math display">\[{\left[\begin{array}{l}Y&#39; \\U \\V\end{array}\right]\\= \left[\begin{array}{ccc}0.299 &amp; 0.587 &amp; 0.114 \\-0.14713 &amp; -0.28886 &amp; 0.436 \\0.615 &amp; -0.51499 &amp; -0.10001\end{array}\right]\left[\begin{array}{l}R \\G \\B\end{array}\right]}\]</span></p><p><span class="math display">\[{\left[\begin{array}{l}R \\G \\B\end{array}\right]\\= \left[\begin{array}{ccc}1 &amp; 0 &amp; 1.13983 \\1 &amp; -0.39465 &amp; -0.58060 \\1 &amp; 2.03211 &amp; 0\end{array}\right]\\\left[\begin{array}{l}Y&#39; \\U \\V\end{array}\right]}\]</span></p><p>é«˜æ¸…ç”µè§†ä½¿ç”¨æ ‡å‡†BT.709ï¼š <span class="math display">\[{\left[\begin{array}{l}Y^{\prime} \\U \\V\end{array}\right]=\left[\begin{array}{ccc}0.2126 &amp; 0.7152 &amp; 0.0722 \\-0.09991 &amp; -0.33609 &amp; 0.436 \\0.615 &amp; -0.55861 &amp; -0.05639\end{array}\right]\left[\begin{array}{l}R \\G \\B\end{array}\right]}\]</span></p><p><span class="math display">\[{\left[\begin{array}{l}R \\G \\B\end{array}\right]=\left[\begin{array}{ccc}1 &amp; 0 &amp; 1.28033 \\1 &amp; -0.21482 &amp; -0.38059 \\1 &amp; 2.12798 &amp; 0\end{array}\right]\left[\begin{array}{l}Y^{\prime} \\U \\V\end{array}\right]}\]</span></p><p>å¯¹äºiOSé‡‡é›†çš„CMSampleBufferRefï¼Œè°ƒç”¨<code>CVBufferGetAttachment</code>è·å–YCbCrMatrixï¼Œå†³å®šä½¿ç”¨BT.601è¿˜æ˜¯BT.709ã€‚</p><h2 id="é‡‡æ ·æ–¹å¼">é‡‡æ ·æ–¹å¼</h2><p>YUVç›¸æ¯”äºRGBæ ¼å¼æœ€å¤§çš„å¥½å¤„æ˜¯å¯ä»¥åšåˆ°åœ¨ä¿æŒå›¾åƒè´¨é‡é™ä½ä¸æ˜æ˜¾çš„å‰æä¸‹ï¼Œå‡å°æ–‡ä»¶å¤§å°ã€‚YUVæ ¼å¼ä¹‹æ‰€ä»¥èƒ½å¤Ÿåšåˆ°ï¼Œæ˜¯å› ä¸ºè¿›è¡Œäº†é‡‡æ ·æ“ä½œã€‚</p><p>YUVå›¾åƒå­˜å‚¨æ¨¡å¼ä¸é‡‡æ ·æ–¹å¼å¯†åˆ‡ç›¸å…³ã€‚ä¸»æµçš„é‡‡æ ·æ–¹å¼æœ‰ä¸‰ç§ï¼ŒYUV4:4:4<strong>(YUV444)</strong>ã€YUV4:2:2<strong>(YUV422)</strong>ã€YUV4:2:0<strong>(YUV420)</strong>ï¼ˆæ‰€æœ‰è®¾å¤‡éƒ½æ”¯æŒï¼‰ã€‚è¿™äº›é‡‡æ ·æ–¹å¼ï¼Œä¸å‹ç¼©Yåˆ†é‡ï¼Œå¯¹UVåˆ†é‡çš„å‹ç¼©ç¨‹åº¦ä¸åŒï¼Œè¿™æ˜¯ç”±äººçœ¼çš„ç‰¹æ€§å†³å®šçš„ï¼Œäººçœ¼å¯¹äº®åº¦Yæ›´æ•æ„Ÿï¼Œå¯¹è‰²åº¦UVæ²¡æœ‰é‚£ä¹ˆæ•æ„Ÿï¼Œå‹ç¼©UVåˆ†é‡å¯ä»¥é™ä½æ•°æ®é‡ï¼Œä½†å¹¶ä¸ä¼šäººçœ¼ä¸»è§‚æ„Ÿè§‰é€ æˆå¤ªå¤§å½±å“ã€‚</p><p>YUVåé¢æ¥çš„æ•°å­—å°±æ˜¯<span class="math inline">\(Y\)</span>ã€<span class="math inline">\(C_b\)</span>ã€<span class="math inline">\(C_r\)</span>ä¸‰ä¸ªåˆ†é‡çš„æ¯”ä¾‹ã€‚</p><p>è‹¥ä»¥ä»¥é»‘ç‚¹è¡¨ç¤ºé‡‡æ ·è¯¥åƒç´ ç‚¹çš„Yåˆ†é‡ï¼Œä»¥ç©ºå¿ƒåœ†åœˆè¡¨ç¤ºé‡‡ç”¨è¯¥åƒç´ ç‚¹çš„UVåˆ†é‡ï¼Œåˆ™è¿™ä¸‰ç§é‡‡æ ·æ–¹å¼å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772067597-256abbba-34ae-452b-8070-2b4685f65386.png" /></p><p>å³ï¼š</p><ul><li><p>YUV4:4:4é‡‡æ ·ï¼Œæ¯ä¸€ä¸ªYå¯¹åº”ä¸€ç»„UVåˆ†é‡ã€‚</p></li><li><p>YUV4:2:2é‡‡æ ·ï¼Œæ¯ä¸¤ä¸ªYå…±ç”¨ä¸€ç»„UVåˆ†é‡ã€‚</p></li><li><p>YUV4:2:0é‡‡æ ·ï¼Œæ¯å››ä¸ªYå…±ç”¨ä¸€ç»„UVåˆ†é‡ã€‚</p></li></ul><h3 id="yuv444">YUV4:4:4</h3><p>4:4:4ï¼Œè¡¨ç¤ºå®Œå…¨å–æ ·ã€‚æ¯ä¸ª Y å¯¹åº”ä¸€ç»„ UV åˆ†é‡ã€‚</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772067684-94dd4489-e95f-4483-9573-7fe5c4139ecb.png" /></p><p>ç›¸é‚»çš„4ä¸ªåƒç´ é‡Œæœ‰4ä¸ªYã€4ä¸ªUã€4ä¸ªVã€‚æ¯1ä¸ªYä½¿ç”¨1ç»„UVåˆ†é‡ã€‚å¦‚ä¸‹(æ¯ä¸ª[]ä¸ºä¸€ä¸ªåƒç´ ç‚¹)ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ Y U V ]  [ Y U V ]  [ Y U V ]  [ Y U V ]</span><br><span class="line">[ Y U V ]  [ Y U V ]  [ Y U V ]  [ Y U V ]</span><br><span class="line">[ Y U V ]  [ Y U V ]  [ Y U V ]  [ Y U V ]</span><br><span class="line">[ Y U V ]  [ Y U V ]  [ Y U V ]  [ Y U V ]</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ç§é‡‡æ ·æ–¹å¼ä¸‹ï¼Œä¸€ä¸ªåƒç´ ç‚¹åŒ…å«çš„å®Œæ•´çš„ä¿¡æ¯ã€‚</p><p><strong>æ¯ä¸ªåƒç´ å¤§å°æ˜¯3å­—èŠ‚ï¼ˆ24ä½ï¼‰ï¼Œä¸RGBä¸€è‡´ã€‚</strong></p><h3 id="yuv422">YUV4:2:2</h3><p>4:2:2ï¼Œè¡¨ç¤º 2:1 æ°´å¹³å–æ ·ï¼Œå‚ç›´å®Œå…¨é‡‡æ ·ã€‚æ¯ä¸¤ä¸ª Y å…±ç”¨ä¸€ç»„ UV åˆ†é‡ã€‚</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772067808-3f48509f-c288-4451-8aa1-43af153ea027.png" /></p><p>ç›¸é‚»çš„4ä¸ªåƒç´ é‡Œæœ‰4ä¸ªYã€2ä¸ªUã€2ä¸ªVã€‚æ¯2ä¸ªYå…±ç”¨1ç»„UVåˆ†é‡ã€‚å¹³å‡ç®—æ¥ï¼Œä¸€ä¸ªåƒç´ å ç”¨çš„æ•°æ®å®½åº¦ä¸º16bï¼Œå…¶ä¸­Yå 8bï¼ŒUå 4bï¼ŒVå 4bã€‚åé¢å­˜å‚¨æ¨¡å¼å‘½åä¸­çš„æ•°å­—16æŒ‡çš„å°±æ˜¯16bã€‚<strong>å¹³å‡æ¯ä¸ªåƒç´ å¤§å°æ˜¯2å­—èŠ‚ï¼Œæ¯”RGBå°‘â…“ã€‚</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ Y U ]  [ Y V ]  [ Y U ]  [ Y V ]</span><br><span class="line">[ Y V ]  [ Y U ]  [ Y V ]  [ Y U ]</span><br><span class="line">[ Y U ]  [ Y V ]  [ Y U ]  [ Y V ]</span><br><span class="line">[ Y V ]  [ Y U ]  [ Y V ]  [ Y U ]</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ç§é‡‡æ ·æ–¹å¼ä¸‹ï¼Œè¿˜åŸå‡ºä¸€ä¸ªåƒç´ ç‚¹ï¼Œéœ€è¦ç›¸é‚»çš„ä¸¤ä¸ªåƒç´ ç‚¹æ•°æ®ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ Y U ]  [ Y V ]</span><br></pre></td></tr></table></figure><h3 id="yuv420">YUV4:2:0</h3><p>4:2:0ï¼Œè¡¨ç¤º 2:1 æ°´å¹³å–æ ·ï¼Œå‚ç›´ 2:1 é‡‡æ ·ã€‚</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772067907-bf5c524e-747c-41a4-be38-cbc8a40ed36f.png" /></p><p>4:1:0å¹¶ä¸æ„å‘³ç€åªæœ‰<span class="math inline">\(Y\)</span>ã€<span class="math inline">\(C_b\)</span>ä¸¤ä¸ªåˆ†é‡ï¼Œè€Œæ²¡æœ‰<span class="math inline">\(C_r\)</span>åˆ†é‡ã€‚å®é™…æŒ‡çš„æ˜¯å¯¹æ¯è¡Œæ‰«æçº¿æ¥è¯´ï¼Œåªæœ‰ä¸€ä¸­è‰²åº¦åˆ†é‡ï¼Œç›¸é‚»çš„æ‰«æçº¿å­˜å‚¨ä¸åŒçš„è‰²åº¦åˆ†é‡ã€‚</p><p>ç›¸é‚»çš„4ä¸ªåƒç´ é‡Œæœ‰4ä¸ªYã€2ä¸ªUã€0ä¸ªVï¼Œæˆ–4ä¸ªYã€2ä¸ªVï¼Œ0ä¸ªUã€‚æ¯4ä¸ªYå…±ç”¨1ç»„UVåˆ†é‡ã€‚å¹³å‡ç®—æ¥ï¼Œä¸€ä¸ªåƒç´ å ç”¨çš„æ•°æ®å®½åº¦ä¸º12bitï¼Œå…¶ä¸­Yå 8bitï¼ŒUå 2bitï¼ŒVå 2bitã€‚åé¢å­˜å‚¨æ¨¡å¼å‘½åä¸­çš„æ•°å­—12æŒ‡çš„å°±æ˜¯12bã€‚<strong>å¹³å‡æ¯ä¸ªåƒç´ æ˜¯12bï¼Œæ¯”RGBå°‘Â½ã€‚</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ Y U ]  [ Y ]  [ Y U ]  [ Y ]</span><br><span class="line">[ Y V ]  [ Y ]  [ Y V ]  [ Y ]</span><br><span class="line">[ Y U ]  [ Y ]  [ Y U ]  [ Y ]</span><br><span class="line">[ Y V ]  [ Y ]  [ Y V ]  [ Y ]</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ç§é‡‡æ ·æ–¹å¼ä¸‹ï¼Œè¿˜åŸå‡ºä¸€ä¸ªåƒç´ ç‚¹ï¼Œéœ€è¦ç›¸é‚»çš„å››ä¸ªåƒç´ ç‚¹æ•°æ®ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ Y U ]  [ Y ]</span><br><span class="line">[ Y V ]  [ Y ]</span><br></pre></td></tr></table></figure><p><span class="math display">\[YUV4:2:0 æ•°æ®é‡ = Y Ã— 1.5 = RGB Ã· 2\]</span></p><h2 id="å­˜å‚¨æ ¼å¼">å­˜å‚¨æ ¼å¼</h2><p>åœ¨åŒä¸€é‡‡æ ·æ¨¡å¼ä¸‹ï¼Œæ ¹æ®åˆ†é‡å…ƒç´ æ’åˆ—é¡ºåºçš„ä¸åŒï¼Œåˆåˆ†ä¸ºä¸åŒçš„å­˜å‚¨æ¨¡å¼ã€‚</p><ul><li><p><strong>packed</strong>ï¼Œç´§ç¼©æ ¼å¼ï¼ˆpacked formatsï¼‰ï¼šå°† Yã€Uã€V å€¼å­˜å‚¨æˆä¸€ä¸ª Macro Pixels æ•°ç»„ï¼Œå’Œ RGB çš„å­˜æ”¾æ–¹å¼ç±»ä¼¼ã€‚</p><ul><li><p>å†…å­˜ä¸­æ’åˆ—å½¢å¼ç±»ä¼¼ï¼šYVYUYVYUYVYUYVYU...ã€‚</p></li><li><p>åœ¨å…·ä½“çš„å­˜å‚¨æ¨¡å¼å‘½åä¸­ï¼Œpackedæ ¼å¼ä¸å¸¦åç¼€Pã€‚</p></li><li><p>é€‚åˆYUV 4:4:4</p></li></ul></li><li><p><strong>planar</strong>ï¼Œå¹³é¢æ ¼å¼ï¼ˆplanar formatsï¼‰ï¼šå°† Yã€Uã€V 3ä¸ªåˆ†é‡åˆ†åˆ«å­˜æ”¾åœ¨ä¸åŒçš„çŸ©é˜µä¸­ï¼ˆ3ä¸ªå­—èŠ‚æ•°ç»„ï¼‰ã€‚</p><ul><li><p>å†…å­˜ä¸­æ’åˆ—å½¢å¼ç±»ä¼¼ï¼šYYYYYY...ï¼ŒUUUUUU...ï¼ŒVVVVVV...ã€‚</p></li><li><p>åœ¨å…·ä½“çš„å­˜å‚¨æ¨¡å¼å‘½åä¸­ï¼Œplanaræ ¼å¼å¸¦åç¼€Pã€‚</p></li><li><p>é€‚åˆI420ï¼ˆYUV420pï¼‰ã€YV12ï¼ˆYUV420pï¼‰</p></li></ul></li><li><p><strong>semi-planar</strong>ï¼Œå°†Yã€Uã€Vä¸‰ä¸ªåˆ†é‡æ”¾åœ¨2ä¸ªçŸ©é˜µ(å¹³é¢)ä¸­ï¼ˆ2ä¸ªå­—èŠ‚æ•°ç»„ï¼‰ã€‚Yå ç”¨ä¸€ä¸ªå¹³é¢ï¼ŒUVå…±ç”¨ä¸€ä¸ªå¹³é¢ã€‚</p></li><li><p>å†…å­˜ä¸­æ’åˆ—å½¢å¼ç±»ä¼¼ï¼šYYYYYY...ï¼ŒUVUVUV...ã€‚</p><ul><li>åœ¨å…·ä½“çš„å­˜å‚¨æ¨¡å¼å‘½åä¸­ï¼Œsemi-planaræ ¼å¼å¸¦åç¼€SPã€‚</li></ul></li><li><p>é€‚åˆNV12ï¼ˆYUV420spï¼‰ã€NV21ï¼ˆYUV420spï¼‰</p></li></ul><h2 id="åƒç´ æ ¼å¼">åƒç´ æ ¼å¼</h2><h3 id="yuv422-1">YUV422</h3><p>å†…å­˜åˆ†å¸ƒï¼šYUYVã€YVYUã€UYVYã€VYUY</p><p>è¿™å››ç§æ ¼å¼æ¯ä¸€ç§åˆå¯ä»¥åˆ†ä¸º2ç±»ï¼ˆpackedå’Œplanarï¼‰ï¼Œä»¥<strong>YUYV</strong>ä¸ºä¾‹ï¼Œä¸€ä¸ª6*4çš„å›¾åƒçš„å­˜å‚¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Y Y Y Y Y Y                   </span><br><span class="line">Y Y Y Y Y Y                  </span><br><span class="line">Y Y Y Y Y Y                   </span><br><span class="line">Y Y Y Y Y Y                    </span><br><span class="line">U U U U U U                  Y U Y V Y U Y V Y U Y V</span><br><span class="line">U U U U U U                  Y U Y V Y U Y V Y U Y V</span><br><span class="line">V V V V V V                  Y U Y V Y U Y V Y U Y V</span><br><span class="line">V V V V V V                  Y U Y V Y U Y V Y U Y V</span><br><span class="line">- Planar -                          - Packed -</span><br></pre></td></tr></table></figure><h3 id="yuv420-1">YUV420</h3><ul><li>YUV420pï¼šI420ã€YV12ï¼Œplanarï¼Œåˆ†åˆ«å­˜å‚¨åœ¨ä¸‰ä¸ªå­—èŠ‚æ•°ç»„ä¸­ã€‚</li><li>YUV420spï¼šNV12ã€NV21ï¼Œsemi-planarï¼ŒYå­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼ŒUVå­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ã€‚</li></ul><p>åŒæ ·ï¼Œå¯¹äºä¸€ä¸ª6*4çš„å›¾åƒï¼Œè¿™å››ç§åƒç´ æ ¼å¼çš„å­˜å‚¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Y Y Y Y Y Y      Y Y Y Y Y Y      Y Y Y Y Y Y      Y Y Y Y Y Y</span><br><span class="line">Y Y Y Y Y Y      Y Y Y Y Y Y      Y Y Y Y Y Y      Y Y Y Y Y Y</span><br><span class="line">Y Y Y Y Y Y      Y Y Y Y Y Y      Y Y Y Y Y Y      Y Y Y Y Y Y</span><br><span class="line">Y Y Y Y Y Y      Y Y Y Y Y Y      Y Y Y Y Y Y      Y Y Y Y Y Y</span><br><span class="line">U U U U U U      V V V V V V      U V U V U V      V U V U V U</span><br><span class="line">V V V V V V      U U U U U U      U V U V U V      V U V U V U</span><br><span class="line"> - I420 -         - YV12 -         - NV12 -         - NV21 -</span><br></pre></td></tr></table></figure><h2 id="å ç”¨å­—èŠ‚æ•°">å ç”¨å­—èŠ‚æ•°</h2><p>YUV420å›¾åƒå ç”¨å­—èŠ‚æ•°ä¸º ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size = width * height + (width * height) / 4 + (width * height) / 4 = width * height * 1.5 // åˆšå¥½æ˜¯ RGB çš„ä¸€åŠ</span><br></pre></td></tr></table></figure><p>RGBæ ¼å¼çš„å›¾åƒå ç”¨å­—èŠ‚æ•°ä¸º:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size = width * height * 3</span><br></pre></td></tr></table></figure><p>RGBAæ ¼å¼çš„å›¾åƒå ç”¨å­—èŠ‚æ•°ä¸º:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size = width * height * 4</span><br></pre></td></tr></table></figure><h2 id="yuvæ•°æ®è®¿é—®">YUVæ•°æ®è®¿é—®</h2><p>å¯¹äºä¸€ä¸ªYUVæ ¼å¼å­˜æ”¾çš„æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥è¯»å–å¹¶åˆ†ç¦»æˆYã€Uã€Vå„ä¸ªåˆ†é‡çš„æ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å–YUV420Pçš„æ–‡ä»¶ï¼Œæ¯ä¸ªYã€Uã€Vå€¼éƒ½æ˜¯ç”¨ä¸€ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œæ‰€ä»¥ä½¿ç”¨åˆšå¥½æ˜¯ä¸€å­—èŠ‚å¤§å°çš„charè¡¨ç¤º</span></span><br><span class="line"><span class="keyword">int</span> yuv_size = w * h * <span class="number">3</span> / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *pic = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="built_in">malloc</span>(yuv_size);</span><br><span class="line">fread(pic, <span class="number">1</span>, yuv_size, fyuv);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> written_byte, writting_byte = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// Y</span></span><br><span class="line">writting_byte = w * h;</span><br><span class="line">fwrite(pic + written_byte, <span class="number">1</span>, writting_byte, fy);</span><br><span class="line">written_byte += writting_byte;</span><br><span class="line"><span class="comment">// U</span></span><br><span class="line">writting_byte = w * h / <span class="number">4</span>;</span><br><span class="line">fwrite(pic + written_byte, <span class="number">1</span>, writting_byte, fu);</span><br><span class="line">written_byte += writting_byte;</span><br><span class="line"><span class="comment">// V</span></span><br><span class="line">writting_byte = w * h / <span class="number">4</span>;</span><br><span class="line">fwrite(pic + written_byte, <span class="number">1</span>, writting_byte, fv);</span><br><span class="line">written_byte += writting_byte;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹äºYUV444Pçš„åˆ†ç¦»ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œåªæ˜¯ï¼š</span></span><br><span class="line"><span class="comment">// yuv_size = w * h * 3</span></span><br><span class="line"><span class="comment">// writting_byte = w * h</span></span><br></pre></td></tr></table></figure><p>å¯¹äºYUVæ ¼å¼æ•°æ®å˜æˆç°åº¦å›¾ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠUã€Vå€¼éƒ½ç½®ç©ºå³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å–YUV420Pçš„æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">int</span> yuv_size = w * h * <span class="number">3</span> / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *pic = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="built_in">malloc</span>(yuv_size);</span><br><span class="line">fread(pic, <span class="number">1</span>, yuv_size, fyuv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Gray</span></span><br><span class="line"><span class="built_in">memset</span>(pic + w * h, <span class="number">0</span>, w * h / <span class="number">2</span>);</span><br><span class="line">fwrite(pic, <span class="number">1</span>, yuv_size, fyuv);</span><br></pre></td></tr></table></figure><h2 id="iosç›¸æœºæ”¯æŒè¾“å‡ºå›¾ç‰‡æ ¼å¼">iOSç›¸æœºæ”¯æŒè¾“å‡ºå›¾ç‰‡æ ¼å¼</h2><ul><li><p>420v</p><ul><li><p><code>kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange</code></p></li><li><p>è¡¨ç¤ºè¾“å‡ºçš„è§†é¢‘æ ¼å¼ä¸ºNV12ï¼ˆYUV420spï¼‰</p></li><li><p>èŒƒå›´ï¼š(luma = [16,235], chroma = [16,240])</p></li></ul></li><li><p>420f</p><ul><li><p><code>kCVPixelFormatType_420YpCbCr8BiPlanarFullRange</code></p></li><li><p>è¡¨ç¤ºè¾“å‡ºçš„è§†é¢‘æ ¼å¼ä¸ºNV12ï¼ˆYUV420spï¼‰</p></li><li><p>èŒƒå›´ï¼š(luma = [0,255], chroma = [1,255])</p></li></ul></li><li><p>BGRA</p><ul><li><code>kCVPixelFormatType_32BGRA</code></li><li>è¾“å‡ºçš„æ˜¯BGRAçš„æ ¼å¼</li></ul></li></ul><p>Androidä»æ‘„åƒå¤´é‡‡é›†çš„é¢„è§ˆæ•°æ®ä¸€èˆ¬éƒ½æ˜¯NV21ï¼ŒiOSä¸€èˆ¬é‡‡é›†çš„æ•°æ®éƒ½æ˜¯NV12ã€‚</p><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><p>https://juejin.im/post/5a572730f265da3e2c3803ad</p></li><li><p><a href="https://en.wikipedia.org/wiki/YUV">YUV - Wikipedia</a></p></li><li><p><a href="https://www.fourcc.org/yuv.php">YUV pixel formats</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;è‰²å½©ç©ºé—´&quot;&gt;è‰²å½©ç©ºé—´&lt;/h2&gt;
&lt;p&gt;åƒç´ æ ¼å¼æè¿°äº†åƒç´ æ•°æ®å­˜å‚¨æ‰€ç”¨çš„æ ¼å¼ï¼Œå®šä¹‰äº†åƒç´ åœ¨å†…å­˜ä¸­çš„ç¼–ç æ–¹å¼ã€‚RGBå’ŒYUVä¸ºä¸¤ç§ç»å¸¸ä½¿ç”¨çš„åƒç´ æ ¼å¼ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>å›¾åƒåŸºç¡€æŠ€æœ¯</title>
    <link href="https://bqlin.github.io/posts/image_basic_technology/"/>
    <id>https://bqlin.github.io/posts/image_basic_technology/</id>
    <published>2021-03-15T02:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å›¾åƒä¸å±å¹•">å›¾åƒä¸å±å¹•</h2><p>ä¸€ä¸ªåƒç´ å¯ä»¥æœ‰ä¸¤å±‚å«ä¹‰ï¼š</p><ul><li>å›¾åƒæ•°æ®çš„ä¸€ä¸ªç‚¹ã€‚</li><li>å±å¹•ä¸Šçš„ä¸€ä¸ªç‚¹ã€‚</li></ul><p>å›¾åƒä¸å±å¹•çš„å…³ç³»ï¼š</p><ul><li><p>å›¾åƒæ˜¯æ•°æ®ï¼›</p></li><li><p>å±å¹•æ˜¯æ˜¾ç¤ºè®¾å¤‡ï¼›</p></li><li><p>å›¾åƒæ•°æ®ç»è¿‡é©±åŠ¨ç¨‹åºè®©å±å¹•æ˜¾ç¤ºå›¾åƒã€‚</p></li></ul><p>å±å¹•æŒ‡æ ‡ï¼š</p><ul><li>PPIï¼Œpixel per inch</li><li>DPIï¼ŒDots per inch</li></ul><p>PPI å’Œ DPI ä¸€èˆ¬éƒ½ç›¸åŒã€‚å¦‚æœ PPI &gt; 300 å°±å±äºè§†ç½‘è†œå±ï¼ˆäººçœ¼åŒºåˆ†ä¸å‡ºæ¯ä¸ªéƒ½åƒç´ ç‚¹ï¼‰ã€‚</p><p>æ¯ä¸ªåƒç´ å…·æœ‰ä½æ·±ï¼Œå³ä½¿ç”¨å¤šå°‘ä½æ¥ä¿å­˜ä¸€ä¸ªåƒç´ ã€‚å¯ä»¥æ ¹æ®ä½æ·±ç»´åº¦åˆ’åˆ†ä¸åŒçš„åƒç´ æ ¼å¼ï¼š</p><ul><li>RGB888ï¼ˆ24ä½ï¼‰</li><li>RGBAï¼ˆ32ä½ï¼‰</li></ul><p>å­˜å‚¨æ¨¡å¼ï¼š</p><ul><li>RGB565ï¼šä½¿ç”¨16ä½è¡¨ç¤ºä¸€ä¸ªåƒç´ ã€‚Rï¼š5ä½ï¼ŒGï¼š6ä½ï¼ŒBï¼š5ä½ã€‚</li><li>RGB888ï¼šä½¿ç”¨24ä½æ¥è¡¨ç¤ºä¸€ä¸ªåƒç´ ï¼Œæ¯ä¸ªåˆ†é‡éƒ½ç”¨8ä½è¡¨ç¤ºã€‚</li><li>ARGB8888ï¼šä½¿ç”¨32ä½æ¥è¡¨ç¤ºä¸€ä¸ªåƒç´ ï¼ŒRã€Gã€Béƒ½ç”¨8ä½è¡¨ç¤ºï¼Œå¦å¤–A(Alpha)è¡¨ç¤ºé€æ˜åº¦ï¼Œä¹Ÿç”¨8ä½è¡¨ç¤ºã€‚</li></ul><h2 id="å›¾åƒçš„åƒç´ ä¿¡æ¯">å›¾åƒçš„åƒç´ ä¿¡æ¯</h2><p>https://www.yuque.com/quandong/pqm3wg/nfzu3o</p><p>åƒç´ æ ¼å¼åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ol type="1"><li><p>æ¯ä¸ªåˆ†é‡çš„ä½æ•°ï¼Œå³åœ¨ä¸€ä¸ªåƒç´ ä¸­æ¯ä¸ªç‹¬ç«‹é¢œè‰²åˆ†é‡çš„ä½æ•°ã€‚å¯¹äºä¸€ä¸ªå›¾åƒé®ç½©ï¼Œè¿™ä¸ªå€¼æ˜¯æºåƒç´ ä¸­é®ç½©bitçš„æ•°ç›®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæºå›¾ç‰‡æ˜¯8-bitçš„é®ç½©ï¼Œåˆ™æŒ‡å®šæ¯ä¸ªåˆ†é‡æ˜¯8ä½ã€‚</p></li><li><p>æ¯ä¸ªåƒç´ çš„ä½æ•°ï¼Œå³ä¸€ä¸ªæºåƒç´ æ‰€å çš„æ€»çš„ä½æ•°ã€‚è¿™ä¸ªå€¼å¿…é¡»è‡³å°‘æ˜¯æ¯ä¸ªåˆ†é‡çš„ä½æ•°ä¹˜ä»¥æ¯ä¸ªåƒç´ ä¸­åˆ†é‡çš„æ•°ç›®ã€‚</p></li><li><p>æ¯è¡Œçš„å­—èŠ‚æ•°ï¼Œå³å›¾åƒä¸­æ°´å¹³è¡Œçš„å­—èŠ‚æ•°ã€‚</p></li></ol><h3 id="ä½å›¾å¸ƒå±€">ä½å›¾å¸ƒå±€</h3><p>https://www.yuque.com/quandong/pqm3wg/nfzu3o</p><p>ä»¥ä¸‹çš„å¸¸é‡æŒ‡å®šäº†alphaåˆ†é‡çš„ä½ç½®åŠé¢œè‰²åˆ†é‡æ˜¯å¦åšé¢„å¤„ç†ï¼š</p><ol type="1"><li><p>kCGImageAlphaLastï¼šalphaåˆ†é‡å­˜å‚¨åœ¨æ¯ä¸ªåƒç´ ä¸­æœ€ä¸æ˜¾è‘—çš„ä½ç½®ï¼Œå¦‚RGBAã€‚</p></li><li><p>kCGImageAlphaFirstï¼šalphaåˆ†é‡å­˜å‚¨åœ¨æ¯ä¸ªåƒç´ ä¸­æœ€æ˜¾è‘—çš„ä½ç½®ï¼Œå¦‚ARGBã€‚</p></li><li><p>kCGImageAlphaPremultipliedLastï¼šalphaåˆ†é‡å­˜å‚¨åœ¨æ¯ä¸ªåƒç´ ä¸­æœ€ä¸æ˜¾è‘—çš„ä½ç½®ï¼Œä½†é¢œè‰²åˆ†é‡å·²ç»ä¹˜ä»¥äº†alphaå€¼ã€‚</p></li><li><p>kCGImageAlphaPremultipliedFirstï¼šalphaåˆ†é‡å­˜å‚¨åœ¨æ¯ä¸ªåƒç´ ä¸­æœ€æ˜¾è‘—çš„ä½ç½®ï¼ŒåŒæ—¶é¢œè‰²åˆ†é‡å·²ç»ä¹˜ä»¥äº†alphaå€¼ã€‚</p></li><li><p>kCGImageAlphaNoneSkipLastï¼šæ²¡æœ‰alphaåˆ†é‡ã€‚å¦‚æœåƒç´ çš„æ€»å¤§å°å¤§äºé¢œè‰²ç©ºé—´ä¸­é¢œè‰²åˆ†é‡æ•°ç›®æ‰€éœ€è¦çš„ç©ºé—´ï¼Œåˆ™æœ€ä¸æ˜¾è‘—ä½ç½®çš„ä½å°†è¢«å¿½ç•¥ã€‚</p></li><li><p>kCGImageAlphaNoneSkipFirstï¼šæ²¡æœ‰alphaåˆ†é‡ã€‚å¦‚æœåƒç´ çš„æ€»å¤§å°å¤§äºé¢œè‰²ç©ºé—´ä¸­é¢œè‰²åˆ†é‡æ•°ç›®æ‰€éœ€è¦çš„ç©ºé—´ï¼Œåˆ™æœ€æ˜¾è‘—ä½ç½®çš„ä½å°†è¢«å¿½ç•¥ã€‚</p></li><li><p>kCGImageAlphaNoneï¼šç­‰äºkCGImageAlphaNoneSkipLastã€‚</p></li></ol><p>å›¾11-2æ¼”ç¤ºäº†ä¸€ä¸ªåƒç´ åœ¨ä½¿ç”¨16-æˆ–32-bitæ•´å‹åƒç´ æ ¼å¼çš„CMYKå’ŒRGBé¢œè‰²ç©ºé—´ä¸­å¦‚ä½•è¡¨ç¤ºã€‚32-bitæ•´å‹åƒç´ æ ¼å¼ä¸­ï¼Œæ¯ä¸ªåˆ†é‡å 8ä½ã€‚16-bitæ•´å‹åƒç´ æ ¼å¼ä¸­æ¯ä¸ªåˆ†é‡å 5ä½ã€‚QuartzåŒæ ·æ”¯æŒ128-bitæµ®ç‚¹åƒç´ æ ¼å¼ï¼Œæ¯ä¸ªåˆ†é‡å 32ä½ã€‚128-bitæ ¼å¼æ²¡æœ‰æ˜¾ç¤ºåœ¨ä¸‹å›¾ä¸­ã€‚</p><p><strong>Figure 11-2</strong> 32-bit and 16-bit pixel formats for CMYK and RGB color spaces in Quartz 2D<img src="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/Art/colorformatrgba32.gif" alt="16- and 32-bit pixel formats for CMYK and RGB color spaces in Quartz 2D" /></p><h2 id="è‰²å½©ç©ºé—´">è‰²å½©ç©ºé—´</h2><p><a href="a904a9146e560770e4c6b36917573db0">https://www.cnblogs.com/leisure_chn/p/10290575.html</a></p><p>é¢œè‰²æ˜¯ä¸åŒæ³¢é•¿çš„å…‰å¯¹äººçœ¼åˆºæ¿€äº§ç”Ÿçš„è‰²å½©æ„Ÿè§‰ã€‚è‰²å½©ç©ºé—´ï¼ˆColor Spaceï¼‰æ˜¯é¢œè‰²çš„æ•°å­¦è¡¨ç¤ºï¼Œæ ¹æ®ä¸åŒçš„è¡¨ç¤ºæ–¹æ³•åˆ†ä¸ºä¸åŒçš„è‰²å½©æ¨¡å‹ã€‚æœ€å¸¸ç”¨çš„è‰²å½©æ¨¡å‹æœ‰ä¸‰ç±»ï¼šRGBï¼ˆç”¨äºè®¡ç®—æœºå›¾å½¢å­¦ï¼‰ï¼Œ YUVï¼ˆç”¨äºè§†é¢‘ç³»ç»Ÿï¼‰ï¼Œ CMYKï¼ˆç”¨äºå½©è‰²å°åˆ·ï¼‰ã€‚</p><p>æè¿°å…‰çš„å¸¸ç”¨ç‰©ç†é‡æœ‰å››ä¸ªï¼šå…‰é€šé‡ã€å…‰å¼ºã€ç…§åº¦ã€äº®åº¦ã€‚</p><p><strong>å½©è‰²ä¸‰è¦ç´ </strong></p><p>å…‰çš„é¢œè‰²å–å†³äºå®¢è§‚å’Œä¸»è§‚ä¸¤æ–¹é¢çš„å› ç´ ã€‚å®¢è§‚å› ç´ æ˜¯å…‰çš„åŠŸç‡æ³¢è°±åˆ†å¸ƒï¼Œå®ƒå½±å“å…‰æºçš„é¢œè‰²ã€‚ä¸»è§‚å› ç´ æ˜¯äººçœ¼è§†é¢‘ç‰¹æ€§ï¼Œå®ƒå½±å“äººçœ¼å¯¹è‰²å½©çš„æ„Ÿè§‰ã€‚ å½©è‰²ä¸‰è¦ç´ æŒ‡äº®åº¦(Lightness)ã€è‰²è°ƒ(Hue)å’Œé¥±å’Œåº¦(Saturation)ï¼Œä»»ä¸€è‰²å½©éƒ½å¯ä»¥ç”¨è¿™ä¸‰ä¸ªåŸºæœ¬å‚é‡æ¥è¡¨ç¤ºï¼š</p><p><strong><em>äº®åº¦</em></strong>ï¼šè¡¨ç¤ºé¢œè‰²æ˜æš—çš„ç¨‹åº¦ï¼Œæ˜¯å…‰ä½œç”¨äºäººçœ¼æ—¶å¼•èµ·çš„æ˜äº®ç¨‹åº¦çš„æ„Ÿè§‰ã€‚</p><p><strong><em>è‰²è°ƒ</em></strong>ï¼šæ˜¯æŒ‡é¢œè‰²çš„ç±»åˆ«ï¼Œä¾‹å¦‚çº¢è‰²ã€è“è‰²ã€ç»¿è‰²æŒ‡çš„å°±æ˜¯è‰²è°ƒã€‚</p><p><strong><em>é¥±å’Œåº¦</em></strong>ï¼šæŒ‡é¢œè‰²çš„æ·±æµ…ç¨‹åº¦ï¼Œä¹Ÿç§°å½©åº¦ã€‚ä¾‹å¦‚æ·±ç»¿ã€æµ…ç»¿æŒ‡çš„å°±æ˜¯ç»¿è‰²è¿™ä¸ªè‰²è°ƒçš„é¥±å’Œåº¦ï¼Œé¥±å’Œåº¦è¶Šé«˜ï¼Œé¢œè‰²è¶Šæ·±ã€‚</p><h3 id="rgbè‰²å½©ç©ºé—´">RGBè‰²å½©ç©ºé—´</h3><p>äººçœ¼çœ‹åˆ°çš„ç‰©ä½“é¢œè‰²ï¼Œæ˜¯å…‰æºç…§å°„åˆ°ç‰©ä½“ï¼Œç‰©ä½“å¸æ”¶(è¿˜æœ‰é€å°„)éƒ¨åˆ†é¢œè‰²çš„å…‰ï¼Œç„¶åä»ç‰©ä½“è¡¨é¢åå°„çš„å…‰çº¿è¿›å…¥äººçœ¼åäººçœ¼å¾—åˆ°çš„è‰²å½©æ„Ÿè§‰ã€‚</p><p>äººçœ¼çœ‹åˆ°ç‰©ä½“ä¸ºé»‘è‰²ï¼Œæ˜¯å› ä¸ºç‰©ä½“å°†å…‰çº¿å®Œå…¨å¸æ”¶ï¼Œæ²¡æœ‰å…‰ä»ç‰©ä½“è¡¨é¢åå°„å‡ºæ¥(ä¾‹å¦‚ç™½å¤©æˆ‘ä»¬çœ‹ä¸€ä»¶é»‘è¡£æœ)ï¼›æˆ–è€…æ²¡æœ‰ä»»ä½•å…‰çº¿ç…§å°„åˆ°ç‰©ä½“(ä¾‹å¦‚é»‘åº•æˆ‘ä»¬çœ‹ä¸€å¼ ç™½çº¸)ã€‚</p><p>äººçœ¼çœ‹åˆ°ç‰©ä½“ä¸ºç™½è‰²ï¼Œæ˜¯å› ä¸ºåœ¨ç™½å…‰æºç…§å°„ä¸‹ï¼Œç‰©ä½“ä¸å¸æ”¶å…‰çº¿è€Œå°†å…‰çº¿å…¨éƒ¨åå°„(ä¾‹å¦‚ç™½å¤©æˆ‘ä»¬çœ‹ä¸€å¼ ç™½çº¸)ã€‚</p><p>é¢œè‰²ä¸å…‰æºå’Œç‰©ä½“çš„å¸è‰²ç‰¹æ€§å¯†åˆ‡ç›¸å…³ï¼ŒåŸºäºæ­¤ï¼Œå¼•å‡ºæ··è‰²æ–¹æ³•ä¸­çš„åŠ è‰²æ³•å’Œå‡è‰²æ³•ã€‚</p><p>åŠ è‰²æ³•åˆ©ç”¨å…‰æºå‘å°„ç‰¹æ€§ï¼Œå°†å„åˆ†è‰²çš„å…‰è°±æˆåˆ†ç›¸åŠ å¾—åˆ°æ··åˆé¢œè‰²ã€‚RGBè‰²å½©ç©ºé—´é‡‡ç”¨åŠ è‰²æ³•ã€‚å½“æ— ä»»ä½•å…‰çº¿ç…§å°„æ—¶ï¼ŒRã€Gã€Bä¸‰ç§é¢œè‰²åˆ†é‡éƒ½ä¸º0æ—¶ï¼Œç‰©ä½“å‘ˆç°é»‘è‰²ï¼›å½“Rã€Gã€Bä¸‰ç§é¢œè‰²åˆ†é‡è¾¾åˆ°æœ€å¤§æ—¶ï¼Œç‰©ä½“ä¸å¸æ”¶å…‰çº¿åªåå°„çš„æƒ…å†µä¸‹ï¼Œç‰©ä½“å‘ˆç°ç™½è‰²ã€‚æˆ‘ä»¬ç§°é»‘è‰²ä¸ºæœ€æš—ï¼Œç™½è‰²ä¸ºæœ€äº®ï¼Œè¦è¾¾åˆ°æœ€äº®çŠ¶æ€ï¼Œéœ€è¦ä¸‰è‰²åˆ†é‡æœ€å¤§ç¨‹åº¦æ··åˆï¼Œå› æ­¤ç§°ä¸ºåŠ è‰²ã€‚</p><p>åŠ è‰²æ³•ç”¨äºè‡ªå‘å…‰ç‰©ä½“ã€‚RGBé¢œè‰²ç©ºé—´ä¸»è¦åº”ç”¨äºè®¡ç®—æœºæ˜¾ç¤ºå™¨ã€ç”µè§†æœºã€èˆå°ç¯å…‰ç­‰ï¼Œéƒ½å…·æœ‰å‘å…‰ç‰¹æ€§ã€‚å½©è‰²åƒç´ åœ¨æ˜¾ç¤ºå™¨å±å¹•ä¸Šä¸ä¼šé‡å ï¼Œä½†è¶³å¤Ÿçš„è·ç¦»æ—¶ï¼Œå…‰çº¿ä»åƒç´ æ‰©æ•£åˆ°è§†ç½‘è†œä¸Šä¼šé‡å ï¼Œäººçœ¼ä¼šæ„Ÿè§‰åˆ°é‡å åçš„é¢œè‰²æ•ˆæœã€‚</p><p>å‡è‰²æ³•æ˜¯åˆ©ç”¨é¢œæ–™å¸è‰²ç‰¹æ€§ï¼Œæ¯åŠ ä¸€ç§é¢œè‰²çš„é¢œæ–™ï¼Œä¼šå¸æ”¶æ‰å¯¹åº”çš„è¡¥è‰²æˆåˆ†ã€‚CMYKè‰²å½©ç©ºé—´é‡‡ç”¨å‡è‰²æ³•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ç™½çº¸(ç™½å…‰ç…§å°„ã€ä¸å¸æ”¶ã€å…¨åå°„)ä¸Šæ¶‚é¢œæ–™ï¼Œé»„è‰²é¢œæ–™èƒ½å¸æ”¶è“è‰²(é»„è‰²çš„è¡¥è‰²)ï¼Œå› æ­¤åœ¨ç™½å…‰ç…§å°„ä¸‹æ˜¾ç¤ºé»„è‰²ï¼Œå½“é»„(Y)ã€é’(C)ã€å“çº¢(M)ä¸‰è‰²æ··åœ¨ä¸€èµ·ä¸”é¢œè‰²åˆ†é‡éƒ½ä¸ºæœ€å¤§æ—¶ï¼Œå®ƒä»¬çš„è¡¥è‰²æˆåˆ†è¢«å¸æ”¶æ‰ï¼Œå˜æˆäº†é»‘è‰²ï¼›å½“ä¸‰è‰²åˆ†é‡ä¸º0å³ä»€ä¹ˆä¹Ÿä¸æ¶‚æ—¶ï¼Œç™½çº¸æ˜¾ç°ç™½è‰²ã€‚è¦è¾¾åˆ°æœ€å¤§äº®åº¦ï¼Œéœ€è¦ä¸‰è‰²åˆ†é‡å®Œå…¨æ¶ˆå¤±ï¼Œå› æ­¤ç§°ä¸ºå‡è‰²ã€‚</p><p>å°åˆ·æ—¶ï¼Œæ— æ³•è¾¾åˆ°ç†æƒ³ç¨‹åº¦ï¼ŒCã€Mã€Yæœ€å¤§ç¨‹åº¦æ··åˆåæ— æ³•å¾—åˆ°çº¯é»‘è‰²ï¼Œåªèƒ½å¾—åˆ°æ·±ç°è‰²ï¼Œå› æ­¤åœ¨Cã€Mã€Yä¸‰è‰²ä¹‹å¤–å¼•å…¥äº†K(é»‘è‰²)ã€‚</p><p>å‡è‰²æ³•ç”¨äºæ— æ³•å‘å…‰çš„ç‰©ä½“ã€‚CMYKé¢œè‰²ç©ºé—´ä¸»è¦åº”ç”¨äºå°åˆ·ã€ç»˜ç”»ã€å¸ƒæ–™æŸ“è‰²ç­‰ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å›¾åƒä¸å±å¹•&quot;&gt;å›¾åƒä¸å±å¹•&lt;/h2&gt;
&lt;p&gt;ä¸€ä¸ªåƒç´ å¯ä»¥æœ‰ä¸¤å±‚å«ä¹‰ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>è§†é¢‘åŸºç¡€æŠ€æœ¯</title>
    <link href="https://bqlin.github.io/posts/basic_video_technology/"/>
    <id>https://bqlin.github.io/posts/basic_video_technology/</id>
    <published>2021-03-15T01:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>è§†é¢‘æ˜¯ä»€ä¹ˆï¼š</p><ul><li><p>è§†é¢‘ç”±ä¸€ç»„<strong>å›¾åƒ</strong>ç»„æˆï¼›</p><ul><li>è§†é¢‘çš„åŸºæœ¬å•å…ƒæ˜¯å›¾åƒã€‚</li></ul></li><li><p>ä¸ºäº†ä¼ è¾“ã€å ç”¨æ›´å°çš„ç©ºé—´ï¼Œå¸¸å¸¸è¢«<strong>å‹ç¼©</strong>å­˜å‚¨ä¸ä¼ è¾“ï¼›</p></li><li><p>æœ€ç»ˆéœ€è¦è§£å‹ä½å›¾åƒåœ¨<strong>æ˜¾ç¤ºè®¾å¤‡</strong>ä¸Šå±•ç¤ºã€‚</p></li></ul><h2 id="ç æµè®¡ç®—">ç æµè®¡ç®—</h2><ul><li><p>åˆ†è¾¨ç‡ã€‚Xè½´åƒç´ ä¸ªæ•°Ã—Yè½´åƒç´ ä¸ªæ•°ã€‚</p></li><li><p>é¢œè‰²åˆ†é‡ï¼ˆåˆ†é‡ä¸ªæ•°ã€åˆ†é‡å¤§å°ï¼‰</p></li><li><p>å¸§ç‡ã€‚æ¯ç§’é‡‡é›†/æ’­æ”¾å›¾åƒçš„ä¸ªæ•°ã€‚</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æœªç¼–ç è§†é¢‘çš„RGBç æµ</span><br><span class="line">= å®½Ã—é«˜ // åˆ†è¾¨ç‡</span><br><span class="line">Ã—3 // é¢œè‰²åˆ†é‡ï¼Œæ¯ä¸ªåƒç´ 3å­—èŠ‚å¤§å°</span><br><span class="line">Ã—å¸§ç‡</span><br><span class="line">(Ã—8 // æŒ‰ä½è®¡ç®—)</span><br></pre></td></tr></table></figure><h2 id="ç¼–ç è§£ç è½¬ç ">ç¼–ç ã€è§£ç ã€è½¬ç </h2><h3 id="ç¼–ç encode">ç¼–ç ï¼ˆencodeï¼‰</h3><p>é€šè¿‡ç‰¹å®šçš„å‹ç¼©æŠ€æœ¯ï¼Œå°†æŸä¸ªè§†é¢‘çš„è§†é¢‘æµæ ¼å¼è½¬æ¢æˆå¦ä¸€ç§è§†é¢‘æ ¼å¼çš„è§†é¢‘æµæ–¹å¼ã€‚</p><p>è§†é¢‘ï¼š</p><ul><li>YUV420/422 -&gt; H264</li><li>RGB888 -&gt; H264</li><li>YUV420 -&gt; H265</li></ul><p>éŸ³é¢‘ï¼š</p><ul><li>PCM -&gt; AAC</li><li>PCM -&gt; G726</li><li>PCM -&gt; G711</li></ul><h3 id="è§£ç decode">è§£ç ï¼ˆdecodeï¼‰</h3><p>é€šè¿‡ç‰¹å®šçš„è§£å‹ç¼©æŠ€æœ¯ï¼Œå°†æŸä¸ªè§†é¢‘æ ¼å¼çš„è§†é¢‘æµè½¬æ¢æˆå¦ä¸€ç§è§†é¢‘æ ¼å¼çš„è§†é¢‘æµæ–¹å¼ã€‚</p><p>è§†é¢‘ç¼–ç é’ˆå¯¹å›¾ç‰‡åºåˆ—</p><p>è§†é¢‘ï¼š</p><ul><li>H264 -&gt; YUV420/422</li><li>H264 -&gt; RGB888</li><li>H265 -&gt; YUV420</li></ul><p>éŸ³é¢‘ï¼š</p><ul><li>AAC -&gt; PCM</li><li>G726 -&gt; PCM</li><li>G711 -&gt; PCM</li></ul><p>è½¬ç ï¼ˆtranscodeï¼‰ï¼šè§†é¢‘è½¬ç æŠ€æœ¯å°†è§†é¢‘ä¿¡å·ä»ä¸€ç§æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§æ ¼å¼ã€‚</p><h3 id="è½¬ç ">è½¬ç </h3><p>è§†é¢‘ï¼š</p><ul><li><p>æ”¹å˜åˆ†è¾¨ç‡ï¼ˆresolutionï¼‰</p></li><li><p>æ”¹å˜å¸§ç‡ï¼ˆframe rateï¼‰</p></li><li><p>æ”¹å˜æ¯”ç‰¹ç‡ï¼ˆbit rateï¼‰ç­‰ç¼–ç å‚æ•°</p></li></ul><p>éŸ³é¢‘ï¼š</p><ul><li><p>æ”¹å˜é‡‡æ ·ç‡ï¼ˆsample rateï¼‰</p></li><li><p>æ”¹å˜é€šé“æ•°ï¼ˆchannelsï¼‰</p></li><li><p>æ”¹å˜ä½å®½ï¼ˆsample formatï¼‰</p></li></ul><h2 id="å°è£…è§£å°è£…">å°è£…ã€è§£å°è£…</h2><p>å°è£…ï¼ˆmuxï¼‰ï¼šå¤ç”¨ï¼ŒæŒ‰ä¸€å®šæ ¼å¼ç»„ç»‡åŸéŸ³è§†é¢‘æµ</p><p>è§£å°è£…ï¼ˆdemuxï¼‰ï¼šåˆ†è§£ï¼Œè§£å¤ç”¨ï¼ŒæŒ‰ä¸€å®šæ ¼å¼è§£æå‡ºåŸå§‹éŸ³è§†é¢‘æµ</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;è§†é¢‘æ˜¯ä»€ä¹ˆï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;è§†é¢‘ç”±ä¸€ç»„&lt;strong&gt;å›¾åƒ&lt;/strong&gt;ç»„æˆï¼›&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è§†é¢‘çš„åŸºæœ¬å•å…ƒæ˜¯å›¾åƒã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ä¸ºäº†ä¼ è¾“ã€å ç”¨æ›´å°çš„ç©ºé—´ï¼Œå¸¸å¸¸è¢«&lt;strong&gt;å‹ç¼©&lt;/strong&gt;å­˜å‚¨ä¸ä¼ è¾“ï¼›&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;æœ€ç»ˆéœ€è¦è§£å‹ä½å›¾åƒåœ¨&lt;strong&gt;æ˜¾ç¤ºè®¾å¤‡&lt;/strong&gt;ä¸Šå±•ç¤ºã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>AAC ç¼–è§£ç å™¨</title>
    <link href="https://bqlin.github.io/posts/aac/"/>
    <id>https://bqlin.github.io/posts/aac/</id>
    <published>2021-03-15T00:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç¼–ç è§„æ ¼">ç¼–ç è§„æ ¼</h2><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615773129050-3a7142f2-f0e9-451c-b9b9-22716478e3b7.png" /></p><ul><li><p>AAC LCï¼š<strong>Low Complexity</strong>ã€‚ä½å¤æ‚åº¦è§„æ ¼ï¼Œç æµæ˜¯ 128kï¼ŒéŸ³è´¨å¥½ã€‚ä¸»è¦åº”ç”¨äºä¸­é«˜ç¼–ç ç‡çš„åœºæ™¯ç¼–ç ï¼ˆ&gt;= 80Kbit/sï¼‰ã€‚</p></li><li><p>AAC HE V1ï¼šAAC LC + <strong>SBRï¼ˆSpectral Band Replicationï¼‰</strong>ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯æŒ‰é¢‘è°±ä¿å­˜ï¼Œä½é¢‘ç¼–ç ä¿å­˜ä¸»è¦éƒ¨åˆ†ï¼Œé«˜é¢‘å•ç‹¬æ”¾å¤§ç¼–ç ä¿å­˜éŸ³è´¨ã€‚ç æµåœ¨ 64k å·¦å³ã€‚ä¸»è¦åº”ç”¨äºä½ç ç‡çš„ç¼–ç ï¼ˆ&lt;= 48Kbit/sï¼‰</p></li><li><p>AAC HE V2ï¼šAAC LC + SBR + <strong>PSï¼ˆParametric Stereoï¼‰</strong>ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯åŒå£°é“ä¸­çš„å£°éŸ³å­˜åœ¨æŸç§ç›¸ä¼¼åº¦ï¼Œåªéœ€å­˜å‚¨ä¸€ä¸ªå£°é“çš„å…¨éƒ¨ä¿¡æ¯ï¼Œç„¶åï¼ŒèŠ±å¾ˆå°‘çš„å­—èŠ‚ç”¨å‚æ•°æè¿°å¦ä¸€ä¸ªå£°é“å’Œå®ƒä¸åŒçš„åœ°æ–¹ã€‚</p></li></ul><p>ä¸€èˆ¬ç æµè¶Šå¤§ï¼Œå…¶ä¿çœŸåº¦è¶Šé«˜ã€‚ç æµè¶Šå°ï¼Œå‹ç¼©æ¯”é«˜ï¼Œå»é™¤çš„å†—ä½™ä¿¡æ¯å°±å¤šï¼Œå…¶å°±ä¼šå¯¹å£°éŸ³é€ æˆä¸€å®šçš„æŸå¤±ã€‚</p><h2 id="ç¼–ç æ ¼å¼">ç¼–ç æ ¼å¼</h2><h4 id="adifaudio-data-interchange-format">ADIFï¼ˆAudio Data Interchange Formatï¼‰</h4><p>å¯ä»¥ç¡®å®šåœ°æ‰¾åˆ°è¿™ä¸ªéŸ³é¢‘æ•°æ®çš„å¼€å§‹ï¼Œç›¸å½“äº AAC æ•°æ®åŠ ä¸Šæ•°æ®å¤´ã€‚åªèƒ½ä»å¤´å¼€å§‹è§£ç ï¼Œä¸èƒ½åœ¨éŸ³é¢‘æ•°æ®æµä¸­é—´å¼€å§‹ã€‚åº”ç”¨äºç£ç›˜æ–‡ä»¶ã€‚</p><h4 id="adtsaudio-data-transport-stream">ADTSï¼ˆAudio Data Transport Streamï¼‰</h4><p>æ¯ä¸€å¸§éƒ½æœ‰ä¸€ä¸ªåŒæ­¥å­—ï¼Œæ‰€ä»¥å¯ä»¥åœ¨éŸ³é¢‘æµçš„ä»»æ„ä½ç½®å¼€å§‹è§£ç ã€‚ä¼šæ¯” ADIF çš„æ•°æ®å¤§ã€‚åº”ç”¨äºæµåª’ä½“ã€‚</p><h3 id="adts-ç»“æ„">ADTS ç»“æ„</h3><p>ADTSç”±7æˆ–9ä¸ªå­—èŠ‚ç»„æˆï¼Œä½†å…¶å­—æ®µæ’åˆ—æ˜¯æŒ‰ç…§ä½æ¥æ’åˆ—ã€‚ä»¥ä¸‹æ¯æ®µï¼ˆå³å›¾çš„ä¸€è¡Œï¼‰æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼ˆ8ä½ï¼‰ï¼Œæ¯ä¸ªå­—æ¯è¡¨ç¤ºä¸€ä½ï¼ˆ0/1ï¼‰ï¼Œæ¯å››ä½å¯ç”¨ä¸€ä¸ªåå…­è¿›åˆ¶è¡¨ç¤ºã€‚</p><p>äºŒè¿›åˆ¶è¡¨ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AAAAAAAA AAAABCCD EEFFFFGH HHIJKLMM MMMMMMMM MMMOOOOO OOOOOOPP (QQQQQQQQ QQQQQQQQ)</span><br></pre></td></tr></table></figure><p>Header consists of 7 or 9 bytes (without or with CRC).</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1622170367857-03c1ed4e-cb1e-49fd-b9c0-b06137675a3f.png" /></p><table><colgroup><col style="width: 7%" /><col style="width: 16%" /><col style="width: 75%" /></colgroup><thead><tr class="header"><th>Letter</th><th>Length (bits)</th><th>Description</th></tr></thead><tbody><tr class="odd"><td>A</td><td>12</td><td>syncword 0xFFF, all bits <strong>must</strong> be 1<br />åŒæ­¥å­—ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸ª ADTS æ•°æ®ï¼Œéƒ½ä¸º1ã€‚</td></tr><tr class="even"><td>B</td><td>1</td><td>MPEG Version: 0 for MPEG-4, 1 for MPEG-2<br />ä½¿ç”¨çš„ç¼–ç è§„èŒƒã€‚</td></tr><tr class="odd"><td>C</td><td>2</td><td>Layer: always 0</td></tr><tr class="even"><td>D</td><td>1</td><td>protection absent, <strong>Warning</strong>, set to 1 if there is no CRC and 0 if there is CRC<br />å†³å®šæ˜¯7ä½è¿˜æ˜¯9ä½ã€‚</td></tr><tr class="odd"><td>E</td><td>2</td><td>profile, the <a href="https://wiki.multimedia.cx/index.php/MPEG-4_Audio#Audio_Object_Types">MPEG-4 Audio Object Type</a> minus 1 ä½¿ç”¨çš„ç¼–ç è§„æ ¼â†‘ã€‚</td></tr><tr class="even"><td>F</td><td>4</td><td><a href="https://wiki.multimedia.cx/index.php/MPEG-4_Audio#Sampling_Frequencies">MPEG-4 Sampling Frequency Index</a> (15 is forbidden)<br />é‡‡æ ·ç‡</td></tr><tr class="odd"><td>G</td><td>1</td><td>private bit, guaranteed never to be used by MPEG, set to 0 when encoding, ignore when decoding</td></tr><tr class="even"><td>H</td><td>3</td><td><a href="https://wiki.multimedia.cx/index.php/MPEG-4_Audio#Channel_Configurations">MPEG-4 Channel Configuration</a> (in the case of 0, the channel configuration is sent via an inband PCE)</td></tr><tr class="odd"><td>I</td><td>1</td><td>originality, set to 0 when encoding, ignore when decoding</td></tr><tr class="even"><td>J</td><td>1</td><td>home, set to 0 when encoding, ignore when decoding</td></tr><tr class="odd"><td>K</td><td>1</td><td>copyrighted id bit, the next bit of a centrally registered copyright identifier, set to 0 when encoding, ignore when decoding</td></tr><tr class="even"><td>L</td><td>1</td><td>copyright id start, signals that this frame's copyright id bit is the first bit of the copyright id, set to 0 when encoding, ignore when decoding</td></tr><tr class="odd"><td>M</td><td>13</td><td>frame length, this value must include 7 or 9 bytes of header length: FrameLength = (ProtectionAbsent == 1 ? 7 : 9) + size(AACFrame)</td></tr><tr class="even"><td>O</td><td>11</td><td>Buffer fullness</td></tr><tr class="odd"><td>P</td><td>2</td><td>Number of AAC frames (RDBs) in ADTS frame <strong>minus 1</strong>, for maximum compatibility always use 1 AAC frame per ADTS frame</td></tr><tr class="even"><td>Q</td><td>16</td><td>CRC if <em>protection absent</em> is 0</td></tr></tbody></table><p>è¿™äº›å€¼ä¸€èˆ¬ä¸æ˜¯å…·ä½“çš„æ•°å€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªçº¦å®šçš„ç¼–å·ï¼Œæ ¹æ®ç¼–å·è·å¾—å…¶å¯¹åº”å…·ä½“æ•°å€¼ã€‚</p><p>å¯ä»¥æ ¹æ®<a href="https://www.p23.nl/projects/aac-header/">è¯¥å·¥å…·</a>ï¼Œè¾“å…¥å¯¹åº”çš„ ADTS å¤´ï¼Œå°±å¯ä»¥è§£æå‡ºå…·ä½“çš„å«ä¹‰ã€‚</p><p>å¯è§ï¼Œæ‰¾åˆ°ä¸€ä¸ªåŒæ­¥å­—<code>0xFFF</code>å³æ‰¾åˆ°ä¸€ä¸ªADTSçš„å¼€å¤´ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç¼–ç è§„æ ¼&quot;&gt;ç¼–ç è§„æ ¼&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/bqlin/image-land/raw/master/1615773129050-3a7142f2-f0e9-451c-b9b9-22716478e3b7.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>å¸¸è§éŸ³é¢‘æ ¼å¼</title>
    <link href="https://bqlin.github.io/posts/common_audio_formats/"/>
    <id>https://bqlin.github.io/posts/common_audio_formats/</id>
    <published>2021-03-14T23:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç”µè§†å¹¿æ’­ç¦»ä¸å¼€å£°éŸ³ä¿¡å·ï¼Œéšç€äººä»¬å¯¹ç”µè§†è´¨é‡çš„è¦æ±‚è¶Šæ¥è¶Šé«˜ï¼Œåœ¨æ•°å­—ç”µè§†å¹¿æ’­ã€é«˜æ¸…æ™°æ•°å­—ç”µè§†å’Œæ•°å­—ç”µå½±ä¸­ä¸ä»…åº”æœ‰é«˜è´¨é‡çš„å›¾åƒï¼Œè¿˜è¦ä¿è¯æœ‰é«˜è´¨é‡çš„ä¼´éŸ³ã€‚</p><p>éŸ³é¢‘æ–‡ä»¶æ ¼å¼å¾€å¾€åŒ…å«äº†å¯¹éŸ³é¢‘ç¼–ç æ ¼å¼çš„è¡¨è¾¾ï¼Œä¸¤è€…ä¸€èˆ¬æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œæˆ–è€…è¯´éŸ³é¢‘æ–‡ä»¶æ ¼å¼ä¹Ÿæ˜¯éŸ³é¢‘ç¼–ç æ ¼å¼ã€‚</p><h2 id="pcm">PCM</h2><p>PCM (PulseCode Modulation) è¢«ç§°ä¸ºè„‰ç ç¼–ç è°ƒåˆ¶ã€‚PCMä¸­çš„å£°éŸ³æ•°æ®æ²¡æœ‰è¢«å‹ç¼©ï¼Œå¦‚æœæ˜¯å•å£°é“çš„æ–‡ä»¶ï¼Œé‡‡æ ·æ•°æ®æŒ‰æ—¶é—´çš„å…ˆåé¡ºåºä¾æ¬¡å­˜å…¥(å®ƒçš„åŸºæœ¬ç»„ç»‡å•ä½æ˜¯BYTE(8bit)æˆ–WORD(16bit))ï¼Œå¦‚æœæ˜¯åŒå£°é“çš„æ–‡ä»¶ï¼Œé‡‡æ ·æ•°æ®æŒ‰æ—¶é—´å…ˆåé¡ºåºäº¤å‰åœ°å­˜å…¥ã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p><figure><img src="https://gitee.com/bqlin/image-land/raw/master/pcm_storage.png" alt="PCMå­˜å‚¨æ–¹å¼" /><figcaption aria-hidden="true">PCMå­˜å‚¨æ–¹å¼</figcaption></figure><p>PCMçš„æ¯ä¸ªæ ·æœ¬å€¼åŒ…å«åœ¨ä¸€ä¸ªæ•´æ•°iä¸­ï¼Œiçš„é•¿åº¦ä¸ºå®¹çº³æŒ‡å®šæ ·æœ¬é•¿åº¦æ‰€éœ€çš„æœ€å°å­—èŠ‚æ•°ã€‚8ä½å’Œ16ä½çš„PCMæ³¢å½¢æ ·æœ¬çš„æ•°æ®æ ¼å¼ï¼š</p><table><thead><tr class="header"><th>æ ·æœ¬å¤§å°</th><th>æ•°æ®æ ¼å¼</th><th>æœ€å°å€¼</th><th>æœ€å¤§å€¼</th></tr></thead><tbody><tr class="odd"><td>8bit PCM</td><td>unsigned int</td><td>0</td><td>255</td></tr><tr class="even"><td>16bit PCM</td><td>int</td><td>-32768</td><td>32767</td></tr></tbody></table><p>PCMæ²¡æœ‰ä¿å­˜å…ƒæ•°æ®ä¿¡æ¯ï¼Œæ’­æ”¾æ—¶è¦å‡†ç¡®æŒ‡å®šé‡‡æ ·æ ¼å¼ã€é‡‡æ ·ç‡å’Œå£°é“æ‰èƒ½æ’­æ”¾ã€‚</p><h2 id="wav">WAV</h2><p>å®ç°æ–¹å¼å¾ˆå¤šï¼Œåœ¨åŸ PCM æ•°æ®æ ¼å¼å‰é¢åŠ ä¸Š 44 å­—èŠ‚å…ƒæ•°æ®æè¿° PCMï¼šé‡‡æ ·ç‡ã€å£°é“æ•°ã€æ•°æ®æ ¼å¼ç­‰ã€‚</p><p>ç‰¹ç‚¹ï¼šä¿ç•™åŸå§‹PCMï¼ŒéŸ³è´¨å¥½ï¼Œå¤§é‡è½¯ä»¶éƒ½æ”¯æŒï¼›</p><p>é€‚åˆåœºæ™¯ï¼šé«˜æ¯”ç‰¹ç‡ä¸‹å¯¹å…¼å®¹æ€§æœ‰è¦æ±‚çš„éŸ³ä¹æ¬£èµã€‚</p><p>WAVæ ¼å¼ç¬¦åˆèµ„æºäº¤æ¢æ–‡ä»¶æ ¼å¼(RIFFï¼ŒResourceInterchange File Format)è§„èŒƒã€‚WAVæ–‡ä»¶åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šå¤´ä¿¡æ¯å’ŒPCMéŸ³é¢‘æ•°æ®ã€‚</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615772960502-9cc13cf5-f355-467b-98e7-ff90a3db7246.png" /></p><h2 id="æœ‰æŸå‹ç¼©ç¼–ç æ ¼å¼">æœ‰æŸå‹ç¼©ç¼–ç æ ¼å¼</h2><h3 id="mp3">MP3</h3><p>MP3ï¼ŒMPEG-1 Audio Layer IIIï¼Œä¹Ÿå¯ä»¥æ˜¯MPEG-2 Audio Layer IIIã€‚</p><p>æŠ€æœ¯ç»†èŠ‚ï¼š</p><ul><li>ä½¿ç”¨MDCTç®—æ³•ï¼Œä¿®æ­£äº†DCTç®—æ³•ä¸Šçš„ä¸€äº›ç¼ºé™·ã€‚</li><li>ä½¿ç”¨å£°å­¦å¿ƒç†æ¨¡å‹ï¼š<ul><li>äººè€³å¬è§‰èŒƒå›´æ˜¯20Hzï½20kHzï¼Œå»æ‰é«˜é¢‘ä¿¡æ¯ï¼›</li><li>äººè€³å¯¹2000Hzï½5000Hzæœ€çµæ•ï¼Œä¸¤ç«¯ä¸‹é™æ¯”è¾ƒå‰å®³ï¼Œå°¤å…¶æ˜¯é«˜é¢‘ï¼Œåœ¨å»æ‰éƒ¨åˆ†é«˜é¢‘ä¿¡æ¯ï¼›</li><li>äººè€³æœ‰é®è”½æ•ˆåº”ï¼Œå»æ‰é¢‘åŸŸå’Œæ—¶åŸŸé®è”½çš„éƒ¨åˆ†ï¼›</li></ul></li><li>ä½¿ç”¨å“ˆå¤«æ›¼ç¼–ç å‹ç¼©éŸ³é¢‘æ•°æ®ã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>CBRç¼–ç å¯¹20kHzä»¥ä¸Šçš„å£°éŸ³ä¸€åˆ€åˆ‡ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨VBRè§„é¿ã€‚</li><li>æœ€åˆä½¿ç”¨çš„ID3æ ‡ç­¾æ²¡æœ‰ç»Ÿä¸€çš„æ–‡æœ¬ç¼–ç ã€‚ID3 v2å¯¹æ­¤åšäº†ä¿®æ­£ã€‚</li><li>å¤šå£°é“æ”¯æŒè¾ƒå·®ã€‚éä¸»æµçš„MPEG-2 Audio Layer IIIæ‰æ”¯æŒäº†5.1å£°é“ã€‚</li></ul><h3 id="aac">AAC</h3><p>AACï¼ŒAdvanced Audio Codingã€‚ä¸ºäº†å–ä»£MP3ã€‚ç›®å‰è¾ƒçƒ­é—¨çš„æœ‰æŸå‹ç¼©ç¼–ç æŠ€æœ¯ï¼Œè¡ç”Ÿäº† LC-AACã€HE-AACã€HE-AAC v2 è¿™ä¸‰ç§ä¸»è¦ç¼–ç æ ¼å¼ã€‚</p><p>ç‰¹ç‚¹ï¼šåœ¨å°äº 128Kbit/s çš„ç ç‡ä¸‹è¡¨ç°ä¼˜å¼‚ï¼Œå¹¶ä¸”å¤šç”¨äºè§†é¢‘ä¸­çš„éŸ³é¢‘ç¼–ç ã€‚</p><p>é€‚ç”¨åœºæ™¯ï¼š128Kbit/s ä»¥ä¸‹çš„éŸ³é¢‘ç¼–ç ï¼Œå¤šç”¨äºè§†é¢‘ä¸­éŸ³é¢‘è½¨çš„ç¼–ç ã€‚</p><p>æŠ€æœ¯ç»†èŠ‚ï¼š</p><ul><li>ä½¿ç”¨äº†å®Œæ•´çš„MDCTç®—æ³•ï¼Œç¼–ç æ•ˆç‡ä¸Šæ›´èƒœä¸€ç­¹ã€‚ä¸€èˆ¬åŒç­‰ç ç‡ä¸‹ï¼ŒAACè´¨é‡æ¯”MP3æ›´å¥½ä¸€äº›ã€‚</li><li>æ”¯æŒæ›´å¤§çš„é‡‡æ ·ç‡ï¼ˆ16ï½48kHz=&gt;8~96kHzï¼‰ã€‚</li><li>æ”¯æŒé«˜è¾¾48ä¸ªå£°é“ã€‚</li><li>å¯¹é¢‘ç‡é«˜äº16kHzçš„éŸ³è´¨æ›´å¥½ã€‚</li></ul><h3 id="ogg">Ogg</h3><p>Oggæ˜¯Vorbisç¼–ç çš„å®¹å™¨ã€‚</p><ul><li>éå¸¸æœ‰æ½œåŠ›ï¼Œå„ç§ç ç‡ä¸‹éƒ½æœ‰æ¯”è¾ƒä¼˜ç§€çš„è¡¨ç°ã€‚</li><li>å°¤å…¶åœ¨ä½ç ç‡æƒ…å†µä¸‹ï¼Œç¼–ç ç®—æ³•å‡ºè‰²ï¼Œå¯ä»¥ç”¨æ›´å°ç ç‡è¾¾åˆ°æ›´å¥½çš„éŸ³è´¨ã€‚</li></ul><p>ç‰¹ç‚¹ï¼šå¯ä»¥ç”¨æ¯”MP3æ›´å°çš„ç ç‡å®ç°æ¯”MP3æ›´å¥½çš„éŸ³è´¨ï¼Œé«˜ä¸­ä½ç ç‡ä¸‹å‡æœ‰è‰¯å¥½çš„è¡¨ç°ï¼Œå…¼å®¹ä¸å¤Ÿå¥½ï¼Œæµåª’ä½“ç‰¹æ€§ä¸æ”¯æŒã€‚</p><p>ä½¿ç”¨åœºæ™¯ï¼šè¯­è¨€èŠå¤©çš„éŸ³é¢‘æ¶ˆæ¯åœºæ™¯</p><p>æŠ€æœ¯ç»†èŠ‚ï¼š</p><p>åŸºäºMDCTæ—¶é¢‘è½¬æ¢ï¼Œç„¶åé€šè¿‡å¿ƒç†å£°å­¦è¿›è¡Œé¢‘æ®µèˆå¼ƒã€‚åç»­ä½¿ç”¨çŸ¢é‡é‡åŒ–ç®—æ³•ï¼Œä½¿å¾—åœ¨ä½ç ç‡ä¸‹æœ‰ç€å¾ˆå¥½çš„è¡¨ç°ï¼Œæ¥è¿‘AAC HEï¼Œä½†è¿˜æ²¡èƒ½è¶…è¶Šã€‚</p><h3 id="opus">Opus</h3><ul><li>ç¼–ç æ¯”Vorbisæ›´å¥½çš„ä½ç ç‡è¡¨ç°ï¼Œå¹¶åœ¨åŒç ç‡ä¸‹è¶…è¶Šäº†AAC HEã€‚</li><li>ä½å»¶æ—¶ã€‚ä½¿å¾—åœ¨æ•°å­—è¯­éŸ³é€šä¿¡é¢†åŸŸä¸­åº”ç”¨å¹¿æ³›ã€‚</li></ul><h3 id="ac-3">AC-3</h3><p>AC-3ï¼ŒDolby Digitalã€‚</p><ul><li>é¦–ä¸ªä½¿ç”¨MDCTç®—æ³•è¿›è¡Œå‹ç¼©çš„ç¼–ç ï¼ŒåŒæ—¶è¿˜ä½¿ç”¨éŸ³é¢‘å¿ƒç†å­¦ç ”ç©¶æˆæœå¯¹å‹ç¼©ç®—æ³•è¿›è¡Œä¼˜åŒ–ï¼Œä½¿å¾—æœ€ç»ˆå‹ç¼©åçš„äº§ç‰©ä»æ‹¥æœ‰å½±é™¢åŸºæœ¬æ•ˆæœã€‚</li><li>DDç¼–ç ä¸€èˆ¬æœ‰6ä¸ªå£°é“ï¼Œç§°ä¸ºDD 5.1ã€‚</li><li>å…ƒæ•°æ®ä¸­å¸¦æœ‰å¯¹è§£ç è¿‡ç¨‹è¿›è¡Œæ§åˆ¶çš„ç›¸å…³ä¿¡æ¯ï¼Œä½¿å¾—å®ƒåœ¨æ”¯æŒçš„æ’­æ”¾å™¨ä¸Šå¯ä»¥è¿˜åŸå‡ºåˆ¶ç‰‡æ–¹æƒ³è¦çš„æ•ˆæœã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>åªæ”¯æŒå›ºå®šç ç‡ç¼–ç ï¼Œä½¿å¾—ç ç‡æ¯”è¾ƒé«˜ã€‚</li></ul><p>å‡çº§ç‰ˆæœ¬ï¼šE-AC-3ï¼ŒDolby Digital Plusã€‚</p><h3 id="dts">DTS</h3><p>Dolbyçš„ç«äº‰å¯¹æ‰‹ã€‚</p><p>é€‰æ‹©ADPCMä½œä¸ºç®—æ³•åŸºç¡€ï¼Œé‡‡ç”¨è‡ªé€‚åº”é‡‡æ ·å¤§å°è®°å½•ç”µå¹³å€¼ã€‚å¯¹å­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ã€‚åŒæ—¶ï¼Œç›¸å¯¹äºä½¿ç”¨MDCTç®—æ³•ç®—å‡ºä¸åŒé¢‘ç‡æ®µå†ç æ‰äººè€³ä¸æ•æ„Ÿéƒ¨åˆ†çš„åšæ³•ï¼ŒåŸºäºAFPCMçš„ç®—æ³•è™½å‹ç¼©æ¯”ä½ä¸€äº›ï¼Œä½†å¯¹å£°éŸ³ç»†èŠ‚ä¿ç•™å¾—æ›´å¥½ã€‚</p><p>ä½†ä¹Ÿæ˜¯å› ä¸ºä½¿ç”¨è‡ªé€‚åº”é‡‡æ ·å¤§å°ï¼Œä½¿å¾—ä½“ç§¯æ§åˆ¶æ¯”DDè¦å·®ä¸€äº›ï¼Œè¿™é™åˆ¶äº†å®ƒçš„ä½¿ç”¨ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>å¤§éƒ¨åˆ†ç¼–ç æ ¼å¼éƒ½æ˜¯åŸºäºPCMè¿›è¡Œæ— æŸã€æœ‰æŸçš„å‹ç¼©ç¼–ç ã€‚ä½¿ç”¨çš„ç¼–ç æŠ€æœ¯éƒ½æ˜¯ç±»ä¼¼çš„ã€‚æœ‰æŸå‹ç¼©ç¼–ç åŸºäºMDCTï¼Œç„¶åç»è¿‡å¿ƒç†å£°å­¦æ¨¡å‹å–å‡ºäººè€³ä¸æ•æ„Ÿçš„ä¿¡æ¯ï¼Œæœ€åç»è¿‡å“ˆå¤«æ›¼ç¼–ç å‹ç¼©ã€‚æ— æŸå‹ç¼©ç¼–ç éƒ½æ˜¯åŸºäºçº¿æ€§é¢„æµ‹ç¼–ç ã€‚ä¸åŒçš„æ ¼å¼å¯èƒ½æ›´å¤šæ˜¯æœºæ„ã€å‚å•†ç«äº‰çš„äº§ç‰©ã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://blog.xinoassassin.me/2019/11/Audio-Codecs/">éŸ³é¢‘ç¼–ç å˜è¿å½•</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç”µè§†å¹¿æ’­ç¦»ä¸å¼€å£°éŸ³ä¿¡å·ï¼Œéšç€äººä»¬å¯¹ç”µè§†è´¨é‡çš„è¦æ±‚è¶Šæ¥è¶Šé«˜ï¼Œåœ¨æ•°å­—ç”µè§†å¹¿æ’­ã€é«˜æ¸…æ™°æ•°å­—ç”µè§†å’Œæ•°å­—ç”µå½±ä¸­ä¸ä»…åº”æœ‰é«˜è´¨é‡çš„å›¾åƒï¼Œè¿˜è¦ä¿è¯æœ‰é«˜è´¨é‡çš„ä¼´éŸ³ã€‚&lt;/p&gt;
&lt;p&gt;éŸ³é¢‘æ–‡ä»¶æ ¼å¼å¾€å¾€åŒ…å«äº†å¯¹éŸ³é¢‘ç¼–ç æ ¼å¼çš„è¡¨è¾¾ï¼Œä¸¤è€…ä¸€èˆ¬æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œæˆ–è€…è¯´éŸ³é¢‘æ–‡ä»¶æ ¼å¼ä¹Ÿæ˜¯éŸ³é¢‘ç¼–ç æ ¼å¼ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>éŸ³é¢‘åŸºç¡€æŠ€æœ¯</title>
    <link href="https://bqlin.github.io/posts/audio_basic_technology/"/>
    <id>https://bqlin.github.io/posts/audio_basic_technology/</id>
    <published>2021-03-14T22:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="äººè€³å¬è§‰èŒƒå›´">äººè€³å¬è§‰èŒƒå›´</h2><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615773041050-3cf23e1f-cd52-469b-b648-de0888eeed57.png" /></p><p>æ¬¡å£°æ³¢ï¼Œå¬è§‰èŒƒå›´ï¼š20Hz~20kHzï¼Œè¶…å£°æ³¢</p><p>Hzï¼Œèµ«å…¹ï¼Œä¸€ç§’å†…æŒ¯åŠ¨çš„æ¬¡æ•°ã€‚</p><p>äººå‘å£°èŒƒå›´ï¼š85Hz~1100Hz</p><h2 id="å£°éŸ³ä¸‰è¦ç´ ">å£°éŸ³ä¸‰è¦ç´ </h2><ul><li>éŸ³è°ƒï¼ˆé¢‘ç‡ï¼‰ï¼šéŸ³é¢‘çš„å¿«æ…¢ã€‚ç”·ç”Ÿ &gt; å¥³ç”Ÿ &gt; å„¿ç«¥</li><li>éŸ³é‡ï¼ˆå¼ºåº¦ï¼‰ï¼šæŒ¯åŠ¨çš„å¹…åº¦</li><li>éŸ³è‰²ï¼šè°æ³¢</li></ul><h3 id="éŸ³è°ƒé¢‘ç‡">éŸ³è°ƒï¼ˆé¢‘ç‡ï¼‰</h3><p>åœ¨ä¸€ä¸ªæ³¢ä¸­ï¼Œå‘¨æœŸæ˜¯å®Œæˆä¸€ä¸ªå‘¨æœŸæ‰€éœ€çš„æ—¶é—´ï¼Œé¢‘ç‡æ˜¯å‘¨æœŸçš„å€’æ•°ï¼Œä»¥èµ«å…¹è¡¨ç¤ºæ¯ç§’å‘¨æœŸæ•°ã€‚ä»æœ¬è´¨ä¸Šè¯´ï¼Œå®Œæˆä¸€ä¸ªå‘¨æœŸæ‰€éœ€çš„æ—¶é—´è¶ŠçŸ­ï¼Œé¢‘ç‡è¶Šé«˜ï¼›ä»è§†è§‰ä¸Šçœ‹ï¼Œå³°å€¼å½¼æ­¤é è¿‘çš„æ³¢æ¯”å³°å€¼è¿œçš„æ³¢å…·æœ‰æ›´é«˜çš„é¢‘ç‡ã€‚è™½ç„¶é¢‘ç‡æè¿°äº†æ³¢å½¢å¾ªç¯é‡å¤ç‡çš„æ•°å€¼åº¦é‡ï¼Œå•éŸ³è°ƒæ›´åƒæ˜¯æˆ‘ä»¬ç”¨æ¥æè¿°å£°éŸ³çš„ä¸»è§‚æœ¯è¯­ã€‚</p><h3 id="éŸ³é‡å¼ºåº¦">éŸ³é‡ï¼ˆå¼ºåº¦ï¼‰</h3><p>å¼ºåº¦æ˜¯ç†è§£å£°éŸ³æˆåˆ†çš„å¦ä¸€ä¸ªç»´åº¦ã€‚å£°éŸ³å¼ºåº¦æè¿°äº†å£°éŸ³åœ¨ä¸€ä¸ªåŒºåŸŸå†…ä½ç§»çš„å£°åŠŸç‡ï¼Œä»¥ç“¦ç‰¹/å¹³æ–¹ç±³ä¸ºå•ä½ã€‚å£°éŸ³çš„åŠŸç‡æ˜¯å£°éŸ³åœ¨æŸä¸ªå•ä½æ—¶é—´å†…ä¼ é€’èƒ½é‡çš„é€Ÿç‡ï¼Œå³å¼ºåº¦æœ¬è´¨ä¸Šæ˜¯å£°éŸ³ç½®æ¢çš„èƒ½é‡ã€‚</p><p>å¬è€…çš„æŒç»­æ—¶é—´ã€é¢‘ç‡å’Œå¹´é¾„ç­‰æ··æ‚å› ç´ ä¼šå½±å“å£°éŸ³çš„å“åº¦ã€‚</p><h3 id="éŸ³è‰²">éŸ³è‰²</h3><p>é“¶è‰²æè¿°äº†èµ‹äºˆå£°éŸ³ç‰¹å¾çš„å¤šç§å±æ€§ã€‚</p><h2 id="æ¨¡æ‹Ÿä¿¡å·æ•°å­—åŒ–è¿‡ç¨‹">æ¨¡æ‹Ÿä¿¡å·æ•°å­—åŒ–è¿‡ç¨‹</h2><p>æ¨¡æ‹ŸéŸ³é¢‘ä¿¡å·è½¬åŒ–ä¸ºæ•°å­—éŸ³é¢‘ä¿¡å·ï¼šæ¨¡æ‹ŸéŸ³é¢‘ä¿¡å·æ˜¯ä¸€ä¸ªåœ¨æ—¶é—´ä¸Šå’Œå¹…åº¦ä¸Šéƒ½è¿ç»­çš„ä¿¡å·ï¼Œå®ƒçš„æ•°å­—åŒ–è¿‡ç¨‹å¦‚ä¸‹æ‰€è¿°ã€‚</p><p>æ¨¡æ‹Ÿä¿¡å·æ•°å­—åŒ–çš„ç»“æœäº§ç‰©æ˜¯PCMæˆ–WAVæ–‡ä»¶ã€‚</p><h3 id="é‡‡æ ·">é‡‡æ ·</h3><p>åœ¨æ—¶é—´è½´ä¸Šå¯¹ä¿¡å·è¿›è¡Œæ•°å­—åŒ–ã€‚</p><p>æŒ‰ç…§å›ºå®šçš„æ—¶é—´é—´éš”æŠ½å–æ¨¡æ‹Ÿä¿¡å·çš„å€¼ï¼Œè¿™æ ·ï¼Œé‡‡æ ·åå°±å¯ä»¥ä½¿ä¸€ä¸ªæ—¶é—´è¿ç»­çš„ä¿¡æ¯æ³¢å˜ä¸ºåœ¨æ—¶é—´ä¸Šå–å€¼æ•°ç›®æœ‰é™çš„ç¦»æ•£ä¿¡å·ã€‚</p><p>é‡‡æ ·è¿‡ç¨‹å†³å®šé‡‡æ ·ç‡ï¼ˆsample rateï¼‰ã€‚</p><h3 id="é‡åŒ–">é‡åŒ–</h3><p>åœ¨å¹…åº¦è½´ä¸Šå¯¹ä¿¡å·è¿›è¡Œæ•°å­—åŒ–ã€‚ç”¨æœ‰é™ä¸ªå¹…åº¦å€¼è¿‘ä¼¼è¿˜åŸåŸæ¥è¿ç»­å˜åŒ–çš„å¹…åº¦å€¼ï¼ŒæŠŠæ¨¡æ‹Ÿä¿¡å·çš„è¿ç»­å¹…åº¦å˜ä¸ºæœ‰é™æ•°é‡çš„æœ‰ä¸€å®šé—´éš”çš„ç¦»æ•£å€¼ã€‚</p><p>é‡åŒ–è¿‡ç¨‹å†³å®šä½æ·±/é‡‡æ ·å¤§å°ï¼Œè¿™æ˜¯é€šè¿‡é‡‡æ ·æ ¼å¼ï¼ˆsample formatï¼‰ä½“ç°çš„ã€‚</p><h3 id="ç¼–ç ">ç¼–ç </h3><p>ç”¨äºŒè¿›åˆ¶æ•°è¡¨ç¤ºæ¯ä¸ªé‡‡æ ·çš„é‡åŒ–å€¼ï¼ˆåè¿›åˆ¶æ•°ï¼‰ã€‚</p><p>åŸå§‹éŸ³é¢‘æ•°æ®ï¼š</p><ul><li><p>PCMï¼Œè„‰å†²ç¼–ç è°ƒåˆ¶ã€‚</p><ul><li>çº¯ç²¹çš„éŸ³é¢‘æ•°æ®ï¼Œä¸å¸¦éŸ³é¢‘æ ¼å¼ã€‚æ‰€ä»¥PCMéŸ³é¢‘æµçš„ç ç‡è®¡ç®—æ–¹å¼å¦‚ä¸Šæ‰€è¿°ã€‚</li></ul></li><li><p>WAVï¼Œåœ¨PCMä¸Šæ·»åŠ éŸ³é¢‘ä¿¡æ¯çš„å¤´ã€‚</p><ul><li>ä½†é™¤äº†å­˜å‚¨PCMåŸå§‹æ•°æ®ï¼Œå®ƒè¿˜å¯ä»¥å­˜å‚¨å‹ç¼©æ•°æ®ã€‚</li><li>å¦‚ä¸‹å›¾å¯è§ï¼ŒWAVå­˜å‚¨çš„éŸ³é¢‘æ ¼å¼å°±æ˜¯é‡åŒ–çš„ä¿¡æ¯ï¼šé‡‡æ ·å¤§å°ã€é‡‡æ ·ç‡ã€å£°é“æ•°ã€‚</li></ul></li></ul><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615773052644-80b40cf3-456c-44e8-955c-f25777c8246f.png" /></p><p>ä¸Šè¿°çš„<strong>ç¼–ç </strong>æ˜¯æ¨¡æ•°è½¬æ¢è¿‡ç¨‹ä¸­çš„ç¼–ç æˆäºŒè¿›åˆ¶æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œæ³¨æ„ä¸<strong>éŸ³é¢‘ç¼–ç </strong>åˆ†å¼€ã€‚ä¸€èˆ¬æ‰€è¯´çš„éŸ³é¢‘ç¼–ç æ›´å¤šæ˜¯æŒ‡å¯¹éŸ³é¢‘çš„å‹ç¼©ã€‚</p><h3 id="å°ç»“">å°ç»“</h3><p>éŸ³é¢‘ç”±æ³¢å½¢ç»„æˆï¼ŒåŒ…æ‹¬ä¸åŒé¢‘ç‡å’ŒæŒ¯å¹…çš„æ³¢çš„å åŠ ã€‚ä¸ºäº†åœ¨æ•°å­—åª’ä½“å†…è¡¨ç¤ºè¿™äº›æ³¢å½¢ï¼Œéœ€è¦å¯¹æ³¢å½¢è¿›è¡Œé‡‡æ ·ï¼Œå…¶<strong>é‡‡æ ·ç‡</strong>éœ€è¦ï¼ˆè‡³å°‘ï¼‰å¯ä»¥è¡¨ç¤ºæ‚¨è¦å¤åˆ¶çš„æœ€é«˜é¢‘ç‡çš„å£°éŸ³ï¼›åŒæ—¶è¿˜éœ€è¦å­˜å‚¨è¶³å¤Ÿçš„<strong>ä½æ·±</strong>ï¼Œä»¥è¡¨ç¤ºå£°éŸ³æ ·æœ¬ä¸­æ³¢å½¢çš„é€‚å½“æŒ¯å¹…ï¼ˆå“åº¦å’ŒæŸ”åº¦ï¼‰ã€‚</p><ul><li><p>ä½æ·±/é‡‡æ ·å¤§å°ï¼šä¸€ä¸ªé‡‡æ ·ç”¨å¤šå°‘ bit å­˜æ”¾ã€‚èƒ½å¤Ÿè¡¨è¾¾çš„æ•°å€¼èŒƒå›´ã€‚ä½¿ç”¨8ä½ã€16ä½è¡¨è¾¾ã€‚</p><ul><li>ä½æ·±å½±å“ç»™å®šéŸ³é¢‘æ ·æœ¬çš„åŠ¨æ€èŒƒå›´ã€‚ä½æ·±è¶Šé«˜ï¼Œè¡¨ç¤ºçš„æŒ¯å¹…è¶Šç²¾ç¡®ã€‚å¦‚æœåœ¨åŒä¸€éŸ³é¢‘æ ·æœ¬å†…æœ‰å¾ˆå¤šå“äº®å’ŒæŸ”å’Œçš„å£°éŸ³ï¼Œåˆ™éœ€è¦æ›´å¤§çš„ä½æ·±æ‰èƒ½æ­£ç¡®è¡¨ç¤ºè¿™äº›å£°éŸ³ã€‚</li><li>å¢é«˜ä½æ·±è¿˜ä¼šé™ä½éŸ³é¢‘æ ·æœ¬å†…çš„ä¿¡å™ªæ¯”ã€‚CD éŸ³ä¹éŸ³é¢‘ä½¿ç”¨ 16 ä½çš„ä½æ·±ã€‚DVD éŸ³é¢‘ä½¿ç”¨ 24 ä½çš„ä½æ·±ï¼Œè€Œå¤§å¤šæ•°ç”µè¯è®¾å¤‡ä½¿ç”¨ 8 ä½çš„ä½æ·±ã€‚ï¼ˆæŸäº›å‹ç¼©æŠ€æœ¯å¯ä»¥è¡¥å¿è¾ƒå°ä½æ·±çš„ä¸è¶³ï¼Œä½†å¾€å¾€ä¼šæœ‰æŸè€—ã€‚ï¼‰</li></ul></li><li><p>é‡‡æ ·ç‡ï¼šé‡‡æ ·é¢‘ç‡ï¼Œå³ä¸€ç§’å†…é‡‡æ ·çš„ä¸ªæ•°ã€‚8kã€16kã€32kã€44.1kã€48kã€‚è¶Šé«˜è¶Šç²¾ç»†ï¼Œé«˜ä¿çœŸã€‚</p><ul><li>å£°éŸ³ä»¥æ¨¡æ‹Ÿæ³¢å½¢çš„å½¢å¼å­˜åœ¨ã€‚æ•°å­—éŸ³é¢‘ç‰‡æ®µä»¥è¶³å¤Ÿå¿«çš„é€Ÿç‡å¯¹æ¨¡æ‹Ÿæ³¢çš„æŒ¯å¹…è¿›è¡Œé‡‡æ ·ï¼Œæ¨¡ä»¿æ³¢çš„å›ºæœ‰é¢‘ç‡ï¼Œè¾¾åˆ°é«˜åº¦æ¥è¿‘è¿™ç§æ¨¡æ‹Ÿæ³¢çš„æ•ˆæœã€‚æ•°å­—éŸ³é¢‘ç‰‡æ®µçš„é‡‡æ ·ç‡æŒ‡å®šäº†ï¼ˆæ¯ç§’ï¼‰ä»éŸ³é¢‘çš„æºç´ æä¸­é‡‡é›†çš„æ ·æœ¬æ•°ï¼›é‡‡æ ·ç‡è¶Šé«˜ï¼Œæ•°å­—éŸ³é¢‘å¦‚å®è¡¨ç¤ºé«˜é¢‘çš„èƒ½åŠ›å°±è¶Šå¼ºã€‚</li><li>æ ¹æ® <a href="https://en.wikipedia.org/wiki/Nyquistâ€“Shannon_sampling_theorem">Nyquist-Shannon å®šç†</a>ï¼Œå¯¹äºæ‚¨è¦ä»¥æ•°å­—å½¢å¼é‡‡é›†çš„ä»»ä½•å£°æ³¢ï¼Œæ‚¨çš„é‡‡æ ·ç‡é€šå¸¸éœ€è¦é«˜äºå…¶æœ€é«˜é¢‘ç‡çš„ä¸¤å€ã€‚ä¾‹å¦‚ï¼Œè¦è¡¨ç¤ºäººç±»å¬è§‰èŒƒå›´ (20-20000 Hz) å†…çš„éŸ³é¢‘ï¼Œæ•°å­—éŸ³é¢‘æ ¼å¼å¿…é¡»è‡³å°‘æ¯ç§’é‡‡æ · 40000 æ¬¡ï¼ˆCD éŸ³é¢‘ä½¿ç”¨ 44100 Hz çš„é‡‡æ ·ç‡ï¼Œéƒ¨åˆ†åŸå› ä¹Ÿåœ¨äºæ­¤ï¼‰ã€‚</li></ul></li><li><p>å£°é“ï¼šå•å£°é“ã€åŒå£°é“ã€å¤šå£°é“ã€‚</p></li></ul><p>é€šè¿‡ä»¥ä¸Šä¸‰è€…å¯ä»¥è®¡ç®—å‡ºåŸå§‹éŸ³é¢‘çš„ç ç‡ï¼ˆä¸€ç§’å†…çš„æ¯”ç‰¹æ•°ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æœªç»å‹ç¼©çš„ç ç‡ = é‡‡æ ·ç‡ Ã— é‡‡æ ·å¤§å° Ã— å£°é“æ•°</span><br><span class="line">44100 * 16 * 2 / 1000 = 1378.125kbps</span><br><span class="line">ä¸€åˆ†é’Ÿçš„å­˜å‚¨ç©ºé—´ï¼š</span><br><span class="line">1378.125 * 60 / 8 / 1024 = 10.09MB</span><br></pre></td></tr></table></figure><h3 id="ç›´æ¥è¯»å–å¤„ç†pcm">ç›´æ¥è¯»å–å¤„ç†PCM</h3><p>å¯¹äºPCMï¼Œå…¶æ¯ä¸ªé‡‡æ ·çš„éƒ½æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡æŒ‡é’ˆè¿›è¡Œè®¿é—®æ“ä½œï¼Œå¦‚æŠŠPCM16LEåŒå£°é“ï¼ˆé‡‡æ ·å¤§å°16ä½ï¼Œå³æ¯ä¸ªå£°é“çš„é‡‡æ ·å¤§å°ä¸º2å­—èŠ‚ï¼›LEï¼šä½¿ç”¨å°ç«¯æ–¹å¼å­˜å‚¨ï¼‰åˆ†ç¦»å£°é“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">FILE *fpcm = fopen(url, <span class="string">&quot;rb+&quot;</span>);</span><br><span class="line">FILE *fl = fopen(<span class="string">&quot;output_l.pcm&quot;</span>, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line">FILE *fr = fopen(<span class="string">&quot;output_r.pcm&quot;</span>, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ…å«å·¦å³å£°é“çš„é‡‡æ ·</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *sample = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (!feof(fpcm)) &#123;</span><br><span class="line">    fread(sample, <span class="number">1</span>, <span class="number">4</span>, fpcm);</span><br><span class="line">    <span class="comment">// L</span></span><br><span class="line">    fwrite(sample, <span class="number">1</span>, <span class="number">2</span>, fl);</span><br><span class="line">    <span class="comment">// R</span></span><br><span class="line">    fwrite(sample + <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, fr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(sample);</span><br><span class="line">fclose(fpcm);</span><br><span class="line">fclose(fl);</span><br><span class="line">fclose(fr);</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„ï¼Œå°†å·¦å£°é“éŸ³é‡é™ä½ä¸€åŠï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FILE *fin = fopen(url, <span class="string">&quot;rb+&quot;</span>);</span><br><span class="line">FILE *fout = fopen(<span class="string">&quot;output_halfleft.pcm&quot;</span>, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *sample = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (!feof(fin)) &#123;</span><br><span class="line">    <span class="keyword">short</span> *samplel = <span class="literal">NULL</span>;</span><br><span class="line">    fread(sample, <span class="number">1</span>, <span class="number">4</span>, fin);</span><br><span class="line"></span><br><span class="line">    samplel = (<span class="keyword">short</span> *)sample;</span><br><span class="line">    *samplel = *samplel / <span class="number">2</span>;</span><br><span class="line">    fwrite(sample, <span class="number">1</span>, <span class="number">4</span>, fout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(sample);</span><br><span class="line">fclose(fin);</span><br><span class="line">fclose(fout);</span><br></pre></td></tr></table></figure><p>è€ŒåŠ é€Ÿï¼Œè€Œå¯ä»¥é‡‡ç”¨éš”ä½é‡‡æ ·çš„æ–¹å¼å®ç°ï¼Œä½†è¿™æ ·çš„æ•ˆæœéŸ³è°ƒä¹Ÿä¼šä¸Šå»ã€‚ä¾‹å¦‚æŠŠé€Ÿåº¦æå‡ä¸€å€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FILE *fin = fopen(url, <span class="string">&quot;rb+&quot;</span>);</span><br><span class="line">FILE *fout = fopen(<span class="string">&quot;output_doublespeed.pcm&quot;</span>, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line"><span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *sample = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (!feof(fin)) &#123;</span><br><span class="line">    fread(sample, <span class="number">1</span>, <span class="number">4</span>, fin);</span><br><span class="line">    <span class="keyword">if</span> (cnt % <span class="number">2</span> != <span class="number">0</span>) &#123; fwrite(sample, <span class="number">1</span>, <span class="number">4</span>, fout); &#125;</span><br><span class="line">    cnt++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(sample);</span><br><span class="line">fclose(fin);</span><br><span class="line">fclose(fout);</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥è¿›è¡Œé‡‡æ ·æ ¼å¼çš„è½¬æ¢ï¼Œä¾‹å¦‚ç®€å•æŠŠPCM16LEè½¬æ¢ä¸ºPCM8ï¼Œç”±äºæ˜¯é™é‡‡æ ·ï¼Œæ‰€ä»¥éŸ³è´¨ä¹Ÿä¼šä¸‹é™ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">FILE *fin = fopen(url, <span class="string">&quot;rb+&quot;</span>);</span><br><span class="line">FILE *fout = fopen(<span class="string">&quot;output_8.pcm&quot;</span>, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line"><span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *sample = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (!feof(fin)) &#123;</span><br><span class="line">    <span class="keyword">short</span> *s16 = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> s8 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> s8_u = <span class="number">0</span>;</span><br><span class="line">    fread(sample, <span class="number">1</span>, <span class="number">4</span>, fin);</span><br><span class="line">    <span class="comment">//(-32768-32767)</span></span><br><span class="line">    s16 = (<span class="keyword">short</span> *)sample;</span><br><span class="line">    s8 = (*s16) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    <span class="comment">//(0-255)</span></span><br><span class="line">    s8_u = s8 + <span class="number">128</span>;</span><br><span class="line">    <span class="comment">// L</span></span><br><span class="line">    fwrite(&amp;s8_u, <span class="number">1</span>, <span class="number">1</span>, fout);</span><br><span class="line"></span><br><span class="line">    s16 = (<span class="keyword">short</span> *)(sample + <span class="number">2</span>);</span><br><span class="line">    s8 = (*s16) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    s8_u = s8 + <span class="number">128</span>;</span><br><span class="line">    <span class="comment">// R</span></span><br><span class="line">    fwrite(&amp;s8_u, <span class="number">1</span>, <span class="number">1</span>, fout);</span><br><span class="line">    cnt++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(sample);</span><br><span class="line">fclose(fin);</span><br><span class="line">fclose(fout);</span><br></pre></td></tr></table></figure><h2 id="éŸ³é¢‘å‹ç¼©ç¼–ç ">éŸ³é¢‘å‹ç¼©ç¼–ç </h2><p>ä¸æ‰€æœ‰æ•°æ®ä¸€æ ·ï¼ŒéŸ³é¢‘æ•°æ®é€šå¸¸ä¼šè¿›è¡Œå‹ç¼©ï¼Œä»¥ä¾¿æ›´æ˜“äºå­˜å‚¨å’Œä¼ è¾“ã€‚éŸ³é¢‘ç¼–ç ä¸­çš„å‹ç¼©å¯èƒ½ä¸ºæ— æŸæˆ–æœ‰æŸã€‚æ— æŸå‹ç¼©ç»è¿‡è§£åŒ…åå¯ä»¥å°†æ•°å­—æ•°æ®æ¢å¤ä¸ºåŸå§‹å½¢å¼ã€‚æœ‰æŸå‹ç¼©åœ¨å‹ç¼©å’Œè§£å‹ç¼©è¿‡ç¨‹ä¸­å¿…ç„¶ä¼šç§»é™¤æŸäº›ä¿¡æ¯ï¼Œå¹¶ä¸”è¿›è¡Œå‚æ•°åŒ–ï¼Œä»¥ä¾¿è¡¨æ˜åœ¨å¤šå¤§å®¹é™èŒƒå›´å†…å…è®¸å‹ç¼©æŠ€æœ¯ç§»é™¤æ•°æ®ã€‚</p><p>éŸ³é¢‘å‹ç¼©å¾€å¾€è¿½æ±‚ä¸¤ä¸ªæç«¯ï¼šå‹ç¼©æ¯”å°½å¯èƒ½å¤§ã€å‹ç¼©é€Ÿåº¦å°½å¯èƒ½å¿«ã€‚</p><h3 id="åŸºæœ¬è¿‡ç¨‹">åŸºæœ¬è¿‡ç¨‹</h3><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615773063221-2e1a0503-20ab-4284-bf61-961677beadf7.png" /></p><p>ä»¥ä¸Šè¿‡ç¨‹åŒ…å«äº†æœ‰æŸå‹ç¼©å’Œæ— æŸå‹ç¼©çš„è¿‡ç¨‹ã€‚ä¸»è¦è¿˜æ˜¯æœ‰æŸå‹ç¼©ã€‚</p><p>æ—¶åŸŸè½¬é¢‘åŸŸï¼šå»é™¤è¢«é®è”½æ‰çš„éŸ³é¢‘ä¿¡å·ï¼›å¿ƒç†å£°å­¦æ¨¡å‹ï¼šå»é™¤äººè€³å¬è§‰èŒƒå›´ä»¥å¤–çš„éŸ³é¢‘ä¿¡å·ã€‚</p><h3 id="å‹ç¼©æ–¹å¼">å‹ç¼©æ–¹å¼</h3><ul><li>æœ‰æŸå‹ç¼©ï¼ˆæ¸…é™¤åæ— æ³•æ¢å¤ï¼‰ï¼šæ¶ˆé™¤å†—ä½™ä¿¡æ¯<ul><li>åœ¨ä¿è¯ä¿¡å·åœ¨å¬è§‰æ–¹é¢ä¸äº§ç”Ÿå¤±çœŸçš„å‰æä¸‹ï¼Œå¯¹éŸ³é¢‘æ•°æ®ä¿¡å·å°½å¯èƒ½å¤§çš„å‹ç¼©ã€‚è¿™äº›å†—ä½™ä¿¡æ¯ï¼š<ul><li>äººè€³å¬è§‰èŒƒå›´å¤–çš„éŸ³é¢‘ä¿¡å·</li><li>è¢«é®è”½æ‰çš„éŸ³é¢‘ä¿¡å·<ul><li>é¢‘åŸŸé®è”½</li><li>æ—¶åŸŸé®è”½</li></ul></li></ul></li></ul></li><li>æ— æŸå‹ç¼©</li></ul><h3 id="æœ‰æŸå‹ç¼©ç¼–ç ">æœ‰æŸå‹ç¼©ç¼–ç </h3><p>æœ‰æŸå‹ç¼©åˆ™ä¼šåœ¨æ„å»ºå‹ç¼©æ•°æ®æœŸé—´æ¸…é™¤æˆ–å‡å°‘æŸäº›ç±»å‹çš„ä¿¡æ¯ï¼Œä»è€Œå‹ç¼©éŸ³é¢‘æ•°æ®ã€‚</p><h4 id="é¢‘åŸŸé®è”½æ•ˆåº”">é¢‘åŸŸé®è”½æ•ˆåº”</h4><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615773071671-80a1ca9f-4f41-4b11-990e-ef7710cf2120.png" /></p><p>éŸ³é‡é«˜çš„ä¼šé®è”½é™„è¿‘éŸ³è°ƒçš„å£°éŸ³ã€‚</p><h4 id="æ—¶åŸŸé®è”½æ•ˆåº”">æ—¶åŸŸé®è”½æ•ˆåº”</h4><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615773078659-0b7012e9-17a0-41a8-bffa-7838d70324f9.png" /></p><p>éŸ³é‡é«˜çš„ä¼šé®è”½é™„è¿‘æ—¶é—´çš„å£°éŸ³ã€‚</p><h3 id="æ— æŸå‹ç¼©ç¼–ç ">æ— æŸå‹ç¼©ç¼–ç </h3><p>æ— æŸå‹ç¼©å¯¹å­˜å‚¨çš„æ•°æ®è¿›è¡Œå¤æ‚çš„é‡æ’ï¼Œä»è€Œå‹ç¼©æ•°å­—éŸ³é¢‘æ•°æ®ï¼Œä½†ä¸ä¼šå¯¼è‡´åŸå§‹æ•°å­—æ ·æœ¬çš„è´¨é‡ä¸‹é™ã€‚å¦‚æœé‡‡ç”¨æ— æŸå‹ç¼©ï¼Œåœ¨å°†æ•°æ®è§£åŒ…ä¸ºåŸå§‹æ•°å­—å½¢å¼æ—¶ï¼Œä¸ä¼šä¸¢å¤±ä»»ä½•ä¿¡æ¯ã€‚</p><p>é‚£ä¹ˆï¼Œæ— æŸå‹ç¼©æŠ€æœ¯ä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šå…·æœ‰ä¼˜åŒ–å‚æ•°ï¼Ÿè¿™äº›å‚æ•°é€šå¸¸ç”¨æ¥æ§åˆ¶æ–‡ä»¶å¤§å°å’Œè§£å‹ç¼©æ—¶é—´ã€‚ä¾‹å¦‚ï¼ŒFLAC ä½¿ç”¨ 0ï¼ˆæœ€å¿«ï¼‰åˆ° 8ï¼ˆæ–‡ä»¶å¤§å°æœ€å°ï¼‰çš„å‹ç¼©çº§åˆ«å‚æ•°ã€‚ä¸è¾ƒä½çº§åˆ«çš„å‹ç¼©ç›¸æ¯”ï¼Œè¾ƒé«˜çº§åˆ«çš„ FLAC å‹ç¼©ä¸ä¼šä¸¢å¤±ä»»ä½•ä¿¡æ¯ã€‚å‹ç¼©ç®—æ³•åªæ˜¯éœ€è¦åœ¨æ„å»ºæˆ–è§£æ„åŸå§‹æ•°å­—éŸ³é¢‘æ—¶æ¶ˆè€—æ›´å¤šçš„è®¡ç®—èƒ½é‡ã€‚</p><p>ä»æŠ€æœ¯ä¸Šè®²ï¼Œ<code>LINEAR16</code> ä¸æ˜¯â€œæ— æŸå‹ç¼©â€ï¼Œå› ä¸ºé¦–å…ˆå®ƒå¹¶æœªæ¶‰åŠå‹ç¼©ã€‚</p><ul><li><p>ç†µç¼–ç </p><ul><li>å“ˆå¤«æ›¼ç¼–ç ã€‚ä½¿ç”¨å¾ˆå°çš„äºŒè¿›åˆ¶æ•°ä»£è¡¨ä¸€ä¸ªè¾ƒé•¿çš„å­—ç¬¦ï¼Œé¢‘ç‡è¶Šé«˜ç¼–ç è¶Šå°ï¼Œé¢‘ç‡è¶Šä½ç¼–ç è¶Šé•¿ã€‚</li></ul></li><li><p>ç®—æœ¯ç¼–ç </p><ul><li>é€šè¿‡äºŒè¿›åˆ¶çš„å°æ•°æ¥è¿›è¡Œç¼–ç ã€‚</li></ul></li><li><p>é¦™å†œç¼–ç </p><ul><li>ç®—æœ¯ç¼–ç çš„æ”¹è¿›ã€‚</li></ul></li></ul><h2 id="å¸¸è§éŸ³é¢‘ç¼–ç å™¨">å¸¸è§éŸ³é¢‘ç¼–ç å™¨</h2><p>å¸¸è§çš„éŸ³é¢‘ç¼–ç å™¨åŒ…æ‹¬ OPUSã€AACã€Oggã€Speexã€iLBCã€AMRã€G.711 ç­‰ã€‚</p><ul><li><p>OPUS</p><ul><li>å»¶è¿Ÿå°ï¼Œå‹ç¼©æ¯”é«˜ã€‚WebRTC é»˜è®¤ä½¿ç”¨ã€‚</li></ul></li><li><p>AAC</p><ul><li>åº”ç”¨å¹¿æ³›ï¼Œç§»åŠ¨è®¾å¤‡æ”¯æŒç¡¬ç¼–è§£ç ã€‚ç”¨äºå–ä»£ mp3ã€‚</li></ul></li><li><p>Ogg</p><ul><li>æ”¶è´¹ï¼Œå› æ­¤å¯¼è‡´åº”ç”¨ä¸å¹¿ã€‚</li></ul></li><li><p>Speex</p><ul><li>ç›´æ¥æ”¯æŒå›éŸ³æ¶ˆé™¤åŠŸèƒ½ã€‚</li></ul></li><li><p>G.711</p><ul><li>çª„å¸¦éŸ³é¢‘ï¼Œç¼–ç åæ•°æ®éå¸¸å°ï¼Œä½†å£°éŸ³æŸåè¾ƒå¤§ã€‚å›ºè¯ã€‚</li></ul></li></ul><p>ç½‘ä¸Šè¯„æµ‹ç»“æœï¼šOPUS &gt; AAC &gt; Ogg</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615773098988-be49753b-73f4-4d8a-a59e-8694a89767f0.png" /></p><p><img src="https://gitee.com/bqlin/image-land/raw/master/1615773110640-28723744-dc39-4a10-ac20-8e83a91f9c05.png" /></p><h2 id="éŸ³é¢‘é‡é‡‡æ ·">éŸ³é¢‘é‡é‡‡æ ·</h2><p>å«ä¹‰ï¼šå°†éŸ³é¢‘ä¸‰å…ƒç»„ï¼ˆé‡‡æ ·ç‡ã€é‡‡æ ·å¤§å°ã€é€šé“æ•°ï¼‰çš„å€¼è½¬æ¢æˆå¦å¤–ä¸€ç»„å€¼ã€‚å³åªè¦æ”¹å˜è¿™ä¸‰å…ƒç»„çš„ä»»æ„å€¼éƒ½æ˜¯è¿›è¡Œé‡é‡‡æ ·ã€‚</p><p>é‡é‡‡æ ·çš„åº”ç”¨åœºæ™¯ï¼š</p><ul><li><p>ä»è®¾å¤‡é‡‡é›†çš„éŸ³é¢‘æ•°æ®ä¸ç¼–ç å™¨è¦æ±‚çš„æ•°æ®ä¸ä¸€è‡´ã€‚</p></li><li><p>è¾“å‡ºè®¾å¤‡è¦æ±‚çš„éŸ³é¢‘æ•°æ®ä¸è¦æ’­æ”¾çš„éŸ³é¢‘æ•°æ®ä¸ä¸€è‡´ã€‚</p></li><li><p>æ›´æ–¹ä¾¿è®¡ç®—ï¼Œå¦‚å›éŸ³æ¶ˆé™¤è¦æŠŠåŒå£°é“è½¬æ¢æˆå•å£°é“ã€‚</p></li></ul><h2 id="ç æ§">ç æ§</h2><ul><li>In CBR (constant bit rate) formats, such as linear PCM and IMA/ADPCM, all packets are the same size.</li><li>In VBR (variable bit rate) formats, such as AAC, Apple Lossless, and MP3, all packets have the same number of frames but the number of bits in each sample value can vary.</li><li>In VFR (variable frame rate) formats, packets have a varying number of frames. There are no commonly used formats of this type.</li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;äººè€³å¬è§‰èŒƒå›´&quot;&gt;äººè€³å¬è§‰èŒƒå›´&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/bqlin/image-land/raw/master/1615773041050-3cf23e1f-cd52-469b-b648-de0888eeed57.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>FLVæ ¼å¼</title>
    <link href="https://bqlin.github.io/posts/flv/"/>
    <id>https://bqlin.github.io/posts/flv/</id>
    <published>2021-03-14T21:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>FLVä¸RTMPåè®®æœ‰å¯†åˆ‡çš„è”ç³»ã€‚æ¯ä¸ªRTMPçš„æ•°æ®åŠ ä¸ªå¤´å°±æ˜¯FLVäº†ã€‚</p><p>FLVæ–‡ä»¶æ˜¯ä»¥FLVæ ¼å¼å­˜å‚¨çš„ã€‚</p><p><img src="https://gitee.com/bqlin/image-land/raw/master/edhpT8.png" /></p><p>FLVæ–‡ä»¶ = FLV header + æ•°æ®</p><p>FLV headerï¼Œå 9å­—èŠ‚ï¼š</p><ul><li>å‰3å­—èŠ‚ï¼šFã€Lã€V</li><li>ç‰ˆæœ¬ï¼Œå€¼ä¸º1ã€‚</li><li>ç±»å‹<ul><li>0ï½5ä½ï¼Œä¿ç•™ï¼Œå¿…é¡»æ˜¯0ã€‚</li><li>6ä½ï¼Œæ˜¯å¦æœ‰éŸ³é¢‘tagã€‚ii</li><li>7ä½ï¼Œä¿ç•™ï¼Œå¿…é¡»æ˜¯0ã€‚</li><li>8ä½ï¼Œæ˜¯å¦æœ‰è§†é¢‘tagã€‚</li></ul></li><li>åç§»é‡ï¼Œå 4å­—èŠ‚ï¼ŒHeaderçš„å¤§å°ï¼Œå¿…é¡»æ˜¯9ã€‚</li></ul><p>æ•°æ®æ˜¯ç”±ä¸€ä¸ªä¸ªåˆ†ç»„ç»„æˆï¼Œä¸€ä¸ªåˆ†ç»„çš„ç»“æ„ï¼š</p><ul><li>pre tagsizeï¼Œå 4å­—èŠ‚ï¼Œå‰ä¸€ä¸ªtagçš„å¤§å°ï¼Œå³tagå¤§å°åœ¨tagçš„åé¢å­˜æ”¾ã€‚</li><li>Tag</li></ul><p>Tagçš„ç»“æ„ï¼š</p><ul><li>TTï¼Œ1å­—èŠ‚ï¼ŒTagç±»å‹ã€‚0x08éŸ³é¢‘ï¼Œ0x09è§†é¢‘ï¼Œ0x12scriptè„šæœ¬ã€‚</li><li>DataSizeï¼Œ3å­—èŠ‚ï¼ŒTag bodyæ•°æ®å¤§å°ï¼ˆPreTagSize - Tag Header Sizeï¼‰</li><li>TimeStaï¼Œ3å­—èŠ‚ï¼Œæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰</li><li>Eï¼Œ1å­—èŠ‚ï¼Œæ‰©å±•æ—¶é—´æˆ³ã€‚</li><li>SIDï¼Œ3å­—èŠ‚ï¼ŒStreamIDï¼Œå§‹ç»ˆæ˜¯0ã€‚</li><li>Tag DATA</li></ul><p>Tag DATAå¯ä»¥ä¿å­˜ä¸¤ç§ç±»å‹æ•°æ®ï¼šéŸ³é¢‘ã€è§†é¢‘ã€‚</p><ul><li>éŸ³é¢‘Tag DATA<ul><li>header<ul><li>SFï¼Œé‡‡æ ·ç‡</li><li>SR</li><li>SS</li><li>ST</li></ul></li><li><h2 id="data">data</h2></li></ul></li><li>è§†é¢‘Tag DATA</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;FLVä¸RTMPåè®®æœ‰å¯†åˆ‡çš„è”ç³»ã€‚æ¯ä¸ªRTMPçš„æ•°æ®åŠ ä¸ªå¤´å°±æ˜¯FLVäº†ã€‚&lt;/p&gt;
&lt;p&gt;FLVæ–‡ä»¶æ˜¯ä»¥FLVæ ¼å¼å­˜å‚¨çš„ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>å¤šåª’ä½“å®¹å™¨</title>
    <link href="https://bqlin.github.io/posts/multimedia_container/"/>
    <id>https://bqlin.github.io/posts/multimedia_container/</id>
    <published>2021-03-14T20:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬å¸¸è¯´çš„è§†é¢‘æ–‡ä»¶æ ¼å¼å¸¸å¸¸åªæ˜¯å¤šåª’ä½“å°è£…æ ¼å¼ï¼Œé‡Œé¢ä¸ä»…åŒ…å«äº†è§†é¢‘ï¼Œè¿˜æœ‰éŸ³é¢‘ã€å­—å¹•ç­‰åª’ä½“ä¿¡æ¯ã€‚è€Œçº¯è§†é¢‘ç æµçš„æ ¼å¼æ›´å¤šä½¿ç”¨ä½¿ç”¨ç¼–ç æ ¼å¼è¡¨è¾¾ã€‚</p><p><strong>å¤šåª’ä½“å°è£…æ ¼å¼</strong>ï¼ˆ<strong>M</strong>ultimedia <strong>C</strong>ontainer <strong>F</strong>ormatï¼Œç®€ç§°MCFã€å¤šåª’ä½“å®¹å™¨ï¼‰ï¼Œæ˜¯ä¸€ç§å¼€æ”¾ï¼ˆæ²¡æœ‰èº«ä»½è§„é™ï¼Œå…è´¹ï¼‰ã€è‡ªç”±çš„æ•°æ®æ ¼å¼ã€‚</p><p>å¤šåª’ä½“æ–‡ä»¶æ˜¯ä¸ªå®¹å™¨ã€‚å®¹å™¨é‡Œé¢å­˜åœ¨å¤šä¸ª<strong>æµï¼ˆstream/trackï¼‰</strong>ã€‚æ¯ç§æµæ˜¯ç”±ä¸åŒçš„ç¼–ç å™¨ç¼–ç¨‹ç”Ÿæˆçš„ã€‚ä»æµä¸­è¯»å‡ºçš„æ•°æ®ç§°ä¸º<strong>åŒ…</strong>ã€‚åœ¨ä¸€ä¸ªåŒ…ä¸­åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª<strong>å¸§</strong>ã€‚</p><p>å®¹å™¨æ ¼å¼å†…éƒ¨å¯¹éŸ³è§†é¢‘æ•°æ®çš„å¤„ç†éƒ½æ˜¯å¤§åŒå°å¼‚ï¼ŒåŒºåˆ«ç‚¹å¹¶ä¸å¤§ã€‚æ›´å¤šçš„å·®è·åœ¨äºå®ƒä»¬å¯¹äºä¸åŒç¼–ç æ ¼å¼çš„æ”¯æŒç¨‹åº¦ã€å…ƒæ•°æ®çš„è¯¦ç»†ç¨‹åº¦ä»¥åŠå¯¹äºæ˜¯å¦èƒ½å¤Ÿæ”¯æŒéŸ³è§†é¢‘ä»¥å¤–çš„æ•°æ®ã€‚</p><p>ä¸åŒçš„å®¹å™¨å…·æœ‰ä¸åŒçš„ç‰¹ç‚¹ï¼Œä¸‹é¢ç®€å•ä»‹ç»å¸¸ç”¨çš„å¤šåª’ä½“å®¹å™¨ã€‚</p><h2 id="avi">AVI</h2><p>AVIï¼ŒAudio Video Interleaveã€‚</p><ul><li>æœºæ„ï¼šMircrosoft</li><li>ä¸æ”¯æŒæµåª’ä½“</li><li>æ”¯æŒç¼–è§£ç å™¨ï¼šå‡ ä¹æ‰€æœ‰</li><li>BTä¸‹è½½è§†é¢‘</li></ul><p>ä¸€ç§RIFFï¼ˆResource Interchange File Formatï¼‰æ–‡ä»¶æ ¼å¼ã€‚åŒæ ·ä½¿ç”¨RIFFæ–‡ä»¶æ ¼å¼è¿˜æœ‰WAVæ ¼å¼æ–‡ä»¶ã€‚RIFFä½¿ç”¨å°ç«¯åºå­˜å‚¨ã€‚</p><p>ä¸»ä½“ä¸­çš„å›¾åƒæ•°æ®å’Œå£°éŸ³æ•°æ®æ˜¯äº¤å‰å­˜æ”¾çš„ï¼Œä»¥æ­¤è¾¾åˆ°éŸ³è§†é¢‘åŒæ­¥ã€‚ä»å°¾éƒ¨çš„ç´¢å¼•å¯ä»¥è·³è½¬åˆ°è¦æ’­æ”¾çš„ä½ç½®ã€‚</p><p>æ’­æ”¾æ—¶é—´æ²¡æœ‰ç›´æ¥çš„å­—æ®µç”±è¯»å–çš„å¸§æ•°å’Œå¸§ç‡è®¡ç®—å¾—å‡ºã€‚</p><p>ç¼ºç‚¹ï¼š</p><ul><li>ç”±äºç´¢å¼•åœ¨æ–‡ä»¶å°¾éƒ¨ï¼Œæ‰€ä»¥ä¸é€‚åˆç”¨æ¥æµä¼ è¾“ã€‚</li><li>å®¹å™¨ä¸­æˆ‘æ²¡æœ‰æ—¶é—´æˆ³ï¼Œåªèƒ½é€šè¿‡å¸§æ•°å’Œå¸§ç‡è®¡ç®—å¾—å‡ºã€‚åœ¨ç´¢å¼•ä¸­ä¹Ÿæ²¡æœ‰å†™æ˜æ—¶é—´æˆ³å’Œåª’ä½“ä½ç½®çš„ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨æ’­æ”¾AVIæ—¶seekæ“ä½œè¿˜éœ€è¦é¢å¤–çš„æŠ€æœ¯æ‰‹æ®µã€‚</li><li>ç”±äºåª’ä½“æ•°æ®åˆ†å—å­˜æ”¾ï¼Œä½¿å¾—å®ƒå¯¹å¾ˆå¤šä½¿ç”¨è¿åŠ¨é¢„æµ‹ç‰¹å®šçš„è§†é¢‘ç¼–ç çš„æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºé¢„æµ‹å¸§éœ€è¦è®¿é—®å¸§å¤–çš„æ•°æ®ã€‚</li></ul><h3 id="äºŒè¿›åˆ¶æ„æˆ">äºŒè¿›åˆ¶æ„æˆ</h3><p>AVIæ–‡ä»¶æ˜¯ä¸€ä¸ªç±»å‹ä¸º<code>AVI</code>çš„RIFFå—ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªsubchunkæ„æˆï¼š</p><ul><li><code>hdrl</code> LISTï¼Œä¿¡æ¯å—ï¼šå…ƒæ•°æ®</li><li><code>movi</code> LISTï¼Œæ•°æ®å—ï¼šä¿å­˜éŸ³è§†é¢‘åºåˆ—æ•°æ®</li><li><code>idxl</code> LISTï¼Œç´¢å¼•å—ï¼ˆå¯é€‰ï¼‰</li></ul><p>ç»“æ„ç¤ºæ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">RIFF (â€˜AVI â€™</span><br><span class="line">      LIST (â€˜hdrlâ€™</span><br><span class="line">            â€˜avihâ€™(ä¸»AVIä¿¡æ¯å¤´æ•°æ®)</span><br><span class="line">            LIST (â€˜strlâ€™</span><br><span class="line">                  â€˜strhâ€™ (æµçš„å¤´ä¿¡æ¯æ•°æ®)</span><br><span class="line">                  â€˜strfâ€™ (æµçš„æ ¼å¼ä¿¡æ¯æ•°æ®)</span><br><span class="line">                  [â€˜strdâ€™ (å¯é€‰çš„é¢å¤–çš„å¤´ä¿¡æ¯æ•°æ®) ]</span><br><span class="line">                  [â€˜strnâ€™ (å¯é€‰çš„æµçš„åå­—) ]</span><br><span class="line">                  ...</span><br><span class="line">                 )</span><br><span class="line">             ...</span><br><span class="line">           )</span><br><span class="line">      LIST (â€˜moviâ€™</span><br><span class="line">            &#123; SubChunk | LIST (â€˜rec â€™</span><br><span class="line">                              SubChunk1</span><br><span class="line">                              SubChunk2</span><br><span class="line">                              ...</span><br><span class="line">                             )</span><br><span class="line">               ...</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">           )</span><br><span class="line">      [â€˜idx1â€™ (å¯é€‰çš„AVIç´¢å¼•å—æ•°æ®) ]</span><br><span class="line">     )</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/bqlin/image-land/raw/master/Gb5mrn.jpg" /></p><p>å‚è€ƒï¼š</p><ul><li><a href="https://www.cnblogs.com/tocy/p/media_container_8-avi.html">å¤šåª’ä½“æ–‡ä»¶æ ¼å¼ä¹‹AVI - Tocy - åšå®¢å›­</a></li><li><a href="https://sp4n9x.github.io/2020/12/30/AVI%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/">AVIæ–‡ä»¶æ ¼å¼åˆ†æ | Sp4n9x's Blog</a></li></ul><h2 id="mov">MOV</h2><p>MOVï¼ŒQuickTime File Formatï¼ˆQTFFï¼‰</p><ul><li>æœºæ„ï¼šApple</li><li>æ”¯æŒæµåª’ä½“</li><li>æ”¯æŒç¼–è§£ç å™¨ï¼š<ul><li>éŸ³ï¼šAACã€MPEG-1 Layers I/II/IIIã€AC-3ç­‰</li><li>è§†ï¼šMPEG-2/4ã€H.264ç­‰</li></ul></li><li>ç‚¹æ’­ã€ç›´æ’­</li></ul><h3 id="ç›¸å…³æ¦‚å¿µ">ç›¸å…³æ¦‚å¿µ</h3><p>atomï¼šQTFFçš„åŸºæœ¬æ•°æ®å•å…ƒï¼Œå¯ä»¥æ¥å®¹çº³å®é™…çš„éŸ³è§†é¢‘æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ”¾ç½®å…ƒæ•°æ®å’Œå­—å¹•ç­‰ä¿¡æ¯ï¼Œé€šè¿‡å±‚å±‚åµŒå¥—æ–¹å¼å½¢æˆæ ‘çŠ¶ç»“æ„ã€‚atomå®¹çº³çš„æ•°æ®ç±»å‹å’Œå¤§å°åœ¨atomå¤´éƒ¨è¿›è¡Œæè¿°ã€‚</p><h2 id="mp4">MP4</h2><p>MP4ï¼ŒMPEG-4 Part14</p><ul><li>æœºæ„ï¼šMPEG</li><li>æ”¯æŒæµåª’ä½“</li><li>æ”¯æŒç¼–è§£ç å™¨ï¼š<ul><li>éŸ³ï¼šAACã€MPEG-1 Layers I/II/IIIã€AC-3ç­‰</li><li>è§†ï¼šMPEG-2/4ã€H.264ã€H.263ç­‰</li></ul></li><li>äº’è”ç½‘è§†é¢‘ç½‘ç«™</li></ul><p>MP4ç”±å¤šä¸ªåŒ…å«ä¸åŒä¿¡æ¯çš„boxï¼Œä»¥æ ‘å½¢å¼ç»„ç»‡æ„æˆï¼Œä¸MOVçš„atomå‡ ä¹ä¸€è‡´ã€‚</p><p>æ ¹ç»“ç‚¹ä¸‹åŒ…å«ä¸‰ä¸ªboxï¼š</p><ul><li><code>ftyp</code>ï¼šæ–‡ä»¶ç±»å‹</li><li><code>moov</code>ï¼šå…ƒæ•°æ®</li><li><code>mdat</code>ï¼šåª’ä½“æ•°æ®</li></ul><p>æŠŠmoovæ”¾åˆ°mdatå‰é¢å¯ä»¥æ›´å¿«å‡†å¤‡æ’­æ”¾ã€‚</p><h3 id="boxç»“æ„">boxç»“æ„</h3><p>æ„æˆï¼š</p><ul><li>headerï¼šæŒ‡æ˜boxå¤§å°å’Œç±»å‹ï¼›<ul><li>å¢åŠ äº†<code>version</code>ï¼ˆ8ä½ï¼‰å’Œ<code>flags</code>ï¼ˆ24ä½ï¼‰å­—æ®µçš„æˆä¸ºFullBoxã€‚</li><li>å½“sizeç­‰äº0æ—¶ï¼Œä»£è¡¨è¿™ä¸ªboxæ˜¯æ–‡ä»¶æœ€åä¸€ä¸ªboxã€‚å½“sizeç­‰äº1æ—¶ï¼Œè¯´æ˜boxé•¿åº¦éœ€è¦æ›´å¤šçš„ä½æ¥æè¿°ï¼Œåœ¨åé¢ä¼šå®šä¹‰ä¸€ä¸ª64ä½çš„largesizeæ¥æè¿°boxçš„é•¿åº¦ã€‚</li></ul></li><li>bodyï¼šæ•°æ®æˆ–box</li></ul><h3 id="å¸¸ç”¨å®¹å™¨">å¸¸ç”¨å®¹å™¨</h3><ul><li><p>moovï¼ŒéŸ³è§†é¢‘æ•°æ®çš„å…ƒæ•°æ®ä¿¡æ¯</p><ul><li><p>mvhdï¼Œå½±ç‰‡æ–‡ä»¶å¤´ä¿¡æ¯ï¼Œæœªå‹ç¼©è¿‡çš„å½±ç‰‡ä¿¡æ¯çš„å¤´å®¹å™¨</p></li><li><p>trakï¼Œå¤šä¸ªï¼Œå„è½¨é“ä¿¡æ¯å®¹å™¨</p><ul><li><p>tkhdï¼Œè½¨é“å…ƒæ•°æ®ï¼ˆTrackIDã€Durationã€éŸ³é‡ç­‰ç­‰ï¼‰</p></li><li><p>edts</p><ul><li>å¦‚æœæ²¡æœ‰è¯¥è¡¨ï¼Œé‚£ä¹ˆè¿™ä¸ªè½¨é“ä¼šç«‹å³å¼€å§‹æ’­æ”¾ï¼Œä¸€ä¸ªç©ºçš„ edts æ•°æ®ç”¨æ¥å®šä½å¯¹è½¨é“çš„èµ·å§‹æ—¶é—´åç§»ä½ç½®</li></ul></li><li><p>mdia</p><ul><li><p>mdhdï¼Œåª’ä½“å¤´</p></li><li><p>hdlrï¼Œå¥æŸ„å‚è€ƒ</p></li><li><p>minfï¼Œåª’ä½“ä¿¡æ¯</p><ul><li><p>vmhdï¼Œè§†é¢‘ä¿¡æ¯å¤´</p></li><li><p>smhdï¼ŒéŸ³é¢‘ä¿¡æ¯å¤´</p></li><li><p>dinfï¼Œæ•°æ®ä¿¡æ¯</p></li><li><p>stdlï¼Œé‡‡æ ·è¡¨</p></li></ul></li></ul></li></ul></li></ul></li></ul><p><img src="https://gitee.com/bqlin/image-land/raw/master/BkC2zj.jpg" /></p><p><code>mdat</code> boxä¸­çš„å¤šåª’ä½“æ•°æ®æ˜¯æ²¡æœ‰ç»“æ„çš„ï¼Œæ˜¯å‚è€ƒ<code>moov</code>çš„<code>track</code> boxè§£æã€‚<code>moov</code>åŒ…å«äº†æ•´ä¸ªå¤šåª’ä½“æ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œseekä¹Ÿæ˜¯é€šè¿‡è¯¥boxå®ç°ï¼Œé€šè¿‡å…¶ä¸­çš„å„ä¸ªè¡¨æŸ¥åˆ°æ•°æ®åç§»ä½ç½®ã€‚</p><h2 id="flv">FLV</h2><p>FLVï¼ŒFLash Videoã€‚</p><ul><li>æœºæ„ï¼šAdobe</li><li>æ”¯æŒæµåª’ä½“</li><li>æ”¯æŒç¼–è§£ç å™¨ï¼š<ul><li>éŸ³ï¼šMP3ã€ADPCMã€Linear PCMã€AACç­‰</li><li>è§†ï¼šSorensonã€VP6ã€H.264</li></ul></li><li>äº’è”ç½‘è§†é¢‘</li></ul><p>FLVå¸¸ç”¨åšæµåª’ä½“ã€‚</p><p>ç»“æ„ï¼š</p><ul><li><p>FLV Header</p><ul><li><p>å­—ç¬¦ FLV ç­¾åå­—æ®µ</p></li><li><p>ç‰ˆæœ¬</p></li><li><p>ä¿ç•™æ ‡è®°</p></li><li><p>éŸ³è§†é¢‘æ ‡è®°</p></li><li><p>æ•°æ®åç§»</p></li></ul></li><li><p>FLV Bodyï¼Œè¿™é‡Œbodyåªæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œå…·ä½“ç›´æ¥å°±æ˜¯PreviousTagSizeå’ŒTag</p><ul><li><p>PreviousTagSize #0ï¼š0</p></li><li><p>TAG #1</p><ul><li><p>TAG Header</p><ul><li><p>Type</p></li><li><p>DataSize</p></li><li><p><strong>TimeStamp</strong></p></li></ul></li><li><p>TAG Data</p><ul><li><p>Audio Tag Data</p><ul><li>ç¬¬ä¸€ä¸ªå­—èŠ‚åŒ…å«éŸ³é¢‘æ•°æ®çš„å‚æ•°ä¿¡æ¯</li><li>ç¬¬äºŒä¸ªå­—èŠ‚å¼€å§‹ä¸ºéŸ³é¢‘æµæ•°æ®</li></ul></li><li><p>Video Tag Dataï¼ˆåŒä¸Šï¼‰</p></li><li><p>Script Tag Data</p><ul><li>å¸¸ç”¨äºå±•ç¤ºå…ƒæ•°æ®ï¼Œå­˜å‚¨çš„æ•°æ®æ ¼å¼ä¸€èˆ¬ä¸º AMF æ ¼å¼</li></ul></li></ul></li></ul></li><li><p>PreviousTagSize #1ï¼šä¸Šä¸€ä¸ªTAGå¤§å°ã€‚</p></li><li><p>TAG #2</p></li><li><p>PreviousTagSize #2</p></li><li><p>...</p></li></ul></li></ul><p>å‚è€ƒï¼š</p><ul><li><a href="https://juejin.cn/post/6844903555027959822">Flvæ ¼å¼è§£æ - æ˜é‡‘</a></li></ul><h2 id="ts">TS</h2><p>TSï¼ŒMPEG2-TS</p><ul><li>æœºæ„ï¼šMPEG</li><li>æ”¯æŒæµåª’ä½“</li><li>æ”¯æŒç¼–è§£ç å™¨ï¼š<ul><li>éŸ³ï¼šMPEG-1 Layers I/II/IIIã€AAC</li><li>è§†ï¼šMPEG-1/2/4ã€H.264</li></ul></li><li>IPTVï¼Œä½å»¶æ—¶ç›´æ’­</li></ul><p>TSæ–‡ä»¶ä¸ºä¼ è¾“æµæ–‡ä»¶ï¼Œå…¶ç‰¹ç‚¹æ˜¯è¦æ±‚ä»è§†é¢‘æµçš„ä»»æ„ç‰‡æ®µå¼€å§‹éƒ½æ˜¯å¯ä»¥ç‹¬ç«‹è§£ç çš„ã€‚TSå®¹å™¨æ˜¯ä¸ºäº†æµä¼ è¾“è€Œè®¾è®¡çš„ã€‚</p><p>åœ¨MPEG-2æ ‡å‡†ä¸­ï¼Œæœ‰ä¸¤ç§ä¸åŒç±»å‹çš„ç æµè¾“å‡ºåˆ°ä¿¡é“ï¼šä¸€ç§æ˜¯èŠ‚ç›®ç æµï¼ˆProgram Stream, PSï¼‰ï¼Œé€‚ç”¨äºæ²¡æœ‰è¯¯å·®äº§ç”Ÿçš„åª’ä½“å­˜å‚¨ï¼Œå¦‚DVDç­‰å­˜å‚¨ä»‹è´¨ï¼ˆ.vobï¼‰ã€‚å¦ä¸€ç§æ˜¯ä¼ é€æµï¼ˆTransport stream, TS)ï¼Œé€‚ç”¨äºæœ‰ä¿¡é“å™ªå£°äº§ç”Ÿçš„ä¼ è¾“ï¼Œç›®å‰TSæµå¹¿æ³›åº”ç”¨äºå¹¿æ’­ç”µè§†ä¸­ï¼Œå¦‚æœºé¡¶ç›’ç­‰ã€‚</p><p>TSæ–‡ä»¶åˆ†å±‚ï¼š</p><ul><li>ESï¼ŒElementary Streamï¼šåŸå§‹æµï¼Œç›´æ¥ä»ç¼–ç å™¨å‡ºæ¥çš„è£¸æ•°æ®ã€‚</li><li>PESï¼ŒPacket Elemental Streamï¼šåˆ†å‰²æ‰“åŒ…çš„ESæµï¼ŒåŠ å…¥äº†PESå¤´ï¼ˆPTSã€DTSç­‰ï¼‰ã€‚PESç”±åŒ…å¤´å’Œplayloadç»„æˆã€‚</li><li>TSå±‚ï¼ŒTransport Streamï¼šä¼ è¾“æµã€‚æ˜¯åœ¨PESå±‚çš„åŸºç¡€ä¸ŠåŠ å…¥æ•°æ®æµçš„è¯†åˆ«å’Œä¼ è¾“å¿…é¡»çš„ä¿¡æ¯ã€‚<strong>å›ºå®šåŒ…é•¿åº¦ä¸º188å­—èŠ‚</strong>ï¼Œä»¥ä¾¿äºæ‰¾åˆ°å¸§çš„èµ·å§‹ä½ç½®ï¼Œæ˜“äºä»ä¸¢åŒ…ä¸­æ¢å¤ã€‚</li></ul><p>ä¸ºäº†ä¾¿äºä¼ è¾“ï¼Œå®ç°æ—¶åˆ†å¤ç”¨ï¼ŒåŸºæœ¬æµESå¿…é¡»æ‰“åŒ…ï¼Œå°±æ˜¯å°†é¡ºåºè¿ç»­ã€è¿ç»­ä¼ è¾“çš„æ•°æ®æµæŒ‰ä¸€å®šçš„æ—¶é—´é•¿åº¦è¿›è¡Œåˆ†å‰²ï¼Œåˆ†å‰²çš„å°æ®µå«åŒ…ï¼Œå› æ­¤æ‰“åŒ…ä¹Ÿç§°ä¸ºåˆ†ç»„ã€‚</p><p>å‚è€ƒï¼š<a href="https://www.cnblogs.com/jiayayao/p/6832614.html">TSæµåŸºæœ¬æ¦‚å¿µ</a>ã€<a href="https://blog.csdn.net/dxpqxb/article/details/79654004">tsæµæ ¼å¼è¯¦è§£</a></p><p><img src="https://gitee.com/bqlin/image-land/raw/master/0QxdDS.jpg" /></p><h2 id="mkv">MKV</h2><p>MKVï¼ŒMatroska Video File</p><ul><li>æœºæ„ï¼šMatroska</li><li>æ”¯æŒæµåª’ä½“</li><li>æ”¯æŒç¼–è§£ç å™¨ï¼šå‡ ä¹æ‰€æœ‰</li><li>ç‚¹æ’­ã€ç›´æ’­</li></ul><p>å¼€æ”¾æ ‡å‡†ã€å…è´¹ä½¿ç”¨ï¼Œå¯æ”¾å…¥å¤šç§åª’ä½“ä¿¡æ¯ï¼Œä¸”ä¸é™æ•°é‡ã€‚è€Œä¸”æ˜¯ç›®å‰å”¯ä¸€ä¸€ä¸ªæ”¯æŒå°è£…ASSå­—å¹•çš„æ ¼å¼ã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://en.wikipedia.org/wiki/Comparison_of_video_container_formats">Comparison of video container formats - Wikipedia</a></li><li><a href="https://www.jianshu.com/p/529c3729f357">mp4æ–‡ä»¶æ ¼å¼è§£æ - ç®€ä¹¦</a></li><li><a href="https://blog.xinoassassin.me/2019/10/Media-Containers/">å¤šåª’ä½“å®¹å™¨æ ¼å¼å˜è¿å² | éšå†™ - XinoAssassin's Blog</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘ä»¬å¸¸è¯´çš„è§†é¢‘æ–‡ä»¶æ ¼å¼å¸¸å¸¸åªæ˜¯å¤šåª’ä½“å°è£…æ ¼å¼ï¼Œé‡Œé¢ä¸ä»…åŒ…å«äº†è§†é¢‘ï¼Œè¿˜æœ‰éŸ³é¢‘ã€å­—å¹•ç­‰åª’ä½“ä¿¡æ¯ã€‚è€Œçº¯è§†é¢‘ç æµçš„æ ¼å¼æ›´å¤šä½¿ç”¨ä½¿ç”¨ç¼–ç æ ¼å¼è¡¨è¾¾ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å¤šåª’ä½“å°è£…æ ¼å¼&lt;/strong&gt;ï¼ˆ&lt;strong&gt;M&lt;/strong&gt;ultimedia &lt;strong&gt;C&lt;/strong&gt;ontainer &lt;strong&gt;F&lt;/strong&gt;ormatï¼Œç®€ç§°MCFã€å¤šåª’ä½“å®¹å™¨ï¼‰ï¼Œæ˜¯ä¸€ç§å¼€æ”¾ï¼ˆæ²¡æœ‰èº«ä»½è§„é™ï¼Œå…è´¹ï¼‰ã€è‡ªç”±çš„æ•°æ®æ ¼å¼ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>RTMP</title>
    <link href="https://bqlin.github.io/posts/rtmp/"/>
    <id>https://bqlin.github.io/posts/rtmp/</id>
    <published>2021-03-14T19:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>RTMPï¼ŒReal Time Messaging Protocolï¼Œä½¿ç”¨TCPï¼Œé»˜è®¤åœ¨1935ç«¯å£ä¸Šä¼ è¾“ä¸€èˆ¬çš„FLVæ ¼å¼æµã€‚</p><p>ä¼˜ç‚¹ï¼š</p><ul><li>æ”¯æŒåŠ å¯†</li><li>éšç§æ€§å¥½</li><li>å®æ—¶æ€§å¥½</li><li>å»¶è¿Ÿç›¸å¯¹è¾ƒä½</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>ä½¿ç”¨éå…¬å…±ç«¯å£ï¼Œå¯èƒ½è¢«é˜²ç«å¢™æ‹¦æˆªï¼›</li><li>è·¨å¹³å°å·®</li></ul><p>å¸¸ç”¨åº”ç”¨é¢†åŸŸï¼š</p><ul><li>å¨±ä¹ç›´æ’­</li><li>ç‚¹æ’­</li></ul><p>åº”ç”¨ä¼šæ¯”HLSæ›´ä¸ºå¹¿æ³›ï¼Œä¸»è¦è¿˜æ˜¯å› ä¸ºä¼ è¾“æ•ˆç‡è¾ƒé«˜ã€åŸºå»ºæ¯”è¾ƒæˆç†Ÿã€‚</p><p>å‘å±•æ–¹å‘ï¼šä½¿ç”¨UDPé€æ¸æ›¿ä»£TCPæ–¹æ¡ˆï¼ŒæŠŠä¼ è¾“åšè–„ã€‚</p><p>RTMPæ˜¯åœ¨TCPå»ºç«‹è¿æ¥çš„åŸºç¡€ä¹‹ä¸Šä¼ è¾“ï¼Œå³åº•å±‚ä½¿ç”¨ä½¿ç”¨TCPçš„ã€‚ç»è¿‡RTMPæ¡æ‰‹åï¼Œå»ºç«‹RTMP <strong>Connetction</strong>ï¼Œç„¶å<strong>stream</strong>ä¼ è¾“ã€‚</p><p>åˆ›å»ºæµçš„åŸºæœ¬æµç¨‹ï¼š</p><ol type="1"><li>é€šè¿‡socketå»ºç«‹TCPè¿æ¥ï¼›</li><li>RTMPæ¡æ‰‹ï¼›</li><li>å»ºç«‹RTMPè¿æ¥ï¼›</li><li>åˆ›å»ºRTMPæµã€‚</li></ol><p>æ¡æ‰‹è¿‡ç¨‹ï¼š</p><figure><img src="https://gitee.com/bqlin/image-land/raw/master/æˆªå±2021-06-03%20ä¸‹åˆ6.17.58.png" alt="æ¡æ‰‹" /><figcaption aria-hidden="true">æ¡æ‰‹</figcaption></figure><p>å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼š</p><figure><img src="https://gitee.com/bqlin/image-land/raw/master/r4TCIf.png" alt="å»ºç«‹è¿æ¥" /><figcaption aria-hidden="true">å»ºç«‹è¿æ¥</figcaption></figure><p>åˆ›å»ºæµçš„è¿‡ç¨‹ï¼š</p><figure><img src="https://gitee.com/bqlin/image-land/raw/master/CjhJhz.png" alt="åˆ›å»ºæµ" /><figcaption aria-hidden="true">åˆ›å»ºæµ</figcaption></figure><p>æ¨æµè¿‡ç¨‹ï¼š</p><figure><img src="https://gitee.com/bqlin/image-land/raw/master/QvkEbr.png" alt="æ¨æµ" /><figcaption aria-hidden="true">æ¨æµ</figcaption></figure><p>æ‹‰æµè¿‡ç¨‹ï¼š</p><figure><img src="https://gitee.com/bqlin/image-land/raw/master/XQBrlm.png" alt="æ‹‰æµ" /><figcaption aria-hidden="true">æ‹‰æµ</figcaption></figure><h2 id="æ¶ˆæ¯æ ¼å¼">æ¶ˆæ¯æ ¼å¼</h2><p><img src="https://gitee.com/bqlin/image-land/raw/master/S8cLlD.png" /></p><p>å½“è¿æ¥å»ºç«‹å¥½åï¼Œå°±å¯ä»¥å‘é€æ¶ˆæ¯äº†ï¼ŒRTMPæ¶ˆæ¯æœ‰å›ºå®šçš„æ ¼å¼ï¼Œå¦‚ä¸Šå›¾ï¼Œè¿™æ˜¯RTMPåè®®ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†ã€‚</p><p>å¦‚ä¸€èˆ¬ç½‘ç»œåè®®ï¼Œæ•´ä¸ªRTMPçš„æ¶ˆæ¯ç”±Headerå’ŒBodyç»„æˆã€‚</p><p>Headeråˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>Basic Headerï¼Œå¿…æœ‰</li><li>Message Headerï¼Œå¯é€‰</li><li>Extended Timestampï¼Œå¯é€‰</li></ul><p>åä¸¤è€…æ˜¯å¦å­˜åœ¨æ˜¯æ ¹æ®Basic Headerçš„å€¼å†³å®šçš„ã€‚</p><p>Basic Headerçš„å¤§å°ä¹Ÿæ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œå…¶å¤§å°ç”±ç¬¬ä¸€ä¸ªå­—èŠ‚å†³å®šã€‚Basic Headerç¬¬ä¸€ä¸ªå­—èŠ‚ç»„æˆï¼š</p><ul><li>å‰2ä½ï¼šfmtã€‚</li><li>å6ä½ï¼šå–å€¼ä¸º0ã€1ã€2ï½63ã€‚çº¦æŸå½“å‰æˆ–åç»­å­—èŠ‚æ˜¯å¦ä¸ºchunk string idï¼ˆCSIDï¼‰ã€‚<ul><li>0ï¼Œåˆ™è¡¨ç¤ºæ•´ä¸ªBasic Headerå 2ä¸ªå­—èŠ‚ï¼Œå³ä½¿ç”¨ç¬¬2ä¸ªå­—èŠ‚è¡¨è¾¾CSIDã€‚</li><li>1ï¼Œåˆ™è¡¨ç¤ºæ•´ä¸ªBasic Headerå 4ä¸ªå­—èŠ‚ï¼Œå³ä½¿ç”¨åç»­3ä¸ªå­—èŠ‚è¡¨è¾¾CSIDã€‚</li><li>2ï½63ï¼Œåˆ™è¡¨ç¤ºæ•´ä¸ªBasic Headerå 1ä¸ªå­—èŠ‚ï¼Œå³fmtåé¢çš„6ä½æ˜¯CSIDã€‚è‡ªå·±ä½¿ç”¨çš„è¯åŸºæœ¬å¤Ÿç”¨ã€‚</li></ul></li></ul><p>Message Headeræ˜¯å¯é€‰çš„ï¼Œä¹Ÿæ˜¯åŠ¨æ€å¤§å°çš„ã€‚è¿™ä¸¤è€…éƒ½æ˜¯ç”±Basic Headerçš„fmtå†³å®šçš„ï¼Œfmtæ˜¯2ä½ï¼Œå¯è¡¨ç¤ºä»¥ä¸‹çŠ¶æ€ï¼š</p><ul><li>00ï¼ŒMessage Headeræœ€é•¿ï¼Œå 11å­—èŠ‚ï¼Œå³åŒ…å«ï¼šTimeStamp(3) + MegLength(3) + TypeID(1) + StreamID(4)ã€‚</li><li>01ï¼ŒMessage Headerå 7å­—èŠ‚ï¼Œå³åŒ…å«ï¼šTimeStamp(3) + MegLength(3) + TypeID(1)ã€‚</li><li>10ï¼ŒMessage Headerå 3å­—èŠ‚ï¼Œå³åŒ…å«ï¼šTimeStamp(3)ã€‚</li><li>11ï¼Œæ²¡æœ‰Message Headerã€‚</li></ul><p>ä¹‹æ‰€ä»¥æ˜¯å¯å˜çš„ï¼Œæ˜¯å› ä¸ºåŒä¸€ä¸ªæµã€åŒä¸€ä¸ªåŒ…åˆ†ä¸ºå¤šä¸ªæ¶ˆæ¯/chunk/å—ä¼ è¾“ï¼Œæœ‰å¾ˆå¤šä¿¡æ¯åªéœ€è¦ä¼ ä¸€æ¬¡å°±å¯ä»¥ï¼Œåç»­å®¢æˆ·ç«¯æ”¶åˆ°çš„ä¿¡æ¯å¤ç”¨å‰é¢çš„ä¿¡æ¯å³å¯ã€‚</p><p>å½“ç”¨Message Headerè¿˜è¡¨è¾¾ä¿¡æ¯çš„æ—¶å€™ï¼Œå°±éœ€è¦Extended Timestampã€‚å½“Message Headerä¸­çš„TimeStampå€¼ä¸º0xFFFFFFæ—¶ï¼Œå°±å­˜åœ¨Extended Timestampã€‚</p><h3 id="æ¶ˆæ¯ç±»å‹typeid">æ¶ˆæ¯ç±»å‹/TypeID</h3><table><thead><tr class="header"><th>TypeID</th><th>ä½œç”¨</th><th>SID</th><th>CSID</th><th>åˆ†ç±»</th></tr></thead><tbody><tr class="odd"><td>1</td><td>Set Chunk Size</td><td>0</td><td>2</td><td>æ§åˆ¶æ¶ˆæ¯</td></tr><tr class="even"><td>2</td><td>Abort Message</td><td>0</td><td>2</td><td>æ§åˆ¶æ¶ˆæ¯</td></tr><tr class="odd"><td>3</td><td>Acknowledgement</td><td>0</td><td>2</td><td>æ§åˆ¶æ¶ˆæ¯</td></tr><tr class="even"><td>5</td><td>Window Acknowlegement Size</td><td>0</td><td>2</td><td>æ§åˆ¶æ¶ˆæ¯</td></tr><tr class="odd"><td>6</td><td>Set Peer Bandwidth</td><td>0</td><td>2</td><td>æ§åˆ¶æ¶ˆæ¯</td></tr><tr class="even"><td>8</td><td>éŸ³é¢‘æ•°æ®</td><td></td><td></td><td></td></tr><tr class="odd"><td>9</td><td>è§†é¢‘æ•°æ®</td><td></td><td></td><td></td></tr><tr class="even"><td>15ï¼ˆAMF3ï¼‰ï¼Œ18ï¼ˆAFM0ï¼‰</td><td>Data Message</td><td></td><td></td><td>å‘½ä»¤æ¶ˆæ¯</td></tr><tr class="odd"><td>16ï¼ˆAFM3ï¼‰ï¼Œ19ï¼ˆAFM0ï¼‰</td><td>Shared Object Message</td><td></td><td></td><td>å‘½ä»¤æ¶ˆæ¯</td></tr><tr class="even"><td>17ï¼ˆAFM3ï¼‰ï¼Œ20ï¼ˆAFM0ï¼‰</td><td>Command Message</td><td></td><td></td><td>å‘½ä»¤æ¶ˆæ¯</td></tr><tr class="odd"><td>22</td><td>Aggregate Message</td><td></td><td></td><td></td></tr></tbody></table><p>AMFæ˜¯Flashçš„ç¼–ç æ•°æ®æ ¼å¼ï¼Œå…¶å½¢å¼åƒKLVï¼ˆKey+Length+Valueï¼‰ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;RTMPï¼ŒReal Time Messaging Protocolï¼Œä½¿ç”¨TCPï¼Œé»˜è®¤åœ¨1935ç«¯å£ä¸Šä¼ è¾“ä¸€èˆ¬çš„FLVæ ¼å¼æµã€‚&lt;/p&gt;
&lt;p&gt;ä¼˜ç‚¹ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>æµåª’ä½“ä¼ è¾“åè®®</title>
    <link href="https://bqlin.github.io/posts/streaming_transfer_protocol/"/>
    <id>https://bqlin.github.io/posts/streaming_transfer_protocol/</id>
    <published>2021-03-14T18:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>æµåª’ä½“åè®®æ˜¯æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡éµå¾ªçš„è§„å®šã€‚</p><h2 id="rtsp">RTSP</h2><p>è¯¥åè®®å®šä¹‰äº†ä¸€å¯¹å¤šåº”ç”¨ç¨‹åºå¦‚ä½•æœ‰æ•ˆåœ°é€šè¿‡IPç½‘ç»œä¼ é€å¤šåª’ä½“æ•°æ®ã€‚RTSPæä¾›äº†ä¸€ä¸ªå¯æ‰©å±•æ¡†æ¶ï¼Œä½¿å®æ—¶æ•°æ®ï¼Œå¦‚éŸ³é¢‘ä¸è§†é¢‘çš„å—æ§ã€ç‚¹æ’­æˆä¸ºå¯èƒ½ã€‚æ•°æ®æºåŒ…æ‹¬ç°åœºæ•°æ®ä¸å­˜å‚¨åœ¨å‰ªè¾‘ä¸­çš„æ•°æ®ã€‚è¯¥åè®®ç›®çš„åœ¨äºæ§åˆ¶å¤šä¸ªæ•°æ®å‘é€è¿æ¥ï¼Œä¸ºé€‰æ‹©å‘é€é€šé“ï¼Œå¦‚UDPã€å¤šæ’­UDPä¸TCPæä¾›é€”å¾„ï¼Œå¹¶ä¸ºé€‰æ‹©åŸºäºRTPä¸Šå‘é€æœºåˆ¶æä¾›æ–¹æ³•ã€‚</p><h2 id="rtmp">RTMP</h2><p>RTMPæ˜¯Adobe Systemså…¬å¸ä¸ºFlashæ’­æ”¾å™¨å’ŒæœåŠ¡å™¨ä¹‹é—´éŸ³é¢‘ã€è§†é¢‘å’Œæ•°æ®å®æ—¶ä¼ è¾“å¼€å‘çš„å¼€æ”¾åè®®ï¼Œå› ä¸ºæ˜¯å¼€æ”¾åè®®æ‰€ä»¥éƒ½å¯ä»¥ä½¿ç”¨ã€‚</p><ul><li>RTMPåè®®ç”¨äºå¯¹è±¡ã€è§†é¢‘ã€éŸ³é¢‘çš„ä¼ è¾“ï¼Œè¿™ä¸ªåè®®å»ºç«‹åœ¨TCPåè®®æˆ–è€…è½®è¯¢HTTPåè®®ä¹‹ä¸Šã€‚</li><li>RTMPåè®®å°±åƒä¸€ä¸ªç”¨æ¥è£…æ•°æ®åŒ…çš„å®¹å™¨ï¼Œè¿™äº›æ•°æ®å¯ä»¥æ˜¯FLVä¸­çš„è§†éŸ³é¢‘æ•°æ®ã€‚ä¸€ä¸ªå•ä¸€çš„è¿æ¥å¯ä»¥é€šè¿‡ä¸åŒçš„é€šé“ä¼ è¾“å¤šè·¯ç½‘ç»œæµï¼Œè¿™äº›é€šé“ä¸­çš„åŒ…éƒ½æ˜¯æŒ‰ç…§å›ºå®šå¤§å°çš„åŒ…ä¼ è¾“çš„ã€‚</li></ul><h2 id="hls">HLS</h2><p>HTTP Live Streaming æŠŠæ•´ä¸ªæµåˆ†æˆä¸€ä¸ªä¸ªåŸºäº HTTP çš„æ–‡ä»¶æ¥ä¸‹è½½ï¼Œæ¯æ¬¡åªä¸‹è½½ä¸€äº›ã€‚HLS åè®®ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šHTTPï¼ˆä¼ è¾“åè®®ï¼‰ã€M3U8ï¼ˆç´¢å¼•æ–‡ä»¶ï¼‰ã€TSï¼ˆéŸ³è§†é¢‘åª’ä½“ä¿¡æ¯ï¼‰ã€‚</p><p>ç¼–ç æ ¼å¼è¦æ±‚ï¼š</p><ul><li><p>è§†é¢‘ç¼–ç æ ¼å¼ï¼šH264</p></li><li><p>éŸ³é¢‘çš„ç¼–ç æ ¼å¼ï¼šAACã€MP3ã€AC-3</p></li><li><p>è§†é¢‘çš„å°è£…æ ¼å¼ï¼šts</p></li><li><p>ä¿å­˜ ts ç´¢å¼•çš„ M3U8 æ–‡ä»¶</p></li></ul><p>ä¼˜åŠ¿ï¼š</p><ul><li><p>ç›¸å¯¹äº RTMP æ¥è®²ä½¿ç”¨äº†æ ‡å‡†çš„ HTTP åè®®æ¥ä¼ è¾“æ•°æ®ï¼Œå¯ä»¥é¿å…åœ¨ä¸€äº›ç‰¹æ®Šçš„ç½‘ç»œç¯å¢ƒä¸‹è¢«å±è”½</p></li><li><p>åœ¨æœåŠ¡ç«¯åšè´Ÿè½½å‡è¡¡è¦ç®€å•ã€‚å› ä¸º HLS æ˜¯åŸºäºæ— åè®®çš„ HTTP å®ç°çš„ï¼Œå®¢æˆ·ç«¯åªéœ€è¦æŒ‰ç…§é¡ºåºä¸‹è½½å­˜å‚¨åœ¨æœåŠ¡å™¨çš„æ™®é€š ts æ–‡ä»¶è¿›è¡Œæ’­æ”¾å³å¯ã€‚è€Œ RTMP æ˜¯ä¸€ç§æœ‰çŠ¶æ€åè®®ï¼Œå¾ˆéš¾å¯¹è§†é¢‘æœåŠ¡å™¨è¿›è¡Œå¹³æ»‘æ‰©å±•ï¼Œå› ä¸ºéœ€è¦ä¸ºæ¯ä¸€ä¸ªæ’­æ”¾è§†é¢‘æµçš„å®¢æˆ·ç«¯ç»´æŠ¤çŠ¶æ€ã€‚</p></li><li><p>HLS åè®®æœ¬èº«å®ç°äº†ç ç‡è‡ªé€‚åº”ï¼Œåœ¨ä¸åŒçš„å¸¦å®½æƒ…å†µä¸‹ï¼Œè®¾å¤‡å¯ä»¥è‡ªåŠ¨åˆ‡æ¢åˆ°æœ€é€‚åˆè‡ªå·±ç ç‡çš„è§†é¢‘æ’­æ”¾ã€‚</p></li></ul><p>åŠ£åŠ¿ï¼š</p><p>å»¶è¿Ÿï¼Œå¾ˆéš¾åšåˆ° 10s ä»¥ä¸‹ï¼Œè€Œ RTMP å¯ä»¥é™åˆ° 3s~4sã€‚</p><h3 id="m3u8">M3U8</h3><ul><li><p>EXTM3U</p><ul><li>é¦–è¡Œ</li></ul></li><li><p>EXT-X-VERSION</p><ul><li>æ ¼å¼ç‰ˆæœ¬</li></ul></li><li><p>EXT-TARGETDURATION</p><ul><li>æœ€å¤§åˆ‡ç‰‡æ—¶é•¿çš„å››èˆäº”å…¥å€¼</li></ul></li><li><p>EXT-X-MEDIA-SEQUENCE</p><ul><li>ç›´æ’­åˆ‡ç‰‡åºåˆ—</li></ul></li><li><p>EXTINF</p><ul><li>æ¯ä¸ªåˆ‡ç‰‡æ—¶é•¿</li><li>ä¸‹æ–¹ä¸ºåˆ†ç‰‡è·¯å¾„</li></ul></li><li><p>EXT-X-ENDLIST</p><ul><li>ä¸ä¼šäº§ç”Ÿæ›´å¤šåˆ‡ç‰‡ï¼Œè¯¥ M3U8 åœæ­¢æ›´æ–°</li></ul></li><li><p>EXT-X-STREAM-INF</p><ul><li><p>å¤šçº§ M3U8 æ–‡ä»¶ï¼Œæ”¯æŒäºŒçº§</p></li><li><p>åæ¥å‚æ•°ï¼š</p><ul><li>BANDWIDTHï¼Œæœ€é«˜ç ç‡å€¼</li><li>AVERAGE-BANDWIDTHï¼Œå¹³å‡ç ç‡å€¼</li></ul></li><li><p>ä¸‹é¢æ¥å­ M3U8 è·¯å¾„</p></li></ul></li></ul><h3 id="å®¢æˆ·ç«¯é€»è¾‘">å®¢æˆ·ç«¯é€»è¾‘</h3><ol type="1"><li>é€šè¿‡ç»™å®šURIè·å–æ’­æ”¾åˆ—è¡¨ã€‚è‹¥æ˜¯Master Playlistï¼Œå®¢æˆ·ç«¯é€‰æ‹©ä¸€ä¸ªVariant Streamæ¥æ’­æ”¾ã€‚</li><li>å®¢æˆ·ç«¯æ£€æŸ¥<code>#EXT-X-VERSION</code>ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³ã€‚</li><li>å®¢æˆ·ç«¯å¿½ç•¥ä¸å¯è¯†åˆ«çš„tagsã€å±æ€§é”®å€¼å¯¹ã€‚</li><li>åŠ è½½Media Playlistï¼Œé€‰æ‹©ä¸€ä¸ªsegmentå¼€å§‹æ’­æ”¾ã€‚</li><li>æ’­æ”¾å®Œä¸€ä¸ªsegmentåï¼Œæ ¹æ®å®¢æˆ·ç«¯å½“å‰çš„å…·ä½“æƒ…å†µé€‰æ‹©ä¸€ä¸ªæ–°çš„segmentï¼Œå¹¶é‡å¤æ‰§è¡Œæ’­æ”¾æ“ä½œã€‚</li><li>å¯¹ä¸ç›´æ’­ï¼Œéœ€è¦å®šæœŸåˆ·æ–°Media Playlistï¼Œå¹¶é€‰æ‹©åˆé€‚çš„segmentæ’­æ”¾ã€‚</li></ol><h3 id="å®¢æˆ·ç«¯ç ç‡åˆ‡æ¢">å®¢æˆ·ç«¯ç ç‡åˆ‡æ¢</h3><p>HLSæœåŠ¡å™¨æä¾›å‡ ç§å¯é€‰çš„ç ç‡ã€‚å®¢æˆ·ç«¯éœ€è¦è‡ªä¸»å®Œæˆç ç‡åˆ‡æ¢ã€‚å®¢æˆ·ç«¯åˆ¤æ–­æ˜¯å¦åˆ‡æ¢ç ç‡çš„å› ç´ ï¼š</p><ul><li>è®¾å¤‡å®é™…çš„ä¸‹è½½é€Ÿåº¦ï¼ˆä¸Master Playlistçš„Variant Streamæ ‡ç­¾ä¸­çš„ç ç‡/å¸¦å®½åšæ¯”è¾ƒï¼‰</li><li>è®¾å¤‡è¿è¡Œæƒ…å†µï¼ˆCPUã€å†…å­˜ã€å±å¹•åˆ†è¾¨ç‡ï¼‰</li></ul><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://blog.csdn.net/bingqingsuimeng/article/details/79184948">ç®€è¿°HLS,HTTP,RTSP,RTMPåè®®çš„åŒºåˆ«_bingqingsuimengçš„ä¸“æ -CSDNåšå®¢</a></li><li></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æµåª’ä½“åè®®æ˜¯æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡éµå¾ªçš„è§„å®šã€‚&lt;/p&gt;
&lt;h2 id=&quot;rtsp&quot;&gt;RTSP&lt;/h2&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>éŸ³è§†é¢‘é€šç”¨æŠ€æœ¯</title>
    <link href="https://bqlin.github.io/posts/audio_and_video_general_technology/"/>
    <id>https://bqlin.github.io/posts/audio_and_video_general_technology/</id>
    <published>2021-03-14T17:34:44.000Z</published>
    <updated>2021-10-28T04:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›´æ¥-alpha-ä¸-é¢„ä¹˜-alpha">ç›´æ¥ alpha ä¸ é¢„ä¹˜ alpha</h2><h3 id="ç›´æ¥-alpha">ç›´æ¥ alpha</h3><p>ä½¿ç”¨ç›´æ¥ alpha æè¿° RGBA é¢œè‰²æ—¶ï¼Œé¢œè‰²çš„ alpha å€¼ä¼šå­˜å‚¨åœ¨ alpha é€šé“ä¸­ã€‚ä¾‹å¦‚ï¼Œè‹¥è¦æè¿°å…·æœ‰ 60% ä¸é€æ˜åº¦çš„çº¢è‰²ï¼Œä½¿ç”¨ä»¥ä¸‹å€¼ï¼š<span class="math inline">\((255, 0, 0, 255 Ã— 0.6) = (255, 0, 0, 153)\)</span>ã€‚å…¶ä¸­153ï¼ˆ<span class="math inline">\(153 = 255 Ã— 0.6\)</span>ï¼‰æŒ‡ç¤ºé¢œè‰²åº”å…·æœ‰ 60% çš„ä¸é€æ˜åº¦ã€‚</p><h3 id="é¢„ä¹˜-alpha">é¢„ä¹˜ alpha</h3><p>ä½¿ç”¨é¢„ä¹˜ alpha æè¿° RGBA é¢œè‰²æ—¶ï¼Œæ¯ç§é¢œè‰²éƒ½ä¼šä¸ alpha å€¼ç›¸ä¹˜ï¼š<span class="math inline">\((255 Ã— 0.6, 0 Ã— 0.6, 0 Ã— 0.6, 255 Ã— 0.6) = (153, 0, 0, 153)\)</span>ã€‚</p><p>é¢„ä¹˜çš„å¥½å¤„ï¼š</p><ul><li>æ··åˆæ—¶å¯ä»¥å°‘ä¸€æ¬¡ä¹˜æ³•ï¼›</li><li>å…³é”®ï¼šåªæœ‰é¢„æµ‹çš„çº¹ç†æ‰èƒ½è¿›è¡ŒTexture Filteringï¼ˆé™¤éä½¿ç”¨æœ€è¿‘é‚»æ’å€¼ï¼‰ã€‚ä½¿å¾—å¸¦é€æ˜åº¦çš„å›¾ç‰‡çº¹ç†å¯ä»¥æ­£å¸¸è¿›è¡Œçº¿æ€§æ’å€¼ã€‚</li></ul><p>å¯¹äºç›´æ¥alphaè½¬æ¢ä¸ºé¢„ä¹˜alphaçš„è¿‡ç¨‹ï¼Œè¦ä¹ˆé¢„å…ˆä½¿ç”¨å·¥å…·è¿›è¡Œå¤„ç†ï¼Œè¦ä¹ˆäº¤ç”±GPUå¤„ç†ã€‚</p><h2 id="è§†é¢‘æˆ–éŸ³é¢‘æ•°æ®å­˜å‚¨çš„2ç§æ ¼å¼packedå’Œplanar">è§†é¢‘æˆ–éŸ³é¢‘æ•°æ®å­˜å‚¨çš„2ç§æ ¼å¼packedå’Œplanar</h2><p>å‡è®¾æœ‰ä¸€è·¯éŸ³é¢‘æµï¼Œæœ‰å·¦å³ä¸¤å£°é“çš„æ•°æ®ã€‚å·¦å£°é“ç”¨Lè¡¨ç¤ºï¼Œå³å£°é“ç”¨Rè¡¨ç¤ºã€‚</p><p>å­˜å‚¨æ—¶ï¼Œå¦‚æœæ˜¯å·¦å³å£°é“æ•°æ®äº¤æ›¿å­˜å‚¨æˆä¸€ç»´æ•°ç»„ï¼Œè¿™ç§æ ¼å¼ç§°ä¸ºpackedã€‚æ ¼å¼ä¸ºLRLRLR....LRLR</p><p>å¦‚æœæ˜¯åˆ†å¼€å­˜å‚¨æˆäºŒç»´æ•°ç»„ï¼Œè¿™ç§æ ¼å¼ç§°ä¸ºplanarã€‚æ ¼å¼ä¸ºLLLLLLLLLLLLLLå’ŒRRRRRRRRRRRRR</p><p>è§†é¢‘ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä½†æ˜¯å¯¹äºYUVæ ¼å¼çš„æ•°æ®ï¼Œæ¯”éŸ³é¢‘å¤šä¸€ç§å­˜å‚¨æ–¹æ³•å«semi-planarï¼Œä¹Ÿå°±æ˜¯åŠplanarã€‚ä¸€å…±2è·¯å­˜å‚¨ï¼ŒYä¸€è·¯ï¼ŒUVä¸€è·¯ï¼Œå…¶ä¸­UVäº¤å‰å­˜å‚¨ã€‚</p><h2 id="è§†é¢‘æ’­æ”¾å™¨åŸç†">è§†é¢‘æ’­æ”¾å™¨åŸç†</h2><p>è§†é¢‘æ’­æ”¾å™¨æ’­æ”¾ä¸€ä¸ªäº’è”ç½‘ä¸Šçš„è§†é¢‘æ–‡ä»¶ï¼Œéœ€è¦ç»è¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼šè§£åè®®ï¼Œè§£å°è£…ï¼Œè§£ç è§†éŸ³é¢‘ï¼Œè§†éŸ³é¢‘åŒæ­¥ã€‚å¦‚æœæ’­æ”¾æœ¬åœ°æ–‡ä»¶åˆ™ä¸éœ€è¦è§£åè®®ï¼Œä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼šè§£å°è£…ï¼Œè§£ç è§†éŸ³é¢‘ï¼Œè§†éŸ³é¢‘åŒæ­¥ã€‚ä»–ä»¬çš„è¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºã€‚</p><pre class="mermaid">flowchart TBæµæ•°æ® --è§£åè®®--> å°è£…æ ¼å¼æ•°æ®;å°è£…æ ¼å¼æ•°æ® --è§£å°è£…--> éŸ³é¢‘å‹ç¼©æ•°æ® --éŸ³é¢‘è§£ç --> éŸ³é¢‘åŸå§‹æ•°æ® --> éŸ³è§†é¢‘åŒæ­¥ --> è§†é¢‘é©±åŠ¨/è®¾å¤‡;å°è£…æ ¼å¼æ•°æ® --è§£å°è£…--> è§†é¢‘å‹ç¼©æ•°æ® --è§†é¢‘è§£ç --> è§†é¢‘åŸå§‹æ•°æ® --> éŸ³è§†é¢‘åŒæ­¥ --> éŸ³é¢‘é©±åŠ¨/è®¾å¤‡;</pre><p>å…¶ä¸­å„ä¸ªé˜¶æ®µçš„å…·ä½“æ ¼å¼ï¼š</p><ul><li>æµæ•°æ®/åè®®å±‚ï¼šHTTPã€RTMPã€<strong>FILE</strong>â€¦â€¦</li><li>å°è£…æ ¼å¼ï¼šMKVã€MP4ã€FLVã€MPEG-TSã€AVIâ€¦â€¦</li><li>å‹ç¼©æ•°æ®ï¼šH264ã€H265ã€MPEG2ã€AACâ€¦â€¦</li><li>åŸå§‹æ•°æ®ï¼šYUV420Pã€YUV422Pã€RGB24ã€PCMâ€¦â€¦</li></ul><p><strong>è§£åè®®</strong>ï¼šå°†æµåª’ä½“åè®®çš„æ•°æ®ï¼Œè§£æä¸ºæ ‡å‡†çš„ç›¸åº”çš„å°è£…æ ¼å¼æ•°æ®ã€‚è§†éŸ³é¢‘åœ¨ç½‘ç»œä¸Šä¼ æ’­çš„æ—¶å€™ï¼Œå¸¸å¸¸é‡‡ç”¨å„ç§æµåª’ä½“åè®®ï¼Œä¾‹å¦‚HTTPã€RTMPæˆ–æ˜¯MMSç­‰ç­‰ã€‚è¿™äº›åè®®åœ¨ä¼ è¾“è§†éŸ³é¢‘æ•°æ®çš„åŒæ—¶ï¼Œä¹Ÿä¼šä¼ è¾“ä¸€äº›ä¿¡ä»¤æ•°æ®ã€‚è¿™äº›ä¿¡ä»¤æ•°æ®åŒ…æ‹¬å¯¹æ’­æ”¾çš„æ§åˆ¶ï¼ˆæ’­æ”¾ï¼Œæš‚åœï¼Œåœæ­¢ï¼‰ï¼Œæˆ–è€…å¯¹ç½‘ç»œçŠ¶æ€çš„æè¿°ç­‰ã€‚è§£åè®®çš„è¿‡ç¨‹ä¸­ä¼šå»é™¤æ‰ä¿¡ä»¤æ•°æ®è€Œåªä¿ç•™è§†éŸ³é¢‘æ•°æ®ã€‚ä¾‹å¦‚ï¼Œé‡‡ç”¨RTMPåè®®ä¼ è¾“çš„æ•°æ®ï¼Œç»è¿‡è§£åè®®æ“ä½œåï¼Œè¾“å‡ºFLVæ ¼å¼çš„æ•°æ®ã€‚</p><p><strong>è§£å°è£…</strong>ï¼šå°†è¾“å…¥çš„å°è£…æ ¼å¼çš„æ•°æ®ï¼Œåˆ†ç¦»æˆä¸ºéŸ³é¢‘æµå‹ç¼©ç¼–ç æ•°æ®å’Œè§†é¢‘æµå‹ç¼©ç¼–ç æ•°æ®ã€‚å°è£…æ ¼å¼ç§ç±»å¾ˆå¤šï¼Œä¾‹å¦‚MP4ï¼ŒMKVï¼ŒRMVBï¼ŒTSï¼ŒFLVï¼ŒAVIç­‰ç­‰ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°†å·²ç»å‹ç¼©ç¼–ç çš„è§†é¢‘æ•°æ®å’ŒéŸ³é¢‘æ•°æ®æŒ‰ç…§ä¸€å®šçš„æ ¼å¼æ”¾åˆ°ä¸€èµ·ã€‚ä¾‹å¦‚ï¼ŒFLVæ ¼å¼çš„æ•°æ®ï¼Œç»è¿‡è§£å°è£…æ“ä½œåï¼Œè¾“å‡ºH.264ç¼–ç çš„è§†é¢‘ç æµå’ŒAACç¼–ç çš„éŸ³é¢‘ç æµã€‚</p><p><strong>è§£ç </strong>ï¼šå°†è§†é¢‘/éŸ³é¢‘å‹ç¼©ç¼–ç æ•°æ®ï¼Œè§£ç æˆä¸ºéå‹ç¼©çš„è§†é¢‘/éŸ³é¢‘åŸå§‹æ•°æ®ã€‚éŸ³é¢‘çš„å‹ç¼©ç¼–ç æ ‡å‡†åŒ…å«AACï¼ŒMP3ï¼ŒAC-3ç­‰ç­‰ï¼Œè§†é¢‘çš„å‹ç¼©ç¼–ç æ ‡å‡†åˆ™åŒ…å«H.264ï¼ŒMPEG2ï¼ŒVC-1ç­‰ç­‰ã€‚è§£ç æ˜¯æ•´ä¸ªç³»ç»Ÿä¸­æœ€é‡è¦ä¹Ÿæ˜¯æœ€å¤æ‚çš„ä¸€ä¸ªç¯èŠ‚ã€‚é€šè¿‡è§£ç ï¼Œå‹ç¼©ç¼–ç çš„è§†é¢‘æ•°æ®è¾“å‡ºæˆä¸ºéå‹ç¼©çš„é¢œè‰²æ•°æ®ï¼Œä¾‹å¦‚YUV420Pï¼ŒRGBç­‰ç­‰ï¼›å‹ç¼©ç¼–ç çš„éŸ³é¢‘æ•°æ®è¾“å‡ºæˆä¸ºéå‹ç¼©çš„éŸ³é¢‘æŠ½æ ·æ•°æ®ï¼Œä¾‹å¦‚PCMæ•°æ®ã€‚</p><p><strong>è§†éŸ³é¢‘åŒæ­¥</strong>ï¼šæ ¹æ®è§£å°è£…æ¨¡å—å¤„ç†è¿‡ç¨‹ä¸­è·å–åˆ°çš„å‚æ•°ä¿¡æ¯ï¼ŒåŒæ­¥è§£ç å‡ºæ¥çš„è§†é¢‘å’ŒéŸ³é¢‘æ•°æ®ï¼Œå¹¶å°†è§†é¢‘éŸ³é¢‘æ•°æ®é€è‡³ç³»ç»Ÿçš„æ˜¾å¡å’Œå£°å¡æ’­æ”¾å‡ºæ¥ã€‚</p><h2 id="éŸ³è§†é¢‘å‹ç¼©ä¸ä¼ ç»Ÿæ•°æ®å‹ç¼©">éŸ³è§†é¢‘å‹ç¼©ä¸ä¼ ç»Ÿæ•°æ®å‹ç¼©</h2><p>æ— è®ºæ˜¯è§†é¢‘è¿˜æ˜¯éŸ³é¢‘ï¼Œåœ¨ä¼ ç»Ÿå‹ç¼©ç®—æ³•çœ‹æ¥ï¼Œæ–‡ä»¶ä¸­åŸºæœ¬ä¹ˆæœ‰ä»€ä¹ˆå†—ä½™ä¿¡æ¯ï¼ŒéŸ³è§†é¢‘çš„å‹ç¼©éƒ½æ˜¯äººä»¬å¯¹éŸ³è§†é¢‘é’ˆå¯¹æ€§å¼€å‘å‹ç¼©ç®—æ³•ï¼Œå»æ‰å®é™…çš„å†—ä½™ä¿¡æ¯ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç›´æ¥-alpha-ä¸-é¢„ä¹˜-alpha&quot;&gt;ç›´æ¥ alpha ä¸ é¢„ä¹˜ alpha&lt;/h2&gt;
&lt;h3 id=&quot;ç›´æ¥-alpha&quot;&gt;ç›´æ¥ alpha&lt;/h3&gt;</summary>
    
    
    
    <category term="éŸ³è§†é¢‘æ¦‚å¿µ" scheme="https://bqlin.github.io/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%A6%82%E5%BF%B5/"/>
    
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>AVFoundationé‡‡é›†API</title>
    <link href="https://bqlin.github.io/posts/avfoundation_capture_api/"/>
    <id>https://bqlin.github.io/posts/avfoundation_capture_api/</id>
    <published>2020-10-23T10:08:47.000Z</published>
    <updated>2020-10-23T10:08:47.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ ¸å¿ƒç±»">æ ¸å¿ƒç±»</h2><h3 id="avcapturesession">AVCaptureSession</h3><p>æ’æ’ï¼Œç”¨äºå»ºç«‹è¾“å…¥ã€è¾“å‡ºå›¾çš„å…³ç³»ã€‚</p><p>æä¾›æ“ä½œï¼š</p><ul><li>é¢„è®¾é…ç½®</li><li>å¢åˆ æŸ¥è¾“å…¥ã€è¾“å‡º</li><li>å¢åˆ æŸ¥è¿æ¥</li><li>å¼€å§‹ã€åœæ­¢è¿è¡Œ</li><li>å¼€å§‹ã€æäº¤é…ç½®</li></ul><p>ä½¿ç”¨æ³¨æ„ï¼š</p><ul><li>æ–¹æ³•è°ƒç”¨åº”åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ä¸²è¡Œé˜Ÿåˆ—ä¸­è¿›è¡Œï¼Œä»¥é˜²æ­¢å½±å“ä¸»çº¿ç¨‹å’Œå®ç°åŒæ­¥æ“ä½œã€‚</li><li>ä¸­æ–­é€šè¿‡é€šçŸ¥è¿›è¡Œç›‘å¬ã€‚</li></ul><h3 id="avcapturedevice">AVCaptureDevice</h3><p>é‡‡é›†è®¾å¤‡ç¡¬ä»¶åŠŸèƒ½çš„å°è£…ã€‚</p><p>ä½¿ç”¨æ³¨æ„ï¼š</p><ul><li>ä½¿ç”¨ç¡¬ä»¶åŠŸèƒ½æ—¶ï¼Œéœ€è¦åˆ¤æ–­è¯¥åŠŸèƒ½æ˜¯å¦å¯ç”¨ï¼›</li><li>ä¿®æ”¹è®¾å¤‡é…ç½®å‰ï¼Œéœ€è¦è°ƒç”¨<code>lockForConfiguration</code>è¿›è¡Œé”å®šï¼Œä»¥é˜²æ­¢å¤–ç•Œä¿®æ”¹ï¼›å¯¹åº”çš„ä¿®æ”¹å®Œæ¯•åï¼Œè°ƒç”¨<code>unlockForConfiguration</code>ã€‚</li></ul><h3 id="avcapturedeviceinput">AVCaptureDeviceInput</h3><p>é‡‡é›†è®¾å¤‡ä½œä¸ºè¾“å…¥çš„å°è£…ã€‚éœ€è¦å°è£…æˆ Input æ‰èƒ½æ·»åŠ ä¼šè¯ä¸­ã€‚</p><p>ä½¿ç”¨æ³¨æ„ï¼š</p><ul><li>åˆ‡æ¢è®¾å¤‡å…¶é€»è¾‘è¦åŒ…è£¹åœ¨AVCaptureSessionçš„<code>beginConfiguration</code>å’Œ<code>engdConfiguration</code>ä¸­ï¼Œéœ€è¦æ ¹æ®è®¾å¤‡åˆ›å»ºInputï¼Œå…ˆç§»é™¤åæ·»åŠ ã€‚</li></ul><h3 id="avcaptureoutput">AVCaptureOutput</h3><p>æŠ½è±¡è¾“å‡ºç±»ï¼Œå…¶æ ¹æ®å®é™…çš„ç›®æ ‡æ•°æ®çš„éœ€æ±‚ä¼šæœ‰å¯¹åº”çš„å…·ä½“ç±»ã€‚ + StillImageOutputï¼šé™æ€å›¾ç‰‡è¾“å‡º + å›¾ç‰‡è¾“å‡ºé…ç½® + æ‹ç…§æ“ä½œ + MovieFileOutputï¼šéŸ³è§†é¢‘æ–‡ä»¶è¾“å‡º + æ–‡ä»¶å¤§å°é™åˆ¶ + å½•åˆ¶å¼€å§‹å’Œåœæ­¢æ“ä½œ + AudioFileOutputï¼šéŸ³é¢‘æ–‡ä»¶è¾“å‡º + éŸ³é¢‘æ ¼å¼é…ç½® + å…ƒæ•°æ®å­˜å– + AudioDataOutputï¼šåŸå§‹éŸ³é¢‘å¸§è¾“å‡º + éŸ³é¢‘æ ¼å¼é…ç½® + VideoDataOutputï¼šåŸå§‹éŸ³é¢‘å¸§è¾“å‡º + è§†é¢‘æ ¼å¼é…ç½® + MetadataOutputï¼šå…ƒæ•°æ®è¾“å‡ºï¼Œå¯ä»¥å®ç°äºŒç»´ç ã€äººè„¸è¯†åˆ« + DepthDataOutputï¼šæ·±åº¦æ•°æ®è¾“å‡º</p><p>æä¾›connectionè·å–å’Œåæ ‡è½¬æ¢ã€‚å…·ä½“çš„ç±»é€šè¿‡ä¸åŒçš„ä»£ç†å¼‚æ­¥è¾“å‡ºæ•°æ®ã€‚</p><h3 id="avcaptureconnection">AVCaptureConnection</h3><p>å»ºç«‹è¾“å…¥å’Œè¾“å‡ºçš„è¿æ¥ï¼Œç”¨äºæ§åˆ¶æ•°æ®æµã€‚åªè¦Inputå’ŒOutputéƒ½æ·»åŠ åˆ°Sessionï¼Œåˆ™å¯ä»¥ç›´æ¥å‘Outputè·å–Connectionã€‚å¦åˆ™éœ€è¦æ‰‹åŠ¨å»ºç«‹è¿æ¥ã€‚</p><p>å¯é…ç½®ä¸è®¾å¤‡ç¡¬ä»¶æ— å…³çš„è½¯ä»¶å¤„ç†ï¼švideoOrientationã€videoScaleAndCropFactorã€videoMirroringã€videoStabilizationã€‚å…¶ä»–çš„å‚æ•°éœ€è¦é…ç½®AVCaptureDeviceã€‚</p><h3 id="avcapturevideopreviewlayer">AVCaptureVideoPreviewLayer</h3><p>å¯ç›´æ¥å…³è”ï¼ˆå¼ºå¼•ç”¨ï¼‰AVCaptureSessionå®ç°é¢„è§ˆã€‚</p><h2 id="é‡‡é›†æ¡ˆä¾‹">é‡‡é›†æ¡ˆä¾‹</h2><h3 id="æ‘„åƒå¤´åæ ‡è½¬æ¢">æ‘„åƒå¤´åæ ‡è½¬æ¢</h3><p>AVCaptureVideoPreviewLayer æä¾›æ‘„åƒå¤´åæ ‡å’Œå±å¹•åæ ‡çš„è½¬æ¢æ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// å±å¹•åæ ‡ -&gt; æ‘„åƒå¤´åæ ‡</span><br><span class="line">- (CGPoint)captureDevicePointOfInterestForPoint:(CGPoint)pointInLayer;</span><br><span class="line"></span><br><span class="line">// æ‘„åƒå¤´åæ ‡ -&gt; å±å¹•åæ ‡</span><br><span class="line">- (CGPoint)pointForCaptureDevicePointOfInterest:(CGPoint)captureDevicePointOfInterest;</span><br></pre></td></tr></table></figure><h3 id="é‡‡é›†ä¼šè¯é…ç½®">é‡‡é›†ä¼šè¯é…ç½®</h3><ol type="1"><li>åˆ›å»º AVCaptureSessionï¼›</li><li>è®¾ç½®åˆ†è¾¨ç‡ï¼›</li><li>ä½¿ç”¨ AVCaptureDevice æ–¹æ³•è·å–å…¶å¯¹åº”ç±»å‹çš„å¯¹è±¡ï¼›</li><li>ä¸ºè®¾å¤‡å¯¹è±¡åˆ›å»º Inputï¼›</li><li>åˆ¤æ–­ä¼šè¯èƒ½å¦æ·»åŠ è¯¥ Inputï¼ˆå› ä¸ºæœ‰å¯èƒ½å…¶ä»–åº”ç”¨åœ¨ä½¿ç”¨è¯¥è®¾å¤‡ï¼‰ï¼Œæ˜¯åˆ™æ·»åŠ ï¼›å¯å°†è®¾å¤‡å¯¹è±¡/input å­˜åˆ°å±æ€§ï¼Œä»¥å¤‡åˆ‡æ¢è®¾å¤‡æ—¶åšåˆ¤æ–­ã€‚</li><li>åˆ›å»º Output å¯¹è±¡ï¼Œè®¾ç½®å…¶æ ¼å¼ã€‚</li><li>åˆ¤æ–­+æ·»åŠ ã€‚å¯ä»¥æ·»åŠ å¤šä¸ª Outputã€‚</li></ol><p>å¼€å§‹ä¸åœæ­¢å°±æ˜¯è°ƒç”¨ Running ç›¸å…³çš„æ–¹æ³•ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ ¸å¿ƒç±»&quot;&gt;æ ¸å¿ƒç±»&lt;/h2&gt;
&lt;h3 id=&quot;avcapturesession&quot;&gt;AVCaptureSession&lt;/h3&gt;</summary>
    
    
    
    <category term="AVFoundation" scheme="https://bqlin.github.io/categories/AVFoundation/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>iOS é…ç½®è®¤è¯è¯ä¹¦</title>
    <link href="https://bqlin.github.io/posts/ios_configuring_the_authentication_certificate/"/>
    <id>https://bqlin.github.io/posts/ios_configuring_the_authentication_certificate/</id>
    <published>2020-10-19T04:15:11.000Z</published>
    <updated>2020-10-19T04:15:11.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>ä¸æ”¯æŒ <code>.crt</code></li></ul><p>è§£å†³ï¼šè½¬æ¢æˆ <code>.cer</code> æ ¼å¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> xxx.crt -inform PEM -out xxx.cer -outform DER</span><br></pre></td></tr></table></figure><ul><li>åªæ”¯æŒäºŒè¿›åˆ¶è¯ä¹¦ï¼Œä¸æ”¯æŒ base64 è¯ä¹¦ã€‚</li></ul><p>è‹¥ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€çš„è¯ä¹¦æ˜¯é•¿è¿™æ ·çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIGCDCCA/CgAwâ€¦â€¦</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure><p>iOS ä¸æ”¯æŒ PEM æ ¼å¼çš„è¯ä¹¦ï¼Œéœ€è¦è½¬æ¢æˆ DER äºŒè¿›åˆ¶æ ¼å¼ã€‚</p><p>åŸç†ï¼šå°†æ–‡æœ¬ä¸­çš„ base64 String è§£ base64ï¼Œå¾—å‡ºçš„ data å†è½¬ stringã€‚</p><p>æœ€ä¿é™©æ–¹æ³•ï¼š</p><p>ä½¿ç”¨ç³»ç»Ÿçš„<code>é’¥åŒ™ä¸²è®¿é—®</code>ï¼Œå¯¼å…¥è¯ä¹¦ï¼Œå†å¯¼å‡ºå³å¯ã€‚</p><h2 id="ä½¿ç”¨ä»£ç æ”¯æŒ-pem-è¯ä¹¦">ä½¿ç”¨ä»£ç æ”¯æŒ PEM è¯ä¹¦</h2><p>å®‰å“æ˜¯ç›´æ¥æ”¯æŒ PEM æ ¼å¼è¯ä¹¦ï¼Œä¸ºäº†å…¼å®¹ iOS ä»¥åŠå‡å°‘è¯ä¹¦æ–‡ä»¶çš„ç»´æŠ¤æˆæœ¬ï¼Œåœ¨ iOS ç«¯ï¼Œå¯ä»¥é€šè¿‡ä»£ç ä»è§£å¯†åçš„ PEM è¯ä¹¦ä¸­æŠ½å–æ ¼å¼æ”¯æŒçš„è¯ä¹¦äºŒè¿›åˆ¶æ•°æ®ã€‚</p><blockquote><p>PEMï¼ŒPrivacy Enhanced Mailï¼Œä¸€èˆ¬ä¸ºæ–‡æœ¬æ ¼å¼ï¼Œä»¥ <code>-----BEGIN...</code> å¼€å¤´ï¼Œä»¥ <code>-----END...</code> ç»“å°¾ã€‚ä¸­é—´çš„å†…å®¹æ˜¯ BASE64 ç¼–ç ã€‚è¿™ç§æ ¼å¼å¯ä»¥ä¿å­˜è¯ä¹¦å’Œç§é’¥ï¼Œæœ‰æ—¶æˆ‘ä»¬ä¹ŸæŠŠPEM æ ¼å¼çš„ç§é’¥çš„åç¼€æ”¹ä¸º .key ä»¥åŒºåˆ«è¯ä¹¦ä¸ç§é’¥ã€‚</p></blockquote><p>å¯è§ PEM è¯ä¹¦æ˜¯ä¸ªæ–‡æœ¬ï¼Œä¸”æ—¢ç„¶æœ‰ BEGIN END åŒ…è£¹ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šæœ‰å¤šä¸ªè¯ä¹¦ã€‚æ‰€ä»¥å¯ä»¥ç»™ NSData å¢åŠ ä¸€ä¸ªæ‰©å±•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, strong, readonly) NSArray&lt;NSData *&gt; *tool_pemBins;</span><br></pre></td></tr></table></figure><p>å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå‡º BEGIN END åŒ…è£¹çš„å†…å®¹ï¼Œå»é™¤æ¢è¡Œï¼Œç„¶å BASE64 è§£ç ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// NSData+Tool</span><br><span class="line">- (NSArray&lt;NSData *&gt; *)tool_pemBins &#123;</span><br><span class="line">    NSMutableArray *array = NSMutableArray.array;</span><br><span class="line">    </span><br><span class="line">    NSString *string = [[NSString alloc] initWithData:self encoding:NSUTF8StringEncoding];</span><br><span class="line">    for (NSString *substring in [string tool_substringsMatchedRx:@&quot;^-*BEGIN \\w*-*$([\\s\\S]*)^-*END \\w*-*$&quot;]) &#123;</span><br><span class="line">        NSString *content = substring;</span><br><span class="line">        content = [content stringByReplacingOccurrencesOfString:@&quot;\n&quot; withString:@&quot;&quot;];</span><br><span class="line">        NSData *data = [[NSData alloc] initWithBase64EncodedString:content options:0];</span><br><span class="line">        [array addObject:data];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return array.copy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// NSString+Tool</span><br><span class="line">- (NSRegularExpression *)tool_rx &#123;</span><br><span class="line">    NSRegularExpressionOptions options = NSRegularExpressionCaseInsensitive | NSRegularExpressionAnchorsMatchLines;</span><br><span class="line">    return [NSRegularExpression regularExpressionWithPattern:self options:options error:NULL];</span><br><span class="line">&#125;</span><br><span class="line">- (NSArray&lt;NSString *&gt; *)tool_substringsMatchedRx:(NSString *)rx &#123;</span><br><span class="line">    NSMutableArray *array = NSMutableArray.array;</span><br><span class="line">    NSArray *results = [rx.tool_rx matchesInString:self options:0 range:NSMakeRange(0, self.length)];</span><br><span class="line">    for (NSTextCheckingResult *result in results) &#123;</span><br><span class="line">        for (int i = 1; i &lt; result.numberOfRanges; i++) &#123;</span><br><span class="line">            NSRange range = [result rangeAtIndex:i];</span><br><span class="line">            if (range.location == NSNotFound || range.length == 0) continue;</span><br><span class="line">            [array addObject:[self substringWithRange:range]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return array.copy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åšè¿™ä¸ªçš„æ—¶å€™ï¼Œæ—¶é—´éƒ½èŠ±åœ¨æ­£åˆ™è¡¨è¾¾å¼çš„åŒ¹é…ä¸Šäº†ï¼Œå› ä¸º iOS çš„æ­£åˆ™è¡¨è¾¾å¼è·Ÿ sublime text ç¼–è¾‘å™¨çš„æ­£åˆ™è¡¨è¾¾å¼æœç´¢æœ‰ç»†å¾®çš„å·®åˆ«ï¼Œè¯­æ³•ä¼¼ä¹ä¹Ÿæ”¯æŒå¾—ä¸å¤Ÿå…¨é¢ï¼Œå› æ­¤éœ€è¦åœ¨ iOS ä¸Šåšä¸æ–­ä¿®æ•´ã€‚</p><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://www.jianshu.com/p/74465973da5e" class="uri">https://www.jianshu.com/p/74465973da5e</a></li><li><a href="https://blog.freessl.cn/ssl-cert-format-introduce/">SSL è¯ä¹¦æ ¼å¼æ™®åŠï¼ŒPEMã€CERã€JKSã€PKCS12</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;ul&gt;
&lt;li&gt;ä¸æ”¯æŒ &lt;code&gt;.crt&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è§£å†³ï¼šè½¬æ¢æˆ &lt;code&gt;.cer&lt;/code&gt; æ ¼å¼ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
  </entry>
  
  <entry>
    <title>è·å–æ—¶é—´æ¥å£å¯¹æ¯”</title>
    <link href="https://bqlin.github.io/posts/get_the_time_api/"/>
    <id>https://bqlin.github.io/posts/get_the_time_api/</id>
    <published>2020-10-19T04:15:11.000Z</published>
    <updated>2020-10-19T04:15:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>NSDate ã€CFAbsoluteTimeGetCurrentã€CACurrentMediaTime çš„åŒºåˆ«</p><p>æ¡†æ¶å±‚ï¼š</p><ul><li>NSDate å±äºFoundation</li><li>CFAbsoluteTimeGetCurrent() å±äº CoreFoundatio</li><li>CACurrentMediaTime() å±äº QuartzCore</li></ul><p>æœ¬è´¨åŒºåˆ«ï¼š</p><p><code>NSDate</code> æˆ– <code>CFAbsoluteTimeGetCurrent()</code> è¿”å›çš„æ—¶é’Ÿæ—¶é—´å°†ä¼šä¼šç½‘ç»œæ—¶é—´åŒæ­¥ï¼Œä»æ—¶é’Ÿåç§»é‡çš„è§’åº¦ã€‚</p><p><code>mach_absolute_time()</code> å’Œ <code>CACurrentMediaTime()</code> æ˜¯åŸºäºå†…å»ºæ—¶é’Ÿçš„ï¼Œèƒ½å¤Ÿæ›´ç²¾ç¡®æ›´åŸå­åŒ–åœ°æµ‹é‡ï¼Œå¹¶ä¸”ä¸ä¼šå› ä¸ºå¤–éƒ¨æ—¶é—´å˜åŒ–è€Œå˜åŒ–ï¼ˆä¾‹å¦‚æ—¶åŒºå˜åŒ–ã€å¤æ—¶åˆ¶ã€ç§’çªå˜ç­‰ï¼‰ï¼Œä½†å®ƒå’Œç³»ç»Ÿçš„ uptime æœ‰å…³ï¼Œç³»ç»Ÿé‡å¯åå…¶å€¼ä¼šè¢«é‡ç½®ã€‚CACurrentMediaTime æ–¹æ³•è·å–åˆ°çš„æ—¶é—´ï¼Œæ˜¯æ‰‹æœºä»å¼€æœºä¸€ç›´åˆ°å½“å‰æ‰€ç»è¿‡çš„ç§’æ•°ã€‚ç±»ä¼¼çš„ï¼ŒCADisplayLink çš„æ—¶é—´æˆ³ä¹Ÿæ˜¯ä½¿ç”¨è¯¥æ¦‚å¿µçš„æ—¶é—´ï¼ˆHostTimeï¼‰ã€‚</p><p>å¸¸è§ç”¨æ³•ï¼š</p><p>NSDateã€CFAbsoluteTimeGetCurrent()å¸¸ç”¨äºæ—¥å¸¸æ—¶é—´ã€æ—¶é—´æˆ³çš„è¡¨ç¤ºï¼Œä¸æœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤äº’ å…¶ä¸­ CFAbsoluteTimeGetCurrent() ç›¸å½“äº <code>[[NSDate data] timeIntervalSinceReferenceDate];</code></p><p><strong>CFAbsoluteTimeGetCurrent() å¸¸ç”¨äºæµ‹è¯•ä»£ç çš„æ•ˆç‡ã€‚</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;NSDate ã€CFAbsoluteTimeGetCurrentã€CACurrentMediaTime çš„åŒºåˆ«&lt;/p&gt;
&lt;p&gt;æ¡†æ¶å±‚ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
  </entry>
  
  <entry>
    <title>AVFoundationæ”¯æŒæ ¼å¼</title>
    <link href="https://bqlin.github.io/posts/avfoundation_movie_format/"/>
    <id>https://bqlin.github.io/posts/avfoundation_movie_format/</id>
    <published>2020-03-15T10:08:47.000Z</published>
    <updated>2020-03-15T10:08:47.000Z</updated>
    
    <content type="html"><![CDATA[<table><thead><tr class="header"><th>å®šä¹‰</th><th>æ‰©å±•å</th></tr></thead><tbody><tr class="odd"><td>AVFileTypeQuickTimeMovie</td><td>.mov æˆ– .qt</td></tr><tr class="even"><td>AVFileTypeMPEG4</td><td>.mp4</td></tr><tr class="odd"><td>AVFileTypeAppleM4V</td><td>.m4v</td></tr><tr class="even"><td>AVFileTypeAppleM4A</td><td>.m4a</td></tr><tr class="odd"><td>AVFileType3GPP</td><td>.3gp æˆ– .3gpp æˆ– .sdv</td></tr><tr class="even"><td>AVFileType3GPP2</td><td>.3g2 æˆ– .3gp2</td></tr><tr class="odd"><td>AVFileTypeCoreAudioFormat</td><td>.caf</td></tr><tr class="even"><td>AVFileTypeWAVE</td><td>.wav æˆ– .wave æˆ– .bwf</td></tr><tr class="odd"><td>AVFileTypeAIFF</td><td>.aif æˆ– .aiff</td></tr><tr class="even"><td>AVFileTypeAIFC</td><td>.aifc æˆ– .cdda</td></tr><tr class="odd"><td>AVFileTypeAMR</td><td>.amr</td></tr><tr class="even"><td>AVFileTypeWAVE</td><td>.wav æˆ– .wave æˆ– .bwf</td></tr><tr class="odd"><td>AVFileTypeMPEGLayer3</td><td>.mp3</td></tr><tr class="even"><td>AVFileTypeSunAU</td><td>.au æˆ– .snd</td></tr><tr class="odd"><td>AVFileTypeAC3</td><td>.ac3</td></tr><tr class="even"><td>AVFileTypeEnhancedAC3</td><td>.eac3</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;å®šä¹‰&lt;/th&gt;
&lt;th&gt;æ‰©å±•å&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;AVFileTypeQuickTimeMovie&lt;/td&gt;
&lt;td&gt;.</summary>
      
    
    
    
    <category term="AVFoundation" scheme="https://bqlin.github.io/categories/AVFoundation/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
    <category term="éŸ³è§†é¢‘" scheme="https://bqlin.github.io/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨å¯¹è±¡åŒ…è£…å®ç°å¤šä»£ç†</title>
    <link href="https://bqlin.github.io/posts/implement_multiple_proxies_using_object_wrappers/"/>
    <id>https://bqlin.github.io/posts/implement_multiple_proxies_using_object_wrappers/</id>
    <published>2020-03-03T02:29:58.000Z</published>
    <updated>2020-03-03T02:29:58.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¤šä»£ç†çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¦‚ï¼š</p><ul><li>ä½¿ç”¨ NSPointerArray å­˜å‚¨ weak delegateï¼›</li><li>ä½¿ç”¨ NSHashTable å­˜å‚¨ weak delegateï¼›</li><li>ä½¿ç”¨ NSProxy è¿›è¡Œè½¬å‘ï¼›</li><li>ä½¿ç”¨ NSObject å°è£… target å’Œ selectorï¼Œè¿›è¡Œéå†è°ƒç”¨ã€‚</li></ul><p>æœ¬æ–‡è®¨è®ºçš„æ˜¯æœ€åä¸€ç§ï¼Œä½†å¯ä»¥ç»“åˆ NSProxy è¿›è¡Œé«˜æ•ˆçš„è½¬å‘ã€‚</p><h2 id="å®ç°åŸç†">å®ç°åŸç†</h2><p>å¯¹è±¡å°è£… weak targetï¼Œå’Œ selectorï¼Œä½¿ç”¨æ•°ç»„å­˜å‚¨è¿™ä¸ªå°è£…å¯¹è±¡ï¼Œåœ¨å›è°ƒçš„åœ°æ–¹ï¼Œéå†æ•°ç»„è°ƒç”¨å„ä¸ªä»£ç†æ–¹æ³•ã€‚</p><h2 id="å°è£…å¯¹è±¡å‘½å">å°è£…å¯¹è±¡å‘½å</h2><ul><li>Delegator</li></ul><h2 id="ç»“åˆ-nsproxy-ä¾¿æ·æ¶ˆæ¯è½¬å‘">ç»“åˆ NSProxy ä¾¿æ·æ¶ˆæ¯è½¬å‘</h2><p>NSProxy å¯ä»¥å®ç°æ¶ˆæ¯çš„è½¬å‘ï¼Œå…·ä½“å¯è§ YYWeakProxy çš„å®ç°ï¼Œå…¶å¯ä»¥å®ç°æ¶ˆæ¯è½¬å‘ä»¥è¾¾åˆ°ï¼Œè°ƒç”¨ proxy çš„æ–¹æ³•ï¼Œç›´æ¥å°±æ˜¯è°ƒç”¨ target çš„æ–¹æ³•ã€‚</p><p>å¦‚æœç»“åˆäº† NSProxyï¼Œåˆ™å¯ä»¥å°‘ä¸€å±‚å­˜å‚¨å’Œè°ƒç”¨ selector çš„é€»è¾‘ã€‚</p><h2 id="qmui-çš„å¤šä»£ç†">QMUI çš„å¤šä»£ç†</h2><p>QMUI çš„å¤šä»£ç†å®ç°æœ‰ç‚¹å·§å¦™ï¼Œå…¶ä½¿ç”¨æ–¹æ³•æ³¨å…¥ï¼Œå¯¹ delegate çš„ setter å’Œ getter å±æ€§è¿›è¡Œä¿®æ”¹ï¼Œå˜æˆè°ƒç”¨å…¶å®¹å™¨ä¸­çš„å¤šä»£ç†æ–¹æ³•ã€‚</p><p>è€Œå…¶å®¹å™¨ä¹Ÿè¿›è¡Œäº†å°è£…ï¼Œå…·ä½“çœ‹ QMUIMultipleDelegates çš„å®ç°ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¤šä»£ç†çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¦‚ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨ NSPointerArray å­˜å‚¨ weak delegateï¼›&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ NSHashTable å­˜å‚¨ weak delegateï¼›&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ NSProxy è¿›è¡Œè½¬å‘ï¼›&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ NSObject å°è£… target å’Œ selectorï¼Œè¿›è¡Œéå†è°ƒç”¨ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
  </entry>
  
  <entry>
    <title>é™æ€åº“ä¸åŠ¨æ€åº“</title>
    <link href="https://bqlin.github.io/posts/static_lib_vs_and_dynamic_lib/"/>
    <id>https://bqlin.github.io/posts/static_lib_vs_and_dynamic_lib/</id>
    <published>2019-09-09T06:20:52.000Z</published>
    <updated>2019-09-09T06:20:52.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="object-file">Object File</h2><p>object fileæ˜¯ä¸ªæœ‰ç»“æ„çš„ä½å…ƒå—ã€‚è¿™äº›ä½å…ƒå—åŒ…å«ç¨‹åºä»£ç ã€‘å‡†å¤‡ç»™Linkerå’ŒLoaderä½¿ç”¨çš„ç›¸å…³ä¿¡æ¯ã€‚</p><p>æŸ¥çœ‹object fileï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -macho -section-headers /bin/ls</span><br></pre></td></tr></table></figure><p>object fileçš„å½¢å¼ï¼š</p><ul><li>Relocatableï¼šåŒ…å«å¯ä»¥åœ¨ç¼–è¯‘æ—¶è¢«å…¶ä»–Relocatableé“¾æ¥çš„ä»£ç å’Œæ•°æ®ï¼Œä»¥ç”ŸæˆExecutableã€‚å¤šä¸ªRelocatableå¯è¢«å°è£…æˆ.aï¼ˆarchiveï¼‰é™æ€åº“ï¼ˆstatic libraryã€static archiveï¼‰ã€‚</li><li>Executableï¼šå¯ä»¥è½½å…¥å†…å­˜çš„æ‰§è¡Œçš„æŒ‡ä»¤é›†åˆã€‚é“¾æ¥å™¨ä¼šæŠŠé™æ€åº“ä¸­çš„ä»£ç ç»™å®šä¸€ä¸ªå›ºå®šçš„loadåœ°å€ï¼Œå¹¶åŒ…å«ï¼ˆcopies and relocatesï¼‰è¿›Executableä¸­ã€‚ä¸”æ¯ä¸ªExecutableä½¿ç”¨é™æ€åº“éƒ½è¦æ‹·è´ä¸€ä»½é™æ€åº“ã€‚</li><li>Sharedï¼šä¸€ç§ç‰¹æ®Šå½¢å¼çš„Relocatableï¼Œç±»ä¼¼åŠ¨æ€åº“ã€‚ä¸å¹¶å…¥ä»»ä½•Executableï¼Œå¯åœ¨å¤šä¸ªExecutableä¹‹é—´å…±äº«ã€‚</li><li>Bundleï¼šåœ¨macOSä¸­é•¿ä½œä¸ºæ’ä»¶ä½¿ç”¨ã€‚</li></ul><h3 id="macosæ”¯æŒçš„å¯æ‰§è¡Œæ ¼å¼">macOSæ”¯æŒçš„å¯æ‰§è¡Œæ ¼å¼</h3><table><colgroup><col style="width: 11%" /><col style="width: 36%" /><col style="width: 51%" /></colgroup><thead><tr class="header"><th>å¯æ‰§è¡Œæ ¼å¼</th><th>magic</th><th>ç”¨é€”</th></tr></thead><tbody><tr class="odd"><td>è„šæœ¬</td><td><code>\x7FELF</code></td><td>ä¸»è¦ç”¨äº shell è„šæœ¬ï¼Œä½†æ˜¯ä¹Ÿå¸¸ç”¨è¯­å…¶ä»–è§£é‡Šå™¨ï¼Œå¦‚ Perl, AWK ç­‰ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è§çš„è„šæœ¬æ–‡ä»¶ä¸­åœ¨ <code>#!</code> æ ‡è®°åçš„å­—ç¬¦ä¸²ï¼Œå³ä¸ºæ‰§è¡Œå‘½ä»¤çš„æŒ‡ä»¤æ–¹å¼ï¼Œä»¥æ–‡ä»¶çš„ stdin æ¥ä¼ é€’å‘½ä»¤</td></tr><tr class="even"><td>é€šç”¨äºŒè¿›åˆ¶æ ¼å¼</td><td><code>0xcafebabe</code> <code>0xbebafeca</code></td><td>åŒ…å«å¤šç§æ¶æ„æ”¯æŒçš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œåªåœ¨ macOS ä¸Šæ”¯æŒ</td></tr><tr class="odd"><td>Mach-O</td><td><code>0xfeedface</code>ï¼ˆ32 ä½ï¼‰ <code>0xfeedfacf</code>ï¼ˆ64 ä½ï¼‰</td><td>macOS çš„åŸç”ŸäºŒè¿›åˆ¶æ ¼å¼</td></tr></tbody></table><h3 id="é€šç”¨äºŒè¿›åˆ¶æ ¼å¼">é€šç”¨äºŒè¿›åˆ¶æ ¼å¼</h3><p>é€šç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼ˆUniversal Binaryã€Fat Binaryï¼‰ã€‚Appleæå‡ºè¿™ä¸ªæ˜¯ä¸ºäº†è§£å†³ä¸€äº›å†å²é—®é¢˜ã€‚macOSï¼Œæ›´ç¡®åˆ‡åœ°è¯´æ˜¯OS Xï¼Œæœ€æ—©æ˜¯åŸºäºPPCæ¶æ„çš„ï¼Œåæ¥æ‰ç§»æ¤åˆ°Intelæ¶æ„ï¼ˆOSX Tiger 10.4.7å¼€å§‹ï¼‰ï¼Œé€šç”¨äºŒè¿›åˆ¶æ ¼å¼å¯ä»¥åœ¨PPCå’Œx86ä¸¤ç§å¤„ç†å™¨ä¸Šæ‰§è¡Œã€‚å³ï¼Œå¯¹å¤šæ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶çš„æ‰“åŒ…é›†åˆæ–‡ä»¶ã€‚</p><p>macOSçš„å¤šæ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶å°±æ˜¯é€‚é…ä¸åŒæ¶æ„çš„Mach-Oæ–‡ä»¶ã€‚</p><h3 id="mach-o">Mach-O</h3><p>Mach-Oï¼ˆMach Object File Formatï¼‰æ˜¯è‹¹æœå¹³å°OSä¸Šçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼Œç±»ä¼¼äºLinuxå’Œå¤§éƒ¨åˆ†UNIXçš„åŸå£°æ ¼å¼ELFï¼ˆExtensible Firmware Interfaceï¼‰ã€‚</p><h4 id="æ–‡ä»¶æ ¼å¼">æ–‡ä»¶æ ¼å¼</h4><figure><img src="https://gitee.com/bqlin/image-land/raw/master/mach-o.png" alt="mach-o" /><figcaption aria-hidden="true">mach-o</figcaption></figure><p>Mach-Oæ ¼å¼ä¸»è¦ç”±ä»¥ä¸‹3éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>Mach-Oå¤´ï¼ˆMach-O Headerï¼‰ï¼šæè¿°äº†Mach-Oçš„CPUæ¶æ„ã€æ–‡ä»¶ç±»å‹ã€åŠ è½½å‘½ä»¤ç­‰ä¿¡æ¯ã€‚</li><li>åŠ è½½å‘½ä»¤ï¼ˆLoad Commandï¼‰ï¼šæè¿°äº†æ–‡ä»¶ä¸­æ•°æ®çš„å…·ä½“ç»„ç»‡ç»“æ„ï¼Œä¸åŒçš„æ•°æ®ç±»å‹ä½¿ç”¨ä¸åŒçš„åŠ è½½å‘½ä»¤è¡¨ç¤ºã€‚</li><li>æ•°æ®ï¼ˆDataï¼‰ï¼šå­˜å‚¨æ¯ä¸ªæ®µï¼ˆSegmentï¼‰çš„æ•°æ®ã€‚æ®µæ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªSectionï¼Œå­˜å‚¨æ•°æ®å’Œä»£ç ï¼Œä¸ELFæ–‡ä»¶ä¸­çš„æ®µç±»ä¼¼ã€‚</li></ul><h3 id="å‚è€ƒ">å‚è€ƒ</h3><ul><li><a href="https://www.desgard.com/iOS-Source-Probe/C/mach-o/Mach-O%20%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%8E%A2%E7%B4%A2.html">Mach-O æ–‡ä»¶æ ¼å¼æ¢ç´¢ Â· GitBook</a></li><li><a href="http://satanwoo.github.io/2017/06/13/Macho-1/">æ·±å…¥å‰–æMacho (1) | SatanWoo</a></li><li><a href="https://objccn.io/issue-6-3/">ObjC ä¸­å›½ - Mach-O å¯æ‰§è¡Œæ–‡ä»¶</a></li></ul><h2 id="é™æ€åº“">é™æ€åº“</h2><p>é™æ€åº“ï¼ˆStatic Librariesï¼‰ï¼Œå¤šä¸ªç›®æ ‡æ–‡ä»¶ï¼ˆobject fileï¼‰çš„æ‰“åŒ…é›†åˆã€‚</p><p>ç‰¹ç‚¹ï¼š</p><ul><li>é™æ€åº“ä¼šç›´æ¥åµŒå…¥åˆ°Appçš„Mach-Oä¸­ã€‚</li><li>ç¼–è¯‘æ—¶å·²ç»é“¾æ¥ï¼Œå¯åŠ¨æ—¶ä¸éœ€è¦äºŒæ¬¡æŸ¥æ‰¾ã€‚å› æ­¤Appå¯åŠ¨æ›´å¿«ã€‚</li><li>æ¯ä¸ªExecutableä½¿ç”¨éƒ½è¦æ‹·è´ä¸€ä»½é™æ€åº“ã€‚</li></ul><figure><img src="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/DynamicLibraries/art/address_space1_2x.png" alt="å›¾1 ä½¿ç”¨é™æ€åº“çš„åº”ç”¨" /><figcaption aria-hidden="true">å›¾1 ä½¿ç”¨é™æ€åº“çš„åº”ç”¨</figcaption></figure><h3 id="æ„å»ºè®¾ç½®">æ„å»ºè®¾ç½®</h3><ul><li>Linking-Math-O Type: Static Library</li><li>Dead Code Stripping: No</li></ul><h2 id="åŠ¨æ€åº“">åŠ¨æ€åº“</h2><p>åŠ¨æ€åº“ï¼ˆåŠ¨æ€é“¾æ¥åº“ã€Dynamic Librariesã€Shared Libraryã€Shared Objectï¼‰ï¼ŒåŒæ ·ä¹Ÿæ˜¯ç›®æ ‡æ–‡ä»¶çš„é›†åˆï¼Œä¸é™æ€åº“åŒºåˆ«çš„æ˜¯åµŒå…¥Appçš„æ–¹å¼å’Œåœ¨AppåŠ è½½çš„æ–¹å¼ã€‚</p><p>ç‰¹ç‚¹ï¼š</p><ul><li>ä»¥ç‹¬ç«‹æ–‡ä»¶åµŒå…¥AppåŒ…ä¸­ã€‚</li><li>Appçš„Mach-Oä¸­åªåŒ…å«å…¶å¼•ç”¨ä¿¡æ¯ï¼Œä½¿ç”¨çš„æ—¶å€™æ‰è¿›è¡ŒåŠ¨æ€é“¾æ¥å’ŒåŠ è½½ã€‚å¯åœ¨ä¸¤ä¸ªæ—¶æœºè½½å…¥ï¼Œå¹¶åŠ¨æ€åˆ†é…ä¸€æ®µåœ°å€ï¼š<ul><li>Appè½½å…¥æ—¶ï¼ˆload timeï¼‰ï¼šå¯åŠ¨æ—¶åŠ è½½ï¼Œç§°ä¸ºåŠ¨æ€é“¾æ¥åº“ã€‚</li><li>Appè¿è¡Œæ—¶ï¼ˆrun timeï¼‰ï¼šå¯åŠ¨ååŠ è½½ï¼Œç§°ä¸ºåŠ¨æ€åŠ è½½åº“ã€‚</li></ul></li><li>å¤šä¸ªExecutableä½¿ç”¨éƒ½ä¸ä¼šè¿›è¡Œæ‹·è´ã€‚å¯ç‹¬ç«‹æ›´æ–°ã€‚</li></ul><p>åªæœ‰ç³»ç»Ÿåº“æˆ–åœ¨macOSä¸Šçš„åŠ¨æ€åº“æ‰æœ‰ä»¥ä¸Šè‡ªç”±é€‰æ‹©è½½å…¥æ—¶æœºçš„ç‰¹æ€§ï¼Œåœ¨iOSä¸­ï¼Œåªèƒ½é€šè¿‡Embedding Frameworksçš„æ–¹å¼ä½¿ç”¨åŠ¨æ€åº“ï¼Œå¹¶åœ¨å¯åŠ¨æ—¶è½½å…¥ä¸é“¾æ¥åŠ¨æ€åº“ã€‚è€Œå…¶é“¾æ¥åŠ¨æ€åº“ä¹Ÿæ˜¯é€ æˆå¯åŠ¨æ—¶é—´é•¿çš„åŸå› ã€‚</p><p>åœ¨iOSçš„å¤šä¸ªExecutableå¯ä»¥æ˜¯Appå’ŒExtensionï¼Œä»–ä»¬å¯ä»¥å…±ç”¨åŒ…ä¸­çš„frameworkã€‚</p><p>åˆ—å‡ºæ‰€æœ‰åŠ¨æ€é“¾æ¥çš„åº“ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -L &lt;PathToArchive&gt;/Products/Applications/&lt;AppName&gt;.app/&lt;AppBinary&gt;</span><br></pre></td></tr></table></figure><figure><img src="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/DynamicLibraries/art/address_space2_2x.png" alt="å›¾2 ä½¿ç”¨åŠ¨æ€åº“çš„åº”ç”¨ç¨‹åº" /><figcaption aria-hidden="true">å›¾2 ä½¿ç”¨åŠ¨æ€åº“çš„åº”ç”¨ç¨‹åº</figcaption></figure><h2 id="åŒºåˆ†">åŒºåˆ†</h2><p>ä½¿ç”¨fileå‘½ä»¤è¾“å‡ºå¯¹åº”çš„Mach-Oä¿¡æ¯ï¼š</p><p>é™æ€åº“ï¼šcurrent ar <strong>archive</strong> random library</p><p>åŠ¨æ€åº“ï¼š<strong>dynamically linked shared library</strong></p><h2 id="æ€§èƒ½å·®å¼‚">æ€§èƒ½å·®å¼‚</h2><p>å¾…å®šã€‚</p><h2 id="framework">framework</h2><p>frameworkæ—¶ä¸€ä¸ªæœ‰ç€ç‰¹å®šç»“æ„çš„æ–‡ä»¶å¤¹ï¼Œé‡Œé¢åŒ…å«å„ç§å…±äº«çš„èµ„æºã€‚å¦‚ï¼šé™æ€åº“/åŠ¨æ€åº“ã€å¤´æ–‡ä»¶ã€æ¨¡å—ä¿¡æ¯å’Œèµ„æºï¼ˆä¾‹å¦‚storyboardã€xibã€å›¾åƒæ–‡ä»¶å’Œæœ¬åœ°åŒ–å­—ç¬¦ä¸²ï¼‰ã€‚</p><p>å…¶ä¸­frameworké‡Œé¢çš„object fileç±»å‹å†³å®šäº†å…¶å¯ç”¨çš„èµ„æºï¼š</p><p>é™æ€åº“ï¼šåªèƒ½ä½¿ç”¨å…¶ä¸­çš„å¤´æ–‡ä»¶ã€æ¨¡å—ä¿¡æ¯ã€‚</p><p>åŠ¨æ€åº“ï¼šå¯å…¨éƒ¨ä½¿ç”¨ï¼Œå³é™¤äº†å¤´æ–‡ä»¶ã€æ¨¡å—ä¿¡æ¯ï¼Œè¿˜èƒ½åµŒå…¥èµ„æºã€‚</p><h3 id="é›†æˆæ–¹å¼">é›†æˆæ–¹å¼</h3><p>é›†æˆåˆ°Appæ—¶æœ‰ä»¥ä¸‹ä¸¤ä¸ªé€‰é¡¹ï¼š</p><ul><li>Linkedï¼šä»…é“¾æ¥ã€‚å¯åŠ¨æ—¶é“¾æ¥åˆ™å‹¾é€‰ï¼Œå¦åˆ™è¦è¿è¡Œæ—¶æ‰é“¾æ¥åˆ™ä¸å‹¾é€‰ã€‚</li><li>Embeddedï¼šæ‹·è´åˆ°AppåŒ…ä¸­çš„frameworkç›®å½•ã€‚</li></ul><p>å¯¹äºé™æ€åº“å’ŒåŠ¨æ€åº“frameworkæœ‰ä¸åŒçš„é€‰æ‹©ï¼š</p><p>é™æ€åº“ï¼šLinkedã€‚å› ä¸ºé™æ€åº“å·²ç»æ‹·è´åˆ°Appçš„Executable Mach-Oæ–‡ä»¶ä¸­ï¼ŒEmbedæ˜¯æ²¡æ„ä¹‰çš„ï¼Œè™½ç„¶Xcodeå…è®¸è¿™æ ·åšã€‚</p><p>åŠ¨æ€åº“ï¼šLinkedï¼ˆiOSå¯é€‰ï¼ŒmacOSå¿…é€‰ï¼‰ + Embedded</p><h3 id="åŠ¨æ€æ›´æ–°åŠ¨æ€åº“">åŠ¨æ€æ›´æ–°åŠ¨æ€åº“</h3><p>è¿™é‡Œçš„åŠ¨æ€æ›´æ–°æ˜¯é’ˆå¯¹äºå·²ç¼–è¯‘çš„åŒ…çš„åŠ¨æ€æ›´æ–°ï¼Œä¸æ˜¯è¿è¡Œæ—¶çš„åŠ¨æ€æ›´æ–°ã€‚</p><p>é¦–å…ˆå¯¹äºiOSï¼Œä¸ŠApp Storeçš„Appæ˜¯ä¸å…è®¸åŠ¨æ€æ›´æ–°åŠ¨æ€åº“çš„ï¼Œå› ä¸ºåœ¨iOSä¸­ä½¿ç”¨åŠ¨æ€åº“åªèƒ½é€šè¿‡frameworkå½¢å¼ï¼Œè€Œä¸ŠApp Storeä¼šè¿›è¡Œç­¾åï¼Œå…¶ä¸­å°±åŒ…å«å¯¹frameworkçš„å“ˆå¸Œï¼Œå³ä¸Šæ¶åï¼Œå°±ä¸å…è®¸æ”¹å˜å…¶frameworkã€‚è€ŒåŠ¨æ€æ›´æ–°frameworkçš„æ–¹å¼å¯ä»¥åœ¨in houseå’Œdevelopæ¨¡å¼ä¸‹ä½¿ç”¨ã€‚</p><p><a href="iOS%20åˆ©ç”¨%20Framework%20è¿›è¡ŒåŠ¨æ€æ›´æ–°.md">iOS åˆ©ç”¨ Framework è¿›è¡ŒåŠ¨æ€æ›´æ–°.md</a></p><h2 id="cocoapodsä¸­çš„ä½¿ç”¨">CocoaPodsä¸­çš„ä½¿ç”¨</h2><p>Podfileï¼š</p><ul><li><code>use_frameworks!</code>ï¼šå½“å‰èŒƒå›´ä½¿ç”¨frameworkã€‚å¯ä»¥æŒ‡å®šåŠ¨æ€åº“ã€é™æ€åº“ã€‚<ul><li><code>use_frameworks! :linkage =&gt; :dynamic</code></li><li><code>use_frameworks! :linkage =&gt; :static</code></li></ul></li></ul><p>Podspecï¼š</p><ul><li><code>spec.static_framework = true</code>ï¼šå½“ä½¿ç”¨<code>use_frameworks!</code>æ ‡è®°æ—¶ï¼Œä½¿ç”¨é™æ€åº“frameworkã€‚</li><li>å¼•ç”¨ç³»ç»Ÿåº“ï¼š<ul><li><code>spec.frameworks = 'QuartzCore', 'CoreData'</code></li><li><code>spec.libraries = 'xml2', 'z'</code></li></ul></li><li>å¼•ç”¨å¤–éƒ¨åº“ï¼š<ul><li><code>spec.vendored_frameworks = 'MyFramework.framework', 'TheirFramework.framework'</code></li><li><code>spec.vendored_libraries = 'libProj4.a', 'libJavaScriptCore.a'</code></li></ul></li></ul><h2 id="åŠ¨æ€åº“å·§ç”¨">åŠ¨æ€åº“å·§ç”¨</h2><h3 id="å‡å°‘é™æ€åº“çš„ä¾èµ–æ‹·è´">å‡å°‘é™æ€åº“çš„ä¾èµ–æ‹·è´</h3><p>é€šè¿‡å‰é¢æˆ‘ä»¬çŸ¥é“å¯æ‰§æ–‡ä»¶ï¼ˆä¸»ç¨‹åºæˆ–è€…åŠ¨æ€åº“ï¼‰åœ¨æ„å»ºçš„é“¾æ¥é˜¶æ®µï¼Œ<strong>é‡åˆ°é™æ€åº“ï¼Œå¸é™„è¿›æ¥ï¼›é‡åˆ°åŠ¨æ€åº“ï¼Œæ‰“æ ‡è®°ï¼Œå½¼æ­¤ä¿æŒç‹¬ç«‹ã€‚</strong></p><p>æ­£å› ä¸ºåŠ¨æ€åº“æ˜¯ä¿æŒç‹¬ç«‹çš„ï¼Œé‚£ä¹ˆå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªåŠ¨æ€åº“æŠŠä¾èµ–çš„é™æ€åº“å¸é™„è¿›æ¥ã€‚<strong>å¯¹å¤–æ•´ä½“å‘ˆç°çš„æ˜¯åŠ¨æ€åº“ç‰¹æ€§ã€‚å…¶ä»–çš„ç»„ä»¶ä¾èµ–æˆ‘ä»¬è‡ªå®šä¹‰çš„åŠ¨æ€åº“ï¼Œç”±äºéš”ç¦»æ€§çš„å­˜åœ¨ï¼Œä¸ä¼šå‡ºç°é—®é¢˜ã€‚</strong></p><blockquote><p>è¿™ä¸ªæ€è·¯åœ¨å¤„ç†é¡¹ç›®ç»„ä»¶åŒ–çš„æ—¶å€™éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨Swiftçš„é¡¹ç›®ä¸­ã€‚</p></blockquote><h3 id="å¤„ç†é™æ€åº“ä¹‹é—´çš„ç¬¦å·å†²çª">å¤„ç†é™æ€åº“ä¹‹é—´çš„ç¬¦å·å†²çª</h3><p>èƒŒæ™¯ï¼šéœ€è¦çŸ¥é“ï¼Œåœ¨æ‰“åŒ…IPAçš„æ—¶å€™ï¼Œæœ€ç»ˆé™æ€åº“ä¼šè¢«è¿æ¥åˆ°æœ€ç»ˆçš„é‚£ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚æ‰€ä»¥å¦‚æœå¤šä¸ªé™æ€åº“æ‹¥æœ‰äº†ç›¸åŒçš„ç¬¦å·å¿…å®šä¼šäº§ç”Ÿç¬¦å·å†²çªã€‚</p><p>é™æ€åº“çš„ç¬¦å·å’ŒåŠ¨æ€åº“åº“ç¬¦å·å¯ä»¥éš”ç¦»ï¼Œè¿›è€Œé¿å…äº†é“¾æ¥æ—¶äº§ç”Ÿçš„ç¬¦å·å†²çªã€‚</p><blockquote><p>è¿™ä¸€ç‚¹åœ¨å¤„ç†ä¸€äº›ç”±äºåº•å±‚ä¸‰æ–¹åº“æºç ä¸èƒ½æ‰‹åŠ¨ä¿®æ”¹ï¼ˆæ¯”å¦‚boringsslä¸opensslï¼‰çš„æ—¶å€™ï¼Œéå¸¸æœ‰ç”¨ã€‚</p></blockquote><h2 id="å‚è€ƒ-1">å‚è€ƒ</h2><ul><li><a href="ç¿»è¯‘-åœ¨åº”ç”¨ç¨‹åºä¸­åµŒå…¥framework.md">ç¿»è¯‘-åœ¨åº”ç”¨ç¨‹åºä¸­åµŒå…¥framework.md</a></li><li><a href="å¹´è½»äººï¼Œå¬è¯´ä½ æƒ³ä½¿ç”¨Framework.md">å¹´è½»äººï¼Œå¬è¯´ä½ æƒ³ä½¿ç”¨Framework.md</a></li><li><a href="https://www.jianshu.com/p/4e0fd0214152">iOSåŠ¨æ€åº“ã€é™æ€åº“åŠä½¿ç”¨åœºæ™¯ã€æ–¹å¼ - ç®€ä¹¦</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;object-file&quot;&gt;Object File&lt;/h2&gt;
&lt;p&gt;object fileæ˜¯ä¸ªæœ‰ç»“æ„çš„ä½å…ƒå—ã€‚è¿™äº›ä½å…ƒå—åŒ…å«ç¨‹åºä»£ç ã€‘å‡†å¤‡ç»™Linkerå’ŒLoaderä½¿ç”¨çš„ç›¸å…³ä¿¡æ¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
  </entry>
  
  <entry>
    <title>æ‰©å±•åç±»å‹åˆ¤æ–­</title>
    <link href="https://bqlin.github.io/posts/extension_type_determination/"/>
    <id>https://bqlin.github.io/posts/extension_type_determination/</id>
    <published>2017-08-24T14:08:56.000Z</published>
    <updated>2017-08-24T14:08:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æˆ‘ä»¬ä½¿ç”¨æ“ä½œç³»ç»Ÿï¼Œç³»ç»Ÿé€šå¸¸å¯ä»¥æ ¹æ®æ–‡ä»¶æ‰©å±•å/åç¼€ï¼Œæ¥åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œå¹¶æ˜¾ç¤ºç›¸åº”å›¾æ ‡ã€‚é‚£ä¹ˆï¼ŒiOS ä¸­å¯ä»¥æ€æ ·å®ç°å‘¢ï¼Ÿ <span id="more"></span></p><p>iOS å¯ä»¥é€šè¿‡ UTI æ¥è¿›è¡Œè½¬æ¢ã€‚UTI æ˜¯ä»€ä¹ˆå‘¢ï¼Œç”¨è¿‡ Media ç›¸å…³çš„æ¡†æ¶çš„åŒå­¦å¯èƒ½ä¸ä¼šé™Œç”Ÿã€‚éœ€è¦äº†è§£çš„åŒå­¦ï¼Œå¯æµè§ˆä»¥ä¸‹èµ„æ–™ï¼š - <a href="https://developer.apple.com/library/content/documentation/FileManagement/Conceptual/understanding_utis/understand_utis_conc/understand_utis_conc.html">Uniform Type Identifier Concepts</a> - <a href="https://developer.apple.com/library/content/documentation/General/Conceptual/DevPedia-CocoaCore/UniformTypeIdentifier.html">Uniform Type Identifier</a></p><p>å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// extension -&gt; UTI</span></span><br><span class="line"><span class="built_in">NSString</span> *UTIForExtension(<span class="built_in">NSString</span> *extension) &#123;</span><br><span class="line">    <span class="comment">//Request the UTI via the file extension</span></span><br><span class="line">    <span class="built_in">NSString</span> *theUTI = (__bridge_transfer <span class="built_in">NSString</span> *)UTTypeCreatePreferredIdentifierForTag(kUTTagClassFilenameExtension, (__bridge <span class="built_in">CFStringRef</span>)(extension), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> theUTI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// åŒ¹é… UTI</span></span><br><span class="line"><span class="built_in">BOOL</span> extensionConformToUTI(<span class="built_in">NSString</span> *extension, <span class="built_in">CFStringRef</span> theUTI) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *preferredUTI = UTIForExtension(extension);</span><br><span class="line">    <span class="keyword">return</span> (UTTypeConformsTo((__bridge <span class="built_in">CFStringRef</span>) preferredUTI, theUTI));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BOOL</span> extensionLikelyImage(<span class="built_in">NSString</span> *extension) &#123;</span><br><span class="line">    <span class="keyword">return</span> extensionConformToUTI(extension, <span class="built_in">CFSTR</span>(<span class="string">&quot;public.image&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">BOOL</span> extensionLikelyAudio(<span class="built_in">NSString</span> *extension) &#123;</span><br><span class="line">    <span class="keyword">return</span> extensionConformToUTI(extension, <span class="built_in">CFSTR</span>(<span class="string">&quot;public.audio&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">BOOL</span> extensionLikelyMovie(<span class="built_in">NSString</span> *extension) &#123;</span><br><span class="line">    <span class="keyword">return</span> extensionConformToUTI(extension, <span class="built_in">CFSTR</span>(<span class="string">&quot;public.movie&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr /><p>ğŸå½©è›‹</p><p>é¡ºä¾¿çš„ï¼Œç»™å‡º UTI ä¸ mimeType çš„è½¬æ¢ï¼Œä»¥åŠç›¸å…³çš„å®ç”¨å‡½æ•°ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// UTI -&gt; mimeType</span></span><br><span class="line"><span class="built_in">NSString</span> *mimeTypeForUTI(<span class="built_in">NSString</span> *aUTI) &#123;</span><br><span class="line">    <span class="built_in">CFStringRef</span> theUTI = (__bridge <span class="built_in">CFStringRef</span>) aUTI;</span><br><span class="line">    <span class="built_in">CFStringRef</span> mimeType = UTTypeCopyPreferredTagWithClass(theUTI, kUTTagClassMIMEType);</span><br><span class="line">    <span class="keyword">return</span> (__bridge_transfer <span class="built_in">NSString</span> *)mimeType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// å…ƒç´ å”¯ä¸€å­—å…¸</span></span><br><span class="line"><span class="built_in">NSArray</span> *uniqueArray(<span class="built_in">NSArray</span> *anArray) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *copiedArray = [<span class="built_in">NSMutableArray</span> arrayWithArray:anArray];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> anArray)     &#123;</span><br><span class="line">        [copiedArray removeObjectIdenticalTo:object];</span><br><span class="line">        [copiedArray addObject:object];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> copiedArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *conformanceArray(<span class="built_in">NSString</span> *aUTI) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *results = [<span class="built_in">NSMutableArray</span> arrayWithObject:aUTI];</span><br><span class="line">    <span class="built_in">NSDictionary</span> *dictionary = utiDictionary(aUTI);</span><br><span class="line">    <span class="keyword">id</span> conforms = dictionary[(__bridge <span class="built_in">NSString</span> *)kUTTypeConformsToKey];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// No conformance</span></span><br><span class="line">    <span class="keyword">if</span> (!conforms) <span class="keyword">return</span> results;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Single conformance</span></span><br><span class="line">    <span class="keyword">if</span> ([conforms isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        [results addObjectsFromArray:conformanceArray(conforms)];</span><br><span class="line">        <span class="keyword">return</span> uniqueArray(results);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Iterate through multiple conformance</span></span><br><span class="line">    <span class="keyword">if</span> ([conforms isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *eachUTI <span class="keyword">in</span> (<span class="built_in">NSArray</span> *) conforms)</span><br><span class="line">            [results addObjectsFromArray:conformanceArray(eachUTI)];</span><br><span class="line">        <span class="keyword">return</span> uniqueArray(results);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Just return the one-item array</span></span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *allExtensions(<span class="built_in">NSString</span> *aUTI) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *results = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="built_in">NSArray</span> *conformance = conformanceArray(aUTI);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *eachUTI <span class="keyword">in</span> conformance)     &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *dictionary = utiDictionary(eachUTI);</span><br><span class="line">        <span class="built_in">NSDictionary</span> *extensions = dictionary[(__bridge <span class="built_in">NSString</span> *)kUTTypeTagSpecificationKey];</span><br><span class="line">        <span class="keyword">id</span> fileTypes = extensions[(__bridge <span class="built_in">NSString</span> *)kUTTagClassFilenameExtension];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ([fileTypes isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]])</span><br><span class="line">            [results addObjectsFromArray:(<span class="built_in">NSArray</span> *) fileTypes];</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ([fileTypes isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]])</span><br><span class="line">            [results addObject:(<span class="built_in">NSString</span> *) fileTypes];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> uniqueArray(results);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *allMIMETypes(<span class="built_in">NSString</span> *aUTI) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *results = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="built_in">NSArray</span> *conformance = conformanceArray(aUTI);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *eachUTI <span class="keyword">in</span> conformance) &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *dictionary = utiDictionary(eachUTI);</span><br><span class="line">        <span class="built_in">NSDictionary</span> *extensions = dictionary[(__bridge <span class="built_in">NSString</span> *)kUTTypeTagSpecificationKey];</span><br><span class="line">        <span class="keyword">id</span> fileTypes = extensions[(__bridge <span class="built_in">NSString</span> *)kUTTagClassMIMEType];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ([fileTypes isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]])</span><br><span class="line">            [results addObjectsFromArray:(<span class="built_in">NSArray</span> *) fileTypes];</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ([fileTypes isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]])</span><br><span class="line">            [results addObject:(<span class="built_in">NSString</span> *) fileTypes];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> uniqueArray(results);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSDictionary</span> *utiDictionary(<span class="built_in">NSString</span> *aUTI) &#123;</span><br><span class="line">    <span class="built_in">NSDictionary</span> *dictionary = (__bridge_transfer <span class="built_in">NSDictionary</span> *)UTTypeCopyDeclaration((__bridge <span class="built_in">CFStringRef</span>) aUTI);</span><br><span class="line">    <span class="keyword">return</span> dictionary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨æˆ‘ä»¬ä½¿ç”¨æ“ä½œç³»ç»Ÿï¼Œç³»ç»Ÿé€šå¸¸å¯ä»¥æ ¹æ®æ–‡ä»¶æ‰©å±•å/åç¼€ï¼Œæ¥åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œå¹¶æ˜¾ç¤ºç›¸åº”å›¾æ ‡ã€‚é‚£ä¹ˆï¼ŒiOS ä¸­å¯ä»¥æ€æ ·å®ç°å‘¢ï¼Ÿ</summary>
    
    
    
    <category term="iOS" scheme="https://bqlin.github.io/categories/iOS/"/>
    
    
    <category term="Apple" scheme="https://bqlin.github.io/tags/Apple/"/>
    
  </entry>
  
</feed>
